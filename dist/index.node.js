var zr=Object.create;var ut=Object.defineProperty;var Fr=Object.getOwnPropertyDescriptor;var Br=Object.getOwnPropertyNames;var Gr=Object.getPrototypeOf,qr=Object.prototype.hasOwnProperty;var se=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Zs=(n,e)=>{for(var t in e)ut(n,t,{get:e[t],enumerable:!0})},Xs=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Br(e))!qr.call(n,i)&&i!==t&&ut(n,i,{get:()=>e[i],enumerable:!(s=Fr(e,i))||s.enumerable});return n};var ce=(n,e,t)=>(t=n!=null?zr(Gr(n)):{},Xs(e||!n||!n.__esModule?ut(t,"default",{value:n,enumerable:!0}):t,n)),$r=n=>Xs(ut({},"__esModule",{value:!0}),n);var xi=se((Tt,as)=>{(function(n,e){if(typeof Tt=="object"&&typeof as=="object")as.exports=e();else if(typeof define=="function"&&define.amd)define([],e);else{var t=e();for(var s in t)(typeof Tt=="object"?Tt:n)[s]=t[s]}})(global,()=>(()=>{"use strict";var n={n:P=>{var O=P&&P.__esModule?()=>P.default:()=>P;return n.d(O,{a:O}),O},d:(P,O)=>{for(var D in O)n.o(O,D)&&!n.o(P,D)&&Object.defineProperty(P,D,{enumerable:!0,get:O[D]})},o:(P,O)=>Object.prototype.hasOwnProperty.call(P,O),r:P=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(P,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(P,"__esModule",{value:!0})}},e={};n.r(e),n.d(e,{Channel:()=>z,EventBuffer:()=>h,Session:()=>R,SseError:()=>x,createChannel:()=>E,createEventBuffer:()=>I,createSession:()=>j});let t=require("http"),s=P=>JSON.stringify(P),i=/(\r\n|\r|\n)/g,r=/\n+$/g,o=P=>{let O=P;return O=O.replace(i,`
`),O=O.replace(r,""),O},a=require("crypto"),l;l=a.randomUUID?()=>(0,a.randomUUID)():()=>(0,a.randomBytes)(4).toString("hex");let c=P=>async(O,D={})=>{let{eventName:F="stream"}=D;return await new Promise((q,H)=>{O.on("data",Z=>{let ue;ue=Buffer.isBuffer(Z)?Z.toString():Z,P(ue,F)}),O.once("end",()=>q(!0)),O.once("close",()=>q(!0)),O.once("error",Z=>H(Z))})},u=P=>async(O,D={})=>{let{eventName:F="iteration"}=D;for await(let q of O)P(q,F)};class h{constructor(O={}){var D,F;this.buffer="",this.writeField=(q,H)=>{let Z=this.sanitize(H);return this.buffer+=q+":"+Z+`
`,this},this.data=q=>{let H=this.serialize(q);return this.writeField("data",H),this},this.id=(q="")=>(this.writeField("id",q),this),this.retry=q=>{let H=q.toString();return this.writeField("retry",H),this},this.comment=(q="")=>(this.writeField("",q),this),this.dispatch=()=>(this.buffer+=`
`,this),this.push=(q,H="message",Z=l())=>(this.event(H).id(Z).data(q).dispatch(),this),this.stream=c(this.push),this.iterate=u(this.push),this.clear=()=>(this.buffer="",this),this.read=()=>this.buffer,this.serialize=(D=O.serializer)!==null&&D!==void 0?D:s,this.sanitize=(F=O.sanitizer)!==null&&F!==void 0?F:o}event(O){return this.writeField("event",O),this}}let _=require("events");var y=n.n(_);class b extends y(){addListener(O,D){return super.addListener(O,D)}prependListener(O,D){return super.prependListener(O,D)}prependOnceListener(O,D){return super.prependOnceListener(O,D)}on(O,D){return super.on(O,D)}once(O,D){return super.once(O,D)}emit(O,...D){return super.emit(O,...D)}off(O,D){return super.off(O,D)}removeListener(O,D){return super.removeListener(O,D)}}class x extends Error{constructor(O){super(O),this.message=`better-sse: ${O}`}}class R extends b{constructor(O,D,F={}){var q,H,Z,ue,Me,Re,ft;super(),this.lastId="",this.isConnected=!1,this.state={},this.initialize=()=>{var J,le,d;let f=`http://${this.req.headers.host}${this.req.url}`,g=new URL(f).searchParams;if(this.trustClientEventId){let m=(d=(le=(J=this.req.headers["last-event-id"])!==null&&J!==void 0?J:g.get("lastEventId"))!==null&&le!==void 0?le:g.get("evs_last_event_id"))!==null&&d!==void 0?d:"";this.lastId=m}let p={};this.res instanceof t.ServerResponse?(p["Content-Type"]="text/event-stream",p["Cache-Control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",p.Connection="keep-alive",p.Pragma="no-cache",p["X-Accel-Buffering"]="no"):(p["content-type"]="text/event-stream",p["cache-control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",p.pragma="no-cache",p["x-accel-buffering"]="no");for(let[m,S]of Object.entries(this.headers))p[m]=S??"";this.res.writeHead(this.statusCode,p),g.has("padding")&&this.buffer.comment(" ".repeat(2049)).dispatch(),g.has("evs_preamble")&&this.buffer.comment(" ".repeat(2056)).dispatch(),this.initialRetry!==null&&this.buffer.retry(this.initialRetry).dispatch(),this.flush(),this.keepAliveInterval!==null&&(this.keepAliveTimer=setInterval(this.keepAlive,this.keepAliveInterval)),this.isConnected=!0,this.emit("connected")},this.onDisconnected=()=>{this.req.removeListener("close",this.onDisconnected),this.res.removeListener("close",this.onDisconnected),this.keepAliveTimer&&clearInterval(this.keepAliveTimer),this.isConnected=!1,this.emit("disconnected")},this.keepAlive=()=>{this.buffer.comment().dispatch(),this.flush()},this.data=J=>(this.buffer.data(J),this),this.id=(J="")=>(this.buffer.id(J),this.lastId=J,this),this.retry=J=>(this.buffer.retry(J),this),this.comment=J=>(this.buffer.comment(J),this),this.dispatch=()=>(this.buffer.dispatch(),this),this.flush=()=>(this.res.write(this.buffer.read()),this.buffer.clear(),this),this.push=(J,le="message",d=l())=>{if(!this.isConnected)throw new x("Cannot push data to a non-active session.");return this.buffer.push(J,le,d),this.flush(),this.lastId=d,this.emit("push",J,le,d),this},this.stream=c(this.push),this.iterate=u(this.push),this.batch=async J=>{if(J instanceof h)this.res.write(J.read());else{let le=new h({serializer:this.serialize,sanitizer:this.sanitize});await J(le),this.res.write(le.read())}},this.req=O,this.res=D;let Yt=(q=F.serializer)!==null&&q!==void 0?q:s,ht=(H=F.sanitizer)!==null&&H!==void 0?H:o;this.serialize=Yt,this.sanitize=ht,this.buffer=new h({serializer:Yt,sanitizer:ht}),this.trustClientEventId=(Z=F.trustClientEventId)===null||Z===void 0||Z,this.initialRetry=F.retry===null?null:(ue=F.retry)!==null&&ue!==void 0?ue:2e3,this.keepAliveInterval=F.keepAlive===null?null:(Me=F.keepAlive)!==null&&Me!==void 0?Me:1e4,this.statusCode=(Re=F.statusCode)!==null&&Re!==void 0?Re:200,this.headers=(ft=F.headers)!==null&&ft!==void 0?ft:{},this.req.once("close",this.onDisconnected),this.res.once("close",this.onDisconnected),setImmediate(this.initialize)}event(O){return this.buffer.event(O),this}}let j=(...P)=>new Promise(O=>{let D=new R(...P);D.once("connected",()=>{O(D)})});class z extends b{constructor(){super(),this.state={},this.sessions=new Set,this.broadcast=(O,D="message",F={})=>{var q;let H=(q=F.eventId)!==null&&q!==void 0?q:l(),Z=F.filter?this.activeSessions.filter(F.filter):this.sessions;for(let ue of Z)ue.push(O,D,H);return this.emit("broadcast",O,D,H),this}}get activeSessions(){return Array.from(this.sessions)}get sessionCount(){return this.sessions.size}register(O){if(this.sessions.has(O))return this;if(!O.isConnected)throw new x("Cannot register a non-active session.");return O.once("disconnected",()=>{this.emit("session-disconnected",O),this.deregister(O)}),this.sessions.add(O),this.emit("session-registered",O),this}deregister(O){return this.sessions.has(O)?(this.sessions.delete(O),this.emit("session-deregistered",O),this):this}}let E=(...P)=>new z(...P),I=(...P)=>new h(...P);return e})())});var Ti=se((Ea,Pi)=>{"use strict";var{Duplex:Xr}=require("stream");function Oi(n){n.emit("close")}function Qr(){!this.destroyed&&this._writableState.finished&&this.destroy()}function Ai(n){this.removeListener("error",Ai),this.destroy(),this.listenerCount("error")===0&&this.emit("error",n)}function en(n,e){let t=!0,s=new Xr({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return n.on("message",function(r,o){let a=!o&&s._readableState.objectMode?r.toString():r;s.push(a)||n.pause()}),n.once("error",function(r){s.destroyed||(t=!1,s.destroy(r))}),n.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(i,r){if(n.readyState===n.CLOSED){r(i),process.nextTick(Oi,s);return}let o=!1;n.once("error",function(l){o=!0,r(l)}),n.once("close",function(){o||r(i),process.nextTick(Oi,s)}),t&&n.terminate()},s._final=function(i){if(n.readyState===n.CONNECTING){n.once("open",function(){s._final(i)});return}n._socket!==null&&(n._socket._writableState.finished?(i(),s._readableState.endEmitted&&s.destroy()):(n._socket.once("finish",function(){i()}),n.close()))},s._read=function(){n.isPaused&&n.resume()},s._write=function(i,r,o){if(n.readyState===n.CONNECTING){n.once("open",function(){s._write(i,r,o)});return}n.send(i,o)},s.on("end",Qr),s.on("error",Ai),s}Pi.exports=en});var ve=se((Ca,Ei)=>{"use strict";Ei.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Ye=se((Na,Ct)=>{"use strict";var{EMPTY_BUFFER:tn}=ve(),cs=Buffer[Symbol.species];function sn(n,e){if(n.length===0)return tn;if(n.length===1)return n[0];let t=Buffer.allocUnsafe(e),s=0;for(let i=0;i<n.length;i++){let r=n[i];t.set(r,s),s+=r.length}return s<e?new cs(t.buffer,t.byteOffset,s):t}function Ci(n,e,t,s,i){for(let r=0;r<i;r++)t[s+r]=n[r]^e[r&3]}function Ni(n,e){for(let t=0;t<n.length;t++)n[t]^=e[t&3]}function rn(n){return n.length===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.length)}function fs(n){if(fs.readOnly=!0,Buffer.isBuffer(n))return n;let e;return n instanceof ArrayBuffer?e=new cs(n):ArrayBuffer.isView(n)?e=new cs(n.buffer,n.byteOffset,n.byteLength):(e=Buffer.from(n),fs.readOnly=!1),e}Ct.exports={concat:sn,mask:Ci,toArrayBuffer:rn,toBuffer:fs,unmask:Ni};if(!process.env.WS_NO_BUFFER_UTIL)try{let n=require("bufferutil");Ct.exports.mask=function(e,t,s,i,r){r<48?Ci(e,t,s,i,r):n.mask(e,t,s,i,r)},Ct.exports.unmask=function(e,t){e.length<32?Ni(e,t):n.unmask(e,t)}}catch{}});var Di=se((ja,Ii)=>{"use strict";var ji=Symbol("kDone"),hs=Symbol("kRun"),us=class{constructor(e){this[ji]=()=>{this.pending--,this[hs]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[hs]()}[hs](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[ji])}}};Ii.exports=us});var Xe=se((Ia,Ri)=>{"use strict";var Ke=require("zlib"),Li=Ye(),nn=Di(),{kStatusCode:Ui}=ve(),on=Buffer[Symbol.species],an=Buffer.from([0,0,255,255]),It=Symbol("permessage-deflate"),pe=Symbol("total-length"),Ze=Symbol("callback"),Se=Symbol("buffers"),jt=Symbol("error"),Nt,ds=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Nt){let i=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Nt=new nn(i)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[Ze];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(i=>!(t.serverNoContextTakeover===!1&&i.server_no_context_takeover||i.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>i.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!i.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let i=t[s];if(i.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(i=i[0],s==="client_max_window_bits"){if(i!==!0){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else if(s==="server_max_window_bits"){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(i!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=i})}),e}decompress(e,t,s){Nt.add(i=>{this._decompress(e,t,(r,o)=>{i(),s(r,o)})})}compress(e,t,s){Nt.add(i=>{this._compress(e,t,(r,o)=>{i(),s(r,o)})})}_decompress(e,t,s){let i=this._isServer?"client":"server";if(!this._inflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ke.Z_DEFAULT_WINDOWBITS:this.params[r];this._inflate=Ke.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[It]=this,this._inflate[pe]=0,this._inflate[Se]=[],this._inflate.on("error",cn),this._inflate.on("data",Mi)}this._inflate[Ze]=s,this._inflate.write(e),t&&this._inflate.write(an),this._inflate.flush(()=>{let r=this._inflate[jt];if(r){this._inflate.close(),this._inflate=null,s(r);return}let o=Li.concat(this._inflate[Se],this._inflate[pe]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[pe]=0,this._inflate[Se]=[],t&&this.params[`${i}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let i=this._isServer?"server":"client";if(!this._deflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ke.Z_DEFAULT_WINDOWBITS:this.params[r];this._deflate=Ke.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[pe]=0,this._deflate[Se]=[],this._deflate.on("data",ln)}this._deflate[Ze]=s,this._deflate.write(e),this._deflate.flush(Ke.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let r=Li.concat(this._deflate[Se],this._deflate[pe]);t&&(r=new on(r.buffer,r.byteOffset,r.length-4)),this._deflate[Ze]=null,this._deflate[pe]=0,this._deflate[Se]=[],t&&this.params[`${i}_no_context_takeover`]&&this._deflate.reset(),s(null,r)})}};Ri.exports=ds;function ln(n){this[Se].push(n),this[pe]+=n.length}function Mi(n){if(this[pe]+=n.length,this[It]._maxPayload<1||this[pe]<=this[It]._maxPayload){this[Se].push(n);return}this[jt]=new RangeError("Max payload size exceeded"),this[jt].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[jt][Ui]=1009,this.removeListener("data",Mi),this.reset()}function cn(n){this[It]._inflate=null,n[Ui]=1007,this[Ze](n)}});var Qe=se((Da,Dt)=>{"use strict";var{isUtf8:zi}=require("buffer"),fn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function hn(n){return n>=1e3&&n<=1014&&n!==1004&&n!==1005&&n!==1006||n>=3e3&&n<=4999}function _s(n){let e=n.length,t=0;for(;t<e;)if(!(n[t]&128))t++;else if((n[t]&224)===192){if(t+1===e||(n[t+1]&192)!==128||(n[t]&254)===192)return!1;t+=2}else if((n[t]&240)===224){if(t+2>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||n[t]===224&&(n[t+1]&224)===128||n[t]===237&&(n[t+1]&224)===160)return!1;t+=3}else if((n[t]&248)===240){if(t+3>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||(n[t+3]&192)!==128||n[t]===240&&(n[t+1]&240)===128||n[t]===244&&n[t+1]>143||n[t]>244)return!1;t+=4}else return!1;return!0}Dt.exports={isValidStatusCode:hn,isValidUTF8:_s,tokenChars:fn};if(zi)Dt.exports.isValidUTF8=function(n){return n.length<24?_s(n):zi(n)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let n=require("utf-8-validate");Dt.exports.isValidUTF8=function(e){return e.length<32?_s(e):n(e)}}catch{}});var bs=se((La,Ji)=>{"use strict";var{Writable:un}=require("stream"),Fi=Xe(),{BINARY_TYPES:dn,EMPTY_BUFFER:Bi,kStatusCode:_n,kWebSocket:gn}=ve(),{concat:gs,toArrayBuffer:pn,unmask:yn}=Ye(),{isValidStatusCode:mn,isValidUTF8:Gi}=Qe(),Lt=Buffer[Symbol.species],ae=0,qi=1,$i=2,Wi=3,ps=4,ys=5,Ut=6,ms=class extends un{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||dn[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[gn]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=ae}_write(e,t,s){if(this._opcode===8&&this._state==ae)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new Lt(s.buffer,s.byteOffset+e,s.length-e),new Lt(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],i=t.length-e;e>=s.length?t.set(this._buffers.shift(),i):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),i),this._buffers[0]=new Lt(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case ae:this.getInfo(e);break;case qi:this.getPayloadLength16(e);break;case $i:this.getPayloadLength64(e);break;case Wi:this.getMask();break;case ps:this.getData(e);break;case ys:case Ut:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48){let i=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(i);return}let s=(t[0]&64)===64;if(s&&!this._extensions[Fi.extensionName]){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(!this._fragmented){let i=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let i=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(i);return}if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let i=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(i);return}}else{let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let i=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(i);return}}else if(this._masked){let i=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(i);return}this._payloadLength===126?this._state=qi:this._payloadLength===127?this._state=$i:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let i=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(i);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=Wi:this._state=ps}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=ps}getData(e){let t=Bi;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&yn(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=ys,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[Fi.extensionName].decompress(e,this._fin,(i,r)=>{if(i)return t(i);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(r)}this.dataMessage(t),this._state===ae&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=ae;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let i;this._binaryType==="nodebuffer"?i=gs(s,t):this._binaryType==="arraybuffer"?i=pn(gs(s,t)):i=s,this._allowSynchronousEvents?(this.emit("message",i,!0),this._state=ae):(this._state=Ut,setImmediate(()=>{this.emit("message",i,!0),this._state=ae,this.startLoop(e)}))}else{let i=gs(s,t);if(!this._skipUTF8Validation&&!Gi(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(r);return}this._state===ys||this._allowSynchronousEvents?(this.emit("message",i,!1),this._state=ae):(this._state=Ut,setImmediate(()=>{this.emit("message",i,!1),this._state=ae,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,Bi),this.end();else{let s=e.readUInt16BE(0);if(!mn(s)){let r=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(r);return}let i=new Lt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Gi(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(r);return}this._loop=!1,this.emit("conclude",s,i),this.end()}this._state=ae;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=ae):(this._state=Ut,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=ae,this.startLoop(t)}))}createError(e,t,s,i,r){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=r,o[_n]=i,o}};Ji.exports=ms});var Ss=se((Ma,Yi)=>{"use strict";var{Duplex:Ua}=require("stream"),{randomFillSync:bn}=require("crypto"),Hi=Xe(),{EMPTY_BUFFER:vn}=ve(),{isValidStatusCode:Sn}=Qe(),{mask:Vi,toBuffer:Ie}=Ye(),he=Symbol("kByteLength"),wn=Buffer.alloc(4),Mt=8*1024,Ae,De=Mt,vs=class n{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let s,i=!1,r=2,o=!1;t.mask&&(s=t.maskBuffer||wn,t.generateMask?t.generateMask(s):(De===Mt&&(Ae===void 0&&(Ae=Buffer.alloc(Mt)),bn(Ae,0,Mt),De=0),s[0]=Ae[De++],s[1]=Ae[De++],s[2]=Ae[De++],s[3]=Ae[De++]),o=(s[0]|s[1]|s[2]|s[3])===0,r=6);let a;typeof e=="string"?(!t.mask||o)&&t[he]!==void 0?a=t[he]:(e=Buffer.from(e),a=e.length):(a=e.length,i=t.mask&&t.readOnly&&!o);let l=a;a>=65536?(r+=8,l=127):a>125&&(r+=2,l=126);let c=Buffer.allocUnsafe(i?a+r:r);return c[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(c[0]|=64),c[1]=l,l===126?c.writeUInt16BE(a,2):l===127&&(c[2]=c[3]=0,c.writeUIntBE(a,4,6)),t.mask?(c[1]|=128,c[r-4]=s[0],c[r-3]=s[1],c[r-2]=s[2],c[r-1]=s[3],o?[c,e]:i?(Vi(e,s,c,r,a),[c]):(Vi(e,s,e,0,a),[c,e])):[c,e]}close(e,t,s,i){let r;if(e===void 0)r=vn;else{if(typeof e!="number"||!Sn(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)r=Buffer.allocUnsafe(2),r.writeUInt16BE(e,0);else{let a=Buffer.byteLength(t);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");r=Buffer.allocUnsafe(2+a),r.writeUInt16BE(e,0),typeof t=="string"?r.write(t,2):r.set(t,2)}}let o={[he]:r.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,r,!1,o,i]):this.sendFrame(n.frame(r,o),i)}ping(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=Ie(e),i=e.length,r=Ie.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[he]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}pong(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=Ie(e),i=e.length,r=Ie.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[he]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}send(e,t,s){let i=this._extensions[Hi.extensionName],r=t.binary?2:1,o=t.compress,a,l;if(typeof e=="string"?(a=Buffer.byteLength(e),l=!1):(e=Ie(e),a=e.length,l=Ie.readOnly),this._firstFragment?(this._firstFragment=!1,o&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=i._threshold),this._compress=o):(o=!1,r=0),t.fin&&(this._firstFragment=!0),i){let c={[he]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:o};this._deflating?this.enqueue([this.dispatch,e,this._compress,c,s]):this.dispatch(e,this._compress,c,s)}else this.sendFrame(n.frame(e,{[he]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:!1}),s)}dispatch(e,t,s,i){if(!t){this.sendFrame(n.frame(e,s),i);return}let r=this._extensions[Hi.extensionName];this._bufferedBytes+=s[he],this._deflating=!0,r.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");typeof i=="function"&&i(l);for(let c=0;c<this._queue.length;c++){let u=this._queue[c],h=u[u.length-1];typeof h=="function"&&h(l)}return}this._bufferedBytes-=s[he],this._deflating=!1,s.readOnly=!1,this.sendFrame(n.frame(a,s),i),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][he],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][he],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Yi.exports=vs});var rr=se((Ra,ir)=>{"use strict";var{kForOnEventAttribute:et,kListener:ws}=ve(),Ki=Symbol("kCode"),Zi=Symbol("kData"),Xi=Symbol("kError"),Qi=Symbol("kMessage"),er=Symbol("kReason"),Le=Symbol("kTarget"),tr=Symbol("kType"),sr=Symbol("kWasClean"),ye=class{constructor(e){this[Le]=null,this[tr]=e}get target(){return this[Le]}get type(){return this[tr]}};Object.defineProperty(ye.prototype,"target",{enumerable:!0});Object.defineProperty(ye.prototype,"type",{enumerable:!0});var Pe=class extends ye{constructor(e,t={}){super(e),this[Ki]=t.code===void 0?0:t.code,this[er]=t.reason===void 0?"":t.reason,this[sr]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Ki]}get reason(){return this[er]}get wasClean(){return this[sr]}};Object.defineProperty(Pe.prototype,"code",{enumerable:!0});Object.defineProperty(Pe.prototype,"reason",{enumerable:!0});Object.defineProperty(Pe.prototype,"wasClean",{enumerable:!0});var Ue=class extends ye{constructor(e,t={}){super(e),this[Xi]=t.error===void 0?null:t.error,this[Qi]=t.message===void 0?"":t.message}get error(){return this[Xi]}get message(){return this[Qi]}};Object.defineProperty(Ue.prototype,"error",{enumerable:!0});Object.defineProperty(Ue.prototype,"message",{enumerable:!0});var tt=class extends ye{constructor(e,t={}){super(e),this[Zi]=t.data===void 0?null:t.data}get data(){return this[Zi]}};Object.defineProperty(tt.prototype,"data",{enumerable:!0});var kn={addEventListener(n,e,t={}){for(let i of this.listeners(n))if(!t[et]&&i[ws]===e&&!i[et])return;let s;if(n==="message")s=function(r,o){let a=new tt("message",{data:o?r:r.toString()});a[Le]=this,Rt(e,this,a)};else if(n==="close")s=function(r,o){let a=new Pe("close",{code:r,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[Le]=this,Rt(e,this,a)};else if(n==="error")s=function(r){let o=new Ue("error",{error:r,message:r.message});o[Le]=this,Rt(e,this,o)};else if(n==="open")s=function(){let r=new ye("open");r[Le]=this,Rt(e,this,r)};else return;s[et]=!!t[et],s[ws]=e,t.once?this.once(n,s):this.on(n,s)},removeEventListener(n,e){for(let t of this.listeners(n))if(t[ws]===e&&!t[et]){this.removeListener(n,t);break}}};ir.exports={CloseEvent:Pe,ErrorEvent:Ue,Event:ye,EventTarget:kn,MessageEvent:tt};function Rt(n,e,t){typeof n=="object"&&n.handleEvent?n.handleEvent.call(n,t):n.call(e,t)}});var ks=se((za,nr)=>{"use strict";var{tokenChars:st}=Qe();function _e(n,e,t){n[e]===void 0?n[e]=[t]:n[e].push(t)}function xn(n){let e=Object.create(null),t=Object.create(null),s=!1,i=!1,r=!1,o,a,l=-1,c=-1,u=-1,h=0;for(;h<n.length;h++)if(c=n.charCodeAt(h),o===void 0)if(u===-1&&st[c]===1)l===-1&&(l=h);else if(h!==0&&(c===32||c===9))u===-1&&l!==-1&&(u=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);u===-1&&(u=h);let y=n.slice(l,u);c===44?(_e(e,y,t),t=Object.create(null)):o=y,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(u===-1&&st[c]===1)l===-1&&(l=h);else if(c===32||c===9)u===-1&&l!==-1&&(u=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);u===-1&&(u=h),_e(t,n.slice(l,u),!0),c===44&&(_e(e,o,t),t=Object.create(null),o=void 0),l=u=-1}else if(c===61&&l!==-1&&u===-1)a=n.slice(l,h),l=u=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(i){if(st[c]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:s||(s=!0),i=!1}else if(r)if(st[c]===1)l===-1&&(l=h);else if(c===34&&l!==-1)r=!1,u=h;else if(c===92)i=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(c===34&&n.charCodeAt(h-1)===61)r=!0;else if(u===-1&&st[c]===1)l===-1&&(l=h);else if(l!==-1&&(c===32||c===9))u===-1&&(u=h);else if(c===59||c===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);u===-1&&(u=h);let y=n.slice(l,u);s&&(y=y.replace(/\\/g,""),s=!1),_e(t,a,y),c===44&&(_e(e,o,t),t=Object.create(null),o=void 0),a=void 0,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);if(l===-1||r||c===32||c===9)throw new SyntaxError("Unexpected end of input");u===-1&&(u=h);let _=n.slice(l,u);return o===void 0?_e(e,_,t):(a===void 0?_e(t,_,!0):s?_e(t,a,_.replace(/\\/g,"")):_e(t,a,_),_e(e,o,t)),e}function On(n){return Object.keys(n).map(e=>{let t=n[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(i=>{let r=s[i];return Array.isArray(r)||(r=[r]),r.map(o=>o===!0?i:`${i}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}nr.exports={format:On,parse:xn}});var Ts=se((Ga,pr)=>{"use strict";var An=require("events"),Pn=require("https"),Tn=require("http"),lr=require("net"),En=require("tls"),{randomBytes:Cn,createHash:Nn}=require("crypto"),{Duplex:Fa,Readable:Ba}=require("stream"),{URL:xs}=require("url"),we=Xe(),jn=bs(),In=Ss(),{BINARY_TYPES:or,EMPTY_BUFFER:zt,GUID:Dn,kForOnEventAttribute:Os,kListener:Ln,kStatusCode:Un,kWebSocket:Q,NOOP:cr}=ve(),{EventTarget:{addEventListener:Mn,removeEventListener:Rn}}=rr(),{format:zn,parse:Fn}=ks(),{toBuffer:Bn}=Ye(),Gn=30*1e3,fr=Symbol("kAborted"),As=[8,13],me=["CONNECTING","OPEN","CLOSING","CLOSED"],qn=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,V=class n extends An{constructor(e,t,s){super(),this._binaryType=or[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=zt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=n.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),hr(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){or.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let i=new jn({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation});this._sender=new In(e,this._extensions,s.generateMask),this._receiver=i,this._socket=e,i[Q]=this,e[Q]=this,i.on("conclude",Jn),i.on("drain",Hn),i.on("error",Vn),i.on("message",Yn),i.on("ping",Kn),i.on("pong",Zn),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",dr),e.on("data",Bt),e.on("end",_r),e.on("error",gr),this._readyState=n.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[we.extensionName]&&this._extensions[we.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){oe(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===n.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=n.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),Gn)}}pause(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||zt,t,s)}pong(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||zt,t,s)}resume(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}let i={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[we.extensionName]||(i.compress=!1),this._sender.send(e||zt,i,s)}terminate(){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){oe(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=n.CLOSING,this._socket.destroy())}}};Object.defineProperty(V,"CONNECTING",{enumerable:!0,value:me.indexOf("CONNECTING")});Object.defineProperty(V.prototype,"CONNECTING",{enumerable:!0,value:me.indexOf("CONNECTING")});Object.defineProperty(V,"OPEN",{enumerable:!0,value:me.indexOf("OPEN")});Object.defineProperty(V.prototype,"OPEN",{enumerable:!0,value:me.indexOf("OPEN")});Object.defineProperty(V,"CLOSING",{enumerable:!0,value:me.indexOf("CLOSING")});Object.defineProperty(V.prototype,"CLOSING",{enumerable:!0,value:me.indexOf("CLOSING")});Object.defineProperty(V,"CLOSED",{enumerable:!0,value:me.indexOf("CLOSED")});Object.defineProperty(V.prototype,"CLOSED",{enumerable:!0,value:me.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(n=>{Object.defineProperty(V.prototype,n,{enumerable:!0})});["open","error","close","message"].forEach(n=>{Object.defineProperty(V.prototype,`on${n}`,{enumerable:!0,get(){for(let e of this.listeners(n))if(e[Os])return e[Ln];return null},set(e){for(let t of this.listeners(n))if(t[Os]){this.removeListener(n,t);break}typeof e=="function"&&this.addEventListener(n,e,{[Os]:!0})}})});V.prototype.addEventListener=Mn;V.prototype.removeEventListener=Rn;pr.exports=V;function hr(n,e,t,s){let i={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:As[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(n._autoPong=i.autoPong,!As.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${As.join(", ")})`);let r;if(e instanceof xs)r=e;else try{r=new xs(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}r.protocol==="http:"?r.protocol="ws:":r.protocol==="https:"&&(r.protocol="wss:"),n._url=r.href;let o=r.protocol==="wss:",a=r.protocol==="ws+unix:",l;if(r.protocol!=="ws:"&&!o&&!a?l=`The URL's protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"`:a&&!r.pathname?l="The URL's pathname is empty":r.hash&&(l="The URL contains a fragment identifier"),l){let x=new SyntaxError(l);if(n._redirects===0)throw x;Ft(n,x);return}let c=o?443:80,u=Cn(16).toString("base64"),h=o?Pn.request:Tn.request,_=new Set,y;if(i.createConnection=i.createConnection||(o?Wn:$n),i.defaultPort=i.defaultPort||c,i.port=r.port||c,i.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,i.headers={...i.headers,"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket"},i.path=r.pathname+r.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(y=new we(i.perMessageDeflate!==!0?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=zn({[we.extensionName]:y.offer()})),t.length){for(let x of t){if(typeof x!="string"||!qn.test(x)||_.has(x))throw new SyntaxError("An invalid or duplicated subprotocol was specified");_.add(x)}i.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(r.username||r.password)&&(i.auth=`${r.username}:${r.password}`),a){let x=i.path.split(":");i.socketPath=x[0],i.path=x[1]}let b;if(i.followRedirects){if(n._redirects===0){n._originalIpc=a,n._originalSecure=o,n._originalHostOrSocketPath=a?i.socketPath:r.host;let x=s&&s.headers;if(s={...s,headers:{}},x)for(let[R,j]of Object.entries(x))s.headers[R.toLowerCase()]=j}else if(n.listenerCount("redirect")===0){let x=a?n._originalIpc?i.socketPath===n._originalHostOrSocketPath:!1:n._originalIpc?!1:r.host===n._originalHostOrSocketPath;(!x||n._originalSecure&&!o)&&(delete i.headers.authorization,delete i.headers.cookie,x||delete i.headers.host,i.auth=void 0)}i.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),b=n._req=h(i),n._redirects&&n.emit("redirect",n.url,b)}else b=n._req=h(i);i.timeout&&b.on("timeout",()=>{oe(n,b,"Opening handshake has timed out")}),b.on("error",x=>{b===null||b[fr]||(b=n._req=null,Ft(n,x))}),b.on("response",x=>{let R=x.headers.location,j=x.statusCode;if(R&&i.followRedirects&&j>=300&&j<400){if(++n._redirects>i.maxRedirects){oe(n,b,"Maximum redirects exceeded");return}b.abort();let z;try{z=new xs(R,e)}catch{let I=new SyntaxError(`Invalid URL: ${R}`);Ft(n,I);return}hr(n,z,t,s)}else n.emit("unexpected-response",b,x)||oe(n,b,`Unexpected server response: ${x.statusCode}`)}),b.on("upgrade",(x,R,j)=>{if(n.emit("upgrade",x),n.readyState!==V.CONNECTING)return;b=n._req=null;let z=x.headers.upgrade;if(z===void 0||z.toLowerCase()!=="websocket"){oe(n,R,"Invalid Upgrade header");return}let E=Nn("sha1").update(u+Dn).digest("base64");if(x.headers["sec-websocket-accept"]!==E){oe(n,R,"Invalid Sec-WebSocket-Accept header");return}let I=x.headers["sec-websocket-protocol"],P;if(I!==void 0?_.size?_.has(I)||(P="Server sent an invalid subprotocol"):P="Server sent a subprotocol but none was requested":_.size&&(P="Server sent no subprotocol"),P){oe(n,R,P);return}I&&(n._protocol=I);let O=x.headers["sec-websocket-extensions"];if(O!==void 0){if(!y){oe(n,R,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let D;try{D=Fn(O)}catch{oe(n,R,"Invalid Sec-WebSocket-Extensions header");return}let F=Object.keys(D);if(F.length!==1||F[0]!==we.extensionName){oe(n,R,"Server indicated an extension that was not requested");return}try{y.accept(D[we.extensionName])}catch{oe(n,R,"Invalid Sec-WebSocket-Extensions header");return}n._extensions[we.extensionName]=y}n.setSocket(R,j,{allowSynchronousEvents:i.allowSynchronousEvents,generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})}),i.finishRequest?i.finishRequest(b,n):b.end()}function Ft(n,e){n._readyState=V.CLOSING,n.emit("error",e),n.emitClose()}function $n(n){return n.path=n.socketPath,lr.connect(n)}function Wn(n){return n.path=void 0,!n.servername&&n.servername!==""&&(n.servername=lr.isIP(n.host)?"":n.host),En.connect(n)}function oe(n,e,t){n._readyState=V.CLOSING;let s=new Error(t);Error.captureStackTrace(s,oe),e.setHeader?(e[fr]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(Ft,n,s)):(e.destroy(s),e.once("error",n.emit.bind(n,"error")),e.once("close",n.emitClose.bind(n)))}function Ps(n,e,t){if(e){let s=Bn(e).length;n._socket?n._sender._bufferedBytes+=s:n._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${n.readyState} (${me[n.readyState]})`);process.nextTick(t,s)}}function Jn(n,e){let t=this[Q];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=n,t._socket[Q]!==void 0&&(t._socket.removeListener("data",Bt),process.nextTick(ur,t._socket),n===1005?t.close():t.close(n,e))}function Hn(){let n=this[Q];n.isPaused||n._socket.resume()}function Vn(n){let e=this[Q];e._socket[Q]!==void 0&&(e._socket.removeListener("data",Bt),process.nextTick(ur,e._socket),e.close(n[Un])),e.emit("error",n)}function ar(){this[Q].emitClose()}function Yn(n,e){this[Q].emit("message",n,e)}function Kn(n){let e=this[Q];e._autoPong&&e.pong(n,!this._isServer,cr),e.emit("ping",n)}function Zn(n){this[Q].emit("pong",n)}function ur(n){n.resume()}function dr(){let n=this[Q];this.removeListener("close",dr),this.removeListener("data",Bt),this.removeListener("end",_r),n._readyState=V.CLOSING;let e;!this._readableState.endEmitted&&!n._closeFrameReceived&&!n._receiver._writableState.errorEmitted&&(e=n._socket.read())!==null&&n._receiver.write(e),n._receiver.end(),this[Q]=void 0,clearTimeout(n._closeTimer),n._receiver._writableState.finished||n._receiver._writableState.errorEmitted?n.emitClose():(n._receiver.on("error",ar),n._receiver.on("finish",ar))}function Bt(n){this[Q]._receiver.write(n)||this.pause()}function _r(){let n=this[Q];n._readyState=V.CLOSING,n._receiver.end(),this.end()}function gr(){let n=this[Q];this.removeListener("error",gr),this.on("error",cr),n&&(n._readyState=V.CLOSING,this.destroy())}});var mr=se((qa,yr)=>{"use strict";var{tokenChars:Xn}=Qe();function Qn(n){let e=new Set,t=-1,s=-1,i=0;for(i;i<n.length;i++){let o=n.charCodeAt(i);if(s===-1&&Xn[o]===1)t===-1&&(t=i);else if(i!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=i);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${i}`);s===-1&&(s=i);let a=n.slice(t,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${i}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let r=n.slice(t,i);if(e.has(r))throw new SyntaxError(`The "${r}" subprotocol is duplicated`);return e.add(r),e}yr.exports={parse:Qn}});var Or=se((Wa,xr)=>{"use strict";var eo=require("events"),Gt=require("http"),{Duplex:$a}=require("stream"),{createHash:to}=require("crypto"),br=ks(),Te=Xe(),so=mr(),io=Ts(),{GUID:ro,kWebSocket:no}=ve(),oo=/^[+/0-9A-Za-z]{22}==$/,vr=0,Sr=1,kr=2,Es=class extends eo{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:io,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=Gt.createServer((s,i)=>{let r=Gt.STATUS_CODES[426];i.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),i.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=ao(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,r,o)=>{this.handleUpgrade(i,r,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=vr}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===kr){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(it,this);return}if(e&&this.once("close",e),this._state!==Sr)if(this._state=Sr,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(it,this):process.nextTick(it,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{it(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,i){t.on("error",wr);let r=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){Ee(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){Ee(this,e,t,400,"Invalid Upgrade header");return}if(r===void 0||!oo.test(r)){Ee(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==8&&a!==13){Ee(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){rt(t,400);return}let l=e.headers["sec-websocket-protocol"],c=new Set;if(l!==void 0)try{c=so.parse(l)}catch{Ee(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let u=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&u!==void 0){let _=new Te(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let y=br.parse(u);y[Te.extensionName]&&(_.accept(y[Te.extensionName]),h[Te.extensionName]=_)}catch{Ee(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let _={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(_,(y,b,x,R)=>{if(!y)return rt(t,b||401,x,R);this.completeUpgrade(h,r,c,e,t,s,i)});return}if(!this.options.verifyClient(_))return rt(t,401)}this.completeUpgrade(h,r,c,e,t,s,i)}completeUpgrade(e,t,s,i,r,o,a){if(!r.readable||!r.writable)return r.destroy();if(r[no])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>vr)return rt(r,503);let c=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${to("sha1").update(t+ro).digest("base64")}`],u=new this.options.WebSocket(null,void 0,this.options);if(s.size){let h=this.options.handleProtocols?this.options.handleProtocols(s,i):s.values().next().value;h&&(c.push(`Sec-WebSocket-Protocol: ${h}`),u._protocol=h)}if(e[Te.extensionName]){let h=e[Te.extensionName].params,_=br.format({[Te.extensionName]:[h]});c.push(`Sec-WebSocket-Extensions: ${_}`),u._extensions=e}this.emit("headers",c,i),r.write(c.concat(`\r
`).join(`\r
`)),r.removeListener("error",wr),u.setSocket(r,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(u),u.on("close",()=>{this.clients.delete(u),this._shouldEmitClose&&!this.clients.size&&process.nextTick(it,this)})),a(u,i)}};xr.exports=Es;function ao(n,e){for(let t of Object.keys(e))n.on(t,e[t]);return function(){for(let s of Object.keys(e))n.removeListener(s,e[s])}}function it(n){n._state=kr,n.emit("close")}function wr(){this.destroy()}function rt(n,e,t,s){t=t||Gt.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},n.once("finish",n.destroy),n.end(`HTTP/1.1 ${e} ${Gt.STATUS_CODES[e]}\r
`+Object.keys(s).map(i=>`${i}: ${s[i]}`).join(`\r
`)+`\r
\r
`+t)}function Ee(n,e,t,s,i){if(n.listenerCount("wsClientError")){let r=new Error(i);Error.captureStackTrace(r,Ee),n.emit("wsClientError",r,t,e)}else rt(t,s,i)}});var bo={};Zs(bo,{AuthorizationStruct:()=>zs,CMDService:()=>Ns,Callable:()=>dt,ChatroomStruct:()=>qs,CircularBuffer:()=>vt,CoherenceMap:()=>$t,CoherenceStruct:()=>qt,CommentStruct:()=>$s,DS:()=>re,Data:()=>Er,DataStruct:()=>Bs,DataTablet:()=>lt,DateStruct:()=>Hs,DelayBuffer:()=>St,DelayBufferManager:()=>qe,E2EEService:()=>is,ECGStruct:()=>Jt,EDAStruct:()=>Ds,EEGCoordinates:()=>Tr,EEGStruct:()=>be,EMGStruct:()=>Ms,EventHandler:()=>Fe,EventStruct:()=>Gs,EyeTrackerStruct:()=>Is,FNIRSStruct:()=>Wt,FrequencyBandsStruct:()=>at,Graph:()=>de,GraphNode:()=>$,GroupStruct:()=>Fs,HRVStruct:()=>Us,HTTPbackend:()=>os,IMUStruct:()=>js,InputBuffer:()=>bt,NotificationStruct:()=>Ws,PPGStruct:()=>Ls,ProfileStruct:()=>Rs,Router:()=>Xt,SSEbackend:()=>ls,ScheduleStruct:()=>Js,Service:()=>ee,SessionManager:()=>$e,SessionService:()=>es,Struct:()=>Y,StructBackend:()=>Ks,StructFrontend:()=>Vs,WSSbackend:()=>Cs,animate:()=>si,backprop:()=>ei,bindListener:()=>ni,branching:()=>ii,connectionHasId:()=>Qt,defaultCollections:()=>Rr,defaultManifest:()=>ns,defaultServiceWorker:()=>rs,defaultSpecifiers:()=>Nr,eegCoordinates:()=>Oe,genTimeSpecifiers:()=>uo,genTimestampFromString:()=>ge,getAllProperties:()=>Zt,getCallbackFromString:()=>Be,getFnParamNames:()=>Jr,getFunctionHead:()=>ci,getStringId:()=>N,htmlBodyBoilerPlate:()=>Yr,instanceObject:()=>Wr,isFunction:()=>Qs,isNativeClass:()=>_t,isTypedArray:()=>di,loaders:()=>pt,loop:()=>ti,methodstrings:()=>Vr,parseFunctionFromText:()=>yt,pseudoObjectId:()=>_o,randomId:()=>jr,reconstructObject:()=>Hr,recursivelyAssign:()=>mt,recursivelyStringifyFunctions:()=>li,scriptBoilerPlate:()=>Kr,setCoordinate:()=>ot,spliceTypedArray:()=>_i,state:()=>Kt,stringifyFast:()=>ui,stringifyWithCircularRefs:()=>fi,stringifyWithFunctionsAndCircularRefs:()=>hi,structRegistry:()=>Cr,substitute__operator:()=>ai,toObjectId:()=>K,transformListenerResult:()=>oi,triggerListenerOncreate:()=>ri,wrapArgs:()=>gt});module.exports=$r(bo);var Fe=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let s of t)this.triggerEvent(s,this.data[s]);if(this.triggers[ze]){let s=r=>{r(e)},i=this.triggers[ze].length;for(let r=i-1;r>=0;r--)s(this.triggers[ze][r].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let s=r=>{r.onchange(t)},i=this.triggers[e].length;for(let r=i-1;r>=0;r--)s(this.triggers[e][r])}};subscribeState=e=>this.subscribeEvent(ze,e);unsubscribeState=e=>this.unsubscribeEvent(ze,e);subscribeEvent=(e,t,s,i)=>{if(e){s&&i&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>s[i],set:o=>{s[i]=o},enumerable:!0,configurable:!0}),this.triggers[e]||(this.triggers[e]=[]);let r=this.ctr;return this.ctr++,this.triggers[e].push({sub:r,onchange:t}),r}else return};unsubscribeEvent=(e,t)=>{let s=this.triggers[e];if(s)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let i,r=s.find((o,a)=>{if(o.sub===t)return i=a,!0});return r&&s.splice(i,1),Object.keys(s).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(r),!0}};subscribeEventOnce=(e,t)=>{let s,i=r=>{t(r),this.unsubscribeEvent(e,s)};return s=this.subscribeEvent(e,i),s};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let s in this.triggers[e])if(this.triggers[e][s].sub===t)return this.triggers[e][s]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved},ze="*s";var Kt=new Fe,dt=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},$=class n{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:Kt};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,s){if(this.__setProperties(e,t,s),typeof e=="function"||e?.__callable){let i=new dt;i.__call=(...o)=>this.__operator(...o);let r=new Proxy(i,{get:(o,a,l)=>Reflect.has(this,a)?Reflect.get(this,a,l):Reflect.get(o,a,l),set:(o,a,l,c)=>Reflect.has(this,a)?Reflect.set(this,a,l,c):Reflect.set(o,a,l,c)});return Object.setPrototypeOf(r,this),r}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,s)=>{if((()=>{let r=e;typeof e=="function"?_t(e)?e=new e:e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&s?.get(e)&&(e=s.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=r)})(),typeof e=="object"){let r=()=>{e.__node?.state?this.__node.state=e.__node.state:s&&(e.__node.state=s.__node.state)},o=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},a=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},l=()=>{typeof e.__node=="string"?s?.get(e.__node.tag)?e=s.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),s&&(e.__node.graph=s),e instanceof de&&(e.__node.source=e)},c=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof de||e instanceof de)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof de&&e instanceof de&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(b=>{t.set(e.__node.tag+"."+b.__node.tag,b)});let y=()=>{e.__node.nodes.forEach(b=>{t.__node.nodes.delete(e.__node.tag+"."+b.__node.tag)})};this.__addOndisconnected(y)}},u=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&s){let y=s.get(e.__operator);y&&(e.__operator=y.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},h=()=>{e.__node=Object.assign(this.__node,e.__node);let y=Object.getOwnPropertyNames(e).filter(b=>{if(!Ne[b])return!0});for(let b of y)b in e&&b!=="name"&&(this[b]=e[b])},_=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(y=>y.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(y=>y.bind(this))))};r(),a(),o(),l(),c(),h(),_(),u()}};__subscribe=(e,t,s,i,r,o,a)=>{let l=(u,h=(y,b)=>b||y,_=e)=>{let y;if(o){let R=gt(_,o,this.__node.graph);_=R.__callback,y=R.__args}let b=this.__node.state.subscribeEvent(u,_,this,t),x=this.__node.state.getEvent(u,b);return this.__listeners||(this.__listeners={}),this.__listeners[u]=this.__node.state.triggers[u],x&&(x.source=this.__node.tag,t&&(x.key=t),x.target=h(e,i),r&&(x.tkey=r),s&&(x.subInput=s),o&&(x.arguments=y,x.__args=o),a&&(x.__callback=a),x.node=this,x.graph=this.__node.graph),b},c=u=>{let h=this.__node.graph.get(u);if(!h&&u.includes(".")){i=u.substring(0,u.lastIndexOf("."));let _=this.__node.graph.get(u.substring(0,i));r=u.lastIndexOf(".")+1,_&&typeof _[t]=="function"&&(u=(...y)=>_[r](...y))}else h.__operator&&(u=h.__operator,r="__operator");return u};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(a=this.__node.tag+"."+e,r=e,i){if(this.__node.graph?.get(i)){let _=this.__node.graph?.get(i);if(typeof _[e]=="function"){let y=_[e];e=(...b)=>{y(...b)}}else{let y=e;e=x=>{_[y]=x}}}}else if(typeof this[e]=="function"){let _=this[e];e=(...y)=>{_(...y)}}else this.__node.graph?.get(e)&&(e=c(e));if(typeof e!="function")return}let u,h=s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?u=l(h,(_,y)=>y||_,e):e?.__node&&(u=l(h,(_,y)=>y||_.__node.unique,(..._)=>{e.__operator&&e.__operator(..._)})),u}else{if(typeof e=="string"&&(a=e,i||(i=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),r="__operator",typeof e!="object"))return;let u,h=s?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?u=l(h,(_,y)=>y||_,e):e?.__node&&(u=l(h,(_,y)=>y||_.__node.unique,(..._)=>{e.__operator&&e.__operator(..._)})),u}};__unsubscribe=(e,t,s)=>t?this.__node.state.unsubscribeEvent(s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(s?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=gt(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...s)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,s);let i=e(...s);return this.__node.state.triggers[this.__node.unique]&&(typeof i?.then=="function"?i.then(r=>{r!==void 0&&this.__node.state.setValue(this.__node.unique,r)}).catch(console.error):i!==void 0&&this.__node.state.setValue(this.__node.unique,i)),i},this.__parent instanceof n&&!this.__subscribedToParent&&this.__parent.__operator){let s=this.__parent.__subscribe(this),i=()=>{this.__parent?.__unsubscribe(s),delete this.__subscribedToParent};this.__addOndisconnected(i),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let s=this.__node.localState,i=(r,o)=>{let a=this.__node.unique+"."+o,l=`${a}input`,c,u,h,_;if(typeof r[o]=="function"&&o!=="__operator")this.__props?.[o]?h=this.__props:h=s,c=()=>h[o],u=y=>{this.__props?.[o]||(y=y.bind(this)),h[o]=(...b)=>{this.__node.state.triggers[l]&&this.__node.state.setValue(l,b);let x=y(...b);return this.__node.state.triggers[a]&&(typeof x?.then=="function"?x.then(R=>{this.__node.state.triggerEvent(a,R)}).catch(console.error):this.__node.state.triggerEvent(a,x)),x}},s[o]=r[o].bind(this),_={get:c,set:u,enumerable:!0,configurable:!0};else if(o!=="__graph"){let y,b,x;this.__props?.[o]?x=this.__props:x=s,y=()=>x[o],b=R=>{x[o]=R,this.__node.state.triggers[a]&&this.__node.state.triggerEvent(a,R)},s[o]=r[o],_={get:y,set:b,enumerable:!0,configurable:!0}}if(Object.defineProperty(r,o,_),typeof this.__node.initial=="object"){let y=Object.getOwnPropertyDescriptor(this.__node.initial,o);(y===void 0||y?.configurable)&&Object.defineProperty(this.__node.initial,o,_)}};if(t)i(e,t);else for(let r in e)i(e,r)};__proxyObject=e=>{let t=Zt(e);for(let s of t){let i={get:()=>e[s],set:r=>{e[s]=r},enumerable:!0,configurable:!0};if(Object.defineProperty(this,s,i),typeof this.__node.initial=="object"){let r=Object.getOwnPropertyDescriptor(this.__node.initial,s);(r===void 0||r?.configurable)&&Object.defineProperty(this.__node.initial,s,i)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=s=>{s(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=s=>{s(this)};this.__ondisconnected.forEach(t)}}},de=class n{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:Kt,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,Ge(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=!1)=>{function s(o,a,l=!0,c=!0){if(c){o||(o={});for(let u in a)!u.startsWith("__")&&a[u]&&typeof a[u]=="object"?(o[u]=a[u],a[u]?.__children&&s({},a[u].__children,!1,!1)):typeof a[u]=="function"&&(o[u]=a[u]);s(o,a,!0,!1)}else if(a?.__children&&!l)a.__children?.constructor.name==="Object"?o.__children?.constructor.name==="Object"?o.__children=s(o.__children,a.__children,!0,!1):o.__children=s({},a.__children,!0,!1):o.__children=a.__children;else if(l)for(let u in a)!u.startsWith("__")&&a[u]&&typeof a[u]=="object"?(o[u]=Object.assign({},a[u]),a[u]?.__children&&(o[u].__children=s({},a[u].__children,!1,!1))):typeof a[u]=="function"&&(o[u]=a[u]);return o}this.__node.roots=s(this.__node.roots?this.__node.roots:{},e);let i=Object.assign({},e);i.__node&&delete i.__node;let r=this.recursiveSet(i,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let o=new $(e,this,this);this.set(o.__node.tag,o),this.runLoaders(o,this,e,e.__node.tag),o.__listeners&&(r[o.__node.tag]=o.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(r),i};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,s,i)=>{for(let r in this.__node.loaders)typeof this.__node.loaders[r]=="object"?(this.__node.loaders[r].init&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i),this.__node.loaders[r].connected&&e.__addOnconnected(this.__node.loaders[r].connect),this.__node.loaders[r].disconnected&&e.__addOndisconnected(this.__node.loaders[r].disconnect)):typeof this.__node.loaders[r]=="function"&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i)};add=(e,t,s=!0)=>{let i={};typeof t=="string"&&(t=this.get(t));let r;if(typeof e=="function"?_t(e)?e.prototype instanceof $?(e=e.prototype.constructor(e,t,this),r=!0):e=new e:e={__operator:e,__callable:!0}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!r){let l=Object.getOwnPropertyNames(e),c=Object.getOwnPropertyNames(Object.getPrototypeOf(e));l.push(...c),l=l.filter(h=>!Ne.includes(h));let u={};for(let h of l)u[h]=e[h];e=u}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(s)this.remove(e.__node.tag,!0);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let o,a=Ge({},e,2);if(r?o=e:o=new $(e,t,this),this.set(o.__node.tag,o),this.runLoaders(o,t,e,o.__node.tag),this.__node.roots[o.__node.tag]=a,o.__children&&(o.__children=Object.assign({},o.__children),this.recursiveSet(o.__children,o,i,o.__children)),o.__listeners){i[o.__node.tag]=Object.assign({},o.__listeners);for(let l in o.__listeners){let c=o.__listeners[l];o[l]&&(delete i[o.__node.tag][l],i[o.__node.tag][o.__node.tag+"."+l]=c),typeof c=="string"&&(o.__children?.[c]?i[o.__node.tag][l]=o.__node.tag+"."+c:t instanceof $&&(t.__node.tag===c||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===c)&&(i[o.__node.tag][l]=t.__node.tag))}}return this.setListeners(i),o.__callConnected(),o};recursiveSet=(e,t,s={},i,r=!1)=>{let o=Object.getOwnPropertyNames(i).filter(l=>!Ne.includes(l)),a=Object.getOwnPropertyNames(Object.getPrototypeOf(i)).filter(l=>!Ne.includes(l));o.push(...a);for(let l of o){if(l.includes("__"))continue;let c=i[l];if(Array.isArray(c))continue;let u;if(typeof c=="function"?_t(c)?(c=new c,c instanceof $&&(c=c.prototype.constructor(c,t,this),u=!0)):c={__operator:c,__callable:!0}:typeof c=="string"?this.__node.nodes.get(c)?c=this.__node.nodes.get(c):c=this.__node.roots[c]:typeof c=="boolean"&&(this.__node.nodes.get(l)?c=this.__node.nodes.get(l):c=this.__node.roots[l]),c&&typeof c=="object"){if(!u&&!(c instanceof $)){let b=Object.getOwnPropertyNames(c).filter(j=>!Ne.includes(j)),x=Object.getOwnPropertyNames(Object.getPrototypeOf(c)).filter(j=>!Ne.includes(j));x.splice(x.indexOf("constructor"),1),b.push(...x);let R={};for(let j of b)R[j]=c[j];c=R}if(c.__node||(c.__node={}),c.__node.tag||(c.__node.tag=l),c.__node.initial||(c.__node.initial=e[l]),r&&this.get(c.__node.tag))this.remove(c.__node.tag,!0);else if(this.get(c.__node.tag)&&!(!(t instanceof n)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+c.__node.tag))continue;let h,_=!1,y=Ge({},c,2);if(u||c instanceof $?h=c:(h=new $(c,t,this),_=!0),!_&&c instanceof $&&!u&&t instanceof $){let b=this.subscribe(t.__node.tag,h.__node.tag),x=R=>{this.unsubscribe(t.__node.tag,b)};h.__addOndisconnected(x)}else if(h){if(this.set(h.__node.tag,h),this.runLoaders(h,t,e[l],l),e[l]=h,this.__node.roots[h.__node.tag]=y,h.__children&&(h.__children=Object.assign({},h.__children),this.recursiveSet(h.__children,h,s,h.__children)),h.__listeners){s[h.__node.tag]=Object.assign({},h.__listeners);for(let b in h.__listeners){let x=h.__listeners[b],R=b;h[b]&&(delete s[h.__node.tag][b],R=h.__node.tag+"."+b,s[h.__node.tag][R]=x),typeof x=="string"&&(h.__children?.[x]?s[h.__node.tag][R]=h.__node.tag+"."+x:t instanceof $&&(t.__node.tag===x||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===x)&&(s[h.__node.tag][R]=t.__node.tag))}}h.__callConnected()}}}return s};remove=(e,t=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof $){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let s=i=>{for(let r in i)this.unsubscribe(i[r]),this.delete(i[r].__node.tag),delete this.__node.roots[i[r].__node.tag],this.delete(r),delete this.__node.roots[r],i[r].__node.tag=i[r].__node.tag.substring(i[r].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(i[r]),i[r].__callDisconnected(),i[r].__children&&s(i[r].__children)};e.__children&&s(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let s=this.get(e);if(!s&&e.includes(".")){if(s=this.get(e.substring(0,e.lastIndexOf("."))),typeof s?.[e.substring(e.lastIndexOf(".")+1)]=="function")return s[e.substring(e.lastIndexOf(".")+1)](...t)}else if(s?.__operator)return s.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let s=this.get(t);if(typeof e[t]=="object")for(let i in e[t]){let r=this.get(i),o;if(typeof e[t][i]!="object")e[t][i]={__callback:e[t][i]};else if(!e[t][i].__callback)for(let a in e[t][i]){typeof e[t][i][a]!="object"&&(e[t][i][a]={__callback:e[t][i][a]},s.__operator&&(e[t][i][a].__callback===!0||typeof e[t][i][a].__callback>"u")&&(e[t][i][a].__callback=s.__operator));let l=this.get(a);if(l)o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,void 0,e[t][i][a].subInput,t);else{let c=i.substring(0,i.lastIndexOf("."));if(l=this.get(c),l){let u=i.substring(i.lastIndexOf(".")+1);o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,u,e[t][i][a].subInput,t)}}}if("__callback"in e[t][i])if(s&&((e[t][i].__callback===!0||typeof e[t][i].__callback>"u")&&(e[t][i].__callback=s.__operator),typeof e[t][i].__callback=="function"&&(e[t][i].__callback=e[t][i].__callback.bind(s))),r)o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,void 0,e[t][i].subInput,t);else{let a=i.substring(0,i.lastIndexOf("."));r=this.get(a),r&&(o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,i.substring(i.lastIndexOf(".")+1),e[t][i].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let s in e.__listeners){if(t&&s!==t||typeof e.__listeners[s]?.sub!="number")continue;let i=this.get(s);if(i)if(typeof!e.__listeners[s]?.__callback=="number")for(let r in e.__listeners[s])e.__listeners[s][r]?.sub&&(this.unsubscribe(i,e.__listeners[s][r].sub,void 0,e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,void 0,e.__listeners[s].subInput),e.__listeners[s].sub=void 0);else if(i=this.get(s.substring(0,s.lastIndexOf("."))),i)if(typeof e.__listeners[s]=="object"&&!e.__listeners[s]?.__callback)for(let r in e.__listeners[s])typeof e.__listeners[s][r]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s][r].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s].subInput),e.__listeners[s].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return!0});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,s)=>{let i=this.get(e);if(i){let r=i.__node.unique;return t&&(r+="."+t),this.__node.state.getEvent(r,s)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof $){let s;if(t)s=Object.assign({},this.__node.roots[e.__node.tag]);else{s=Object.assign({},e);for(let i in s)i.includes("__")&&delete s[i]}}};subscribe=(e,t,s,i,r,o,a)=>{let l=e;typeof e=="string"&&(l=this.get(e),!l&&e.includes(".")&&(l=this.get(e.substring(0,e.lastIndexOf("."))),i=e.substring(e.lastIndexOf(".")+1))),o instanceof $&&(o=o.__node.tag);let c;if(typeof t=="string"){c=t;let h=_=>{if(this.get(_)?.__operator){let y=this.get(_);o=_,_=function(...b){return y.__operator(...b)}}else if(_.includes(".")){o=_.substring(0,_.lastIndexOf("."));let y=this.get(o),b=_.substring(_.lastIndexOf(".")+1);a=b,typeof y[b]=="function"?y[b]instanceof $?_=y[b]:_=function(...x){return y[b](...x)}:_=function(x){return y[b]=x,y[b]}}return _};if(o){let _=this.get(o);typeof _?.[t]=="function"?(a=t,t=function(...y){return _[i](...y)}):_?.[i]?(a=i,_[i]instanceof $?t=_[i]:t=function(y){return _[i]=y,_[i]}):t=h(t)}else t=h(t)}let u;if(l instanceof $){let h=()=>{u=l.__subscribe(t,i,r,o,a,s,c);let _=()=>{u!==void 0&&l.__unsubscribe(u,i,r),u=void 0};l.__addOndisconnected(()=>{_(),l.__addOnconnected(()=>{u===void 0&&l.__node.graph.__node.tag===this.__node.tag&&h()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof $&&t.__addOndisconnected(()=>{_()})};h()}else if(typeof e=="string"){let h=this.get(e);if(h){if(t instanceof $&&t.__operator){let _=()=>{u=h.__subscribe(t.__operator,i,r,o,a,s,c);let y=()=>{u!==void 0&&h.__unsubscribe(u,i,r)};h.__addOndisconnected(()=>{y(),h.__addOnconnected(()=>{u===void 0&&h.__node.graph.__node.tag===this.__node.tag&&_()})}),t.__addOndisconnected(y)};_()}else if(typeof t=="function"||typeof t=="string"){let _=()=>{u=h.__subscribe(t,i,r,o,a,s,c);let y=()=>{u!==void 0&&h.__unsubscribe(u,i,r),u=void 0};h.__addOndisconnected(()=>{y(),h.__addOnconnected(()=>{u===void 0&&h.__node.graph.__node.tag===this.__node.tag&&_()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(y)};_()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(u=this.__node.state.subscribeEvent(e,t))}return u};unsubscribe=(e,t,s,i)=>e instanceof $?e.__unsubscribe(t,s,i):this.get(e)?.__unsubscribe(t,s,i);setState=e=>{this.__node.state.setState(e)}};function Ge(n,e,t=1/0,s=0){for(let i in e)e[i]?.constructor.name==="Object"&&s<t?(s++,n[i]?.constructor.name==="Object"?Ge(n[i],e[i],t,s):n[i]=Ge({},e[i],t,s)):n[i]=e[i];return n}function Zt(n){var e=[],t=n;do{var s=Object.getOwnPropertyNames(t);let i=function(r){e.indexOf(r)===-1&&e.push(r)};s.forEach(i)}while(t=Object.getPrototypeOf(t));return e}function Wr(n){let e=Zt(n),t={};for(let s of e)t[s]=n[s];return t}function _t(n){return Qs(n)==="class"}function Qs(n){return typeof n=="function"?n.prototype?Object.getOwnPropertyDescriptor(n,"prototype")?.writable?"function":"class":n.constructor.name==="AsyncFunction"?"async":"arrow":""}var Be=(n,e)=>{if(e.get(n)?.__operator){let t=e.get(n);return(...s)=>{t.__operator(...s)}}else if(n.includes(".")){let t=n.split("."),s=t.pop(),i=t.join("."),r=e.get(i);return typeof e.get(i)?.[s]=="function"?(...o)=>r[s](...o):()=>r[s]}else if(e.get(n)){let t=e.get(n);return()=>t}else{let t=n;return()=>t}},gt=(n,e,t)=>{let s=[],i=(o,a)=>{if(o==="__output"||o==="__input"||o==="__callback")s[a]={__callback:l=>l,__args:void 0,idx:a};else if(typeof o=="string")s[a]={__callback:Be(o,t),__args:void 0,idx:a};else if(typeof o=="function"){let l=o;s[a]={__callback:(...c)=>l(...c),__args:void 0,idx:a}}else if(typeof o=="object"&&(o.__input||o.__callback)){let l=function(c){let u=c.__input?c.__input:c.__callback;if(typeof c.__input=="string"&&(u={__callback:Be(c.__input,t),__args:void 0,idx:a}),c.__args){let h=gt(u,c.__args,t);u={__callback:h.__callback,__args:h.__args,idx:a}}else u={__callback:u,__args:void 0,idx:a};if(c.__output){let h=c.__output;if(typeof c.__output=="string"?h={__callback:Be(h,t),__args:void 0,idx:a}:typeof o.__output=="object"&&(h=l(h)),typeof h?.__callback=="function"){let _=u.__callback,y=h.__callback;u={__callback:(...b)=>y(_(...b)),__args:h.__args,idx:a}}}return u};s[a]=l(o)}else{let l=o;s[a]={__callback:()=>l,__args:void 0,idx:a}}};e.forEach(i),typeof n=="string"&&(n={__callback:Be(n,t),__args:void 0});let r=typeof n=="function"?n:n.__callback;return n=function(...o){let a=c=>c.__callback(...o);return r(...s.map(a))},{__callback:n,__args:s}},Ne=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var ei=(n,e,t)=>{n.__node.backward&&e instanceof $&&t.setListeners({[e.__node.tag]:{[n.__node.tag]:e}})},ti=(n,e,t)=>{if(n.__operator){let s=Math.random();if(n.__node.loops||(n.__node.loops={}),typeof n.__node.delay=="number"){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=setTimeout(async()=>{o(await i(...r))},n.__node.delay)}))}else if(n.__node.frame===!0){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=requestAnimationFrame(async()=>{o(await i(...r))})}))}if(typeof n.__node.repeat=="number"||typeof n.__node.recursive=="number"){let i=n.__operator;n.__setOperator(async(...r)=>{let o=n.__node.repeat?n.__node.repeat:n.__node.recursive,a,l=async(c,...u)=>{for(;c>0;){if(n.__node.delay||n.__node.frame){i(...u).then(async h=>{n.__node.recursive?await l(c,h):await l(c,...u)});break}else a=await i(...r);c--}};return await l(o,...r),a})}if(n.__node.loop&&typeof n.__node.loop=="number"){let i=n.__operator,r=n.__node.loop;n.__setOperator((...a)=>{if("looping"in n.__node||(n.__node.looping=!0),n.__node.looping){let l=performance.now();i(...a),n.__node.loops[s]=setTimeout(()=>{let u=performance.now()-l-n.__node.loop;u>0?r=n.__node.loop-u:r=n.__node.loop,r<=0&&(r=n.__node.loop),n.__operator(...a)},r)}}),n.__node.looping&&n.__operator();let o=a=>{a.__node.looping&&(a.__node.looping=!1),a.__node.loops[s]&&(clearTimeout(a.__node.loops[s]),cancelAnimationFrame(a.__node.loops[s]))};n.__addOndisconnected(o)}}},si=(n,e,t)=>{if(n.__node.animate===!0||n.__animation){let s=n.__operator;n.__setOperator((...r)=>{"animating"in n.__node||(n.__node.animating=!0),n.__node.animating&&(typeof n.__animation=="function"?n.__animation(...r):s(...r),n.__node.animationFrame=requestAnimationFrame(()=>{n.__operator(...r)}))}),(n.__node.animating||(!("animating"in n.__node)||n.__node.animating)&&n.__animation)&&setTimeout(()=>{n.__node.animationFrame=requestAnimationFrame(n.__operator)},10);let i=r=>{r.__node.animating&&(r.__node.animating=!1),r.__node.animationFrame&&cancelAnimationFrame(r.__node.animationFrame)};n.__addOndisconnected(i)}},ii=(n,e,t)=>{if(typeof n.__branch=="object"&&n.__operator&&!n.__branchApplied){let s=n.__operator;n.__branchApplied=!0,n.__operator=(...i)=>{let r=s(...i);for(let o in n.__branch){let a=()=>{typeof n.__branch[o].then=="function"?n.__branch[o].then(r):n.__branch[o].then instanceof $&&n.__branch[o].then.__operator?n.__branch[o].then.__operator(r):r=n.__branch[o].then};typeof n.__branch[o].if=="function"?n.__branch[o].if(r)==!0&&a():n.__branch[o].if===r&&a()}return r}}if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&n.__listeners[s].branch&&!n.__listeners[s].branchApplied){let i=n.__listeners[s].callback;n.__listeners[s].branchApplied=!0,n.__listeners.callback=r=>{let o=()=>{typeof n.__listeners[s].branch.then=="function"?r=n.__listeners[s].branch.then(r):n.__listeners[s].branch.then instanceof $&&n.__listeners[s].branch.then.__operator?r=n.__listeners[s].branch.then.__operator(r):r=n.__listeners[s].branch.then};return typeof n.__listeners[s].branch.if=="function"?n.__listeners[s].branch.if(r)&&o():n.__listeners[s].branch.if===r&&o(),i(r)}}}},ri=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&n.__listeners[s].oncreate&&n.__listeners[s].callback(n.__listeners[s].oncreate)},ni=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].binding=="object"&&(n.__listeners.callback=n.__listeners.callback.bind(n.__listeners[s].binding))},oi=(n,e,t)=>{if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].transform=="function"&&!n.__listeners[s].transformApplied){let i=n.__listeners[s].callback;n.__listeners[s].transformApplied=!0,n.__listeners.callback=r=>(r=n.__listeners[s].transform(r),i(r))}}},ai=(n,e,t)=>{n.post&&!n.__operator?n.__setOperator(n.post):!n.__operator&&typeof n.get=="function"&&n.__setOperator(n.get),!n.get&&n.__operator,n.aliases&&n.aliases.forEach(s=>{t.set(s,n);let i=r=>{t.__node.nodes.delete(s)};n.__addOndisconnected(i)}),typeof t.__node.roots?.[n.__node.tag]=="object"&&n.get&&(t.__node.roots[n.__node.tag].get=n.get)},pt={backprop:ei,loop:ti,animate:si,branching:ii,triggerListenerOncreate:ri,bindListener:ni,transformListenerResult:oi,substitute__operator:ai};var li=n=>{let e={};for(let t in n)typeof n[t]=="object"?e[t]=li(n[t]):typeof n[t]=="function"?e[t]=n[t].toString():e[t]=n[t];return e};function Jr(n){typeof n!="string"&&(n=n.toString());let e=n.match(/\(?[^]*?\)?\s*=>/);if(e)return e[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let t=n.match(/\([^]*?\)/);return t?t[0].replace(/[()\s]/gi,"").split(","):[]}var ci=n=>{let e=n.indexOf("=>")+1;return e<=0&&(e=n.indexOf("){")),e<=0&&(e=n.indexOf(") {")),n.slice(0,n.indexOf("{",e)+1)};function yt(n=""){let e=r=>r.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=ci(n),s=e(n),i;if(t.includes("function")){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s)}else if(t.substring(0,6)===s.substring(0,6)){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s.substring(s.indexOf("{")+1,s.length-1))}else try{i=(0,eval)(n)}catch{}return i}function Hr(n="{}"){try{let e=typeof n=="string"?JSON.parse(n):n,t=s=>{for(let i in s)if(typeof s[i]=="string"){let r=yt(s[i]);typeof r=="function"&&(s[i]=r)}else typeof s[i]=="object"&&t(s[i]);return s};return t(e)}catch(e){console.error(e);return}}var fi=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,c=e[l];if(typeof c=="object")if(c[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(c=e[l],typeof c=="object"&&c[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(a,t.join("."))}return a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=fi);var hi=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,c=e[l];if(typeof c=="object")if(c[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(c=e[l],typeof c=="object"&&c[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(typeof a=="function"?a.toString():a,t.join("."))}return typeof a=="function"?a.toString():a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=hi);var ui=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1;if(e[l]){var c=e[l];if(typeof c=="object")if(c[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(c=e[l],typeof c=="object"&&c[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l++}}}function r(o,a){let l;if(a!=null)if(typeof a=="object"){let c=a.constructor.name;o&&c==="Object"&&i(o,a);let u=n.get(a);if(u)return"[Circular Reference]"+u;if(n.set(a,t.join(".")),c==="Array")a.length>20?l=a.slice(a.length-20):l=a;else if(c.includes("Set"))l=Array.from(a);else if(c!=="Object"&&c!=="Number"&&c!=="String"&&c!=="Boolean")l="instanceof_"+c;else if(c==="Object"){let h={};for(let _ in a)if(a[_]==null)h[_]=a[_];else if(Array.isArray(a[_]))a[_].length>20?h[_]=a[_].slice(a[_].length-20):h[_]=a[_];else if(a[_].constructor.name==="Object"){h[_]={};for(let y in a[_])if(Array.isArray(a[_][y]))a[_][y].length>20?h[_][y]=a[_][y].slice(a[_][y].length-20):h[_][y]=a[_][y];else if(a[_][y]!=null){let b=a[_][y].constructor.name;b.includes("Set")?h[_][y]=Array.from(a[_][y]):b!=="Number"&&b!=="String"&&b!=="Boolean"?h[_][y]="instanceof_"+b:h[_][y]=a[_][y]}else h[_][y]=a[_][y]}else{let y=a[_].constructor.name;y.includes("Set")?h[_]=Array.from(a[_]):y!=="Number"&&y!=="String"&&y!=="Boolean"?h[_]="instanceof_"+y:h[_]=a[_]}l=h}else l=a}else l=a;return l}return function(a,l){e.push(a);let c=JSON.stringify(a,r,l);return s(),c}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=ui);function Vr(n){if(typeof n.__methods=="object")for(let e in n.__methods){let t=n.__methods[e],s=typeof t=="function"?t:yt(t);e==="__operator"?n.__setOperator(s):n[e]=s.bind(n)}}var ee=class extends de{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({...pt},e.loaders):{...pt}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((r,o)=>{this.get(o)?this.set(t+"."+o,r):this.set(o,r)}),this.__node.nodes.forEach((r,o)=>{e[t].__node.nodes.get(o)||e[t].__node.nodes.set(o,r)});let s=this.set;this.set=(r,o)=>(e[t].set(r,o),s(r,o));let i=this.delete;this.delete=r=>(e[t].delete(r),i(r))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,s)=>{let i=t,r=this.__node.nodes.get(e);if(r||(r=this.__node.roots[e]),r?.[i])if(typeof r[i]!="function"){if(s){Array.isArray(s)&&s.length===1?r[i]=s[0]:r[i]=s;return}return r[i]}else return Array.isArray(s)?r[i](...s):r[i](s);else return this.handleServiceMessage({route:e,args:s,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let s=t.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,s,i,r)=>{if(e instanceof $)return r?this.subscribe(e,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)})};pipeOnce=(e,t,s,i,r)=>{if(e instanceof $)return r?e.__node.state.subscribeEventOnce(e.__node.unique,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.__node.state.subscribeEventOnce(e.__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)})};terminate=(...e)=>{};isTypedArray=di;recursivelyAssign=mt;spliceTypedArray=_i;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),!0);error=(...e)=>(console.error(...e),!0)};function di(n){return ArrayBuffer.isView(n)&&Object.prototype.toString.call(n)!=="[object DataView]"}var mt=(n,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?n[t]?.constructor.name==="Object"&&!Array.isArray(n[t])?mt(n[t],e[t]):n[t]=mt({},e[t]):n[t]=e[t];return n};function _i(n,e,t){let s=n.subarray(0,e),i;t&&(i=n.subarray(t+1));let r;return(s.length>0||i?.length>0)&&(r=new n.constructor(s.length+i.length)),r&&(s.length>0&&r.set(s),i&&i.length>0&&r.set(i,s.length)),r}(()=>{var n=class{data={};triggers={};ctr=0;constructor(d){typeof d=="object"&&(this.data=d)}setState=d=>{Object.assign(this.data,d);let f=Object.getOwnPropertyNames(d);for(let g of f)this.triggerEvent(g,this.data[g]);if(this.triggers[e]){let g=m=>{m(d)},p=this.triggers[e].length;for(let m=p-1;m>=0;m--)g(this.triggers[e][m].onchange)}return this.data};setValue=(d,f)=>{this.data[d]=f,this.triggerEvent(d,f)};triggerEvent=(d,f)=>{if(this.triggers[d]){let g=m=>{m.onchange(f)},p=this.triggers[d].length;for(let m=p-1;m>=0;m--)g(this.triggers[d][m])}};subscribeState=d=>this.subscribeEvent(e,d);unsubscribeState=d=>this.unsubscribeEvent(e,d);subscribeEvent=(d,f,g,p)=>{if(d){g&&p&&!this.triggers[d]&&Object.defineProperty(this.data,d,{get:()=>g[p],set:S=>{g[p]=S},enumerable:!0,configurable:!0}),this.triggers[d]||(this.triggers[d]=[]);let m=this.ctr;return this.ctr++,this.triggers[d].push({sub:m,onchange:f}),m}else return};unsubscribeEvent=(d,f)=>{let g=this.triggers[d];if(g)if(f===void 0)delete this.triggers[d],delete this.data[d];else{let p,m=g.find((S,w)=>{if(S.sub===f)return p=w,!0});return m&&g.splice(p,1),Object.keys(g).length===0&&(delete this.triggers[d],delete this.data[d]),this.onRemoved&&this.onRemoved(m),!0}};subscribeEventOnce=(d,f)=>{let g,p=m=>{f(m),this.unsubscribeEvent(d,g)};return g=this.subscribeEvent(d,p),g};getEvent=(d,f)=>{if(typeof f!="number")return this.triggers[d];for(let g in this.triggers[d])if(this.triggers[d][g].sub===f)return this.triggers[d][g]};getSnapshot=()=>{let d={};for(let f in this.data)d[f]=this.data[f]};onRemoved},e="*s",t=new n,s=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},i=class gi{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:t};__children;__parent;__operator;__listeners;__props;__args;constructor(f,g,p){if(this.__setProperties(f,g,p),typeof f=="function"||f?.__callable){let m=new s;m.__call=(...w)=>this.__operator(...w);let S=new Proxy(m,{get:(w,k,A)=>Reflect.has(this,k)?Reflect.get(this,k,A):Reflect.get(w,k,A),set:(w,k,A,T)=>Reflect.has(this,k)?Reflect.set(this,k,A,T):Reflect.set(w,k,A,T)});return Object.setPrototypeOf(S,this),S}}get __graph(){return this.__node?.graph}set __graph(f){this.__node.graph=f}__setProperties=(f,g,p)=>{if((()=>{let m=f;typeof f=="function"?c(f)?f=new f:f={__operator:f,__node:{forward:!0,tag:f.name}}:typeof f=="string"&&p?.get(f)&&(f=p.get(f)),"__node"in f||(f.__node={}),f.__node.initial||(f.__node.initial=m)})(),typeof f=="object"){let m=()=>{f.__node?.state?this.__node.state=f.__node.state:p&&(f.__node.state=p.__node.state)},S=()=>{f.__props&&(typeof f.__props=="function"&&(f.__props=new f.__props),typeof f.__props=="object"&&this.__proxyObject(f.__props))},w=()=>{f.__node.tag||(f.__operator?.name?f.__node.tag=f.__operator.name:f.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},k=()=>{typeof f.__node=="string"?p?.get(f.__node.tag)?f=p.get(f.__node.tag):f.__node={}:f.__node||(f.__node={}),p&&(f.__node.graph=p),f instanceof r&&(f.__node.source=f)},A=()=>{if(!f.__parent&&g&&(f.__parent=g),g?.__node&&!(g instanceof r||f instanceof r)&&(f.__node.tag=g.__node.tag+"."+f.__node.tag),g instanceof r&&f instanceof r&&(f.__node.loaders&&Object.assign(g.__node.loaders?g.__node.loaders:{},f.__node.loaders),g.__node.mapGraphs)){f.__node.nodes.forEach(M=>{g.set(f.__node.tag+"."+M.__node.tag,M)});let C=()=>{f.__node.nodes.forEach(M=>{g.__node.nodes.delete(f.__node.tag+"."+M.__node.tag)})};this.__addOndisconnected(C)}},T=()=>{if(typeof f.default=="function"&&!f.__operator&&(f.__operator=f.default),f.__operator){if(typeof f.__operator=="string"&&p){let C=p.get(f.__operator);C&&(f.__operator=C.__operator),!f.__node.tag&&f.__operator.name&&(f.__node.tag=f.__operator.name)}typeof f.__operator=="function"&&(f.__operator=this.__setOperator(f.__operator)),f.default&&(f.default=f.__operator)}},U=()=>{f.__node=Object.assign(this.__node,f.__node);let C=Object.getOwnPropertyNames(f).filter(M=>{if(!y[M])return!0});for(let M of C)M in f&&M!=="name"&&(this[M]=f[M])},L=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(C=>C.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(C=>C.bind(this))))};m(),w(),S(),k(),A(),U(),L(),T()}};__subscribe=(f,g,p,m,S,w,k)=>{let A=(U,L=(M,B)=>B||M,C=f)=>{let M;if(w){let X=_(C,w,this.__node.graph);C=X.__callback,M=X.__args}let B=this.__node.state.subscribeEvent(U,C,this,g),G=this.__node.state.getEvent(U,B);return this.__listeners||(this.__listeners={}),this.__listeners[U]=this.__node.state.triggers[U],G&&(G.source=this.__node.tag,g&&(G.key=g),G.target=L(f,m),S&&(G.tkey=S),p&&(G.subInput=p),w&&(G.arguments=M,G.__args=w),k&&(G.__callback=k),G.node=this,G.graph=this.__node.graph),B},T=U=>{let L=this.__node.graph.get(U);if(!L&&U.includes(".")){m=U.substring(0,U.lastIndexOf("."));let C=this.__node.graph.get(U.substring(0,m));S=U.lastIndexOf(".")+1,C&&typeof C[g]=="function"&&(U=(...M)=>C[S](...M))}else L.__operator&&(U=L.__operator,S="__operator");return U};if(g){if((!this.__node.localState||!this.__node.localState[g])&&this.__addLocalState(this,g),typeof f=="string"){if(k=this.__node.tag+"."+f,S=f,m){if(this.__node.graph?.get(m)){let C=this.__node.graph?.get(m);if(typeof C[f]=="function"){let M=C[f];f=(...B)=>{M(...B)}}else{let M=f;f=B=>{C[M]=B}}}}else if(typeof this[f]=="function"){let C=this[f];f=(...M)=>{C(...M)}}else this.__node.graph?.get(f)&&(f=T(f));if(typeof f!="function")return}let U,L=p?this.__node.unique+"."+g+"input":this.__node.unique+"."+g;return typeof f=="function"&&!f?.__node?U=A(L,(C,M)=>M||C,f):f?.__node&&(U=A(L,(C,M)=>M||C.__node.unique,(...C)=>{f.__operator&&f.__operator(...C)})),U}else{if(typeof f=="string"&&(k=f,m||(m=f),this.__node.graph.get(f)&&(f=this.__node.graph.get(f)),S="__operator",typeof f!="object"))return;let U,L=p?this.__node.unique+"input":this.__node.unique;return typeof f=="function"&&!f?.__node?U=A(L,(C,M)=>M||C,f):f?.__node&&(U=A(L,(C,M)=>M||C.__node.unique,(...C)=>{f.__operator&&f.__operator(...C)})),U}};__unsubscribe=(f,g,p)=>g?this.__node.state.unsubscribeEvent(p?this.__node.unique+"."+g+"input":this.__node.unique+"."+g,f):this.__node.state.unsubscribeEvent(p?this.__node.unique+"input":this.__node.unique,f);__setOperator=f=>{f=f.bind(this),this.__args&&this.__node.graph&&(f=_(f,this.__args,this.__node.graph).__callback);let g=`${this.__node.unique}input`;if(this.__operator=(...p)=>{this.__node.state.triggers[g]&&this.__node.state.setValue(g,p);let m=f(...p);return this.__node.state.triggers[this.__node.unique]&&(typeof m?.then=="function"?m.then(S=>{S!==void 0&&this.__node.state.setValue(this.__node.unique,S)}).catch(console.error):m!==void 0&&this.__node.state.setValue(this.__node.unique,m)),m},this.__parent instanceof gi&&!this.__subscribedToParent&&this.__parent.__operator){let p=this.__parent.__subscribe(this),m=()=>{this.__parent?.__unsubscribe(p),delete this.__subscribedToParent};this.__addOndisconnected(m),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(f,g)=>{if(!f)return;this.__node.localState||(this.__node.localState={});let p=this.__node.localState,m=(S,w)=>{let k=this.__node.unique+"."+w,A=`${k}input`,T,U,L,C;if(typeof S[w]=="function"&&w!=="__operator")this.__props?.[w]?L=this.__props:L=p,T=()=>L[w],U=M=>{this.__props?.[w]||(M=M.bind(this)),L[w]=(...B)=>{this.__node.state.triggers[A]&&this.__node.state.setValue(A,B);let G=M(...B);return this.__node.state.triggers[k]&&(typeof G?.then=="function"?G.then(X=>{this.__node.state.triggerEvent(k,X)}).catch(console.error):this.__node.state.triggerEvent(k,G)),G}},p[w]=S[w].bind(this),C={get:T,set:U,enumerable:!0,configurable:!0};else if(w!=="__graph"){let M,B,G;this.__props?.[w]?G=this.__props:G=p,M=()=>G[w],B=X=>{G[w]=X,this.__node.state.triggers[k]&&this.__node.state.triggerEvent(k,X)},p[w]=S[w],C={get:M,set:B,enumerable:!0,configurable:!0}}if(Object.defineProperty(S,w,C),typeof this.__node.initial=="object"){let M=Object.getOwnPropertyDescriptor(this.__node.initial,w);(M===void 0||M?.configurable)&&Object.defineProperty(this.__node.initial,w,C)}};if(g)m(f,g);else for(let S in f)m(f,S)};__proxyObject=f=>{let g=a(f);for(let p of g){let m={get:()=>f[p],set:S=>{f[p]=S},enumerable:!0,configurable:!0};if(Object.defineProperty(this,p,m),typeof this.__node.initial=="object"){let S=Object.getOwnPropertyDescriptor(this.__node.initial,p);(S===void 0||S?.configurable)&&Object.defineProperty(this.__node.initial,p,m)}}};__addOnconnected(f){f=f.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(f):typeof this.__onconnected=="function"?this.__onconnected=[f,this.__onconnected]:this.__onconnected=f}__addOndisconnected(f){f=f.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(f):typeof this.__ondisconnected=="function"?this.__ondisconnected=[f,this.__ondisconnected]:this.__ondisconnected=f}__callConnected(f=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let g=p=>{p(this)};this.__onconnected.forEach(g)}}__callDisconnected(f=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let g=p=>{p(this)};this.__ondisconnected.forEach(g)}}},r=class pi{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:t,roots:{}};constructor(f){this.init(f)}init=f=>{if(f){let g=Object.assign({},f);delete g.roots,o(this.__node,g),f.roots&&this.load(f.roots)}};load=(f,g=!1)=>{function p(w,k,A=!0,T=!0){if(T){w||(w={});for(let U in k)!U.startsWith("__")&&k[U]&&typeof k[U]=="object"?(w[U]=k[U],k[U]?.__children&&p({},k[U].__children,!1,!1)):typeof k[U]=="function"&&(w[U]=k[U]);p(w,k,!0,!1)}else if(k?.__children&&!A)k.__children?.constructor.name==="Object"?w.__children?.constructor.name==="Object"?w.__children=p(w.__children,k.__children,!0,!1):w.__children=p({},k.__children,!0,!1):w.__children=k.__children;else if(A)for(let U in k)!U.startsWith("__")&&k[U]&&typeof k[U]=="object"?(w[U]=Object.assign({},k[U]),k[U]?.__children&&(w[U].__children=p({},k[U].__children,!1,!1))):typeof k[U]=="function"&&(w[U]=k[U]);return w}this.__node.roots=p(this.__node.roots?this.__node.roots:{},f);let m=Object.assign({},f);m.__node&&delete m.__node;let S=this.recursiveSet(m,this,void 0,f,g);if(f.__node){if(!f.__node.tag)f.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(f.__node.tag)){let w=new i(f,this,this);this.set(w.__node.tag,w),this.runLoaders(w,this,f,f.__node.tag),w.__listeners&&(S[w.__node.tag]=w.__listeners)}}else f.__listeners&&this.setListeners(f.__listeners);return this.setListeners(S),m};setLoaders=(f,g)=>(g?this.__node.loaders=f:Object.assign(this.__node.loaders,f),this.__node.loaders);runLoaders=(f,g,p,m)=>{for(let S in this.__node.loaders)typeof this.__node.loaders[S]=="object"?(this.__node.loaders[S].init&&this.__node.loaders[S](f,g,this,this.__node.roots,p,m),this.__node.loaders[S].connected&&f.__addOnconnected(this.__node.loaders[S].connect),this.__node.loaders[S].disconnected&&f.__addOndisconnected(this.__node.loaders[S].disconnect)):typeof this.__node.loaders[S]=="function"&&this.__node.loaders[S](f,g,this,this.__node.roots,p,m)};add=(f,g,p=!0)=>{let m={};typeof g=="string"&&(g=this.get(g));let S;if(typeof f=="function"?c(f)?f.prototype instanceof i?(f=f.prototype.constructor(f,g,this),S=!0):f=new f:f={__operator:f,__callable:!0}:typeof f=="string"&&(f=this.__node.roots[f]),!f)return;if(!S){let A=Object.getOwnPropertyNames(f),T=Object.getOwnPropertyNames(Object.getPrototypeOf(f));A.push(...T),A=A.filter(L=>!y.includes(L));let U={};for(let L of A)U[L]=f[L];f=U}if(f.__node||(f.__node={}),f.__node.initial=f,typeof f=="object"&&this.get(f.__node.tag))if(p)this.remove(f.__node.tag,!0);else return;else if(f.__node.tag&&this.get(f.__node.tag))return this.get(f.__node.tag);let w,k=o({},f,2);if(S?w=f:w=new i(f,g,this),this.set(w.__node.tag,w),this.runLoaders(w,g,f,w.__node.tag),this.__node.roots[w.__node.tag]=k,w.__children&&(w.__children=Object.assign({},w.__children),this.recursiveSet(w.__children,w,m,w.__children)),w.__listeners){m[w.__node.tag]=Object.assign({},w.__listeners);for(let A in w.__listeners){let T=w.__listeners[A];w[A]&&(delete m[w.__node.tag][A],m[w.__node.tag][w.__node.tag+"."+A]=T),typeof T=="string"&&(w.__children?.[T]?m[w.__node.tag][A]=w.__node.tag+"."+T:g instanceof i&&(g.__node.tag===T||g.__node.tag.includes(".")&&g.__node.tag.split(".").pop()===T)&&(m[w.__node.tag][A]=g.__node.tag))}}return this.setListeners(m),w.__callConnected(),w};recursiveSet=(f,g,p={},m,S=!1)=>{let w=Object.getOwnPropertyNames(m).filter(A=>!y.includes(A)),k=Object.getOwnPropertyNames(Object.getPrototypeOf(m)).filter(A=>!y.includes(A));w.push(...k);for(let A of w){if(A.includes("__"))continue;let T=m[A];if(Array.isArray(T))continue;let U;if(typeof T=="function"?c(T)?(T=new T,T instanceof i&&(T=T.prototype.constructor(T,g,this),U=!0)):T={__operator:T,__callable:!0}:typeof T=="string"?this.__node.nodes.get(T)?T=this.__node.nodes.get(T):T=this.__node.roots[T]:typeof T=="boolean"&&(this.__node.nodes.get(A)?T=this.__node.nodes.get(A):T=this.__node.roots[A]),T&&typeof T=="object"){if(!U&&!(T instanceof i)){let B=Object.getOwnPropertyNames(T).filter(Ce=>!y.includes(Ce)),G=Object.getOwnPropertyNames(Object.getPrototypeOf(T)).filter(Ce=>!y.includes(Ce));G.splice(G.indexOf("constructor"),1),B.push(...G);let X={};for(let Ce of B)X[Ce]=T[Ce];T=X}if(T.__node||(T.__node={}),T.__node.tag||(T.__node.tag=A),T.__node.initial||(T.__node.initial=f[A]),S&&this.get(T.__node.tag))this.remove(T.__node.tag,!0);else if(this.get(T.__node.tag)&&!(!(g instanceof pi)&&g?.__node)||g?.__node&&this.get(g.__node.tag+"."+T.__node.tag))continue;let L,C=!1,M=o({},T,2);if(U||T instanceof i?L=T:(L=new i(T,g,this),C=!0),!C&&T instanceof i&&!U&&g instanceof i){let B=this.subscribe(g.__node.tag,L.__node.tag),G=X=>{this.unsubscribe(g.__node.tag,B)};L.__addOndisconnected(G)}else if(L){if(this.set(L.__node.tag,L),this.runLoaders(L,g,f[A],A),f[A]=L,this.__node.roots[L.__node.tag]=M,L.__children&&(L.__children=Object.assign({},L.__children),this.recursiveSet(L.__children,L,p,L.__children)),L.__listeners){p[L.__node.tag]=Object.assign({},L.__listeners);for(let B in L.__listeners){let G=L.__listeners[B],X=B;L[B]&&(delete p[L.__node.tag][B],X=L.__node.tag+"."+B,p[L.__node.tag][X]=G),typeof G=="string"&&(L.__children?.[G]?p[L.__node.tag][X]=L.__node.tag+"."+G:g instanceof i&&(g.__node.tag===G||g.__node.tag.includes(".")&&g.__node.tag.split(".").pop()===G)&&(p[L.__node.tag][X]=g.__node.tag))}}L.__callConnected()}}}return p};remove=(f,g=!0)=>{if(this.unsubscribe(f),typeof f=="string"&&(f=this.get(f)),f instanceof i){this.delete(f.__node.tag),delete this.__node.roots[f.__node.tag],g&&this.clearListeners(f),f.__callDisconnected();let p=m=>{for(let S in m)this.unsubscribe(m[S]),this.delete(m[S].__node.tag),delete this.__node.roots[m[S].__node.tag],this.delete(S),delete this.__node.roots[S],m[S].__node.tag=m[S].__node.tag.substring(m[S].__node.tag.lastIndexOf(".")+1),g&&this.clearListeners(m[S]),m[S].__callDisconnected(),m[S].__children&&p(m[S].__children)};f.__children&&p(f.__children)}return f?.__node.tag&&f?.__parent&&(delete f?.__parent,f.__node.tag=f.__node.tag.substring(f.__node.tag.indexOf(".")+1)),f?.__node.graph&&(f.__node.graph=void 0),f};run=(f,...g)=>{if(typeof f=="string"){let p=this.get(f);if(!p&&f.includes(".")){if(p=this.get(f.substring(0,f.lastIndexOf("."))),typeof p?.[f.substring(f.lastIndexOf(".")+1)]=="function")return p[f.substring(f.lastIndexOf(".")+1)](...g)}else if(p?.__operator)return p.__operator(...g)}if(f?.__operator)return f?.__operator(...g)};setListeners=f=>{for(let g in f){let p=this.get(g);if(typeof f[g]=="object")for(let m in f[g]){let S=this.get(m),w;if(typeof f[g][m]!="object")f[g][m]={__callback:f[g][m]};else if(!f[g][m].__callback)for(let k in f[g][m]){typeof f[g][m][k]!="object"&&(f[g][m][k]={__callback:f[g][m][k]},p.__operator&&(f[g][m][k].__callback===!0||typeof f[g][m][k].__callback>"u")&&(f[g][m][k].__callback=p.__operator));let A=this.get(k);if(A)w=this.subscribe(A,f[g][m][k].__callback,f[g][m][k].__args,void 0,f[g][m][k].subInput,g);else{let T=m.substring(0,m.lastIndexOf("."));if(A=this.get(T),A){let U=m.substring(m.lastIndexOf(".")+1);w=this.subscribe(A,f[g][m][k].__callback,f[g][m][k].__args,U,f[g][m][k].subInput,g)}}}if("__callback"in f[g][m])if(p&&((f[g][m].__callback===!0||typeof f[g][m].__callback>"u")&&(f[g][m].__callback=p.__operator),typeof f[g][m].__callback=="function"&&(f[g][m].__callback=f[g][m].__callback.bind(p))),S)w=this.subscribe(S,f[g][m].__callback,f[g][m].__args,void 0,f[g][m].subInput,g);else{let k=m.substring(0,m.lastIndexOf("."));S=this.get(k),S&&(w=this.subscribe(S,f[g][m].__callback,f[g][m].__args,m.substring(m.lastIndexOf(".")+1),f[g][m].subInput,g))}}}};clearListeners=(f,g)=>{if(typeof f=="string"&&(f=this.get(f)),f?.__listeners)for(let p in f.__listeners){if(g&&p!==g||typeof f.__listeners[p]?.sub!="number")continue;let m=this.get(p);if(m)if(typeof!f.__listeners[p]?.__callback=="number")for(let S in f.__listeners[p])f.__listeners[p][S]?.sub&&(this.unsubscribe(m,f.__listeners[p][S].sub,void 0,f.__listeners[p][S].subInput),f.__listeners[p][S].sub=void 0);else typeof f.__listeners[p]?.sub=="number"&&(this.unsubscribe(m,f.__listeners[p].sub,void 0,f.__listeners[p].subInput),f.__listeners[p].sub=void 0);else if(m=this.get(p.substring(0,p.lastIndexOf("."))),m)if(typeof f.__listeners[p]=="object"&&!f.__listeners[p]?.__callback)for(let S in f.__listeners[p])typeof f.__listeners[p][S]?.sub=="number"&&(this.unsubscribe(m,f.__listeners[p][S].sub,p.substring(p.lastIndexOf(".")+1),f.__listeners[p][S].subInput),f.__listeners[p][S].sub=void 0);else typeof f.__listeners[p]?.sub=="number"&&(this.unsubscribe(m,f.__listeners[p].sub,p.substring(p.lastIndexOf(".")+1),f.__listeners[p].subInput),f.__listeners[p].sub=void 0)}};get=f=>this.__node.nodes.get(f);getByUnique=f=>Array.from(this.__node.nodes.values()).find(g=>{if(g.__node.unique===f)return!0});set=(f,g)=>this.__node.nodes.set(f,g);delete=f=>this.__node.nodes.delete(f);list=()=>Array.from(this.__node.nodes.keys());getListener=(f,g,p)=>{let m=this.get(f);if(m){let S=m.__node.unique;return g&&(S+="."+g),this.__node.state.getEvent(S,p)}};getProps=(f,g)=>{if(typeof f=="string"&&(f=this.get(f)),f instanceof i){let p;if(g)p=Object.assign({},this.__node.roots[f.__node.tag]);else{p=Object.assign({},f);for(let m in p)m.includes("__")&&delete p[m]}}};subscribe=(f,g,p,m,S,w,k)=>{let A=f;typeof f=="string"&&(A=this.get(f),!A&&f.includes(".")&&(A=this.get(f.substring(0,f.lastIndexOf("."))),m=f.substring(f.lastIndexOf(".")+1))),w instanceof i&&(w=w.__node.tag);let T;if(typeof g=="string"){T=g;let L=C=>{if(this.get(C)?.__operator){let M=this.get(C);w=C,C=function(...B){return M.__operator(...B)}}else if(C.includes(".")){w=C.substring(0,C.lastIndexOf("."));let M=this.get(w),B=C.substring(C.lastIndexOf(".")+1);k=B,typeof M[B]=="function"?M[B]instanceof i?C=M[B]:C=function(...G){return M[B](...G)}:C=function(G){return M[B]=G,M[B]}}return C};if(w){let C=this.get(w);typeof C?.[g]=="function"?(k=g,g=function(...M){return C[m](...M)}):C?.[m]?(k=m,C[m]instanceof i?g=C[m]:g=function(M){return C[m]=M,C[m]}):g=L(g)}else g=L(g)}let U;if(A instanceof i){let L=()=>{U=A.__subscribe(g,m,S,w,k,p,T);let C=()=>{U!==void 0&&A.__unsubscribe(U,m,S),U=void 0};A.__addOndisconnected(()=>{C(),A.__addOnconnected(()=>{U===void 0&&A.__node.graph.__node.tag===this.__node.tag&&L()})}),typeof g=="string"&&this.get(g)&&(g=this.get(g)),g instanceof i&&g.__addOndisconnected(()=>{C()})};L()}else if(typeof f=="string"){let L=this.get(f);if(L){if(g instanceof i&&g.__operator){let C=()=>{U=L.__subscribe(g.__operator,m,S,w,k,p,T);let M=()=>{U!==void 0&&L.__unsubscribe(U,m,S)};L.__addOndisconnected(()=>{M(),L.__addOnconnected(()=>{U===void 0&&L.__node.graph.__node.tag===this.__node.tag&&C()})}),g.__addOndisconnected(M)};C()}else if(typeof g=="function"||typeof g=="string"){let C=()=>{U=L.__subscribe(g,m,S,w,k,p,T);let M=()=>{U!==void 0&&L.__unsubscribe(U,m,S),U=void 0};L.__addOndisconnected(()=>{M(),L.__addOnconnected(()=>{U===void 0&&L.__node.graph.__node.tag===this.__node.tag&&C()})}),typeof g=="string"&&this.get(g)&&this.get(g).__addOndisconnected(M)};C()}}else typeof g=="string"&&(g=this.__node.nodes.get(g).__operator),typeof g=="function"&&!g?.__node&&(U=this.__node.state.subscribeEvent(f,g))}return U};unsubscribe=(f,g,p,m)=>f instanceof i?f.__unsubscribe(g,p,m):this.get(f)?.__unsubscribe(g,p,m);setState=f=>{this.__node.state.setState(f)}};function o(d,f,g=1/0,p=0){for(let m in f)f[m]?.constructor.name==="Object"&&p<g?(p++,d[m]?.constructor.name==="Object"?o(d[m],f[m],g,p):d[m]=o({},f[m],g,p)):d[m]=f[m];return d}function a(d){var f=[],g=d;do{var p=Object.getOwnPropertyNames(g);let m=function(S){f.indexOf(S)===-1&&f.push(S)};p.forEach(m)}while(g=Object.getPrototypeOf(g));return f}function l(d){let f=a(d),g={};for(let p of f)g[p]=d[p];return g}function c(d){return u(d)==="class"}function u(d){return typeof d=="function"?d.prototype?Object.getOwnPropertyDescriptor(d,"prototype")?.writable?"function":"class":d.constructor.name==="AsyncFunction"?"async":"arrow":""}var h=(d,f)=>{if(f.get(d)?.__operator){let g=f.get(d);return(...p)=>{g.__operator(...p)}}else if(d.includes(".")){let g=d.split("."),p=g.pop(),m=g.join("."),S=f.get(m);return typeof f.get(m)?.[p]=="function"?(...w)=>S[p](...w):()=>S[p]}else if(f.get(d)){let g=f.get(d);return()=>g}else{let g=d;return()=>g}},_=(d,f,g)=>{let p=[],m=(w,k)=>{if(w==="__output"||w==="__input"||w==="__callback")p[k]={__callback:A=>A,__args:void 0,idx:k};else if(typeof w=="string")p[k]={__callback:h(w,g),__args:void 0,idx:k};else if(typeof w=="function"){let A=w;p[k]={__callback:(...T)=>A(...T),__args:void 0,idx:k}}else if(typeof w=="object"&&(w.__input||w.__callback)){let A=function(T){let U=T.__input?T.__input:T.__callback;if(typeof T.__input=="string"&&(U={__callback:h(T.__input,g),__args:void 0,idx:k}),T.__args){let L=_(U,T.__args,g);U={__callback:L.__callback,__args:L.__args,idx:k}}else U={__callback:U,__args:void 0,idx:k};if(T.__output){let L=T.__output;if(typeof T.__output=="string"?L={__callback:h(L,g),__args:void 0,idx:k}:typeof w.__output=="object"&&(L=A(L)),typeof L?.__callback=="function"){let C=U.__callback,M=L.__callback;U={__callback:(...B)=>M(C(...B)),__args:L.__args,idx:k}}}return U};p[k]=A(w)}else{let A=w;p[k]={__callback:()=>A,__args:void 0,idx:k}}};f.forEach(m),typeof d=="string"&&(d={__callback:h(d,g),__args:void 0});let S=typeof d=="function"?d:d.__callback;return d=function(...w){let k=A=>A.__callback(...w);return S(...p.map(k))},{__callback:d,__args:p}},y=Object.getOwnPropertyNames(Object.getPrototypeOf({})),b=(d,f,g)=>{d.__node.backward&&f instanceof i&&g.setListeners({[f.__node.tag]:{[d.__node.tag]:f}})},x=(d,f,g)=>{if(d.__operator){let p=Math.random();if(d.__node.loops||(d.__node.loops={}),typeof d.__node.delay=="number"){let m=d.__operator;d.__setOperator((...S)=>new Promise((w,k)=>{d.__node.loops[p]=setTimeout(async()=>{w(await m(...S))},d.__node.delay)}))}else if(d.__node.frame===!0){let m=d.__operator;d.__setOperator((...S)=>new Promise((w,k)=>{d.__node.loops[p]=requestAnimationFrame(async()=>{w(await m(...S))})}))}if(typeof d.__node.repeat=="number"||typeof d.__node.recursive=="number"){let m=d.__operator;d.__setOperator(async(...S)=>{let w=d.__node.repeat?d.__node.repeat:d.__node.recursive,k,A=async(T,...U)=>{for(;T>0;){if(d.__node.delay||d.__node.frame){m(...U).then(async L=>{d.__node.recursive?await A(T,L):await A(T,...U)});break}else k=await m(...S);T--}};return await A(w,...S),k})}if(d.__node.loop&&typeof d.__node.loop=="number"){let m=d.__operator,S=d.__node.loop;d.__setOperator((...k)=>{if("looping"in d.__node||(d.__node.looping=!0),d.__node.looping){let A=performance.now();m(...k),d.__node.loops[p]=setTimeout(()=>{let T=performance.now()-A-d.__node.loop;T>0?S=d.__node.loop-T:S=d.__node.loop,S<=0&&(S=d.__node.loop),d.__operator(...k)},S)}}),d.__node.looping&&d.__operator();let w=k=>{k.__node.looping&&(k.__node.looping=!1),k.__node.loops[p]&&(clearTimeout(k.__node.loops[p]),cancelAnimationFrame(k.__node.loops[p]))};d.__addOndisconnected(w)}}},R=(d,f,g)=>{if(d.__node.animate===!0||d.__animation){let p=d.__operator;d.__setOperator((...S)=>{"animating"in d.__node||(d.__node.animating=!0),d.__node.animating&&(typeof d.__animation=="function"?d.__animation(...S):p(...S),d.__node.animationFrame=requestAnimationFrame(()=>{d.__operator(...S)}))}),(d.__node.animating||(!("animating"in d.__node)||d.__node.animating)&&d.__animation)&&setTimeout(()=>{d.__node.animationFrame=requestAnimationFrame(d.__operator)},10);let m=S=>{S.__node.animating&&(S.__node.animating=!1),S.__node.animationFrame&&cancelAnimationFrame(S.__node.animationFrame)};d.__addOndisconnected(m)}},j=(d,f,g)=>{if(typeof d.__branch=="object"&&d.__operator&&!d.__branchApplied){let p=d.__operator;d.__branchApplied=!0,d.__operator=(...m)=>{let S=p(...m);for(let w in d.__branch){let k=()=>{typeof d.__branch[w].then=="function"?d.__branch[w].then(S):d.__branch[w].then instanceof i&&d.__branch[w].then.__operator?d.__branch[w].then.__operator(S):S=d.__branch[w].then};typeof d.__branch[w].if=="function"?d.__branch[w].if(S)==!0&&k():d.__branch[w].if===S&&k()}return S}}if(d.__listeners){for(let p in d.__listeners)if(typeof d.__listeners[p]=="object"&&d.__listeners[p].branch&&!d.__listeners[p].branchApplied){let m=d.__listeners[p].callback;d.__listeners[p].branchApplied=!0,d.__listeners.callback=S=>{let w=()=>{typeof d.__listeners[p].branch.then=="function"?S=d.__listeners[p].branch.then(S):d.__listeners[p].branch.then instanceof i&&d.__listeners[p].branch.then.__operator?S=d.__listeners[p].branch.then.__operator(S):S=d.__listeners[p].branch.then};return typeof d.__listeners[p].branch.if=="function"?d.__listeners[p].branch.if(S)&&w():d.__listeners[p].branch.if===S&&w(),m(S)}}}},z=(d,f,g)=>{if(d.__listeners)for(let p in d.__listeners)typeof d.__listeners[p]=="object"&&d.__listeners[p].oncreate&&d.__listeners[p].callback(d.__listeners[p].oncreate)},E=(d,f,g)=>{if(d.__listeners)for(let p in d.__listeners)typeof d.__listeners[p]=="object"&&typeof d.__listeners[p].binding=="object"&&(d.__listeners.callback=d.__listeners.callback.bind(d.__listeners[p].binding))},I=(d,f,g)=>{if(d.__listeners){for(let p in d.__listeners)if(typeof d.__listeners[p]=="object"&&typeof d.__listeners[p].transform=="function"&&!d.__listeners[p].transformApplied){let m=d.__listeners[p].callback;d.__listeners[p].transformApplied=!0,d.__listeners.callback=S=>(S=d.__listeners[p].transform(S),m(S))}}},P=(d,f,g)=>{d.post&&!d.__operator?d.__setOperator(d.post):!d.__operator&&typeof d.get=="function"&&d.__setOperator(d.get),!d.get&&d.__operator,d.aliases&&d.aliases.forEach(p=>{g.set(p,d);let m=S=>{g.__node.nodes.delete(p)};d.__addOndisconnected(m)}),typeof g.__node.roots?.[d.__node.tag]=="object"&&d.get&&(g.__node.roots[d.__node.tag].get=d.get)},O={backprop:b,loop:x,animate:R,branching:j,triggerListenerOncreate:z,bindListener:E,transformListenerResult:I,substitute__operator:P},D=d=>{let f={};for(let g in d)typeof d[g]=="object"?f[g]=D(d[g]):typeof d[g]=="function"?f[g]=d[g].toString():f[g]=d[g];return f};function F(d){typeof d!="string"&&(d=d.toString());let f=d.match(/\(?[^]*?\)?\s*=>/);if(f)return f[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let g=d.match(/\([^]*?\)/);return g?g[0].replace(/[()\s]/gi,"").split(","):[]}var q=d=>{let f=d.indexOf("=>")+1;return f<=0&&(f=d.indexOf("){")),f<=0&&(f=d.indexOf(") {")),d.slice(0,d.indexOf("{",f)+1)};function H(d=""){let f=S=>S.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),g=q(d),p=f(d),m;if(g.includes("function")){let S=g.substring(g.indexOf("(")+1,g.lastIndexOf(")"));m=new Function(S,p)}else if(g.substring(0,6)===p.substring(0,6)){let S=g.substring(g.indexOf("(")+1,g.lastIndexOf(")"));m=new Function(S,p.substring(p.indexOf("{")+1,p.length-1))}else try{m=(0,eval)(d)}catch{}return m}function Z(d="{}"){try{let f=typeof d=="string"?JSON.parse(d):d,g=p=>{for(let m in p)if(typeof p[m]=="string"){let S=H(p[m]);typeof S=="function"&&(p[m]=S)}else typeof p[m]=="object"&&g(p[m]);return p};return g(f)}catch(f){console.error(f);return}}var ue=function(){let d=new Map,f=[],g=["this"];function p(){d.clear(),f.length=0,g.length=1}function m(w,k){var A=f.length-1,T=f[A];if(typeof T=="object")if(T[w]===k||A===0)g.push(w),f.push(k.pushed);else for(;A-->=0;){if(T=f[A],typeof T=="object"&&T[w]===k){A+=2,f.length=A,g.length=A,--A,f[A]=k,g[A]=w;break}A--}}function S(w,k){if(k!=null&&typeof k=="object"){w&&m(w,k);let A=d.get(k);if(A)return"[Circular Reference]"+A;d.set(k,g.join("."))}return k}return function(w,k){try{return f.push(w),JSON.stringify(w,S,k)}finally{p()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=ue);var Me=function(){let d=new Map,f=[],g=["this"];function p(){d.clear(),f.length=0,g.length=1}function m(w,k){var A=f.length-1,T=f[A];if(typeof T=="object")if(T[w]===k||A===0)g.push(w),f.push(k.pushed);else for(;A-->=0;){if(T=f[A],typeof T=="object"&&T[w]===k){A+=2,f.length=A,g.length=A,--A,f[A]=k,g[A]=w;break}A--}}function S(w,k){if(k!=null&&typeof k=="object"){w&&m(w,k);let A=d.get(k);if(A)return"[Circular Reference]"+A;d.set(typeof k=="function"?k.toString():k,g.join("."))}return typeof k=="function"?k.toString():k}return function(w,k){try{return f.push(w),JSON.stringify(w,S,k)}finally{p()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=Me);var Re=function(){let d=new Map,f=[],g=["this"];function p(){d.clear(),f.length=0,g.length=1}function m(w,k){var A=f.length-1;if(f[A]){var T=f[A];if(typeof T=="object")if(T[w]===k||A===0)g.push(w),f.push(k.pushed);else for(;A-->=0;){if(T=f[A],typeof T=="object"&&T[w]===k){A+=2,f.length=A,g.length=A,--A,f[A]=k,g[A]=w;break}A++}}}function S(w,k){let A;if(k!=null)if(typeof k=="object"){let T=k.constructor.name;w&&T==="Object"&&m(w,k);let U=d.get(k);if(U)return"[Circular Reference]"+U;if(d.set(k,g.join(".")),T==="Array")k.length>20?A=k.slice(k.length-20):A=k;else if(T.includes("Set"))A=Array.from(k);else if(T!=="Object"&&T!=="Number"&&T!=="String"&&T!=="Boolean")A="instanceof_"+T;else if(T==="Object"){let L={};for(let C in k)if(k[C]==null)L[C]=k[C];else if(Array.isArray(k[C]))k[C].length>20?L[C]=k[C].slice(k[C].length-20):L[C]=k[C];else if(k[C].constructor.name==="Object"){L[C]={};for(let M in k[C])if(Array.isArray(k[C][M]))k[C][M].length>20?L[C][M]=k[C][M].slice(k[C][M].length-20):L[C][M]=k[C][M];else if(k[C][M]!=null){let B=k[C][M].constructor.name;B.includes("Set")?L[C][M]=Array.from(k[C][M]):B!=="Number"&&B!=="String"&&B!=="Boolean"?L[C][M]="instanceof_"+B:L[C][M]=k[C][M]}else L[C][M]=k[C][M]}else{let M=k[C].constructor.name;M.includes("Set")?L[C]=Array.from(k[C]):M!=="Number"&&M!=="String"&&M!=="Boolean"?L[C]="instanceof_"+M:L[C]=k[C]}A=L}else A=k}else A=k;return A}return function(w,k){f.push(w);let A=JSON.stringify(w,S,k);return p(),A}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Re);function ft(d){if(typeof d.__methods=="object")for(let f in d.__methods){let g=d.__methods[f],p=typeof g=="function"?g:H(g);f==="__operator"?d.__setOperator(p):d[f]=p.bind(d)}}var Yt=class extends r{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(d){super({...d,loaders:d?.loaders?Object.assign({...O},d.loaders):{...O}}),d?.services&&this.addServices(d.services),d?.restrict&&(this.restrict=d.restrict),this.load(this)}addServices=d=>{for(let f in d)if(typeof d[f]=="function"&&(d[f]=new d[f]),d[f]?.__node?.loaders&&Object.assign(this.__node.loaders,d[f].__node.loaders),d[f]?.__node?.nodes){d[f].__node.nodes.forEach((m,S)=>{this.get(S)?this.set(f+"."+S,m):this.set(S,m)}),this.__node.nodes.forEach((m,S)=>{d[f].__node.nodes.get(S)||d[f].__node.nodes.set(S,m)});let g=this.set;this.set=(m,S)=>(d[f].set(m,S),g(m,S));let p=this.delete;this.delete=m=>(d[f].delete(m),p(m))}else typeof d[f]=="object"&&this.load(d[f])};handleMethod=(d,f,g)=>{let p=f,m=this.__node.nodes.get(d);if(m||(m=this.__node.roots[d]),m?.[p])if(typeof m[p]!="function"){if(g){Array.isArray(g)&&g.length===1?m[p]=g[0]:m[p]=g;return}return m[p]}else return Array.isArray(g)?m[p](...g):m[p](g);else return this.handleServiceMessage({route:d,args:g,method:f})};handleServiceMessage(d){let f;return typeof d=="object"&&(d.route?f=d.route:d.node&&(f=d.node)),f?Array.isArray(d.args)?this.run(f,...d.args):this.run(f,d.args):d}handleGraphNodeCall(d,f){if(!d)return f;if(f?.args)this.handleServiceMessage(f);else return Array.isArray(f)?this.run(d,...f):this.run(d,f)}transmit=(...d)=>{if(typeof d[0]=="object"){let f=d[0];if(f.method)return this.handleMethod(f.route,f.method,f.args);if(f.route)return this.handleServiceMessage(f);if(f.node)return this.handleGraphNodeCall(f.node,f.args);this.__node.keepState&&(f.route&&this.setState({[f.route]:f.args}),f.node&&this.setState({[f.node]:f.args}));return}else return};receive=(...d)=>{if(d[0]){let f=d[0];if(typeof f=="string"){let g=f.substring(0,8);(g.includes("{")||g.includes("["))&&(g.includes("\\")&&(f=f.replace(/\\/g,"")),f[0]==='"'&&(f=f.substring(1,f.length-1)),f=JSON.parse(f))}if(typeof f=="object"){if(f.method)return this.restrict?.[f.route]?void 0:this.handleMethod(f.route,f.method,f.args);if(f.route)return this.restrict?.[f.route]?void 0:this.handleServiceMessage(f);if(f.node)return typeof f.node=="string"&&this.restrict?.[f.node]?void 0:this.handleGraphNodeCall(f.node,f.args);this.__node.keepState&&(f.route&&this.setState({[f.route]:f.args}),f.node&&this.setState({[f.node]:f.args}));return}}};pipe=(d,f,g,p,m)=>{if(d instanceof i)return m?this.subscribe(d,S=>{let w=m(S);w!==void 0?this.transmit({route:f,args:w,method:p}):this.transmit({route:f,args:S,method:p},g)}):this.subscribe(d,S=>{this.transmit({route:f,args:S,method:p},g)});if(typeof d=="string")return this.subscribe(d,S=>{this.transmit({route:f,args:S,method:p},g)})};pipeOnce=(d,f,g,p,m)=>{if(d instanceof i)return m?d.__node.state.subscribeEventOnce(d.__node.unique,S=>{let w=m(S);w!==void 0?this.transmit({route:f,args:w,method:p}):this.transmit({route:f,args:S,method:p},g)}):this.__node.state.subscribeEventOnce(d.__node.unique,S=>{this.transmit({route:f,args:S,method:p},g)});if(typeof d=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(d).__node.unique,S=>{this.transmit({route:f,args:S,method:p},g)})};terminate=(...d)=>{};isTypedArray=ht;recursivelyAssign=J;spliceTypedArray=le;ping=()=>(console.log("pinged!"),"pong");echo=(...d)=>(this.transmit(...d),d);log=(...d)=>(console.log(...d),!0);error=(...d)=>(console.error(...d),!0)};function ht(d){return ArrayBuffer.isView(d)&&Object.prototype.toString.call(d)!=="[object DataView]"}var J=(d,f)=>{for(let g in f)f[g]?.constructor.name==="Object"&&!Array.isArray(f[g])?d[g]?.constructor.name==="Object"&&!Array.isArray(d[g])?J(d[g],f[g]):d[g]=J({},f[g]):d[g]=f[g];return d};function le(d,f,g){let p=d.subarray(0,f),m;g&&(m=d.subarray(g+1));let S;return(p.length>0||m?.length>0)&&(S=new d.constructor(p.length+m.length)),S&&(p.length>0&&S.set(p),m&&m.length>0&&S.set(m,p.length)),S}})();var Xt=class extends(void 0){name="router";connections={};sources={};services={};serviceConnections={};users={};userTimeout=1e4;order;constructor(e){if(super(e),this.load(this),e&&(e.order&&(this.order=e.order),e.timeout&&(this.userTimeout=e.timeout),e.graph))for(let t in e.graph){let s=e.graph[t];if(typeof s=="function"&&(s=new s),s?.__node?.nodes)s.name=t,s.__node.tag=t,this.addServices({[s.name]:s}),this.routeService(s,s.connections);else if(typeof s?.service=="function"&&(s.service=new s.service),s?.service?.__node?.nodes&&(s.service.name=t,s.service.__node.tag=t,this.addServices({[s.service.name]:s.service}),this.routeService(s.service)),typeof s?.service=="object"&&(s.connections&&(Array.isArray(s.connections)?s.connections.forEach(i=>{this.addServiceConnections(s[t].service,i)}):this.addServiceConnections(s.service,s.connections)),s.config))for(let i in s.config)this.openConnection(s.service,s.config[i],s.config[i].source,s.config[i].args)}}addUser=async(e,t,s,i)=>{let r;if(e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),this.users[e._id]?r=this.users[e._id]:r=Object.assign({},e),t){for(let o in t)typeof t[o]=="object"&&(t[o].connection._id||await new Promise((a,l)=>{let c=performance.now(),u=()=>{t[o].connection._id?a(!0):performance.now()-c>this.userTimeout?(delete t[o],l(!1)):setTimeout(()=>{u()},100)};u()}).catch(a=>{console.error("Connections timed out:",a)}));for(let o in t)t[o]=this.addConnection(t[o],r._id)}if(s)for(let o in s)this.openConnection(s[o].service,s[o],r._id,s[o].args);if(!this.users[e._id]){let o=(E,...I)=>{let P=this.getConnection(r._id,"send");if(P?.send)return P.send(E,...I)},a=(E,...I)=>{let P=this.getConnections(r._id,"send");for(let O in P)if(P[O]?.send)return P[O].send(E,...I)},l=(E,I,...P)=>{let O=this.getConnection(r._id,"request");if(O?.request)return O.request(E,I,...P)},c=(E,I,...P)=>{let O=this.getConnections(r._id,"request"),D=[];for(let F in O)O[F]?.request&&D.push(O[F].request(E,I,...P));return Promise.all(D)},u=(E,I,P,...O)=>{let D=this.getConnection(r._id,"post");if(D?.post)return D.post(E,I,P,...O)},h=(E,I,P,...O)=>{let D=this.getConnections(r._id,"post");for(let F in D)D[F]?.post&&D[F].post(E,I,P,...O)},_=(E,I,P,...O)=>{let D=this.getConnection(r._id,"run");if(D?.run)return D.run(E,I,P,...O)},y=(E,I,P,...O)=>{let D=this.getConnections(r._id,"run"),F=[];for(let q in D)D[q]?.run&&F.push(D[q].run(E,I,P,...O));return Promise.all(F)},b=(E,I,...P)=>{let O=this.getConnection(r._id,"subscribe");if(O?.subscribe)return O.subscribe(E,I,...P)},x=(E,I,...P)=>{let O=this.getConnections(r._id,"subscribe"),D=[];for(let F in O)O[F]?.post&&D.push(O[F].subscribe(E,I,...P));return Promise.all(D)},R=(E,I,...P)=>{let O=this.getConnection(r._id,"unsubscribe");if(O?.unsubscribe)return O.unsubscribe(E,I,...P)},j=(E,I,...P)=>{let O=this.getConnections(r._id,"unsubscribe"),D=[];for(let F in O)O[F]?.post&&I?.[F]&&D.push(O[F].unsubscribe(E,I[F],...P));return Promise.all(D)},z=()=>this.removeUser(r);r.send=o,r.request=l,r.post=u,r.run=_,r.subscribe=b,r.unsubscribe=R,r.terminate=z,r.sendAll=a,r.requestAll=c,r.postAll=h,r.runAll=y,r.subscribeAll=x,r.unsubscribeAll=j,r.terminateAll=z,this.users[r._id]=r}if(t&&!i){let o={},a=!1;Object.keys(t).map((l,c)=>{t[l]?._id&&(o[`${c}`]=t[l]?._id,a=!0)}),a&&r.send({route:"addUser",args:[{_id:r._id},o,void 0,!0]})}return r};removeUser(e,t){return t&&this.removeConnection(e,t),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}getConnection=(e,t,s)=>{if(this.connections[e])return this.connections[e];if(this.sources[e]){if(t?.includes("All"))return this.users[e];if(s)if(t){if(this.sources[e][s]?.[t])return this.sources[e][s]}else return this.sources[e][s]?this.sources[e][s]:void 0;else if(this.order)for(let i=0;i<this.order.length;i++){let r=this.order[i];for(let o in this.sources[e])if(this.sources[e][o].service){if(typeof this.sources[e][o].service=="object"){if(this.sources[e][o].service.__node.tag===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name&&!this.serviceConnections[this.sources[e][o].service.name]){this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}else if(this.sources[e][o].service===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name){this.serviceConnections[this.sources[e][o].service.name]||this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}}else for(let i in this.sources[e]){if(this.sources[e][i].connectionType&&this.sources[e][i].service?.name&&!this.serviceConnections[this.sources[e][i].service.name]){this.removeConnection(this.sources[e][i]);continue}if(t){if(this.sources[e][i][t])return this.sources[e][i]}else return this.sources[e][i]}}else if(this.order&&!this.connections[e])for(let i=0;i<this.order.length;i++){let r=this.order[i];if(this.sources[r]?.[e]){if(this.sources[r][e].connectionType&&this.sources[r][e].service?.name&&!this.serviceConnections[this.sources[r][e].service.service.name]){this.removeConnection(this.sources[r][e].service);continue}if(t){if(this.sources[r][e][t])return this.sources[r][e]}else return this.sources[r][e]}}};getConnections=(e,t,s)=>{if(this.sources[e]){if(!s&&!t)return this.sources[e];let i={};for(let r in this.sources[e])if(typeof this.sources[e][r]=="object"){if(this.sources[e][r]._id){let o=!0;if(t&&!this.sources[e][r][t]&&(o=!1),s)for(let a in s)if(typeof this.sources[e][r][a]=="object"&&typeof s[a]=="object"){for(let l in s[a])if(s[a][l]!==this.sources[e][r][a][l]){o=!1;break}}else if(this.sources[e][r][a]!==s[a])o=!1;else{o=!1;break}o&&(i[this.sources[e][r]._id]=this.sources[e][r])}else for(let o in this.sources[e][r])if(typeof this.sources[e][r][o]=="object"){let a=!0;if(t&&!this.sources[e][r][o][t]&&(a=!1),s)for(let l in s)if(typeof this.sources[e][r][o][l]=="object"&&typeof s[l]=="object"){for(let c in s[l])if(s[l][c]!==this.sources[e][r][o][l][c]){a=!1;break}}else if(this.sources[e][r][o][l]!==s[l])a=!1;else{a=!1;break}a&&(i[this.sources[e][r][o]._id]=this.sources[e][r][o])}}return i}};runConnection=async(e,t,s,i)=>{let r;if(t.indexOf("All")>-1?r=this.users[e]:r=this.getConnection(e,t,i),r){let o=r[t](...s);return o=await o,o}};subscribeThroughConnection=(e,t,s,i,...r)=>{if(typeof t=="string"&&(t=this.getConnection(t,"run")),typeof t=="object")return new Promise((o,a)=>{t.run("routeConnections",[e,s,t._id,...r]).then(l=>{this.__node.state.subscribeEvent(s,c=>{c?.callbackId===e&&(i?typeof i=="string"?this.setState({[i]:c.args}):i(c.args):this.setState({[s]:c.args}))}),o(l)}).catch(a)})};addConnection=(e,t,s=!0)=>{let i={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let r in this.serviceConnections)for(let o in this.serviceConnections[r])if(this.serviceConnections[r][o][e]){e={connection:this.serviceConnections[r][o][e]},e.service=r,i.connectionType=r,i.connectionsKey=o;break}typeof e=="string"&&this.__node.nodes.get(e)&&(e={connection:this.__node.nodes.get(e)})}if(!(!e||typeof e=="string")){if(t&&(i.source=t),e.connection instanceof void 0){i.connection=e.connection;let r=i.connection;i.send=async o=>o.method?Array.isArray(o.args)?r[o.method]?.(...o.args):r[o.method]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.request=async(o,a)=>a?Array.isArray(o.args)?r[a]?.(...o.args):r[a]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.post=async(o,a,l)=>{if(o&&r.__node.graph.get(o)){let c=r.__node.graph.get(o);return l?Array.isArray(a)?c[l]?.(...a):c[l]?.(a):Array.isArray(a)?c.__operator(...a):c.__operator(a)}else return l?Array.isArray(a)?r[l]?.(...a):r[l]?.(a):Array.isArray(a)?r.__operator(...a):r.__operator(a)},i.run=i.post,i.subscribe=async o=>r.__subscribe(o),i.unsubscribe=async o=>r.__unsubscribe(o),i.terminate=()=>(r.__node.graph.remove(r),!0),i.onclose=e.onclose,i.onclose&&r.__addOndisconnected(o=>{i.onclose&&i.onclose(i,o)})}else if(e.connection instanceof void 0){e.connection.__node.nodes.get("open")&&(i.service=e.connection);let r=i.connection;i.send=async o=>{Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.request=async(o,a)=>{if(o.route)return a?Array.isArray(o.args)?r.__node.nodes.get(o.route)[a]?.(...o.args):r.__node.nodes.get(o.route)[a]?.(o.args):Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.post=async(o,a,l)=>{if(o&&r.get(o)){let c=r.get(o);return l?Array.isArray(a)?c[l]?.(...a):c[l]?.(a):Array.isArray(a)?c.run(...a):c.run(a)}},i.run=i.post,i.subscribe=async(o,a)=>r.subscribe(o,a),i.unsubscribe=async(o,a)=>r.unsubscribe(o,a),i.terminate=o=>(r.remove(o),!0)}else if(!(e._id&&this.connections[e._id])){let r=e.connection;if(typeof r=="string"){if(this.connections[r])r=this.connections[r];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let o in e.service.connections)if(e.service.connections[o][r]){r=e.service.connections[o][r],i.connectionType=o,i.connectionsKey=r;break}}}else for(let o in this.serviceConnections)for(let a in this.serviceConnections[o])if(this.serviceConnections[o][a][r]){r=this.serviceConnections[o][a][r],e.service=o,i.connectionType=o,i.connectionsKey=a;break}}if(typeof r!="object")return;if(i._id=r._id,i.connection=e.connection,i.send=r.send,i.request=r.request,i.run=r.run,i.post=r.post,i.subscribe=r.subscribe,i.unsubscribe=r.unsubscribe,i.terminate=r.terminate,i.onclose=e.onclose,i.onclose){if(!(r.onclose&&i.onclose.toString()===r.onclose.toString())){let o=r.onclose;r.onclose=(...a)=>{i.onclose&&i.onclose(i,...a),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}}else{let o=r.onclose;r.onclose=(...a)=>{this.removeConnection(i),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),i.service=e.service):r.graph&&(i.service=r.graph)}return!i.source&&e.source?i.source=e.source:!i.source&&e.service?i.source=typeof e.service=="object"?e.service?.name:void 0:!i.source&&(i.connection instanceof void 0||i.connection instanceof void 0)&&(i.source="local",this.order.indexOf("local")||this.order.unshift("local")),i._id||(i._id=`connection${Math.floor(Math.random()*1e15)}`),i.source&&(this.sources[i.source]||(this.sources[i.source]={}),this.sources[i.source][i._id]=i),this.connections[i._id]||(this.connections[i._id]=i),i}};removeConnection=(e,t=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){t&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let s in this.sources)if(this.sources[s][e])delete this.sources[s][e];else for(let i in this.sources[s])this.sources[s][i]?.[e]&&delete this.sources[s][e];return!0}else if(this.sources[e]){for(let s in this.sources[e])this.removeConnection(this.sources[e][s],t);return!0}}};routeService=(e,t,s,i)=>{if(this.services[e.name]=e,e.__node?.nodes&&this.__node.nodes.forEach((r,o)=>{e.__node?.nodes.get(o)?e.__node?.nodes.set(this.name+"."+o,r):e.__node?.nodes.set(o,r)}),e.users&&(e.users=this.users),t)if(typeof t=="string")this.addServiceConnections(e,t,s);else for(let r in t)this.addServiceConnections(e,r,s);i?this.order=i:(this.order||(this.order=[]),this.order.push(e.name))};addServiceConnections=(e,t,s)=>{if(typeof e=="string"&&(e=this.services[e]),t&&e[t]){let i={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][t]=e[t];for(let r in e[t])this.connections[r]||(i[r]=this.addConnection({connection:e[t][r],service:e},s),i[r].connectionType=t);return i}};openConnection=async(e,t,s,...i)=>{if(typeof e=="string"&&(e=this.services[e]),e?.__node.nodes){let r=e.run("open",t,...i);if(r instanceof Promise)return r.then(async o=>{o._id||await Qt(o,this.userTimeout),o._id&&this.addConnection({connection:o,service:e},s)});if(r&&(r._id||await Qt(r,this.userTimeout),r._id))return this.addConnection({connection:r,service:e},s)}};terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());routeConnections=(e,t,s,...i)=>{let r;if(typeof s=="string"&&(this.sources[s]&&(r=s),s=this.getConnection(s,"send")),typeof t=="string"&&(t=this.getConnection(t,"subscribe")),t?.subscribe&&s?.send)return new Promise((a,l)=>{t.subscribe(e,c=>{!this.connections[s._id]&&r&&this.sources[r]&&(r=s,Object.keys(this.sources[r]).forEach(u=>{this.sources[s][u].send&&(s=this.sources[s][u])})),this.connections[s._id]&&s.send({callbackId:e,args:c})},...i).then(c=>{a(c)})})};setUserData=(e,t)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object")return this.recursivelyAssign(e,t),!0}};function Qt(n,e=1e4){return new Promise((t,s)=>{let i=performance.now(),r=()=>{n._id?t(!0):performance.now()-i>e?s(!1):setTimeout(()=>{r()},100)};r()}).catch(t=>{console.error("Connection timed out:",t)})}var bt=class{_raw=[];constructor(e){e&&(this._raw=[...e])}get buffer(){let e=this._raw;return this._raw=[],e}set buffer(e){if(Array.isArray(e))this._raw.push(...e);else throw new Error("Input must be an array")}clear(){this._raw.length=0}push(...e){e.length>1?this._raw.push(...e):Array.isArray(e[0])?this._raw.push(...e[0]):this._raw.push(e[0])}get length(){return this._raw.length}set length(e){this._raw.length=e}},vt=class{_raw;_size;onfilled;_count=0;constructor(e,t){if(e<=0)throw new Error("Size must be greater than 0");this._size=e,this._raw=new Array(e),t&&this.push(t)}get buffer(){return this._count<this._size?this._raw.slice(this._size-this._count):[...this._raw]}clear(){this._raw.length=0}set buffer(e){this.push(e)}push(...e){e.length>1?this.pushArray(e):Array.isArray(e[0])?this.pushArray(e[0]):(this._raw.length>=this._size&&this._raw.splice(0,1),this._raw.push(e[0]),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&this._count++)}pushArray(e){let t=e.length,s=this._raw.length+t;s>this._size&&this._raw.splice(0,s-this._size),this._raw.push(...e),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&(this._count+=e.length,this._count>this._size&&(this._count=this._size))}get length(){return this._count}set length(e){if(e<0||e>this._size)throw new Error(`Length must be between 0 and ${this._size}`);this._count=e}},St=class{_buffer={};bufferHasData;_rules;_pollInterval;_pollTimeout;onupdate;prevState;constructor(e,t){this._pollInterval=t,this.setRules(e)}setRules(e){this._rules?Object.assign(this._rules,e):this._rules=e}clearRules(e){for(let t of e)delete this._rules[t]}set buffer(e){for(let t in e){let s=this._rules[t];if(!s)continue;let i=e[t];s==="state"||s===!0?(this._buffer[t]=i,this.bufferHasData=!0):s==="inpbuf"?(this._buffer[t]||(this._buffer[t]=new bt),this._buffer[t].push(i),this.bufferHasData=!0):s?.type==="circbuf"&&(this._buffer[t]||(this._buffer[t]=new vt(s.length)),this._buffer[t].push(i),this.bufferHasData=!0)}}get buffer(){let e={};for(let t in this._buffer)this._buffer[t]!==void 0&&(this._buffer[t]?._raw?(e[t]=this._buffer[t].buffer,this._buffer[t].clear()):(e[t]=this._buffer[t],delete this._buffer[t]));return this.bufferHasData=!1,e}clear(){this._buffer={},this.bufferHasData=!1}startPolling(e){e&&(this.onupdate=e),this._pollInterval&&!this._pollTimeout&&(this._pollTimeout=setInterval(()=>{if(this.bufferHasData&&this.onupdate){let t=this.buffer;this.prevState=t,this.onupdate(t),this.clear()}},this._pollInterval))}stopPolling(){this._pollTimeout&&(clearInterval(this._pollTimeout),this._pollTimeout=void 0)}},qe=class{buffers={};pollInterval;pollTimeout;onupdate;prevState;constructor(e){this.pollInterval=e}createBuffer(e,t,s){if(this.buffers[e])throw new Error(`Buffer with name ${e} already exists`);let i=new St(t,s);this.buffers[e]=i}deleteBuffer(e){delete this.buffers[e]}get(e){return this.buffers[e]}updateBuffer(e,t){if(this.buffers[e])this.buffers[e].buffer=t;else throw new Error("No buffer found of name "+e)}aggregateBuffers(){let e={};for(let t in this.buffers)if(this.buffers[t].bufferHasData){let s=this.buffers[t].buffer;e[t]=s,this.buffers[t].clear()}this.prevState=e,this.onupdate&&Object.keys(e).length>0&&this.onupdate(e)}startPolling(e){e&&(this.onupdate=e),this.pollInterval&&!this.pollTimeout&&(this.pollTimeout=setInterval(()=>{this.aggregateBuffers()},this.pollInterval))}stopPolling(){this.pollTimeout&&(clearInterval(this.pollTimeout),this.pollTimeout=void 0)}};var $e=class{sessions={};delayBufferManager;globalPollInterval=1e3;tokens={};useTokens=!1;prevState;onupdate;constructor(e,t,s){e&&(this.globalPollInterval=e),t&&(this.onupdate=t),s!==void 0&&(this.useTokens=s),this.delayBufferManager=new qe(this.globalPollInterval),this.delayBufferManager.onupdate=i=>{if(this.onupdate){let r=Object.keys(i),o={};r.forEach(a=>{o[a]=this.sessions[a]}),this.prevState=i,this.onupdate(i,o)}else console.log("Buffers updated:",i)}}createSession=(e,t,s,i,r)=>{if(this.sessions[e])return new Error(`Session with ID ${e} already exists`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==r))return new Error(`Invalid token for user ${t}`);this.delayBufferManager.createBuffer(e,s);let o={password:i?.password,bannedUsers:i?.bannedUsers||{},adminUsers:i?.adminUsers||{}};o.adminUsers[t]=!0,this.sessions[e]={users:{},rules:o,db:this.delayBufferManager.get(e)},this.addUserToSession(e,t,r,i?.password)};deleteSession=(e,t,s)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);(this.checkAdmin(e,t,s)||Object.keys(i.rules.adminUsers).length===0||Object.keys(i.users).length===0)&&(this.delayBufferManager.deleteBuffer(e),delete this.sessions[e])};clearUserToken=e=>{delete this.tokens[e]};getSessionInfo=(e,t,s)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);let r=this.delayBufferManager.get(e)?._rules;return{_id:e,users:Object.keys(i.users),dbrules:r}};checkAdmin(e,t,s){let i=this.sessions[e];return this.useTokens&&(!i.rules.adminUsers[t]||this.tokens[t]!==s)?(console.error(`User ${t} does not have admin privileges or invalid token`),!1):!0}updateSessions=(e,t,s,i,r,o)=>{for(let a in e)this.updateBuffer(a,e[a],t,s,i?.[a],r,o)};updateBuffer=(e,t,s,i,r,o,a)=>{let l=this.sessions[e];l&&(!this.useTokens||s&&l.users[s]&&this.tokens[s]===i||o&&this.checkAdmin(e,o,a)||l.rules.password&&l.rules.password===r)&&this.delayBufferManager.updateBuffer(e,t)};addUserToSession=(e,t,s,i,r,o,a)=>{let l=this.sessions[e];if(!l)return new Error(`Session with ID ${e} does not exist`);if(l.rules.password&&l.rules.password!==i||a&&!this.checkAdmin(e,o,a))return new Error("Password required or invalid admin token");if(l.rules.bannedUsers&&l.rules.bannedUsers[t])return new Error(`User ${t} is banned from this session`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);l.users[t]=!0,r&&l.db.setRules(r)};removeUserFromSession=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);r.users[t]&&this.checkAdmin(e,s,i)&&delete r.users[t]};setAdmin=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,i)&&(r.rules.adminUsers[t]=!0)};removeAdmin=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);Object.keys(r.rules.adminUsers).length>1&&this.checkAdmin(e,s,i)&&delete r.rules.adminUsers[t]};banUser=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,t,i)&&(r.rules.bannedUsers[s]=!0,this.removeUserFromSession(e,s,t,i))};unbanUser=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,i)&&delete r.rules.bannedUsers[t]};splitUpdatesByUser=e=>{let t={};return Object.keys(e).forEach(s=>{let i=this.sessions[s];if(!i)return;let r=e[s];r&&Object.keys(i.users).forEach(o=>{t[o]||(t[o]={}),t[o][s]=r})}),t};startPolling=()=>{this.delayBufferManager.startPolling()};stopPolling=()=>{this.delayBufferManager.stopPolling()};setSessionToken=(e,t)=>{this.tokens[e]=t};generateSessionToken=e=>{let t=`${Math.floor(Math.random()*1e15)}`;return e&&(this.tokens[e]=t),t}};var es=class extends(void 0){users={};sessionManager;sessionData={};onlocalupdate;onremoteupdate;constructor(e,t,s,i,r=!1){if(super(e),i){this.users=i;for(let l in i)i[l]._id||(i[l]._id=l)}s&&(this.onlocalupdate=s),this.sessionManager=new $e(t||1e3,(l,c)=>{let u=this.sessionManager.splitUpdatesByUser(l);for(let h in u)this.onlocalupdate?this.onlocalupdate(u[h],c,this.users[h]):this.users[h]?.send&&this.users[h].send({route:"receiveSessionData",args:[u[h],h]})},r);let o={},a=Object.getOwnPropertyNames(this.sessionManager);for(let l of a)l!=="createSession"&&l!=="updateSessions"&&l!=="updateBuffer"&&l!=="setSessionToken"&&l!=="generateSessionToken"&&l!=="startPolling"&&l!=="stopPolling"&&typeof this.sessionManager[l]=="function"&&(o[l]=(...c)=>{let u=this.sessionManager[l](...c);u instanceof Error&&console.error(u)});this.load(this),this.load(o)}get prevState(){if(this.sessionManager?.prevState)return this.sessionManager.prevState}setSessionToken=(e,t,s)=>{if(this.sessionManager.setSessionToken(e,t),s&&this.users[e]?.send){let i={route:"setSessionToken",args:[e,t]};this.users[e].send(i)}else this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t};generateSessionToken=e=>{let t=this.sessionManager.generateSessionToken(e);return e&&this.users[e]&&(this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t),t};messageRemoteSession=(e,t,...s)=>{this.users[e].send({route:t,args:s})};receiveSessionData=(e,t)=>{let s={};for(let i in e)this.sessionData[i]||(this.sessionData[i]={}),this.recursivelyAssign(this.sessionData[i]||{},e),s=this.sessionData[i];return this.onremoteupdate&&this.onremoteupdate(s,this.users[t]),s};createSession=(e,t,s,i,r)=>this.sessionManager.createSession(e,t,s,i,r);updateSessions=(e,t,s,i,r,o)=>this.sessionManager.updateSessions(e,t,s,i,r,o);updateBuffer=(e,t,s,i,r,o,a)=>this.sessionManager.updateBuffer(e,t,s,i,r,o,a);startPolling=()=>this.sessionManager.startPolling();stopPolling=()=>this.sessionManager.stopPolling()};var v={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(n){this.toString=function(){return"CORRUPT: "+this.message},this.message=n},invalid:function(n){this.toString=function(){return"INVALID: "+this.message},this.message=n},bug:function(n){this.toString=function(){return"BUG: "+this.message},this.message=n},notReady:function(n){this.toString=function(){return"NOT READY: "+this.message},this.message=n}}};v.cipher.aes=function(n){this.s[0][0][0]||this.O();var e,t,s,i,r=this.s[0][4],o=this.s[1];e=n.length;var a=1;if(e!==4&&e!==6&&e!==8)throw new v.exception.invalid("invalid aes key size");for(this.b=[s=n.slice(0),i=[]],n=e;n<4*e+28;n++)t=s[n-1],(n%e===0||e===8&&n%e===4)&&(t=r[t>>>24]<<24^r[t>>16&255]<<16^r[t>>8&255]<<8^r[t&255],n%e===0&&(t=t<<8^t>>>24^a<<24,a=a<<1^283*(a>>7))),s[n]=s[n-e]^t;for(e=0;n;e++,n--)t=s[e&3?n:n-4],i[e]=4>=n||4>e?t:o[0][r[t>>>24]]^o[1][r[t>>16&255]]^o[2][r[t>>8&255]]^o[3][r[t&255]]};v.cipher.aes.prototype={encrypt:function(n){return bi(this,n,0)},decrypt:function(n){return bi(this,n,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var n=this.s[0],e=this.s[1],t=n[4],s=e[4],i,r,o,a=[],l=[],c,u,h,_;for(i=0;256>i;i++)l[(a[i]=i<<1^283*(i>>7))^i]=i;for(r=o=0;!t[r];r^=c||1,o=l[o]||1)for(h=o^o<<1^o<<2^o<<3^o<<4,h=h>>8^h&255^99,t[r]=h,s[h]=r,u=a[i=a[c=a[r]]],_=16843009*u^65537*i^257*c^16843008*r,u=257*a[h]^16843008*h,i=0;4>i;i++)n[i][r]=u=u<<24^u>>>8,e[i][h]=_=_<<24^_>>>8;for(i=0;5>i;i++)n[i]=n[i].slice(0),e[i]=e[i].slice(0)}};function bi(n,e,t){if(e.length!==4)throw new v.exception.invalid("invalid aes block size");var s=n.b[t],i=e[0]^s[0],r=e[t?3:1]^s[1],o=e[2]^s[2];e=e[t?1:3]^s[3];var a,l,c,u=s.length/4-2,h,_=4,y=[0,0,0,0];a=n.s[t],n=a[0];var b=a[1],x=a[2],R=a[3],j=a[4];for(h=0;h<u;h++)a=n[i>>>24]^b[r>>16&255]^x[o>>8&255]^R[e&255]^s[_],l=n[r>>>24]^b[o>>16&255]^x[e>>8&255]^R[i&255]^s[_+1],c=n[o>>>24]^b[e>>16&255]^x[i>>8&255]^R[r&255]^s[_+2],e=n[e>>>24]^b[i>>16&255]^x[r>>8&255]^R[o&255]^s[_+3],_+=4,i=a,r=l,o=c;for(h=0;4>h;h++)y[t?3&-h:h]=j[i>>>24]<<24^j[r>>16&255]<<16^j[o>>8&255]<<8^j[e&255]^s[_++],a=i,i=r,r=o,o=e,e=a;return y}v.bitArray={bitSlice:function(n,e,t){return n=v.bitArray.$(n.slice(e/32),32-(e&31)).slice(1),t===void 0?n:v.bitArray.clamp(n,t-e)},extract:function(n,e,t){var s=Math.floor(-e-t&31);return((e+t-1^e)&-32?n[e/32|0]<<32-s^n[e/32+1|0]>>>s:n[e/32|0]>>>s)&(1<<t)-1},concat:function(n,e){if(n.length===0||e.length===0)return n.concat(e);var t=n[n.length-1],s=v.bitArray.getPartial(t);return s===32?n.concat(e):v.bitArray.$(e,s,t|0,n.slice(0,n.length-1))},bitLength:function(n){var e=n.length;return e===0?0:32*(e-1)+v.bitArray.getPartial(n[e-1])},clamp:function(n,e){if(32*n.length<e)return n;n=n.slice(0,Math.ceil(e/32));var t=n.length;return e=e&31,0<t&&e&&(n[t-1]=v.bitArray.partial(e,n[t-1]&2147483648>>e-1,1)),n},partial:function(n,e,t){return n===32?e:(t?e|0:e<<32-n)+1099511627776*n},getPartial:function(n){return Math.round(n/1099511627776)||32},equal:function(n,e){if(v.bitArray.bitLength(n)!==v.bitArray.bitLength(e))return!1;var t=0,s;for(s=0;s<n.length;s++)t|=n[s]^e[s];return t===0},$:function(n,e,t,s){var i;for(i=0,s===void 0&&(s=[]);32<=e;e-=32)s.push(t),t=0;if(e===0)return s.concat(n);for(i=0;i<n.length;i++)s.push(t|n[i]>>>e),t=n[i]<<32-e;return i=n.length?n[n.length-1]:0,n=v.bitArray.getPartial(i),s.push(v.bitArray.partial(e+n&31,32<e+n?t:s.pop(),1)),s},i:function(n,e){return[n[0]^e[0],n[1]^e[1],n[2]^e[2],n[3]^e[3]]},byteswapM:function(n){var e,t;for(e=0;e<n.length;++e)t=n[e],n[e]=t>>>24|t>>>8&65280|(t&65280)<<8|t<<24;return n}};v.codec.utf8String={fromBits:function(n){var e="",t=v.bitArray.bitLength(n),s,i;for(s=0;s<t/8;s++)!(s&3)&&(i=n[s/4]),e+=String.fromCharCode(i>>>8>>>8>>>8),i<<=8;return decodeURIComponent(escape(e))},toBits:function(n){n=unescape(encodeURIComponent(n));var e=[],t,s=0;for(t=0;t<n.length;t++)s=s<<8|n.charCodeAt(t),(t&3)===3&&(e.push(s),s=0);return t&3&&e.push(v.bitArray.partial(8*(t&3),s)),e}};v.codec.hex={fromBits:function(n){var e="",t;for(t=0;t<n.length;t++)e+=((n[t]|0)+0xf00000000000).toString(16).substr(4);return e.substr(0,v.bitArray.bitLength(n)/4)},toBits:function(n){var e,t=[],s;for(n=n.replace(/\s|0x/g,""),s=n.length,n=n+"00000000",e=0;e<n.length;e+=8)t.push(parseInt(n.substr(e,8),16)^0);return v.bitArray.clamp(t,4*s)}};v.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(n,e,t){var s=v.codec.base32.BASE,i=v.codec.base32.REMAINING,r="",o=0,a=v.codec.base32.B,l=0,c=v.bitArray.bitLength(n);for(t&&(a=v.codec.base32.X),t=0;r.length*s<c;)r+=a.charAt((l^n[t]>>>o)>>>i),o<s?(l=n[t]<<s-o,o+=i,t++):(l<<=s,o-=s);for(;r.length&7&&!e;)r+="=";return r},toBits:function(n,e){n=n.replace(/\s|=/g,"").toUpperCase();var t=v.codec.base32.BITS,s=v.codec.base32.BASE,i=v.codec.base32.REMAINING,r=[],o,a=0,l=v.codec.base32.B,c=0,u,h="base32";for(e&&(l=v.codec.base32.X,h="base32hex"),o=0;o<n.length;o++){if(u=l.indexOf(n.charAt(o)),0>u){if(!e)try{return v.codec.base32hex.toBits(n)}catch{}throw new v.exception.invalid("this isn't "+h+"!")}a>i?(a-=i,r.push(c^u>>>a),c=u<<t-a):(a+=s,c^=u<<t-a)}return a&56&&r.push(v.bitArray.partial(a&56,c,1)),r}};v.codec.base32hex={fromBits:function(n,e){return v.codec.base32.fromBits(n,e,1)},toBits:function(n){return v.codec.base32.toBits(n,1)}};v.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(n,e,t){var s="",i=0,r=v.codec.base64.B,o=0,a=v.bitArray.bitLength(n);for(t&&(r=r.substr(0,62)+"-_"),t=0;6*s.length<a;)s+=r.charAt((o^n[t]>>>i)>>>26),6>i?(o=n[t]<<6-i,i+=26,t++):(o<<=6,i-=6);for(;s.length&3&&!e;)s+="=";return s},toBits:function(n,e){n=n.replace(/\s|=/g,"");var t=[],s,i=0,r=v.codec.base64.B,o=0,a;for(e&&(r=r.substr(0,62)+"-_"),s=0;s<n.length;s++){if(a=r.indexOf(n.charAt(s)),0>a)throw new v.exception.invalid("this isn't base64!");26<i?(i-=26,t.push(o^a>>>i),o=a<<32-i):(i+=6,o^=a<<32-i)}return i&56&&t.push(v.bitArray.partial(i&56,o,1)),t}};v.codec.base64url={fromBits:function(n){return v.codec.base64.fromBits(n,1,1)},toBits:function(n){return v.codec.base64.toBits(n,1)}};v.hash.sha256=function(n){this.b[0]||this.O(),n?(this.F=n.F.slice(0),this.A=n.A.slice(0),this.l=n.l):this.reset()};v.hash.sha256.hash=function(n){return new v.hash.sha256().update(n).finalize()};v.hash.sha256.prototype={blockSize:512,reset:function(){return this.F=this.Y.slice(0),this.A=[],this.l=0,this},update:function(n){typeof n=="string"&&(n=v.codec.utf8String.toBits(n));var e,t=this.A=v.bitArray.concat(this.A,n);if(e=this.l,n=this.l=e+v.bitArray.bitLength(n),9007199254740991<n)throw new v.exception.invalid("Cannot hash more than 2^53 - 1 bits");if(typeof Uint32Array<"u"){var s=new Uint32Array(t),i=0;for(e=512+e-(512+e&511);e<=n;e+=512)ts(this,s.subarray(16*i,16*(i+1))),i+=1;t.splice(0,16*i)}else for(e=512+e-(512+e&511);e<=n;e+=512)ts(this,t.splice(0,16));return this},finalize:function(){var n,t=this.A,e=this.F,t=v.bitArray.concat(t,[v.bitArray.partial(1,1)]);for(n=t.length+2;n&15;n++)t.push(0);for(t.push(Math.floor(this.l/4294967296)),t.push(this.l|0);t.length;)ts(this,t.splice(0,16));return this.reset(),e},Y:[],b:[],O:function(){function n(r){return 4294967296*(r-Math.floor(r))|0}for(var e=0,t=2,s,i;64>e;t++){for(i=!0,s=2;s*s<=t;s++)if(t%s===0){i=!1;break}i&&(8>e&&(this.Y[e]=n(Math.pow(t,.5))),this.b[e]=n(Math.pow(t,1/3)),e++)}}};function ts(n,e){var t,s,i,r=n.F,o=n.b,a=r[0],l=r[1],c=r[2],u=r[3],h=r[4],_=r[5],y=r[6],b=r[7];for(t=0;64>t;t++)16>t?s=e[t]:(s=e[t+1&15],i=e[t+14&15],s=e[t&15]=(s>>>7^s>>>18^s>>>3^s<<25^s<<14)+(i>>>17^i>>>19^i>>>10^i<<15^i<<13)+e[t&15]+e[t+9&15]|0),s=s+b+(h>>>6^h>>>11^h>>>25^h<<26^h<<21^h<<7)+(y^h&(_^y))+o[t],b=y,y=_,_=h,h=u+s|0,u=c,c=l,l=a,a=s+(l&c^u&(l^c))+(l>>>2^l>>>13^l>>>22^l<<30^l<<19^l<<10)|0;r[0]=r[0]+a|0,r[1]=r[1]+l|0,r[2]=r[2]+c|0,r[3]=r[3]+u|0,r[4]=r[4]+h|0,r[5]=r[5]+_|0,r[6]=r[6]+y|0,r[7]=r[7]+b|0}v.mode.ccm={name:"ccm",G:[],listenProgress:function(n){v.mode.ccm.G.push(n)},unListenProgress:function(n){n=v.mode.ccm.G.indexOf(n),-1<n&&v.mode.ccm.G.splice(n,1)},fa:function(n){var e=v.mode.ccm.G.slice(),t;for(t=0;t<e.length;t+=1)e[t](n)},encrypt:function(n,e,t,s,i){var r,o=e.slice(0),a=v.bitArray,l=a.bitLength(t)/8,c=a.bitLength(o)/8;if(i=i||64,s=s||[],7>l)throw new v.exception.invalid("ccm: iv must be at least 7 bytes");for(r=2;4>r&&c>>>8*r;r++);return r<15-l&&(r=15-l),t=a.clamp(t,8*(15-r)),e=v.mode.ccm.V(n,e,t,s,i,r),o=v.mode.ccm.C(n,o,t,e,i,r),a.concat(o.data,o.tag)},decrypt:function(n,e,t,s,i){i=i||64,s=s||[];var r=v.bitArray,o=r.bitLength(t)/8,c=r.bitLength(e),a=r.clamp(e,c-i),l=r.bitSlice(e,c-i),c=(c-i)/8;if(7>o)throw new v.exception.invalid("ccm: iv must be at least 7 bytes");for(e=2;4>e&&c>>>8*e;e++);if(e<15-o&&(e=15-o),t=r.clamp(t,8*(15-e)),a=v.mode.ccm.C(n,a,t,l,i,e),n=v.mode.ccm.V(n,a.data,t,s,i,e),!r.equal(a.tag,n))throw new v.exception.corrupt("ccm: tag doesn't match");return a.data},na:function(n,e,t,s,i,r){var o=[],a=v.bitArray,l=a.i;if(s=[a.partial(8,(e.length?64:0)|s-2<<2|r-1)],s=a.concat(s,t),s[3]|=i,s=n.encrypt(s),e.length)for(t=a.bitLength(e)/8,65279>=t?o=[a.partial(16,t)]:4294967295>=t&&(o=a.concat([a.partial(16,65534)],[t])),o=a.concat(o,e),e=0;e<o.length;e+=4)s=n.encrypt(l(s,o.slice(e,e+4).concat([0,0,0])));return s},V:function(n,e,t,s,i,r){var o=v.bitArray,a=o.i;if(i/=8,i%2||4>i||16<i)throw new v.exception.invalid("ccm: invalid tag length");if(4294967295<s.length||4294967295<e.length)throw new v.exception.bug("ccm: can't deal with 4GiB or more data");for(t=v.mode.ccm.na(n,s,t,i,o.bitLength(e)/8,r),s=0;s<e.length;s+=4)t=n.encrypt(a(t,e.slice(s,s+4).concat([0,0,0])));return o.clamp(t,8*i)},C:function(n,e,t,s,i,r){var o,a=v.bitArray;o=a.i;var l=e.length,c=a.bitLength(e),u=l/50,h=u;if(t=a.concat([a.partial(8,r-1)],t).concat([0,0,0]).slice(0,4),s=a.bitSlice(o(s,n.encrypt(t)),0,i),!l)return{tag:s,data:[]};for(o=0;o<l;o+=4)o>u&&(v.mode.ccm.fa(o/l),u+=h),t[3]++,i=n.encrypt(t),e[o]^=i[0],e[o+1]^=i[1],e[o+2]^=i[2],e[o+3]^=i[3];return{tag:s,data:a.clamp(e,c)}}};v.mode.ocb2={name:"ocb2",encrypt:function(n,e,t,s,i,r){if(v.bitArray.bitLength(t)!==128)throw new v.exception.invalid("ocb iv must be 128 bits");var o,a=v.mode.ocb2.S,l=v.bitArray,c=l.i,u=[0,0,0,0];t=a(n.encrypt(t));var h,_=[];for(s=s||[],i=i||64,o=0;o+4<e.length;o+=4)h=e.slice(o,o+4),u=c(u,h),_=_.concat(c(t,n.encrypt(c(t,h)))),t=a(t);return h=e.slice(o),e=l.bitLength(h),o=n.encrypt(c(t,[0,0,0,e])),h=l.clamp(c(h.concat([0,0,0]),o),e),u=c(u,c(h.concat([0,0,0]),o)),u=n.encrypt(c(u,c(t,a(t)))),s.length&&(u=c(u,r?s:v.mode.ocb2.pmac(n,s))),_.concat(l.concat(h,l.clamp(u,i)))},decrypt:function(n,e,t,s,i,r){if(v.bitArray.bitLength(t)!==128)throw new v.exception.invalid("ocb iv must be 128 bits");i=i||64;var o=v.mode.ocb2.S,a=v.bitArray,l=a.i,c=[0,0,0,0],u=o(n.encrypt(t)),h,_,y=v.bitArray.bitLength(e)-i,b=[];for(s=s||[],t=0;t+4<y/32;t+=4)h=l(u,n.decrypt(l(u,e.slice(t,t+4)))),c=l(c,h),b=b.concat(h),u=o(u);if(_=y-32*t,h=n.encrypt(l(u,[0,0,0,_])),h=l(h,a.clamp(e.slice(t),_).concat([0,0,0])),c=l(c,h),c=n.encrypt(l(c,l(u,o(u)))),s.length&&(c=l(c,r?s:v.mode.ocb2.pmac(n,s))),!a.equal(a.clamp(c,i),a.bitSlice(e,y)))throw new v.exception.corrupt("ocb: tag doesn't match");return b.concat(a.clamp(h,_))},pmac:function(n,e){var t,s=v.mode.ocb2.S,i=v.bitArray,r=i.i,o=[0,0,0,0],a=n.encrypt([0,0,0,0]),a=r(a,s(s(a)));for(t=0;t+4<e.length;t+=4)a=s(a),o=r(o,n.encrypt(r(a,e.slice(t,t+4))));return t=e.slice(t),128>i.bitLength(t)&&(a=r(a,s(a)),t=i.concat(t,[-2147483648,0,0,0])),o=r(o,t),n.encrypt(r(s(r(a,s(a))),o))},S:function(n){return[n[0]<<1^n[1]>>>31,n[1]<<1^n[2]>>>31,n[2]<<1^n[3]>>>31,n[3]<<1^135*(n[0]>>>31)]}};v.mode.gcm={name:"gcm",encrypt:function(n,e,t,s,i){var r=e.slice(0);return e=v.bitArray,s=s||[],n=v.mode.gcm.C(!0,n,r,s,t,i||128),e.concat(n.data,n.tag)},decrypt:function(n,e,t,s,i){var r=e.slice(0),o=v.bitArray,a=o.bitLength(r);if(i=i||128,s=s||[],i<=a?(e=o.bitSlice(r,a-i),r=o.bitSlice(r,0,a-i)):(e=r,r=[]),n=v.mode.gcm.C(!1,n,r,s,t,i),!o.equal(n.tag,e))throw new v.exception.corrupt("gcm: tag doesn't match");return n.data},ka:function(n,e){var t,s,i,r,o,a=v.bitArray.i;for(i=[0,0,0,0],r=e.slice(0),t=0;128>t;t++){for((s=(n[Math.floor(t/32)]&1<<31-t%32)!==0)&&(i=a(i,r)),o=(r[3]&1)!==0,s=3;0<s;s--)r[s]=r[s]>>>1|(r[s-1]&1)<<31;r[0]>>>=1,o&&(r[0]^=-520093696)}return i},j:function(n,e,t){var s,i=t.length;for(e=e.slice(0),s=0;s<i;s+=4)e[0]^=4294967295&t[s],e[1]^=4294967295&t[s+1],e[2]^=4294967295&t[s+2],e[3]^=4294967295&t[s+3],e=v.mode.gcm.ka(e,n);return e},C:function(n,e,t,s,i,r){var o,a,l,c,u,h,_,y,b=v.bitArray;for(h=t.length,_=b.bitLength(t),y=b.bitLength(s),a=b.bitLength(i),o=e.encrypt([0,0,0,0]),a===96?(i=i.slice(0),i=b.concat(i,[1])):(i=v.mode.gcm.j(o,[0,0,0,0],i),i=v.mode.gcm.j(o,i,[0,0,Math.floor(a/4294967296),a&4294967295])),a=v.mode.gcm.j(o,[0,0,0,0],s),u=i.slice(0),s=a.slice(0),n||(s=v.mode.gcm.j(o,a,t)),c=0;c<h;c+=4)u[3]++,l=e.encrypt(u),t[c]^=l[0],t[c+1]^=l[1],t[c+2]^=l[2],t[c+3]^=l[3];return t=b.clamp(t,_),n&&(s=v.mode.gcm.j(o,a,t)),n=[Math.floor(y/4294967296),y&4294967295,Math.floor(_/4294967296),_&4294967295],s=v.mode.gcm.j(o,s,n),l=e.encrypt(i),s[0]^=l[0],s[1]^=l[1],s[2]^=l[2],s[3]^=l[3],{tag:b.bitSlice(s,0,r),data:t}}};v.misc.hmac=function(n,e){this.W=e=e||v.hash.sha256;var t=[[],[]],s,i=e.prototype.blockSize/32;for(this.w=[new e,new e],n.length>i&&(n=e.hash(n)),s=0;s<i;s++)t[0][s]=n[s]^909522486,t[1][s]=n[s]^1549556828;this.w[0].update(t[0]),this.w[1].update(t[1]),this.R=new e(this.w[0])};v.misc.hmac.prototype.encrypt=v.misc.hmac.prototype.mac=function(n){if(this.aa)throw new v.exception.invalid("encrypt on already updated hmac called!");return this.update(n),this.digest(n)};v.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]),this.aa=!1};v.misc.hmac.prototype.update=function(n){this.aa=!0,this.R.update(n)};v.misc.hmac.prototype.digest=function(){var n=this.R.finalize(),n=new this.W(this.w[1]).update(n).finalize();return this.reset(),n};v.misc.pbkdf2=function(n,e,t,s,i){if(t=t||1e4,0>s||0>t)throw new v.exception.invalid("invalid params to pbkdf2");typeof n=="string"&&(n=v.codec.utf8String.toBits(n)),typeof e=="string"&&(e=v.codec.utf8String.toBits(e)),i=i||v.misc.hmac,n=new i(n);var r,o,a,l,c=[],u=v.bitArray;for(l=1;32*c.length<(s||1);l++){for(i=r=n.encrypt(u.concat(e,[l])),o=1;o<t;o++)for(r=n.encrypt(r),a=0;a<r.length;a++)i[a]^=r[a];c=c.concat(i)}return s&&(c=u.clamp(c,s)),c};v.prng=function(n){this.c=[new v.hash.sha256],this.m=[0],this.P=0,this.H={},this.N=0,this.U={},this.Z=this.f=this.o=this.ha=0,this.b=[0,0,0,0,0,0,0,0],this.h=[0,0,0,0],this.L=void 0,this.M=n,this.D=!1,this.K={progress:{},seeded:{}},this.u=this.ga=0,this.I=1,this.J=2,this.ca=65536,this.T=[0,48,64,96,128,192,256,384,512,768,1024],this.da=3e4,this.ba=80};v.prng.prototype={randomWords:function(n,e){var t=[],s;s=this.isReady(e);var i;if(s===this.u)throw new v.exception.notReady("generator isn't seeded");if(s&this.J){s=!(s&this.I),i=[];var r=0,o;for(this.Z=i[0]=new Date().valueOf()+this.da,o=0;16>o;o++)i.push(4294967296*Math.random()|0);for(o=0;o<this.c.length&&(i=i.concat(this.c[o].finalize()),r+=this.m[o],this.m[o]=0,s||!(this.P&1<<o));o++);for(this.P>=1<<this.c.length&&(this.c.push(new v.hash.sha256),this.m.push(0)),this.f-=r,r>this.o&&(this.o=r),this.P++,this.b=v.hash.sha256.hash(this.b.concat(i)),this.L=new v.cipher.aes(this.b),s=0;4>s&&(this.h[s]=this.h[s]+1|0,!this.h[s]);s++);}for(s=0;s<n;s+=4)(s+1)%this.ca===0&&Si(this),i=ss(this),t.push(i[0],i[1],i[2],i[3]);return Si(this),t.slice(0,n)},setDefaultParanoia:function(n,e){if(n===0&&e!=="Setting paranoia=0 will ruin your security; use it only for testing")throw new v.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=n},addEntropy:function(n,e,t){t=t||"user";var s,i,r=new Date().valueOf(),o=this.H[t],a=this.isReady(),l=0;switch(s=this.U[t],s===void 0&&(s=this.U[t]=this.ha++),o===void 0&&(o=this.H[t]=0),this.H[t]=(this.H[t]+1)%this.c.length,typeof n){case"number":e===void 0&&(e=1),this.c[o].update([s,this.N++,1,e,r,1,n|0]);break;case"object":if(t=Object.prototype.toString.call(n),t==="[object Uint32Array]"){for(i=[],t=0;t<n.length;t++)i.push(n[t]);n=i}else for(t!=="[object Array]"&&(l=1),t=0;t<n.length&&!l;t++)typeof n[t]!="number"&&(l=1);if(!l){if(e===void 0)for(t=e=0;t<n.length;t++)for(i=n[t];0<i;)e++,i=i>>>1;this.c[o].update([s,this.N++,2,e,r,n.length].concat(n))}break;case"string":e===void 0&&(e=n.length),this.c[o].update([s,this.N++,3,e,r,n.length]),this.c[o].update(n);break;default:l=1}if(l)throw new v.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[o]+=e,this.f+=e,a===this.u&&(this.isReady()!==this.u&&vi("seeded",Math.max(this.o,this.f)),vi("progress",this.getProgress()))},isReady:function(n){return n=this.T[n!==void 0?n:this.M],this.o&&this.o>=n?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=n?this.J|this.u:this.u},getProgress:function(n){return n=this.T[n||this.M],this.o>=n||this.f>n?1:this.f/n},startCollectors:function(){if(!this.D){if(this.a={loadTimeCollector:Je(this,this.ma),mouseCollector:Je(this,this.oa),keyboardCollector:Je(this,this.la),accelerometerCollector:Je(this,this.ea),touchCollector:Je(this,this.qa)},window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,!1),window.addEventListener("mousemove",this.a.mouseCollector,!1),window.addEventListener("keypress",this.a.keyboardCollector,!1),window.addEventListener("devicemotion",this.a.accelerometerCollector,!1),window.addEventListener("touchmove",this.a.touchCollector,!1);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new v.exception.bug("can't attach event");this.D=!0}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,!1),window.removeEventListener("mousemove",this.a.mouseCollector,!1),window.removeEventListener("keypress",this.a.keyboardCollector,!1),window.removeEventListener("devicemotion",this.a.accelerometerCollector,!1),window.removeEventListener("touchmove",this.a.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=!1)},addEventListener:function(n,e){this.K[n][this.ga++]=e},removeEventListener:function(n,e){var t,s,i=this.K[n],r=[];for(s in i)i.hasOwnProperty(s)&&i[s]===e&&r.push(s);for(t=0;t<r.length;t++)s=r[t],delete i[s]},la:function(){We(this,1)},oa:function(n){var e,t;try{e=n.x||n.clientX||n.offsetX||0,t=n.y||n.clientY||n.offsetY||0}catch{t=e=0}e!=0&&t!=0&&this.addEntropy([e,t],2,"mouse"),We(this,0)},qa:function(n){n=n.touches[0]||n.changedTouches[0],this.addEntropy([n.pageX||n.clientX,n.pageY||n.clientY],1,"touch"),We(this,0)},ma:function(){We(this,2)},ea:function(n){if(n=n.accelerationIncludingGravity.x||n.accelerationIncludingGravity.y||n.accelerationIncludingGravity.z,window.orientation){var e=window.orientation;typeof e=="number"&&this.addEntropy(e,1,"accelerometer")}n&&this.addEntropy(n,2,"accelerometer"),We(this,0)}};function vi(n,e){var t,s=v.random.K[n],i=[];for(t in s)s.hasOwnProperty(t)&&i.push(s[t]);for(t=0;t<i.length;t++)i[t](e)}function We(n,e){typeof window<"u"&&window.performance&&typeof window.performance.now=="function"?n.addEntropy(window.performance.now(),e,"loadtime"):n.addEntropy(new Date().valueOf(),e,"loadtime")}function Si(n){n.b=ss(n).concat(ss(n)),n.L=new v.cipher.aes(n.b)}function ss(n){for(var e=0;4>e&&(n.h[e]=n.h[e]+1|0,!n.h[e]);e++);return n.L.encrypt(n.h)}function Je(n,e){return function(){e.apply(n,arguments)}}v.random=new v.prng(6);e:try{if(kt=typeof module<"u"&&module.exports){try{xt=require("crypto")}catch{xt=null}kt=wt=xt}if(kt&&wt.randomBytes)He=wt.randomBytes(128),He=new Uint32Array(new Uint8Array(He).buffer),v.random.addEntropy(He,1024,"crypto['randomBytes']");else if(typeof window<"u"&&typeof Uint32Array<"u"){if(Ve=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(Ve);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(Ve);else break e;v.random.addEntropy(Ve,1024,"crypto['getRandomValues']")}}catch(n){typeof window<"u"&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(n))}var He,wt,Ve,kt,xt;v.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(n,e,t,s){t=t||{},s=s||{};var i=v.json,r=i.g({iv:v.random.randomWords(4,0)},i.defaults),o;if(i.g(r,t),t=r.adata,typeof r.salt=="string"&&(r.salt=v.codec.base64.toBits(r.salt)),typeof r.iv=="string"&&(r.iv=v.codec.base64.toBits(r.iv)),!v.mode[r.mode]||!v.cipher[r.cipher]||typeof n=="string"&&100>=r.iter||r.ts!==64&&r.ts!==96&&r.ts!==128||r.ks!==128&&r.ks!==192&&r.ks!==256||2>r.iv.length||4<r.iv.length)throw new v.exception.invalid("json encrypt: invalid parameters");return typeof n=="string"?(o=v.misc.cachedPbkdf2(n,r),n=o.key.slice(0,r.ks/32),r.salt=o.salt):v.ecc&&n instanceof v.ecc.elGamal.publicKey&&(o=n.kem(),r.kemtag=o.tag,n=o.key.slice(0,r.ks/32)),typeof e=="string"&&(e=v.codec.utf8String.toBits(e)),typeof t=="string"&&(r.adata=t=v.codec.utf8String.toBits(t)),o=new v.cipher[r.cipher](n),i.g(s,r),s.key=n,r.ct=r.mode==="ccm"&&v.arrayBuffer&&v.arrayBuffer.ccm&&e instanceof ArrayBuffer?v.arrayBuffer.ccm.encrypt(o,e,r.iv,t,r.ts):v.mode[r.mode].encrypt(o,e,r.iv,t,r.ts),r},encrypt:function(n,e,t,s){var i=v.json,r=i.ja.apply(i,arguments);return i.encode(r)},ia:function(n,e,t,s){t=t||{},s=s||{};var i=v.json;e=i.g(i.g(i.g({},i.defaults),e),t,!0);var r,o;if(r=e.adata,typeof e.salt=="string"&&(e.salt=v.codec.base64.toBits(e.salt)),typeof e.iv=="string"&&(e.iv=v.codec.base64.toBits(e.iv)),!v.mode[e.mode]||!v.cipher[e.cipher]||typeof n=="string"&&100>=e.iter||e.ts!==64&&e.ts!==96&&e.ts!==128||e.ks!==128&&e.ks!==192&&e.ks!==256||!e.iv||2>e.iv.length||4<e.iv.length)throw new v.exception.invalid("json decrypt: invalid parameters");return typeof n=="string"?(o=v.misc.cachedPbkdf2(n,e),n=o.key.slice(0,e.ks/32),e.salt=o.salt):v.ecc&&n instanceof v.ecc.elGamal.secretKey&&(n=n.unkem(v.codec.base64.toBits(e.kemtag)).slice(0,e.ks/32)),typeof r=="string"&&(r=v.codec.utf8String.toBits(r)),o=new v.cipher[e.cipher](n),r=e.mode==="ccm"&&v.arrayBuffer&&v.arrayBuffer.ccm&&e.ct instanceof ArrayBuffer?v.arrayBuffer.ccm.decrypt(o,e.ct,e.iv,e.tag,r,e.ts):v.mode[e.mode].decrypt(o,e.ct,e.iv,r,e.ts),i.g(s,e),s.key=n,t.raw===1?r:v.codec.utf8String.fromBits(r)},decrypt:function(n,e,t,s){var i=v.json;return i.ia(n,i.decode(e),t,s)},encode:function(n){var e,t="{",s="";for(e in n)if(n.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new v.exception.invalid("json encode: invalid property name");switch(t+=s+'"'+e+'":',s=",",typeof n[e]){case"number":case"boolean":t+=n[e];break;case"string":t+='"'+escape(n[e])+'"';break;case"object":t+='"'+v.codec.base64.fromBits(n[e],0)+'"';break;default:throw new v.exception.bug("json encode: unsupported type")}}return t+"}"},decode:function(n){if(n=n.replace(/\s/g,""),!n.match(/^\{.*\}$/))throw new v.exception.invalid("json decode: this isn't json!");n=n.replace(/^\{|\}$/g,"").split(/,/);var e={},t,s;for(t=0;t<n.length;t++){if(!(s=n[t].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new v.exception.invalid("json decode: this isn't json!");s[3]!=null?e[s[2]]=parseInt(s[3],10):s[4]!=null?e[s[2]]=s[2].match(/^(ct|adata|salt|iv)$/)?v.codec.base64.toBits(s[4]):unescape(s[4]):s[5]!=null&&(e[s[2]]=s[5]==="true")}return e},g:function(n,e,t){if(n===void 0&&(n={}),e===void 0)return n;for(var s in e)if(e.hasOwnProperty(s)){if(t&&n[s]!==void 0&&n[s]!==e[s])throw new v.exception.invalid("required parameter overridden");n[s]=e[s]}return n},sa:function(n,e){var t={},s;for(s in n)n.hasOwnProperty(s)&&n[s]!==e[s]&&(t[s]=n[s]);return t},ra:function(n,e){var t={},s;for(s=0;s<e.length;s++)n[e[s]]!==void 0&&(t[e[s]]=n[e[s]]);return t}};v.encrypt=v.json.encrypt;v.decrypt=v.json.decrypt;v.misc.pa={};v.misc.cachedPbkdf2=function(n,e){var t=v.misc.pa,s;return e=e||{},s=e.iter||1e3,t=t[n]=t[n]||{},s=t[s]=t[s]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):v.random.randomWords(2,0)},t=e.salt===void 0?s.firstSalt:e.salt,s[t]=s[t]||v.misc.pbkdf2(n,t,e.iter),{key:s[t].slice(0),salt:t.slice(0)}};var ie=v;var is=class extends(void 0){name="e2ee";keys;securedKeys=!1;encryptedkeys;secret;constructor(e,t,s,i){super(e),t&&(s&&i?(this.securedKeys=!0,this.encryptedkeys=ie.encrypt(i,JSON.stringify(t)).cipher,this.secret=i):Object.assign(this.keys,t)),this.load(this)}addKey=(e,t)=>{if(t||(t=`key${Math.floor(Math.random()*1e15)}`),this.securedKeys&&this.secret&&this.encryptedkeys){let s=JSON.parse(ie.decrypt(this.secret,this.encryptedkeys));return s[t]={key:e,_id:t},this.encryptedkeys=ie.encrypt(this.secret,s).cipher,this.encryptedkeys}else this.keys[t]={key:e,_id:t};return this.keys[t]};static generateSecret(){return ie.codec.base64.fromBits(ie.random.randomWords(8,10))}encrypt(e,t){return e=ie.encrypt(t,e).cipher,e}decrypt(e,t){return e=ie.decrypt(t,e),e}encryptRoute=(e,t)=>{typeof e=="object"&&(e=JSON.stringify(e));let s;if(this.securedKeys&&this.secret&&this.encryptedkeys){let i=JSON.parse(ie.decrypt(this.secret,this.encryptedkeys));i[t]?.key&&(e=ie.encrypt(this.secret,i[t].key).cipher)}else this.keys[t]&&(s||(s=t),e=this.encrypt(e,s));return e={route:"decryptRoute",args:[e,t]},e};decryptRoute=(e,t)=>{let s=e;if(typeof e=="object"){if(t||typeof e.keyId=="string"&&(t=e.keyId),t){let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(ie.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=ie.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e.args,i))}}else{let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(ie.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=ie.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e,i))}return s};transmit=(e,t)=>(t||(t=Object.keys(this.keys)[0]),e=this.encryptRoute(e,t),this.handleServiceMessage(e));receive=(e,t)=>{if(t||(t=Object.keys(this.keys)[0]),e=this.decryptRoute(e,t),typeof e=="string"){let s=e.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(e=e.replace(/\\/g,"")),e[0]==='"'&&(e=e.substring(1,e.length-1)),e=JSON.parse(e))}if(typeof e=="object"){if(typeof e.method=="string")return this.handleMethod(e.route,e.method,e.args);if(typeof e.route=="string")return this.handleServiceMessage(e);if(typeof e.node=="string"||e.node instanceof void 0)return this.handleGraphNodeCall(e.node,e.args);this.__node.keepState&&(e.route&&this.setState({[e.route]:e.args}),e.node&&this.setState({[e.node]:e.args}))}else return e}};var At=ce(require("http")),Pt=ce(require("https")),te=ce(require("fs")),fe=ce(require("path"));function Yr(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=t}):e+=n,e+="</body></html>",e}function Kr(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=`<script src="${t}"></script>`}):e+=`<script src="${n}"></script>`,e+="</body></html>",e}var rs=function(n=4/24){return`//https://github.com/ibrahima92/pwa-with-vanilla-js

//https://github.com/ibrahima92/pwa-with-vanilla-js
let cacheName = 'pwa-assets';
const assets = [
  "/",
  "/index.html",
  "/dist/index.css", //alt default paths
  "/dist/index.js",
  '/favicon.ico'
];

let cacheExpiration = 1000 * 60 * //seconds 
  60 * //minutes
  24 * //hours
  ${n};    //days

let isValid = function (response) {
	if (!response) return false;
	var fetched = response.headers.get('sw-fetched-on');
	if (fetched && (!navigator.onLine || (parseFloat(fetched) + (cacheExpiration)) > new Date().getTime())) 
      return true;
	return false;
};

self.addEventListener("install", installEvent => {
  installEvent.waitUntil(
    caches.open(cacheName).then(cache => {
      cache.addAll(assets);
    })
  );
});

self.addEventListener("fetch", fetchEvent => { //https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/
  fetchEvent.respondWith(
    caches.match(fetchEvent.request).then(function (response) {

        // If there's a cached API and it's still valid, use it
        if (isValid(response)) {
            return response;
        }

        // Otherwise, make a fresh API call
        if(response && !assets.includes(fetchEvent.request.url)) return response;
        // Otherwise, make a fresh API call
        else return fetch(fetchEvent.request).then(function (response) {

            // Cache for offline access
            if(assets.includes(fetchEvent.request.url)){
              var copy = response.clone();
              fetchEvent.waitUntil(caches.open(cacheName).then(function (cache) {
                var headers = new Headers(copy.headers);
                headers.append('sw-fetched-on', new Date().getTime());
                return copy.blob().then(function (body) {
                  return cache.put(fetchEvent.request, new Response(body, {
                    status: copy.status ? copy.status : 200,
                    statusText: copy.statusText,
                    headers: headers
                  }));
                });
              }));
            }
            
            // Return the requested file
            return response;

        })
        // .catch(function (error) {
        // 	return caches.match(request).then(function (response) { //fallback to offline cache
        // 		return response || caches.match('/offline.json'); //todo: figure out what is supposed to go in offline.json (https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/)
        // 	});
        // });  
  }));
});

`},ns=(n="PWA")=>`{
    "short_name": "${n}",
    "name": "${n}",
    "start_url": "/",
    "display": "standalone",
    "theme_color": "#000000",
    "background_color": "#ffffff",
    "description": "${n} Test",
    "lang": "en-US",
    "permissions": [
        "storage"
    ],
    "icons":[{
        "src": "./assets/logo196.png",
        "sizes": "196x196"
    },
    {
        "src": "./assets/logo512.png",
        "sizes": "512x512"
    }]
}`;var os=class extends ee{name="http";server;debug=!1;servers={};mimeTypes={".html":"text/html",".htm":"text/html",".js":"text/javascript",".css":"text/css",".json":"application/json",".txt":"text/plain",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpg",".gif":"image/gif",".svg":"image/svg+xml",".xhtml":"application/xhtml+xml",".bmp":"image/bmp",".wav":"audio/wav",".mp3":"audio/mpeg",".mp4":"video/mp4",".xml":"application/xml",".webm":"video/webm",".webp":"image/webp",".weba":"audio/webm",".woff":"font/woff",woff2:"font/woff2",".ttf":"application/font-ttf",".eot":"application/vnd.ms-fontobject",".otf":"application/font-otf",".wasm":"application/wasm",".zip":"application/zip",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".tif":"image/tiff",".sh":"application/x-sh",".csh":"application/x-csh",".rar":"application/vnd.rar",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".odt":"application/vnd.oasis.opendocument.text",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odp":"application/vnd.oasis.opendocument.presentation",".mpeg":"video/mpeg",".mjs":"text/javascript",".cjs":"text/javascript",".jsonld":"application/ld+json",".jar":"application/java-archive",".ico":"image/vnd.microsoft.icon",".gz":"application/gzip",epub:"application/epub+zip",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".csv":"text/csv",".avi":"video/x-msvideo",".aac":"audio/aac",".mpkg":"application/vnd.apple.installer+xml",".oga":"audio/ogg",".ogv":"video/ogg",ogx:"application/ogg",".php":"application/x-httpd-php",".rtf":"application/rtf",".swf":"application/x-shockwave-flash",".7z":"application/x-7z-compressed",".3gp":"video/3gpp"};constructor(e,t){super(e),this.load(this),t&&this.setupServer(t)}onStarted=(e,t,s)=>{console.log(`\u{1F431} Node server running at 
            ${e}://${t}:${s}/`)};setupServer=(e={protocol:"http",host:"localhost",port:8080,startpage:"index.html"},t,s)=>{if(e.pages){for(let i in e.pages)if(typeof e.pages[i]=="string")this.addPage(`${e.port}/${i}`,e.pages[i]);else if(typeof e.pages[i]=="object"||typeof e.pages[i]=="function"){e.pages[i].template&&(e.pages[i].get=e.pages[i].template);let r=`${e.port}/${i}`;i!=="_all"&&this.load({[r]:e.pages[i]})}}this.setupHTTPserver(e,t,s)};open=this.setupServer;setupHTTPserver=(e={host:"localhost",port:8080,startpage:"index.html",errpage:void 0},t,s=()=>{this.onStarted("http",e.host,e.port)})=>{let i=e.host?e.host:"localhost",r=e.port?e.port:8e3;if(!i||!r)return;let o=`${i}:${r}`;this.servers[o]&&this.terminate(this.servers[o]),"keepState"in e||(e.keepState=!0);let a={server:void 0,type:"httpserver",address:o,...e};t||(t=(c,u)=>{let h={args:{request:c,response:u},method:c.method,served:a},_=c.url.slice(1);if(_||(_="/"),e.debug){let y=Ot(new Date);console.log(y," | ","From: ",c.socket?.remoteAddress,"For: ",c.url," | ",c.method)}e.pages?Zr.call(this,_,h,e.pages,c,u,e.port):h.route=_,this.receive(h)});let l;if(e.protocol==="http")l=At.createServer(t);else{let c;e.keypath&&e.certpath?(c={key:te.readFileSync(e.keypath),cert:te.readFileSync(e.certpath),passphrase:e.passphrase},l=Pt.createServer(c,t)):console.error("Error, key and/or cert .pem SSL files not provided. See OpenSSL certbot for more info on how to create free SSL certifications, or create your own self-signed one for local development.")}if(!l){console.error("Server not successfully created.");return}return a.server=l,a.terminate=()=>{this.terminate(a)},a.service=this,this.servers[o]=a,a._id=e._id?e._id:o,new Promise((c,u)=>{let h;l.on("error",_=>{a.onerror?a.onerror(_,a):console.error("Server error:",_.toString()),h||u(_)}),l.on("clientError",(_,y)=>{a.onerror?a.onerror(_,a):console.error(Ot(new Date)," | Server clientError:",_.toString()," | From: ",y.remoteAddress),y&&y.destroy()}),l.on("tlsClientError",(_,y)=>{a.onerror?a.onerror(_,a):console.error(Ot(new Date)," | Server tlsClientError: ",_.toString()," | From: ",y.remoteAddress),y&&y.destroy()}),l.on("upgrade",(_,y,b)=>{a.onupgrade&&a.onupgrade(_,y,b,a)}),l.listen(r,i,()=>{s(),a.onopen&&a.onopen(a),h=!0,c(a)})})};transmit=(e,t,s,i)=>{let r=e;if(typeof r=="object"&&!r.byteLength&&(r=JSON.stringify(r)),typeof t=="string"&&e)return this.POST(t,e);if(typeof t=="string")return this.GET(t);if(t)t.headers||(t.headers={"Content-Type":"application/json","Content-Length":r.length});else{let o=this.servers[Object.keys(this.servers)[0]];t={protocol:o.protocol,host:o.host,port:o.port,method:"POST",path:e.route,headers:{"Content-Type":"application/json","Content-Length":r.length}}}return this.request(t,r,s,i)};withResult=(e,t,s)=>{if(t&&!e.writableEnded&&!e.destroyed){let i="text/plain",r={};if(typeof t=="string"){let o=fe.extname(t);if(o&&te.existsSync(fe.join(process.cwd(),t))){if(i=this.mimeTypes[o]||"application/octet-stream",t=te.readFileSync(fe.join(process.cwd(),t)),i==="text/html"&&(s.served?.pages?._all||s.served?.pages?.[s.route])){let{templateString:a,headers:l}=this.injectPageCode(t.toString(),s.route,s.served);t=a,Object.assign(r,l)}}else if(typeof t=="string"&&t.includes("<")&&t.includes(">")&&t.indexOf("<")<t.indexOf(">")){if(r["Content-Type"]="text/html",s?.served?.pages?._all||s?.served?.pages?.[s.route]){let{templateString:a,headers:l}=this.injectPageCode(t,s.route,s.served);t=a,Object.assign(r,l)}e.writeHead(200,r),e.end(t,"utf-8");return}}else typeof t=="object"&&(t=JSON.stringify(t),i="application/json");r["Content-Type"]=i,e.writeHead(200,r),e.end(t,"utf-8")}else try{e.destroy()}catch{}};injectPageCode=(e,t,s)=>{s?.pages?.[t]?.inject&&(typeof s.pages[t].inject=="object"?e=this.buildPage(s.pages[t].inject,e):typeof s.pages[t].inject=="function"?e+=s.pages[t].inject():(typeof s.pages[t].inject=="string"||typeof s.pages[t].inject=="number")&&(e+=s.pages[t].inject)),s?.pages?._all?.inject&&(typeof s.pages._all.inject=="object"?e=this.buildPage(s.pages._all.inject,e):typeof s.pages._all.inject=="function"?e+=s.pages._all.inject():(typeof s.pages._all.inject=="string"||typeof s.pages._all.inject=="number")&&(e+=s.pages._all.inject));let i={};return s.pages._all?.headers&&Object.assign(i,s.pages._all.headers),s.pages[t]?.headers&&Object.assign(i,s.pages[t].headers),{templateString:e,headers:i}};receive=e=>(this.debug&&console.log(e.args.request.method,e.args.request.url),new Promise((s,i)=>{this.responsePromiseHandler(s,i,e,e.args.request,e.args.response,e.method,e.served)}).catch(s=>{console.error("Request Error:",s)}));responseOnErrorPromiseHandler=(e,t,s)=>{if(!e.writableEnded||!e.destroyed)e.statusCode=400,e.end(void 0,void 0),t(s);else{try{e.destroy()}catch{}t(s)}};getFailedPromiseHandler=(e,t,s,i,r,o)=>{if((r.writableEnded||r.destroyed)&&t(s),s=="./"||s==o?.startpage){let a="<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Brains@Play Server</h1></body></html>";if(o?.pages?._all||o?.pages?.error){let{templateString:l,headers:c}=this.injectPageCode(a,i.route,o);a=l}r.writeHead(200,{"Content-Type":"text/html"}),r.end(a,"utf-8"),e(a),o?.keepState&&this.setState({[o.address]:a});return}else this.debug&&console.log(`File ${s} does not exist on path!`);r.writeHead(500),r.end(void 0,void 0),t(s)};handleBufferedPostBodyPromiseHandler=(e,t,s,i,r)=>{if(t=Buffer.concat(t).toString(),typeof t=="string"){let u=t.substring(0,8);(u.includes("{")||u.includes("["))&&(u.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}let o,a,l;if(t?.route&&(o=t.route,a=t.method,l=t.args,o||(typeof t.route=="string"&&t.route.includes("/")&&t.route.length>1&&(t.route=t.route.split("/").pop()),o=t.route)),!o&&s?.route){let u=s.route;a=s.method,l=s.args,u||(typeof s.route=="string"&&s.route.includes("/")&&s.route.length>1&&(s.route=s.route.split("/").pop()),u=s.route)}let c=t;if(o)if(this.restrict?.[o]){try{i.destroy()}catch{}e(c)}else t.method?c=this.handleMethod(o,a,l):t.node?c=this.handleGraphNodeCall(t.node,t.args):c=this.handleServiceMessage({route:o,args:l,method:a}),c instanceof Promise?c.then(u=>{this.withResult(i,u,s),r?.keepState&&this.setState({[r.address]:c}),e(c)}):(this.withResult(i,c,s),r?.keepState&&this.setState({[r.address]:c}),e(c));else if(!i.writableEnded||!i.destroyed)i.statusCode=200,i.end(void 0,void 0),e(c);else{try{i.destroy()}catch{}e(c)}};onRequestFileReadPromiseHandler=(e,t,s,i,r,o,a,l)=>{if(e)if(e.code=="ENOENT")if(l?.errpage)te.readFile(l.errpage,(h,_)=>{if(o.writeHead(404,{"Content-Type":"text/html"}),l.pages?._all||l.pages?.error){let{templateString:y,headers:b}=this.injectPageCode(_.toString(),a.route,l);_=y}o.end(_,"utf-8"),i(_)});else{o.writeHead(404,{"Content-Type":"text/html"});let h=`<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Error: ${e.code}</h1></body></html>`;if(l?.pages?._all||l?.pages?.[a.route]){let{templateString:_,headers:y}=this.injectPageCode(h.toString(),a.route,l);h=_}o.end(h,"utf-8"),i(e.code)}else o.writeHead(500),o.end("Something went wrong: "+e.code+` ..
`,"utf-8"),i(e.code);else{var c=String(fe.extname(r)).toLowerCase(),u=this.mimeTypes[c]||"application/octet-stream";let h={"Content-Type":u};if(u==="text/html"&&(l?.pages?._all||l?.pages?.[a.route])){let{templateString:_,headers:y}=this.injectPageCode(t.toString(),a.route,l);Object.assign(h,y),t=_}o.writeHead(200,h),o.end(t,"utf-8"),s(t)}};responsePromiseHandler=(e,t,s,i,r,o,a)=>{if(r.on("error",c=>{if(a.debug){let u=Ot(new Date);console.error(u,"| Response Error: ",c," From: ",i.socket?.remoteAddress," For: ",i.url," | ",i.method)}this.responseOnErrorPromiseHandler(r,t,c),i.destroy(),i.socket?.destroy()}),o==="GET"||o==="get"){var l="."+i.url;if(i.url&&this.restrict?.[i.url]&&t(i.url),l=="./"&&a?.startpage&&(l=a.startpage),l.includes("?")&&(l=l.substring(0,l.indexOf("?"))),(i.url!=="/"||a?.startpage)&&te.existsSync(fe.join(process.cwd(),l)))r.writableEnded||r.destroyed?t(l):te.readFile(fe.join(process.cwd(),l),(c,u)=>{this.onRequestFileReadPromiseHandler(c,u,e,t,l,r,s,a)});else if(s.route){let c;if(a){let u=`${a.port}/${s.route}`;this.__node.nodes.get(u)&&(c=u)}if(!c&&this.__node.nodes.get(s.route)&&(c=s.route),c){let u;s.method?u=this.handleMethod(c,s.method,void 0):s.node?u=this.handleGraphNodeCall(s.node,void 0):u=this.handleServiceMessage({route:c,args:void 0,method:s.method}),u instanceof Promise?u.then(h=>{a?.keepState&&this.setState({[a.address]:u}),this.withResult(r,h,s),e(u)}):u&&(a?.keepState&&this.setState({[a.address]:u}),this.withResult(r,u,s),e(u))}else s.redirect?(r.writeHead(301,{Location:s.redirect}),r.end(),e(!0)):this.getFailedPromiseHandler(e,t,l,s,r,a)}else this.getFailedPromiseHandler(e,t,l,s,r,a)}else{let c,u=!0,h;i.on("data",_=>{c||(c=[]),c.push(_),u&&(u=!1,h&&clearTimeout(h))}).on("end",()=>{this.handleBufferedPostBodyPromiseHandler(e,c,s,r,a)}),h=setTimeout(()=>{if(u){let _=new Error(`Request timed out from | ${i.socket?.remoteAddress} | For: ${i.url} | ${i.method}`);i.destroy(_),a.server.emit("clientError",_,i.socket),a.debug&&console.error(_),t(_)}},a.timeout?a.timeout:1e3)}};request=(e,t,s,i)=>{let r=At;e.protocol?.includes("https")&&(r=Pt),delete e.protocol;let o=r.request(e,a=>{s&&a.on("data",s),i&&a.on("end",i)});if(e.headers)for(let a in e.headers)o.setHeader(a,e.headers[a]);return t&&o.write(t),o.end(),o};POST=(e,t,s)=>{let i=e;i instanceof URL&&(i=e.toString());let r=i.startsWith("https")?"https":"http",o,a,l,c=i.split("/");return c.forEach(h=>{if(h.includes(":")){let _=h.split(":");o=_[0],a=_[1]}}),c.length>3&&(l=c.slice(3).join("/")),this.request({protocol:r,host:o,port:a,path:l,method:"POST",headers:s},t)};GET=e=>new Promise((t,s)=>{let i=At,r=e;e instanceof URL&&(r=e.toString()),r.includes("https")&&(i=Pt),i.get(e,o=>{let a=[];o.on("data",l=>{a.push(l)}),o.on("end",()=>{t(Buffer.concat(a))})}).on("error",o=>{s(o)})});terminate=e=>{typeof e=="string"&&(e=this.servers[e]),typeof e=="object"&&(e.server.close(),e.onclose&&e.onclose(e))};getRequestBody(e){let t=[];return new Promise((s,i)=>{e.on("data",r=>{t.push(r)}).on("end",()=>{s(Buffer.concat(t))}).on("error",r=>{let o=new Error(`Request timed out from | ${e.socket?.remoteAddress} | For: ${e.url} | ${e.method}`);e.destroy(o),i(o)})})}addPage=(e,t)=>{typeof t=="string"&&(t.includes("<html")||(t="<!DOCTYPE html><html>"+t+"</html>")),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};addHTML=(e,t)=>{typeof t=="string"&&(!t.includes("<")||!t.includes(">"))&&(t="<div>"+t+"</div>"),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};buildPage=(e,t)=>{let s="";t&&(s+=t);let i=(r,o,a)=>{if(!Array.isArray(r[o])&&typeof r[o]=="object")for(let l in r)i(r,l,a);else if(this.__node.nodes.get(o)?.get){let l=this.__node.nodes.get(o)?.get;if(typeof l=="function"&&(Array.isArray(r[o])?l=l(...r[o]):l=l(r[o])),typeof l=="string"){let c=a.lastIndexOf("<");if(c>0){let u=a.substring(c);a=a.substring(0,c)+l+u}else a+=l}}else if(this.__node.nodes.get(o)?.__operator){let l;if(this.__node.nodes.get(o)?.__operator&&(l=this.__node.nodes.get(o).__operator(r[o])),typeof l=="string"){let c=a.lastIndexOf("<");if(c>0){let u=a.substring(c);a=a.substring(0,c)+l+u}else a+=l}}else typeof this.__node.nodes.get(o)=="string"&&(a+=this.__node.nodes.get(o));return a};if(Array.isArray(e))e.forEach(r=>{s=i(e,r,s)});else if(typeof e=="object")for(let r in e)s=i(e,r,s);else typeof e=="string"?s+=e:typeof e=="function"&&(s+=e());return s};hotreload=(e="http://localhost:8080/wss",t)=>{e instanceof URL&&(e=e.toString());let s=(i,r)=>{let o=new WebSocket(i);function a(c){let u=c.includes("/")?c.split("/"):c.split("\\"),h=u[u.length-1];var _=document.getElementsByTagName("link");for(var y in _){var b=_[y];if(!c||b.href?.includes(h)){let x=b.getAttribute("href").split("?")[0],R=x+="";b.setAttribute("href",R)}}}function l(c,u,h){let _=c.includes("/")?c.split("/"):c.split("\\"),y=_[_.length-1],b=document.querySelectorAll("[src]"),x=!1;for(let R of b)if(R.src.includes(y))if(R.tagName==="SCRIPT"&&!u){window.location.reload();return}else{let j=document.createElement("object");R.insertAdjacentElement("afterend",j),R.remove();let z=R.cloneNode(!0);j.insertAdjacentElement("beforebegin",z),j.remove(),x=!0}x||window.location.reload()}o.addEventListener("message",c=>{let u=c.data;if(typeof u=="string"&&u.startsWith("{")&&(u=JSON.parse(u)),u.file){let h=u.file,_=u.reloadscripts;h.endsWith("html")||h.endsWith("xml")||h.endsWith("wasm")?window.location.reload():h.endsWith("css")?(r.endsWith("css")||(r+=".css"),a(r)):h.endsWith("js")||h.endsWith("ts")||h.endsWith("jsx")||h.endsWith("tsx")||h.endsWith("vue")?l(h,_):(a(h),l(h))}}),o.addEventListener("close",()=>{let h=Math.round(30),_=0,y=()=>{if(_++,_>h){console.error("Could not reconnect to dev server.");return}o=new WebSocket(i),o.onerror=b=>{console.error(`Hot reload port disconnected, will reload on reconnected. Attempt ${_} of ${h}`)},o.addEventListener("error",()=>{setTimeout(y,100)}),o.addEventListener("open",()=>{location.reload()})};y()})};return`
            <script>
                console.log('Hot Reload port available at ${e}');  
                (`+s.toString()+`)('${e}',${t?`'${t}'`:void 0}); 
            </script>
        `};pwa=(e="PWA",t=4/24,s="service-worker.js")=>{te.existsSync(s)||te.writeFileSync(fe.join(process.cwd(),s),rs(t)),te.existsSync("manifest.webmanifest")||te.writeFileSync(fe.join(process.cwd(),"/manifest.webmanifest"),ns(e));function i(r){Array.from(document.head.querySelectorAll("link")).find(l=>{if(l.href.includes("manifest"))return!0})||document.head.insertAdjacentHTML("beforeend",'<link rel="manifest" href="./manifest.webmanifest">');let o=!!(window.location.hostname==="localhost"||window.location.hostname==="[::1]"||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function a(){navigator.serviceWorker.register(r).then(l=>{l.onupdatefound=()=>{let c=l.installing;c!=null&&(c.onstatechange=()=>{c.state==="installed"&&(navigator.serviceWorker.controller?console.log("New content is available and will be used when all tabs for this page are closed."):console.log("Content is cached for offline use."))})}}).catch(l=>{console.error("Error during service worker registration:",l)})}"serviceWorker"in navigator&&addEventListener("load",()=>{o?(fetch(r).then(l=>{let c=l.headers.get("content-type");l.status===404||c!=null&&c.indexOf("javascript")===-1?navigator.serviceWorker.ready.then(u=>{u.unregister().then(()=>{window.location.reload()})}):a()}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")}),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker.")})):a()})}return`
            <script>
                (`+i.toString()+`)('${s}'); 
            </script>
        `}};function Zr(n,e,t,s,i,r){let o=t[n],a=n;if(o)e.route=n,s.url=n;else{let l="/"+n;if(o=t[l],a=l,!o&&!fe.extname(n))if(a=n.split("/")[0]+"/*",t[a])o=t[a],e.route=a,s.url=a;else{let u=l.split("/");u[u.length-1]="",a=u.join("/")+"*",t[a]&&(o=t[a],e.route=a,s.url=a)}else e.route=l,s.url=l}return typeof o=="object"&&(o.redirect&&(n=o.redirect,e.redirect=n,e.route=n),o.onrequest&&(typeof o.onrequest=="string"&&(o.onrequest=this.__node.nodes.get(o.onrequest)),typeof o.onrequest=="object"?o.onrequest.__operator&&o.onrequest.__operator(o,s,i):typeof o.onrequest=="function"&&o.onrequest(this,this.__node.nodes.get(`${r}/${a}`),s,i))),o}function Ot(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var Et=ce(xi()),ls=class extends ee{name="sse";debug=!1;servers={};eventsources={};connections={servers:this.servers,eventsources:this.eventsources};constructor(e){super(e),this.load(this)}openSSE=e=>{let t=e.server,s=e.path;if(this.servers[s])return!1;let i=(0,Et.createChannel)(),r={type:"sse",channel:i,sessions:{},requests:{},...e};this.servers[s]=r,r._id=e._id?e._id:s;let o=(j,z,E)=>this.transmit(j,s,z,E),a=()=>this.terminate(s),l=(j,z,E,I)=>{if(!E){let P=[];for(let O in r.sessions)P.push(this.request(j,s,O,I));return P}return this.request(j,s,z,E,I)},c=(j,z,E,I,P)=>{let O={route:j,args:z};return E&&(O.method=E),this.transmit(O,s,P,I)},u=(j,z,E,I,P)=>{let O={route:j,args:z};if(!I){let D=[];for(let F in r.sessions)D.push(this.request(O,s,F,P));return D}return this.request(O,s,E,I,P)},h=(j,z,E,I,P,O,D)=>this.subscribeToSSE(j,e.url,z,E,I,P,O,D),_=(j,z,E,I)=>u("unsubscribe",[j,z],void 0,E,I);r.send=o,r.request=l,r.post=c,r.run=u,r.subscribe=h,r.unsubscribe=_,r.terminate=a,r.graph=this;let y=(j,z)=>{if(j.url?.includes(s))if(j.method==="GET")this.debug&&console.log("SSE Request",s),(0,Et.createSession)(j,z).then(E=>{i.register(E);let I=`sse${Math.floor(Math.random()*1e15)}`;r.sessions[I]=E,this.eventsources[I]={_id:I,session:E,served:r,send:(P,O)=>o(P,O,I),request:(P,O,D)=>l(P,O,I,D),post:(P,O,D,F)=>c(P,O,D,I,F),run:(P,O,D,F)=>u(P,O,D,I,F),subscribe:(P,O)=>h(P,O,void 0,I),unsubscribe:(P,O,D)=>_(P,O,I,D),terminate:()=>(delete this.eventsources[I],delete r.sessions[I],!0),onclose:(P,O,D,F,q)=>{O.onconnectionclose&&O.onconnectionclose(P,O,D,F,q)},graph:this},E.push(JSON.stringify({route:"setId",args:I})),E.on("close",()=>{let P=this.eventsources[I],O=P.onclose;delete this.eventsources[I],O&&P.onclose(E,r,I,j,z)}),r.onconnection&&r.onconnection(E,r,I,j,z)});else{let E=[];j.on("data",I=>{E.push(I)}).on("end",()=>{if(E=Buffer.concat(E).toString(),typeof E=="string"){let F=E.substring(0,8);(F.includes("{")||F.includes("["))&&(F.includes("\\")&&(E=E.replace(/\\/g,"")),E[0]==='"'&&(E=E.substring(1,E.length-1)),E=JSON.parse(E))}let I,P,O,D;if((E?.route||E?.callbackId)&&(P=E.method,O=E.args,D=E.callbackId,typeof E.route=="string"&&(E.route.includes("/")&&E.route.length>1&&(E.route=E.route.split("/").pop()),I=this.__node.roots?.[E.route])),I){let F=this.receive({route:I,args:O,method:P})}else D&&r.requests[D]&&r.requests[D](O);this.__node.keepState&&this.setState({[s]:E})})}},b=t.listeners("request");t.removeAllListeners("request");let x=(j,z)=>{b.forEach(E=>{E(j,z)})},R=(j,z)=>{j.url&&(j.url.indexOf(s)>-1?(this.servers[s]||(t.removeListener("request",R),t.addListener("request",x)),y(j,z)):x(j,z))};return t.addListener("request",R),t.addListener("close",()=>{r.onclose&&r.onclose(r)}),r};open=this.openSSE;streamIterable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].iterate(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].iterate(t));return o}};streamReadable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].stream(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].stream(t));return o}};transmit=(e,t,s,i)=>{if(!t&&(typeof e=="object"&&!e.byteLength||typeof e=="number")){if(e?.route){let r=Object.keys(this.servers);if(r.length>0){let o=this.servers[r[0]];o.channels?.includes(e.route)&&(t=o.path,s=e.route)}!t&&e.route&&this.servers[e.route]&&(t=e.route)}e=JSON.stringify(e)}if(t||(t=Object.keys(this.servers)[0]),t&&this.servers[t]){if(i){if(this.servers[t].sessions[i]?.isConnected)this.servers[t].sessions[i].push(e,s);else if(this.servers[t].sessions[i])return delete this.servers[t].sessions[i],!1}else this.servers[t].channel.broadcast(e,s);return!0}return!1};request=(e,t,s,i,r)=>new Promise((o,a)=>{let l=`${Math.random()}`,c={route:"runRequest",args:[e,t,l,i]};s&&(c.method=s);let u=this.servers[t],h=_=>{o(_)};u.requests[l]=h,u&&(i?u.sessions[i]&&u.sessions[i].push(JSON.stringify(c),r):u.channel.broadcast(JSON.stringify(c),r))});runRequest=(e,t,s,i)=>{let r=this.receive(e);if(t){let o=this.servers[t];o&&(r instanceof Promise?r.then(a=>{i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:a,callbackId:s})):o.channel.broadcast(JSON.stringify({args:a,callbackId:s}))}):i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:r,callbackId:s})):o.channel.broadcast(JSON.stringify({args:r,callbackId:s})))}return r};subscribeSSE=(e,t,s,i,r,o,a)=>{if(!this.restrict?.[e]&&this.servers[t])return this.subscribe(e,l=>{this.servers[t].send({args:l,callbackId:e},a,o)},s,i,r)};subscribeToSSE=(e,t,s,i,r,o,a,l)=>{if(this.servers[t])if(this.__node.state.subscribeEvent(t,c=>{c?.callbackId===e&&(s?typeof s=="string"?this.run(s,c.args):s(c.args):this.setState({[t]:c.args}))}),a){if(this.servers[t].sessions[a])return this.eventsources[a].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l)}else{let c=[];for(let u in this.servers[t].sessions)c.push(this.eventsources[u].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l));return c}};terminate=e=>(typeof e=="object"?delete this.servers[e.path]:typeof e=="string"&&(delete this.servers[e],delete this.eventsources[e]),!0)};var lo=ce(Ti(),1),co=ce(bs(),1),fo=ce(Ss(),1),Ar=ce(Ts(),1),nt=ce(Or(),1);var ke=Ar.default;var Cs=class extends ee{name="wss";debug=!1;servers={};sockets={};connections={servers:this.servers,sockets:this.sockets};constructor(e){super(e),this.load(this)}open=e=>e?.server?this.setupWSS(e):this.openWS(e);setupWSS=e=>{let t=e.port,s=e.path,i=typeof e.server=="object"?e.server:void 0,r=e.host;delete e.server,"keepState"in e||(e.keepState=!0);let o={};e.noServer?o.noServer=!0:t?t&&(o.port=t):i&&(o.server=i),e.perMessageDeflate&&(o.perMessageDeflate=e.perMessageDeflate),e.serverOptions,Object.assign(o,e.serverOptions);let a=new nt.default(o),l="";if(!r&&i){let j=i.address();t||(t=j.port),l=j.address}else r&&(l=r);t&&(l+=":"+t),s&&(s.startsWith("/")||(s="/"+s),l+=s),this.servers[l]={type:"wss",wss:a,clients:{},address:l,...e},a.addListener("connection",(j,z)=>{this.debug&&console.log(`New socket connection on ${l}`);let E=`socket${Math.floor(Math.random()*1e12)}`;if(this.servers[l].clients[E]=j,j.send(JSON.stringify({route:"setId",args:E})),this.openWS({socket:j,address:E,_id:E,debug:e.debug,onclose:(I,P)=>{this.servers[l].onconnectionclosed&&this.servers[l].onconnectionclosed(I,P,j,this.servers[l],E),delete this.servers[l].clients[E]},onmessage:e.onmessage}),e.debug){let I=ho(new Date);console.log(I," | ",E," | Number of live sockets: ",Object.keys(this.servers[l].clients).length)}this.servers[l].onconnection&&this.servers[l].onconnection(j,z,this.servers[l],E)}),a.on("error",j=>{this.debug&&console.log("Socket Error:",j),this.servers[l]?.onerror?this.servers[l].onerror(j,a,this.servers[l]):console.error(j)});let c=(j,z,E)=>{if(j.headers&&j.url){this.debug&&console.log("Upgrade request at: ",j.url);let I=!1;if(s&&j.url===s)I=!0;else{let P=j.headers.host.split(":")[0];t&&(P+=":"+t),P===l?I=!0:(P+=j.url.split("?")[0],P===l&&(I=!0))}I&&this.servers[l]&&this.servers[l].wss.handleUpgrade(j,z,E,P=>{this.servers[l].onupgrade&&this.servers[l].onupgrade(P,this.servers[l],j,z,E),this.servers[l].wss.emit("connection",P,j)})}};i&&i.addListener("upgrade",c),a.addListener("close",()=>{i&&i.removeListener("upgrade",c),this.servers[l]?.onclose?this.servers[l].onclose(a,this.servers[l]):console.log(`wss closed: ${l}`),delete this.servers[l]});let u=(j,z)=>{if(typeof j=="object"&&(j=JSON.stringify(j)),z)return this.sockets[z].send(j);for(let E in this.servers[l].clients)this.sockets[E].send(j)},h=(j,z,E)=>{if(E)return this.sockets[E].request(j,z);{let I=[];for(let P in this.servers[l].clients)I.push(this.sockets[P].request(j,z));return I}},_=(j,z,E,I)=>{if(I)return this.sockets[I].post(j,z,E);for(let P in this.servers[l].clients)this.sockets[P].post(j,z,E)},y=(j,z,E,I)=>{if(I)return this.sockets[I].run(j,z,E);{let P=[];for(let O in this.servers[l].clients)P.push(this.sockets[O].run(j,z,E));return P}},b=(j,z,E,I,P,O)=>{if(E)this.sockets[E].subscribe(j,z,I,P,O);else{let D=[];for(let F in this.servers[l].clients)D.push(this.sockets[F].subscribe(j,z,I,P,O));return D}},x=(j,z,E)=>{if(E)this.sockets[E].unsubscribe(j,z);else{let I=[];for(let P in this.servers[l].clients)I.push(this.sockets[P].unsubscribe(j,z));return I}},R=j=>j?this.terminate(j):this.terminate(l);return this.servers[l].send=u,this.servers[l].request=h,this.servers[l].post=_,this.servers[l].run=y,this.servers[l].subscribe=b,this.servers[l].unsubscribe=x,this.servers[l].terminate=R,this.servers[l].graph=this,this.servers[l]._id=e._id?e._id:l,this.servers[l]};openWS=e=>{if(!e.address){let h=e.protocol;h||(h="wss"),e.address=`${h}://${e.host}`,e.port&&(e.address+=":"+e.port),(!e.path||e.path?.startsWith("/"))&&(e.address+="/"),e.path&&(e.address+=e.path)}let t=e.address,s;if(e.socket?s=e.socket:s=new ke(t),"keepState"in e||(e.keepState=!0),e.onmessage)s.on("message",h=>{this.sockets[t].onmessage(h,s,this.sockets[t])});else if(e._id)s.addListener("message",h=>{ArrayBuffer.isView(h)&&(h=h.toString()),e.debug&&console.log("Message from ",e._id,": ",h),this.receive(h,s,this.sockets[t]),e.keepState&&this.setState({[t]:h})});else{let h=_=>{if(ArrayBuffer.isView(_)&&(_=_.toString()),_&&(e.debug&&console.log("Message from ",t,": ",_),typeof _=="string")){let y=_.substring(0,8);(y.includes("{")||y.includes("["))&&(y.includes("\\")&&(_=_.replace(/\\/g,"")),_[0]==='"'&&(_=_.substring(1,_.length-1)),_=JSON.parse(_),_.route==="setId"?(this.sockets[t]._id=_.args,s.removeEventListener("message",h),s.on("message",b=>{ArrayBuffer.isView(b)&&(b=b.toString()),e.debug&&console.log("Message from ",this.sockets[t]._id,": ",b),this.receive(b,s,this.sockets[t]),e.keepState&&this.setState({[t]:b})})):(this.receive(_,s,this.sockets[t]),this.setState({[t]:_})))}this.receive(_,s,this.sockets[t]),e.keepState&&this.setState({[t]:_})};s.addListener("message",h),e.onmessage=h}s.addListener("open",()=>{this.sockets[t].onopen&&this.sockets[t].onopen(s,this.sockets[t])}),s.addListener("close",(h,_)=>{let y=this.sockets[t],b=y.onclose;delete this.sockets[t],b&&b(h,_,s,y)}),s.on("error",h=>{this.sockets[t]?.onerror&&this.sockets[t].onerror(h,s,this.sockets[t])});let i=h=>this.transmit(h,s),r=(h,_,y)=>{let b={route:h,args:_};return y&&(b.method=y),this.transmit(b,s)},o=(h,_,y)=>new Promise((b,x)=>{let R=Math.random(),j={route:"runRequest",args:[{route:h,args:_},this.sockets[t]._id,R]};y&&(j.args[0].method=y);let z=E=>{let I=E.data;typeof I=="string"&&I.indexOf("{")>-1&&(I=JSON.parse(I)),typeof I=="object"&&I.callbackId===R&&(s.removeEventListener("message",z),b(I.args))};s.addEventListener("message",z),this.transmit(j,s)}),a=(h,_)=>this.request(h,s,this.sockets[t]._id,_),l=(h,_)=>this.subscribeToSocket(h,this.sockets[t]._id,_),c=(h,_)=>o("unsubscribe",[h,_]),u=()=>{this.terminate(this.sockets[t]._id)};return this.sockets[t]={type:"socket",socket:s,send:i,post:r,request:a,run:o,subscribe:l,unsubscribe:c,terminate:u,graph:this,__node:{tag:t},...e},this.sockets[t]};transmit=(e,t)=>{if((typeof e=="object"&&(e?.route||e?.node||typeof e.arrayBuffer!="function"&&typeof e.byteLength!="number"&&typeof e[0]?.byteLength!="number")||typeof e=="number")&&(e=JSON.stringify(e)),!t){let s=this.servers[Object.keys(this.servers)[0]];if(s)t=s.wss;else{let i=this.sockets[Object.keys(this.sockets)[0]];i&&(t=i.socket)}}t instanceof nt.default?t.clients.forEach(s=>{s.send(e)}):t instanceof ke&&t.send(e)};closeWS=e=>{if(e){if(typeof e=="string"){for(let t in this.sockets)if(t.includes(e)){e=this.sockets[t].socket,delete this.sockets[t];break}}}else{let t=this.sockets[Object.keys(this.sockets)[0]];t&&(e=t.socket)}return e instanceof ke&&e.readyState===e.OPEN&&e.close(),!0};terminate=e=>{let t;if(e){if(typeof e=="string"){t=e;for(let s in this.servers)if(s.includes(e)||this.servers[s]._id===e){e=this.servers[s].wss;for(let i in this.servers[s].clients)this.closeWS(this.servers[s].clients[i]);delete this.servers[s];break}if(!e){for(let s in this.sockets)if(s.includes(e)||this.sockets[s]._id===e){e=this.sockets[s].socket,delete this.sockets[s];break}}}}else{let s=Object.keys(this.servers);for(let r in s)this.terminate(r);let i=Object.keys(this.sockets);for(let r in i)this.terminate(r)}return e instanceof nt.default?e.close(s=>{s&&console.error(s)}):e instanceof ke&&(e.readyState===e.OPEN&&e.close(),this.get(t||e.url)&&this.remove(t||e.url)),!0};request=(e,t,s,i)=>{let r=`${Math.random()}`,o={route:"runRequest",args:[e,s,r]};return i&&(o.method=i),new Promise((a,l)=>{let c=u=>{let h=u.data;typeof h=="string"&&h.includes("callbackId")&&(h=JSON.parse(h)),typeof h=="object"&&h.callbackId===r&&(t.removeEventListener("message",c),a(h.args))};t.addEventListener("message",c),t.send(JSON.stringify(o))})};runRequest=(e,t,s)=>{let i=this.receive(e);if(t){if(typeof t=="string"){for(let r in this.servers)for(let o in this.servers[r].clients)if(o===t){t=this.servers[r].clients[o];break}if(!(t instanceof ke)){for(let r in this.sockets)if(r===t){t=this.sockets[r].socket;break}}}i instanceof Promise?i.then(r=>{i={args:r,callbackId:s},t instanceof ke&&t.send(JSON.stringify(i))}):(i={args:i,callbackId:s},t instanceof ke&&t.send(JSON.stringify(i)))}return i};subscribeSocket=(e,t,s,i,r)=>{if(!this.restrict?.[e]){if(typeof t=="string")if(this.sockets[t])t=this.sockets[t].socket;else for(let o in this.servers)this.servers[o].clients[t]&&(t=this.servers[o].clients[t]);if(typeof t=="object")return this.subscribe(e,o=>{t.readyState===t.OPEN&&(o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e})))},s,i,r)}};subscribeToSocket=(e,t,s,i,r,o)=>{if(typeof t=="string"&&this.sockets[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.setState({[s]:a.args}):s(a.args):this.setState({[t]:a.args}))}),this.sockets[t].request({route:"subscribeSocket",args:[e,t,i,r,o]})}};function ho(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var xe=require("child_process");var Pr=ce(require("path")),Ns=class extends ee{processes;connections={processes:void 0};subprocessloader={process:(e,t,s,i,r)=>{e.command&&this.createProcess(e)}};constructor(e){super(e),this.load(this),this.connections.processes=this.processes,process?.stdin&&process.stdin.on("data",t=>{let s=t.toString();this.receive(s)})}createProcess=e=>{let t=e;if(t.command||(t.command="node"),t.args||(t.args=[Pr.default.join(process.cwd(),"node_modules","graphscript-node","services","cmd","childprocess.js")]),t.command){let s;t.options||(t.options={shell:!0,stdio:"inherit"}),t.controller=new AbortController,t.options=Object.assign({signal:t.controller.signal,env:process.env,cwd:process.cwd()},t.options),t.tag?t._id=t.tag:(t._id=`process${Math.floor(Math.random()*1e15)}`,t.tag=t._id),typeof t.command=="string"&&(t.command.includes(".js")?s=(0,xe.fork)(t.command,t.args,t.options):s=(0,xe.spawn)(t.command,t.args?t.args:[],t.options),s instanceof xe.ChildProcess&&(s.stderr&&(t.onerror?s.stderr.on("data",t.onerror):s.stderr.on("data",console.error)),s.stdout&&(t.stdout?s.stdout.on("data",t.stdout):s.stdout.on("data",i=>{let r=i.toString();this.receive(r),this.setState({[t._id]:r})})),t.onclose&&s.on("close",t.onclose),t.process=s,t.controller=new AbortController,t.send=i=>s.send(i),t.request=(i,r)=>this.request(i,t._id,r),t.post=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),s.send(JSON.stringify(a))},t.run=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),this.request(a,t._id)},t.subscribe=(i,r,o,a,l)=>this.subscribeToProcess(i,t._id,r,o,a,l),t.unsubscribe=(i,r)=>t.run("unsubscribe",[i,r]),this.processes[t._id]=t))}return t};open=this.createProcess;abort=e=>(e.controller?e.controller.abort():e.kill(),!0);send=(e,t)=>e.send(t);request=(e,t,s)=>{let i=this.processes[t].process;return new Promise((r,o)=>{let a=Math.random(),l={route:"runRequest",args:[e,a]};s&&(l.method=s);let c=u=>{let h=u.toString();if(h.includes("{")){let _=JSON.parse(h);_.callbackId===a&&(i.removeListener("data",c),r(_.args))}};i.addListener("data",c),i.send(l)})};runRequest=(e,t,s)=>{let i=this.receive(e);return typeof s=="string"&&(s=this.processes[s].process),i instanceof Promise?i.then(r=>{i={args:r,callbackId:t},s instanceof xe.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))}):(i={args:i,callbackId:t},s instanceof xe.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))),i};subscribeProcess(e,t,s,i,r){if(!this.restrict?.[e])return typeof t=="string"&&this.processes[t]&&(t=this.processes[t].process),this.subscribe(e,o=>{o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e}))},s,i,r)}subscribeToProcess(e,t,s,i,r,o){if(typeof t=="string"&&this.processes[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.run(s,a.args):s(a.args):this.setState({[t]:a.args}))}),this.processes[t].request(JSON.stringify({route:"subscribeSocket",args:[e,t,i,r,o]}))}};var re={};Zs(re,{AuthorizationStruct:()=>zs,ChatroomStruct:()=>qs,CoherenceMap:()=>$t,CoherenceStruct:()=>qt,CommentStruct:()=>$s,Data:()=>Er,DataStruct:()=>Bs,DateStruct:()=>Hs,ECGStruct:()=>Jt,EDAStruct:()=>Ds,EEGCoordinates:()=>Tr,EEGStruct:()=>be,EMGStruct:()=>Ms,EventStruct:()=>Gs,EyeTrackerStruct:()=>Is,FNIRSStruct:()=>Wt,FrequencyBandsStruct:()=>at,GroupStruct:()=>Fs,HRVStruct:()=>Us,IMUStruct:()=>js,NotificationStruct:()=>Ws,PPGStruct:()=>Ls,ProfileStruct:()=>Rs,ScheduleStruct:()=>Js,Struct:()=>Y,eegCoordinates:()=>Oe,setCoordinate:()=>ot,structRegistry:()=>Cr});function Y(n="struct",e={},t={_id:""},s={structType:"struct",_id:""}){function i(o=""){return`${o+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}let r={_id:i(n+"defaultId"),structType:n,ownerId:t?._id,timestamp:Date.now(),parent:{structType:s?.structType,_id:s?._id}};return r.ownerId||delete r.ownerId,r?.parent?._id||delete r.parent,Object.keys(e).length>0&&Object.assign(r,e),r}var Oe={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function ot(n,e={}){if(!Oe[n.tag]&&n.position&&(Oe[n.tag]=[n.position.x,n.position.y,n.position.z]),Oe[n.tag]){let t={channel:"",position:{x:Oe[n.tag][0],y:Oe[n.tag][1],z:Oe[n.tag][2]}};return Object.assign(e,t)}else return Object.assign(e,n)}function Tr(n=[],e=!0){let t=[];for(let s of n){let i=be(s);t.push(i)}return e&&t.push(...$t({channelDicts:n})),t}function at(n=[],e={}){let t={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return n.forEach(s=>t[s]=[]),Object.assign(e,t)}function be(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=at(),r={tag:n,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=Y("eeg",r,t,s);return n&&ot(r,o),Object.assign(o,e)}function qt(n={0:be("FP1"),1:be("FP2")},e={},t={_id:""},s={structType:"struct",_id:""}){let i=at(),r={tag:n[0]?.tag+"::"+n[1]?.tag,x0:n[0]?.position?.x,y0:n[0]?.position?.y,z0:n[0]?.position?.z,x1:n[1]?.position?.x,y1:n[1]?.position?.y,z1:n[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=Y("coherence",r,t,s);return Object.assign(o,e)}function $t(n={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},t={_id:""},s={structType:"struct",_id:""}){for(var i=[],r=1,o=0,a=0;a<n.channelDicts.length*(n.channelDicts.length+1)/2-n.channelDicts.length;a++){if(n.taggedOnly===!1||n.taggedOnly===!0&&n.channelDicts[o].tag!==null&&n.channelDicts[o+r].tag!==null&&n.channelDicts[o].tag!=="other"&&n.channelDicts[o+r].tag!=="other"&&n.channelDicts[o].analyze===!0&&n.channelDicts[o+r].analyze===!0){var l=be(n.channelDicts[o].tag),c=be(n.channelDicts[o+r].tag);i.push(qt({0:l,1:c},{},t,s))}r++,r+o===n.channelDicts.length&&(o++,r=1)}return i}function Wt(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},r=Y("fnirs",i,t,s);return n&&ot(i,r),Object.assign(r,e)}function js(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},r=Y("imu",i,t,s);return n&&ot(i,r),Object.assign(r,e)}function Is(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},r=Y("eyetracker",i,t,s);return Object.assign(r,e)}function Jt(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},r=Y("ecg",i,t,s);return Object.assign(r,e)}function Ds(n="",e={},t={_id:""},s={structType:"struct",_id:""}){}function Ls(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=Wt(n,t,s,e);return i.structType="ppg",i}function Us(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=Jt(n,t,s,e);return i.structType="hrv",i}function Ms(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=be(n,t,s,e);return i.structType="emg",i}function Rs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Y("profile",{tag:n,name:"",username:"",firstName:"",lastName:"",email:"",phone:"",sex:"",birthday:"",type:"",pictureUrl:"",userRoles:{},socials:{},data:{},hidden:!1,accessToken:"",refreshToken:""},t,s);return Object.assign(r,e)}function zs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Y("authorization",{tag:n,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:{},structs:{},excluded:{},groups:{},status:"PENDING",expires:!1,associatedAuthId:""},t,s);return Object.assign(r,e)}function Fs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Y("group",{tag:n,name:"",details:"",admins:{},peers:{},clients:{},users:{}},t,s);return Object.assign(r,e)}function Er(n,e){return{type:n,data:e,timestamp:Date.now()}}function Bs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",expires:!1,type:"",data:new Array},r=Y("data",i,t,s);return Object.assign(r,e)}function Gs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,event:"",author:"",startTime:"",endTime:"",grade:void 0,value:void 0,units:void 0,location:void 0,notes:"",attachments:new Array,users:{}},r=Y("event",i,t,s);return Object.assign(r,e)}function qs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:{},audioChatActive:!1,videoChatActive:!1},r=Y("chatroom",i,t,s);return Object.assign(r,e)}function $s(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:{},attachments:new Array},r=Y("comment",i,t,s);return Object.assign(r,e)}function Ws(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Y("notification",{tag:n,note:"",parentUserId:""},t,s);return Object.assign(r,e)}function Js(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",attachments:new Array,dates:new Array},r=Y("schedule",i,t,s);return Object.assign(r,e)}function Hs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},r=Y("date",i,t,s);return Object.assign(r,e)}var Cr={Struct:Y,EEGStruct:be,FNIRSStruct:Wt,CoherenceStruct:qt,CoherenceMap:$t,FrequencyBandsStruct:at,IMUStruct:js,EyeTrackerStruct:Is,ECGStruct:Jt,EDAStruct:Ds,PPGStruct:Ls,HRVStruct:Us,EMGStruct:Ms,ProfileStruct:Rs,AuthorizationStruct:zs,GroupStruct:Fs,DataStruct:Bs,EventStruct:Gs,ChatroomStruct:qs,CommentStruct:$s,NotificationStruct:Ws,ScheduleStruct:Js,DateStruct:Hs};var lt=class{id;threaded;workers;DS=re;collections=new Map;data={byTime:{},notes:{},events:{},sleep:{},food:{},rx:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}};rolloverLimit=5e4;dataSorts=new Map;watches={};constructor(e={}){Object.assign(this.data,e),this.dataSorts=new Map,this.watches={},this.setSort("event",t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],t.event==="sleep"&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t)),this.setSort(["notes","note","link"],t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t)),this.id=this.randomId("dataTablet")}randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(e){let t=s=>{let i=s.structType,r=this.collections.get(i);r||(r=new Map,this.collections.set(i,r)),r.set(s._id,s),this.onCollectionSet(i,r)};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)}getLocalData(e,t){let s="",i="",r="";if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return this.collections.forEach(a=>{if((i==="_id"||i==="id")&&r){let l=a.get(r);l&&o.push(l)}else a.forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections.get(e);if(!a)return o;if(!i&&!s)return a.forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return a.get(r);a.forEach((l,c)=>{i&&r&&!s?l[i]===r&&o.push(l):s&&!i?l.ownerId===s&&o.push(l):s&&i&&r&&l.ownerId===s&&l[i]&&l[i]===r&&o.push(l)})}return o}onCollectionSet=(e,t)=>{};runSort(e,t={},s=[],i=this){let r,o=this.getSort(e);if(o)r=o(t,s,i);else return!1;return r}setSort(e,t=(s,i=[],r=this)=>{}){Array.isArray(e)?e.forEach(s=>{this.dataSorts.set(s,t)}):this.dataSorts.set(e,t)}getSort(e){return this.dataSorts.get(e)}checkWatches(e={}){for(let t in this.watches)this.watches[t].ondata(e,this.watches[t].accum,this.watches[t].ownerId)&&(this.watches[t].ontrigger(this.watches[t].accum),this.watches[t].triggered=!1)}setWatch(e,t,s=(r,o,a)=>(r.ownerId===a&&(o.data[r._id]=r),Object.keys(o.data).length>10),i=r=>{console.log(r);let o=Y("alert",{alert:!0,data:r},{_id:r[Object.keys(r)[0]].ownerId});r={}}){this.watches[e]={accum:{},ownerId:t,ondata:s,ontrigger:i}}getWatch(e){return this.watches[e]}async sortStructsIntoTable(e=[]){let t=function(i,r){if(i.timestamp&&r.timestamp)return i.timestamp-r.timestamp};e.sort(t);let s=[];for(let i=0;i<e.length;i++){let r=e[i];if(!r.timestamp)continue;let o=r.timestamp;if(this.data.byTime[o]?this.data.byTime[o].push(r):this.data.byTime[o]=[r],r.structType==="data"&&r.data)r.data.forEach(async a=>{if(typeof a=="object"&&!Array.isArray(a)){let l=a.dataType;if(a.ownerId=r.ownerId,a.timestamp||(a.timestamp=o),l){let c=this.runSort(l,a,s,this);c?c.constructor?.name!=="Promise"&&(this.checkWatches(c),this.onUpdate(o,c),s.push(c)):(this.data[l]||(this.data[l]={}),a.timestamp=o,this.data[l][o]?this.data[l][o].push(a):this.data[l][o]=[a],this.data.byTime[o]?this.data.byTime[o].push(a):this.data.byTime[o]=[a],this.checkWatches(a),this.onUpdate(o,a),s.push(a))}}});else{let a=this.runSort(r.structType,r,s,this);if(a)this.checkWatches(a),this.onUpdate(o,a),s.push(a);else{let l=r.structType;this.data[l]||(this.data[l]={}),this.data[l][o]?this.data[l][o].push(r):this.data[l][o]=[r],this.checkWatches(r),this.onUpdate(o,r),s.push(r)}}}for(let i in this.data)this.data[i]=this.sortObjectByPropName(this.data[i]);this.onSorted(s)}onUpdate(e,t,s=this.data){}onSorted(e=[]){}getDataByTimestamp(e,t){let s=this.data.byTime[e];return t&&s&&(s=s.filter(i=>t?t===i.ownerId:!0)),s}getDataByTimeRange(e,t,s,i){let r={};if(s){for(let o in this.data[s]){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data[s][o]])}s==="sleep"&&(r=this.filterSleepResults(r))}else for(let o in this.data.byTime){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data.byTime[o]])}if(i&&r)for(let o in r){let a=[];r[o]=r[o],r[o].forEach((l,c)=>{l.ownerId!==i&&a.push(c)}),a.reverse().forEach(l=>{r[o].splice(l,1)}),r[o].length===0&&delete r[o]}return r}getDataByType(e,t,s){if(!this.data[e])return;let i={...this.data[e]};if(t&&(i=[...i[t]]),s&&i)for(let r in i){let o=[];i[r]=[...i[r]],i[r].forEach((a,l)=>{a.ownerId!==s&&o.push(l)}),o.reverse().forEach(a=>{i[r].splice(a,1)}),i[r].length===0&&delete i[r]}return e==="sleep"&&(i=this.filterSleepResults(i)),i}filterSleepResults(e={}){let t=[];for(let i in e)e[i]=[...e[i]],t.push(...e[i].filter(r=>r.structType==="event"));return t.forEach(i=>{let r;for(let o in e)e[o].forEach((a,l)=>a.structType==="fitbitsleep"&&i.startTime&&i.endTime&&Math.abs(a.startTime-i.startTime)<1e3*12*3600&&Math.abs(a.endTime-i.endTime)<1e3*12*3600&&i.endTime-i.startTime>1e3*2*3600?(r=l,!0):!1),r&&e[o].splice(r,1)}),e}sortObjectByPropName(e){return Object.keys(e).sort().reduce((s,i)=>(s[i]=e[i],s),{})}checkRollover(e,t=this.rolloverLimit){if(!e)return!1;let s=this.collections.get(e);return s?(s.forEach(i=>{for(let r in i)Array.isArray(i[r])?i[r].length>t&&(i[r].slice(i[r].length-t),r==="ffts"?i.fftCount=i[r].length:r==="times"&&(i.count=i[r].length)):typeof i[r]=="object"&&this.checkRollover(i[r])}),!0):!1}};var Nr=["now","minute","5 minutes","30 minutes","hour","6 hours","12 hours","day","3 days","week","2 weeks","month","6 months","year","5 years","decade"];function uo(n=Nr){let e=["now"];return n.forEach(t=>{t!=="now"?e.push(`last ${t}`):e.push(t)}),e}function ge(n){let e=new Date;if(n!=="now"){if(n==="last minute")e.setMinutes(e.getMinutes()-1);else if(n==="last hour")e.setHours(e.getHours()-1);else if(n==="last day")e.setDate(e.getDate()-1);else if(n==="last week")e.setDate(e.getDate()-7);else if(n==="last month")e.setMonth(e.getMonth()-1);else if(n==="last year")e.setFullYear(e.getFullYear()-1);else if(n==="last decade")e.setFullYear(e.getFullYear()-1*10);else if(n==="last century")e.setFullYear(e.getFullYear()-1*100);else if(n==="last millennium")e.setFullYear(e.getFullYear()-1*1e3);else if(n==="last microsecond")e.setMilliseconds(e.getMilliseconds()-1);else if(n==="last nanosecond")e.setMilliseconds(e.getMilliseconds()-1*.001);else if(n.startsWith("last")){let[,t,s]=n.match(/last (\d+) (\w+)/)||[];if(t&&s){let i=parseInt(t,10);s.includes("minute")?e.setMinutes(e.getMinutes()-i):s.includes("hour")?e.setHours(e.getHours()-i):s.includes("day")?e.setDate(e.getDate()-i):s.includes("week")?e.setDate(e.getDate()-i*7):s.includes("month")?e.setMonth(e.getMonth()-i):s.includes("year")?e.setFullYear(e.getFullYear()-i):s.includes("decade")?e.setFullYear(e.getFullYear()-i*10):s.includes("century")?e.setFullYear(e.getFullYear()-i*100):s.includes("millennium")?e.setFullYear(e.getFullYear()-i*1e3):s.includes("microsecond")?e.setMilliseconds(e.getMilliseconds()-i):s.includes("nanosecond")&&e.setMilliseconds(e.getMilliseconds()-i*.001)}}}return e.getTime()}var jr=n=>(n?`${n}`:"")+Math.floor(1e15*Math.random()),_o=(n=Math,e=Date,t=16,s=i=>n.floor(i).toString(t))=>s(e.now()/1e3)+" ".repeat(t).replace(/./g,()=>s(n.random()*t)),Vs=class extends ee{name="structs";currentUser;tablet=new lt;collections=this.tablet.collections;id=jr();useAccessTokens=!1;useRefreshTokens=!1;constructor(e,t){super(e),this.load(this),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),t instanceof Object&&Object.keys(t).length>0&&this.setupUser(t)}getToken(e){return this.useRefreshTokens?e.refreshToken:e.accessToken}setupUser=async(e,t=s=>{})=>{if(!e){console.error('must provide a minimum info object! e.g. {_id:"abc123"}'),t(void 0);return}let s=!1;e.id&&!e._id?e._id=e.id:e._id&&(e.id=e._id);let i=await this.getUser(e._id),r=i?.user,o,a=!1;if(!r||!r._id){o=this.userStruct(e,!1),a=!0;let l=await this.setUser(o),c=this.getLocalData(void 0,{ownerId:o._id});c?.length>0&&this.updateServerData(c),this.setAuthorizationsByGroup(o)}else{o=r;let l={_id:e._id,ownerId:e._id},c=this.userStruct(e,!1);for(let u in c)e[u]&&r[u]!==e[u]?(l[u]=e[u],r[u]=e[u]):c[u]&&!r[u]&&(l[u]=c[u],r[u]=c[u]);Object.keys(l).length>2&&await this.setUser(l),i?.authorizations&&Array.isArray(i.authorizations)&&this.setLocalData(i.authorizations),i?.groups&&Array.isArray(i.groups)&&this.setLocalData(i.groups)}if(a)this.setLocalData(o);else{let l=await this.getAllUserData(o._id,void 0,[ge("last day"),Date.now()]);if(!(!l||l.length===0)){this.setLocalData(l);let c=l.filter(y=>{if(y.structType==="notification"&&(this.getLocalData("authorization",y.parent._id)||y.parent.structType==="user"||y.parent.structType==="authorization"||!this.getLocalData(y.parent.structType,y.parent._id)))return!0}),u=l.filter(y=>{if(y.structType==="comment")return!0}),h=[];u.forEach(y=>{this.getLocalData("comment",{_id:y._id})||h.push(y._id)}),h.length>0&&this.deleteData(h),c.length>0&&(this.resolveNotifications(c,!1,void 0),s=!0);let _=l.filter(y=>{if(y.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(_)}this.setLocalData(o)}return o?(this.currentUser?Object.assign(this.currentUser,o):this.currentUser=o,t(this.currentUser),this.currentUser):(t(o),o)};baseServerCallback=async e=>{let t=e;if(typeof e=="object"&&e?.structType&&(t=[e]),Array.isArray(t)){let s=t.filter(i=>{if(i.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(s);for(let i=0;i<t.length;i++){let r=t[i];if(typeof r=="object")if((!r.structType||r.structType==="USER")&&(r.email?r.structType="user":r.structType="uncategorized"),r.structType==="user"||r.structType==="authorization"||r.structType==="group"){if(r.structType==="user")r._id=r.id;else if(r.structType==="group"&&this.currentUser){let o=!1;r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_admin"]?(this.currentUser.userRoles[r.name+"_admin"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_admin"]&&(delete this.currentUser.userRoles[r.name+"_admin"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_peer"]?(this.currentUser.userRoles[r.name+"_peer"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_peer"]&&(delete this.currentUser.userRoles[r.name+"_peer"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_client"]?(this.currentUser.userRoles[r.name+"_client"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_client"]&&(delete this.currentUser.userRoles[r.name+"_client"],o=!0),o&&await this.setUser(this.currentUser)}this.setLocalData(r)}else r.structType==="notification"?(this.getLocalData("notification",{ownerId:r.ownerId,_id:r.parent._id})?this.setLocalData(r):this.getLocalData(r.structType,{_id:r.parent._id})||this.overwriteLocalData(r),r.ownerId===this.currentUser?._id&&(r.parent.structType==="user"||r.parent.structType==="dataInstance"||r.parent.structType==="schedule"||r.parent.structType==="authorization")&&await this.resolveNotifications([r],!0),this.onNotify(r)):this.overwriteLocalData(r)}}this.onData(e)};structNotification=()=>{this.checkForNotifications()};structDeleted=e=>{this.deleteLocalData([e])};onData=e=>{};onNotify=e=>{};randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct=async(e="struct",t={},s,i,r=!0)=>{let o=re.Struct(e,t,s,i);return r&&(o=await this.updateServerData([o])[0]),o};getUser=async(e="",t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return s(i),i}};queryUsers=async(e,t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"queryUsers",args:[this.currentUser._id,e,t,s,void 0,this.getToken(this.currentUser)]});return i(r),r}};getUsers=async(e=[],t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUsersByIds",args:[this.currentUser._id,e,t]});return s(i),i}};getUsersByRole=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=await this.currentUser.request({route:"getUsersByRole",args:[this.currentUser._id,e]});return t(s),s}};getAllUserData=async(e,t=[],s,i=this.baseServerCallback)=>{if(s&&(typeof s[0]=="string"&&(s[0]=ge(s[0])),typeof s[1]=="string"&&(s[1]=ge(s[1]))),this.currentUser?.request){let r=await this.currentUser.request({route:"getAllData",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return i(r),r}};query=async(e,t={},s=!1,i=0,r=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e||!t)return;let o=await this.currentUser.request({route:"query",args:[this.currentUser._id,e,t,s,i,this.getToken(this.currentUser)]});return typeof r=="function"&&r(o),o}};getDataByTimeRange(e,t,s,i=0,r=0,o){let a={};t&&(typeof t[0]=="string"&&(t[0]=ge(t[0])),typeof t[1]=="string"&&(t[1]=ge(t[1])));let l={$gt:t[0],$lt:t[1]};return o?a[o]=l:a.timestamp=l,this.getData(e,s,a,i,r)}getData=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{if(this.currentUser?.request){let a=await this.currentUser.request({route:"getData",args:[this.currentUser._id,e,t,s,i,r,this.getToken(this.currentUser)]});return typeof o=="function"&&o(a),a}};getDataByIds=async(e=[],t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"getDataByIds",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return typeof i=="function"&&i(r),r}};getStructParentData=async(e,t=this.baseServerCallback)=>{if(e?.parent&&this.currentUser?.request){let s=[this.currentUser._id,e.parent?.structType,"_id",e.parent?._id,this.getToken(this.currentUser)],i=(await this.currentUser.request({route:"getData",args:s}))?.[0];return typeof t=="function"&&t(i),i}};setUser=async(e,t=this.baseServerCallback)=>{if(console.log(this.currentUser),e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setUser",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkUserToken=async(e,t=this.currentUser,s=this.baseServerCallback)=>{if(!e)return!1;let i=!1;for(let r in e){let o=this.userStruct();if(t[r]&&r!=="_id")if(Array.isArray(e[r])){for(let a=0;a<t[r].length;a++)if(e[r].indexOf(t[r][a])<0){t[r]=e[r],i=!0;break}if(!i){for(let a=0;a<e[r].length;a++)if(t[r].indexOf(e[r][a])<0){t[r]=e[r],i=!0;break}}}else t[r]!==e[r]&&(t[r]=e[r],i=!0);else!t[r]&&o[r]&&(t[r]=e[r],i=!0)}return i&&await this.setUser(t,s)};setData=async(e=[],t=!0,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=new Array;!Array.isArray(e)&&typeof e=="object"&&(e=[e]),e.forEach(o=>{i.push(this.stripStruct(o))});let r=await this.currentUser.request({route:"setData",args:[this.currentUser._id,i,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};updateServerData=this.setData;deleteData=async(e=[],t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=[];e.forEach(r=>{if(typeof r=="object")r?.structType&&r?._id&&(s.push({structType:r.structType,_id:r._id}),this.deleteLocalData(r));else if(typeof r=="string"){let o=this.getLocalData(void 0,{_id:r});o&&!Array.isArray(o)?s.push({structType:o.structType,_id:o._id}):s.push({_id:r})}});let i=await this.currentUser.request({route:"deleteData",args:[this.currentUser._id,s,this.getToken(this.currentUser)]});return typeof t=="function"&&t(i),i}};deleteUser=async(e=this.currentUser._id,t,s=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;let i=await this.currentUser.request({route:"deleteUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};setGroup=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setGroup",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getUserGroups=async(e=this.currentUser._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUserGroups",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteGroup=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteGroup",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};setAuthorization=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setAuthorization",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getAuthorizations=async(e=this.currentUser?._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){if(e===void 0)return;let i=await this.currentUser.request({route:"getAuthorizations",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteAuthorization=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteAuthorization",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkForNotifications=async(e=this.currentUser?._id)=>await this.getData("notification",e);resolveNotifications=async(e=[],t=!0,s=this.currentUser)=>{if(!s||e.length===0)return;let i=[],r=[],o=[],a=!1;if(e.length===0&&(e=this.getLocalData("notification",{ownerId:s._id})),e.forEach(l=>{l.parent.structType==="user"&&(a=!0),o.push(l.parent.structType),i.push(l.parent._id),r.push(l._id),this.deleteLocalData(l)}),this.deleteData(e),t){if(o.reverse().forEach((l,c)=>{l==="user"&&(this.getUser(i[c]),i.splice(i.length-c-1,1))}),i.length===1)return await this.getDataByIds(i,void 0,e[0].parent.structType);if(i.length>0)return await this.getDataByIds(i)}return!0};setAuthorizationsByGroup=async(e=this.currentUser)=>{let t=this.getLocalData("authorization",{ownerId:e._id}),s=[];if(e.userRoles&&await Promise.all(Object.keys(e.userRoles).map(async i=>{let o=i.split("_")[0],a;if(i.includes("client")?a=o+"_peer":i.includes("peer")?a=o+"_client":i.includes("admin")&&(a=o+"_owner"),a){let l=await this.getUsersByRole(a);l&&await Promise.all(l.map(async c=>{let u=c.username;u||(u=c.email),u||(u=c._id);let h=e.username;if(h||(h=e.email),h||(h=e._id),u!==h){if(i.includes("client")){if(!t.find(y=>{if(y.authorizerId===c._id&&y.authorizedId===e._id)return!0})){let y=await this.authorizeUser(re.ProfileStruct("user",e,e),c._id,u,e._id,h,{peer:!0},void 0,{group:o});s.push(y)}}else if(i.includes("peer")&&!t.find(y=>{if(y.authorizedId===c._id&&y.authorizerId===e._id)return!0})){let y=await this.authorizeUser(re.ProfileStruct("user",e,e),e._id,h,c._id,u,{peer:!0},void 0,{group:o});s.push(y)}}}))}})),s.length>0)return s};deleteRoom=async e=>{if(!e)return!1;let t=[e];return e.comments?.forEach(s=>{let i=this.getLocalData("comment",{_id:s});t.push(i)}),e?await this.deleteData(t):!1};deleteComment=async e=>{let t=[e],s=(a=e)=>{a?.replies&&a.replies.forEach(l=>{let c=this.getLocalData("comment",{_id:l});c&&(c.replies.length>0&&c.replies.forEach(u=>{s(u)}),t.push(c))})};s(e);let i=this.getLocalData(e.parent?.structType,{_id:e.parent?._id}),r=[];i&&(r=[i],t.forEach(a=>{let l=i.replies?.indexOf(a._id);l>-1&&i.replies.splice(l,1);let c=i.comments?.indexOf(a._id);c>-1&&i.comments.splice(c,1)}));let o=this.getLocalData("comment",{_id:e.replyTo});if(o?._id!==i?._id){let a=o.replies?.indexOf(i._id);a>-1&&o.replies.splice(a,1),r.push(o)}return r.length>0&&await this.updateServerData(r),await this.deleteData(t)};getUserDataByAuthorization=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=e.authorizerId;if(a)return new Promise(async l=>{this.getUser(a,!0,async c=>{let u;t?u=await this.getData(t,a,s,i,r,o):u=await this.getAllUserData(a,["notification"],void 0,o),l(u),o(u)})})};getUserDataByAuthorizationGroup=async(e="",t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=this.getLocalData("authorization"),l=[];return await Promise.all(a.map(async c=>{if(c.groups?.includes(e)){let u=c.authorizerId;if(u){let h,_=await this.getUser(u,!0,o);_&&l.push(_),t?h=await this.getData(t,u,s,i,r,o):h=await this.getAllUserData(u,["notification"],void 0,o),h&&l.push(h)}return!0}})),l};overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){this.tablet.setLocalData(e)}getLocalData(e,t){return this.tablet.getLocalData(e,t)}getLocalUserPeerIds=(e=this.currentUser)=>{if(!e)return{};let t={};return this.getLocalData("authorization",e._id).forEach(i=>{i.authorizations.peer&&i.authorizerId===e._id&&(t[i.authorizedId]=!0)}),t};getLocalReplies(e){let t=[];if(e.replies){if(e.replies.reduce((s,i)=>s*(typeof i=="object"?1:0),1))return e.replies}else return t;return t=this.getLocalData("comment",{replyTo:e._id}),t}hasLocalAuthorization(e,t=this.currentUser._id){let i=this.getLocalData("authorization",{ownerId:t}).find(r=>{if(r.authorizedId===t&&r.authorizerId===e||r.authorizerId===t&&r.authorizedId===e)return!0});return i||!1}deleteLocalData(e){return Array.isArray(e)?e.forEach(t=>this.deleteStruct(t)):this.deleteStruct(e),!0}deleteStruct(e){if(typeof e=="string"&&(e=this.getLocalData(void 0,{_id:e})),!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.tablet.collections.get(e.structType).delete(e._id),!0)}stripStruct(e){let t=Object.assign({},e);for(let s in t)(t[s]===void 0||t[s]===""||t[s].constructor.name==="Map"||t[s].constructor.name==="Set"||typeof t[s]=="function"||Array.isArray(t[s])&&t[s].length===0||typeof t[s]=="object"&&Object.keys(t[s]).length===0)&&delete t[s];return t}createStruct(e,t,s=this.currentUser,i){return re.Struct(e,t,s,i)}userStruct(e={},t=!1){let s=re.ProfileStruct(void 0,e,e);if(!s.name&&s.firstName)s.name=s.firstName+" "+s.lastName;else if(s.name&&!s.firstName){let r=s.name.split(" ");s.firstName=r[0],s.lastName=r[r.length-1]}e._id?s.id=e._id:e.id?s.id=e.id:s.id="user"+Math.floor(Math.random()*1e15),s._id=s.id,s.ownerId=s.id;let i=re.ProfileStruct();for(let r in e)Object.keys(i).indexOf(r)<0&&delete s[r];return t&&(this.currentUser=s),s}authorizeUser=async(e,t="",s="",i="",r="",o={},a={},l={},c={},u=!1)=>{if(!e)return;let h=this.createStruct("authorization",void 0,e,void 0);return h.authorizedId=i,h.authorizedName=r,h.authorizerId=t,h.authorizerName=s,h.authorizations=o,h.structs=a,h.excluded=l,h.groups=c,h.expires=u,h.status="PENDING",h.associatedAuthId="",h=await this.setAuthorization(h),h};addGroup=async(e,t="",s="",i={},r={},o={},a=!0)=>{if(!e)return;let l=this.createStruct("group",void 0,e);return l.name=t,l.details=s,l.admins=i,l.peers=r,l.clients=o,l.users={},Object.assign(l.users,l.admins),Object.assign(l.users,l.peers),Object.assign(l.users,l.clients),a&&(l=await this.setGroup(l)),l};dataObject(e=void 0,t="any",s=Date.now()){return{type:t,data:e,timestamp:s}}addData=async(e,t="",s="",i="",r=[],o=!1,a=!0)=>{if(!e)return;let l=this.createStruct("dataInstance",void 0,e);return l.author=t,l.title=s,l.type=i,l.data=r,l.expires=o,a&&(l=await this.updateServerData([l])[0]),l};addEvent=async(e,t="",s="",i="",r,o,a,l,c,u,h,_,y=!0)=>{if(!e)return;_&&Object.keys(_).length===0&&(_=this.getLocalUserPeerIds(e));let b=this.createStruct("event",void 0,e);return b.author=t,b.event=s,b.notes=i,b.startTime=r,b.endTime=o,b.grade=a,b.attachments=h,b.value=l,b.units=c,b.users=_,b.location=u,y&&(b=await this.updateServerData([b])[0]),b};addChatroom=async(e,t="",s="",i,r,o=!0)=>{if(!e)return;r&&Object.keys(r).length===0&&(r=this.getLocalUserPeerIds(e));let a=this.createStruct("chatroom",void 0,e);a.message=s,a.attachments=i,a.authorId=t,a.users=r,a.replies=[],a.comments=[];let l=[a];return o&&(a=await this.updateServerData(l)[0]),a};addComment=async(e,t,s,i="",r="",o,a=!0)=>{if(!t||(s||(s=t),!e))return;let l=this.createStruct("comment",void 0,e,t);l.authorId=i,l.replyTo=s?._id,l.message=r,l.attachments=o,l.users=t?.users,l.replies=[],a||s?.replies.push(l._id),a||t?.comments.push(l._id);let c=[l,t];s?._id!==t._id&&c.push(s);let u;a&&(u=await this.updateServerData(c));let h;return typeof u=="object"&&(h=u.find(_=>{if(l.ownerId===_.ownerId&&l.timestamp===_.timestamp&&l.message===_.message)return!0})),h||u}};var Ys=Math.floor(Math.random()*16777215),Ir=W.index=parseInt(Math.random()*16777215,10),Dr=(typeof process>"u"||typeof process.pid!="number"?Math.floor(Math.random()*1e5):process.pid)%65535,Lr=(()=>{try{return _Buffer}catch{try{return Buffer}catch{return null}}})(),Ht=function(n){return!!(n!=null&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n))},Mr=[];for(ne=0;ne<256;ne++)Mr[ne]=(ne<=15?"0":"")+ne.toString(16);var ne,Ur=new RegExp("^[0-9a-fA-F]{24}$"),ct=[];ne=0;for(;ne<10;)ct[48+ne]=ne++;for(;ne<16;)ct[55+ne]=ct[87+ne]=ne++;function W(n){if(!(this instanceof W))return new W(n);if(n&&(n instanceof W||n._bsontype==="ObjectId"))return n;if(this._bsontype="ObjectId",n==null||typeof n=="number"){this.id=this.generate(n);return}var e=W.isValid(n);if(!e&&n!=null)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&typeof n=="string"&&n.length===24)return W.createFromHexString(n);if(n!=null&&n.length===12)this.id=n;else{if(n!=null&&typeof n.toHexString=="function")return n;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}}module.exports=W;W.default=W;W.createFromTime=function(n){return n=parseInt(n,10)%4294967295,new W(po(8,n)+"0000000000000000")};W.createFromHexString=function(n){if(typeof n>"u"||n!=null&&n.length!==24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",t=0;t<24;)e+=String.fromCharCode(ct[n.charCodeAt(t++)]<<4|ct[n.charCodeAt(t++)]);return new W(e)};W.isValid=function(n){return n==null?!1:typeof n=="number"?!0:typeof n=="string"?n.length===12||n.length===24&&Ur.test(n):n instanceof W?!0:Ht(n)?W.isValid(n.toString("hex")):typeof n.toHexString=="function"&&Lr&&(n.id instanceof Lr||typeof n.id=="string")?n.id.length===12||n.id.length===24&&Ur.test(n.id):!1};W.prototype={constructor:W,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(this.id.length===24)return this.id;if(Ht(this.id))return this.id.toString("hex");for(var n="",e=0;e<this.id.length;e++)n+=Mr[this.id.charCodeAt(e)];return n},equals:function(n){return n instanceof W?this.toString()===n.toString():typeof n=="string"&&W.isValid(n)&&n.length===12&&Ht(this.id)?n===this.id.toString("binary"):typeof n=="string"&&W.isValid(n)&&n.length===24?n.toLowerCase()===this.toHexString():typeof n=="string"&&W.isValid(n)&&n.length===12?n===this.id:n!=null&&(n instanceof W||n.toHexString)?n.toHexString()===this.toHexString():!1},getTimestamp:function(){var n=new Date,e;return Ht(this.id)?e=this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:e=this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,n.setTime(Math.floor(e)*1e3),n},generate:function(n){typeof n!="number"&&(n=~~(Date.now()/1e3)),n=parseInt(n,10)%4294967295;var e=go();return String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255,Ys>>16&255,Ys>>8&255,Ys&255,Dr>>8&255,Dr&255,e>>16&255,e>>8&255,e&255)}};function go(){return Ir=(Ir+1)%16777215}function po(n,e){return e=e.toString(16),e.length===n?e:"00000000".substring(e.length,n)+e}var yo=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";W.prototype[yo]=function(){return"ObjectId("+this+")"};W.prototype.toJSON=W.prototype.toHexString;W.prototype.toString=W.prototype.toHexString;var mo=n=>(n?`${n}_`:"")+Math.floor(1e15*Math.random()),K=n=>typeof n=="string"&&n.length===24?new W(n):n,N=n=>typeof n=="object"?n.toString():n,Rr=["profile","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],Ks=class extends ee{name="structs";debug=!1;db;users={};collections={};mode="local";useAuths=!0;useAccessTokens=!1;useRefreshTokens=!1;accessTokens=new Map;refreshTokens=new Map;constructor(e,t){super(e),this.load(this),t&&this.initDB(t)}initDB=e=>{this.db=e.db,e?.users&&(this.users=e.users),e.mode&&(this.mode=e.mode),e?.collections&&(this.collections=e.collections),e.debug&&(this.debug=e.debug),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),"useAuths"in e&&(this.useAuths=e.useAuths),Rr.forEach(t=>{this.collections[t]||(this.collections[t]=this.db?{instance:this.db.collection(t)}:{},this.collections[t].reference={})})};query=async(e,t,s,i,r,o)=>{let a=this.users[e];if(!a)return!1;if(this.mode.indexOf("mongo")>-1)return await this.queryMongo(a,t,s,i,r,o);{let l=this.getLocalData(a,t);if(l&&!Array.isArray(l)){let u=!this.useAuths;if(l?.ownerId?this.useAuths&&(u=await this.checkAuthorization(a,l,"READ",o)):u=!0,u)return l}typeof r=="number"&&Array.isArray(l)&&l.length>r&&l.splice(0,r);let c=[];return l&&await Promise.all(l.map(async u=>{let h=this.getLocalData(N(u._id)),_=!this.useAuths;!h?.ownerId||h.ownerId===a._id?_=!0:this.useAuths&&(_=await this.checkAuthorization(a,h,"READ",o)),_&&c.push(h)})),c}};getUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.indexOf("mongo")>-1)o=await this.getMongoUser(r,t,void 0,s,i);else{let a=this.getLocalData("profile",{_id:t});if(!a)o={user:void 0};else{let l=!this.useAuths;if(!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"READ",i)),l){let c=this.getLocalData("group",{ownerId:t}),u=this.getLocalData("authorization",{ownerId:t});o={user:a,groups:c,authorizations:u}}else o={user:{}}}}return this.debug&&console.log("getUser: user:",r,"input:",t,"output",o),o};setUser=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(t.accessToken)this.accessTokens.set(e,s);else if(this.useAccessTokens)return!1;if(t.refreshToken)this.refreshTokens.set(e,t.refreshToken);else if(this.useRefreshTokens)return!1;if(delete t.accessToken,delete t.refreshToken,delete i.accessToken,delete i.refreshToken,this.mode.indexOf("mongo")>-1)r=await this.setMongoUser(i,t,s);else{let o=!this.useAuths;return!t?.ownerId||t.ownerId===i._id?o=!0:this.useAuths&&(o=await this.checkAuthorization(i,t,"WRITE",s)),o&&this.setLocalData(t),!0}return this.debug&&console.log("setUser user:",i,"input:",t,"output",r),r};getUsersByIds=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoUsersByIds(i,t,s);else if(r=[],Array.isArray(t)){let o=this.getLocalData("profile",{_id:t});o&&(s?r.push({_id:o._id,username:o.username,firstName:o.firstName,lastName:o.lastName,fullName:o.fullName,pictureUrl:o.pictureUrl}):r.push(o))}return this.debug&&console.log("getUserByIds: user:",i,"input:",t,"output",r),r};getUsersByRole=async(e,t)=>{let s=this.users[e];if(!s)return!1;let i;if(this.mode.includes("mongo"))i=await this.getMongoUsersByRole(s,t);else{let r=this.getLocalData("profile");i=[],r.forEach(o=>{o.userRoles[t]&&i.push(o)})}return this.debug&&console.log("getUserByRoles: user:",s,"input:",t,"output",i),i};deleteUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.deleteMongoUser(r,t,s,i);else{o=!1;let a=this.getLocalData(t);if(a){let l=!this.useAuths;!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"WRITE",i)),l&&(o=this.deleteLocalData(a))}}return this.debug&&console.log("deleteUser: user:",r,"input:",t,"output",o),o};setData=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.setMongoData(r,t,s,i);else{let a=[];return o=[],await Promise.all(t.map(async l=>{let c=this.getLocalData(l),u=!this.useAuths;!c?.ownerId||c.ownerId===r._id?u=!0:this.useAuths&&(u=await this.checkAuthorization(r,c,"WRITE",i)),u&&(this.collections[c.structType]||(this.collections[c.structType]={},this.collections[c.structType].reference={}),this.setLocalData(c),o.push(c),c.structType!=="notification"&&a.push(c))})),a.length>0&&(s===!0||typeof s>"u")&&this.checkToNotify(r,a,this.mode),this.debug&&console.log("setData:",r,t,o),!0}return this.debug&&console.log("setData: user:",r,"input:",t,s,"output",o),o};getData=async(e,t,s,i,r,o,a)=>{let l=this.users[e];if(!l)return!1;let c;if(this.mode.includes("mongo"))c=await this.getMongoData(l,t,s,i,r,o,a);else{c=[];let u;t&&(u=this.getLocalData(t)),u&&s&&(u=u.filter(h=>{if(h.ownerId===s)return!0})),u&&await Promise.all(u.map(async h=>{let _=this.getLocalData(N(h._id)),y=!this.useAuths;!_?.ownerId||_.ownerId===l._id?y=!0:this.useAuths&&(y=await this.checkAuthorization(l,_,"READ",a)),y&&c.push(_)}))}return this.debug&&console.log("getData: user:",l,"input:",t,s,i,r,o,"output",c),c};getDataByIds=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getMongoDataByIds(o,t,s,i,r);else{a=[];let l;i&&(l=this.getLocalData(i)),l&&s&&(l=l.filter(c=>{if(c.ownerId===s)return!0})),l&&await Promise.all(l.map(async c=>{let u=this.getLocalData(N(c._id)),h=!this.useAuths;!u?.ownerId||u.ownerId===o._id?h=!0:this.useAuths&&(h=await this.checkAuthorization(o,u,"READ",r)),h&&a.push(u)}))}return this.debug&&console.log("getDataByIds: user:",o,"input:",t,s,i,"output",a),a};getAllData=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getAllUserMongoData(o,t,s,i,r);else{let l=this.getLocalData(void 0,{ownerId:t});a=[],await Promise.all(l.map(async c=>{if(s){if(s.indexOf(c.structType)<0){let u=!this.useAuths;!c?.ownerId||c.ownerId===o._id?u=!0:this.useAuths&&(u=await this.checkAuthorization(o,c,"READ",r)),u&&a.push(c)}}else{let u=!this.useAuths;!c?.ownerId||c.ownerId===o._id?u=!0:this.useAuths&&(u=await this.checkAuthorization(o,c,"READ",r)),u&&a.push(c)}}))}return this.debug&&console.log("getAllData: user:",o,"input:",t,s,"output",a),a};deleteData=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;return this.mode.includes("mongo")?r=await this.deleteMongoData(i,t,s):(r=!1,await Promise.all(t.map(async o=>{let a=this.getLocalData(o),l=!this.useAuths;!a?.ownerId||a.ownerId===i._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(i,a,"WRITE",s)),l&&this.deleteLocalData(a),r=!0}))),this.debug&&console.log("deleteData: user:",i,"input:",t,"output",r),r};getUserGroups=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoGroups(i,t,s);else if(typeof s=="string")r=this.getLocalData("group",{_id:s});else{r=[];let o=this.getLocalData("group");t?o.forEach(a=>{Object.keys(a.users).includes(t)&&r.push(a)}):o.forEach(a=>{Object.keys(a.users).includes(N(i._id))&&r.push(a)})}return this.debug&&console.log("getGroups: user:",i,"input:",t,s,"output",r),r};deleteGroup=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoGroup(i,t,s);else{let o=this.getLocalData("group",t),a=!this.useAuths;o&&(!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s))),a&&(r=!0)}return this.debug&&console.log("deleteGroup: user:",i,"input:",t,"output",r),r};getAuthorizations=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.getMongoAuthorizations(r,t,s,i);else if(s){let a=this.getLocalData("authorization",{_id:s});a&&(o=[a])}else o=this.getLocalData("authorization",{ownerId:t});return this.debug&&console.log("getAuthorizations: user:",r,"input:",t,s,"output",o),o};deleteAuthorization=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoAuthorization(i,t,s);else{r=!0;let o=this.getLocalData("authorization",{_id:t});if(o){let a=!this.useAuths;!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s)),a&&(r=this.deleteLocalData(o))}}return this.debug&&console.log("deleteAuthorization: user:",i,"input:",t,"output",r),r};getToken=e=>this.useAccessTokens?this.accessTokens.get(e._id):this.useRefreshTokens?this.refreshTokens.get(e._id):void 0;notificationStruct=(e={})=>{let t="notification";return{structType:t,timestamp:Date.now(),_id:mo(t),note:"",alert:!1,ownerId:"",parentUserId:"",parent:{structType:e?.structType,_id:N(e?._id)}}};checkToNotify=async(e,t=[],s=this.mode)=>{if(t.length===0)return!1;if(typeof e=="string")for(let o in this.users){let a=this.users[o];N(a._id)===e&&(e=a)}if(typeof e=="string"||e==null)return!1;let i={},r=[];if(t.forEach(async o=>{if(o?._id){if(o.ownerId&&e?._id!==o.ownerId){let a=this.notificationStruct(o);a._id="notification_"+N(o._id)+"_"+o.ownerId,a.ownerId=o.ownerId,a.note=o.structType,a.parentUserId=o.ownerId,o.alert&&(a.alert=o.alert),r.push(a),i[o.ownerId]=o.ownerId}if(o.users)Object.keys(o.users).forEach(a=>{if(a!==e._id){let l=this.notificationStruct(o);l._id="notification_"+N(o._id)+"_"+a,l.ownerId=a,l.note=o.structType,o.alert&&(l.alert=o.alert),l.parentUserId=o.ownerId,r.push(l),i[a]=a}});else{let a=[];if(s.includes("mongo")){let c=await this.collections.authorization.instance.find({$or:[{authorizedId:e._id},{authorizerId:e._id}]}).toArray();c.length>0&&c.forEach(u=>a.push(u))}else a=this.getLocalData("authorization",{authorizedId:e._id}),a.push(...this.getLocalData("authorization",{authorizerId:e._id}));a.length>0&&a.forEach(l=>{if(o.authorizerId===o.ownerId&&!i[o.authorizedId]&&l.status==="OKAY"&&l.authorizations.peer){let c=this.notificationStruct(o);c.ownerId=l.authorizedId,c._id="notification_"+N(o._id)+"_"+l.authorizedId,c.note=o.structType,c.parentUserId=o.ownerId,o.alert&&(c.alert=o.alert),r.push(c),i[c.ownerId]=c.ownerId}})}}}),r.length>0){s.includes("mongo")?await this.setMongoData(e,r,!0,this.getToken(e)):this.setLocalData(r);for(let o in i)this.users[o]?.sendAll({route:"structNotification",args:!0});return!0}else return!1};queryMongo=async(e,t,s={},i=!1,r=0,o)=>{if(!(!t&&!s))if(i){let a=await this.db.collection(t).findOne(s);if(!a)return;let l=!this.useAuths;return a?.ownerId?(N(e._id)!==a.ownerId||N(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",o)):l=!0,l?a:void 0}else{let a=this.db.collection(t).find(s).sort({$natural:-1}).skip(r),l=[],c=await a.toArray();if(c.length>0){let u=!this.useAuths,h="";for(let _ of c)_?.ownerId?(N(e._id)!==_.ownerId||N(e._id)===_.ownerId&&e.userRoles?.admincontrol)&&h!==_.ownerId&&(this.useAuths&&(u=await this.checkAuthorization(e,_,"READ",o)),h=_.ownerId):u=!0,u&&l.push(_)}return l}};setMongoData=async(e,t=[],s=!0,i)=>{let r=!1;if(t.length>0){let o=!this.useAuths,a="";if(await Promise.all(t.map(async l=>{let c={};if(Array.isArray(l)&&(c=l[1],l=l[0]),!l?.ownerId||l.ownerId===e._id?o=!0:(N(e._id)!==l.ownerId||N(e._id)===l.ownerId&&e.userRoles?.admincontrol)&&a!==l.ownerId&&(this.useAuths&&(o=await this.checkAuthorization(e,l,"WRITE",i)),a=l.ownerId),o&&l.structType){this.collections[l.structType]||(this.collections[l.structType]={},this.collections[l.structType].reference={});let u=JSON.parse(JSON.stringify(l));u._id&&delete u._id,l._id?N(l._id).includes("defaultId")?(await this.db.collection(l.structType?l.structType:"data").insertOne(u),r=!0):l.structType==="notification"?await this.db.collection(l.structType?l.structType:"data").updateOne({_id:l._id},{$set:u,...c},{upsert:!0,unique:!1}):await this.db.collection(l.structType?l.structType:"data").updateOne({_id:K(l._id)},{$set:u,...c},{upsert:!0}):l.structType&&this.db.collection(l.structType?l.structType:"data").insertOne(u)}})),r===!0){let l=[];return await Promise.all(t.map(async(c,u)=>{let h=JSON.parse(JSON.stringify(c));if(h._id&&h.structType!=="profile"&&delete h._id,c.structType!=="comment"){let _;c.structType!=="notification"&&(_=await this.db.collection(h.structType).findOne(h)),_&&(_._id=N(_._id),l.push(_))}else if(c.structType==="comment"){let y=JSON.parse(JSON.stringify(c));y._id&&delete y._id;let b=await this.db.collection("comment").findOne(y),x=b?.replyTo,R=t.find(j=>{if(N(j._id)===x)return!0});if(R){let j=JSON.parse(JSON.stringify(R));j._id&&delete j._id;let z;if(await Promise.all(["discussion","chatroom","comment"].map(async E=>{let I=await this.db.collection(E).findOne({_id:K(x)});I&&(z=I)})),z){let E=N(b.parent._id),I,P;E!==x?(I=t.find(D=>{if(N(D._id)===E)return!0}),I&&(delete I._id,await Promise.all(["discussion","chatroom"].map(async D=>{let F=await this.db.collection(D).findOne(I);F&&(P=F)})))):P=z;let O=[b];z&&(z.replies.indexOf(N(b._id))<0&&(z.replies.push(N(b._id)),b.replyTo=N(z._id)),O.push(z)),P&&P.comments.indexOf(b._id)<0&&(P.comments.push(N(b._id)),b.parent._id=N(P._id)),await Promise.all(O.map(async D=>{let F=JSON.parse(JSON.stringify(D));delete F._id,await this.db.collection(D.structType).updateOne({_id:K(D._id)},{$set:F},{upsert:!1})})),[...l].reverse().forEach((D,F)=>{O.find(q=>{if(N(D._id)===N(q._id))return!0})&&l.splice(l.length-F-1,1)}),l.push(...O)}}else b&&l.push(b)}})),s&&this.checkToNotify(e,l),l}else{let l=[];return t.forEach(c=>{c.structType!=="notification"&&l.push(c)}),s&&this.checkToNotify(e,l),!0}}else return!1};setMongoUser=async(e,t,s)=>{if(t._id){let i=K(t._id),r={_id:i};if(await this.collections.profile.instance.findOne(r)&&(N(e._id)!==t.ownerId||N(e._id)===t.ownerId&&e.userRoles?.admincontrol)){let l=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(e,t,"WRITE",s)),!l)return!1}let a=JSON.parse(JSON.stringify(t));return a._id=i,this.debug&&console.log("RETURNS PROFILE",t),await this.collections.profile.instance.updateOne(r,{$set:a},{upsert:!0}),e=await this.collections.profile.instance.findOne(r),this.checkToNotify(e,[t]),e}else return!1};setGroup=async(e,t,s=this.mode,i)=>{if(t?._id){let r=N(e._id),o;if(s.includes("mongo")?o=await this.collections.group.instance.findOne({name:t.name}):o=this.getLocalData("group",{_id:N(t._id)}),o&&(o.ownerId!==t.ownerId||t.admins.indexOf(r)<0))return!1;if(r!==t.ownerId){let b=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?b=!0:this.useAuths&&(b=await this.checkAuthorization(e,t,"WRITE",i)),!b)return!1}let a=[];Object.keys(t.users).forEach(b=>{a.push({email:b},{id:b},{username:b})});let l={},c={};if(s.includes("mongo")){let x=this.collections.profile.instance.find({$or:a}).toArray();x.length>0&&x.forEach(R=>{l[r]=R,c[r]=!0})}else a.forEach(b=>{let x=this.getLocalData("profile",b);x.length>0&&(l[N(x[0]._id)]=x[0],c[N(x[0]._id)]=!0)});t.users=c;let u={},h={},_={};Object.keys(l).forEach(b=>{let x=l[b];(t.admins[N(x._id)]||t.admins[x.email]||t.admins[x.username]||t.admins[t.ownerId])&&(u[N(x._id)]||(u[N(x._id)]=!0)),(t.peers[N(x._id)]||t.peers[x.email]||t.peers[x.username]||t.peers[t.ownerId])&&(h[N(x._id)]||(h[N(x._id)]=!0)),(t.clients[N(x._id)]||t.clients[x.email]||t.clients[x.username]||t.clients[t.ownerId])&&(_[N(x._id)]||(_[N(x._id)]=!0))}),t.admins=u,t.peers=h,t.clients=_;let y=JSON.parse(JSON.stringify(t));return y._id&&delete y._id,s.includes("mongo")?N(t._id).includes("defaultId")?(await this.db.collection(t.structType?t.structType:"data").insertOne(y),delete t._id,t=await this.db.collection(t.structType?t.structType:"data").findOne(t),t._id=N(t._id)):await this.collections.group.instance.updateOne({_id:K(t._id)},{$set:y},{upsert:!0}):this.setLocalData(t),this.checkToNotify(e,[t],this.mode),this.debug&&console.log("setGroup: user:",e,"output",t),t}else return!1};getMongoUser=(e,t="",s=!0,i=!1,r)=>new Promise(async o=>{let a=[{email:t},{id:t},{username:t}];try{a.push({_id:K(t)})}catch{console.log("error creating ObjectId with ",t)}let l=await this.collections.profile.instance.findOne({$or:a});if(!l||l==null)o(void 0);else if(l._id=N(l._id),l.ownerId||(l.ownerId=l._id),i)(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),l={username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id},o({user:l});else if(s){if(N(e._id)!==l._id||N(e._id)===l._id&&e.userRoles?.admincontrol){let x=!this.useAuths;this.useAuths&&(x=await this.checkAuthorization(e,l,"READ",r)),x||o(void 0)}let c=[],u=this.collections.authorization.instance.find({ownerId:l._id}),h=await u.toArray();u.toArray().length>0&&h.forEach(x=>c.push(x));let y=await this.collections.group.instance.find({users:{$all:[l._id]}}).toArray(),b=[];y.length>0&&y.forEach(x=>b.push(x)),o({user:l,authorizations:c,groups:b})}else(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),o({user:l})});queryUsers=(e,t="",s=0,i=0,r=!1,o)=>(typeof e=="string"&&(e=this.users[e]),e?new Promise(async a=>{let l={$regex:`^${t}`,$options:"i"},c=[{email:l},{username:l},{firstName:l},{lastName:l},{name:l}],u;if(this.mode.includes("mongo")){let h=this.collections.profile.instance.find({$or:c},{projection:Vt}).skip(i);s>0&&h.limit(s),await h,u=await h.toArray(),console.log(u)}else{u=[];for(let h=0;h<c.length;h++){let _=this.getLocalData("profile",c[h]);Array.isArray(_)?_.forEach(y=>{u.push({firstName:y.firstName,lastName:y.lastName,fullName:y.fullName,username:y.username,pictureUrl:y.pictureUrl})}):_&&u.push({firstName:_.firstName,lastName:_.lastName,fullName:_.fullName,username:_.username,pictureUrl:_.pictureUrl})}}if(r){let h=[],_=N(e._id);for(let y=0;y<u.length;y++){let b=u[y];if(b._id=N(b._id),_!==b._id||_===b._id&&e.userRoles?.admincontrol){let x=!this.useAuths;this.useAuths&&(x=await this.checkAuthorization(e,b,"READ",o)),x&&h.push(b)}}u=h}else if(this.useAccessTokens||this.useRefreshTokens){let h=this.getToken(e);if(!h||h!==o){a(!1);return}}a(u)}):Promise.resolve(void 0));getMongoUsersByIds=async(e,t=[],s)=>{let i=[];t.forEach(o=>{try{i.push({_id:K(o)})}catch{}});let r=[];if(i.length>0){let a=await this.collections.profile.instance.find({$or:i}).toArray();a.length>0&&a.forEach(l=>{s?r.push({username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id}):r.push(l)})}return r};getMongoUsersByRole=async(e,t)=>{let s=this.collections.profile.instance.find({userRoles:{$all:{[t]:!0}}}),i=[],r=await s.toArray();return r.length>0&&r.forEach(o=>{i.push(o)}),i};getMongoDataByIds=async(e,t,s,i,r)=>{let o=N(e._id);if(t.length>0){let a=[];t.forEach(c=>{let u={_id:K(c)};s&&(u.ownerId=s),a.push(u)});let l=[];if(!i)await Promise.all(Object.keys(this.collections).map(async c=>{let h=await(await this.db.collection(c).find({$or:a})).toArray();if(h.length>0){let _=!0,y="";for(let b=0;b<h.length;b++){let x=h[b];x?.ownerId?(o!==x.ownerId||o===x.ownerId&&e.userRoles?.admincontrol)&&y!==x.ownerId&&(this.useAuths&&(_=await this.checkAuthorization(e,x,"READ",r)),y=x.ownerId):_=!0,_&&l.push(x)}}}));else{let u=await(await this.db.collection(i).find({$or:a})).toArray();if(u.length>0){let h=!0,_="";u.forEach(async y=>{y?.ownerId?(o!==y.ownerId||o===y.ownerId&&e.userRoles?.admincontrol)&&_!==y.ownerId&&(this.useAuths&&(h=await this.checkAuthorization(e,y,"READ",r)),_=y.ownerId):h=!0,h&&l.push(y)})}}return l}};getMongoData=async(e,t,s,i={},r=0,o=0,a)=>{s||(s=i?.ownerId),i||(i={}),i._id&&(i._id=K(i._id));let l=N(e._id),c=[],u=!0,h="",_;if(!t&&!s&&!i)return[];if(!t&&s&&Object.keys(i).length===0)return await this.getAllUserMongoData(e,s);if((!i||Object.keys(i).length===0)&&s&&t?_=this.db.collection(t).find({ownerId:s}).sort({$natural:-1}).skip(o):t&&Object.keys(i).length>0&&(s&&(i.ownerId=s),_=await this.db.collection(t).find(i).sort({$natural:-1}).skip(o)),_){r>0&&_.limit(r);let y=await _.toArray();if(y.length>0)for(let b=0;b<y.length;b++){let x=y[b];x?.ownerId?(l!==x.ownerId||l===x.ownerId&&e.userRoles?.admincontrol)&&h!==x.ownerId&&(this.useAuths&&(u=await this.checkAuthorization(e,x,"READ",a)),h=x.ownerId):u=!0,u===!0&&c.push(x)}}else!t&&Object.keys(i).length>0&&!s&&await Promise.all(Object.keys(this.collections).map(async y=>{if(_=await this.db.collection(y).find(i).sort({$natural:-1}).skip(o),_){r>0&&_.limit(r);let b=await _.toArray();if(b.length>0)for(let x=0;x<b.length;x++){let R=b[x];R?.ownerId?(l!==R.ownerId||l===R.ownerId&&e.userRoles?.admincontrol)&&h!==R.ownerId&&(this.useAuths&&(u=await this.checkAuthorization(e,R,"READ",a)),h=R.ownerId):u=!0,u===!0&&c.push(R)}}}));return u?c:[]};getAllUserMongoData=async(e,t,s=[],i,r)=>{let o=[],a=!0,l="";return await Promise.all(Object.keys(this.collections).map(async(c,u)=>{if(a&&s.indexOf(c)<0){let h={ownerId:t};i&&(typeof i[0]=="string"&&(i[0]=ge(i[0])),typeof i[1]=="string"&&(i[1]=ge(i[1])),h.timestamp={$gt:i[0],$lt:i[1]});let y=await this.db.collection(c).find(h).toArray(),b=y.length;for(let x=0;x<b;x++){let R=y[x];t?(N(e._id)!==t||N(e._id)===t&&e.userRoles?.admincontrol)&&l!==t&&(this.useAuths&&(a=await this.checkAuthorization(e,R,"READ",r)),l=t):a=!0,a&&o.push(R)}}})),a?o:[]};getMongoDataByRefs=async(e,t=[],s)=>{let i=[];if(i.length>0){let r="";t.forEach(async o=>{if(o.structType&&N(o._id)){let a=await this.db.collection(o.structType).findOne({_id:K(o._id)});if(a){let l=!0;!a?.ownerId||a.ownerId===e._id?l=!0:(N(e._id)!==a.ownerId||N(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&r!==a.ownerId&&(this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",s)),r=a.ownerId),l===!0&&i.push(a)}}})}return i};getMongoAuthorizations=async(e,t=N(e._id),s="",i)=>{let r=[];if(s.length===0){let a=await this.collections.authorization.instance.find({ownerId:t}).toArray();a.length>0&&a.forEach(l=>{r.push(l)})}else r.push(await this.collections.authorization.instance.findOne({_id:K(s),ownerId:t}));if(r[0]?.ownerId){if(N(e._id)!==r[0]?.ownerId){let o=!this.useAuths;if(this.useAuths&&(o=await this.checkAuthorization(e,r[0],"READ",i)),!o)return}}return r};getMongoGroups=async(e,t=N(e._id),s="")=>{let i=[];if(s.length===0){let o=await this.collections.group.instance.find({users:{$all:[t]}}).toArray();o.length>0&&o.forEach(a=>{i.push(a)})}else try{i.push(await this.collections.group.instance.findOne({_id:K(s),users:{$all:[t]}}))}catch{}return i};deleteMongoData=async(e,t=[],s)=>{let i=[];await Promise.all(t.map(async o=>{try{let a=K(o._id),l=await this.db.collection(o.structType).findOne({_id:a});if(l){i.push(l);let c=await this.collections.notifications.instance.find({parent:{structType:o.structType,_id:N(o._id)}}),u=c.toArray().length;for(let h=0;h<u;h++){let _=await c.next();_&&i.push(_)}}}catch{}}));let r="";return await Promise.all(i.map(async(o,a)=>{let l=!0;!o?.ownerId||o.ownerId===e._id?l=!0:(o.ownerId!==N(e._id)||N(e._id)===o.ownerId&&e.userRoles?.admincontrol)&&o.ownerId!==r&&(r=o.ownerId,this.useAuths&&(l=await this.checkAuthorization(e,o,"WRITE",s))),l&&(await this.db.collection(o.structType?o.structType:"data").deleteOne({_id:K(o._id)}),o.users&&Object.keys(o.users).forEach(c=>{c!==N(e._id)&&c!==o.ownerId&&this.users[c]&&this.users[c]?.sendAll({route:"structDeleted",args:{_id:N(o._id),structType:o.structType}})}),o.ownerId!==e._id&&this.users[o.ownerId]&&this.users[o.ownerId]?.sendAll({route:"structDeleted",args:{_id:N(o._id),structType:o.structType}}))})),!0};deleteMongoUser=async(e,t,s,i)=>{if(N(e._id)!==t||N(e._id)===t&&e.userRoles?.admincontrol){let r=await this.collections.profile.instance.findOne({id:t}),o=!this.useAuths;if(r?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,r,"WRITE",i)):o=!0,!o)return!1}if(await this.collections.profile.instance.deleteOne({id:t}),s)for(let r in this.collections)this.collections[r].instance.deleteMany({ownerId:t}),this.collections[r].instance.updateMany({users:{[t]:!0}},{$unset:{[`users.${t}`]:""}});return N(e._id)!==t&&this.users[t]&&this.users[t]?.sendAll({route:"structDeleted",args:{_id:t,structType:"profile"}}),!0};deleteMongoGroup=async(e,t,s)=>{let i=await this.collections.group.instance.findOne({_id:K(t)});if(i){if(i?.ownerId){if(N(e._id)!==i.ownerId||N(e._id)===i.ownerId&&e.userRoles?.admincontrol){let r=!this.useAuths;if(this.useAuths&&(r=await this.checkAuthorization(e,i,"WRITE",s)),!r)return!1}}return i.users&&Object.keys(i.users).forEach(r=>{this.users[r]?.sendAll({route:"structDeleted",args:{_id:N(i._id),structType:i.structType}})}),await this.collections.group.instance.deleteOne({_id:K(t)}),!0}else return!1};deleteMongoAuthorization=async(e,t,s)=>{let i=await this.collections.authorization.instance.findOne({_id:K(t)}),r=N(e._id);if(i){if(r!==i.ownerId||r===i.ownerId&&e.userRoles?.admincontrol){let o=!this.useAuths;if(i?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,i,"WRITE",s)):o=!0,!o)return!1}return i.associatedAuthId&&(this.debug&&console.log(i),await this.collections.authorization.instance.deleteOne({_id:K(i.associatedAuthId)}),i.authorizerId!==r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:N(i.associatedAuthId),structType:i.structType}}):i.authorizedId!==r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:N(i.associatedAuthId),structType:i.structType}})),await this.collections.authorization.instance.deleteOne({_id:K(t)}),i.authorizerId===r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:N(i._id),structType:i.structType}}):i.authorizedId===r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:N(i._id),structType:i.structType}}),!0}else return!1};setAuthorization=async(e,t,s)=>{let i,r,o=this.mode.includes("mongo");if(o?(i=(await this.getMongoUser(e,t.authorizedId,!1)).user,r=(await this.getMongoUser(e,t.authorizerId,!1)).user):(i=this.getLocalData("profile",{_id:t.authorizedId})?.[0],r=this.getLocalData("profile",{_id:t.authorizerId})?.[0]),!i||!r)return!1;if(t.authorizedId!==N(i._id)&&(t.authorizedId=N(i._id)),t.authorizerId!==N(r._id)&&(t.authorizerId=N(r._id)),t.authorizedName||(i.name?t.authorizedName=i.name:i.username?t.authorizedName=i.username:i.email&&(t.authorizedName=i.email)),t.authorizerName||(i.name?t.authorizedName=i.name:r.username?t.authorizerName=r.username:r.email&&(t.authorizerName=r.email)),t?.ownerId){if((N(e._id)!==t.ownerId||N(e._id)===t.ownerId&&e.userRoles?.admincontrol)&&N(e._id)!==t.authorizedId&&N(e._id)!==t.authorizerId){let u=!this.useAuths;if(this.useAuths&&(u=await this.checkAuthorization(e,t,"WRITE",s)),!u)return!1}}let a=[];if(o){let h=await(await this.collections.authorization.instance.find({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId}]})).toArray();h.length>0&&h.forEach(_=>a.push(_))}else{let u=this.getLocalData("authorization",{authorizedId:t.authorizedId});Array.isArray(u)&&u.forEach(h=>{h.authorizerId===t.authorizerId&&a.push(h)})}let l;if(Array.isArray(a))for(let u=0;u<a.length;u++){let h=a[u];if(h.ownerId!==N(e._id)){t.authorizerId===N(e._id)?(h.authorizations=t.authorizations,h.structs=t.structs,h.excluded=t.excluded,h.expires=t.expires,h.status="OKAY",t.status="OKAY"):(t.authorizations=h.authorizations,t.structs=h.structs,t.excluded=h.excluded,t.expires=h.expires,h.status="OKAY",t.status="OKAY"),t.associatedAuthId=N(h._id),h.associatedAuthId=N(t._id),l=h;let _=JSON.parse(JSON.stringify(h));o?(delete _._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:h.ownerId}]},{$set:_},{upsert:!0})):this.setLocalData(_)}}let c=JSON.parse(JSON.stringify(t));if(o?(delete c._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:t.ownerId}]},{$set:c},{upsert:!0})):this.setLocalData(c),N(t._id).includes("defaultId")&&o){let u=await this.collections.authorization.instance.findOne(c);if(u&&(t._id=N(u._id),l)){let h=await this.collections.authorization.instance.findOne({$and:[{authorizedId:l.authorizedId},{authorizerId:l.authorizerId},{ownerId:l.ownerId}]});if(h){h.associatedAuthId=N(t._id);let _=JSON.parse(JSON.stringify(h));delete _._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:h.authorizedId},{authorizerId:h.authorizerId},{ownerId:h.ownerId}]},{$set:_},{upsert:!0}),this.checkToNotify(e,[h])}}}return t};checkAuthorization=async(e,t,s="READ",i)=>{if(typeof e=="string"&&(this.users[e]?e=this.users[e]:e={_id:e}),!e||!t)return!1;if(!t.ownerId)return!0;if(typeof e=="object"&&t.ownerId===N(e._id))return e.userRoles?.admincontrol,!0;if(this.useAccessTokens){if(!this.accessTokens.get(e._id)||this.accessTokens.get(e._id)!==i)return!1}else if(this.useRefreshTokens&&(!this.refreshTokens.get(e._id)||this.refreshTokens.get(e._id)!==i))return!1;let r,o;if(this.mode.includes("mongo")){if(r=await this.collections.authorization.instance.findOne({$or:[{authorizedId:N(e._id),authorizerId:t.ownerId,ownerId:N(e._id)},{authorizedId:t.ownerId,authorizerId:N(e._id),ownerId:N(e._id)}]}),!r)return!1;o=await this.collections.authorization.instance.findOne({$or:[{authorizedId:N(e._id),authorizerId:t.ownerId,ownerId:N(t.ownerId)},{authorizedId:t.ownerId,authorizerId:N(e._id),ownerId:N(t.ownerId)}]})}else r=this.getLocalData("authorization",{ownerId:N(e._id)}).find(l=>{if(l.authorizedId===N(e._id)&&l.authorizerId===t.ownerId)return!0}),o=this.getLocalData("authorization",{ownerId:t.ownerId}).find(l=>{if(l.authorizedId===N(e._id)&&l.authorizerId===t.ownerId)return!0});if(!r||!o)return!1;let a=!1;return r.status==="OKAY"&&o.status==="OKAY"&&(t.structType==="group"?r.authorizations[t.name+"_admin"]&&o.authorizations[t.name+"_admin"]&&(a=!0):r.authorizations.peer&&o.authorizations.peer||r.authorizations.admincontrol&&o.authorizations.admincontrol||r.structIds[N(t._id)]&&o.structIds[N(t._id)]?a=!0:r.excluded[t.structType]&&t.ownerId===N(e._id)&&s==="WRITE"&&(a=!1)),a};wipeDB=async()=>(await Promise.all(Object.values(this.collections).map(e=>{try{e.instance.remove({})}catch{}})),!0);overwriteLocalData=e=>{if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:N(t._id)});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:N(e._id)});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}};setLocalData=e=>{let t=s=>{let i=s.structType,r=this.collections[i]?.reference;r||(r={},this.collections[i]||(this.collections[i]={}),this.collections[i].reference=r),r[N(s._id)]=s};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)};getLocalData=(e,t)=>{let s,i,r;if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return Object.values(this.collections).forEach(a=>{if(a=a.reference,(i==="_id"||i==="id")&&r){let l=a[r];l&&o.push(l)}else Object.values(a).forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections[e]?.reference;if(!a)return o;if(!i&&!s)return Object.values(a).forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return N(a[r]);Object.keys(a).forEach(l=>{let c=a[l];i&&r&&!s?c[i]===r&&o.push(c):s&&!i?c.ownerId===s&&o.push(c):s&&i&&r&&c.ownerId===s&&c[i]&&c[i]===r&&o.push(c)})}return o};deleteLocalData=e=>{if(!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.collections[e.structType]&&delete this.collections[e.structType].reference[e._id],!0)}},Vt=re.ProfileStruct();for(let n in Vt)n==="username"||n==="lastName"||n==="firstName"||n==="name"||n==="_id"||n==="pictureUrl"?Vt[n]=1:delete Vt[n];0&&(module.exports={AuthorizationStruct,CMDService,Callable,ChatroomStruct,CircularBuffer,CoherenceMap,CoherenceStruct,CommentStruct,DS,Data,DataStruct,DataTablet,DateStruct,DelayBuffer,DelayBufferManager,E2EEService,ECGStruct,EDAStruct,EEGCoordinates,EEGStruct,EMGStruct,EventHandler,EventStruct,EyeTrackerStruct,FNIRSStruct,FrequencyBandsStruct,Graph,GraphNode,GroupStruct,HRVStruct,HTTPbackend,IMUStruct,InputBuffer,NotificationStruct,PPGStruct,ProfileStruct,Router,SSEbackend,ScheduleStruct,Service,SessionManager,SessionService,Struct,StructBackend,StructFrontend,WSSbackend,animate,backprop,bindListener,branching,connectionHasId,defaultCollections,defaultManifest,defaultServiceWorker,defaultSpecifiers,eegCoordinates,genTimeSpecifiers,genTimestampFromString,getAllProperties,getCallbackFromString,getFnParamNames,getFunctionHead,getStringId,htmlBodyBoilerPlate,instanceObject,isFunction,isNativeClass,isTypedArray,loaders,loop,methodstrings,parseFunctionFromText,pseudoObjectId,randomId,reconstructObject,recursivelyAssign,recursivelyStringifyFunctions,scriptBoilerPlate,setCoordinate,spliceTypedArray,state,stringifyFast,stringifyWithCircularRefs,stringifyWithFunctionsAndCircularRefs,structRegistry,substitute__operator,toObjectId,transformListenerResult,triggerListenerOncreate,wrapArgs});
