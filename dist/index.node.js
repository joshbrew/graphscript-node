var Sr=Object.create;var He=Object.defineProperty;var vr=Object.getOwnPropertyDescriptor;var wr=Object.getOwnPropertyNames;var kr=Object.getPrototypeOf,xr=Object.prototype.hasOwnProperty;var z=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Ms=(n,e)=>{for(var t in e)He(n,t,{get:e[t],enumerable:!0})},Rs=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of wr(e))!xr.call(n,i)&&i!==t&&He(n,i,{get:()=>e[i],enumerable:!(s=vr(e,i))||s.enumerable});return n};var J=(n,e,t)=>(t=n!=null?Sr(kr(n)):{},Rs(e||!n||!n.__esModule?He(t,"default",{value:n,enumerable:!0}):t,n)),Ar=n=>Rs(He({},"__esModule",{value:!0}),n);var ri=z((lt,$t)=>{(function(n,e){if(typeof lt=="object"&&typeof $t=="object")$t.exports=e();else if(typeof define=="function"&&define.amd)define([],e);else{var t=e();for(var s in t)(typeof lt=="object"?lt:n)[s]=t[s]}})(global,()=>(()=>{"use strict";var n={n:m=>{var _=m&&m.__esModule?()=>m.default:()=>m;return n.d(_,{a:_}),_},d:(m,_)=>{for(var k in _)n.o(_,k)&&!n.o(m,k)&&Object.defineProperty(m,k,{enumerable:!0,get:_[k]})},o:(m,_)=>Object.prototype.hasOwnProperty.call(m,_),r:m=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(m,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(m,"__esModule",{value:!0})}},e={};n.r(e),n.d(e,{Channel:()=>A,EventBuffer:()=>c,Session:()=>x,SseError:()=>y,createChannel:()=>b,createEventBuffer:()=>w,createSession:()=>v});let t=require("http"),s=m=>JSON.stringify(m),i=/(\r\n|\r|\n)/g,r=/\n+$/g,o=m=>{let _=m;return _=_.replace(i,`
`),_=_.replace(r,""),_},a=require("crypto"),l;l=a.randomUUID?()=>(0,a.randomUUID)():()=>(0,a.randomBytes)(4).toString("hex");let f=m=>async(_,k={})=>{let{eventName:O="stream"}=k;return await new Promise((T,L)=>{_.on("data",M=>{let ie;ie=Buffer.isBuffer(M)?M.toString():M,m(ie,O)}),_.once("end",()=>T(!0)),_.once("close",()=>T(!0)),_.once("error",M=>L(M))})},h=m=>async(_,k={})=>{let{eventName:O="iteration"}=k;for await(let T of _)m(T,O)};class c{constructor(_={}){var k,O;this.buffer="",this.writeField=(T,L)=>{let M=this.sanitize(L);return this.buffer+=T+":"+M+`
`,this},this.data=T=>{let L=this.serialize(T);return this.writeField("data",L),this},this.id=(T="")=>(this.writeField("id",T),this),this.retry=T=>{let L=T.toString();return this.writeField("retry",L),this},this.comment=(T="")=>(this.writeField("",T),this),this.dispatch=()=>(this.buffer+=`
`,this),this.push=(T,L="message",M=l())=>(this.event(L).id(M).data(T).dispatch(),this),this.stream=f(this.push),this.iterate=h(this.push),this.clear=()=>(this.buffer="",this),this.read=()=>this.buffer,this.serialize=(k=_.serializer)!==null&&k!==void 0?k:s,this.sanitize=(O=_.sanitizer)!==null&&O!==void 0?O:o}event(_){return this.writeField("event",_),this}}let u=require("events");var d=n.n(u);class g extends d(){addListener(_,k){return super.addListener(_,k)}prependListener(_,k){return super.prependListener(_,k)}prependOnceListener(_,k){return super.prependOnceListener(_,k)}on(_,k){return super.on(_,k)}once(_,k){return super.once(_,k)}emit(_,...k){return super.emit(_,...k)}off(_,k){return super.off(_,k)}removeListener(_,k){return super.removeListener(_,k)}}class y extends Error{constructor(_){super(_),this.message=`better-sse: ${_}`}}class x extends g{constructor(_,k,O={}){var T,L,M,ie,Et,Ct,Nt;super(),this.lastId="",this.isConnected=!1,this.state={},this.initialize=()=>{var U,X,ce;let br=`http://${this.req.headers.host}${this.req.url}`,We=new URL(br).searchParams;if(this.trustClientEventId){let It=(ce=(X=(U=this.req.headers["last-event-id"])!==null&&U!==void 0?U:We.get("lastEventId"))!==null&&X!==void 0?X:We.get("evs_last_event_id"))!==null&&ce!==void 0?ce:"";this.lastId=It}let H={};this.res instanceof t.ServerResponse?(H["Content-Type"]="text/event-stream",H["Cache-Control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",H.Connection="keep-alive",H.Pragma="no-cache",H["X-Accel-Buffering"]="no"):(H["content-type"]="text/event-stream",H["cache-control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",H.pragma="no-cache",H["x-accel-buffering"]="no");for(let[It,js]of Object.entries(this.headers))H[It]=js??"";this.res.writeHead(this.statusCode,H),We.has("padding")&&this.buffer.comment(" ".repeat(2049)).dispatch(),We.has("evs_preamble")&&this.buffer.comment(" ".repeat(2056)).dispatch(),this.initialRetry!==null&&this.buffer.retry(this.initialRetry).dispatch(),this.flush(),this.keepAliveInterval!==null&&(this.keepAliveTimer=setInterval(this.keepAlive,this.keepAliveInterval)),this.isConnected=!0,this.emit("connected")},this.onDisconnected=()=>{this.req.removeListener("close",this.onDisconnected),this.res.removeListener("close",this.onDisconnected),this.keepAliveTimer&&clearInterval(this.keepAliveTimer),this.isConnected=!1,this.emit("disconnected")},this.keepAlive=()=>{this.buffer.comment().dispatch(),this.flush()},this.data=U=>(this.buffer.data(U),this),this.id=(U="")=>(this.buffer.id(U),this.lastId=U,this),this.retry=U=>(this.buffer.retry(U),this),this.comment=U=>(this.buffer.comment(U),this),this.dispatch=()=>(this.buffer.dispatch(),this),this.flush=()=>(this.res.write(this.buffer.read()),this.buffer.clear(),this),this.push=(U,X="message",ce=l())=>{if(!this.isConnected)throw new y("Cannot push data to a non-active session.");return this.buffer.push(U,X,ce),this.flush(),this.lastId=ce,this.emit("push",U,X,ce),this},this.stream=f(this.push),this.iterate=h(this.push),this.batch=async U=>{if(U instanceof c)this.res.write(U.read());else{let X=new c({serializer:this.serialize,sanitizer:this.sanitize});await U(X),this.res.write(X.read())}},this.req=_,this.res=k;let Us=(T=O.serializer)!==null&&T!==void 0?T:s,Ls=(L=O.sanitizer)!==null&&L!==void 0?L:o;this.serialize=Us,this.sanitize=Ls,this.buffer=new c({serializer:Us,sanitizer:Ls}),this.trustClientEventId=(M=O.trustClientEventId)===null||M===void 0||M,this.initialRetry=O.retry===null?null:(ie=O.retry)!==null&&ie!==void 0?ie:2e3,this.keepAliveInterval=O.keepAlive===null?null:(Et=O.keepAlive)!==null&&Et!==void 0?Et:1e4,this.statusCode=(Ct=O.statusCode)!==null&&Ct!==void 0?Ct:200,this.headers=(Nt=O.headers)!==null&&Nt!==void 0?Nt:{},this.req.once("close",this.onDisconnected),this.res.once("close",this.onDisconnected),setImmediate(this.initialize)}event(_){return this.buffer.event(_),this}}let v=(...m)=>new Promise(_=>{let k=new x(...m);k.once("connected",()=>{_(k)})});class A extends g{constructor(){super(),this.state={},this.sessions=new Set,this.broadcast=(_,k="message",O={})=>{var T;let L=(T=O.eventId)!==null&&T!==void 0?T:l(),M=O.filter?this.activeSessions.filter(O.filter):this.sessions;for(let ie of M)ie.push(_,k,L);return this.emit("broadcast",_,k,L),this}}get activeSessions(){return Array.from(this.sessions)}get sessionCount(){return this.sessions.size}register(_){if(this.sessions.has(_))return this;if(!_.isConnected)throw new y("Cannot register a non-active session.");return _.once("disconnected",()=>{this.emit("session-disconnected",_),this.deregister(_)}),this.sessions.add(_),this.emit("session-registered",_),this}deregister(_){return this.sessions.has(_)?(this.sessions.delete(_),this.emit("session-deregistered",_),this):this}}let b=(...m)=>new A(...m),w=(...m)=>new c(...m);return e})())});var li=z((oa,ai)=>{"use strict";var{Duplex:Dr}=require("stream");function ni(n){n.emit("close")}function Ur(){!this.destroyed&&this._writableState.finished&&this.destroy()}function oi(n){this.removeListener("error",oi),this.destroy(),this.listenerCount("error")===0&&this.emit("error",n)}function Lr(n,e){let t=!0,s=new Dr({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return n.on("message",function(r,o){let a=!o&&s._readableState.objectMode?r.toString():r;s.push(a)||n.pause()}),n.once("error",function(r){s.destroyed||(t=!1,s.destroy(r))}),n.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(i,r){if(n.readyState===n.CLOSED){r(i),process.nextTick(ni,s);return}let o=!1;n.once("error",function(l){o=!0,r(l)}),n.once("close",function(){o||r(i),process.nextTick(ni,s)}),t&&n.terminate()},s._final=function(i){if(n.readyState===n.CONNECTING){n.once("open",function(){s._final(i)});return}n._socket!==null&&(n._socket._writableState.finished?(i(),s._readableState.endEmitted&&s.destroy()):(n._socket.once("finish",function(){i()}),n.close()))},s._read=function(){n.isPaused&&n.resume()},s._write=function(i,r,o){if(n.readyState===n.CONNECTING){n.once("open",function(){s._write(i,r,o)});return}n.send(i,o)},s.on("end",Ur),s.on("error",oi),s}ai.exports=Lr});var re=z((aa,fi)=>{"use strict";fi.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Ce=z((la,ct)=>{"use strict";var{EMPTY_BUFFER:jr}=re(),Ht=Buffer[Symbol.species];function Mr(n,e){if(n.length===0)return jr;if(n.length===1)return n[0];let t=Buffer.allocUnsafe(e),s=0;for(let i=0;i<n.length;i++){let r=n[i];t.set(r,s),s+=r.length}return s<e?new Ht(t.buffer,t.byteOffset,s):t}function ci(n,e,t,s,i){for(let r=0;r<i;r++)t[s+r]=n[r]^e[r&3]}function hi(n,e){for(let t=0;t<n.length;t++)n[t]^=e[t&3]}function Rr(n){return n.length===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.length)}function Jt(n){if(Jt.readOnly=!0,Buffer.isBuffer(n))return n;let e;return n instanceof ArrayBuffer?e=new Ht(n):ArrayBuffer.isView(n)?e=new Ht(n.buffer,n.byteOffset,n.byteLength):(e=Buffer.from(n),Jt.readOnly=!1),e}ct.exports={concat:Mr,mask:ci,toArrayBuffer:Rr,toBuffer:Jt,unmask:hi};if(!process.env.WS_NO_BUFFER_UTIL)try{let n=require("bufferutil");ct.exports.mask=function(e,t,s,i,r){r<48?ci(e,t,s,i,r):n.mask(e,t,s,i,r)},ct.exports.unmask=function(e,t){e.length<32?hi(e,t):n.unmask(e,t)}}catch{}});var gi=z((fa,di)=>{"use strict";var ui=Symbol("kDone"),Vt=Symbol("kRun"),Yt=class{constructor(e){this[ui]=()=>{this.pending--,this[Vt]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Vt]()}[Vt](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[ui])}}};di.exports=Yt});var De=z((ca,mi)=>{"use strict";var Ne=require("zlib"),pi=Ce(),zr=gi(),{kStatusCode:yi}=re(),Br=Buffer[Symbol.species],Fr=Buffer.from([0,0,255,255]),dt=Symbol("permessage-deflate"),Q=Symbol("total-length"),Ie=Symbol("callback"),ne=Symbol("buffers"),ut=Symbol("error"),ht,Kt=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!ht){let i=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;ht=new zr(i)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[Ie];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(i=>!(t.serverNoContextTakeover===!1&&i.server_no_context_takeover||i.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>i.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!i.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let i=t[s];if(i.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(i=i[0],s==="client_max_window_bits"){if(i!==!0){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else if(s==="server_max_window_bits"){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(i!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=i})}),e}decompress(e,t,s){ht.add(i=>{this._decompress(e,t,(r,o)=>{i(),s(r,o)})})}compress(e,t,s){ht.add(i=>{this._compress(e,t,(r,o)=>{i(),s(r,o)})})}_decompress(e,t,s){let i=this._isServer?"client":"server";if(!this._inflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ne.Z_DEFAULT_WINDOWBITS:this.params[r];this._inflate=Ne.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[dt]=this,this._inflate[Q]=0,this._inflate[ne]=[],this._inflate.on("error",qr),this._inflate.on("data",_i)}this._inflate[Ie]=s,this._inflate.write(e),t&&this._inflate.write(Fr),this._inflate.flush(()=>{let r=this._inflate[ut];if(r){this._inflate.close(),this._inflate=null,s(r);return}let o=pi.concat(this._inflate[ne],this._inflate[Q]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[Q]=0,this._inflate[ne]=[],t&&this.params[`${i}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let i=this._isServer?"server":"client";if(!this._deflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ne.Z_DEFAULT_WINDOWBITS:this.params[r];this._deflate=Ne.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[Q]=0,this._deflate[ne]=[],this._deflate.on("data",Gr)}this._deflate[Ie]=s,this._deflate.write(e),this._deflate.flush(Ne.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let r=pi.concat(this._deflate[ne],this._deflate[Q]);t&&(r=new Br(r.buffer,r.byteOffset,r.length-4)),this._deflate[Ie]=null,this._deflate[Q]=0,this._deflate[ne]=[],t&&this.params[`${i}_no_context_takeover`]&&this._deflate.reset(),s(null,r)})}};mi.exports=Kt;function Gr(n){this[ne].push(n),this[Q]+=n.length}function _i(n){if(this[Q]+=n.length,this[dt]._maxPayload<1||this[Q]<=this[dt]._maxPayload){this[ne].push(n);return}this[ut]=new RangeError("Max payload size exceeded"),this[ut].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[ut][yi]=1009,this.removeListener("data",_i),this.reset()}function qr(n){this[dt]._inflate=null,n[yi]=1007,this[Ie](n)}});var Ue=z((ha,gt)=>{"use strict";var{isUtf8:bi}=require("buffer"),$r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function Wr(n){return n>=1e3&&n<=1014&&n!==1004&&n!==1005&&n!==1006||n>=3e3&&n<=4999}function Zt(n){let e=n.length,t=0;for(;t<e;)if(!(n[t]&128))t++;else if((n[t]&224)===192){if(t+1===e||(n[t+1]&192)!==128||(n[t]&254)===192)return!1;t+=2}else if((n[t]&240)===224){if(t+2>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||n[t]===224&&(n[t+1]&224)===128||n[t]===237&&(n[t+1]&224)===160)return!1;t+=3}else if((n[t]&248)===240){if(t+3>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||(n[t+3]&192)!==128||n[t]===240&&(n[t+1]&240)===128||n[t]===244&&n[t+1]>143||n[t]>244)return!1;t+=4}else return!1;return!0}gt.exports={isValidStatusCode:Wr,isValidUTF8:Zt,tokenChars:$r};if(bi)gt.exports.isValidUTF8=function(n){return n.length<24?Zt(n):bi(n)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let n=require("utf-8-validate");gt.exports.isValidUTF8=function(e){return e.length<32?Zt(e):n(e)}}catch{}});var ss=z((ua,Oi)=>{"use strict";var{Writable:Hr}=require("stream"),Si=De(),{BINARY_TYPES:Jr,EMPTY_BUFFER:vi,kStatusCode:Vr,kWebSocket:Yr}=re(),{concat:Xt,toArrayBuffer:Kr,unmask:Zr}=Ce(),{isValidStatusCode:Xr,isValidUTF8:wi}=Ue(),pt=Buffer[Symbol.species],W=0,ki=1,xi=2,Ai=3,Qt=4,es=5,yt=6,ts=class extends Hr{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||Jr[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[Yr]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=W}_write(e,t,s){if(this._opcode===8&&this._state==W)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new pt(s.buffer,s.byteOffset+e,s.length-e),new pt(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],i=t.length-e;e>=s.length?t.set(this._buffers.shift(),i):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),i),this._buffers[0]=new pt(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case W:this.getInfo(e);break;case ki:this.getPayloadLength16(e);break;case xi:this.getPayloadLength64(e);break;case Ai:this.getMask();break;case Qt:this.getData(e);break;case es:case yt:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48){let i=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(i);return}let s=(t[0]&64)===64;if(s&&!this._extensions[Si.extensionName]){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(!this._fragmented){let i=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let i=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(i);return}if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let i=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(i);return}}else{let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let i=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(i);return}}else if(this._masked){let i=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(i);return}this._payloadLength===126?this._state=ki:this._payloadLength===127?this._state=xi:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let i=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(i);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=Ai:this._state=Qt}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=Qt}getData(e){let t=vi;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Zr(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=es,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[Si.extensionName].decompress(e,this._fin,(i,r)=>{if(i)return t(i);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(r)}this.dataMessage(t),this._state===W&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=W;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let i;this._binaryType==="nodebuffer"?i=Xt(s,t):this._binaryType==="arraybuffer"?i=Kr(Xt(s,t)):i=s,this._allowSynchronousEvents?(this.emit("message",i,!0),this._state=W):(this._state=yt,setImmediate(()=>{this.emit("message",i,!0),this._state=W,this.startLoop(e)}))}else{let i=Xt(s,t);if(!this._skipUTF8Validation&&!wi(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(r);return}this._state===es||this._allowSynchronousEvents?(this.emit("message",i,!1),this._state=W):(this._state=yt,setImmediate(()=>{this.emit("message",i,!1),this._state=W,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,vi),this.end();else{let s=e.readUInt16BE(0);if(!Xr(s)){let r=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(r);return}let i=new pt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!wi(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(r);return}this._loop=!1,this.emit("conclude",s,i),this.end()}this._state=W;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=W):(this._state=yt,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=W,this.startLoop(t)}))}createError(e,t,s,i,r){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=r,o[Vr]=i,o}};Oi.exports=ts});var rs=z((ga,Ei)=>{"use strict";var{Duplex:da}=require("stream"),{randomFillSync:Qr}=require("crypto"),Ti=De(),{EMPTY_BUFFER:en}=re(),{isValidStatusCode:tn}=Ue(),{mask:Pi,toBuffer:ye}=Ce(),Y=Symbol("kByteLength"),sn=Buffer.alloc(4),_t=8*1024,he,_e=_t,is=class n{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let s,i=!1,r=2,o=!1;t.mask&&(s=t.maskBuffer||sn,t.generateMask?t.generateMask(s):(_e===_t&&(he===void 0&&(he=Buffer.alloc(_t)),Qr(he,0,_t),_e=0),s[0]=he[_e++],s[1]=he[_e++],s[2]=he[_e++],s[3]=he[_e++]),o=(s[0]|s[1]|s[2]|s[3])===0,r=6);let a;typeof e=="string"?(!t.mask||o)&&t[Y]!==void 0?a=t[Y]:(e=Buffer.from(e),a=e.length):(a=e.length,i=t.mask&&t.readOnly&&!o);let l=a;a>=65536?(r+=8,l=127):a>125&&(r+=2,l=126);let f=Buffer.allocUnsafe(i?a+r:r);return f[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(f[0]|=64),f[1]=l,l===126?f.writeUInt16BE(a,2):l===127&&(f[2]=f[3]=0,f.writeUIntBE(a,4,6)),t.mask?(f[1]|=128,f[r-4]=s[0],f[r-3]=s[1],f[r-2]=s[2],f[r-1]=s[3],o?[f,e]:i?(Pi(e,s,f,r,a),[f]):(Pi(e,s,e,0,a),[f,e])):[f,e]}close(e,t,s,i){let r;if(e===void 0)r=en;else{if(typeof e!="number"||!tn(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)r=Buffer.allocUnsafe(2),r.writeUInt16BE(e,0);else{let a=Buffer.byteLength(t);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");r=Buffer.allocUnsafe(2+a),r.writeUInt16BE(e,0),typeof t=="string"?r.write(t,2):r.set(t,2)}}let o={[Y]:r.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,r,!1,o,i]):this.sendFrame(n.frame(r,o),i)}ping(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=ye(e),i=e.length,r=ye.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[Y]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}pong(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=ye(e),i=e.length,r=ye.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[Y]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}send(e,t,s){let i=this._extensions[Ti.extensionName],r=t.binary?2:1,o=t.compress,a,l;if(typeof e=="string"?(a=Buffer.byteLength(e),l=!1):(e=ye(e),a=e.length,l=ye.readOnly),this._firstFragment?(this._firstFragment=!1,o&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=i._threshold),this._compress=o):(o=!1,r=0),t.fin&&(this._firstFragment=!0),i){let f={[Y]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:o};this._deflating?this.enqueue([this.dispatch,e,this._compress,f,s]):this.dispatch(e,this._compress,f,s)}else this.sendFrame(n.frame(e,{[Y]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:!1}),s)}dispatch(e,t,s,i){if(!t){this.sendFrame(n.frame(e,s),i);return}let r=this._extensions[Ti.extensionName];this._bufferedBytes+=s[Y],this._deflating=!0,r.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");typeof i=="function"&&i(l);for(let f=0;f<this._queue.length;f++){let h=this._queue[f],c=h[h.length-1];typeof c=="function"&&c(l)}return}this._bufferedBytes-=s[Y],this._deflating=!1,s.readOnly=!1,this.sendFrame(n.frame(a,s),i),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][Y],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][Y],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Ei.exports=is});var Ri=z((pa,Mi)=>{"use strict";var{kForOnEventAttribute:Le,kListener:ns}=re(),Ci=Symbol("kCode"),Ni=Symbol("kData"),Ii=Symbol("kError"),Di=Symbol("kMessage"),Ui=Symbol("kReason"),me=Symbol("kTarget"),Li=Symbol("kType"),ji=Symbol("kWasClean"),ee=class{constructor(e){this[me]=null,this[Li]=e}get target(){return this[me]}get type(){return this[Li]}};Object.defineProperty(ee.prototype,"target",{enumerable:!0});Object.defineProperty(ee.prototype,"type",{enumerable:!0});var ue=class extends ee{constructor(e,t={}){super(e),this[Ci]=t.code===void 0?0:t.code,this[Ui]=t.reason===void 0?"":t.reason,this[ji]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Ci]}get reason(){return this[Ui]}get wasClean(){return this[ji]}};Object.defineProperty(ue.prototype,"code",{enumerable:!0});Object.defineProperty(ue.prototype,"reason",{enumerable:!0});Object.defineProperty(ue.prototype,"wasClean",{enumerable:!0});var be=class extends ee{constructor(e,t={}){super(e),this[Ii]=t.error===void 0?null:t.error,this[Di]=t.message===void 0?"":t.message}get error(){return this[Ii]}get message(){return this[Di]}};Object.defineProperty(be.prototype,"error",{enumerable:!0});Object.defineProperty(be.prototype,"message",{enumerable:!0});var je=class extends ee{constructor(e,t={}){super(e),this[Ni]=t.data===void 0?null:t.data}get data(){return this[Ni]}};Object.defineProperty(je.prototype,"data",{enumerable:!0});var rn={addEventListener(n,e,t={}){for(let i of this.listeners(n))if(!t[Le]&&i[ns]===e&&!i[Le])return;let s;if(n==="message")s=function(r,o){let a=new je("message",{data:o?r:r.toString()});a[me]=this,mt(e,this,a)};else if(n==="close")s=function(r,o){let a=new ue("close",{code:r,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[me]=this,mt(e,this,a)};else if(n==="error")s=function(r){let o=new be("error",{error:r,message:r.message});o[me]=this,mt(e,this,o)};else if(n==="open")s=function(){let r=new ee("open");r[me]=this,mt(e,this,r)};else return;s[Le]=!!t[Le],s[ns]=e,t.once?this.once(n,s):this.on(n,s)},removeEventListener(n,e){for(let t of this.listeners(n))if(t[ns]===e&&!t[Le]){this.removeListener(n,t);break}}};Mi.exports={CloseEvent:ue,ErrorEvent:be,Event:ee,EventTarget:rn,MessageEvent:je};function mt(n,e,t){typeof n=="object"&&n.handleEvent?n.handleEvent.call(n,t):n.call(e,t)}});var os=z((ya,zi)=>{"use strict";var{tokenChars:Me}=Ue();function K(n,e,t){n[e]===void 0?n[e]=[t]:n[e].push(t)}function nn(n){let e=Object.create(null),t=Object.create(null),s=!1,i=!1,r=!1,o,a,l=-1,f=-1,h=-1,c=0;for(;c<n.length;c++)if(f=n.charCodeAt(c),o===void 0)if(h===-1&&Me[f]===1)l===-1&&(l=c);else if(c!==0&&(f===32||f===9))h===-1&&l!==-1&&(h=c);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${c}`);h===-1&&(h=c);let d=n.slice(l,h);f===44?(K(e,d,t),t=Object.create(null)):o=d,l=h=-1}else throw new SyntaxError(`Unexpected character at index ${c}`);else if(a===void 0)if(h===-1&&Me[f]===1)l===-1&&(l=c);else if(f===32||f===9)h===-1&&l!==-1&&(h=c);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${c}`);h===-1&&(h=c),K(t,n.slice(l,h),!0),f===44&&(K(e,o,t),t=Object.create(null),o=void 0),l=h=-1}else if(f===61&&l!==-1&&h===-1)a=n.slice(l,c),l=h=-1;else throw new SyntaxError(`Unexpected character at index ${c}`);else if(i){if(Me[f]!==1)throw new SyntaxError(`Unexpected character at index ${c}`);l===-1?l=c:s||(s=!0),i=!1}else if(r)if(Me[f]===1)l===-1&&(l=c);else if(f===34&&l!==-1)r=!1,h=c;else if(f===92)i=!0;else throw new SyntaxError(`Unexpected character at index ${c}`);else if(f===34&&n.charCodeAt(c-1)===61)r=!0;else if(h===-1&&Me[f]===1)l===-1&&(l=c);else if(l!==-1&&(f===32||f===9))h===-1&&(h=c);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${c}`);h===-1&&(h=c);let d=n.slice(l,h);s&&(d=d.replace(/\\/g,""),s=!1),K(t,a,d),f===44&&(K(e,o,t),t=Object.create(null),o=void 0),a=void 0,l=h=-1}else throw new SyntaxError(`Unexpected character at index ${c}`);if(l===-1||r||f===32||f===9)throw new SyntaxError("Unexpected end of input");h===-1&&(h=c);let u=n.slice(l,h);return o===void 0?K(e,u,t):(a===void 0?K(t,u,!0):s?K(t,a,u.replace(/\\/g,"")):K(t,a,u),K(e,o,t)),e}function on(n){return Object.keys(n).map(e=>{let t=n[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(i=>{let r=s[i];return Array.isArray(r)||(r=[r]),r.map(o=>o===!0?i:`${i}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}zi.exports={format:on,parse:nn}});var hs=z((ba,Ki)=>{"use strict";var an=require("events"),ln=require("https"),fn=require("http"),Gi=require("net"),cn=require("tls"),{randomBytes:hn,createHash:un}=require("crypto"),{Duplex:_a,Readable:ma}=require("stream"),{URL:as}=require("url"),oe=De(),dn=ss(),gn=rs(),{BINARY_TYPES:Bi,EMPTY_BUFFER:bt,GUID:pn,kForOnEventAttribute:ls,kListener:yn,kStatusCode:_n,kWebSocket:j,NOOP:qi}=re(),{EventTarget:{addEventListener:mn,removeEventListener:bn}}=Ri(),{format:Sn,parse:vn}=os(),{toBuffer:wn}=Ce(),kn=30*1e3,$i=Symbol("kAborted"),fs=[8,13],te=["CONNECTING","OPEN","CLOSING","CLOSED"],xn=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,N=class n extends an{constructor(e,t,s){super(),this._binaryType=Bi[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=bt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=n.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),Wi(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Bi.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let i=new dn({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation});this._sender=new gn(e,this._extensions,s.generateMask),this._receiver=i,this._socket=e,i[j]=this,e[j]=this,i.on("conclude",Tn),i.on("drain",Pn),i.on("error",En),i.on("message",Cn),i.on("ping",Nn),i.on("pong",In),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Ji),e.on("data",vt),e.on("end",Vi),e.on("error",Yi),this._readyState=n.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[oe.extensionName]&&this._extensions[oe.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){$(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===n.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=n.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),kn)}}pause(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){cs(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||bt,t,s)}pong(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){cs(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||bt,t,s)}resume(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){cs(this,e,s);return}let i={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[oe.extensionName]||(i.compress=!1),this._sender.send(e||bt,i,s)}terminate(){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){$(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=n.CLOSING,this._socket.destroy())}}};Object.defineProperty(N,"CONNECTING",{enumerable:!0,value:te.indexOf("CONNECTING")});Object.defineProperty(N.prototype,"CONNECTING",{enumerable:!0,value:te.indexOf("CONNECTING")});Object.defineProperty(N,"OPEN",{enumerable:!0,value:te.indexOf("OPEN")});Object.defineProperty(N.prototype,"OPEN",{enumerable:!0,value:te.indexOf("OPEN")});Object.defineProperty(N,"CLOSING",{enumerable:!0,value:te.indexOf("CLOSING")});Object.defineProperty(N.prototype,"CLOSING",{enumerable:!0,value:te.indexOf("CLOSING")});Object.defineProperty(N,"CLOSED",{enumerable:!0,value:te.indexOf("CLOSED")});Object.defineProperty(N.prototype,"CLOSED",{enumerable:!0,value:te.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(n=>{Object.defineProperty(N.prototype,n,{enumerable:!0})});["open","error","close","message"].forEach(n=>{Object.defineProperty(N.prototype,`on${n}`,{enumerable:!0,get(){for(let e of this.listeners(n))if(e[ls])return e[yn];return null},set(e){for(let t of this.listeners(n))if(t[ls]){this.removeListener(n,t);break}typeof e=="function"&&this.addEventListener(n,e,{[ls]:!0})}})});N.prototype.addEventListener=mn;N.prototype.removeEventListener=bn;Ki.exports=N;function Wi(n,e,t,s){let i={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:fs[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(n._autoPong=i.autoPong,!fs.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${fs.join(", ")})`);let r;if(e instanceof as)r=e;else try{r=new as(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}r.protocol==="http:"?r.protocol="ws:":r.protocol==="https:"&&(r.protocol="wss:"),n._url=r.href;let o=r.protocol==="wss:",a=r.protocol==="ws+unix:",l;if(r.protocol!=="ws:"&&!o&&!a?l=`The URL's protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"`:a&&!r.pathname?l="The URL's pathname is empty":r.hash&&(l="The URL contains a fragment identifier"),l){let y=new SyntaxError(l);if(n._redirects===0)throw y;St(n,y);return}let f=o?443:80,h=hn(16).toString("base64"),c=o?ln.request:fn.request,u=new Set,d;if(i.createConnection=i.createConnection||(o?On:An),i.defaultPort=i.defaultPort||f,i.port=r.port||f,i.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,i.headers={...i.headers,"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket"},i.path=r.pathname+r.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(d=new oe(i.perMessageDeflate!==!0?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=Sn({[oe.extensionName]:d.offer()})),t.length){for(let y of t){if(typeof y!="string"||!xn.test(y)||u.has(y))throw new SyntaxError("An invalid or duplicated subprotocol was specified");u.add(y)}i.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(r.username||r.password)&&(i.auth=`${r.username}:${r.password}`),a){let y=i.path.split(":");i.socketPath=y[0],i.path=y[1]}let g;if(i.followRedirects){if(n._redirects===0){n._originalIpc=a,n._originalSecure=o,n._originalHostOrSocketPath=a?i.socketPath:r.host;let y=s&&s.headers;if(s={...s,headers:{}},y)for(let[x,v]of Object.entries(y))s.headers[x.toLowerCase()]=v}else if(n.listenerCount("redirect")===0){let y=a?n._originalIpc?i.socketPath===n._originalHostOrSocketPath:!1:n._originalIpc?!1:r.host===n._originalHostOrSocketPath;(!y||n._originalSecure&&!o)&&(delete i.headers.authorization,delete i.headers.cookie,y||delete i.headers.host,i.auth=void 0)}i.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),g=n._req=c(i),n._redirects&&n.emit("redirect",n.url,g)}else g=n._req=c(i);i.timeout&&g.on("timeout",()=>{$(n,g,"Opening handshake has timed out")}),g.on("error",y=>{g===null||g[$i]||(g=n._req=null,St(n,y))}),g.on("response",y=>{let x=y.headers.location,v=y.statusCode;if(x&&i.followRedirects&&v>=300&&v<400){if(++n._redirects>i.maxRedirects){$(n,g,"Maximum redirects exceeded");return}g.abort();let A;try{A=new as(x,e)}catch{let w=new SyntaxError(`Invalid URL: ${x}`);St(n,w);return}Wi(n,A,t,s)}else n.emit("unexpected-response",g,y)||$(n,g,`Unexpected server response: ${y.statusCode}`)}),g.on("upgrade",(y,x,v)=>{if(n.emit("upgrade",y),n.readyState!==N.CONNECTING)return;g=n._req=null;let A=y.headers.upgrade;if(A===void 0||A.toLowerCase()!=="websocket"){$(n,x,"Invalid Upgrade header");return}let b=un("sha1").update(h+pn).digest("base64");if(y.headers["sec-websocket-accept"]!==b){$(n,x,"Invalid Sec-WebSocket-Accept header");return}let w=y.headers["sec-websocket-protocol"],m;if(w!==void 0?u.size?u.has(w)||(m="Server sent an invalid subprotocol"):m="Server sent a subprotocol but none was requested":u.size&&(m="Server sent no subprotocol"),m){$(n,x,m);return}w&&(n._protocol=w);let _=y.headers["sec-websocket-extensions"];if(_!==void 0){if(!d){$(n,x,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let k;try{k=vn(_)}catch{$(n,x,"Invalid Sec-WebSocket-Extensions header");return}let O=Object.keys(k);if(O.length!==1||O[0]!==oe.extensionName){$(n,x,"Server indicated an extension that was not requested");return}try{d.accept(k[oe.extensionName])}catch{$(n,x,"Invalid Sec-WebSocket-Extensions header");return}n._extensions[oe.extensionName]=d}n.setSocket(x,v,{allowSynchronousEvents:i.allowSynchronousEvents,generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})}),i.finishRequest?i.finishRequest(g,n):g.end()}function St(n,e){n._readyState=N.CLOSING,n.emit("error",e),n.emitClose()}function An(n){return n.path=n.socketPath,Gi.connect(n)}function On(n){return n.path=void 0,!n.servername&&n.servername!==""&&(n.servername=Gi.isIP(n.host)?"":n.host),cn.connect(n)}function $(n,e,t){n._readyState=N.CLOSING;let s=new Error(t);Error.captureStackTrace(s,$),e.setHeader?(e[$i]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(St,n,s)):(e.destroy(s),e.once("error",n.emit.bind(n,"error")),e.once("close",n.emitClose.bind(n)))}function cs(n,e,t){if(e){let s=wn(e).length;n._socket?n._sender._bufferedBytes+=s:n._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${n.readyState} (${te[n.readyState]})`);process.nextTick(t,s)}}function Tn(n,e){let t=this[j];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=n,t._socket[j]!==void 0&&(t._socket.removeListener("data",vt),process.nextTick(Hi,t._socket),n===1005?t.close():t.close(n,e))}function Pn(){let n=this[j];n.isPaused||n._socket.resume()}function En(n){let e=this[j];e._socket[j]!==void 0&&(e._socket.removeListener("data",vt),process.nextTick(Hi,e._socket),e.close(n[_n])),e.emit("error",n)}function Fi(){this[j].emitClose()}function Cn(n,e){this[j].emit("message",n,e)}function Nn(n){let e=this[j];e._autoPong&&e.pong(n,!this._isServer,qi),e.emit("ping",n)}function In(n){this[j].emit("pong",n)}function Hi(n){n.resume()}function Ji(){let n=this[j];this.removeListener("close",Ji),this.removeListener("data",vt),this.removeListener("end",Vi),n._readyState=N.CLOSING;let e;!this._readableState.endEmitted&&!n._closeFrameReceived&&!n._receiver._writableState.errorEmitted&&(e=n._socket.read())!==null&&n._receiver.write(e),n._receiver.end(),this[j]=void 0,clearTimeout(n._closeTimer),n._receiver._writableState.finished||n._receiver._writableState.errorEmitted?n.emitClose():(n._receiver.on("error",Fi),n._receiver.on("finish",Fi))}function vt(n){this[j]._receiver.write(n)||this.pause()}function Vi(){let n=this[j];n._readyState=N.CLOSING,n._receiver.end(),this.end()}function Yi(){let n=this[j];this.removeListener("error",Yi),this.on("error",qi),n&&(n._readyState=N.CLOSING,this.destroy())}});var Xi=z((Sa,Zi)=>{"use strict";var{tokenChars:Dn}=Ue();function Un(n){let e=new Set,t=-1,s=-1,i=0;for(i;i<n.length;i++){let o=n.charCodeAt(i);if(s===-1&&Dn[o]===1)t===-1&&(t=i);else if(i!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=i);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${i}`);s===-1&&(s=i);let a=n.slice(t,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${i}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let r=n.slice(t,i);if(e.has(r))throw new SyntaxError(`The "${r}" subprotocol is duplicated`);return e.add(r),e}Zi.exports={parse:Un}});var nr=z((wa,rr)=>{"use strict";var Ln=require("events"),wt=require("http"),{Duplex:va}=require("stream"),{createHash:jn}=require("crypto"),Qi=os(),de=De(),Mn=Xi(),Rn=hs(),{GUID:zn,kWebSocket:Bn}=re(),Fn=/^[+/0-9A-Za-z]{22}==$/,er=0,tr=1,ir=2,us=class extends Ln{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Rn,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=wt.createServer((s,i)=>{let r=wt.STATUS_CODES[426];i.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),i.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=Gn(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,r,o)=>{this.handleUpgrade(i,r,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=er}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===ir){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(Re,this);return}if(e&&this.once("close",e),this._state!==tr)if(this._state=tr,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(Re,this):process.nextTick(Re,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{Re(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,i){t.on("error",sr);let r=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){ge(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){ge(this,e,t,400,"Invalid Upgrade header");return}if(r===void 0||!Fn.test(r)){ge(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==8&&a!==13){ge(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){ze(t,400);return}let l=e.headers["sec-websocket-protocol"],f=new Set;if(l!==void 0)try{f=Mn.parse(l)}catch{ge(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let h=e.headers["sec-websocket-extensions"],c={};if(this.options.perMessageDeflate&&h!==void 0){let u=new de(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let d=Qi.parse(h);d[de.extensionName]&&(u.accept(d[de.extensionName]),c[de.extensionName]=u)}catch{ge(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let u={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(u,(d,g,y,x)=>{if(!d)return ze(t,g||401,y,x);this.completeUpgrade(c,r,f,e,t,s,i)});return}if(!this.options.verifyClient(u))return ze(t,401)}this.completeUpgrade(c,r,f,e,t,s,i)}completeUpgrade(e,t,s,i,r,o,a){if(!r.readable||!r.writable)return r.destroy();if(r[Bn])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>er)return ze(r,503);let f=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${jn("sha1").update(t+zn).digest("base64")}`],h=new this.options.WebSocket(null,void 0,this.options);if(s.size){let c=this.options.handleProtocols?this.options.handleProtocols(s,i):s.values().next().value;c&&(f.push(`Sec-WebSocket-Protocol: ${c}`),h._protocol=c)}if(e[de.extensionName]){let c=e[de.extensionName].params,u=Qi.format({[de.extensionName]:[c]});f.push(`Sec-WebSocket-Extensions: ${u}`),h._extensions=e}this.emit("headers",f,i),r.write(f.concat(`\r
`).join(`\r
`)),r.removeListener("error",sr),h.setSocket(r,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(h),h.on("close",()=>{this.clients.delete(h),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Re,this)})),a(h,i)}};rr.exports=us;function Gn(n,e){for(let t of Object.keys(e))n.on(t,e[t]);return function(){for(let s of Object.keys(e))n.removeListener(s,e[s])}}function Re(n){n._state=ir,n.emit("close")}function sr(){this.destroy()}function ze(n,e,t,s){t=t||wt.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},n.once("finish",n.destroy),n.end(`HTTP/1.1 ${e} ${wt.STATUS_CODES[e]}\r
`+Object.keys(s).map(i=>`${i}: ${s[i]}`).join(`\r
`)+`\r
\r
`+t)}function ge(n,e,t,s,i){if(n.listenerCount("wsClientError")){let r=new Error(i);Error.captureStackTrace(r,ge),n.emit("wsClientError",r,t,e)}else ze(t,s,i)}});var Qn={};Ms(Qn,{AuthorizationStruct:()=>ws,CMDService:()=>gs,Callable:()=>Je,ChatroomStruct:()=>Os,CircularBuffer:()=>et,CoherenceMap:()=>xt,CoherenceStruct:()=>kt,CommentStruct:()=>Ts,DS:()=>F,Data:()=>fr,DataStruct:()=>xs,DataTablet:()=>qe,DateStruct:()=>Cs,DelayBuffer:()=>tt,DelayBufferManager:()=>xe,E2EEService:()=>Bt,ECGStruct:()=>Ot,EDAStruct:()=>_s,EEGCoordinates:()=>lr,EEGStruct:()=>se,EMGStruct:()=>Ss,EventHandler:()=>ve,EventStruct:()=>As,EyeTrackerStruct:()=>ys,FNIRSStruct:()=>At,FrequencyBandsStruct:()=>Ge,Graph:()=>q,GraphNode:()=>P,GroupStruct:()=>ks,HRVStruct:()=>bs,HTTPbackend:()=>qt,IMUStruct:()=>ps,InputBuffer:()=>Qe,NotificationStruct:()=>Ps,PPGStruct:()=>ms,ProfileStruct:()=>vs,Router:()=>Lt,SSEbackend:()=>Wt,ScheduleStruct:()=>Es,Service:()=>C,SessionManager:()=>Ae,SessionService:()=>Mt,Struct:()=>I,StructBackend:()=>Ds,StructFrontend:()=>Ns,WSSbackend:()=>ds,animate:()=>Gs,backprop:()=>Bs,bindListener:()=>Ws,branching:()=>qs,connectionHasId:()=>jt,defaultCollections:()=>mr,defaultManifest:()=>Gt,defaultServiceWorker:()=>Ft,defaultSpecifiers:()=>hr,eegCoordinates:()=>fe,genTimeSpecifiers:()=>Jn,genTimestampFromString:()=>Z,getAllProperties:()=>Ut,getCallbackFromString:()=>we,getFnParamNames:()=>Tr,getFunctionHead:()=>Ys,getStringId:()=>S,htmlBodyBoilerPlate:()=>Cr,instanceObject:()=>Or,isFunction:()=>zs,isNativeClass:()=>Ve,isTypedArray:()=>Qs,loaders:()=>Ke,loop:()=>Fs,methodstrings:()=>Er,parseFunctionFromText:()=>Ze,pseudoObjectId:()=>Vn,randomId:()=>ur,reconstructObject:()=>Pr,recursivelyAssign:()=>Xe,recursivelyStringifyFunctions:()=>Vs,scriptBoilerPlate:()=>Nr,setCoordinate:()=>Fe,spliceTypedArray:()=>ei,state:()=>Dt,stringifyFast:()=>Xs,stringifyWithCircularRefs:()=>Ks,stringifyWithFunctionsAndCircularRefs:()=>Zs,structRegistry:()=>cr,substitute__operator:()=>Js,toObjectId:()=>D,transformListenerResult:()=>Hs,triggerListenerOncreate:()=>$s,wrapArgs:()=>Ye});module.exports=Ar(Qn);var ve=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let s of t)this.triggerEvent(s,this.data[s]);if(this.triggers[Se]){let s=r=>{r(e)},i=this.triggers[Se].length;for(let r=i-1;r>=0;r--)s(this.triggers[Se][r].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let s=r=>{r.onchange(t)},i=this.triggers[e].length;for(let r=i-1;r>=0;r--)s(this.triggers[e][r])}};subscribeState=e=>this.subscribeEvent(Se,e);unsubscribeState=e=>this.unsubscribeEvent(Se,e);subscribeEvent=(e,t,s,i)=>{if(e){s&&i&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>s[i],set:o=>{s[i]=o},enumerable:!0,configurable:!0}),this.triggers[e]||(this.triggers[e]=[]);let r=this.ctr;return this.ctr++,this.triggers[e].push({sub:r,onchange:t}),r}else return};unsubscribeEvent=(e,t)=>{let s=this.triggers[e];if(s)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let i,r=s.find((o,a)=>{if(o.sub===t)return i=a,!0});return r&&s.splice(i,1),Object.keys(s).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(r),!0}};subscribeEventOnce=(e,t)=>{let s,i=r=>{t(r),this.unsubscribeEvent(e,s)};return s=this.subscribeEvent(e,i),s};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let s in this.triggers[e])if(this.triggers[e][s].sub===t)return this.triggers[e][s]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved},Se="*s";var Dt=new ve,Je=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},P=class n{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:Dt};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,s){if(this.__setProperties(e,t,s),typeof e=="function"||e?.__callable){let i=new Je;i.__call=(...o)=>this.__operator(...o);let r=new Proxy(i,{get:(o,a,l)=>Reflect.has(this,a)?Reflect.get(this,a,l):Reflect.get(o,a,l),set:(o,a,l,f)=>Reflect.has(this,a)?Reflect.set(this,a,l,f):Reflect.set(o,a,l,f)});return Object.setPrototypeOf(r,this),r}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,s)=>{if((()=>{let r=e;typeof e=="function"?Ve(e)?e=new e:e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&s?.get(e)&&(e=s.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=r)})(),typeof e=="object"){let r=()=>{e.__node?.state?this.__node.state=e.__node.state:s&&(e.__node.state=s.__node.state)},o=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},a=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},l=()=>{typeof e.__node=="string"?s?.get(e.__node.tag)?e=s.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),s&&(e.__node.graph=s),e instanceof q&&(e.__node.source=e)},f=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof q||e instanceof q)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof q&&e instanceof q&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(g=>{t.set(e.__node.tag+"."+g.__node.tag,g)});let d=()=>{e.__node.nodes.forEach(g=>{t.__node.nodes.delete(e.__node.tag+"."+g.__node.tag)})};this.__addOndisconnected(d)}},h=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&s){let d=s.get(e.__operator);d&&(e.__operator=d.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},c=()=>{e.__node=Object.assign(this.__node,e.__node);let d=Object.getOwnPropertyNames(e).filter(g=>{if(!pe[g])return!0});for(let g of d)g in e&&g!=="name"&&(this[g]=e[g])},u=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(d=>d.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(d=>d.bind(this))))};r(),a(),o(),l(),f(),c(),u(),h()}};__subscribe=(e,t,s,i,r,o,a)=>{let l=(h,c=(d,g)=>g||d,u=e)=>{let d;if(o){let x=Ye(u,o,this.__node.graph);u=x.__callback,d=x.__args}let g=this.__node.state.subscribeEvent(h,u,this,t),y=this.__node.state.getEvent(h,g);return this.__listeners||(this.__listeners={}),this.__listeners[h]=this.__node.state.triggers[h],y&&(y.source=this.__node.tag,t&&(y.key=t),y.target=c(e,i),r&&(y.tkey=r),s&&(y.subInput=s),o&&(y.arguments=d,y.__args=o),a&&(y.__callback=a),y.node=this,y.graph=this.__node.graph),g},f=h=>{let c=this.__node.graph.get(h);if(!c&&h.includes(".")){i=h.substring(0,h.lastIndexOf("."));let u=this.__node.graph.get(h.substring(0,i));r=h.lastIndexOf(".")+1,u&&typeof u[t]=="function"&&(h=(...d)=>u[r](...d))}else c.__operator&&(h=c.__operator,r="__operator");return h};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(a=this.__node.tag+"."+e,r=e,i){if(this.__node.graph?.get(i)){let u=this.__node.graph?.get(i);if(typeof u[e]=="function"){let d=u[e];e=(...g)=>{d(...g)}}else{let d=e;e=y=>{u[d]=y}}}}else if(typeof this[e]=="function"){let u=this[e];e=(...d)=>{u(...d)}}else this.__node.graph?.get(e)&&(e=f(e));if(typeof e!="function")return}let h,c=s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?h=l(c,(u,d)=>d||u,e):e?.__node&&(h=l(c,(u,d)=>d||u.__node.unique,(...u)=>{e.__operator&&e.__operator(...u)})),h}else{if(typeof e=="string"&&(a=e,i||(i=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),r="__operator",typeof e!="object"))return;let h,c=s?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?h=l(c,(u,d)=>d||u,e):e?.__node&&(h=l(c,(u,d)=>d||u.__node.unique,(...u)=>{e.__operator&&e.__operator(...u)})),h}};__unsubscribe=(e,t,s)=>t?this.__node.state.unsubscribeEvent(s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(s?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=Ye(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...s)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,s);let i=e(...s);return this.__node.state.triggers[this.__node.unique]&&(typeof i?.then=="function"?i.then(r=>{r!==void 0&&this.__node.state.setValue(this.__node.unique,r)}).catch(console.error):i!==void 0&&this.__node.state.setValue(this.__node.unique,i)),i},this.__parent instanceof n&&!this.__subscribedToParent&&this.__parent.__operator){let s=this.__parent.__subscribe(this),i=()=>{this.__parent?.__unsubscribe(s),delete this.__subscribedToParent};this.__addOndisconnected(i),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let s=this.__node.localState,i=(r,o)=>{let a=this.__node.unique+"."+o,l=`${a}input`,f,h,c,u;if(typeof r[o]=="function"&&o!=="__operator")this.__props?.[o]?c=this.__props:c=s,f=()=>c[o],h=d=>{this.__props?.[o]||(d=d.bind(this)),c[o]=(...g)=>{this.__node.state.triggers[l]&&this.__node.state.setValue(l,g);let y=d(...g);return this.__node.state.triggers[a]&&(typeof y?.then=="function"?y.then(x=>{this.__node.state.triggerEvent(a,x)}).catch(console.error):this.__node.state.triggerEvent(a,y)),y}},s[o]=r[o].bind(this),u={get:f,set:h,enumerable:!0,configurable:!0};else if(o!=="__graph"){let d,g,y;this.__props?.[o]?y=this.__props:y=s,d=()=>y[o],g=x=>{y[o]=x,this.__node.state.triggers[a]&&this.__node.state.triggerEvent(a,x)},s[o]=r[o],u={get:d,set:g,enumerable:!0,configurable:!0}}if(Object.defineProperty(r,o,u),typeof this.__node.initial=="object"){let d=Object.getOwnPropertyDescriptor(this.__node.initial,o);(d===void 0||d?.configurable)&&Object.defineProperty(this.__node.initial,o,u)}};if(t)i(e,t);else for(let r in e)i(e,r)};__proxyObject=e=>{let t=Ut(e);for(let s of t){let i={get:()=>e[s],set:r=>{e[s]=r},enumerable:!0,configurable:!0};if(Object.defineProperty(this,s,i),typeof this.__node.initial=="object"){let r=Object.getOwnPropertyDescriptor(this.__node.initial,s);(r===void 0||r?.configurable)&&Object.defineProperty(this.__node.initial,s,i)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=s=>{s(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=s=>{s(this)};this.__ondisconnected.forEach(t)}}},q=class n{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:Dt,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,ke(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=!1)=>{function s(o,a,l=!0,f=!0){if(f){o||(o={});for(let h in a)!h.startsWith("__")&&a[h]&&typeof a[h]=="object"?(o[h]=a[h],a[h]?.__children&&s({},a[h].__children,!1,!1)):typeof a[h]=="function"&&(o[h]=a[h]);s(o,a,!0,!1)}else if(a?.__children&&!l)a.__children?.constructor.name==="Object"?o.__children?.constructor.name==="Object"?o.__children=s(o.__children,a.__children,!0,!1):o.__children=s({},a.__children,!0,!1):o.__children=a.__children;else if(l)for(let h in a)!h.startsWith("__")&&a[h]&&typeof a[h]=="object"?(o[h]=Object.assign({},a[h]),a[h]?.__children&&(o[h].__children=s({},a[h].__children,!1,!1))):typeof a[h]=="function"&&(o[h]=a[h]);return o}this.__node.roots=s(this.__node.roots?this.__node.roots:{},e);let i=Object.assign({},e);i.__node&&delete i.__node;let r=this.recursiveSet(i,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let o=new P(e,this,this);this.set(o.__node.tag,o),this.runLoaders(o,this,e,e.__node.tag),o.__listeners&&(r[o.__node.tag]=o.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(r),i};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,s,i)=>{for(let r in this.__node.loaders)typeof this.__node.loaders[r]=="object"?(this.__node.loaders[r].init&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i),this.__node.loaders[r].connected&&e.__addOnconnected(this.__node.loaders[r].connect),this.__node.loaders[r].disconnected&&e.__addOndisconnected(this.__node.loaders[r].disconnect)):typeof this.__node.loaders[r]=="function"&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i)};add=(e,t,s=!0)=>{let i={};typeof t=="string"&&(t=this.get(t));let r;if(typeof e=="function"?Ve(e)?e.prototype instanceof P?(e=e.prototype.constructor(e,t,this),r=!0):e=new e:e={__operator:e,__callable:!0}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!r){let l=Object.getOwnPropertyNames(e),f=Object.getOwnPropertyNames(Object.getPrototypeOf(e));l.push(...f),l=l.filter(c=>!pe.includes(c));let h={};for(let c of l)h[c]=e[c];e=h}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(s)this.remove(e.__node.tag,!0);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let o,a=ke({},e,2);if(r?o=e:o=new P(e,t,this),this.set(o.__node.tag,o),this.runLoaders(o,t,e,o.__node.tag),this.__node.roots[o.__node.tag]=a,o.__children&&(o.__children=Object.assign({},o.__children),this.recursiveSet(o.__children,o,i,o.__children)),o.__listeners){i[o.__node.tag]=Object.assign({},o.__listeners);for(let l in o.__listeners){let f=o.__listeners[l];o[l]&&(delete i[o.__node.tag][l],i[o.__node.tag][o.__node.tag+"."+l]=f),typeof f=="string"&&(o.__children?.[f]?i[o.__node.tag][l]=o.__node.tag+"."+f:t instanceof P&&(t.__node.tag===f||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===f)&&(i[o.__node.tag][l]=t.__node.tag))}}return this.setListeners(i),o.__callConnected(),o};recursiveSet=(e,t,s={},i,r=!1)=>{let o=Object.getOwnPropertyNames(i).filter(l=>!pe.includes(l)),a=Object.getOwnPropertyNames(Object.getPrototypeOf(i)).filter(l=>!pe.includes(l));o.push(...a);for(let l of o){if(l.includes("__"))continue;let f=i[l];if(Array.isArray(f))continue;let h;if(typeof f=="function"?Ve(f)?(f=new f,f instanceof P&&(f=f.prototype.constructor(f,t,this),h=!0)):f={__operator:f,__callable:!0}:typeof f=="string"?this.__node.nodes.get(f)?f=this.__node.nodes.get(f):f=this.__node.roots[f]:typeof f=="boolean"&&(this.__node.nodes.get(l)?f=this.__node.nodes.get(l):f=this.__node.roots[l]),f&&typeof f=="object"){if(!h&&!(f instanceof P)){let g=Object.getOwnPropertyNames(f).filter(v=>!pe.includes(v)),y=Object.getOwnPropertyNames(Object.getPrototypeOf(f)).filter(v=>!pe.includes(v));y.splice(y.indexOf("constructor"),1),g.push(...y);let x={};for(let v of g)x[v]=f[v];f=x}if(f.__node||(f.__node={}),f.__node.tag||(f.__node.tag=l),f.__node.initial||(f.__node.initial=e[l]),r&&this.get(f.__node.tag))this.remove(f.__node.tag,!0);else if(this.get(f.__node.tag)&&!(!(t instanceof n)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+f.__node.tag))continue;let c,u=!1,d=ke({},f,2);if(h||f instanceof P?c=f:(c=new P(f,t,this),u=!0),!u&&f instanceof P&&!h&&t instanceof P){let g=this.subscribe(t.__node.tag,c.__node.tag),y=x=>{this.unsubscribe(t.__node.tag,g)};c.__addOndisconnected(y)}else if(c){if(this.set(c.__node.tag,c),this.runLoaders(c,t,e[l],l),e[l]=c,this.__node.roots[c.__node.tag]=d,c.__children&&(c.__children=Object.assign({},c.__children),this.recursiveSet(c.__children,c,s,c.__children)),c.__listeners){s[c.__node.tag]=Object.assign({},c.__listeners);for(let g in c.__listeners){let y=c.__listeners[g],x=g;c[g]&&(delete s[c.__node.tag][g],x=c.__node.tag+"."+g,s[c.__node.tag][x]=y),typeof y=="string"&&(c.__children?.[y]?s[c.__node.tag][x]=c.__node.tag+"."+y:t instanceof P&&(t.__node.tag===y||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===y)&&(s[c.__node.tag][x]=t.__node.tag))}}c.__callConnected()}}}return s};remove=(e,t=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof P){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let s=i=>{for(let r in i)this.unsubscribe(i[r]),this.delete(i[r].__node.tag),delete this.__node.roots[i[r].__node.tag],this.delete(r),delete this.__node.roots[r],i[r].__node.tag=i[r].__node.tag.substring(i[r].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(i[r]),i[r].__callDisconnected(),i[r].__children&&s(i[r].__children)};e.__children&&s(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let s=this.get(e);if(!s&&e.includes(".")){if(s=this.get(e.substring(0,e.lastIndexOf("."))),typeof s?.[e.substring(e.lastIndexOf(".")+1)]=="function")return s[e.substring(e.lastIndexOf(".")+1)](...t)}else if(s?.__operator)return s.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let s=this.get(t);if(typeof e[t]=="object")for(let i in e[t]){let r=this.get(i),o;if(typeof e[t][i]!="object")e[t][i]={__callback:e[t][i]};else if(!e[t][i].__callback)for(let a in e[t][i]){typeof e[t][i][a]!="object"&&(e[t][i][a]={__callback:e[t][i][a]},s.__operator&&(e[t][i][a].__callback===!0||typeof e[t][i][a].__callback>"u")&&(e[t][i][a].__callback=s.__operator));let l=this.get(a);if(l)o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,void 0,e[t][i][a].subInput,t);else{let f=i.substring(0,i.lastIndexOf("."));if(l=this.get(f),l){let h=i.substring(i.lastIndexOf(".")+1);o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,h,e[t][i][a].subInput,t)}}}if("__callback"in e[t][i])if(s&&((e[t][i].__callback===!0||typeof e[t][i].__callback>"u")&&(e[t][i].__callback=s.__operator),typeof e[t][i].__callback=="function"&&(e[t][i].__callback=e[t][i].__callback.bind(s))),r)o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,void 0,e[t][i].subInput,t);else{let a=i.substring(0,i.lastIndexOf("."));r=this.get(a),r&&(o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,i.substring(i.lastIndexOf(".")+1),e[t][i].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let s in e.__listeners){if(t&&s!==t||typeof e.__listeners[s]?.sub!="number")continue;let i=this.get(s);if(i)if(typeof!e.__listeners[s]?.__callback=="number")for(let r in e.__listeners[s])e.__listeners[s][r]?.sub&&(this.unsubscribe(i,e.__listeners[s][r].sub,void 0,e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,void 0,e.__listeners[s].subInput),e.__listeners[s].sub=void 0);else if(i=this.get(s.substring(0,s.lastIndexOf("."))),i)if(typeof e.__listeners[s]=="object"&&!e.__listeners[s]?.__callback)for(let r in e.__listeners[s])typeof e.__listeners[s][r]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s][r].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s].subInput),e.__listeners[s].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return!0});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,s)=>{let i=this.get(e);if(i){let r=i.__node.unique;return t&&(r+="."+t),this.__node.state.getEvent(r,s)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof P){let s;if(t)s=Object.assign({},this.__node.roots[e.__node.tag]);else{s=Object.assign({},e);for(let i in s)i.includes("__")&&delete s[i]}}};subscribe=(e,t,s,i,r,o,a)=>{let l=e;typeof e=="string"&&(l=this.get(e),!l&&e.includes(".")&&(l=this.get(e.substring(0,e.lastIndexOf("."))),i=e.substring(e.lastIndexOf(".")+1))),o instanceof P&&(o=o.__node.tag);let f;if(typeof t=="string"){f=t;let c=u=>{if(this.get(u)?.__operator){let d=this.get(u);o=u,u=function(...g){return d.__operator(...g)}}else if(u.includes(".")){o=u.substring(0,u.lastIndexOf("."));let d=this.get(o),g=u.substring(u.lastIndexOf(".")+1);a=g,typeof d[g]=="function"?d[g]instanceof P?u=d[g]:u=function(...y){return d[g](...y)}:u=function(y){return d[g]=y,d[g]}}return u};if(o){let u=this.get(o);typeof u?.[t]=="function"?(a=t,t=function(...d){return u[i](...d)}):u?.[i]?(a=i,u[i]instanceof P?t=u[i]:t=function(d){return u[i]=d,u[i]}):t=c(t)}else t=c(t)}let h;if(l instanceof P){let c=()=>{h=l.__subscribe(t,i,r,o,a,s,f);let u=()=>{h!==void 0&&l.__unsubscribe(h,i,r),h=void 0};l.__addOndisconnected(()=>{u(),l.__addOnconnected(()=>{h===void 0&&l.__node.graph.__node.tag===this.__node.tag&&c()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof P&&t.__addOndisconnected(()=>{u()})};c()}else if(typeof e=="string"){let c=this.get(e);if(c){if(t instanceof P&&t.__operator){let u=()=>{h=c.__subscribe(t.__operator,i,r,o,a,s,f);let d=()=>{h!==void 0&&c.__unsubscribe(h,i,r)};c.__addOndisconnected(()=>{d(),c.__addOnconnected(()=>{h===void 0&&c.__node.graph.__node.tag===this.__node.tag&&u()})}),t.__addOndisconnected(d)};u()}else if(typeof t=="function"||typeof t=="string"){let u=()=>{h=c.__subscribe(t,i,r,o,a,s,f);let d=()=>{h!==void 0&&c.__unsubscribe(h,i,r),h=void 0};c.__addOndisconnected(()=>{d(),c.__addOnconnected(()=>{h===void 0&&c.__node.graph.__node.tag===this.__node.tag&&u()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(d)};u()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(h=this.__node.state.subscribeEvent(e,t))}return h};unsubscribe=(e,t,s,i)=>e instanceof P?e.__unsubscribe(t,s,i):this.get(e)?.__unsubscribe(t,s,i);setState=e=>{this.__node.state.setState(e)}};function ke(n,e,t=1/0,s=0){for(let i in e)e[i]?.constructor.name==="Object"&&s<t?(s++,n[i]?.constructor.name==="Object"?ke(n[i],e[i],t,s):n[i]=ke({},e[i],t,s)):n[i]=e[i];return n}function Ut(n){var e=[],t=n;do{var s=Object.getOwnPropertyNames(t);let i=function(r){e.indexOf(r)===-1&&e.push(r)};s.forEach(i)}while(t=Object.getPrototypeOf(t));return e}function Or(n){let e=Ut(n),t={};for(let s of e)t[s]=n[s];return t}function Ve(n){return zs(n)==="class"}function zs(n){return typeof n=="function"?n.prototype?Object.getOwnPropertyDescriptor(n,"prototype")?.writable?"function":"class":n.constructor.name==="AsyncFunction"?"async":"arrow":""}var we=(n,e)=>{if(e.get(n)?.__operator){let t=e.get(n);return(...s)=>{t.__operator(...s)}}else if(n.includes(".")){let t=n.split("."),s=t.pop(),i=t.join("."),r=e.get(i);return typeof e.get(i)?.[s]=="function"?(...o)=>r[s](...o):()=>r[s]}else if(e.get(n)){let t=e.get(n);return()=>t}else{let t=n;return()=>t}},Ye=(n,e,t)=>{let s=[],i=(o,a)=>{if(o==="__output"||o==="__input"||o==="__callback")s[a]={__callback:l=>l,__args:void 0,idx:a};else if(typeof o=="string")s[a]={__callback:we(o,t),__args:void 0,idx:a};else if(typeof o=="function"){let l=o;s[a]={__callback:(...f)=>l(...f),__args:void 0,idx:a}}else if(typeof o=="object"&&(o.__input||o.__callback)){let l=function(f){let h=f.__input?f.__input:f.__callback;if(typeof f.__input=="string"&&(h={__callback:we(f.__input,t),__args:void 0,idx:a}),f.__args){let c=Ye(h,f.__args,t);h={__callback:c.__callback,__args:c.__args,idx:a}}else h={__callback:h,__args:void 0,idx:a};if(f.__output){let c=f.__output;if(typeof f.__output=="string"?c={__callback:we(c,t),__args:void 0,idx:a}:typeof o.__output=="object"&&(c=l(c)),typeof c?.__callback=="function"){let u=h.__callback,d=c.__callback;h={__callback:(...g)=>d(u(...g)),__args:c.__args,idx:a}}}return h};s[a]=l(o)}else{let l=o;s[a]={__callback:()=>l,__args:void 0,idx:a}}};e.forEach(i),typeof n=="string"&&(n={__callback:we(n,t),__args:void 0});let r=typeof n=="function"?n:n.__callback;return n=function(...o){let a=f=>f.__callback(...o);return r(...s.map(a))},{__callback:n,__args:s}},pe=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var Bs=(n,e,t)=>{n.__node.backward&&e instanceof P&&t.setListeners({[e.__node.tag]:{[n.__node.tag]:e}})},Fs=(n,e,t)=>{if(n.__operator){let s=Math.random();if(n.__node.loops||(n.__node.loops={}),typeof n.__node.delay=="number"){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=setTimeout(async()=>{o(await i(...r))},n.__node.delay)}))}else if(n.__node.frame===!0){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=requestAnimationFrame(async()=>{o(await i(...r))})}))}if(typeof n.__node.repeat=="number"||typeof n.__node.recursive=="number"){let i=n.__operator;n.__setOperator(async(...r)=>{let o=n.__node.repeat?n.__node.repeat:n.__node.recursive,a,l=async(f,...h)=>{for(;f>0;){if(n.__node.delay||n.__node.frame){i(...h).then(async c=>{n.__node.recursive?await l(f,c):await l(f,...h)});break}else a=await i(...r);f--}};return await l(o,...r),a})}if(n.__node.loop&&typeof n.__node.loop=="number"){let i=n.__operator,r=n.__node.loop;n.__setOperator((...a)=>{if("looping"in n.__node||(n.__node.looping=!0),n.__node.looping){let l=performance.now();i(...a),n.__node.loops[s]=setTimeout(()=>{let h=performance.now()-l-n.__node.loop;h>0?r=n.__node.loop-h:r=n.__node.loop,r<=0&&(r=n.__node.loop),n.__operator(...a)},r)}}),n.__node.looping&&n.__operator();let o=a=>{a.__node.looping&&(a.__node.looping=!1),a.__node.loops[s]&&(clearTimeout(a.__node.loops[s]),cancelAnimationFrame(a.__node.loops[s]))};n.__addOndisconnected(o)}}},Gs=(n,e,t)=>{if(n.__node.animate===!0||n.__animation){let s=n.__operator;n.__setOperator((...r)=>{"animating"in n.__node||(n.__node.animating=!0),n.__node.animating&&(typeof n.__animation=="function"?n.__animation(...r):s(...r),n.__node.animationFrame=requestAnimationFrame(()=>{n.__operator(...r)}))}),(n.__node.animating||(!("animating"in n.__node)||n.__node.animating)&&n.__animation)&&setTimeout(()=>{n.__node.animationFrame=requestAnimationFrame(n.__operator)},10);let i=r=>{r.__node.animating&&(r.__node.animating=!1),r.__node.animationFrame&&cancelAnimationFrame(r.__node.animationFrame)};n.__addOndisconnected(i)}},qs=(n,e,t)=>{if(typeof n.__branch=="object"&&n.__operator&&!n.__branchApplied){let s=n.__operator;n.__branchApplied=!0,n.__operator=(...i)=>{let r=s(...i);for(let o in n.__branch){let a=()=>{typeof n.__branch[o].then=="function"?n.__branch[o].then(r):n.__branch[o].then instanceof P&&n.__branch[o].then.__operator?n.__branch[o].then.__operator(r):r=n.__branch[o].then};typeof n.__branch[o].if=="function"?n.__branch[o].if(r)==!0&&a():n.__branch[o].if===r&&a()}return r}}if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&n.__listeners[s].branch&&!n.__listeners[s].branchApplied){let i=n.__listeners[s].callback;n.__listeners[s].branchApplied=!0,n.__listeners.callback=r=>{let o=()=>{typeof n.__listeners[s].branch.then=="function"?r=n.__listeners[s].branch.then(r):n.__listeners[s].branch.then instanceof P&&n.__listeners[s].branch.then.__operator?r=n.__listeners[s].branch.then.__operator(r):r=n.__listeners[s].branch.then};return typeof n.__listeners[s].branch.if=="function"?n.__listeners[s].branch.if(r)&&o():n.__listeners[s].branch.if===r&&o(),i(r)}}}},$s=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&n.__listeners[s].oncreate&&n.__listeners[s].callback(n.__listeners[s].oncreate)},Ws=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].binding=="object"&&(n.__listeners.callback=n.__listeners.callback.bind(n.__listeners[s].binding))},Hs=(n,e,t)=>{if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].transform=="function"&&!n.__listeners[s].transformApplied){let i=n.__listeners[s].callback;n.__listeners[s].transformApplied=!0,n.__listeners.callback=r=>(r=n.__listeners[s].transform(r),i(r))}}},Js=(n,e,t)=>{n.post&&!n.__operator?n.__setOperator(n.post):!n.__operator&&typeof n.get=="function"&&n.__setOperator(n.get),!n.get&&n.__operator,n.aliases&&n.aliases.forEach(s=>{t.set(s,n);let i=r=>{t.__node.nodes.delete(s)};n.__addOndisconnected(i)}),typeof t.__node.roots?.[n.__node.tag]=="object"&&n.get&&(t.__node.roots[n.__node.tag].get=n.get)},Ke={backprop:Bs,loop:Fs,animate:Gs,branching:qs,triggerListenerOncreate:$s,bindListener:Ws,transformListenerResult:Hs,substitute__operator:Js};var Vs=n=>{let e={};for(let t in n)typeof n[t]=="object"?e[t]=Vs(n[t]):typeof n[t]=="function"?e[t]=n[t].toString():e[t]=n[t];return e};function Tr(n){typeof n!="string"&&(n=n.toString());let e=n.match(/\(?[^]*?\)?\s*=>/);if(e)return e[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let t=n.match(/\([^]*?\)/);return t?t[0].replace(/[()\s]/gi,"").split(","):[]}var Ys=n=>{let e=n.indexOf("=>")+1;return e<=0&&(e=n.indexOf("){")),e<=0&&(e=n.indexOf(") {")),n.slice(0,n.indexOf("{",e)+1)};function Ze(n=""){let e=r=>r.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=Ys(n),s=e(n),i;if(t.includes("function")){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s)}else if(t.substring(0,6)===s.substring(0,6)){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s.substring(s.indexOf("{")+1,s.length-1))}else try{i=(0,eval)(n)}catch{}return i}function Pr(n="{}"){try{let e=typeof n=="string"?JSON.parse(n):n,t=s=>{for(let i in s)if(typeof s[i]=="string"){let r=Ze(s[i]);typeof r=="function"&&(s[i]=r)}else typeof s[i]=="object"&&t(s[i]);return s};return t(e)}catch(e){console.error(e);return}}var Ks=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(a,t.join("."))}return a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=Ks);var Zs=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(typeof a=="function"?a.toString():a,t.join("."))}return typeof a=="function"?a.toString():a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=Zs);var Xs=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1;if(e[l]){var f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l++}}}function r(o,a){let l;if(a!=null)if(typeof a=="object"){let f=a.constructor.name;o&&f==="Object"&&i(o,a);let h=n.get(a);if(h)return"[Circular Reference]"+h;if(n.set(a,t.join(".")),f==="Array")a.length>20?l=a.slice(a.length-20):l=a;else if(f.includes("Set"))l=Array.from(a);else if(f!=="Object"&&f!=="Number"&&f!=="String"&&f!=="Boolean")l="instanceof_"+f;else if(f==="Object"){let c={};for(let u in a)if(a[u]==null)c[u]=a[u];else if(Array.isArray(a[u]))a[u].length>20?c[u]=a[u].slice(a[u].length-20):c[u]=a[u];else if(a[u].constructor.name==="Object"){c[u]={};for(let d in a[u])if(Array.isArray(a[u][d]))a[u][d].length>20?c[u][d]=a[u][d].slice(a[u][d].length-20):c[u][d]=a[u][d];else if(a[u][d]!=null){let g=a[u][d].constructor.name;g.includes("Set")?c[u][d]=Array.from(a[u][d]):g!=="Number"&&g!=="String"&&g!=="Boolean"?c[u][d]="instanceof_"+g:c[u][d]=a[u][d]}else c[u][d]=a[u][d]}else{let d=a[u].constructor.name;d.includes("Set")?c[u]=Array.from(a[u]):d!=="Number"&&d!=="String"&&d!=="Boolean"?c[u]="instanceof_"+d:c[u]=a[u]}l=c}else l=a}else l=a;return l}return function(a,l){e.push(a);let f=JSON.stringify(a,r,l);return s(),f}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Xs);function Er(n){if(typeof n.__methods=="object")for(let e in n.__methods){let t=n.__methods[e],s=typeof t=="function"?t:Ze(t);e==="__operator"?n.__setOperator(s):n[e]=s.bind(n)}}var C=class extends q{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({...Ke},e.loaders):{...Ke}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((r,o)=>{this.get(o)?this.set(t+"."+o,r):this.set(o,r)}),this.__node.nodes.forEach((r,o)=>{e[t].__node.nodes.get(o)||e[t].__node.nodes.set(o,r)});let s=this.set;this.set=(r,o)=>(e[t].set(r,o),s(r,o));let i=this.delete;this.delete=r=>(e[t].delete(r),i(r))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,s)=>{let i=t,r=this.__node.nodes.get(e);if(r||(r=this.__node.roots[e]),r?.[i])if(typeof r[i]!="function"){if(s){Array.isArray(s)&&s.length===1?r[i]=s[0]:r[i]=s;return}return r[i]}else return Array.isArray(s)?r[i](...s):r[i](s);else return this.handleServiceMessage({route:e,args:s,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let s=t.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,s,i,r)=>{if(e instanceof P)return r?this.subscribe(e,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)})};pipeOnce=(e,t,s,i,r)=>{if(e instanceof P)return r?e.__node.state.subscribeEventOnce(e.__node.unique,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.__node.state.subscribeEventOnce(e.__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)})};terminate=(...e)=>{};isTypedArray=Qs;recursivelyAssign=Xe;spliceTypedArray=ei;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),!0);error=(...e)=>(console.error(...e),!0)};function Qs(n){return ArrayBuffer.isView(n)&&Object.prototype.toString.call(n)!=="[object DataView]"}var Xe=(n,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?n[t]?.constructor.name==="Object"&&!Array.isArray(n[t])?Xe(n[t],e[t]):n[t]=Xe({},e[t]):n[t]=e[t];return n};function ei(n,e,t){let s=n.subarray(0,e),i;t&&(i=n.subarray(t+1));let r;return(s.length>0||i?.length>0)&&(r=new n.constructor(s.length+i.length)),r&&(s.length>0&&r.set(s),i&&i.length>0&&r.set(i,s.length)),r}var Lt=class extends C{name="router";connections={};sources={};services={};serviceConnections={};users={};userTimeout=1e4;order;constructor(e){if(super(e),this.load(this),e&&(e.order&&(this.order=e.order),e.timeout&&(this.userTimeout=e.timeout),e.graph))for(let t in e.graph){let s=e.graph[t];if(typeof s=="function"&&(s=new s),s?.__node?.nodes)s.name=t,s.__node.tag=t,this.addServices({[s.name]:s}),this.routeService(s,s.connections);else if(typeof s?.service=="function"&&(s.service=new s.service),s?.service?.__node?.nodes&&(s.service.name=t,s.service.__node.tag=t,this.addServices({[s.service.name]:s.service}),this.routeService(s.service)),typeof s?.service=="object"&&(s.connections&&(Array.isArray(s.connections)?s.connections.forEach(i=>{this.addServiceConnections(s[t].service,i)}):this.addServiceConnections(s.service,s.connections)),s.config))for(let i in s.config)this.openConnection(s.service,s.config[i],s.config[i].source,s.config[i].args)}}addUser=async(e,t,s,i)=>{let r;if(e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),this.users[e._id]?r=this.users[e._id]:r=Object.assign({},e),t){for(let o in t)typeof t[o]=="object"&&(t[o].connection._id||await new Promise((a,l)=>{let f=performance.now(),h=()=>{t[o].connection._id?a(!0):performance.now()-f>this.userTimeout?(delete t[o],l(!1)):setTimeout(()=>{h()},100)};h()}).catch(a=>{console.error("Connections timed out:",a)}));for(let o in t)t[o]=this.addConnection(t[o],r._id)}if(s)for(let o in s)this.openConnection(s[o].service,s[o],r._id,s[o].args);if(!this.users[e._id]){let o=(b,...w)=>{let m=this.getConnection(r._id,"send");if(m?.send)return m.send(b,...w)},a=(b,...w)=>{let m=this.getConnections(r._id,"send");for(let _ in m)if(m[_]?.send)return m[_].send(b,...w)},l=(b,w,...m)=>{let _=this.getConnection(r._id,"request");if(_?.request)return _.request(b,w,...m)},f=(b,w,...m)=>{let _=this.getConnections(r._id,"request"),k=[];for(let O in _)_[O]?.request&&k.push(_[O].request(b,w,...m));return Promise.all(k)},h=(b,w,m,..._)=>{let k=this.getConnection(r._id,"post");if(k?.post)return k.post(b,w,m,..._)},c=(b,w,m,..._)=>{let k=this.getConnections(r._id,"post");for(let O in k)k[O]?.post&&k[O].post(b,w,m,..._)},u=(b,w,m,..._)=>{let k=this.getConnection(r._id,"run");if(k?.run)return k.run(b,w,m,..._)},d=(b,w,m,..._)=>{let k=this.getConnections(r._id,"run"),O=[];for(let T in k)k[T]?.run&&O.push(k[T].run(b,w,m,..._));return Promise.all(O)},g=(b,w,...m)=>{let _=this.getConnection(r._id,"subscribe");if(_?.subscribe)return _.subscribe(b,w,...m)},y=(b,w,...m)=>{let _=this.getConnections(r._id,"subscribe"),k=[];for(let O in _)_[O]?.post&&k.push(_[O].subscribe(b,w,...m));return Promise.all(k)},x=(b,w,...m)=>{let _=this.getConnection(r._id,"unsubscribe");if(_?.unsubscribe)return _.unsubscribe(b,w,...m)},v=(b,w,...m)=>{let _=this.getConnections(r._id,"unsubscribe"),k=[];for(let O in _)_[O]?.post&&w?.[O]&&k.push(_[O].unsubscribe(b,w[O],...m));return Promise.all(k)},A=()=>this.removeUser(r);r.send=o,r.request=l,r.post=h,r.run=u,r.subscribe=g,r.unsubscribe=x,r.terminate=A,r.sendAll=a,r.requestAll=f,r.postAll=c,r.runAll=d,r.subscribeAll=y,r.unsubscribeAll=v,r.terminateAll=A,this.users[r._id]=r}if(t&&!i){let o={},a=!1;Object.keys(t).map((l,f)=>{t[l]?._id&&(o[`${f}`]=t[l]?._id,a=!0)}),a&&r.send({route:"addUser",args:[{_id:r._id},o,void 0,!0]})}return r};removeUser(e,t){return t&&this.removeConnection(e,t),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}getConnection=(e,t,s)=>{if(this.connections[e])return this.connections[e];if(this.sources[e]){if(t?.includes("All"))return this.users[e];if(s)if(t){if(this.sources[e][s]?.[t])return this.sources[e][s]}else return this.sources[e][s]?this.sources[e][s]:void 0;else if(this.order)for(let i=0;i<this.order.length;i++){let r=this.order[i];for(let o in this.sources[e])if(this.sources[e][o].service){if(typeof this.sources[e][o].service=="object"){if(this.sources[e][o].service.__node.tag===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name&&!this.serviceConnections[this.sources[e][o].service.name]){this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}else if(this.sources[e][o].service===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name){this.serviceConnections[this.sources[e][o].service.name]||this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}}else for(let i in this.sources[e]){if(this.sources[e][i].connectionType&&this.sources[e][i].service?.name&&!this.serviceConnections[this.sources[e][i].service.name]){this.removeConnection(this.sources[e][i]);continue}if(t){if(this.sources[e][i][t])return this.sources[e][i]}else return this.sources[e][i]}}else if(this.order&&!this.connections[e])for(let i=0;i<this.order.length;i++){let r=this.order[i];if(this.sources[r]?.[e]){if(this.sources[r][e].connectionType&&this.sources[r][e].service?.name&&!this.serviceConnections[this.sources[r][e].service.service.name]){this.removeConnection(this.sources[r][e].service);continue}if(t){if(this.sources[r][e][t])return this.sources[r][e]}else return this.sources[r][e]}}};getConnections=(e,t,s)=>{if(this.sources[e]){if(!s&&!t)return this.sources[e];let i={};for(let r in this.sources[e])if(typeof this.sources[e][r]=="object"){if(this.sources[e][r]._id){let o=!0;if(t&&!this.sources[e][r][t]&&(o=!1),s)for(let a in s)if(typeof this.sources[e][r][a]=="object"&&typeof s[a]=="object"){for(let l in s[a])if(s[a][l]!==this.sources[e][r][a][l]){o=!1;break}}else if(this.sources[e][r][a]!==s[a])o=!1;else{o=!1;break}o&&(i[this.sources[e][r]._id]=this.sources[e][r])}else for(let o in this.sources[e][r])if(typeof this.sources[e][r][o]=="object"){let a=!0;if(t&&!this.sources[e][r][o][t]&&(a=!1),s)for(let l in s)if(typeof this.sources[e][r][o][l]=="object"&&typeof s[l]=="object"){for(let f in s[l])if(s[l][f]!==this.sources[e][r][o][l][f]){a=!1;break}}else if(this.sources[e][r][o][l]!==s[l])a=!1;else{a=!1;break}a&&(i[this.sources[e][r][o]._id]=this.sources[e][r][o])}}return i}};runConnection=async(e,t,s,i)=>{let r;if(t.indexOf("All")>-1?r=this.users[e]:r=this.getConnection(e,t,i),r){let o=r[t](...s);return o=await o,o}};subscribeThroughConnection=(e,t,s,i,...r)=>{if(typeof t=="string"&&(t=this.getConnection(t,"run")),typeof t=="object")return new Promise((o,a)=>{t.run("routeConnections",[e,s,t._id,...r]).then(l=>{this.__node.state.subscribeEvent(s,f=>{f?.callbackId===e&&(i?typeof i=="string"?this.setState({[i]:f.args}):i(f.args):this.setState({[s]:f.args}))}),o(l)}).catch(a)})};addConnection=(e,t,s=!0)=>{let i={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let r in this.serviceConnections)for(let o in this.serviceConnections[r])if(this.serviceConnections[r][o][e]){e={connection:this.serviceConnections[r][o][e]},e.service=r,i.connectionType=r,i.connectionsKey=o;break}typeof e=="string"&&this.__node.nodes.get(e)&&(e={connection:this.__node.nodes.get(e)})}if(!(!e||typeof e=="string")){if(t&&(i.source=t),e.connection instanceof P){i.connection=e.connection;let r=i.connection;i.send=async o=>o.method?Array.isArray(o.args)?r[o.method]?.(...o.args):r[o.method]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.request=async(o,a)=>a?Array.isArray(o.args)?r[a]?.(...o.args):r[a]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.post=async(o,a,l)=>{if(o&&r.__node.graph.get(o)){let f=r.__node.graph.get(o);return l?Array.isArray(a)?f[l]?.(...a):f[l]?.(a):Array.isArray(a)?f.__operator(...a):f.__operator(a)}else return l?Array.isArray(a)?r[l]?.(...a):r[l]?.(a):Array.isArray(a)?r.__operator(...a):r.__operator(a)},i.run=i.post,i.subscribe=async o=>r.__subscribe(o),i.unsubscribe=async o=>r.__unsubscribe(o),i.terminate=()=>(r.__node.graph.remove(r),!0),i.onclose=e.onclose,i.onclose&&r.__addOndisconnected(o=>{i.onclose&&i.onclose(i,o)})}else if(e.connection instanceof q){e.connection.__node.nodes.get("open")&&(i.service=e.connection);let r=i.connection;i.send=async o=>{Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.request=async(o,a)=>{if(o.route)return a?Array.isArray(o.args)?r.__node.nodes.get(o.route)[a]?.(...o.args):r.__node.nodes.get(o.route)[a]?.(o.args):Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.post=async(o,a,l)=>{if(o&&r.get(o)){let f=r.get(o);return l?Array.isArray(a)?f[l]?.(...a):f[l]?.(a):Array.isArray(a)?f.run(...a):f.run(a)}},i.run=i.post,i.subscribe=async(o,a)=>r.subscribe(o,a),i.unsubscribe=async(o,a)=>r.unsubscribe(o,a),i.terminate=o=>(r.remove(o),!0)}else if(!(e._id&&this.connections[e._id])){let r=e.connection;if(typeof r=="string"){if(this.connections[r])r=this.connections[r];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let o in e.service.connections)if(e.service.connections[o][r]){r=e.service.connections[o][r],i.connectionType=o,i.connectionsKey=r;break}}}else for(let o in this.serviceConnections)for(let a in this.serviceConnections[o])if(this.serviceConnections[o][a][r]){r=this.serviceConnections[o][a][r],e.service=o,i.connectionType=o,i.connectionsKey=a;break}}if(typeof r!="object")return;if(i._id=r._id,i.connection=e.connection,i.send=r.send,i.request=r.request,i.run=r.run,i.post=r.post,i.subscribe=r.subscribe,i.unsubscribe=r.unsubscribe,i.terminate=r.terminate,i.onclose=e.onclose,i.onclose){if(!(r.onclose&&i.onclose.toString()===r.onclose.toString())){let o=r.onclose;r.onclose=(...a)=>{i.onclose&&i.onclose(i,...a),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}}else{let o=r.onclose;r.onclose=(...a)=>{this.removeConnection(i),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),i.service=e.service):r.graph&&(i.service=r.graph)}return!i.source&&e.source?i.source=e.source:!i.source&&e.service?i.source=typeof e.service=="object"?e.service?.name:void 0:!i.source&&(i.connection instanceof P||i.connection instanceof q)&&(i.source="local",this.order.indexOf("local")||this.order.unshift("local")),i._id||(i._id=`connection${Math.floor(Math.random()*1e15)}`),i.source&&(this.sources[i.source]||(this.sources[i.source]={}),this.sources[i.source][i._id]=i),this.connections[i._id]||(this.connections[i._id]=i),i}};removeConnection=(e,t=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){t&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let s in this.sources)if(this.sources[s][e])delete this.sources[s][e];else for(let i in this.sources[s])this.sources[s][i]?.[e]&&delete this.sources[s][e];return!0}else if(this.sources[e]){for(let s in this.sources[e])this.removeConnection(this.sources[e][s],t);return!0}}};routeService=(e,t,s,i)=>{if(this.services[e.name]=e,e.__node?.nodes&&this.__node.nodes.forEach((r,o)=>{e.__node?.nodes.get(o)?e.__node?.nodes.set(this.name+"."+o,r):e.__node?.nodes.set(o,r)}),e.users&&(e.users=this.users),t)if(typeof t=="string")this.addServiceConnections(e,t,s);else for(let r in t)this.addServiceConnections(e,r,s);i?this.order=i:(this.order||(this.order=[]),this.order.push(e.name))};addServiceConnections=(e,t,s)=>{if(typeof e=="string"&&(e=this.services[e]),t&&e[t]){let i={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][t]=e[t];for(let r in e[t])this.connections[r]||(i[r]=this.addConnection({connection:e[t][r],service:e},s),i[r].connectionType=t);return i}};openConnection=async(e,t,s,...i)=>{if(typeof e=="string"&&(e=this.services[e]),e?.__node.nodes){let r=e.run("open",t,...i);if(r instanceof Promise)return r.then(async o=>{o._id||await jt(o,this.userTimeout),o._id&&this.addConnection({connection:o,service:e},s)});if(r&&(r._id||await jt(r,this.userTimeout),r._id))return this.addConnection({connection:r,service:e},s)}};terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());routeConnections=(e,t,s,...i)=>{let r;if(typeof s=="string"&&(this.sources[s]&&(r=s),s=this.getConnection(s,"send")),typeof t=="string"&&(t=this.getConnection(t,"subscribe")),t?.subscribe&&s?.send)return new Promise((a,l)=>{t.subscribe(e,f=>{!this.connections[s._id]&&r&&this.sources[r]&&(r=s,Object.keys(this.sources[r]).forEach(h=>{this.sources[s][h].send&&(s=this.sources[s][h])})),this.connections[s._id]&&s.send({callbackId:e,args:f})},...i).then(f=>{a(f)})})};setUserData=(e,t)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object")return this.recursivelyAssign(e,t),!0}};function jt(n,e=1e4){return new Promise((t,s)=>{let i=performance.now(),r=()=>{n._id?t(!0):performance.now()-i>e?s(!1):setTimeout(()=>{r()},100)};r()}).catch(t=>{console.error("Connection timed out:",t)})}var Qe=class{_raw=[];constructor(e){e&&(this._raw=[...e])}get buffer(){let e=this._raw;return this._raw=[],e}set buffer(e){if(Array.isArray(e))this._raw.push(...e);else throw new Error("Input must be an array")}clear(){this._raw.length=0}push(...e){e.length>1?this._raw.push(...e):Array.isArray(e[0])?this._raw.push(...e[0]):this._raw.push(e[0])}get length(){return this._raw.length}set length(e){this._raw.length=e}},et=class{_raw;_size;onfilled;_count=0;constructor(e,t){if(e<=0)throw new Error("Size must be greater than 0");this._size=e,this._raw=new Array(e),t&&this.push(t)}get buffer(){return this._count<this._size?this._raw.slice(this._size-this._count):[...this._raw]}clear(){this._raw.length=0}set buffer(e){this.push(e)}push(...e){e.length>1?this.pushArray(e):Array.isArray(e[0])?this.pushArray(e[0]):(this._raw.length>=this._size&&this._raw.splice(0,1),this._raw.push(e[0]),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&this._count++)}pushArray(e){let t=e.length,s=this._raw.length+t;s>this._size&&this._raw.splice(0,s-this._size),this._raw.push(...e),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&(this._count+=e.length,this._count>this._size&&(this._count=this._size))}get length(){return this._count}set length(e){if(e<0||e>this._size)throw new Error(`Length must be between 0 and ${this._size}`);this._count=e}},tt=class{_buffer={};bufferHasData;_rules;_pollInterval;_pollTimeout;onupdate;prevState;constructor(e,t){this._pollInterval=t,this.setRules(e)}setRules(e){this._rules?Object.assign(this._rules,e):this._rules=e}clearRules(e){for(let t of e)delete this._rules[t]}set buffer(e){for(let t in e){let s=this._rules[t];if(!s)continue;let i=e[t];s==="state"||s===!0?(this._buffer[t]=i,this.bufferHasData=!0):s==="inpbuf"?(this._buffer[t]||(this._buffer[t]=new Qe),this._buffer[t].push(i),this.bufferHasData=!0):s?.type==="circbuf"&&(this._buffer[t]||(this._buffer[t]=new et(s.length)),this._buffer[t].push(i),this.bufferHasData=!0)}}get buffer(){let e={};for(let t in this._buffer)this._buffer[t]!==void 0&&(this._buffer[t]?._raw?(e[t]=this._buffer[t].buffer,this._buffer[t].clear()):(e[t]=this._buffer[t],delete this._buffer[t]));return this.bufferHasData=!1,e}clear(){this._buffer={},this.bufferHasData=!1}startPolling(e){e&&(this.onupdate=e),this._pollInterval&&!this._pollTimeout&&(this._pollTimeout=setInterval(()=>{if(this.bufferHasData&&this.onupdate){let t=this.buffer;this.prevState=t,this.onupdate(t),this.clear()}},this._pollInterval))}stopPolling(){this._pollTimeout&&(clearInterval(this._pollTimeout),this._pollTimeout=void 0)}},xe=class{buffers={};pollInterval;pollTimeout;onupdate;prevState;constructor(e){this.pollInterval=e}createBuffer(e,t,s){if(this.buffers[e])throw new Error(`Buffer with name ${e} already exists`);let i=new tt(t,s);this.buffers[e]=i}deleteBuffer(e){delete this.buffers[e]}get(e){return this.buffers[e]}updateBuffer(e,t){if(this.buffers[e])this.buffers[e].buffer=t;else throw new Error("No buffer found of name "+e)}aggregateBuffers(){let e={};for(let t in this.buffers)if(this.buffers[t].bufferHasData){let s=this.buffers[t].buffer;e[t]=s,this.buffers[t].clear()}this.prevState=e,this.onupdate&&Object.keys(e).length>0&&this.onupdate(e)}startPolling(e){e&&(this.onupdate=e),this.pollInterval&&!this.pollTimeout&&(this.pollTimeout=setInterval(()=>{this.aggregateBuffers()},this.pollInterval))}stopPolling(){this.pollTimeout&&(clearInterval(this.pollTimeout),this.pollTimeout=void 0)}};var Ae=class{sessions={};delayBufferManager;globalPollInterval=1e3;tokens={};useTokens=!1;prevState;onupdate;constructor(e,t,s){e&&(this.globalPollInterval=e),t&&(this.onupdate=t),s!==void 0&&(this.useTokens=s),this.delayBufferManager=new xe(this.globalPollInterval),this.delayBufferManager.onupdate=i=>{if(this.onupdate){let r=Object.keys(i),o={};r.forEach(a=>{o[a]=this.sessions[a]}),this.prevState=i,this.onupdate(i,o)}else console.log("Buffers updated:",i)}}createSession=(e,t,s,i,r)=>{if(this.sessions[e])return new Error(`Session with ID ${e} already exists`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==r))return new Error(`Invalid token for user ${t}`);this.delayBufferManager.createBuffer(e,s);let o={password:i?.password,bannedUsers:i?.bannedUsers||{},adminUsers:i?.adminUsers||{}};o.adminUsers[t]=!0,this.sessions[e]={users:{},rules:o,db:this.delayBufferManager.get(e)},this.addUserToSession(e,t,r,i?.password)};deleteSession=(e,t,s)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);(this.checkAdmin(e,t,s)||Object.keys(i.rules.adminUsers).length===0||Object.keys(i.users).length===0)&&(this.delayBufferManager.deleteBuffer(e),delete this.sessions[e])};clearUserToken=e=>{delete this.tokens[e]};getSessionInfo=(e,t,s)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);let r=this.delayBufferManager.get(e)?._rules;return{_id:e,users:Object.keys(i.users),dbrules:r}};checkAdmin(e,t,s){let i=this.sessions[e];return this.useTokens&&(!i.rules.adminUsers[t]||this.tokens[t]!==s)?(console.error(`User ${t} does not have admin privileges or invalid token`),!1):!0}updateSessions=(e,t,s,i,r,o)=>{for(let a in e)this.updateBuffer(a,e[a],t,s,i?.[a],r,o)};updateBuffer=(e,t,s,i,r,o,a)=>{let l=this.sessions[e];l&&(!this.useTokens||s&&l.users[s]&&this.tokens[s]===i||o&&this.checkAdmin(e,o,a)||l.rules.password&&l.rules.password===r)&&this.delayBufferManager.updateBuffer(e,t)};addUserToSession=(e,t,s,i,r,o,a)=>{let l=this.sessions[e];if(!l)return new Error(`Session with ID ${e} does not exist`);if(l.rules.password&&l.rules.password!==i||a&&!this.checkAdmin(e,o,a))return new Error("Password required or invalid admin token");if(l.rules.bannedUsers&&l.rules.bannedUsers[t])return new Error(`User ${t} is banned from this session`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);l.users[t]=!0,r&&l.db.setRules(r)};removeUserFromSession=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);r.users[t]&&this.checkAdmin(e,s,i)&&delete r.users[t]};setAdmin=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,i)&&(r.rules.adminUsers[t]=!0)};removeAdmin=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);Object.keys(r.rules.adminUsers).length>1&&this.checkAdmin(e,s,i)&&delete r.rules.adminUsers[t]};banUser=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,t,i)&&(r.rules.bannedUsers[s]=!0,this.removeUserFromSession(e,s,t,i))};unbanUser=(e,t,s,i)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,i)&&delete r.rules.bannedUsers[t]};splitUpdatesByUser=e=>{let t={};return Object.keys(e).forEach(s=>{let i=this.sessions[s];if(!i)return;let r=e[s];r&&Object.keys(i.users).forEach(o=>{t[o]||(t[o]={}),t[o][s]=r})}),t};startPolling=()=>{this.delayBufferManager.startPolling()};stopPolling=()=>{this.delayBufferManager.stopPolling()};setSessionToken=(e,t)=>{this.tokens[e]=t};generateSessionToken=e=>{let t=`${Math.floor(Math.random()*1e15)}`;return e&&(this.tokens[e]=t),t}};var Mt=class extends C{users={};sessionManager;sessionData={};onlocalupdate;onremoteupdate;constructor(e,t,s,i,r=!1){if(super(e),i){this.users=i;for(let l in i)i[l]._id||(i[l]._id=l)}s&&(this.onlocalupdate=s),this.sessionManager=new Ae(t||1e3,(l,f)=>{let h=this.sessionManager.splitUpdatesByUser(l);for(let c in h)this.onlocalupdate?this.onlocalupdate(h[c],f,this.users[c]):this.users[c]?.send&&this.users[c].send({route:"receiveSessionData",args:[h[c],c]})},r);let o={},a=Object.getOwnPropertyNames(this.sessionManager);for(let l of a)l!=="createSession"&&l!=="updateSessions"&&l!=="updateBuffer"&&l!=="setSessionToken"&&l!=="generateSessionToken"&&l!=="startPolling"&&l!=="stopPolling"&&typeof this.sessionManager[l]=="function"&&(o[l]=(...f)=>{let h=this.sessionManager[l](...f);h instanceof Error&&console.error(h)});this.load(this),this.load(o)}get prevState(){if(this.sessionManager?.prevState)return this.sessionManager.prevState}setSessionToken=(e,t,s)=>{if(this.sessionManager.setSessionToken(e,t),s&&this.users[e]?.send){let i={route:"setSessionToken",args:[e,t]};this.users[e].send(i)}else this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t};generateSessionToken=e=>{let t=this.sessionManager.generateSessionToken(e);return e&&this.users[e]&&(this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t),t};messageRemoteSession=(e,t,...s)=>{this.users[e].send({route:t,args:s})};receiveSessionData=(e,t)=>{let s={};for(let i in e)this.sessionData[i]||(this.sessionData[i]={}),this.recursivelyAssign(this.sessionData[i]||{},e),s=this.sessionData[i];return this.onremoteupdate&&this.onremoteupdate(s,this.users[t]),s};createSession=(e,t,s,i,r)=>this.sessionManager.createSession(e,t,s,i,r);updateSessions=(e,t,s,i,r,o)=>this.sessionManager.updateSessions(e,t,s,i,r,o);updateBuffer=(e,t,s,i,r,o,a)=>this.sessionManager.updateBuffer(e,t,s,i,r,o,a);startPolling=()=>this.sessionManager.startPolling();stopPolling=()=>this.sessionManager.stopPolling()};var p={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(n){this.toString=function(){return"CORRUPT: "+this.message},this.message=n},invalid:function(n){this.toString=function(){return"INVALID: "+this.message},this.message=n},bug:function(n){this.toString=function(){return"BUG: "+this.message},this.message=n},notReady:function(n){this.toString=function(){return"NOT READY: "+this.message},this.message=n}}};p.cipher.aes=function(n){this.s[0][0][0]||this.O();var e,t,s,i,r=this.s[0][4],o=this.s[1];e=n.length;var a=1;if(e!==4&&e!==6&&e!==8)throw new p.exception.invalid("invalid aes key size");for(this.b=[s=n.slice(0),i=[]],n=e;n<4*e+28;n++)t=s[n-1],(n%e===0||e===8&&n%e===4)&&(t=r[t>>>24]<<24^r[t>>16&255]<<16^r[t>>8&255]<<8^r[t&255],n%e===0&&(t=t<<8^t>>>24^a<<24,a=a<<1^283*(a>>7))),s[n]=s[n-e]^t;for(e=0;n;e++,n--)t=s[e&3?n:n-4],i[e]=4>=n||4>e?t:o[0][r[t>>>24]]^o[1][r[t>>16&255]]^o[2][r[t>>8&255]]^o[3][r[t&255]]};p.cipher.aes.prototype={encrypt:function(n){return ti(this,n,0)},decrypt:function(n){return ti(this,n,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var n=this.s[0],e=this.s[1],t=n[4],s=e[4],i,r,o,a=[],l=[],f,h,c,u;for(i=0;256>i;i++)l[(a[i]=i<<1^283*(i>>7))^i]=i;for(r=o=0;!t[r];r^=f||1,o=l[o]||1)for(c=o^o<<1^o<<2^o<<3^o<<4,c=c>>8^c&255^99,t[r]=c,s[c]=r,h=a[i=a[f=a[r]]],u=16843009*h^65537*i^257*f^16843008*r,h=257*a[c]^16843008*c,i=0;4>i;i++)n[i][r]=h=h<<24^h>>>8,e[i][c]=u=u<<24^u>>>8;for(i=0;5>i;i++)n[i]=n[i].slice(0),e[i]=e[i].slice(0)}};function ti(n,e,t){if(e.length!==4)throw new p.exception.invalid("invalid aes block size");var s=n.b[t],i=e[0]^s[0],r=e[t?3:1]^s[1],o=e[2]^s[2];e=e[t?1:3]^s[3];var a,l,f,h=s.length/4-2,c,u=4,d=[0,0,0,0];a=n.s[t],n=a[0];var g=a[1],y=a[2],x=a[3],v=a[4];for(c=0;c<h;c++)a=n[i>>>24]^g[r>>16&255]^y[o>>8&255]^x[e&255]^s[u],l=n[r>>>24]^g[o>>16&255]^y[e>>8&255]^x[i&255]^s[u+1],f=n[o>>>24]^g[e>>16&255]^y[i>>8&255]^x[r&255]^s[u+2],e=n[e>>>24]^g[i>>16&255]^y[r>>8&255]^x[o&255]^s[u+3],u+=4,i=a,r=l,o=f;for(c=0;4>c;c++)d[t?3&-c:c]=v[i>>>24]<<24^v[r>>16&255]<<16^v[o>>8&255]<<8^v[e&255]^s[u++],a=i,i=r,r=o,o=e,e=a;return d}p.bitArray={bitSlice:function(n,e,t){return n=p.bitArray.$(n.slice(e/32),32-(e&31)).slice(1),t===void 0?n:p.bitArray.clamp(n,t-e)},extract:function(n,e,t){var s=Math.floor(-e-t&31);return((e+t-1^e)&-32?n[e/32|0]<<32-s^n[e/32+1|0]>>>s:n[e/32|0]>>>s)&(1<<t)-1},concat:function(n,e){if(n.length===0||e.length===0)return n.concat(e);var t=n[n.length-1],s=p.bitArray.getPartial(t);return s===32?n.concat(e):p.bitArray.$(e,s,t|0,n.slice(0,n.length-1))},bitLength:function(n){var e=n.length;return e===0?0:32*(e-1)+p.bitArray.getPartial(n[e-1])},clamp:function(n,e){if(32*n.length<e)return n;n=n.slice(0,Math.ceil(e/32));var t=n.length;return e=e&31,0<t&&e&&(n[t-1]=p.bitArray.partial(e,n[t-1]&2147483648>>e-1,1)),n},partial:function(n,e,t){return n===32?e:(t?e|0:e<<32-n)+1099511627776*n},getPartial:function(n){return Math.round(n/1099511627776)||32},equal:function(n,e){if(p.bitArray.bitLength(n)!==p.bitArray.bitLength(e))return!1;var t=0,s;for(s=0;s<n.length;s++)t|=n[s]^e[s];return t===0},$:function(n,e,t,s){var i;for(i=0,s===void 0&&(s=[]);32<=e;e-=32)s.push(t),t=0;if(e===0)return s.concat(n);for(i=0;i<n.length;i++)s.push(t|n[i]>>>e),t=n[i]<<32-e;return i=n.length?n[n.length-1]:0,n=p.bitArray.getPartial(i),s.push(p.bitArray.partial(e+n&31,32<e+n?t:s.pop(),1)),s},i:function(n,e){return[n[0]^e[0],n[1]^e[1],n[2]^e[2],n[3]^e[3]]},byteswapM:function(n){var e,t;for(e=0;e<n.length;++e)t=n[e],n[e]=t>>>24|t>>>8&65280|(t&65280)<<8|t<<24;return n}};p.codec.utf8String={fromBits:function(n){var e="",t=p.bitArray.bitLength(n),s,i;for(s=0;s<t/8;s++)!(s&3)&&(i=n[s/4]),e+=String.fromCharCode(i>>>8>>>8>>>8),i<<=8;return decodeURIComponent(escape(e))},toBits:function(n){n=unescape(encodeURIComponent(n));var e=[],t,s=0;for(t=0;t<n.length;t++)s=s<<8|n.charCodeAt(t),(t&3)===3&&(e.push(s),s=0);return t&3&&e.push(p.bitArray.partial(8*(t&3),s)),e}};p.codec.hex={fromBits:function(n){var e="",t;for(t=0;t<n.length;t++)e+=((n[t]|0)+0xf00000000000).toString(16).substr(4);return e.substr(0,p.bitArray.bitLength(n)/4)},toBits:function(n){var e,t=[],s;for(n=n.replace(/\s|0x/g,""),s=n.length,n=n+"00000000",e=0;e<n.length;e+=8)t.push(parseInt(n.substr(e,8),16)^0);return p.bitArray.clamp(t,4*s)}};p.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(n,e,t){var s=p.codec.base32.BASE,i=p.codec.base32.REMAINING,r="",o=0,a=p.codec.base32.B,l=0,f=p.bitArray.bitLength(n);for(t&&(a=p.codec.base32.X),t=0;r.length*s<f;)r+=a.charAt((l^n[t]>>>o)>>>i),o<s?(l=n[t]<<s-o,o+=i,t++):(l<<=s,o-=s);for(;r.length&7&&!e;)r+="=";return r},toBits:function(n,e){n=n.replace(/\s|=/g,"").toUpperCase();var t=p.codec.base32.BITS,s=p.codec.base32.BASE,i=p.codec.base32.REMAINING,r=[],o,a=0,l=p.codec.base32.B,f=0,h,c="base32";for(e&&(l=p.codec.base32.X,c="base32hex"),o=0;o<n.length;o++){if(h=l.indexOf(n.charAt(o)),0>h){if(!e)try{return p.codec.base32hex.toBits(n)}catch{}throw new p.exception.invalid("this isn't "+c+"!")}a>i?(a-=i,r.push(f^h>>>a),f=h<<t-a):(a+=s,f^=h<<t-a)}return a&56&&r.push(p.bitArray.partial(a&56,f,1)),r}};p.codec.base32hex={fromBits:function(n,e){return p.codec.base32.fromBits(n,e,1)},toBits:function(n){return p.codec.base32.toBits(n,1)}};p.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(n,e,t){var s="",i=0,r=p.codec.base64.B,o=0,a=p.bitArray.bitLength(n);for(t&&(r=r.substr(0,62)+"-_"),t=0;6*s.length<a;)s+=r.charAt((o^n[t]>>>i)>>>26),6>i?(o=n[t]<<6-i,i+=26,t++):(o<<=6,i-=6);for(;s.length&3&&!e;)s+="=";return s},toBits:function(n,e){n=n.replace(/\s|=/g,"");var t=[],s,i=0,r=p.codec.base64.B,o=0,a;for(e&&(r=r.substr(0,62)+"-_"),s=0;s<n.length;s++){if(a=r.indexOf(n.charAt(s)),0>a)throw new p.exception.invalid("this isn't base64!");26<i?(i-=26,t.push(o^a>>>i),o=a<<32-i):(i+=6,o^=a<<32-i)}return i&56&&t.push(p.bitArray.partial(i&56,o,1)),t}};p.codec.base64url={fromBits:function(n){return p.codec.base64.fromBits(n,1,1)},toBits:function(n){return p.codec.base64.toBits(n,1)}};p.hash.sha256=function(n){this.b[0]||this.O(),n?(this.F=n.F.slice(0),this.A=n.A.slice(0),this.l=n.l):this.reset()};p.hash.sha256.hash=function(n){return new p.hash.sha256().update(n).finalize()};p.hash.sha256.prototype={blockSize:512,reset:function(){return this.F=this.Y.slice(0),this.A=[],this.l=0,this},update:function(n){typeof n=="string"&&(n=p.codec.utf8String.toBits(n));var e,t=this.A=p.bitArray.concat(this.A,n);if(e=this.l,n=this.l=e+p.bitArray.bitLength(n),9007199254740991<n)throw new p.exception.invalid("Cannot hash more than 2^53 - 1 bits");if(typeof Uint32Array<"u"){var s=new Uint32Array(t),i=0;for(e=512+e-(512+e&511);e<=n;e+=512)Rt(this,s.subarray(16*i,16*(i+1))),i+=1;t.splice(0,16*i)}else for(e=512+e-(512+e&511);e<=n;e+=512)Rt(this,t.splice(0,16));return this},finalize:function(){var n,t=this.A,e=this.F,t=p.bitArray.concat(t,[p.bitArray.partial(1,1)]);for(n=t.length+2;n&15;n++)t.push(0);for(t.push(Math.floor(this.l/4294967296)),t.push(this.l|0);t.length;)Rt(this,t.splice(0,16));return this.reset(),e},Y:[],b:[],O:function(){function n(r){return 4294967296*(r-Math.floor(r))|0}for(var e=0,t=2,s,i;64>e;t++){for(i=!0,s=2;s*s<=t;s++)if(t%s===0){i=!1;break}i&&(8>e&&(this.Y[e]=n(Math.pow(t,.5))),this.b[e]=n(Math.pow(t,1/3)),e++)}}};function Rt(n,e){var t,s,i,r=n.F,o=n.b,a=r[0],l=r[1],f=r[2],h=r[3],c=r[4],u=r[5],d=r[6],g=r[7];for(t=0;64>t;t++)16>t?s=e[t]:(s=e[t+1&15],i=e[t+14&15],s=e[t&15]=(s>>>7^s>>>18^s>>>3^s<<25^s<<14)+(i>>>17^i>>>19^i>>>10^i<<15^i<<13)+e[t&15]+e[t+9&15]|0),s=s+g+(c>>>6^c>>>11^c>>>25^c<<26^c<<21^c<<7)+(d^c&(u^d))+o[t],g=d,d=u,u=c,c=h+s|0,h=f,f=l,l=a,a=s+(l&f^h&(l^f))+(l>>>2^l>>>13^l>>>22^l<<30^l<<19^l<<10)|0;r[0]=r[0]+a|0,r[1]=r[1]+l|0,r[2]=r[2]+f|0,r[3]=r[3]+h|0,r[4]=r[4]+c|0,r[5]=r[5]+u|0,r[6]=r[6]+d|0,r[7]=r[7]+g|0}p.mode.ccm={name:"ccm",G:[],listenProgress:function(n){p.mode.ccm.G.push(n)},unListenProgress:function(n){n=p.mode.ccm.G.indexOf(n),-1<n&&p.mode.ccm.G.splice(n,1)},fa:function(n){var e=p.mode.ccm.G.slice(),t;for(t=0;t<e.length;t+=1)e[t](n)},encrypt:function(n,e,t,s,i){var r,o=e.slice(0),a=p.bitArray,l=a.bitLength(t)/8,f=a.bitLength(o)/8;if(i=i||64,s=s||[],7>l)throw new p.exception.invalid("ccm: iv must be at least 7 bytes");for(r=2;4>r&&f>>>8*r;r++);return r<15-l&&(r=15-l),t=a.clamp(t,8*(15-r)),e=p.mode.ccm.V(n,e,t,s,i,r),o=p.mode.ccm.C(n,o,t,e,i,r),a.concat(o.data,o.tag)},decrypt:function(n,e,t,s,i){i=i||64,s=s||[];var r=p.bitArray,o=r.bitLength(t)/8,f=r.bitLength(e),a=r.clamp(e,f-i),l=r.bitSlice(e,f-i),f=(f-i)/8;if(7>o)throw new p.exception.invalid("ccm: iv must be at least 7 bytes");for(e=2;4>e&&f>>>8*e;e++);if(e<15-o&&(e=15-o),t=r.clamp(t,8*(15-e)),a=p.mode.ccm.C(n,a,t,l,i,e),n=p.mode.ccm.V(n,a.data,t,s,i,e),!r.equal(a.tag,n))throw new p.exception.corrupt("ccm: tag doesn't match");return a.data},na:function(n,e,t,s,i,r){var o=[],a=p.bitArray,l=a.i;if(s=[a.partial(8,(e.length?64:0)|s-2<<2|r-1)],s=a.concat(s,t),s[3]|=i,s=n.encrypt(s),e.length)for(t=a.bitLength(e)/8,65279>=t?o=[a.partial(16,t)]:4294967295>=t&&(o=a.concat([a.partial(16,65534)],[t])),o=a.concat(o,e),e=0;e<o.length;e+=4)s=n.encrypt(l(s,o.slice(e,e+4).concat([0,0,0])));return s},V:function(n,e,t,s,i,r){var o=p.bitArray,a=o.i;if(i/=8,i%2||4>i||16<i)throw new p.exception.invalid("ccm: invalid tag length");if(4294967295<s.length||4294967295<e.length)throw new p.exception.bug("ccm: can't deal with 4GiB or more data");for(t=p.mode.ccm.na(n,s,t,i,o.bitLength(e)/8,r),s=0;s<e.length;s+=4)t=n.encrypt(a(t,e.slice(s,s+4).concat([0,0,0])));return o.clamp(t,8*i)},C:function(n,e,t,s,i,r){var o,a=p.bitArray;o=a.i;var l=e.length,f=a.bitLength(e),h=l/50,c=h;if(t=a.concat([a.partial(8,r-1)],t).concat([0,0,0]).slice(0,4),s=a.bitSlice(o(s,n.encrypt(t)),0,i),!l)return{tag:s,data:[]};for(o=0;o<l;o+=4)o>h&&(p.mode.ccm.fa(o/l),h+=c),t[3]++,i=n.encrypt(t),e[o]^=i[0],e[o+1]^=i[1],e[o+2]^=i[2],e[o+3]^=i[3];return{tag:s,data:a.clamp(e,f)}}};p.mode.ocb2={name:"ocb2",encrypt:function(n,e,t,s,i,r){if(p.bitArray.bitLength(t)!==128)throw new p.exception.invalid("ocb iv must be 128 bits");var o,a=p.mode.ocb2.S,l=p.bitArray,f=l.i,h=[0,0,0,0];t=a(n.encrypt(t));var c,u=[];for(s=s||[],i=i||64,o=0;o+4<e.length;o+=4)c=e.slice(o,o+4),h=f(h,c),u=u.concat(f(t,n.encrypt(f(t,c)))),t=a(t);return c=e.slice(o),e=l.bitLength(c),o=n.encrypt(f(t,[0,0,0,e])),c=l.clamp(f(c.concat([0,0,0]),o),e),h=f(h,f(c.concat([0,0,0]),o)),h=n.encrypt(f(h,f(t,a(t)))),s.length&&(h=f(h,r?s:p.mode.ocb2.pmac(n,s))),u.concat(l.concat(c,l.clamp(h,i)))},decrypt:function(n,e,t,s,i,r){if(p.bitArray.bitLength(t)!==128)throw new p.exception.invalid("ocb iv must be 128 bits");i=i||64;var o=p.mode.ocb2.S,a=p.bitArray,l=a.i,f=[0,0,0,0],h=o(n.encrypt(t)),c,u,d=p.bitArray.bitLength(e)-i,g=[];for(s=s||[],t=0;t+4<d/32;t+=4)c=l(h,n.decrypt(l(h,e.slice(t,t+4)))),f=l(f,c),g=g.concat(c),h=o(h);if(u=d-32*t,c=n.encrypt(l(h,[0,0,0,u])),c=l(c,a.clamp(e.slice(t),u).concat([0,0,0])),f=l(f,c),f=n.encrypt(l(f,l(h,o(h)))),s.length&&(f=l(f,r?s:p.mode.ocb2.pmac(n,s))),!a.equal(a.clamp(f,i),a.bitSlice(e,d)))throw new p.exception.corrupt("ocb: tag doesn't match");return g.concat(a.clamp(c,u))},pmac:function(n,e){var t,s=p.mode.ocb2.S,i=p.bitArray,r=i.i,o=[0,0,0,0],a=n.encrypt([0,0,0,0]),a=r(a,s(s(a)));for(t=0;t+4<e.length;t+=4)a=s(a),o=r(o,n.encrypt(r(a,e.slice(t,t+4))));return t=e.slice(t),128>i.bitLength(t)&&(a=r(a,s(a)),t=i.concat(t,[-2147483648,0,0,0])),o=r(o,t),n.encrypt(r(s(r(a,s(a))),o))},S:function(n){return[n[0]<<1^n[1]>>>31,n[1]<<1^n[2]>>>31,n[2]<<1^n[3]>>>31,n[3]<<1^135*(n[0]>>>31)]}};p.mode.gcm={name:"gcm",encrypt:function(n,e,t,s,i){var r=e.slice(0);return e=p.bitArray,s=s||[],n=p.mode.gcm.C(!0,n,r,s,t,i||128),e.concat(n.data,n.tag)},decrypt:function(n,e,t,s,i){var r=e.slice(0),o=p.bitArray,a=o.bitLength(r);if(i=i||128,s=s||[],i<=a?(e=o.bitSlice(r,a-i),r=o.bitSlice(r,0,a-i)):(e=r,r=[]),n=p.mode.gcm.C(!1,n,r,s,t,i),!o.equal(n.tag,e))throw new p.exception.corrupt("gcm: tag doesn't match");return n.data},ka:function(n,e){var t,s,i,r,o,a=p.bitArray.i;for(i=[0,0,0,0],r=e.slice(0),t=0;128>t;t++){for((s=(n[Math.floor(t/32)]&1<<31-t%32)!==0)&&(i=a(i,r)),o=(r[3]&1)!==0,s=3;0<s;s--)r[s]=r[s]>>>1|(r[s-1]&1)<<31;r[0]>>>=1,o&&(r[0]^=-520093696)}return i},j:function(n,e,t){var s,i=t.length;for(e=e.slice(0),s=0;s<i;s+=4)e[0]^=4294967295&t[s],e[1]^=4294967295&t[s+1],e[2]^=4294967295&t[s+2],e[3]^=4294967295&t[s+3],e=p.mode.gcm.ka(e,n);return e},C:function(n,e,t,s,i,r){var o,a,l,f,h,c,u,d,g=p.bitArray;for(c=t.length,u=g.bitLength(t),d=g.bitLength(s),a=g.bitLength(i),o=e.encrypt([0,0,0,0]),a===96?(i=i.slice(0),i=g.concat(i,[1])):(i=p.mode.gcm.j(o,[0,0,0,0],i),i=p.mode.gcm.j(o,i,[0,0,Math.floor(a/4294967296),a&4294967295])),a=p.mode.gcm.j(o,[0,0,0,0],s),h=i.slice(0),s=a.slice(0),n||(s=p.mode.gcm.j(o,a,t)),f=0;f<c;f+=4)h[3]++,l=e.encrypt(h),t[f]^=l[0],t[f+1]^=l[1],t[f+2]^=l[2],t[f+3]^=l[3];return t=g.clamp(t,u),n&&(s=p.mode.gcm.j(o,a,t)),n=[Math.floor(d/4294967296),d&4294967295,Math.floor(u/4294967296),u&4294967295],s=p.mode.gcm.j(o,s,n),l=e.encrypt(i),s[0]^=l[0],s[1]^=l[1],s[2]^=l[2],s[3]^=l[3],{tag:g.bitSlice(s,0,r),data:t}}};p.misc.hmac=function(n,e){this.W=e=e||p.hash.sha256;var t=[[],[]],s,i=e.prototype.blockSize/32;for(this.w=[new e,new e],n.length>i&&(n=e.hash(n)),s=0;s<i;s++)t[0][s]=n[s]^909522486,t[1][s]=n[s]^1549556828;this.w[0].update(t[0]),this.w[1].update(t[1]),this.R=new e(this.w[0])};p.misc.hmac.prototype.encrypt=p.misc.hmac.prototype.mac=function(n){if(this.aa)throw new p.exception.invalid("encrypt on already updated hmac called!");return this.update(n),this.digest(n)};p.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]),this.aa=!1};p.misc.hmac.prototype.update=function(n){this.aa=!0,this.R.update(n)};p.misc.hmac.prototype.digest=function(){var n=this.R.finalize(),n=new this.W(this.w[1]).update(n).finalize();return this.reset(),n};p.misc.pbkdf2=function(n,e,t,s,i){if(t=t||1e4,0>s||0>t)throw new p.exception.invalid("invalid params to pbkdf2");typeof n=="string"&&(n=p.codec.utf8String.toBits(n)),typeof e=="string"&&(e=p.codec.utf8String.toBits(e)),i=i||p.misc.hmac,n=new i(n);var r,o,a,l,f=[],h=p.bitArray;for(l=1;32*f.length<(s||1);l++){for(i=r=n.encrypt(h.concat(e,[l])),o=1;o<t;o++)for(r=n.encrypt(r),a=0;a<r.length;a++)i[a]^=r[a];f=f.concat(i)}return s&&(f=h.clamp(f,s)),f};p.prng=function(n){this.c=[new p.hash.sha256],this.m=[0],this.P=0,this.H={},this.N=0,this.U={},this.Z=this.f=this.o=this.ha=0,this.b=[0,0,0,0,0,0,0,0],this.h=[0,0,0,0],this.L=void 0,this.M=n,this.D=!1,this.K={progress:{},seeded:{}},this.u=this.ga=0,this.I=1,this.J=2,this.ca=65536,this.T=[0,48,64,96,128,192,256,384,512,768,1024],this.da=3e4,this.ba=80};p.prng.prototype={randomWords:function(n,e){var t=[],s;s=this.isReady(e);var i;if(s===this.u)throw new p.exception.notReady("generator isn't seeded");if(s&this.J){s=!(s&this.I),i=[];var r=0,o;for(this.Z=i[0]=new Date().valueOf()+this.da,o=0;16>o;o++)i.push(4294967296*Math.random()|0);for(o=0;o<this.c.length&&(i=i.concat(this.c[o].finalize()),r+=this.m[o],this.m[o]=0,s||!(this.P&1<<o));o++);for(this.P>=1<<this.c.length&&(this.c.push(new p.hash.sha256),this.m.push(0)),this.f-=r,r>this.o&&(this.o=r),this.P++,this.b=p.hash.sha256.hash(this.b.concat(i)),this.L=new p.cipher.aes(this.b),s=0;4>s&&(this.h[s]=this.h[s]+1|0,!this.h[s]);s++);}for(s=0;s<n;s+=4)(s+1)%this.ca===0&&ii(this),i=zt(this),t.push(i[0],i[1],i[2],i[3]);return ii(this),t.slice(0,n)},setDefaultParanoia:function(n,e){if(n===0&&e!=="Setting paranoia=0 will ruin your security; use it only for testing")throw new p.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=n},addEntropy:function(n,e,t){t=t||"user";var s,i,r=new Date().valueOf(),o=this.H[t],a=this.isReady(),l=0;switch(s=this.U[t],s===void 0&&(s=this.U[t]=this.ha++),o===void 0&&(o=this.H[t]=0),this.H[t]=(this.H[t]+1)%this.c.length,typeof n){case"number":e===void 0&&(e=1),this.c[o].update([s,this.N++,1,e,r,1,n|0]);break;case"object":if(t=Object.prototype.toString.call(n),t==="[object Uint32Array]"){for(i=[],t=0;t<n.length;t++)i.push(n[t]);n=i}else for(t!=="[object Array]"&&(l=1),t=0;t<n.length&&!l;t++)typeof n[t]!="number"&&(l=1);if(!l){if(e===void 0)for(t=e=0;t<n.length;t++)for(i=n[t];0<i;)e++,i=i>>>1;this.c[o].update([s,this.N++,2,e,r,n.length].concat(n))}break;case"string":e===void 0&&(e=n.length),this.c[o].update([s,this.N++,3,e,r,n.length]),this.c[o].update(n);break;default:l=1}if(l)throw new p.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[o]+=e,this.f+=e,a===this.u&&(this.isReady()!==this.u&&si("seeded",Math.max(this.o,this.f)),si("progress",this.getProgress()))},isReady:function(n){return n=this.T[n!==void 0?n:this.M],this.o&&this.o>=n?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=n?this.J|this.u:this.u},getProgress:function(n){return n=this.T[n||this.M],this.o>=n||this.f>n?1:this.f/n},startCollectors:function(){if(!this.D){if(this.a={loadTimeCollector:Te(this,this.ma),mouseCollector:Te(this,this.oa),keyboardCollector:Te(this,this.la),accelerometerCollector:Te(this,this.ea),touchCollector:Te(this,this.qa)},window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,!1),window.addEventListener("mousemove",this.a.mouseCollector,!1),window.addEventListener("keypress",this.a.keyboardCollector,!1),window.addEventListener("devicemotion",this.a.accelerometerCollector,!1),window.addEventListener("touchmove",this.a.touchCollector,!1);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new p.exception.bug("can't attach event");this.D=!0}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,!1),window.removeEventListener("mousemove",this.a.mouseCollector,!1),window.removeEventListener("keypress",this.a.keyboardCollector,!1),window.removeEventListener("devicemotion",this.a.accelerometerCollector,!1),window.removeEventListener("touchmove",this.a.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=!1)},addEventListener:function(n,e){this.K[n][this.ga++]=e},removeEventListener:function(n,e){var t,s,i=this.K[n],r=[];for(s in i)i.hasOwnProperty(s)&&i[s]===e&&r.push(s);for(t=0;t<r.length;t++)s=r[t],delete i[s]},la:function(){Oe(this,1)},oa:function(n){var e,t;try{e=n.x||n.clientX||n.offsetX||0,t=n.y||n.clientY||n.offsetY||0}catch{t=e=0}e!=0&&t!=0&&this.addEntropy([e,t],2,"mouse"),Oe(this,0)},qa:function(n){n=n.touches[0]||n.changedTouches[0],this.addEntropy([n.pageX||n.clientX,n.pageY||n.clientY],1,"touch"),Oe(this,0)},ma:function(){Oe(this,2)},ea:function(n){if(n=n.accelerationIncludingGravity.x||n.accelerationIncludingGravity.y||n.accelerationIncludingGravity.z,window.orientation){var e=window.orientation;typeof e=="number"&&this.addEntropy(e,1,"accelerometer")}n&&this.addEntropy(n,2,"accelerometer"),Oe(this,0)}};function si(n,e){var t,s=p.random.K[n],i=[];for(t in s)s.hasOwnProperty(t)&&i.push(s[t]);for(t=0;t<i.length;t++)i[t](e)}function Oe(n,e){typeof window<"u"&&window.performance&&typeof window.performance.now=="function"?n.addEntropy(window.performance.now(),e,"loadtime"):n.addEntropy(new Date().valueOf(),e,"loadtime")}function ii(n){n.b=zt(n).concat(zt(n)),n.L=new p.cipher.aes(n.b)}function zt(n){for(var e=0;4>e&&(n.h[e]=n.h[e]+1|0,!n.h[e]);e++);return n.L.encrypt(n.h)}function Te(n,e){return function(){e.apply(n,arguments)}}p.random=new p.prng(6);e:try{if(it=typeof module<"u"&&module.exports){try{rt=require("crypto")}catch{rt=null}it=st=rt}if(it&&st.randomBytes)Pe=st.randomBytes(128),Pe=new Uint32Array(new Uint8Array(Pe).buffer),p.random.addEntropy(Pe,1024,"crypto['randomBytes']");else if(typeof window<"u"&&typeof Uint32Array<"u"){if(Ee=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(Ee);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(Ee);else break e;p.random.addEntropy(Ee,1024,"crypto['getRandomValues']")}}catch(n){typeof window<"u"&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(n))}var Pe,st,Ee,it,rt;p.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(n,e,t,s){t=t||{},s=s||{};var i=p.json,r=i.g({iv:p.random.randomWords(4,0)},i.defaults),o;if(i.g(r,t),t=r.adata,typeof r.salt=="string"&&(r.salt=p.codec.base64.toBits(r.salt)),typeof r.iv=="string"&&(r.iv=p.codec.base64.toBits(r.iv)),!p.mode[r.mode]||!p.cipher[r.cipher]||typeof n=="string"&&100>=r.iter||r.ts!==64&&r.ts!==96&&r.ts!==128||r.ks!==128&&r.ks!==192&&r.ks!==256||2>r.iv.length||4<r.iv.length)throw new p.exception.invalid("json encrypt: invalid parameters");return typeof n=="string"?(o=p.misc.cachedPbkdf2(n,r),n=o.key.slice(0,r.ks/32),r.salt=o.salt):p.ecc&&n instanceof p.ecc.elGamal.publicKey&&(o=n.kem(),r.kemtag=o.tag,n=o.key.slice(0,r.ks/32)),typeof e=="string"&&(e=p.codec.utf8String.toBits(e)),typeof t=="string"&&(r.adata=t=p.codec.utf8String.toBits(t)),o=new p.cipher[r.cipher](n),i.g(s,r),s.key=n,r.ct=r.mode==="ccm"&&p.arrayBuffer&&p.arrayBuffer.ccm&&e instanceof ArrayBuffer?p.arrayBuffer.ccm.encrypt(o,e,r.iv,t,r.ts):p.mode[r.mode].encrypt(o,e,r.iv,t,r.ts),r},encrypt:function(n,e,t,s){var i=p.json,r=i.ja.apply(i,arguments);return i.encode(r)},ia:function(n,e,t,s){t=t||{},s=s||{};var i=p.json;e=i.g(i.g(i.g({},i.defaults),e),t,!0);var r,o;if(r=e.adata,typeof e.salt=="string"&&(e.salt=p.codec.base64.toBits(e.salt)),typeof e.iv=="string"&&(e.iv=p.codec.base64.toBits(e.iv)),!p.mode[e.mode]||!p.cipher[e.cipher]||typeof n=="string"&&100>=e.iter||e.ts!==64&&e.ts!==96&&e.ts!==128||e.ks!==128&&e.ks!==192&&e.ks!==256||!e.iv||2>e.iv.length||4<e.iv.length)throw new p.exception.invalid("json decrypt: invalid parameters");return typeof n=="string"?(o=p.misc.cachedPbkdf2(n,e),n=o.key.slice(0,e.ks/32),e.salt=o.salt):p.ecc&&n instanceof p.ecc.elGamal.secretKey&&(n=n.unkem(p.codec.base64.toBits(e.kemtag)).slice(0,e.ks/32)),typeof r=="string"&&(r=p.codec.utf8String.toBits(r)),o=new p.cipher[e.cipher](n),r=e.mode==="ccm"&&p.arrayBuffer&&p.arrayBuffer.ccm&&e.ct instanceof ArrayBuffer?p.arrayBuffer.ccm.decrypt(o,e.ct,e.iv,e.tag,r,e.ts):p.mode[e.mode].decrypt(o,e.ct,e.iv,r,e.ts),i.g(s,e),s.key=n,t.raw===1?r:p.codec.utf8String.fromBits(r)},decrypt:function(n,e,t,s){var i=p.json;return i.ia(n,i.decode(e),t,s)},encode:function(n){var e,t="{",s="";for(e in n)if(n.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new p.exception.invalid("json encode: invalid property name");switch(t+=s+'"'+e+'":',s=",",typeof n[e]){case"number":case"boolean":t+=n[e];break;case"string":t+='"'+escape(n[e])+'"';break;case"object":t+='"'+p.codec.base64.fromBits(n[e],0)+'"';break;default:throw new p.exception.bug("json encode: unsupported type")}}return t+"}"},decode:function(n){if(n=n.replace(/\s/g,""),!n.match(/^\{.*\}$/))throw new p.exception.invalid("json decode: this isn't json!");n=n.replace(/^\{|\}$/g,"").split(/,/);var e={},t,s;for(t=0;t<n.length;t++){if(!(s=n[t].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new p.exception.invalid("json decode: this isn't json!");s[3]!=null?e[s[2]]=parseInt(s[3],10):s[4]!=null?e[s[2]]=s[2].match(/^(ct|adata|salt|iv)$/)?p.codec.base64.toBits(s[4]):unescape(s[4]):s[5]!=null&&(e[s[2]]=s[5]==="true")}return e},g:function(n,e,t){if(n===void 0&&(n={}),e===void 0)return n;for(var s in e)if(e.hasOwnProperty(s)){if(t&&n[s]!==void 0&&n[s]!==e[s])throw new p.exception.invalid("required parameter overridden");n[s]=e[s]}return n},sa:function(n,e){var t={},s;for(s in n)n.hasOwnProperty(s)&&n[s]!==e[s]&&(t[s]=n[s]);return t},ra:function(n,e){var t={},s;for(s=0;s<e.length;s++)n[e[s]]!==void 0&&(t[e[s]]=n[e[s]]);return t}};p.encrypt=p.json.encrypt;p.decrypt=p.json.decrypt;p.misc.pa={};p.misc.cachedPbkdf2=function(n,e){var t=p.misc.pa,s;return e=e||{},s=e.iter||1e3,t=t[n]=t[n]||{},s=t[s]=t[s]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):p.random.randomWords(2,0)},t=e.salt===void 0?s.firstSalt:e.salt,s[t]=s[t]||p.misc.pbkdf2(n,t,e.iter),{key:s[t].slice(0),salt:t.slice(0)}};var B=p;var Bt=class extends C{name="e2ee";keys;securedKeys=!1;encryptedkeys;secret;constructor(e,t,s,i){super(e),t&&(s&&i?(this.securedKeys=!0,this.encryptedkeys=B.encrypt(i,JSON.stringify(t)).cipher,this.secret=i):Object.assign(this.keys,t)),this.load(this)}addKey=(e,t)=>{if(t||(t=`key${Math.floor(Math.random()*1e15)}`),this.securedKeys&&this.secret&&this.encryptedkeys){let s=JSON.parse(B.decrypt(this.secret,this.encryptedkeys));return s[t]={key:e,_id:t},this.encryptedkeys=B.encrypt(this.secret,s).cipher,this.encryptedkeys}else this.keys[t]={key:e,_id:t};return this.keys[t]};static generateSecret(){return B.codec.base64.fromBits(B.random.randomWords(8,10))}encrypt(e,t){return e=B.encrypt(t,e).cipher,e}decrypt(e,t){return e=B.decrypt(t,e),e}encryptRoute=(e,t)=>{typeof e=="object"&&(e=JSON.stringify(e));let s;if(this.securedKeys&&this.secret&&this.encryptedkeys){let i=JSON.parse(B.decrypt(this.secret,this.encryptedkeys));i[t]?.key&&(e=B.encrypt(this.secret,i[t].key).cipher)}else this.keys[t]&&(s||(s=t),e=this.encrypt(e,s));return e={route:"decryptRoute",args:[e,t]},e};decryptRoute=(e,t)=>{let s=e;if(typeof e=="object"){if(t||typeof e.keyId=="string"&&(t=e.keyId),t){let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(B.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=B.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e.args,i))}}else{let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(B.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=B.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e,i))}return s};transmit=(e,t)=>(t||(t=Object.keys(this.keys)[0]),e=this.encryptRoute(e,t),this.handleServiceMessage(e));receive=(e,t)=>{if(t||(t=Object.keys(this.keys)[0]),e=this.decryptRoute(e,t),typeof e=="string"){let s=e.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(e=e.replace(/\\/g,"")),e[0]==='"'&&(e=e.substring(1,e.length-1)),e=JSON.parse(e))}if(typeof e=="object"){if(typeof e.method=="string")return this.handleMethod(e.route,e.method,e.args);if(typeof e.route=="string")return this.handleServiceMessage(e);if(typeof e.node=="string"||e.node instanceof P)return this.handleGraphNodeCall(e.node,e.args);this.__node.keepState&&(e.route&&this.setState({[e.route]:e.args}),e.node&&this.setState({[e.node]:e.args}))}else return e}};var ot=J(require("http")),at=J(require("https")),R=J(require("fs")),V=J(require("path"));function Cr(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=t}):e+=n,e+="</body></html>",e}function Nr(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=`<script src="${t}"></script>`}):e+=`<script src="${n}"></script>`,e+="</body></html>",e}var Ft=function(n=4/24){return`//https://github.com/ibrahima92/pwa-with-vanilla-js

//https://github.com/ibrahima92/pwa-with-vanilla-js
let cacheName = 'pwa-assets';
const assets = [
  "/",
  "/index.html",
  "/dist/index.css", //alt default paths
  "/dist/index.js",
  '/favicon.ico'
];

let cacheExpiration = 1000 * 60 * //seconds 
  60 * //minutes
  24 * //hours
  ${n};    //days

let isValid = function (response) {
	if (!response) return false;
	var fetched = response.headers.get('sw-fetched-on');
	if (fetched && (!navigator.onLine || (parseFloat(fetched) + (cacheExpiration)) > new Date().getTime())) 
      return true;
	return false;
};

self.addEventListener("install", installEvent => {
  installEvent.waitUntil(
    caches.open(cacheName).then(cache => {
      cache.addAll(assets);
    })
  );
});

self.addEventListener("fetch", fetchEvent => { //https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/
  fetchEvent.respondWith(
    caches.match(fetchEvent.request).then(function (response) {

        // If there's a cached API and it's still valid, use it
        if (isValid(response)) {
            return response;
        }

        // Otherwise, make a fresh API call
        if(response && !assets.includes(fetchEvent.request.url)) return response;
        // Otherwise, make a fresh API call
        else return fetch(fetchEvent.request).then(function (response) {

            // Cache for offline access
            if(assets.includes(fetchEvent.request.url)){
              var copy = response.clone();
              fetchEvent.waitUntil(caches.open(cacheName).then(function (cache) {
                var headers = new Headers(copy.headers);
                headers.append('sw-fetched-on', new Date().getTime());
                return copy.blob().then(function (body) {
                  return cache.put(fetchEvent.request, new Response(body, {
                    status: copy.status ? copy.status : 200,
                    statusText: copy.statusText,
                    headers: headers
                  }));
                });
              }));
            }
            
            // Return the requested file
            return response;

        })
        // .catch(function (error) {
        // 	return caches.match(request).then(function (response) { //fallback to offline cache
        // 		return response || caches.match('/offline.json'); //todo: figure out what is supposed to go in offline.json (https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/)
        // 	});
        // });  
  }));
});

`},Gt=(n="PWA")=>`{
    "short_name": "${n}",
    "name": "${n}",
    "start_url": "/",
    "display": "standalone",
    "theme_color": "#000000",
    "background_color": "#ffffff",
    "description": "${n} Test",
    "lang": "en-US",
    "permissions": [
        "storage"
    ],
    "icons":[{
        "src": "./assets/logo196.png",
        "sizes": "196x196"
    },
    {
        "src": "./assets/logo512.png",
        "sizes": "512x512"
    }]
}`;var qt=class extends C{name="http";server;debug=!1;servers={};mimeTypes={".html":"text/html",".htm":"text/html",".js":"text/javascript",".css":"text/css",".json":"application/json",".txt":"text/plain",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpg",".gif":"image/gif",".svg":"image/svg+xml",".xhtml":"application/xhtml+xml",".bmp":"image/bmp",".wav":"audio/wav",".mp3":"audio/mpeg",".mp4":"video/mp4",".xml":"application/xml",".webm":"video/webm",".webp":"image/webp",".weba":"audio/webm",".woff":"font/woff",woff2:"font/woff2",".ttf":"application/font-ttf",".eot":"application/vnd.ms-fontobject",".otf":"application/font-otf",".wasm":"application/wasm",".zip":"application/zip",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".tif":"image/tiff",".sh":"application/x-sh",".csh":"application/x-csh",".rar":"application/vnd.rar",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".odt":"application/vnd.oasis.opendocument.text",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odp":"application/vnd.oasis.opendocument.presentation",".mpeg":"video/mpeg",".mjs":"text/javascript",".cjs":"text/javascript",".jsonld":"application/ld+json",".jar":"application/java-archive",".ico":"image/vnd.microsoft.icon",".gz":"application/gzip",epub:"application/epub+zip",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".csv":"text/csv",".avi":"video/x-msvideo",".aac":"audio/aac",".mpkg":"application/vnd.apple.installer+xml",".oga":"audio/ogg",".ogv":"video/ogg",ogx:"application/ogg",".php":"application/x-httpd-php",".rtf":"application/rtf",".swf":"application/x-shockwave-flash",".7z":"application/x-7z-compressed",".3gp":"video/3gpp"};constructor(e,t){super(e),this.load(this),t&&this.setupServer(t)}onStarted=(e,t,s)=>{console.log(`\u{1F431} Node server running at 
            ${e}://${t}:${s}/`)};setupServer=(e={protocol:"http",host:"localhost",port:8080,startpage:"index.html"},t,s)=>{if(e.pages){for(let i in e.pages)if(typeof e.pages[i]=="string")this.addPage(`${e.port}/${i}`,e.pages[i]);else if(typeof e.pages[i]=="object"||typeof e.pages[i]=="function"){e.pages[i].template&&(e.pages[i].get=e.pages[i].template);let r=`${e.port}/${i}`;i!=="_all"&&this.load({[r]:e.pages[i]})}}this.setupHTTPserver(e,t,s)};open=this.setupServer;setupHTTPserver=(e={host:"localhost",port:8080,startpage:"index.html",errpage:void 0},t,s=()=>{this.onStarted("http",e.host,e.port)})=>{let i=e.host?e.host:"localhost",r=e.port?e.port:8e3;if(!i||!r)return;let o=`${i}:${r}`;this.servers[o]&&this.terminate(this.servers[o]),"keepState"in e||(e.keepState=!0);let a={server:void 0,type:"httpserver",address:o,...e};t||(t=(f,h)=>{let c={args:{request:f,response:h},method:f.method,served:a},u=f.url.slice(1);if(u||(u="/"),e.debug){let d=nt(new Date);console.log(d," | ","From: ",f.socket?.remoteAddress,"For: ",f.url," | ",f.method)}e.pages?Ir.call(this,u,c,e.pages,f,h,e.port):c.route=u,this.receive(c)});let l;if(e.protocol==="http")l=ot.createServer(t);else{let f;e.keypath&&e.certpath?(f={key:R.readFileSync(e.keypath),cert:R.readFileSync(e.certpath),passphrase:e.passphrase},l=at.createServer(f,t)):console.error("Error, key and/or cert .pem SSL files not provided. See OpenSSL certbot for more info on how to create free SSL certifications, or create your own self-signed one for local development.")}if(!l){console.error("Server not successfully created.");return}return a.server=l,a.terminate=()=>{this.terminate(a)},a.service=this,this.servers[o]=a,a._id=e._id?e._id:o,new Promise((f,h)=>{let c;l.on("error",u=>{a.onerror?a.onerror(u,a):console.error("Server error:",u.toString()),c||h(u)}),l.on("clientError",(u,d)=>{a.onerror?a.onerror(u,a):console.error(nt(new Date)," | Server clientError:",u.toString()," | From: ",d.remoteAddress),d&&d.destroy()}),l.on("tlsClientError",(u,d)=>{a.onerror?a.onerror(u,a):console.error(nt(new Date)," | Server tlsClientError: ",u.toString()," | From: ",d.remoteAddress),d&&d.destroy()}),l.on("upgrade",(u,d,g)=>{a.onupgrade&&a.onupgrade(u,d,g,a)}),l.listen(r,i,()=>{s(),a.onopen&&a.onopen(a),c=!0,f(a)})})};transmit=(e,t,s,i)=>{let r=e;if(typeof r=="object"&&!r.byteLength&&(r=JSON.stringify(r)),typeof t=="string"&&e)return this.POST(t,e);if(typeof t=="string")return this.GET(t);if(t)t.headers||(t.headers={"Content-Type":"application/json","Content-Length":r.length});else{let o=this.servers[Object.keys(this.servers)[0]];t={protocol:o.protocol,host:o.host,port:o.port,method:"POST",path:e.route,headers:{"Content-Type":"application/json","Content-Length":r.length}}}return this.request(t,r,s,i)};withResult=(e,t,s)=>{if(t&&!e.writableEnded&&!e.destroyed){let i="text/plain",r={};if(typeof t=="string"){let o=V.extname(t);if(o&&R.existsSync(V.join(process.cwd(),t))){if(i=this.mimeTypes[o]||"application/octet-stream",t=R.readFileSync(V.join(process.cwd(),t)),i==="text/html"&&(s.served?.pages?._all||s.served?.pages?.[s.route])){let{templateString:a,headers:l}=this.injectPageCode(t.toString(),s.route,s.served);t=a,Object.assign(r,l)}}else if(typeof t=="string"&&t.includes("<")&&t.includes(">")&&t.indexOf("<")<t.indexOf(">")){if(r["Content-Type"]="text/html",s?.served?.pages?._all||s?.served?.pages?.[s.route]){let{templateString:a,headers:l}=this.injectPageCode(t,s.route,s.served);t=a,Object.assign(r,l)}e.writeHead(200,r),e.end(t,"utf-8");return}}else typeof t=="object"&&(t=JSON.stringify(t),i="application/json");r["Content-Type"]=i,e.writeHead(200,r),e.end(t,"utf-8")}else try{e.destroy()}catch{}};injectPageCode=(e,t,s)=>{s?.pages?.[t]?.inject&&(typeof s.pages[t].inject=="object"?e=this.buildPage(s.pages[t].inject,e):typeof s.pages[t].inject=="function"?e+=s.pages[t].inject():(typeof s.pages[t].inject=="string"||typeof s.pages[t].inject=="number")&&(e+=s.pages[t].inject)),s?.pages?._all?.inject&&(typeof s.pages._all.inject=="object"?e=this.buildPage(s.pages._all.inject,e):typeof s.pages._all.inject=="function"?e+=s.pages._all.inject():(typeof s.pages._all.inject=="string"||typeof s.pages._all.inject=="number")&&(e+=s.pages._all.inject));let i={};return s.pages._all?.headers&&Object.assign(i,s.pages._all.headers),s.pages[t]?.headers&&Object.assign(i,s.pages[t].headers),{templateString:e,headers:i}};receive=e=>(this.debug&&console.log(e.args.request.method,e.args.request.url),new Promise((s,i)=>{this.responsePromiseHandler(s,i,e,e.args.request,e.args.response,e.method,e.served)}).catch(s=>{console.error("Request Error:",s)}));responseOnErrorPromiseHandler=(e,t,s)=>{if(!e.writableEnded||!e.destroyed)e.statusCode=400,e.end(void 0,void 0),t(s);else{try{e.destroy()}catch{}t(s)}};getFailedPromiseHandler=(e,t,s,i,r,o)=>{if((r.writableEnded||r.destroyed)&&t(s),s=="./"||s==o?.startpage){let a="<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Brains@Play Server</h1></body></html>";if(o?.pages?._all||o?.pages?.error){let{templateString:l,headers:f}=this.injectPageCode(a,i.route,o);a=l}r.writeHead(200,{"Content-Type":"text/html"}),r.end(a,"utf-8"),e(a),o?.keepState&&this.setState({[o.address]:a});return}else this.debug&&console.log(`File ${s} does not exist on path!`);r.writeHead(500),r.end(void 0,void 0),t(s)};handleBufferedPostBodyPromiseHandler=(e,t,s,i,r)=>{if(t=Buffer.concat(t).toString(),typeof t=="string"){let h=t.substring(0,8);(h.includes("{")||h.includes("["))&&(h.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}let o,a,l;if(t?.route&&(o=t.route,a=t.method,l=t.args,o||(typeof t.route=="string"&&t.route.includes("/")&&t.route.length>1&&(t.route=t.route.split("/").pop()),o=t.route)),!o&&s?.route){let h=s.route;a=s.method,l=s.args,h||(typeof s.route=="string"&&s.route.includes("/")&&s.route.length>1&&(s.route=s.route.split("/").pop()),h=s.route)}let f=t;if(o)if(this.restrict?.[o]){try{i.destroy()}catch{}e(f)}else t.method?f=this.handleMethod(o,a,l):t.node?f=this.handleGraphNodeCall(t.node,t.args):f=this.handleServiceMessage({route:o,args:l,method:a}),f instanceof Promise?f.then(h=>{this.withResult(i,h,s),r?.keepState&&this.setState({[r.address]:f}),e(f)}):(this.withResult(i,f,s),r?.keepState&&this.setState({[r.address]:f}),e(f));else if(!i.writableEnded||!i.destroyed)i.statusCode=200,i.end(void 0,void 0),e(f);else{try{i.destroy()}catch{}e(f)}};onRequestFileReadPromiseHandler=(e,t,s,i,r,o,a,l)=>{if(e)if(e.code=="ENOENT")if(l?.errpage)R.readFile(l.errpage,(c,u)=>{if(o.writeHead(404,{"Content-Type":"text/html"}),l.pages?._all||l.pages?.error){let{templateString:d,headers:g}=this.injectPageCode(u.toString(),a.route,l);u=d}o.end(u,"utf-8"),i(u)});else{o.writeHead(404,{"Content-Type":"text/html"});let c=`<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Error: ${e.code}</h1></body></html>`;if(l?.pages?._all||l?.pages?.[a.route]){let{templateString:u,headers:d}=this.injectPageCode(c.toString(),a.route,l);c=u}o.end(c,"utf-8"),i(e.code)}else o.writeHead(500),o.end("Something went wrong: "+e.code+` ..
`,"utf-8"),i(e.code);else{var f=String(V.extname(r)).toLowerCase(),h=this.mimeTypes[f]||"application/octet-stream";let c={"Content-Type":h};if(h==="text/html"&&(l?.pages?._all||l?.pages?.[a.route])){let{templateString:u,headers:d}=this.injectPageCode(t.toString(),a.route,l);Object.assign(c,d),t=u}o.writeHead(200,c),o.end(t,"utf-8"),s(t)}};responsePromiseHandler=(e,t,s,i,r,o,a)=>{if(r.on("error",f=>{if(a.debug){let h=nt(new Date);console.error(h,"| Response Error: ",f," From: ",i.socket?.remoteAddress," For: ",i.url," | ",i.method)}this.responseOnErrorPromiseHandler(r,t,f),i.destroy(),i.socket?.destroy()}),o==="GET"||o==="get"){var l="."+i.url;if(i.url&&this.restrict?.[i.url]&&t(i.url),l=="./"&&a?.startpage&&(l=a.startpage),l.includes("?")&&(l=l.substring(0,l.indexOf("?"))),(i.url!=="/"||a?.startpage)&&R.existsSync(V.join(process.cwd(),l)))r.writableEnded||r.destroyed?t(l):R.readFile(V.join(process.cwd(),l),(f,h)=>{this.onRequestFileReadPromiseHandler(f,h,e,t,l,r,s,a)});else if(s.route){let f;if(a){let h=`${a.port}/${s.route}`;this.__node.nodes.get(h)&&(f=h)}if(!f&&this.__node.nodes.get(s.route)&&(f=s.route),f){let h;s.method?h=this.handleMethod(f,s.method,void 0):s.node?h=this.handleGraphNodeCall(s.node,void 0):h=this.handleServiceMessage({route:f,args:void 0,method:s.method}),h instanceof Promise?h.then(c=>{a?.keepState&&this.setState({[a.address]:h}),this.withResult(r,c,s),e(h)}):h&&(a?.keepState&&this.setState({[a.address]:h}),this.withResult(r,h,s),e(h))}else s.redirect?(r.writeHead(301,{Location:s.redirect}),r.end(),e(!0)):this.getFailedPromiseHandler(e,t,l,s,r,a)}else this.getFailedPromiseHandler(e,t,l,s,r,a)}else{let f,h=!0,c;i.on("data",u=>{f||(f=[]),f.push(u),h&&(h=!1,c&&clearTimeout(c))}).on("end",()=>{this.handleBufferedPostBodyPromiseHandler(e,f,s,r,a)}),c=setTimeout(()=>{if(h){let u=new Error(`Request timed out from | ${i.socket?.remoteAddress} | For: ${i.url} | ${i.method}`);i.destroy(u),a.server.emit("clientError",u,i.socket),a.debug&&console.error(u),t(u)}},a.timeout?a.timeout:1e3)}};request=(e,t,s,i)=>{let r=ot;e.protocol?.includes("https")&&(r=at),delete e.protocol;let o=r.request(e,a=>{s&&a.on("data",s),i&&a.on("end",i)});if(e.headers)for(let a in e.headers)o.setHeader(a,e.headers[a]);return t&&o.write(t),o.end(),o};POST=(e,t,s)=>{let i=e;i instanceof URL&&(i=e.toString());let r=i.startsWith("https")?"https":"http",o,a,l,f=i.split("/");return f.forEach(c=>{if(c.includes(":")){let u=c.split(":");o=u[0],a=u[1]}}),f.length>3&&(l=f.slice(3).join("/")),this.request({protocol:r,host:o,port:a,path:l,method:"POST",headers:s},t)};GET=e=>new Promise((t,s)=>{let i=ot,r=e;e instanceof URL&&(r=e.toString()),r.includes("https")&&(i=at),i.get(e,o=>{let a=[];o.on("data",l=>{a.push(l)}),o.on("end",()=>{t(Buffer.concat(a))})}).on("error",o=>{s(o)})});terminate=e=>{typeof e=="string"&&(e=this.servers[e]),typeof e=="object"&&(e.server.close(),e.onclose&&e.onclose(e))};getRequestBody(e){let t=[];return new Promise((s,i)=>{e.on("data",r=>{t.push(r)}).on("end",()=>{s(Buffer.concat(t))}).on("error",r=>{let o=new Error(`Request timed out from | ${e.socket?.remoteAddress} | For: ${e.url} | ${e.method}`);e.destroy(o),i(o)})})}addPage=(e,t)=>{typeof t=="string"&&(t.includes("<html")||(t="<!DOCTYPE html><html>"+t+"</html>")),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};addHTML=(e,t)=>{typeof t=="string"&&(!t.includes("<")||!t.includes(">"))&&(t="<div>"+t+"</div>"),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};buildPage=(e,t)=>{let s="";t&&(s+=t);let i=(r,o,a)=>{if(!Array.isArray(r[o])&&typeof r[o]=="object")for(let l in r)i(r,l,a);else if(this.__node.nodes.get(o)?.get){let l=this.__node.nodes.get(o)?.get;if(typeof l=="function"&&(Array.isArray(r[o])?l=l(...r[o]):l=l(r[o])),typeof l=="string"){let f=a.lastIndexOf("<");if(f>0){let h=a.substring(f);a=a.substring(0,f)+l+h}else a+=l}}else if(this.__node.nodes.get(o)?.__operator){let l;if(this.__node.nodes.get(o)?.__operator&&(l=this.__node.nodes.get(o).__operator(r[o])),typeof l=="string"){let f=a.lastIndexOf("<");if(f>0){let h=a.substring(f);a=a.substring(0,f)+l+h}else a+=l}}else typeof this.__node.nodes.get(o)=="string"&&(a+=this.__node.nodes.get(o));return a};if(Array.isArray(e))e.forEach(r=>{s=i(e,r,s)});else if(typeof e=="object")for(let r in e)s=i(e,r,s);else typeof e=="string"?s+=e:typeof e=="function"&&(s+=e());return s};hotreload=(e="http://localhost:8080/wss",t)=>{e instanceof URL&&(e=e.toString());let s=(i,r)=>{let o=new WebSocket(i);function a(f){let h=f.includes("/")?f.split("/"):f.split("\\"),c=h[h.length-1];var u=document.getElementsByTagName("link");for(var d in u){var g=u[d];if(!f||g.href?.includes(c)){let y=g.getAttribute("href").split("?")[0],x=y+="";g.setAttribute("href",x)}}}function l(f,h,c){let u=f.includes("/")?f.split("/"):f.split("\\"),d=u[u.length-1],g=document.querySelectorAll("[src]"),y=!1;for(let x of g)if(x.src.includes(d))if(x.tagName==="SCRIPT"&&!h){window.location.reload();return}else{let v=document.createElement("object");x.insertAdjacentElement("afterend",v),x.remove();let A=x.cloneNode(!0);v.insertAdjacentElement("beforebegin",A),v.remove(),y=!0}y||window.location.reload()}o.addEventListener("message",f=>{let h=f.data;if(typeof h=="string"&&h.startsWith("{")&&(h=JSON.parse(h)),h.file){let c=h.file,u=h.reloadscripts;c.endsWith("html")||c.endsWith("xml")||c.endsWith("wasm")?window.location.reload():c.endsWith("css")?(r.endsWith("css")||(r+=".css"),a(r)):c.endsWith("js")||c.endsWith("ts")||c.endsWith("jsx")||c.endsWith("tsx")||c.endsWith("vue")?l(c,u):(a(c),l(c))}}),o.addEventListener("close",()=>{let c=Math.round(30),u=0,d=()=>{if(u++,u>c){console.error("Could not reconnect to dev server.");return}o=new WebSocket(i),o.onerror=g=>{console.error(`Hot reload port disconnected, will reload on reconnected. Attempt ${u} of ${c}`)},o.addEventListener("error",()=>{setTimeout(d,100)}),o.addEventListener("open",()=>{location.reload()})};d()})};return`
            <script>
                console.log('Hot Reload port available at ${e}');  
                (`+s.toString()+`)('${e}',${t?`'${t}'`:void 0}); 
            </script>
        `};pwa=(e="PWA",t=4/24,s="service-worker.js")=>{R.existsSync(s)||R.writeFileSync(V.join(process.cwd(),s),Ft(t)),R.existsSync("manifest.webmanifest")||R.writeFileSync(V.join(process.cwd(),"/manifest.webmanifest"),Gt(e));function i(r){Array.from(document.head.querySelectorAll("link")).find(l=>{if(l.href.includes("manifest"))return!0})||document.head.insertAdjacentHTML("beforeend",'<link rel="manifest" href="./manifest.webmanifest">');let o=!!(window.location.hostname==="localhost"||window.location.hostname==="[::1]"||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function a(){navigator.serviceWorker.register(r).then(l=>{l.onupdatefound=()=>{let f=l.installing;f!=null&&(f.onstatechange=()=>{f.state==="installed"&&(navigator.serviceWorker.controller?console.log("New content is available and will be used when all tabs for this page are closed."):console.log("Content is cached for offline use."))})}}).catch(l=>{console.error("Error during service worker registration:",l)})}"serviceWorker"in navigator&&addEventListener("load",()=>{o?(fetch(r).then(l=>{let f=l.headers.get("content-type");l.status===404||f!=null&&f.indexOf("javascript")===-1?navigator.serviceWorker.ready.then(h=>{h.unregister().then(()=>{window.location.reload()})}):a()}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")}),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker.")})):a()})}return`
            <script>
                (`+i.toString()+`)('${s}'); 
            </script>
        `}};function Ir(n,e,t,s,i,r){let o=t[n],a=n;if(o)e.route=n,s.url=n;else{let l="/"+n;if(o=t[l],a=l,!o&&!V.extname(n))if(a=n.split("/")[0]+"/*",t[a])o=t[a],e.route=a,s.url=a;else{let h=l.split("/");h[h.length-1]="",a=h.join("/")+"*",t[a]&&(o=t[a],e.route=a,s.url=a)}else e.route=l,s.url=l}return typeof o=="object"&&(o.redirect&&(n=o.redirect,e.redirect=n,e.route=n),o.onrequest&&(typeof o.onrequest=="string"&&(o.onrequest=this.__node.nodes.get(o.onrequest)),typeof o.onrequest=="object"?o.onrequest.__operator&&o.onrequest.__operator(o,s,i):typeof o.onrequest=="function"&&o.onrequest(this,this.__node.nodes.get(`${r}/${a}`),s,i))),o}function nt(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var ft=J(ri()),Wt=class extends C{name="sse";debug=!1;servers={};eventsources={};connections={servers:this.servers,eventsources:this.eventsources};constructor(e){super(e),this.load(this)}openSSE=e=>{let t=e.server,s=e.path;if(this.servers[s])return!1;let i=(0,ft.createChannel)(),r={type:"sse",channel:i,sessions:{},requests:{},...e};this.servers[s]=r,r._id=e._id?e._id:s;let o=(v,A,b)=>this.transmit(v,s,A,b),a=()=>this.terminate(s),l=(v,A,b,w)=>{if(!b){let m=[];for(let _ in r.sessions)m.push(this.request(v,s,_,w));return m}return this.request(v,s,A,b,w)},f=(v,A,b,w,m)=>{let _={route:v,args:A};return b&&(_.method=b),this.transmit(_,s,m,w)},h=(v,A,b,w,m)=>{let _={route:v,args:A};if(!w){let k=[];for(let O in r.sessions)k.push(this.request(_,s,O,m));return k}return this.request(_,s,b,w,m)},c=(v,A,b,w,m,_,k)=>this.subscribeToSSE(v,e.url,A,b,w,m,_,k),u=(v,A,b,w)=>h("unsubscribe",[v,A],void 0,b,w);r.send=o,r.request=l,r.post=f,r.run=h,r.subscribe=c,r.unsubscribe=u,r.terminate=a,r.graph=this;let d=(v,A)=>{if(v.url?.includes(s))if(v.method==="GET")this.debug&&console.log("SSE Request",s),(0,ft.createSession)(v,A).then(b=>{i.register(b);let w=`sse${Math.floor(Math.random()*1e15)}`;r.sessions[w]=b,this.eventsources[w]={_id:w,session:b,served:r,send:(m,_)=>o(m,_,w),request:(m,_,k)=>l(m,_,w,k),post:(m,_,k,O)=>f(m,_,k,w,O),run:(m,_,k,O)=>h(m,_,k,w,O),subscribe:(m,_)=>c(m,_,void 0,w),unsubscribe:(m,_,k)=>u(m,_,w,k),terminate:()=>(delete this.eventsources[w],delete r.sessions[w],!0),onclose:(m,_,k,O,T)=>{_.onconnectionclose&&_.onconnectionclose(m,_,k,O,T)},graph:this},b.push(JSON.stringify({route:"setId",args:w})),b.on("close",()=>{let m=this.eventsources[w],_=m.onclose;delete this.eventsources[w],_&&m.onclose(b,r,w,v,A)}),r.onconnection&&r.onconnection(b,r,w,v,A)});else{let b=[];v.on("data",w=>{b.push(w)}).on("end",()=>{if(b=Buffer.concat(b).toString(),typeof b=="string"){let O=b.substring(0,8);(O.includes("{")||O.includes("["))&&(O.includes("\\")&&(b=b.replace(/\\/g,"")),b[0]==='"'&&(b=b.substring(1,b.length-1)),b=JSON.parse(b))}let w,m,_,k;if((b?.route||b?.callbackId)&&(m=b.method,_=b.args,k=b.callbackId,typeof b.route=="string"&&(b.route.includes("/")&&b.route.length>1&&(b.route=b.route.split("/").pop()),w=this.__node.roots?.[b.route])),w){let O=this.receive({route:w,args:_,method:m})}else k&&r.requests[k]&&r.requests[k](_);this.__node.keepState&&this.setState({[s]:b})})}},g=t.listeners("request");t.removeAllListeners("request");let y=(v,A)=>{g.forEach(b=>{b(v,A)})},x=(v,A)=>{v.url&&(v.url.indexOf(s)>-1?(this.servers[s]||(t.removeListener("request",x),t.addListener("request",y)),d(v,A)):y(v,A))};return t.addListener("request",x),t.addListener("close",()=>{r.onclose&&r.onclose(r)}),r};open=this.openSSE;streamIterable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].iterate(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].iterate(t));return o}};streamReadable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].stream(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].stream(t));return o}};transmit=(e,t,s,i)=>{if(!t&&(typeof e=="object"&&!e.byteLength||typeof e=="number")){if(e?.route){let r=Object.keys(this.servers);if(r.length>0){let o=this.servers[r[0]];o.channels?.includes(e.route)&&(t=o.path,s=e.route)}!t&&e.route&&this.servers[e.route]&&(t=e.route)}e=JSON.stringify(e)}if(t||(t=Object.keys(this.servers)[0]),t&&this.servers[t]){if(i){if(this.servers[t].sessions[i]?.isConnected)this.servers[t].sessions[i].push(e,s);else if(this.servers[t].sessions[i])return delete this.servers[t].sessions[i],!1}else this.servers[t].channel.broadcast(e,s);return!0}return!1};request=(e,t,s,i,r)=>new Promise((o,a)=>{let l=`${Math.random()}`,f={route:"runRequest",args:[e,t,l,i]};s&&(f.method=s);let h=this.servers[t],c=u=>{o(u)};h.requests[l]=c,h&&(i?h.sessions[i]&&h.sessions[i].push(JSON.stringify(f),r):h.channel.broadcast(JSON.stringify(f),r))});runRequest=(e,t,s,i)=>{let r=this.receive(e);if(t){let o=this.servers[t];o&&(r instanceof Promise?r.then(a=>{i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:a,callbackId:s})):o.channel.broadcast(JSON.stringify({args:a,callbackId:s}))}):i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:r,callbackId:s})):o.channel.broadcast(JSON.stringify({args:r,callbackId:s})))}return r};subscribeSSE=(e,t,s,i,r,o,a)=>{if(!this.restrict?.[e]&&this.servers[t])return this.subscribe(e,l=>{this.servers[t].send({args:l,callbackId:e},a,o)},s,i,r)};subscribeToSSE=(e,t,s,i,r,o,a,l)=>{if(this.servers[t])if(this.__node.state.subscribeEvent(t,f=>{f?.callbackId===e&&(s?typeof s=="string"?this.run(s,f.args):s(f.args):this.setState({[t]:f.args}))}),a){if(this.servers[t].sessions[a])return this.eventsources[a].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l)}else{let f=[];for(let h in this.servers[t].sessions)f.push(this.eventsources[h].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l));return f}};terminate=e=>(typeof e=="object"?delete this.servers[e.path]:typeof e=="string"&&(delete this.servers[e],delete this.eventsources[e]),!0)};var qn=J(li(),1),$n=J(ss(),1),Wn=J(rs(),1),or=J(hs(),1),Be=J(nr(),1);var ae=or.default;var ds=class extends C{name="wss";debug=!1;servers={};sockets={};connections={servers:this.servers,sockets:this.sockets};constructor(e){super(e),this.load(this)}open=e=>e?.server?this.setupWSS(e):this.openWS(e);setupWSS=e=>{let t=e.port,s=e.path,i=typeof e.server=="object"?e.server:void 0,r=e.host;delete e.server,"keepState"in e||(e.keepState=!0);let o={};e.noServer?o.noServer=!0:t?t&&(o.port=t):i&&(o.server=i),e.perMessageDeflate&&(o.perMessageDeflate=e.perMessageDeflate),e.serverOptions,Object.assign(o,e.serverOptions);let a=new Be.default(o),l="";if(!r&&i){let v=i.address();t||(t=v.port),l=v.address}else r&&(l=r);t&&(l+=":"+t),s&&(s.startsWith("/")||(s="/"+s),l+=s),this.servers[l]={type:"wss",wss:a,clients:{},address:l,...e},a.addListener("connection",(v,A)=>{this.debug&&console.log(`New socket connection on ${l}`);let b=`socket${Math.floor(Math.random()*1e12)}`;if(this.servers[l].clients[b]=v,v.send(JSON.stringify({route:"setId",args:b})),this.openWS({socket:v,address:b,_id:b,debug:e.debug,onclose:(w,m)=>{this.servers[l].onconnectionclosed&&this.servers[l].onconnectionclosed(w,m,v,this.servers[l],b),delete this.servers[l].clients[b]},onmessage:e.onmessage}),e.debug){let w=Hn(new Date);console.log(w," | ",b," | Number of live sockets: ",Object.keys(this.servers[l].clients).length)}this.servers[l].onconnection&&this.servers[l].onconnection(v,A,this.servers[l],b)}),a.on("error",v=>{this.debug&&console.log("Socket Error:",v),this.servers[l]?.onerror?this.servers[l].onerror(v,a,this.servers[l]):console.error(v)});let f=(v,A,b)=>{if(v.headers&&v.url){this.debug&&console.log("Upgrade request at: ",v.url);let w=!1;if(s&&v.url===s)w=!0;else{let m=v.headers.host.split(":")[0];t&&(m+=":"+t),m===l?w=!0:(m+=v.url.split("?")[0],m===l&&(w=!0))}w&&this.servers[l]&&this.servers[l].wss.handleUpgrade(v,A,b,m=>{this.servers[l].onupgrade&&this.servers[l].onupgrade(m,this.servers[l],v,A,b),this.servers[l].wss.emit("connection",m,v)})}};i&&i.addListener("upgrade",f),a.addListener("close",()=>{i&&i.removeListener("upgrade",f),this.servers[l]?.onclose?this.servers[l].onclose(a,this.servers[l]):console.log(`wss closed: ${l}`),delete this.servers[l]});let h=(v,A)=>{if(typeof v=="object"&&(v=JSON.stringify(v)),A)return this.sockets[A].send(v);for(let b in this.servers[l].clients)this.sockets[b].send(v)},c=(v,A,b)=>{if(b)return this.sockets[b].request(v,A);{let w=[];for(let m in this.servers[l].clients)w.push(this.sockets[m].request(v,A));return w}},u=(v,A,b,w)=>{if(w)return this.sockets[w].post(v,A,b);for(let m in this.servers[l].clients)this.sockets[m].post(v,A,b)},d=(v,A,b,w)=>{if(w)return this.sockets[w].run(v,A,b);{let m=[];for(let _ in this.servers[l].clients)m.push(this.sockets[_].run(v,A,b));return m}},g=(v,A,b,w,m,_)=>{if(b)this.sockets[b].subscribe(v,A,w,m,_);else{let k=[];for(let O in this.servers[l].clients)k.push(this.sockets[O].subscribe(v,A,w,m,_));return k}},y=(v,A,b)=>{if(b)this.sockets[b].unsubscribe(v,A);else{let w=[];for(let m in this.servers[l].clients)w.push(this.sockets[m].unsubscribe(v,A));return w}},x=v=>v?this.terminate(v):this.terminate(l);return this.servers[l].send=h,this.servers[l].request=c,this.servers[l].post=u,this.servers[l].run=d,this.servers[l].subscribe=g,this.servers[l].unsubscribe=y,this.servers[l].terminate=x,this.servers[l].graph=this,this.servers[l]._id=e._id?e._id:l,this.servers[l]};openWS=e=>{if(!e.address){let c=e.protocol;c||(c="wss"),e.address=`${c}://${e.host}`,e.port&&(e.address+=":"+e.port),(!e.path||e.path?.startsWith("/"))&&(e.address+="/"),e.path&&(e.address+=e.path)}let t=e.address,s;if(e.socket?s=e.socket:s=new ae(t),"keepState"in e||(e.keepState=!0),e.onmessage)s.on("message",c=>{this.sockets[t].onmessage(c,s,this.sockets[t])});else if(e._id)s.addListener("message",c=>{ArrayBuffer.isView(c)&&(c=c.toString()),e.debug&&console.log("Message from ",e._id,": ",c),this.receive(c,s,this.sockets[t]),e.keepState&&this.setState({[t]:c})});else{let c=u=>{if(ArrayBuffer.isView(u)&&(u=u.toString()),u&&(e.debug&&console.log("Message from ",t,": ",u),typeof u=="string")){let d=u.substring(0,8);(d.includes("{")||d.includes("["))&&(d.includes("\\")&&(u=u.replace(/\\/g,"")),u[0]==='"'&&(u=u.substring(1,u.length-1)),u=JSON.parse(u),u.route==="setId"?(this.sockets[t]._id=u.args,s.removeEventListener("message",c),s.on("message",g=>{ArrayBuffer.isView(g)&&(g=g.toString()),e.debug&&console.log("Message from ",this.sockets[t]._id,": ",g),this.receive(g,s,this.sockets[t]),e.keepState&&this.setState({[t]:g})})):(this.receive(u,s,this.sockets[t]),this.setState({[t]:u})))}this.receive(u,s,this.sockets[t]),e.keepState&&this.setState({[t]:u})};s.addListener("message",c),e.onmessage=c}s.addListener("open",()=>{this.sockets[t].onopen&&this.sockets[t].onopen(s,this.sockets[t])}),s.addListener("close",(c,u)=>{let d=this.sockets[t],g=d.onclose;delete this.sockets[t],g&&g(c,u,s,d)}),s.on("error",c=>{this.sockets[t]?.onerror&&this.sockets[t].onerror(c,s,this.sockets[t])});let i=c=>this.transmit(c,s),r=(c,u,d)=>{let g={route:c,args:u};return d&&(g.method=d),this.transmit(g,s)},o=(c,u,d)=>new Promise((g,y)=>{let x=Math.random(),v={route:"runRequest",args:[{route:c,args:u},this.sockets[t]._id,x]};d&&(v.args[0].method=d);let A=b=>{let w=b.data;typeof w=="string"&&w.indexOf("{")>-1&&(w=JSON.parse(w)),typeof w=="object"&&w.callbackId===x&&(s.removeEventListener("message",A),g(w.args))};s.addEventListener("message",A),this.transmit(v,s)}),a=(c,u)=>this.request(c,s,this.sockets[t]._id,u),l=(c,u)=>this.subscribeToSocket(c,this.sockets[t]._id,u),f=(c,u)=>o("unsubscribe",[c,u]),h=()=>{this.terminate(this.sockets[t]._id)};return this.sockets[t]={type:"socket",socket:s,send:i,post:r,request:a,run:o,subscribe:l,unsubscribe:f,terminate:h,graph:this,__node:{tag:t},...e},this.sockets[t]};transmit=(e,t)=>{if((typeof e=="object"&&(e?.route||e?.node||typeof e.arrayBuffer!="function"&&typeof e.byteLength!="number"&&typeof e[0]?.byteLength!="number")||typeof e=="number")&&(e=JSON.stringify(e)),!t){let s=this.servers[Object.keys(this.servers)[0]];if(s)t=s.wss;else{let i=this.sockets[Object.keys(this.sockets)[0]];i&&(t=i.socket)}}t instanceof Be.default?t.clients.forEach(s=>{s.send(e)}):t instanceof ae&&t.send(e)};closeWS=e=>{if(e){if(typeof e=="string"){for(let t in this.sockets)if(t.includes(e)){e=this.sockets[t].socket,delete this.sockets[t];break}}}else{let t=this.sockets[Object.keys(this.sockets)[0]];t&&(e=t.socket)}return e instanceof ae&&e.readyState===e.OPEN&&e.close(),!0};terminate=e=>{let t;if(e){if(typeof e=="string"){t=e;for(let s in this.servers)if(s.includes(e)||this.servers[s]._id===e){e=this.servers[s].wss;for(let i in this.servers[s].clients)this.closeWS(this.servers[s].clients[i]);delete this.servers[s];break}if(!e){for(let s in this.sockets)if(s.includes(e)||this.sockets[s]._id===e){e=this.sockets[s].socket,delete this.sockets[s];break}}}}else{let s=Object.keys(this.servers);for(let r in s)this.terminate(r);let i=Object.keys(this.sockets);for(let r in i)this.terminate(r)}return e instanceof Be.default?e.close(s=>{s&&console.error(s)}):e instanceof ae&&(e.readyState===e.OPEN&&e.close(),this.get(t||e.url)&&this.remove(t||e.url)),!0};request=(e,t,s,i)=>{let r=`${Math.random()}`,o={route:"runRequest",args:[e,s,r]};return i&&(o.method=i),new Promise((a,l)=>{let f=h=>{let c=h.data;typeof c=="string"&&c.includes("callbackId")&&(c=JSON.parse(c)),typeof c=="object"&&c.callbackId===r&&(t.removeEventListener("message",f),a(c.args))};t.addEventListener("message",f),t.send(JSON.stringify(o))})};runRequest=(e,t,s)=>{let i=this.receive(e);if(t){if(typeof t=="string"){for(let r in this.servers)for(let o in this.servers[r].clients)if(o===t){t=this.servers[r].clients[o];break}if(!(t instanceof ae)){for(let r in this.sockets)if(r===t){t=this.sockets[r].socket;break}}}i instanceof Promise?i.then(r=>{i={args:r,callbackId:s},t instanceof ae&&t.send(JSON.stringify(i))}):(i={args:i,callbackId:s},t instanceof ae&&t.send(JSON.stringify(i)))}return i};subscribeSocket=(e,t,s,i,r)=>{if(!this.restrict?.[e]){if(typeof t=="string")if(this.sockets[t])t=this.sockets[t].socket;else for(let o in this.servers)this.servers[o].clients[t]&&(t=this.servers[o].clients[t]);if(typeof t=="object")return this.subscribe(e,o=>{t.readyState===t.OPEN&&(o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e})))},s,i,r)}};subscribeToSocket=(e,t,s,i,r,o)=>{if(typeof t=="string"&&this.sockets[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.setState({[s]:a.args}):s(a.args):this.setState({[t]:a.args}))}),this.sockets[t].request({route:"subscribeSocket",args:[e,t,i,r,o]})}};function Hn(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var le=require("child_process");var ar=J(require("path")),gs=class extends C{processes;connections={processes:void 0};subprocessloader={process:(e,t,s,i,r)=>{e.command&&this.createProcess(e)}};constructor(e){super(e),this.load(this),this.connections.processes=this.processes,process?.stdin&&process.stdin.on("data",t=>{let s=t.toString();this.receive(s)})}createProcess=e=>{let t=e;if(t.command||(t.command="node"),t.args||(t.args=[ar.default.join(process.cwd(),"node_modules","graphscript-node","services","cmd","childprocess.js")]),t.command){let s;t.options||(t.options={shell:!0,stdio:"inherit"}),t.controller=new AbortController,t.options=Object.assign({signal:t.controller.signal,env:process.env,cwd:process.cwd()},t.options),t.tag?t._id=t.tag:(t._id=`process${Math.floor(Math.random()*1e15)}`,t.tag=t._id),typeof t.command=="string"&&(t.command.includes(".js")?s=(0,le.fork)(t.command,t.args,t.options):s=(0,le.spawn)(t.command,t.args?t.args:[],t.options),s instanceof le.ChildProcess&&(s.stderr&&(t.onerror?s.stderr.on("data",t.onerror):s.stderr.on("data",console.error)),s.stdout&&(t.stdout?s.stdout.on("data",t.stdout):s.stdout.on("data",i=>{let r=i.toString();this.receive(r),this.setState({[t._id]:r})})),t.onclose&&s.on("close",t.onclose),t.process=s,t.controller=new AbortController,t.send=i=>s.send(i),t.request=(i,r)=>this.request(i,t._id,r),t.post=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),s.send(JSON.stringify(a))},t.run=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),this.request(a,t._id)},t.subscribe=(i,r,o,a,l)=>this.subscribeToProcess(i,t._id,r,o,a,l),t.unsubscribe=(i,r)=>t.run("unsubscribe",[i,r]),this.processes[t._id]=t))}return t};open=this.createProcess;abort=e=>(e.controller?e.controller.abort():e.kill(),!0);send=(e,t)=>e.send(t);request=(e,t,s)=>{let i=this.processes[t].process;return new Promise((r,o)=>{let a=Math.random(),l={route:"runRequest",args:[e,a]};s&&(l.method=s);let f=h=>{let c=h.toString();if(c.includes("{")){let u=JSON.parse(c);u.callbackId===a&&(i.removeListener("data",f),r(u.args))}};i.addListener("data",f),i.send(l)})};runRequest=(e,t,s)=>{let i=this.receive(e);return typeof s=="string"&&(s=this.processes[s].process),i instanceof Promise?i.then(r=>{i={args:r,callbackId:t},s instanceof le.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))}):(i={args:i,callbackId:t},s instanceof le.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))),i};subscribeProcess(e,t,s,i,r){if(!this.restrict?.[e])return typeof t=="string"&&this.processes[t]&&(t=this.processes[t].process),this.subscribe(e,o=>{o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e}))},s,i,r)}subscribeToProcess(e,t,s,i,r,o){if(typeof t=="string"&&this.processes[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.run(s,a.args):s(a.args):this.setState({[t]:a.args}))}),this.processes[t].request(JSON.stringify({route:"subscribeSocket",args:[e,t,i,r,o]}))}};var F={};Ms(F,{AuthorizationStruct:()=>ws,ChatroomStruct:()=>Os,CoherenceMap:()=>xt,CoherenceStruct:()=>kt,CommentStruct:()=>Ts,Data:()=>fr,DataStruct:()=>xs,DateStruct:()=>Cs,ECGStruct:()=>Ot,EDAStruct:()=>_s,EEGCoordinates:()=>lr,EEGStruct:()=>se,EMGStruct:()=>Ss,EventStruct:()=>As,EyeTrackerStruct:()=>ys,FNIRSStruct:()=>At,FrequencyBandsStruct:()=>Ge,GroupStruct:()=>ks,HRVStruct:()=>bs,IMUStruct:()=>ps,NotificationStruct:()=>Ps,PPGStruct:()=>ms,ProfileStruct:()=>vs,ScheduleStruct:()=>Es,Struct:()=>I,eegCoordinates:()=>fe,setCoordinate:()=>Fe,structRegistry:()=>cr});function I(n="struct",e={},t={_id:""},s={structType:"struct",_id:""}){function i(o=""){return`${o+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}let r={_id:i(n+"defaultId"),structType:n,ownerId:t?._id,timestamp:Date.now(),parent:{structType:s?.structType,_id:s?._id}};return r.ownerId||delete r.ownerId,r?.parent?._id||delete r.parent,Object.keys(e).length>0&&Object.assign(r,e),r}var fe={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function Fe(n,e={}){if(!fe[n.tag]&&n.position&&(fe[n.tag]=[n.position.x,n.position.y,n.position.z]),fe[n.tag]){let t={channel:"",position:{x:fe[n.tag][0],y:fe[n.tag][1],z:fe[n.tag][2]}};return Object.assign(e,t)}else return Object.assign(e,n)}function lr(n=[],e=!0){let t=[];for(let s of n){let i=se(s);t.push(i)}return e&&t.push(...xt({channelDicts:n})),t}function Ge(n=[],e={}){let t={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return n.forEach(s=>t[s]=[]),Object.assign(e,t)}function se(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=Ge(),r={tag:n,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=I("eeg",r,t,s);return n&&Fe(r,o),Object.assign(o,e)}function kt(n={0:se("FP1"),1:se("FP2")},e={},t={_id:""},s={structType:"struct",_id:""}){let i=Ge(),r={tag:n[0]?.tag+"::"+n[1]?.tag,x0:n[0]?.position?.x,y0:n[0]?.position?.y,z0:n[0]?.position?.z,x1:n[1]?.position?.x,y1:n[1]?.position?.y,z1:n[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=I("coherence",r,t,s);return Object.assign(o,e)}function xt(n={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},t={_id:""},s={structType:"struct",_id:""}){for(var i=[],r=1,o=0,a=0;a<n.channelDicts.length*(n.channelDicts.length+1)/2-n.channelDicts.length;a++){if(n.taggedOnly===!1||n.taggedOnly===!0&&n.channelDicts[o].tag!==null&&n.channelDicts[o+r].tag!==null&&n.channelDicts[o].tag!=="other"&&n.channelDicts[o+r].tag!=="other"&&n.channelDicts[o].analyze===!0&&n.channelDicts[o+r].analyze===!0){var l=se(n.channelDicts[o].tag),f=se(n.channelDicts[o+r].tag);i.push(kt({0:l,1:f},{},t,s))}r++,r+o===n.channelDicts.length&&(o++,r=1)}return i}function At(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},r=I("fnirs",i,t,s);return n&&Fe(i,r),Object.assign(r,e)}function ps(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},r=I("imu",i,t,s);return n&&Fe(i,r),Object.assign(r,e)}function ys(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},r=I("eyetracker",i,t,s);return Object.assign(r,e)}function Ot(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},r=I("ecg",i,t,s);return Object.assign(r,e)}function _s(n="",e={},t={_id:""},s={structType:"struct",_id:""}){}function ms(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=At(n,t,s,e);return i.structType="ppg",i}function bs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=Ot(n,t,s,e);return i.structType="hrv",i}function Ss(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=se(n,t,s,e);return i.structType="emg",i}function vs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=I("profile",{tag:n,name:"",username:"",firstName:"",lastName:"",email:"",phone:"",sex:"",birthday:"",type:"",pictureUrl:"",userRoles:{},socials:{},data:{},hidden:!1,accessToken:"",refreshToken:""},t,s);return Object.assign(r,e)}function ws(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=I("authorization",{tag:n,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:{},structs:{},excluded:{},groups:{},status:"PENDING",expires:!1,associatedAuthId:""},t,s);return Object.assign(r,e)}function ks(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=I("group",{tag:n,name:"",details:"",admins:{},peers:{},clients:{},users:{}},t,s);return Object.assign(r,e)}function fr(n,e){return{type:n,data:e,timestamp:Date.now()}}function xs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",expires:!1,type:"",data:new Array},r=I("data",i,t,s);return Object.assign(r,e)}function As(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,event:"",author:"",startTime:"",endTime:"",grade:void 0,value:void 0,units:void 0,location:void 0,notes:"",attachments:new Array,users:{}},r=I("event",i,t,s);return Object.assign(r,e)}function Os(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:{},audioChatActive:!1,videoChatActive:!1},r=I("chatroom",i,t,s);return Object.assign(r,e)}function Ts(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:{},attachments:new Array},r=I("comment",i,t,s);return Object.assign(r,e)}function Ps(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=I("notification",{tag:n,note:"",parentUserId:""},t,s);return Object.assign(r,e)}function Es(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",attachments:new Array,dates:new Array},r=I("schedule",i,t,s);return Object.assign(r,e)}function Cs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},r=I("date",i,t,s);return Object.assign(r,e)}var cr={Struct:I,EEGStruct:se,FNIRSStruct:At,CoherenceStruct:kt,CoherenceMap:xt,FrequencyBandsStruct:Ge,IMUStruct:ps,EyeTrackerStruct:ys,ECGStruct:Ot,EDAStruct:_s,PPGStruct:ms,HRVStruct:bs,EMGStruct:Ss,ProfileStruct:vs,AuthorizationStruct:ws,GroupStruct:ks,DataStruct:xs,EventStruct:As,ChatroomStruct:Os,CommentStruct:Ts,NotificationStruct:Ps,ScheduleStruct:Es,DateStruct:Cs};var qe=class{id;threaded;workers;DS=F;collections=new Map;data={byTime:{},notes:{},events:{},sleep:{},food:{},rx:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}};rolloverLimit=5e4;dataSorts=new Map;watches={};constructor(e={}){Object.assign(this.data,e),this.dataSorts=new Map,this.watches={},this.setSort("event",t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],t.event==="sleep"&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t)),this.setSort(["notes","note","link"],t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t)),this.id=this.randomId("dataTablet")}randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(e){let t=s=>{let i=s.structType,r=this.collections.get(i);r||(r=new Map,this.collections.set(i,r)),r.set(s._id,s),this.onCollectionSet(i,r)};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)}getLocalData(e,t){let s="",i="",r="";if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return this.collections.forEach(a=>{if((i==="_id"||i==="id")&&r){let l=a.get(r);l&&o.push(l)}else a.forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections.get(e);if(!a)return o;if(!i&&!s)return a.forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return a.get(r);a.forEach((l,f)=>{i&&r&&!s?l[i]===r&&o.push(l):s&&!i?l.ownerId===s&&o.push(l):s&&i&&r&&l.ownerId===s&&l[i]&&l[i]===r&&o.push(l)})}return o}onCollectionSet=(e,t)=>{};runSort(e,t={},s=[],i=this){let r,o=this.getSort(e);if(o)r=o(t,s,i);else return!1;return r}setSort(e,t=(s,i=[],r=this)=>{}){Array.isArray(e)?e.forEach(s=>{this.dataSorts.set(s,t)}):this.dataSorts.set(e,t)}getSort(e){return this.dataSorts.get(e)}checkWatches(e={}){for(let t in this.watches)this.watches[t].ondata(e,this.watches[t].accum,this.watches[t].ownerId)&&(this.watches[t].ontrigger(this.watches[t].accum),this.watches[t].triggered=!1)}setWatch(e,t,s=(r,o,a)=>(r.ownerId===a&&(o.data[r._id]=r),Object.keys(o.data).length>10),i=r=>{console.log(r);let o=I("alert",{alert:!0,data:r},{_id:r[Object.keys(r)[0]].ownerId});r={}}){this.watches[e]={accum:{},ownerId:t,ondata:s,ontrigger:i}}getWatch(e){return this.watches[e]}async sortStructsIntoTable(e=[]){let t=function(i,r){if(i.timestamp&&r.timestamp)return i.timestamp-r.timestamp};e.sort(t);let s=[];for(let i=0;i<e.length;i++){let r=e[i];if(!r.timestamp)continue;let o=r.timestamp;if(this.data.byTime[o]?this.data.byTime[o].push(r):this.data.byTime[o]=[r],r.structType==="data"&&r.data)r.data.forEach(async a=>{if(typeof a=="object"&&!Array.isArray(a)){let l=a.dataType;if(a.ownerId=r.ownerId,a.timestamp||(a.timestamp=o),l){let f=this.runSort(l,a,s,this);f?f.constructor?.name!=="Promise"&&(this.checkWatches(f),this.onUpdate(o,f),s.push(f)):(this.data[l]||(this.data[l]={}),a.timestamp=o,this.data[l][o]?this.data[l][o].push(a):this.data[l][o]=[a],this.data.byTime[o]?this.data.byTime[o].push(a):this.data.byTime[o]=[a],this.checkWatches(a),this.onUpdate(o,a),s.push(a))}}});else{let a=this.runSort(r.structType,r,s,this);if(a)this.checkWatches(a),this.onUpdate(o,a),s.push(a);else{let l=r.structType;this.data[l]||(this.data[l]={}),this.data[l][o]?this.data[l][o].push(r):this.data[l][o]=[r],this.checkWatches(r),this.onUpdate(o,r),s.push(r)}}}for(let i in this.data)this.data[i]=this.sortObjectByPropName(this.data[i]);this.onSorted(s)}onUpdate(e,t,s=this.data){}onSorted(e=[]){}getDataByTimestamp(e,t){let s=this.data.byTime[e];return t&&s&&(s=s.filter(i=>t?t===i.ownerId:!0)),s}getDataByTimeRange(e,t,s,i){let r={};if(s){for(let o in this.data[s]){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data[s][o]])}s==="sleep"&&(r=this.filterSleepResults(r))}else for(let o in this.data.byTime){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data.byTime[o]])}if(i&&r)for(let o in r){let a=[];r[o]=r[o],r[o].forEach((l,f)=>{l.ownerId!==i&&a.push(f)}),a.reverse().forEach(l=>{r[o].splice(l,1)}),r[o].length===0&&delete r[o]}return r}getDataByType(e,t,s){if(!this.data[e])return;let i={...this.data[e]};if(t&&(i=[...i[t]]),s&&i)for(let r in i){let o=[];i[r]=[...i[r]],i[r].forEach((a,l)=>{a.ownerId!==s&&o.push(l)}),o.reverse().forEach(a=>{i[r].splice(a,1)}),i[r].length===0&&delete i[r]}return e==="sleep"&&(i=this.filterSleepResults(i)),i}filterSleepResults(e={}){let t=[];for(let i in e)e[i]=[...e[i]],t.push(...e[i].filter(r=>r.structType==="event"));return t.forEach(i=>{let r;for(let o in e)e[o].forEach((a,l)=>a.structType==="fitbitsleep"&&i.startTime&&i.endTime&&Math.abs(a.startTime-i.startTime)<1e3*12*3600&&Math.abs(a.endTime-i.endTime)<1e3*12*3600&&i.endTime-i.startTime>1e3*2*3600?(r=l,!0):!1),r&&e[o].splice(r,1)}),e}sortObjectByPropName(e){return Object.keys(e).sort().reduce((s,i)=>(s[i]=e[i],s),{})}checkRollover(e,t=this.rolloverLimit){if(!e)return!1;let s=this.collections.get(e);return s?(s.forEach(i=>{for(let r in i)Array.isArray(i[r])?i[r].length>t&&(i[r].slice(i[r].length-t),r==="ffts"?i.fftCount=i[r].length:r==="times"&&(i.count=i[r].length)):typeof i[r]=="object"&&this.checkRollover(i[r])}),!0):!1}};var hr=["now","minute","5 minutes","30 minutes","hour","6 hours","12 hours","day","3 days","week","2 weeks","month","6 months","year","5 years","decade"];function Jn(n=hr){let e=["now"];return n.forEach(t=>{t!=="now"?e.push(`last ${t}`):e.push(t)}),e}function Z(n){let e=new Date;if(n!=="now"){if(n==="last minute")e.setMinutes(e.getMinutes()-1);else if(n==="last hour")e.setHours(e.getHours()-1);else if(n==="last day")e.setDate(e.getDate()-1);else if(n==="last week")e.setDate(e.getDate()-7);else if(n==="last month")e.setMonth(e.getMonth()-1);else if(n==="last year")e.setFullYear(e.getFullYear()-1);else if(n==="last decade")e.setFullYear(e.getFullYear()-1*10);else if(n==="last century")e.setFullYear(e.getFullYear()-1*100);else if(n==="last millennium")e.setFullYear(e.getFullYear()-1*1e3);else if(n==="last microsecond")e.setMilliseconds(e.getMilliseconds()-1);else if(n==="last nanosecond")e.setMilliseconds(e.getMilliseconds()-1*.001);else if(n.startsWith("last")){let[,t,s]=n.match(/last (\d+) (\w+)/)||[];if(t&&s){let i=parseInt(t,10);s.includes("minute")?e.setMinutes(e.getMinutes()-i):s.includes("hour")?e.setHours(e.getHours()-i):s.includes("day")?e.setDate(e.getDate()-i):s.includes("week")?e.setDate(e.getDate()-i*7):s.includes("month")?e.setMonth(e.getMonth()-i):s.includes("year")?e.setFullYear(e.getFullYear()-i):s.includes("decade")?e.setFullYear(e.getFullYear()-i*10):s.includes("century")?e.setFullYear(e.getFullYear()-i*100):s.includes("millennium")?e.setFullYear(e.getFullYear()-i*1e3):s.includes("microsecond")?e.setMilliseconds(e.getMilliseconds()-i):s.includes("nanosecond")&&e.setMilliseconds(e.getMilliseconds()-i*.001)}}}return e.getTime()}var ur=n=>(n?`${n}`:"")+Math.floor(1e15*Math.random()),Vn=(n=Math,e=Date,t=16,s=i=>n.floor(i).toString(t))=>s(e.now()/1e3)+" ".repeat(t).replace(/./g,()=>s(n.random()*t)),Ns=class extends C{name="structs";currentUser;tablet=new qe;collections=this.tablet.collections;id=ur();useAccessTokens=!1;useRefreshTokens=!1;constructor(e,t){super(e),this.load(this),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),t instanceof Object&&Object.keys(t).length>0&&this.setupUser(t)}getToken(e){if(this.useAccessTokens)return e.accessToken;if(this.useRefreshTokens)return e.refreshToken}setupUser=async(e,t=s=>{})=>{if(!e){console.error('must provide a minimum info object! e.g. {_id:"abc123"}'),t(void 0);return}let s=!1;e.id&&!e._id?e._id=e.id:e._id&&(e.id=e._id);let i=await this.getUser(e._id),r=i?.user,o,a=!1;if(!r||!r._id){o=this.userStruct(e,!1),a=!0;let l=await this.setUser(o),f=this.getLocalData(void 0,{ownerId:o._id});f?.length>0&&this.updateServerData(f),this.setAuthorizationsByGroup(o)}else{o=r;let l={_id:e._id,ownerId:e._id},f=this.userStruct(e,!1);for(let h in f)e[h]&&r[h]!==e[h]?(l[h]=e[h],r[h]=e[h]):f[h]&&!r[h]&&(l[h]=f[h],r[h]=f[h]);Object.keys(l).length>2&&await this.setUser(l),i?.authorizations&&Array.isArray(i.authorizations)&&this.setLocalData(i.authorizations),i?.groups&&Array.isArray(i.groups)&&this.setLocalData(i.groups)}if(a)this.setLocalData(o);else{let l=await this.getAllUserData(o._id,void 0,[Z("last day"),Date.now()]);if(!(!l||l.length===0)){this.setLocalData(l);let f=l.filter(d=>{if(d.structType==="notification"&&(this.getLocalData("authorization",d.parent._id)||d.parent.structType==="user"||d.parent.structType==="authorization"||!this.getLocalData(d.parent.structType,d.parent._id)))return!0}),h=l.filter(d=>{if(d.structType==="comment")return!0}),c=[];h.forEach(d=>{this.getLocalData("comment",{_id:d._id})||c.push(d._id)}),c.length>0&&this.deleteData(c),f.length>0&&(this.resolveNotifications(f,!1,void 0),s=!0);let u=l.filter(d=>{if(d.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(u)}this.setLocalData(o)}return o?(this.currentUser?Object.assign(this.currentUser,o):this.currentUser=o,t(this.currentUser),this.currentUser):(t(o),o)};baseServerCallback=async e=>{let t=e;if(typeof e=="object"&&e?.structType&&(t=[e]),Array.isArray(t)){let s=t.filter(i=>{if(i.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(s);for(let i=0;i<t.length;i++){let r=t[i];if(typeof r=="object")if((!r.structType||r.structType==="USER")&&(r.email?r.structType="user":r.structType="uncategorized"),r.structType==="user"||r.structType==="authorization"||r.structType==="group"){if(r.structType==="user")r._id=r.id;else if(r.structType==="group"&&this.currentUser){let o=!1;r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_admin"]?(this.currentUser.userRoles[r.name+"_admin"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_admin"]&&(delete this.currentUser.userRoles[r.name+"_admin"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_peer"]?(this.currentUser.userRoles[r.name+"_peer"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_peer"]&&(delete this.currentUser.userRoles[r.name+"_peer"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_client"]?(this.currentUser.userRoles[r.name+"_client"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_client"]&&(delete this.currentUser.userRoles[r.name+"_client"],o=!0),o&&await this.setUser(this.currentUser)}this.setLocalData(r)}else r.structType==="notification"?(this.getLocalData("notification",{ownerId:r.ownerId,_id:r.parent._id})?this.setLocalData(r):this.getLocalData(r.structType,{_id:r.parent._id})||this.overwriteLocalData(r),r.ownerId===this.currentUser?._id&&(r.parent.structType==="user"||r.parent.structType==="dataInstance"||r.parent.structType==="schedule"||r.parent.structType==="authorization")&&await this.resolveNotifications([r],!0),this.onNotify(r)):this.overwriteLocalData(r)}}this.onData(e)};structNotification=()=>{this.checkForNotifications()};structDeleted=e=>{this.deleteLocalData([e])};onData=e=>{};onNotify=e=>{};randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct=async(e="struct",t={},s,i,r=!0)=>{let o=F.Struct(e,t,s,i);return r&&(o=await this.updateServerData([o])[0]),o};getUser=async(e="",t,s=this.baseServerCallback)=>{if(console.log(this.currentUser),this.currentUser?.request){let i=await this.currentUser.request({route:"getUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return s(i),i}};queryUsers=async(e,t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"queryUsers",args:[this.currentUser._id,e,t,s,void 0,this.getToken(this.currentUser)]});return i(r),r}};getUsers=async(e=[],t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUsersByIds",args:[this.currentUser._id,e,t]});return s(i),i}};getUsersByRole=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=await this.currentUser.request({route:"getUsersByRole",args:[this.currentUser._id,e]});return t(s),s}};getAllUserData=async(e,t=[],s,i=this.baseServerCallback)=>{if(s&&(typeof s[0]=="string"&&(s[0]=Z(s[0])),typeof s[1]=="string"&&(s[1]=Z(s[1]))),this.currentUser?.request){let r=await this.currentUser.request({route:"getAllData",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return i(r),r}};query=async(e,t={},s=!1,i=0,r=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e||!t)return;let o=await this.currentUser.request({route:"query",args:[this.currentUser._id,e,t,s,i,this.getToken(this.currentUser)]});return typeof r=="function"&&r(o),o}};getDataByTimeRange(e,t,s,i=0,r=0,o){let a={};t&&(typeof t[0]=="string"&&(t[0]=Z(t[0])),typeof t[1]=="string"&&(t[1]=Z(t[1])));let l={$gt:t[0],$lt:t[1]};return o?a[o]=l:a.timestamp=l,this.getData(e,s,a,i,r)}getData=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{if(this.currentUser?.request){let a=await this.currentUser.request({route:"getData",args:[this.currentUser._id,e,t,s,i,r,this.getToken(this.currentUser)]});return typeof o=="function"&&o(a),a}};getDataByIds=async(e=[],t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"getDataByIds",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return typeof i=="function"&&i(r),r}};getStructParentData=async(e,t=this.baseServerCallback)=>{if(e?.parent&&this.currentUser?.request){let s=[this.currentUser._id,e.parent?.structType,"_id",e.parent?._id,this.getToken(this.currentUser)],i=(await this.currentUser.request({route:"getData",args:s}))?.[0];return typeof t=="function"&&t(i),i}};setUser=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setUser",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkUserToken=async(e,t=this.currentUser,s=this.baseServerCallback)=>{if(!e)return!1;let i=!1;for(let r in e){let o=this.userStruct();if(t[r]&&r!=="_id")if(Array.isArray(e[r])){for(let a=0;a<t[r].length;a++)if(e[r].indexOf(t[r][a])<0){t[r]=e[r],i=!0;break}if(!i){for(let a=0;a<e[r].length;a++)if(t[r].indexOf(e[r][a])<0){t[r]=e[r],i=!0;break}}}else t[r]!==e[r]&&(t[r]=e[r],i=!0);else!t[r]&&o[r]&&(t[r]=e[r],i=!0)}return i&&await this.setUser(t,s)};setData=async(e=[],t=!0,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=new Array;!Array.isArray(e)&&typeof e=="object"&&(e=[e]),e.forEach(o=>{i.push(this.stripStruct(o))});let r=await this.currentUser.request({route:"setData",args:[this.currentUser._id,i,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};updateServerData=this.setData;deleteData=async(e=[],t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=[];e.forEach(r=>{if(typeof r=="object")r?.structType&&r?._id&&(s.push({structType:r.structType,_id:r._id}),this.deleteLocalData(r));else if(typeof r=="string"){let o=this.getLocalData(void 0,{_id:r});o&&!Array.isArray(o)?s.push({structType:o.structType,_id:o._id}):s.push({_id:r})}});let i=await this.currentUser.request({route:"deleteData",args:[this.currentUser._id,s,this.getToken(this.currentUser)]});return typeof t=="function"&&t(i),i}};deleteUser=async(e=this.currentUser._id,t,s=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;let i=await this.currentUser.request({route:"deleteUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};setGroup=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setGroup",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getUserGroups=async(e=this.currentUser._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUserGroups",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteGroup=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteGroup",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};setAuthorization=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setAuthorization",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getAuthorizations=async(e=this.currentUser?._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){if(e===void 0)return;let i=await this.currentUser.request({route:"getAuthorizations",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteAuthorization=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteAuthorization",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkForNotifications=async(e=this.currentUser?._id)=>await this.getData("notification",e);resolveNotifications=async(e=[],t=!0,s=this.currentUser)=>{if(!s||e.length===0)return;let i=[],r=[],o=[],a=!1;if(e.length===0&&(e=this.getLocalData("notification",{ownerId:s._id})),e.forEach(l=>{l.parent.structType==="user"&&(a=!0),o.push(l.parent.structType),i.push(l.parent._id),r.push(l._id),this.deleteLocalData(l)}),this.deleteData(e),t){if(o.reverse().forEach((l,f)=>{l==="user"&&(this.getUser(i[f]),i.splice(i.length-f-1,1))}),i.length===1)return await this.getDataByIds(i,void 0,e[0].parent.structType);if(i.length>0)return await this.getDataByIds(i)}return!0};setAuthorizationsByGroup=async(e=this.currentUser)=>{let t=this.getLocalData("authorization",{ownerId:e._id}),s=[];if(e.userRoles&&await Promise.all(Object.keys(e.userRoles).map(async i=>{let o=i.split("_")[0],a;if(i.includes("client")?a=o+"_peer":i.includes("peer")?a=o+"_client":i.includes("admin")&&(a=o+"_owner"),a){let l=await this.getUsersByRole(a);l&&await Promise.all(l.map(async f=>{let h=f.username;h||(h=f.email),h||(h=f._id);let c=e.username;if(c||(c=e.email),c||(c=e._id),h!==c){if(i.includes("client")){if(!t.find(d=>{if(d.authorizerId===f._id&&d.authorizedId===e._id)return!0})){let d=await this.authorizeUser(F.ProfileStruct("user",e,e),f._id,h,e._id,c,{peer:!0},void 0,{group:o});s.push(d)}}else if(i.includes("peer")&&!t.find(d=>{if(d.authorizedId===f._id&&d.authorizerId===e._id)return!0})){let d=await this.authorizeUser(F.ProfileStruct("user",e,e),e._id,c,f._id,h,{peer:!0},void 0,{group:o});s.push(d)}}}))}})),s.length>0)return s};deleteRoom=async e=>{if(!e)return!1;let t=[e];return e.comments?.forEach(s=>{let i=this.getLocalData("comment",{_id:s});t.push(i)}),e?await this.deleteData(t):!1};deleteComment=async e=>{let t=[e],s=(a=e)=>{a?.replies&&a.replies.forEach(l=>{let f=this.getLocalData("comment",{_id:l});f&&(f.replies.length>0&&f.replies.forEach(h=>{s(h)}),t.push(f))})};s(e);let i=this.getLocalData(e.parent?.structType,{_id:e.parent?._id}),r=[];i&&(r=[i],t.forEach(a=>{let l=i.replies?.indexOf(a._id);l>-1&&i.replies.splice(l,1);let f=i.comments?.indexOf(a._id);f>-1&&i.comments.splice(f,1)}));let o=this.getLocalData("comment",{_id:e.replyTo});if(o?._id!==i?._id){let a=o.replies?.indexOf(i._id);a>-1&&o.replies.splice(a,1),r.push(o)}return r.length>0&&await this.updateServerData(r),await this.deleteData(t)};getUserDataByAuthorization=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=e.authorizerId;if(a)return new Promise(async l=>{this.getUser(a,!0,async f=>{let h;t?h=await this.getData(t,a,s,i,r,o):h=await this.getAllUserData(a,["notification"],void 0,o),l(h),o(h)})})};getUserDataByAuthorizationGroup=async(e="",t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=this.getLocalData("authorization"),l=[];return await Promise.all(a.map(async f=>{if(f.groups?.includes(e)){let h=f.authorizerId;if(h){let c,u=await this.getUser(h,!0,o);u&&l.push(u),t?c=await this.getData(t,h,s,i,r,o):c=await this.getAllUserData(h,["notification"],void 0,o),c&&l.push(c)}return!0}})),l};overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){this.tablet.setLocalData(e)}getLocalData(e,t){return this.tablet.getLocalData(e,t)}getLocalUserPeerIds=(e=this.currentUser)=>{if(!e)return{};let t={};return this.getLocalData("authorization",e._id).forEach(i=>{i.authorizations.peer&&i.authorizerId===e._id&&(t[i.authorizedId]=!0)}),t};getLocalReplies(e){let t=[];if(e.replies){if(e.replies.reduce((s,i)=>s*(typeof i=="object"?1:0),1))return e.replies}else return t;return t=this.getLocalData("comment",{replyTo:e._id}),t}hasLocalAuthorization(e,t=this.currentUser._id){let i=this.getLocalData("authorization",{ownerId:t}).find(r=>{if(r.authorizedId===t&&r.authorizerId===e||r.authorizerId===t&&r.authorizedId===e)return!0});return i||!1}deleteLocalData(e){return Array.isArray(e)?e.forEach(t=>this.deleteStruct(t)):this.deleteStruct(e),!0}deleteStruct(e){if(typeof e=="string"&&(e=this.getLocalData(void 0,{_id:e})),!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.tablet.collections.get(e.structType).delete(e._id),!0)}stripStruct(e){let t=Object.assign({},e);for(let s in t)(t[s]===void 0||t[s]===""||t[s].constructor.name==="Map"||t[s].constructor.name==="Set"||typeof t[s]=="function"||Array.isArray(t[s])&&t[s].length===0||typeof t[s]=="object"&&Object.keys(t[s]).length===0)&&delete t[s];return t}createStruct(e,t,s=this.currentUser,i){return F.Struct(e,t,s,i)}userStruct(e={},t=!1){let s=F.ProfileStruct(void 0,e,e);if(!s.name&&s.firstName)s.name=s.firstName+" "+s.lastName;else if(s.name&&!s.firstName){let r=s.name.split(" ");s.firstName=r[0],s.lastName=r[r.length-1]}e._id?s.id=e._id:e.id?s.id=e.id:s.id="user"+Math.floor(Math.random()*1e15),s._id=s.id,s.ownerId=s.id;let i=F.ProfileStruct();for(let r in e)Object.keys(i).indexOf(r)<0&&delete s[r];return t&&(this.currentUser=s),s}authorizeUser=async(e,t="",s="",i="",r="",o={},a={},l={},f={},h=!1)=>{if(!e)return;let c=this.createStruct("authorization",void 0,e,void 0);return c.authorizedId=i,c.authorizedName=r,c.authorizerId=t,c.authorizerName=s,c.authorizations=o,c.structs=a,c.excluded=l,c.groups=f,c.expires=h,c.status="PENDING",c.associatedAuthId="",c=await this.setAuthorization(c),c};addGroup=async(e,t="",s="",i={},r={},o={},a=!0)=>{if(!e)return;let l=this.createStruct("group",void 0,e);return l.name=t,l.details=s,l.admins=i,l.peers=r,l.clients=o,l.users={},Object.assign(l.users,l.admins),Object.assign(l.users,l.peers),Object.assign(l.users,l.clients),a&&(l=await this.setGroup(l)),l};dataObject(e=void 0,t="any",s=Date.now()){return{type:t,data:e,timestamp:s}}addData=async(e,t="",s="",i="",r=[],o=!1,a=!0)=>{if(!e)return;let l=this.createStruct("dataInstance",void 0,e);return l.author=t,l.title=s,l.type=i,l.data=r,l.expires=o,a&&(l=await this.updateServerData([l])[0]),l};addEvent=async(e,t="",s="",i="",r,o,a,l,f,h,c,u,d=!0)=>{if(!e)return;u&&Object.keys(u).length===0&&(u=this.getLocalUserPeerIds(e));let g=this.createStruct("event",void 0,e);return g.author=t,g.event=s,g.notes=i,g.startTime=r,g.endTime=o,g.grade=a,g.attachments=c,g.value=l,g.units=f,g.users=u,g.location=h,d&&(g=await this.updateServerData([g])[0]),g};addChatroom=async(e,t="",s="",i,r,o=!0)=>{if(!e)return;r&&Object.keys(r).length===0&&(r=this.getLocalUserPeerIds(e));let a=this.createStruct("chatroom",void 0,e);a.message=s,a.attachments=i,a.authorId=t,a.users=r,a.replies=[],a.comments=[];let l=[a];return o&&(a=await this.updateServerData(l)[0]),a};addComment=async(e,t,s,i="",r="",o,a=!0)=>{if(!t||(s||(s=t),!e))return;let l=this.createStruct("comment",void 0,e,t);l.authorId=i,l.replyTo=s?._id,l.message=r,l.attachments=o,l.users=t?.users,l.replies=[],a||s?.replies.push(l._id),a||t?.comments.push(l._id);let f=[l,t];s?._id!==t._id&&f.push(s);let h;a&&(h=await this.updateServerData(f));let c;return typeof h=="object"&&(c=h.find(u=>{if(l.ownerId===u.ownerId&&l.timestamp===u.timestamp&&l.message===u.message)return!0})),c||h}};var Is=Math.floor(Math.random()*16777215),dr=E.index=parseInt(Math.random()*16777215,10),gr=(typeof process>"u"||typeof process.pid!="number"?Math.floor(Math.random()*1e5):process.pid)%65535,pr=(()=>{try{return _Buffer}catch{try{return Buffer}catch{return null}}})(),Tt=function(n){return!!(n!=null&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n))},_r=[];for(G=0;G<256;G++)_r[G]=(G<=15?"0":"")+G.toString(16);var G,yr=new RegExp("^[0-9a-fA-F]{24}$"),$e=[];G=0;for(;G<10;)$e[48+G]=G++;for(;G<16;)$e[55+G]=$e[87+G]=G++;function E(n){if(!(this instanceof E))return new E(n);if(n&&(n instanceof E||n._bsontype==="ObjectId"))return n;if(this._bsontype="ObjectId",n==null||typeof n=="number"){this.id=this.generate(n);return}var e=E.isValid(n);if(!e&&n!=null)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&typeof n=="string"&&n.length===24)return E.createFromHexString(n);if(n!=null&&n.length===12)this.id=n;else{if(n!=null&&typeof n.toHexString=="function")return n;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}}E.createFromTime=function(n){return n=parseInt(n,10)%4294967295,new E(Kn(8,n)+"0000000000000000")};E.createFromHexString=function(n){if(typeof n>"u"||n!=null&&n.length!==24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",t=0;t<24;)e+=String.fromCharCode($e[n.charCodeAt(t++)]<<4|$e[n.charCodeAt(t++)]);return new E(e)};E.isValid=function(n){return n==null?!1:typeof n=="number"?!0:typeof n=="string"?n.length===12||n.length===24&&yr.test(n):n instanceof E?!0:Tt(n)?E.isValid(n.toString("hex")):typeof n.toHexString=="function"&&pr&&(n.id instanceof pr||typeof n.id=="string")?n.id.length===12||n.id.length===24&&yr.test(n.id):!1};E.prototype={constructor:E,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(this.id.length===24)return this.id;if(Tt(this.id))return this.id.toString("hex");for(var n="",e=0;e<this.id.length;e++)n+=_r[this.id.charCodeAt(e)];return n},equals:function(n){return n instanceof E?this.toString()===n.toString():typeof n=="string"&&E.isValid(n)&&n.length===12&&Tt(this.id)?n===this.id.toString("binary"):typeof n=="string"&&E.isValid(n)&&n.length===24?n.toLowerCase()===this.toHexString():typeof n=="string"&&E.isValid(n)&&n.length===12?n===this.id:n!=null&&(n instanceof E||n.toHexString)?n.toHexString()===this.toHexString():!1},getTimestamp:function(){var n=new Date,e;return Tt(this.id)?e=this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:e=this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,n.setTime(Math.floor(e)*1e3),n},generate:function(n){typeof n!="number"&&(n=~~(Date.now()/1e3)),n=parseInt(n,10)%4294967295;var e=Yn();return String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255,Is>>16&255,Is>>8&255,Is&255,gr>>8&255,gr&255,e>>16&255,e>>8&255,e&255)}};function Yn(){return dr=(dr+1)%16777215}function Kn(n,e){return e=e.toString(16),e.length===n?e:"00000000".substring(e.length,n)+e}var Zn=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";E.prototype[Zn]=function(){return"ObjectId("+this+")"};E.prototype.toJSON=E.prototype.toHexString;E.prototype.toString=E.prototype.toHexString;var Xn=n=>(n?`${n}_`:"")+Math.floor(1e15*Math.random()),D=n=>typeof n=="string"&&n.length===24?new E(n):n,S=n=>typeof n=="object"?n.toString():n,mr=["profile","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],Ds=class extends C{name="structs";debug=!1;db;users={};collections={};mode="local";useAuths=!0;useAccessTokens=!1;useRefreshTokens=!1;accessTokens=new Map;refreshTokens=new Map;constructor(e,t){super(e),this.load(this),t&&this.initDB(t)}initDB=e=>{this.db=e.db,e?.users&&(this.users=e.users),e.mode&&(this.mode=e.mode),e?.collections&&(this.collections=e.collections),e.debug&&(this.debug=e.debug),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),"useAuths"in e&&(this.useAuths=e.useAuths),mr.forEach(t=>{this.collections[t]||(this.collections[t]=this.db?{instance:this.db.collection(t)}:{},this.collections[t].reference={})})};query=async(e,t,s,i,r,o)=>{let a=this.users[e];if(!a)return!1;if(this.mode.indexOf("mongo")>-1)return await this.queryMongo(a,t,s,i,r,o);{let l=this.getLocalData(a,t);if(l&&!Array.isArray(l)){let h=!this.useAuths;if(l?.ownerId?this.useAuths&&(h=await this.checkAuthorization(a,l,"READ",o)):h=!0,h)return l}typeof r=="number"&&Array.isArray(l)&&l.length>r&&l.splice(0,r);let f=[];return l&&await Promise.all(l.map(async h=>{let c=this.getLocalData(S(h._id)),u=!this.useAuths;!c?.ownerId||c.ownerId===a._id?u=!0:this.useAuths&&(u=await this.checkAuthorization(a,c,"READ",o)),u&&f.push(c)})),f}};getUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.indexOf("mongo")>-1)o=await this.getMongoUser(r,t,void 0,s,i);else{let a=this.getLocalData("profile",{_id:t});if(!a)o={user:void 0};else{let l=!this.useAuths;if(!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"READ",i)),l){let f=this.getLocalData("group",{ownerId:t}),h=this.getLocalData("authorization",{ownerId:t});o={user:a,groups:f,authorizations:h}}else o={user:{}}}}return this.debug&&console.log("getUser: user:",r,"input:",t,"output",o),o};setUser=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(t.accessToken)this.accessTokens.set(e,s);else if(this.useAccessTokens)return!1;if(t.refreshToken)this.refreshTokens.set(e,t.refreshToken);else if(this.useRefreshTokens)return!1;if(delete t.accessToken,delete t.refreshToken,delete i.accessToken,delete i.refreshToken,this.mode.indexOf("mongo")>-1)r=await this.setMongoUser(i,t,s);else{let o=!this.useAuths;return!t?.ownerId||t.ownerId===i._id?o=!0:this.useAuths&&(o=await this.checkAuthorization(i,t,"WRITE",s)),o&&this.setLocalData(t),!0}return this.debug&&console.log("setUser user:",i,"input:",t,"output",r),r};getUsersByIds=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoUsersByIds(i,t,s);else if(r=[],Array.isArray(t)){let o=this.getLocalData("profile",{_id:t});o&&(s?r.push({_id:o._id,username:o.username,firstName:o.firstName,lastName:o.lastName,fullName:o.fullName,pictureUrl:o.pictureUrl}):r.push(o))}return this.debug&&console.log("getUserByIds: user:",i,"input:",t,"output",r),r};getUsersByRole=async(e,t)=>{let s=this.users[e];if(!s)return!1;let i;if(this.mode.includes("mongo"))i=await this.getMongoUsersByRole(s,t);else{let r=this.getLocalData("profile");i=[],r.forEach(o=>{o.userRoles[t]&&i.push(o)})}return this.debug&&console.log("getUserByRoles: user:",s,"input:",t,"output",i),i};deleteUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.deleteMongoUser(r,t,s,i);else{o=!1;let a=this.getLocalData(t);if(a){let l=!this.useAuths;!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"WRITE",i)),l&&(o=this.deleteLocalData(a))}}return this.debug&&console.log("deleteUser: user:",r,"input:",t,"output",o),o};setData=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.setMongoData(r,t,s,i);else{let a=[];return o=[],await Promise.all(t.map(async l=>{let f=this.getLocalData(l),h=!this.useAuths;!f?.ownerId||f.ownerId===r._id?h=!0:this.useAuths&&(h=await this.checkAuthorization(r,f,"WRITE",i)),h&&(this.collections[f.structType]||(this.collections[f.structType]={},this.collections[f.structType].reference={}),this.setLocalData(f),o.push(f),f.structType!=="notification"&&a.push(f))})),a.length>0&&(s===!0||typeof s>"u")&&this.checkToNotify(r,a,this.mode),this.debug&&console.log("setData:",r,t,o),!0}return this.debug&&console.log("setData: user:",r,"input:",t,s,"output",o),o};getData=async(e,t,s,i,r,o,a)=>{let l=this.users[e];if(!l)return!1;let f;if(this.mode.includes("mongo"))f=await this.getMongoData(l,t,s,i,r,o,a);else{f=[];let h;t&&(h=this.getLocalData(t)),h&&s&&(h=h.filter(c=>{if(c.ownerId===s)return!0})),h&&await Promise.all(h.map(async c=>{let u=this.getLocalData(S(c._id)),d=!this.useAuths;!u?.ownerId||u.ownerId===l._id?d=!0:this.useAuths&&(d=await this.checkAuthorization(l,u,"READ",a)),d&&f.push(u)}))}return this.debug&&console.log("getData: user:",l,"input:",t,s,i,r,o,"output",f),f};getDataByIds=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getMongoDataByIds(o,t,s,i,r);else{a=[];let l;i&&(l=this.getLocalData(i)),l&&s&&(l=l.filter(f=>{if(f.ownerId===s)return!0})),l&&await Promise.all(l.map(async f=>{let h=this.getLocalData(S(f._id)),c=!this.useAuths;!h?.ownerId||h.ownerId===o._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(o,h,"READ",r)),c&&a.push(h)}))}return this.debug&&console.log("getDataByIds: user:",o,"input:",t,s,i,"output",a),a};getAllData=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getAllUserMongoData(o,t,s,i,r);else{let l=this.getLocalData(void 0,{ownerId:t});a=[],await Promise.all(l.map(async f=>{if(s){if(s.indexOf(f.structType)<0){let h=!this.useAuths;!f?.ownerId||f.ownerId===o._id?h=!0:this.useAuths&&(h=await this.checkAuthorization(o,f,"READ",r)),h&&a.push(f)}}else{let h=!this.useAuths;!f?.ownerId||f.ownerId===o._id?h=!0:this.useAuths&&(h=await this.checkAuthorization(o,f,"READ",r)),h&&a.push(f)}}))}return this.debug&&console.log("getAllData: user:",o,"input:",t,s,"output",a),a};deleteData=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;return this.mode.includes("mongo")?r=await this.deleteMongoData(i,t,s):(r=!1,await Promise.all(t.map(async o=>{let a=this.getLocalData(o),l=!this.useAuths;!a?.ownerId||a.ownerId===i._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(i,a,"WRITE",s)),l&&this.deleteLocalData(a),r=!0}))),this.debug&&console.log("deleteData: user:",i,"input:",t,"output",r),r};getUserGroups=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoGroups(i,t,s);else if(typeof s=="string")r=this.getLocalData("group",{_id:s});else{r=[];let o=this.getLocalData("group");t?o.forEach(a=>{Object.keys(a.users).includes(t)&&r.push(a)}):o.forEach(a=>{Object.keys(a.users).includes(S(i._id))&&r.push(a)})}return this.debug&&console.log("getGroups: user:",i,"input:",t,s,"output",r),r};deleteGroup=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoGroup(i,t,s);else{let o=this.getLocalData("group",t),a=!this.useAuths;o&&(!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s))),a&&(r=!0)}return this.debug&&console.log("deleteGroup: user:",i,"input:",t,"output",r),r};getAuthorizations=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.getMongoAuthorizations(r,t,s,i);else if(s){let a=this.getLocalData("authorization",{_id:s});a&&(o=[a])}else o=this.getLocalData("authorization",{ownerId:t});return this.debug&&console.log("getAuthorizations: user:",r,"input:",t,s,"output",o),o};deleteAuthorization=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoAuthorization(i,t,s);else{r=!0;let o=this.getLocalData("authorization",{_id:t});if(o){let a=!this.useAuths;!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s)),a&&(r=this.deleteLocalData(o))}}return this.debug&&console.log("deleteAuthorization: user:",i,"input:",t,"output",r),r};getToken=e=>this.useAccessTokens?this.accessTokens.get(e._id):this.useRefreshTokens?this.refreshTokens.get(e._id):void 0;notificationStruct=(e={})=>{let t="notification";return{structType:t,timestamp:Date.now(),_id:Xn(t),note:"",alert:!1,ownerId:"",parentUserId:"",parent:{structType:e?.structType,_id:S(e?._id)}}};checkToNotify=async(e,t=[],s=this.mode)=>{if(t.length===0)return!1;if(typeof e=="string")for(let o in this.users){let a=this.users[o];S(a._id)===e&&(e=a)}if(typeof e=="string"||e==null)return!1;let i={},r=[];if(t.forEach(async o=>{if(o?._id){if(o.ownerId&&e?._id!==o.ownerId){let a=this.notificationStruct(o);a._id="notification_"+S(o._id)+"_"+o.ownerId,a.ownerId=o.ownerId,a.note=o.structType,a.parentUserId=o.ownerId,o.alert&&(a.alert=o.alert),r.push(a),i[o.ownerId]=o.ownerId}if(o.users)Object.keys(o.users).forEach(a=>{if(a!==e._id){let l=this.notificationStruct(o);l._id="notification_"+S(o._id)+"_"+a,l.ownerId=a,l.note=o.structType,o.alert&&(l.alert=o.alert),l.parentUserId=o.ownerId,r.push(l),i[a]=a}});else{let a=[];if(s.includes("mongo")){let f=await this.collections.authorization.instance.find({$or:[{authorizedId:e._id},{authorizerId:e._id}]}).toArray();f.length>0&&f.forEach(h=>a.push(h))}else a=this.getLocalData("authorization",{authorizedId:e._id}),a.push(...this.getLocalData("authorization",{authorizerId:e._id}));a.length>0&&a.forEach(l=>{if(o.authorizerId===o.ownerId&&!i[o.authorizedId]&&l.status==="OKAY"&&l.authorizations.peer){let f=this.notificationStruct(o);f.ownerId=l.authorizedId,f._id="notification_"+S(o._id)+"_"+l.authorizedId,f.note=o.structType,f.parentUserId=o.ownerId,o.alert&&(f.alert=o.alert),r.push(f),i[f.ownerId]=f.ownerId}})}}}),r.length>0){s.includes("mongo")?await this.setMongoData(e,r,!0,this.getToken(e)):this.setLocalData(r);for(let o in i)this.users[o]?.sendAll({route:"structNotification",args:!0});return!0}else return!1};queryMongo=async(e,t,s={},i=!1,r=0,o)=>{if(!(!t&&!s))if(i){let a=await this.db.collection(t).findOne(s);if(!a)return;let l=!this.useAuths;return a?.ownerId?(S(e._id)!==a.ownerId||S(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",o)):l=!0,l?a:void 0}else{let a=this.db.collection(t).find(s).sort({$natural:-1}).skip(r),l=[],f=await a.toArray();if(f.length>0){let h=!this.useAuths,c="";for(let u of f)u?.ownerId?(S(e._id)!==u.ownerId||S(e._id)===u.ownerId&&e.userRoles?.admincontrol)&&c!==u.ownerId&&(this.useAuths&&(h=await this.checkAuthorization(e,u,"READ",o)),c=u.ownerId):h=!0,h&&l.push(u)}return l}};setMongoData=async(e,t=[],s=!0,i)=>{let r=!1;if(t.length>0){let o=!this.useAuths,a="";if(await Promise.all(t.map(async l=>{let f={};if(Array.isArray(l)&&(f=l[1],l=l[0]),!l?.ownerId||l.ownerId===e._id?o=!0:(S(e._id)!==l.ownerId||S(e._id)===l.ownerId&&e.userRoles?.admincontrol)&&a!==l.ownerId&&(this.useAuths&&(o=await this.checkAuthorization(e,l,"WRITE",i)),a=l.ownerId),o&&l.structType){this.collections[l.structType]||(this.collections[l.structType]={},this.collections[l.structType].reference={});let h=JSON.parse(JSON.stringify(l));h._id&&delete h._id,l._id?S(l._id).includes("defaultId")?(await this.db.collection(l.structType?l.structType:"data").insertOne(h),r=!0):l.structType==="notification"?await this.db.collection(l.structType?l.structType:"data").updateOne({_id:l._id},{$set:h,...f},{upsert:!0,unique:!1}):await this.db.collection(l.structType?l.structType:"data").updateOne({_id:D(l._id)},{$set:h,...f},{upsert:!0}):l.structType&&this.db.collection(l.structType?l.structType:"data").insertOne(h)}})),r===!0){let l=[];return await Promise.all(t.map(async(f,h)=>{let c=JSON.parse(JSON.stringify(f));if(c._id&&c.structType!=="profile"&&delete c._id,f.structType!=="comment"){let u;f.structType!=="notification"&&(u=await this.db.collection(c.structType).findOne(c)),u&&(u._id=S(u._id),l.push(u))}else if(f.structType==="comment"){let d=JSON.parse(JSON.stringify(f));d._id&&delete d._id;let g=await this.db.collection("comment").findOne(d),y=g?.replyTo,x=t.find(v=>{if(S(v._id)===y)return!0});if(x){let v=JSON.parse(JSON.stringify(x));v._id&&delete v._id;let A;if(await Promise.all(["discussion","chatroom","comment"].map(async b=>{let w=await this.db.collection(b).findOne({_id:D(y)});w&&(A=w)})),A){let b=S(g.parent._id),w,m;b!==y?(w=t.find(k=>{if(S(k._id)===b)return!0}),w&&(delete w._id,await Promise.all(["discussion","chatroom"].map(async k=>{let O=await this.db.collection(k).findOne(w);O&&(m=O)})))):m=A;let _=[g];A&&(A.replies.indexOf(S(g._id))<0&&(A.replies.push(S(g._id)),g.replyTo=S(A._id)),_.push(A)),m&&m.comments.indexOf(g._id)<0&&(m.comments.push(S(g._id)),g.parent._id=S(m._id)),await Promise.all(_.map(async k=>{let O=JSON.parse(JSON.stringify(k));delete O._id,await this.db.collection(k.structType).updateOne({_id:D(k._id)},{$set:O},{upsert:!1})})),[...l].reverse().forEach((k,O)=>{_.find(T=>{if(S(k._id)===S(T._id))return!0})&&l.splice(l.length-O-1,1)}),l.push(..._)}}else g&&l.push(g)}})),s&&this.checkToNotify(e,l),l}else{let l=[];return t.forEach(f=>{f.structType!=="notification"&&l.push(f)}),s&&this.checkToNotify(e,l),!0}}else return!1};setMongoUser=async(e,t,s)=>{if(t._id){let i=D(t._id),r={_id:i};if(await this.collections.profile.instance.findOne(r)&&(S(e._id)!==t.ownerId||S(e._id)===t.ownerId&&e.userRoles?.admincontrol)){let l=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(e,t,"WRITE",s)),!l)return!1}let a=JSON.parse(JSON.stringify(t));return a._id=i,this.debug&&console.log("RETURNS PROFILE",t),await this.collections.profile.instance.updateOne(r,{$set:a},{upsert:!0}),e=await this.collections.profile.instance.findOne(r),this.checkToNotify(e,[t]),e}else return!1};setGroup=async(e,t,s=this.mode,i)=>{if(t?._id){let r=S(e._id),o;if(s.includes("mongo")?o=await this.collections.group.instance.findOne({name:t.name}):o=this.getLocalData("group",{_id:S(t._id)}),o&&(o.ownerId!==t.ownerId||t.admins.indexOf(r)<0))return!1;if(r!==t.ownerId){let g=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?g=!0:this.useAuths&&(g=await this.checkAuthorization(e,t,"WRITE",i)),!g)return!1}let a=[];Object.keys(t.users).forEach(g=>{a.push({email:g},{id:g},{username:g})});let l={},f={};if(s.includes("mongo")){let y=this.collections.profile.instance.find({$or:a}).toArray();y.length>0&&y.forEach(x=>{l[r]=x,f[r]=!0})}else a.forEach(g=>{let y=this.getLocalData("profile",g);y.length>0&&(l[S(y[0]._id)]=y[0],f[S(y[0]._id)]=!0)});t.users=f;let h={},c={},u={};Object.keys(l).forEach(g=>{let y=l[g];(t.admins[S(y._id)]||t.admins[y.email]||t.admins[y.username]||t.admins[t.ownerId])&&(h[S(y._id)]||(h[S(y._id)]=!0)),(t.peers[S(y._id)]||t.peers[y.email]||t.peers[y.username]||t.peers[t.ownerId])&&(c[S(y._id)]||(c[S(y._id)]=!0)),(t.clients[S(y._id)]||t.clients[y.email]||t.clients[y.username]||t.clients[t.ownerId])&&(u[S(y._id)]||(u[S(y._id)]=!0))}),t.admins=h,t.peers=c,t.clients=u;let d=JSON.parse(JSON.stringify(t));return d._id&&delete d._id,s.includes("mongo")?S(t._id).includes("defaultId")?(await this.db.collection(t.structType?t.structType:"data").insertOne(d),delete t._id,t=await this.db.collection(t.structType?t.structType:"data").findOne(t),t._id=S(t._id)):await this.collections.group.instance.updateOne({_id:D(t._id)},{$set:d},{upsert:!0}):this.setLocalData(t),this.checkToNotify(e,[t],this.mode),this.debug&&console.log("setGroup: user:",e,"output",t),t}else return!1};getMongoUser=(e,t="",s=!0,i=!1,r)=>new Promise(async o=>{let a=[{email:t},{id:t},{username:t}];try{a.push({_id:D(t)})}catch{console.log("error creating ObjectId with ",t)}let l=await this.collections.profile.instance.findOne({$or:a});if(!l||l==null)o(void 0);else if(l._id=S(l._id),l.ownerId||(l.ownerId=l._id),i)(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),l={username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id},o({user:l});else if(s){if(S(e._id)!==l._id||S(e._id)===l._id&&e.userRoles?.admincontrol){let y=!this.useAuths;this.useAuths&&(y=await this.checkAuthorization(e,l,"READ",r)),y||o(void 0)}let f=[],h=this.collections.authorization.instance.find({ownerId:l._id}),c=await h.toArray();h.toArray().length>0&&c.forEach(y=>f.push(y));let d=await this.collections.group.instance.find({users:{$all:[l._id]}}).toArray(),g=[];d.length>0&&d.forEach(y=>g.push(y)),o({user:l,authorizations:f,groups:g})}else(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),o({user:l})});queryUsers=(e,t="",s=0,i=0,r=!1,o)=>(typeof e=="string"&&(e=this.users[e]),e?new Promise(async a=>{let l={$regex:`^${t}`,$options:"i"},f=[{email:l},{username:l},{firstName:l},{lastName:l},{name:l}],h;if(this.mode.includes("mongo")){let c=this.collections.profile.instance.find({$or:f},{projection:Pt}).skip(i);s>0&&c.limit(s),await c,h=await c.toArray(),console.log(h)}else{h=[];for(let c=0;c<f.length;c++){let u=this.getLocalData("profile",f[c]);Array.isArray(u)?u.forEach(d=>{h.push({firstName:d.firstName,lastName:d.lastName,fullName:d.fullName,username:d.username,pictureUrl:d.pictureUrl})}):u&&h.push({firstName:u.firstName,lastName:u.lastName,fullName:u.fullName,username:u.username,pictureUrl:u.pictureUrl})}}if(r){let c=[],u=S(e._id);for(let d=0;d<h.length;d++){let g=h[d];if(g._id=S(g._id),u!==g._id||u===g._id&&e.userRoles?.admincontrol){let y=!this.useAuths;this.useAuths&&(y=await this.checkAuthorization(e,g,"READ",o)),y&&c.push(g)}}h=c}else if(this.useAccessTokens||this.useRefreshTokens){let c=this.getToken(e);if(!c||c!==o){a(!1);return}}a(h)}):Promise.resolve(void 0));getMongoUsersByIds=async(e,t=[],s)=>{let i=[];t.forEach(o=>{try{i.push({_id:D(o)})}catch{}});let r=[];if(i.length>0){let a=await this.collections.profile.instance.find({$or:i}).toArray();a.length>0&&a.forEach(l=>{s?r.push({username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id}):r.push(l)})}return r};getMongoUsersByRole=async(e,t)=>{let s=this.collections.profile.instance.find({userRoles:{$all:{[t]:!0}}}),i=[],r=await s.toArray();return r.length>0&&r.forEach(o=>{i.push(o)}),i};getMongoDataByIds=async(e,t,s,i,r)=>{let o=S(e._id);if(t.length>0){let a=[];t.forEach(f=>{let h={_id:D(f)};s&&(h.ownerId=s),a.push(h)});let l=[];if(!i)await Promise.all(Object.keys(this.collections).map(async f=>{let c=await(await this.db.collection(f).find({$or:a})).toArray();if(c.length>0){let u=!0,d="";for(let g=0;g<c.length;g++){let y=c[g];y?.ownerId?(o!==y.ownerId||o===y.ownerId&&e.userRoles?.admincontrol)&&d!==y.ownerId&&(this.useAuths&&(u=await this.checkAuthorization(e,y,"READ",r)),d=y.ownerId):u=!0,u&&l.push(y)}}}));else{let h=await(await this.db.collection(i).find({$or:a})).toArray();if(h.length>0){let c=!0,u="";h.forEach(async d=>{d?.ownerId?(o!==d.ownerId||o===d.ownerId&&e.userRoles?.admincontrol)&&u!==d.ownerId&&(this.useAuths&&(c=await this.checkAuthorization(e,d,"READ",r)),u=d.ownerId):c=!0,c&&l.push(d)})}}return l}};getMongoData=async(e,t,s,i={},r=0,o=0,a)=>{s||(s=i?.ownerId),i||(i={}),i._id&&(i._id=D(i._id));let l=S(e._id),f=[],h=!0,c="",u;if(!t&&!s&&!i)return[];if(!t&&s&&Object.keys(i).length===0)return await this.getAllUserMongoData(e,s);if((!i||Object.keys(i).length===0)&&s&&t?u=this.db.collection(t).find({ownerId:s}).sort({$natural:-1}).skip(o):t&&Object.keys(i).length>0&&(s&&(i.ownerId=s),u=await this.db.collection(t).find(i).sort({$natural:-1}).skip(o)),u){r>0&&u.limit(r);let d=await u.toArray();if(d.length>0)for(let g=0;g<d.length;g++){let y=d[g];y?.ownerId?(l!==y.ownerId||l===y.ownerId&&e.userRoles?.admincontrol)&&c!==y.ownerId&&(this.useAuths&&(h=await this.checkAuthorization(e,y,"READ",a)),c=y.ownerId):h=!0,h===!0&&f.push(y)}}else!t&&Object.keys(i).length>0&&!s&&await Promise.all(Object.keys(this.collections).map(async d=>{if(u=await this.db.collection(d).find(i).sort({$natural:-1}).skip(o),u){r>0&&u.limit(r);let g=await u.toArray();if(g.length>0)for(let y=0;y<g.length;y++){let x=g[y];x?.ownerId?(l!==x.ownerId||l===x.ownerId&&e.userRoles?.admincontrol)&&c!==x.ownerId&&(this.useAuths&&(h=await this.checkAuthorization(e,x,"READ",a)),c=x.ownerId):h=!0,h===!0&&f.push(x)}}}));return h?f:[]};getAllUserMongoData=async(e,t,s=[],i,r)=>{let o=[],a=!0,l="";return await Promise.all(Object.keys(this.collections).map(async(f,h)=>{if(a&&s.indexOf(f)<0){let c={ownerId:t};i&&(typeof i[0]=="string"&&(i[0]=Z(i[0])),typeof i[1]=="string"&&(i[1]=Z(i[1])),c.timestamp={$gt:i[0],$lt:i[1]});let d=await this.db.collection(f).find(c).toArray(),g=d.length;for(let y=0;y<g;y++){let x=d[y];t?(S(e._id)!==t||S(e._id)===t&&e.userRoles?.admincontrol)&&l!==t&&(this.useAuths&&(a=await this.checkAuthorization(e,x,"READ",r)),l=t):a=!0,a&&o.push(x)}}})),a?o:[]};getMongoDataByRefs=async(e,t=[],s)=>{let i=[];if(i.length>0){let r="";t.forEach(async o=>{if(o.structType&&S(o._id)){let a=await this.db.collection(o.structType).findOne({_id:D(o._id)});if(a){let l=!0;!a?.ownerId||a.ownerId===e._id?l=!0:(S(e._id)!==a.ownerId||S(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&r!==a.ownerId&&(this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",s)),r=a.ownerId),l===!0&&i.push(a)}}})}return i};getMongoAuthorizations=async(e,t=S(e._id),s="",i)=>{let r=[];if(s.length===0){let a=await this.collections.authorization.instance.find({ownerId:t}).toArray();a.length>0&&a.forEach(l=>{r.push(l)})}else r.push(await this.collections.authorization.instance.findOne({_id:D(s),ownerId:t}));if(r[0]?.ownerId){if(S(e._id)!==r[0]?.ownerId){let o=!this.useAuths;if(this.useAuths&&(o=await this.checkAuthorization(e,r[0],"READ",i)),!o)return}}return r};getMongoGroups=async(e,t=S(e._id),s="")=>{let i=[];if(s.length===0){let o=await this.collections.group.instance.find({users:{$all:[t]}}).toArray();o.length>0&&o.forEach(a=>{i.push(a)})}else try{i.push(await this.collections.group.instance.findOne({_id:D(s),users:{$all:[t]}}))}catch{}return i};deleteMongoData=async(e,t=[],s)=>{let i=[];await Promise.all(t.map(async o=>{try{let a=D(o._id),l=await this.db.collection(o.structType).findOne({_id:a});if(l){i.push(l);let f=await this.collections.notifications.instance.find({parent:{structType:o.structType,_id:S(o._id)}}),h=f.toArray().length;for(let c=0;c<h;c++){let u=await f.next();u&&i.push(u)}}}catch{}}));let r="";return await Promise.all(i.map(async(o,a)=>{let l=!0;!o?.ownerId||o.ownerId===e._id?l=!0:(o.ownerId!==S(e._id)||S(e._id)===o.ownerId&&e.userRoles?.admincontrol)&&o.ownerId!==r&&(r=o.ownerId,this.useAuths&&(l=await this.checkAuthorization(e,o,"WRITE",s))),l&&(await this.db.collection(o.structType?o.structType:"data").deleteOne({_id:D(o._id)}),o.users&&Object.keys(o.users).forEach(f=>{f!==S(e._id)&&f!==o.ownerId&&this.users[f]&&this.users[f]?.sendAll({route:"structDeleted",args:{_id:S(o._id),structType:o.structType}})}),o.ownerId!==e._id&&this.users[o.ownerId]&&this.users[o.ownerId]?.sendAll({route:"structDeleted",args:{_id:S(o._id),structType:o.structType}}))})),!0};deleteMongoUser=async(e,t,s,i)=>{if(S(e._id)!==t||S(e._id)===t&&e.userRoles?.admincontrol){let r=await this.collections.profile.instance.findOne({id:t}),o=!this.useAuths;if(r?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,r,"WRITE",i)):o=!0,!o)return!1}if(await this.collections.profile.instance.deleteOne({id:t}),s)for(let r in this.collections)this.collections[r].instance.deleteMany({ownerId:t}),this.collections[r].instance.updateMany({users:{[t]:!0}},{$unset:{[`users.${t}`]:""}});return S(e._id)!==t&&this.users[t]&&this.users[t]?.sendAll({route:"structDeleted",args:{_id:t,structType:"profile"}}),!0};deleteMongoGroup=async(e,t,s)=>{let i=await this.collections.group.instance.findOne({_id:D(t)});if(i){if(i?.ownerId){if(S(e._id)!==i.ownerId||S(e._id)===i.ownerId&&e.userRoles?.admincontrol){let r=!this.useAuths;if(this.useAuths&&(r=await this.checkAuthorization(e,i,"WRITE",s)),!r)return!1}}return i.users&&Object.keys(i.users).forEach(r=>{this.users[r]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}})}),await this.collections.group.instance.deleteOne({_id:D(t)}),!0}else return!1};deleteMongoAuthorization=async(e,t,s)=>{let i=await this.collections.authorization.instance.findOne({_id:D(t)}),r=S(e._id);if(i){if(r!==i.ownerId||r===i.ownerId&&e.userRoles?.admincontrol){let o=!this.useAuths;if(i?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,i,"WRITE",s)):o=!0,!o)return!1}return i.associatedAuthId&&(this.debug&&console.log(i),await this.collections.authorization.instance.deleteOne({_id:D(i.associatedAuthId)}),i.authorizerId!==r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:S(i.associatedAuthId),structType:i.structType}}):i.authorizedId!==r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:S(i.associatedAuthId),structType:i.structType}})),await this.collections.authorization.instance.deleteOne({_id:D(t)}),i.authorizerId===r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}}):i.authorizedId===r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}}),!0}else return!1};setAuthorization=async(e,t,s)=>{let i,r,o=this.mode.includes("mongo");if(o?(i=(await this.getMongoUser(e,t.authorizedId,!1)).user,r=(await this.getMongoUser(e,t.authorizerId,!1)).user):(i=this.getLocalData("profile",{_id:t.authorizedId})?.[0],r=this.getLocalData("profile",{_id:t.authorizerId})?.[0]),!i||!r)return!1;if(t.authorizedId!==S(i._id)&&(t.authorizedId=S(i._id)),t.authorizerId!==S(r._id)&&(t.authorizerId=S(r._id)),t.authorizedName||(i.name?t.authorizedName=i.name:i.username?t.authorizedName=i.username:i.email&&(t.authorizedName=i.email)),t.authorizerName||(i.name?t.authorizedName=i.name:r.username?t.authorizerName=r.username:r.email&&(t.authorizerName=r.email)),t?.ownerId){if((S(e._id)!==t.ownerId||S(e._id)===t.ownerId&&e.userRoles?.admincontrol)&&S(e._id)!==t.authorizedId&&S(e._id)!==t.authorizerId){let h=!this.useAuths;if(this.useAuths&&(h=await this.checkAuthorization(e,t,"WRITE",s)),!h)return!1}}let a=[];if(o){let c=await(await this.collections.authorization.instance.find({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId}]})).toArray();c.length>0&&c.forEach(u=>a.push(u))}else{let h=this.getLocalData("authorization",{authorizedId:t.authorizedId});Array.isArray(h)&&h.forEach(c=>{c.authorizerId===t.authorizerId&&a.push(c)})}let l;if(Array.isArray(a))for(let h=0;h<a.length;h++){let c=a[h];if(c.ownerId!==S(e._id)){t.authorizerId===S(e._id)?(c.authorizations=t.authorizations,c.structs=t.structs,c.excluded=t.excluded,c.expires=t.expires,c.status="OKAY",t.status="OKAY"):(t.authorizations=c.authorizations,t.structs=c.structs,t.excluded=c.excluded,t.expires=c.expires,c.status="OKAY",t.status="OKAY"),t.associatedAuthId=S(c._id),c.associatedAuthId=S(t._id),l=c;let u=JSON.parse(JSON.stringify(c));o?(delete u._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:c.ownerId}]},{$set:u},{upsert:!0})):this.setLocalData(u)}}let f=JSON.parse(JSON.stringify(t));if(o?(delete f._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:t.ownerId}]},{$set:f},{upsert:!0})):this.setLocalData(f),S(t._id).includes("defaultId")&&o){let h=await this.collections.authorization.instance.findOne(f);if(h&&(t._id=S(h._id),l)){let c=await this.collections.authorization.instance.findOne({$and:[{authorizedId:l.authorizedId},{authorizerId:l.authorizerId},{ownerId:l.ownerId}]});if(c){c.associatedAuthId=S(t._id);let u=JSON.parse(JSON.stringify(c));delete u._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:c.authorizedId},{authorizerId:c.authorizerId},{ownerId:c.ownerId}]},{$set:u},{upsert:!0}),this.checkToNotify(e,[c])}}}return t};checkAuthorization=async(e,t,s="READ",i)=>{if(typeof e=="string"&&(this.users[e]?e=this.users[e]:e={_id:e}),!e||!t)return!1;if(!t.ownerId)return!0;if(typeof e=="object"&&t.ownerId===S(e._id))return e.userRoles?.admincontrol,!0;if(this.useAccessTokens){if(!this.accessTokens.get(e._id)||this.accessTokens.get(e._id)!==i)return!1}else if(this.useRefreshTokens&&(!this.refreshTokens.get(e._id)||this.refreshTokens.get(e._id)!==i))return!1;let r,o;if(this.mode.includes("mongo")){if(r=await this.collections.authorization.instance.findOne({$or:[{authorizedId:S(e._id),authorizerId:t.ownerId,ownerId:S(e._id)},{authorizedId:t.ownerId,authorizerId:S(e._id),ownerId:S(e._id)}]}),!r)return!1;o=await this.collections.authorization.instance.findOne({$or:[{authorizedId:S(e._id),authorizerId:t.ownerId,ownerId:S(t.ownerId)},{authorizedId:t.ownerId,authorizerId:S(e._id),ownerId:S(t.ownerId)}]})}else r=this.getLocalData("authorization",{ownerId:S(e._id)}).find(l=>{if(l.authorizedId===S(e._id)&&l.authorizerId===t.ownerId)return!0}),o=this.getLocalData("authorization",{ownerId:t.ownerId}).find(l=>{if(l.authorizedId===S(e._id)&&l.authorizerId===t.ownerId)return!0});if(!r||!o)return!1;let a=!1;return r.status==="OKAY"&&o.status==="OKAY"&&(t.structType==="group"?r.authorizations[t.name+"_admin"]&&o.authorizations[t.name+"_admin"]&&(a=!0):r.authorizations.peer&&o.authorizations.peer||r.authorizations.admincontrol&&o.authorizations.admincontrol||r.structIds[S(t._id)]&&o.structIds[S(t._id)]?a=!0:r.excluded[t.structType]&&t.ownerId===S(e._id)&&s==="WRITE"&&(a=!1)),a};wipeDB=async()=>(await Promise.all(Object.values(this.collections).map(e=>{try{e.instance.remove({})}catch{}})),!0);overwriteLocalData=e=>{if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:S(t._id)});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:S(e._id)});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}};setLocalData=e=>{let t=s=>{let i=s.structType,r=this.collections[i]?.reference;r||(r={},this.collections[i]||(this.collections[i]={}),this.collections[i].reference=r),r[S(s._id)]=s};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)};getLocalData=(e,t)=>{let s,i,r;if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return Object.values(this.collections).forEach(a=>{if(a=a.reference,(i==="_id"||i==="id")&&r){let l=a[r];l&&o.push(l)}else Object.values(a).forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections[e]?.reference;if(!a)return o;if(!i&&!s)return Object.values(a).forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return S(a[r]);Object.keys(a).forEach(l=>{let f=a[l];i&&r&&!s?f[i]===r&&o.push(f):s&&!i?f.ownerId===s&&o.push(f):s&&i&&r&&f.ownerId===s&&f[i]&&f[i]===r&&o.push(f)})}return o};deleteLocalData=e=>{if(!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.collections[e.structType]&&delete this.collections[e.structType].reference[e._id],!0)}},Pt=F.ProfileStruct();for(let n in Pt)n==="username"||n==="lastName"||n==="firstName"||n==="name"||n==="_id"||n==="pictureUrl"?Pt[n]=1:delete Pt[n];0&&(module.exports={AuthorizationStruct,CMDService,Callable,ChatroomStruct,CircularBuffer,CoherenceMap,CoherenceStruct,CommentStruct,DS,Data,DataStruct,DataTablet,DateStruct,DelayBuffer,DelayBufferManager,E2EEService,ECGStruct,EDAStruct,EEGCoordinates,EEGStruct,EMGStruct,EventHandler,EventStruct,EyeTrackerStruct,FNIRSStruct,FrequencyBandsStruct,Graph,GraphNode,GroupStruct,HRVStruct,HTTPbackend,IMUStruct,InputBuffer,NotificationStruct,PPGStruct,ProfileStruct,Router,SSEbackend,ScheduleStruct,Service,SessionManager,SessionService,Struct,StructBackend,StructFrontend,WSSbackend,animate,backprop,bindListener,branching,connectionHasId,defaultCollections,defaultManifest,defaultServiceWorker,defaultSpecifiers,eegCoordinates,genTimeSpecifiers,genTimestampFromString,getAllProperties,getCallbackFromString,getFnParamNames,getFunctionHead,getStringId,htmlBodyBoilerPlate,instanceObject,isFunction,isNativeClass,isTypedArray,loaders,loop,methodstrings,parseFunctionFromText,pseudoObjectId,randomId,reconstructObject,recursivelyAssign,recursivelyStringifyFunctions,scriptBoilerPlate,setCoordinate,spliceTypedArray,state,stringifyFast,stringifyWithCircularRefs,stringifyWithFunctionsAndCircularRefs,structRegistry,substitute__operator,toObjectId,transformListenerResult,triggerListenerOncreate,wrapArgs});
