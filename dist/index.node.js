var qi=Object.create;var dt=Object.defineProperty;var $i=Object.getOwnPropertyDescriptor;var Wi=Object.getOwnPropertyNames;var Ji=Object.getPrototypeOf,Hi=Object.prototype.hasOwnProperty;var te=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Zs=(n,e)=>{for(var t in e)dt(n,t,{get:e[t],enumerable:!0})},Xs=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Wi(e))!Hi.call(n,r)&&r!==t&&dt(n,r,{get:()=>e[r],enumerable:!(s=$i(e,r))||s.enumerable});return n};var fe=(n,e,t)=>(t=n!=null?qi(Ji(n)):{},Xs(e||!n||!n.__esModule?dt(t,"default",{value:n,enumerable:!0}):t,n)),Vi=n=>Xs(dt({},"__esModule",{value:!0}),n);var kr=te((Et,as)=>{(function(n,e){if(typeof Et=="object"&&typeof as=="object")as.exports=e();else if(typeof define=="function"&&define.amd)define([],e);else{var t=e();for(var s in t)(typeof Et=="object"?Et:n)[s]=t[s]}})(global,()=>(()=>{"use strict";var n={n:C=>{var N=C&&C.__esModule?()=>C.default:()=>C;return n.d(N,{a:N}),N},d:(C,N)=>{for(var U in N)n.o(N,U)&&!n.o(C,U)&&Object.defineProperty(C,U,{enumerable:!0,get:N[U]})},o:(C,N)=>Object.prototype.hasOwnProperty.call(C,N),r:C=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(C,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(C,"__esModule",{value:!0})}},e={};n.r(e),n.d(e,{Channel:()=>B,EventBuffer:()=>g,Session:()=>F,SseError:()=>j,createChannel:()=>I,createEventBuffer:()=>L,createSession:()=>D});let t=require("http"),s=C=>JSON.stringify(C),r=/(\r\n|\r|\n)/g,i=/\n+$/g,o=C=>{let N=C;return N=N.replace(r,`
`),N=N.replace(i,""),N},l=require("crypto"),c;c=l.randomUUID?()=>(0,l.randomUUID)():()=>(0,l.randomBytes)(4).toString("hex");let u=C=>async(N,U={})=>{let{eventName:G="stream"}=U;return await new Promise((q,V)=>{N.on("data",X=>{let le;le=Buffer.isBuffer(X)?X.toString():X,C(le,G)}),N.once("end",()=>q(!0)),N.once("close",()=>q(!0)),N.once("error",X=>V(X))})},p=C=>async(N,U={})=>{let{eventName:G="iteration"}=U;for await(let q of N)C(q,G)};class g{constructor(N={}){var U,G;this.buffer="",this.writeField=(q,V)=>{let X=this.sanitize(V);return this.buffer+=q+":"+X+`
`,this},this.data=q=>{let V=this.serialize(q);return this.writeField("data",V),this},this.id=(q="")=>(this.writeField("id",q),this),this.retry=q=>{let V=q.toString();return this.writeField("retry",V),this},this.comment=(q="")=>(this.writeField("",q),this),this.dispatch=()=>(this.buffer+=`
`,this),this.push=(q,V="message",X=c())=>(this.event(V).id(X).data(q).dispatch(),this),this.stream=u(this.push),this.iterate=p(this.push),this.clear=()=>(this.buffer="",this),this.read=()=>this.buffer,this.serialize=(U=N.serializer)!==null&&U!==void 0?U:s,this.sanitize=(G=N.sanitizer)!==null&&G!==void 0?G:o}event(N){return this.writeField("event",N),this}}let v=require("events");var w=n.n(v);class A extends w(){addListener(N,U){return super.addListener(N,U)}prependListener(N,U){return super.prependListener(N,U)}prependOnceListener(N,U){return super.prependOnceListener(N,U)}on(N,U){return super.on(N,U)}once(N,U){return super.once(N,U)}emit(N,...U){return super.emit(N,...U)}off(N,U){return super.off(N,U)}removeListener(N,U){return super.removeListener(N,U)}}class j extends Error{constructor(N){super(N),this.message=`better-sse: ${N}`}}class F extends A{constructor(N,U,G={}){var q,V,X,le,Pe,Te,ze;super(),this.lastId="",this.isConnected=!1,this.state={},this.initialize=()=>{var J,ne,f;let a=`http://${this.req.headers.host}${this.req.url}`,h=new URL(a).searchParams;if(this.trustClientEventId){let _=(f=(ne=(J=this.req.headers["last-event-id"])!==null&&J!==void 0?J:h.get("lastEventId"))!==null&&ne!==void 0?ne:h.get("evs_last_event_id"))!==null&&f!==void 0?f:"";this.lastId=_}let d={};this.res instanceof t.ServerResponse?(d["Content-Type"]="text/event-stream",d["Cache-Control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",d.Connection="keep-alive",d.Pragma="no-cache",d["X-Accel-Buffering"]="no"):(d["content-type"]="text/event-stream",d["cache-control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",d.pragma="no-cache",d["x-accel-buffering"]="no");for(let[_,y]of Object.entries(this.headers))d[_]=y??"";this.res.writeHead(this.statusCode,d),h.has("padding")&&this.buffer.comment(" ".repeat(2049)).dispatch(),h.has("evs_preamble")&&this.buffer.comment(" ".repeat(2056)).dispatch(),this.initialRetry!==null&&this.buffer.retry(this.initialRetry).dispatch(),this.flush(),this.keepAliveInterval!==null&&(this.keepAliveTimer=setInterval(this.keepAlive,this.keepAliveInterval)),this.isConnected=!0,this.emit("connected")},this.onDisconnected=()=>{this.req.removeListener("close",this.onDisconnected),this.res.removeListener("close",this.onDisconnected),this.keepAliveTimer&&clearInterval(this.keepAliveTimer),this.isConnected=!1,this.emit("disconnected")},this.keepAlive=()=>{this.buffer.comment().dispatch(),this.flush()},this.data=J=>(this.buffer.data(J),this),this.id=(J="")=>(this.buffer.id(J),this.lastId=J,this),this.retry=J=>(this.buffer.retry(J),this),this.comment=J=>(this.buffer.comment(J),this),this.dispatch=()=>(this.buffer.dispatch(),this),this.flush=()=>(this.res.write(this.buffer.read()),this.buffer.clear(),this),this.push=(J,ne="message",f=c())=>{if(!this.isConnected)throw new j("Cannot push data to a non-active session.");return this.buffer.push(J,ne,f),this.flush(),this.lastId=f,this.emit("push",J,ne,f),this},this.stream=u(this.push),this.iterate=p(this.push),this.batch=async J=>{if(J instanceof g)this.res.write(J.read());else{let ne=new g({serializer:this.serialize,sanitizer:this.sanitize});await J(ne),this.res.write(ne.read())}},this.req=N,this.res=U;let ut=(q=G.serializer)!==null&&q!==void 0?q:s,Ie=(V=G.sanitizer)!==null&&V!==void 0?V:o;this.serialize=ut,this.sanitize=Ie,this.buffer=new g({serializer:ut,sanitizer:Ie}),this.trustClientEventId=(X=G.trustClientEventId)===null||X===void 0||X,this.initialRetry=G.retry===null?null:(le=G.retry)!==null&&le!==void 0?le:2e3,this.keepAliveInterval=G.keepAlive===null?null:(Pe=G.keepAlive)!==null&&Pe!==void 0?Pe:1e4,this.statusCode=(Te=G.statusCode)!==null&&Te!==void 0?Te:200,this.headers=(ze=G.headers)!==null&&ze!==void 0?ze:{},this.req.once("close",this.onDisconnected),this.res.once("close",this.onDisconnected),setImmediate(this.initialize)}event(N){return this.buffer.event(N),this}}let D=(...C)=>new Promise(N=>{let U=new F(...C);U.once("connected",()=>{N(U)})});class B extends A{constructor(){super(),this.state={},this.sessions=new Set,this.broadcast=(N,U="message",G={})=>{var q;let V=(q=G.eventId)!==null&&q!==void 0?q:c(),X=G.filter?this.activeSessions.filter(G.filter):this.sessions;for(let le of X)le.push(N,U,V);return this.emit("broadcast",N,U,V),this}}get activeSessions(){return Array.from(this.sessions)}get sessionCount(){return this.sessions.size}register(N){if(this.sessions.has(N))return this;if(!N.isConnected)throw new j("Cannot register a non-active session.");return N.once("disconnected",()=>{this.emit("session-disconnected",N),this.deregister(N)}),this.sessions.add(N),this.emit("session-registered",N),this}deregister(N){return this.sessions.has(N)?(this.sessions.delete(N),this.emit("session-deregistered",N),this):this}}let I=(...C)=>new B(...C),L=(...C)=>new g(...C);return e})())});var Tr=te((Ia,Pr)=>{"use strict";var{Duplex:sn}=require("stream");function xr(n){n.emit("close")}function rn(){!this.destroyed&&this._writableState.finished&&this.destroy()}function Ar(n){this.removeListener("error",Ar),this.destroy(),this.listenerCount("error")===0&&this.emit("error",n)}function nn(n,e){let t=!0,s=new sn({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return n.on("message",function(i,o){let l=!o&&s._readableState.objectMode?i.toString():i;s.push(l)||n.pause()}),n.once("error",function(i){s.destroyed||(t=!1,s.destroy(i))}),n.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(r,i){if(n.readyState===n.CLOSED){i(r),process.nextTick(xr,s);return}let o=!1;n.once("error",function(c){o=!0,i(c)}),n.once("close",function(){o||i(r),process.nextTick(xr,s)}),t&&n.terminate()},s._final=function(r){if(n.readyState===n.CONNECTING){n.once("open",function(){s._final(r)});return}n._socket!==null&&(n._socket._writableState.finished?(r(),s._readableState.endEmitted&&s.destroy()):(n._socket.once("finish",function(){r()}),n.close()))},s._read=function(){n.isPaused&&n.resume()},s._write=function(r,i,o){if(n.readyState===n.CONNECTING){n.once("open",function(){s._write(r,i,o)});return}n.send(r,o)},s.on("end",rn),s.on("error",Ar),s}Pr.exports=nn});var Se=te((Da,Er)=>{"use strict";Er.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Ze=te((La,Nt)=>{"use strict";var{EMPTY_BUFFER:on}=Se(),cs=Buffer[Symbol.species];function an(n,e){if(n.length===0)return on;if(n.length===1)return n[0];let t=Buffer.allocUnsafe(e),s=0;for(let r=0;r<n.length;r++){let i=n[r];t.set(i,s),s+=i.length}return s<e?new cs(t.buffer,t.byteOffset,s):t}function jr(n,e,t,s,r){for(let i=0;i<r;i++)t[s+i]=n[i]^e[i&3]}function Nr(n,e){for(let t=0;t<n.length;t++)n[t]^=e[t&3]}function ln(n){return n.length===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.length)}function fs(n){if(fs.readOnly=!0,Buffer.isBuffer(n))return n;let e;return n instanceof ArrayBuffer?e=new cs(n):ArrayBuffer.isView(n)?e=new cs(n.buffer,n.byteOffset,n.byteLength):(e=Buffer.from(n),fs.readOnly=!1),e}Nt.exports={concat:an,mask:jr,toArrayBuffer:ln,toBuffer:fs,unmask:Nr};if(!process.env.WS_NO_BUFFER_UTIL)try{let n=require("bufferutil");Nt.exports.mask=function(e,t,s,r,i){i<48?jr(e,t,s,r,i):n.mask(e,t,s,r,i)},Nt.exports.unmask=function(e,t){e.length<32?Nr(e,t):n.unmask(e,t)}}catch{}});var Dr=te((Ma,Ir)=>{"use strict";var Cr=Symbol("kDone"),hs=Symbol("kRun"),us=class{constructor(e){this[Cr]=()=>{this.pending--,this[hs]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[hs]()}[hs](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[Cr])}}};Ir.exports=us});var et=te((Ua,Rr)=>{"use strict";var Xe=require("zlib"),Lr=Ze(),cn=Dr(),{kStatusCode:Mr}=Se(),fn=Buffer[Symbol.species],hn=Buffer.from([0,0,255,255]),Dt=Symbol("permessage-deflate"),ye=Symbol("total-length"),Qe=Symbol("callback"),we=Symbol("buffers"),It=Symbol("error"),Ct,ds=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!Ct){let r=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;Ct=new cn(r)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[Qe];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(r=>!(t.serverNoContextTakeover===!1&&r.server_no_context_takeover||r.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>r.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!r.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let r=t[s];if(r.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(r=r[0],s==="client_max_window_bits"){if(r!==!0){let i=+r;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${r}`);r=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${r}`)}else if(s==="server_max_window_bits"){let i=+r;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${s}": ${r}`);r=i}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(r!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${r}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=r})}),e}decompress(e,t,s){Ct.add(r=>{this._decompress(e,t,(i,o)=>{r(),s(i,o)})})}compress(e,t,s){Ct.add(r=>{this._compress(e,t,(i,o)=>{r(),s(i,o)})})}_decompress(e,t,s){let r=this._isServer?"client":"server";if(!this._inflate){let i=`${r}_max_window_bits`,o=typeof this.params[i]!="number"?Xe.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=Xe.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[Dt]=this,this._inflate[ye]=0,this._inflate[we]=[],this._inflate.on("error",dn),this._inflate.on("data",Ur)}this._inflate[Qe]=s,this._inflate.write(e),t&&this._inflate.write(hn),this._inflate.flush(()=>{let i=this._inflate[It];if(i){this._inflate.close(),this._inflate=null,s(i);return}let o=Lr.concat(this._inflate[we],this._inflate[ye]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[ye]=0,this._inflate[we]=[],t&&this.params[`${r}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let r=this._isServer?"server":"client";if(!this._deflate){let i=`${r}_max_window_bits`,o=typeof this.params[i]!="number"?Xe.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=Xe.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[ye]=0,this._deflate[we]=[],this._deflate.on("data",un)}this._deflate[Qe]=s,this._deflate.write(e),this._deflate.flush(Xe.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=Lr.concat(this._deflate[we],this._deflate[ye]);t&&(i=new fn(i.buffer,i.byteOffset,i.length-4)),this._deflate[Qe]=null,this._deflate[ye]=0,this._deflate[we]=[],t&&this.params[`${r}_no_context_takeover`]&&this._deflate.reset(),s(null,i)})}};Rr.exports=ds;function un(n){this[we].push(n),this[ye]+=n.length}function Ur(n){if(this[ye]+=n.length,this[Dt]._maxPayload<1||this[ye]<=this[Dt]._maxPayload){this[we].push(n);return}this[It]=new RangeError("Max payload size exceeded"),this[It].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[It][Mr]=1009,this.removeListener("data",Ur),this.reset()}function dn(n){this[Dt]._inflate=null,n[Mr]=1007,this[Qe](n)}});var tt=te((Ra,Lt)=>{"use strict";var{isUtf8:Fr}=require("buffer"),_n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function gn(n){return n>=1e3&&n<=1014&&n!==1004&&n!==1005&&n!==1006||n>=3e3&&n<=4999}function _s(n){let e=n.length,t=0;for(;t<e;)if(!(n[t]&128))t++;else if((n[t]&224)===192){if(t+1===e||(n[t+1]&192)!==128||(n[t]&254)===192)return!1;t+=2}else if((n[t]&240)===224){if(t+2>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||n[t]===224&&(n[t+1]&224)===128||n[t]===237&&(n[t+1]&224)===160)return!1;t+=3}else if((n[t]&248)===240){if(t+3>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||(n[t+3]&192)!==128||n[t]===240&&(n[t+1]&240)===128||n[t]===244&&n[t+1]>143||n[t]>244)return!1;t+=4}else return!1;return!0}Lt.exports={isValidStatusCode:gn,isValidUTF8:_s,tokenChars:_n};if(Fr)Lt.exports.isValidUTF8=function(n){return n.length<24?_s(n):Fr(n)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let n=require("utf-8-validate");Lt.exports.isValidUTF8=function(e){return e.length<32?_s(e):n(e)}}catch{}});var bs=te((Fa,Jr)=>{"use strict";var{Writable:pn}=require("stream"),zr=et(),{BINARY_TYPES:yn,EMPTY_BUFFER:Br,kStatusCode:mn,kWebSocket:bn}=Se(),{concat:gs,toArrayBuffer:vn,unmask:Sn}=Ze(),{isValidStatusCode:wn,isValidUTF8:Gr}=tt(),Mt=Buffer[Symbol.species],ce=0,qr=1,$r=2,Wr=3,ps=4,ys=5,Ut=6,ms=class extends pn{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||yn[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[bn]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=ce}_write(e,t,s){if(this._opcode===8&&this._state==ce)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new Mt(s.buffer,s.byteOffset+e,s.length-e),new Mt(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],r=t.length-e;e>=s.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),r),this._buffers[0]=new Mt(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case ce:this.getInfo(e);break;case qr:this.getPayloadLength16(e);break;case $r:this.getPayloadLength64(e);break;case Wr:this.getMask();break;case ps:this.getData(e);break;case ys:case Ut:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48){let r=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(r);return}let s=(t[0]&64)===64;if(s&&!this._extensions[zr.extensionName]){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(!this._fragmented){let r=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let r=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let r=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(r);return}if(s){let r=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(r);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let r=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(r);return}}else{let r=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(r);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let r=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(r);return}}else if(this._masked){let r=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(r);return}this._payloadLength===126?this._state=qr:this._payloadLength===127?this._state=$r:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let r=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(r);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=Wr:this._state=ps}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=ps}getData(e){let t=Br;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Sn(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=ys,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[zr.extensionName].decompress(e,this._fin,(r,i)=>{if(r)return t(r);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(i)}this.dataMessage(t),this._state===ce&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=ce;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let r;this._binaryType==="nodebuffer"?r=gs(s,t):this._binaryType==="arraybuffer"?r=vn(gs(s,t)):r=s,this._allowSynchronousEvents?(this.emit("message",r,!0),this._state=ce):(this._state=Ut,setImmediate(()=>{this.emit("message",r,!0),this._state=ce,this.startLoop(e)}))}else{let r=gs(s,t);if(!this._skipUTF8Validation&&!Gr(r)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(i);return}this._state===ys||this._allowSynchronousEvents?(this.emit("message",r,!1),this._state=ce):(this._state=Ut,setImmediate(()=>{this.emit("message",r,!1),this._state=ce,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,Br),this.end();else{let s=e.readUInt16BE(0);if(!wn(s)){let i=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(i);return}let r=new Mt(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!Gr(r)){let i=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(i);return}this._loop=!1,this.emit("conclude",s,r),this.end()}this._state=ce;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=ce):(this._state=Ut,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=ce,this.startLoop(t)}))}createError(e,t,s,r,i){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=i,o[mn]=r,o}};Jr.exports=ms});var Ss=te((Ba,Yr)=>{"use strict";var{Duplex:za}=require("stream"),{randomFillSync:On}=require("crypto"),Hr=et(),{EMPTY_BUFFER:kn}=Se(),{isValidStatusCode:xn}=tt(),{mask:Vr,toBuffer:Me}=Ze(),de=Symbol("kByteLength"),An=Buffer.alloc(4),Rt=8*1024,Ee,Ue=Rt,vs=class n{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let s,r=!1,i=2,o=!1;t.mask&&(s=t.maskBuffer||An,t.generateMask?t.generateMask(s):(Ue===Rt&&(Ee===void 0&&(Ee=Buffer.alloc(Rt)),On(Ee,0,Rt),Ue=0),s[0]=Ee[Ue++],s[1]=Ee[Ue++],s[2]=Ee[Ue++],s[3]=Ee[Ue++]),o=(s[0]|s[1]|s[2]|s[3])===0,i=6);let l;typeof e=="string"?(!t.mask||o)&&t[de]!==void 0?l=t[de]:(e=Buffer.from(e),l=e.length):(l=e.length,r=t.mask&&t.readOnly&&!o);let c=l;l>=65536?(i+=8,c=127):l>125&&(i+=2,c=126);let u=Buffer.allocUnsafe(r?l+i:i);return u[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(u[0]|=64),u[1]=c,c===126?u.writeUInt16BE(l,2):c===127&&(u[2]=u[3]=0,u.writeUIntBE(l,4,6)),t.mask?(u[1]|=128,u[i-4]=s[0],u[i-3]=s[1],u[i-2]=s[2],u[i-1]=s[3],o?[u,e]:r?(Vr(e,s,u,i,l),[u]):(Vr(e,s,e,0,l),[u,e])):[u,e]}close(e,t,s,r){let i;if(e===void 0)i=kn;else{if(typeof e!="number"||!xn(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let l=Buffer.byteLength(t);if(l>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+l),i.writeUInt16BE(e,0),typeof t=="string"?i.write(t,2):i.set(t,2)}}let o={[de]:i.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,i,!1,o,r]):this.sendFrame(n.frame(i,o),r)}ping(e,t,s){let r,i;if(typeof e=="string"?(r=Buffer.byteLength(e),i=!1):(e=Me(e),r=e.length,i=Me.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[de]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}pong(e,t,s){let r,i;if(typeof e=="string"?(r=Buffer.byteLength(e),i=!1):(e=Me(e),r=e.length,i=Me.readOnly),r>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[de]:r,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:i,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}send(e,t,s){let r=this._extensions[Hr.extensionName],i=t.binary?2:1,o=t.compress,l,c;if(typeof e=="string"?(l=Buffer.byteLength(e),c=!1):(e=Me(e),l=e.length,c=Me.readOnly),this._firstFragment?(this._firstFragment=!1,o&&r&&r.params[r._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=l>=r._threshold),this._compress=o):(o=!1,i=0),t.fin&&(this._firstFragment=!0),r){let u={[de]:l,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:c,rsv1:o};this._deflating?this.enqueue([this.dispatch,e,this._compress,u,s]):this.dispatch(e,this._compress,u,s)}else this.sendFrame(n.frame(e,{[de]:l,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:i,readOnly:c,rsv1:!1}),s)}dispatch(e,t,s,r){if(!t){this.sendFrame(n.frame(e,s),r);return}let i=this._extensions[Hr.extensionName];this._bufferedBytes+=s[de],this._deflating=!0,i.compress(e,s.fin,(o,l)=>{if(this._socket.destroyed){let c=new Error("The socket was closed while data was being compressed");typeof r=="function"&&r(c);for(let u=0;u<this._queue.length;u++){let p=this._queue[u],g=p[p.length-1];typeof g=="function"&&g(c)}return}this._bufferedBytes-=s[de],this._deflating=!1,s.readOnly=!1,this.sendFrame(n.frame(l,s),r),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][de],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][de],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};Yr.exports=vs});var ii=te((Ga,ri)=>{"use strict";var{kForOnEventAttribute:st,kListener:ws}=Se(),Kr=Symbol("kCode"),Zr=Symbol("kData"),Xr=Symbol("kError"),Qr=Symbol("kMessage"),ei=Symbol("kReason"),Re=Symbol("kTarget"),ti=Symbol("kType"),si=Symbol("kWasClean"),me=class{constructor(e){this[Re]=null,this[ti]=e}get target(){return this[Re]}get type(){return this[ti]}};Object.defineProperty(me.prototype,"target",{enumerable:!0});Object.defineProperty(me.prototype,"type",{enumerable:!0});var je=class extends me{constructor(e,t={}){super(e),this[Kr]=t.code===void 0?0:t.code,this[ei]=t.reason===void 0?"":t.reason,this[si]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Kr]}get reason(){return this[ei]}get wasClean(){return this[si]}};Object.defineProperty(je.prototype,"code",{enumerable:!0});Object.defineProperty(je.prototype,"reason",{enumerable:!0});Object.defineProperty(je.prototype,"wasClean",{enumerable:!0});var Fe=class extends me{constructor(e,t={}){super(e),this[Xr]=t.error===void 0?null:t.error,this[Qr]=t.message===void 0?"":t.message}get error(){return this[Xr]}get message(){return this[Qr]}};Object.defineProperty(Fe.prototype,"error",{enumerable:!0});Object.defineProperty(Fe.prototype,"message",{enumerable:!0});var rt=class extends me{constructor(e,t={}){super(e),this[Zr]=t.data===void 0?null:t.data}get data(){return this[Zr]}};Object.defineProperty(rt.prototype,"data",{enumerable:!0});var Pn={addEventListener(n,e,t={}){for(let r of this.listeners(n))if(!t[st]&&r[ws]===e&&!r[st])return;let s;if(n==="message")s=function(i,o){let l=new rt("message",{data:o?i:i.toString()});l[Re]=this,Ft(e,this,l)};else if(n==="close")s=function(i,o){let l=new je("close",{code:i,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});l[Re]=this,Ft(e,this,l)};else if(n==="error")s=function(i){let o=new Fe("error",{error:i,message:i.message});o[Re]=this,Ft(e,this,o)};else if(n==="open")s=function(){let i=new me("open");i[Re]=this,Ft(e,this,i)};else return;s[st]=!!t[st],s[ws]=e,t.once?this.once(n,s):this.on(n,s)},removeEventListener(n,e){for(let t of this.listeners(n))if(t[ws]===e&&!t[st]){this.removeListener(n,t);break}}};ri.exports={CloseEvent:je,ErrorEvent:Fe,Event:me,EventTarget:Pn,MessageEvent:rt};function Ft(n,e,t){typeof n=="object"&&n.handleEvent?n.handleEvent.call(n,t):n.call(e,t)}});var Os=te((qa,ni)=>{"use strict";var{tokenChars:it}=tt();function ge(n,e,t){n[e]===void 0?n[e]=[t]:n[e].push(t)}function Tn(n){let e=Object.create(null),t=Object.create(null),s=!1,r=!1,i=!1,o,l,c=-1,u=-1,p=-1,g=0;for(;g<n.length;g++)if(u=n.charCodeAt(g),o===void 0)if(p===-1&&it[u]===1)c===-1&&(c=g);else if(g!==0&&(u===32||u===9))p===-1&&c!==-1&&(p=g);else if(u===59||u===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${g}`);p===-1&&(p=g);let w=n.slice(c,p);u===44?(ge(e,w,t),t=Object.create(null)):o=w,c=p=-1}else throw new SyntaxError(`Unexpected character at index ${g}`);else if(l===void 0)if(p===-1&&it[u]===1)c===-1&&(c=g);else if(u===32||u===9)p===-1&&c!==-1&&(p=g);else if(u===59||u===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${g}`);p===-1&&(p=g),ge(t,n.slice(c,p),!0),u===44&&(ge(e,o,t),t=Object.create(null),o=void 0),c=p=-1}else if(u===61&&c!==-1&&p===-1)l=n.slice(c,g),c=p=-1;else throw new SyntaxError(`Unexpected character at index ${g}`);else if(r){if(it[u]!==1)throw new SyntaxError(`Unexpected character at index ${g}`);c===-1?c=g:s||(s=!0),r=!1}else if(i)if(it[u]===1)c===-1&&(c=g);else if(u===34&&c!==-1)i=!1,p=g;else if(u===92)r=!0;else throw new SyntaxError(`Unexpected character at index ${g}`);else if(u===34&&n.charCodeAt(g-1)===61)i=!0;else if(p===-1&&it[u]===1)c===-1&&(c=g);else if(c!==-1&&(u===32||u===9))p===-1&&(p=g);else if(u===59||u===44){if(c===-1)throw new SyntaxError(`Unexpected character at index ${g}`);p===-1&&(p=g);let w=n.slice(c,p);s&&(w=w.replace(/\\/g,""),s=!1),ge(t,l,w),u===44&&(ge(e,o,t),t=Object.create(null),o=void 0),l=void 0,c=p=-1}else throw new SyntaxError(`Unexpected character at index ${g}`);if(c===-1||i||u===32||u===9)throw new SyntaxError("Unexpected end of input");p===-1&&(p=g);let v=n.slice(c,p);return o===void 0?ge(e,v,t):(l===void 0?ge(t,v,!0):s?ge(t,l,v.replace(/\\/g,"")):ge(t,l,v),ge(e,o,t)),e}function En(n){return Object.keys(n).map(e=>{let t=n[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(r=>{let i=s[r];return Array.isArray(i)||(i=[i]),i.map(o=>o===!0?r:`${r}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}ni.exports={format:En,parse:Tn}});var Ts=te((Ja,pi)=>{"use strict";var jn=require("events"),Nn=require("https"),Cn=require("http"),li=require("net"),In=require("tls"),{randomBytes:Dn,createHash:Ln}=require("crypto"),{Duplex:$a,Readable:Wa}=require("stream"),{URL:ks}=require("url"),Oe=et(),Mn=bs(),Un=Ss(),{BINARY_TYPES:oi,EMPTY_BUFFER:zt,GUID:Rn,kForOnEventAttribute:xs,kListener:Fn,kStatusCode:zn,kWebSocket:Q,NOOP:ci}=Se(),{EventTarget:{addEventListener:Bn,removeEventListener:Gn}}=ii(),{format:qn,parse:$n}=Os(),{toBuffer:Wn}=Ze(),Jn=30*1e3,fi=Symbol("kAborted"),As=[8,13],be=["CONNECTING","OPEN","CLOSING","CLOSED"],Hn=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,Y=class n extends jn{constructor(e,t,s){super(),this._binaryType=oi[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=zt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=n.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),hi(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){oi.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let r=new Mn({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation});this._sender=new Un(e,this._extensions,s.generateMask),this._receiver=r,this._socket=e,r[Q]=this,e[Q]=this,r.on("conclude",Kn),r.on("drain",Zn),r.on("error",Xn),r.on("message",Qn),r.on("ping",eo),r.on("pong",to),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",di),e.on("data",Gt),e.on("end",_i),e.on("error",gi),this._readyState=n.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[Oe.extensionName]&&this._extensions[Oe.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){ae(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===n.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=n.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),Jn)}}pause(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||zt,t,s)}pong(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||zt,t,s)}resume(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){Ps(this,e,s);return}let r={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[Oe.extensionName]||(r.compress=!1),this._sender.send(e||zt,r,s)}terminate(){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){ae(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=n.CLOSING,this._socket.destroy())}}};Object.defineProperty(Y,"CONNECTING",{enumerable:!0,value:be.indexOf("CONNECTING")});Object.defineProperty(Y.prototype,"CONNECTING",{enumerable:!0,value:be.indexOf("CONNECTING")});Object.defineProperty(Y,"OPEN",{enumerable:!0,value:be.indexOf("OPEN")});Object.defineProperty(Y.prototype,"OPEN",{enumerable:!0,value:be.indexOf("OPEN")});Object.defineProperty(Y,"CLOSING",{enumerable:!0,value:be.indexOf("CLOSING")});Object.defineProperty(Y.prototype,"CLOSING",{enumerable:!0,value:be.indexOf("CLOSING")});Object.defineProperty(Y,"CLOSED",{enumerable:!0,value:be.indexOf("CLOSED")});Object.defineProperty(Y.prototype,"CLOSED",{enumerable:!0,value:be.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(n=>{Object.defineProperty(Y.prototype,n,{enumerable:!0})});["open","error","close","message"].forEach(n=>{Object.defineProperty(Y.prototype,`on${n}`,{enumerable:!0,get(){for(let e of this.listeners(n))if(e[xs])return e[Fn];return null},set(e){for(let t of this.listeners(n))if(t[xs]){this.removeListener(n,t);break}typeof e=="function"&&this.addEventListener(n,e,{[xs]:!0})}})});Y.prototype.addEventListener=Bn;Y.prototype.removeEventListener=Gn;pi.exports=Y;function hi(n,e,t,s){let r={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:As[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(n._autoPong=r.autoPong,!As.includes(r.protocolVersion))throw new RangeError(`Unsupported protocol version: ${r.protocolVersion} (supported versions: ${As.join(", ")})`);let i;if(e instanceof ks)i=e;else try{i=new ks(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}i.protocol==="http:"?i.protocol="ws:":i.protocol==="https:"&&(i.protocol="wss:"),n._url=i.href;let o=i.protocol==="wss:",l=i.protocol==="ws+unix:",c;if(i.protocol!=="ws:"&&!o&&!l?c=`The URL's protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"`:l&&!i.pathname?c="The URL's pathname is empty":i.hash&&(c="The URL contains a fragment identifier"),c){let j=new SyntaxError(c);if(n._redirects===0)throw j;Bt(n,j);return}let u=o?443:80,p=Dn(16).toString("base64"),g=o?Nn.request:Cn.request,v=new Set,w;if(r.createConnection=r.createConnection||(o?Yn:Vn),r.defaultPort=r.defaultPort||u,r.port=i.port||u,r.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,r.headers={...r.headers,"Sec-WebSocket-Version":r.protocolVersion,"Sec-WebSocket-Key":p,Connection:"Upgrade",Upgrade:"websocket"},r.path=i.pathname+i.search,r.timeout=r.handshakeTimeout,r.perMessageDeflate&&(w=new Oe(r.perMessageDeflate!==!0?r.perMessageDeflate:{},!1,r.maxPayload),r.headers["Sec-WebSocket-Extensions"]=qn({[Oe.extensionName]:w.offer()})),t.length){for(let j of t){if(typeof j!="string"||!Hn.test(j)||v.has(j))throw new SyntaxError("An invalid or duplicated subprotocol was specified");v.add(j)}r.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(r.origin&&(r.protocolVersion<13?r.headers["Sec-WebSocket-Origin"]=r.origin:r.headers.Origin=r.origin),(i.username||i.password)&&(r.auth=`${i.username}:${i.password}`),l){let j=r.path.split(":");r.socketPath=j[0],r.path=j[1]}let A;if(r.followRedirects){if(n._redirects===0){n._originalIpc=l,n._originalSecure=o,n._originalHostOrSocketPath=l?r.socketPath:i.host;let j=s&&s.headers;if(s={...s,headers:{}},j)for(let[F,D]of Object.entries(j))s.headers[F.toLowerCase()]=D}else if(n.listenerCount("redirect")===0){let j=l?n._originalIpc?r.socketPath===n._originalHostOrSocketPath:!1:n._originalIpc?!1:i.host===n._originalHostOrSocketPath;(!j||n._originalSecure&&!o)&&(delete r.headers.authorization,delete r.headers.cookie,j||delete r.headers.host,r.auth=void 0)}r.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(r.auth).toString("base64")),A=n._req=g(r),n._redirects&&n.emit("redirect",n.url,A)}else A=n._req=g(r);r.timeout&&A.on("timeout",()=>{ae(n,A,"Opening handshake has timed out")}),A.on("error",j=>{A===null||A[fi]||(A=n._req=null,Bt(n,j))}),A.on("response",j=>{let F=j.headers.location,D=j.statusCode;if(F&&r.followRedirects&&D>=300&&D<400){if(++n._redirects>r.maxRedirects){ae(n,A,"Maximum redirects exceeded");return}A.abort();let B;try{B=new ks(F,e)}catch{let L=new SyntaxError(`Invalid URL: ${F}`);Bt(n,L);return}hi(n,B,t,s)}else n.emit("unexpected-response",A,j)||ae(n,A,`Unexpected server response: ${j.statusCode}`)}),A.on("upgrade",(j,F,D)=>{if(n.emit("upgrade",j),n.readyState!==Y.CONNECTING)return;A=n._req=null;let B=j.headers.upgrade;if(B===void 0||B.toLowerCase()!=="websocket"){ae(n,F,"Invalid Upgrade header");return}let I=Ln("sha1").update(p+Rn).digest("base64");if(j.headers["sec-websocket-accept"]!==I){ae(n,F,"Invalid Sec-WebSocket-Accept header");return}let L=j.headers["sec-websocket-protocol"],C;if(L!==void 0?v.size?v.has(L)||(C="Server sent an invalid subprotocol"):C="Server sent a subprotocol but none was requested":v.size&&(C="Server sent no subprotocol"),C){ae(n,F,C);return}L&&(n._protocol=L);let N=j.headers["sec-websocket-extensions"];if(N!==void 0){if(!w){ae(n,F,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let U;try{U=$n(N)}catch{ae(n,F,"Invalid Sec-WebSocket-Extensions header");return}let G=Object.keys(U);if(G.length!==1||G[0]!==Oe.extensionName){ae(n,F,"Server indicated an extension that was not requested");return}try{w.accept(U[Oe.extensionName])}catch{ae(n,F,"Invalid Sec-WebSocket-Extensions header");return}n._extensions[Oe.extensionName]=w}n.setSocket(F,D,{allowSynchronousEvents:r.allowSynchronousEvents,generateMask:r.generateMask,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation})}),r.finishRequest?r.finishRequest(A,n):A.end()}function Bt(n,e){n._readyState=Y.CLOSING,n.emit("error",e),n.emitClose()}function Vn(n){return n.path=n.socketPath,li.connect(n)}function Yn(n){return n.path=void 0,!n.servername&&n.servername!==""&&(n.servername=li.isIP(n.host)?"":n.host),In.connect(n)}function ae(n,e,t){n._readyState=Y.CLOSING;let s=new Error(t);Error.captureStackTrace(s,ae),e.setHeader?(e[fi]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(Bt,n,s)):(e.destroy(s),e.once("error",n.emit.bind(n,"error")),e.once("close",n.emitClose.bind(n)))}function Ps(n,e,t){if(e){let s=Wn(e).length;n._socket?n._sender._bufferedBytes+=s:n._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${n.readyState} (${be[n.readyState]})`);process.nextTick(t,s)}}function Kn(n,e){let t=this[Q];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=n,t._socket[Q]!==void 0&&(t._socket.removeListener("data",Gt),process.nextTick(ui,t._socket),n===1005?t.close():t.close(n,e))}function Zn(){let n=this[Q];n.isPaused||n._socket.resume()}function Xn(n){let e=this[Q];e._socket[Q]!==void 0&&(e._socket.removeListener("data",Gt),process.nextTick(ui,e._socket),e.close(n[zn])),e.emit("error",n)}function ai(){this[Q].emitClose()}function Qn(n,e){this[Q].emit("message",n,e)}function eo(n){let e=this[Q];e._autoPong&&e.pong(n,!this._isServer,ci),e.emit("ping",n)}function to(n){this[Q].emit("pong",n)}function ui(n){n.resume()}function di(){let n=this[Q];this.removeListener("close",di),this.removeListener("data",Gt),this.removeListener("end",_i),n._readyState=Y.CLOSING;let e;!this._readableState.endEmitted&&!n._closeFrameReceived&&!n._receiver._writableState.errorEmitted&&(e=n._socket.read())!==null&&n._receiver.write(e),n._receiver.end(),this[Q]=void 0,clearTimeout(n._closeTimer),n._receiver._writableState.finished||n._receiver._writableState.errorEmitted?n.emitClose():(n._receiver.on("error",ai),n._receiver.on("finish",ai))}function Gt(n){this[Q]._receiver.write(n)||this.pause()}function _i(){let n=this[Q];n._readyState=Y.CLOSING,n._receiver.end(),this.end()}function gi(){let n=this[Q];this.removeListener("error",gi),this.on("error",ci),n&&(n._readyState=Y.CLOSING,this.destroy())}});var mi=te((Ha,yi)=>{"use strict";var{tokenChars:so}=tt();function ro(n){let e=new Set,t=-1,s=-1,r=0;for(r;r<n.length;r++){let o=n.charCodeAt(r);if(s===-1&&so[o]===1)t===-1&&(t=r);else if(r!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=r);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${r}`);s===-1&&(s=r);let l=n.slice(t,s);if(e.has(l))throw new SyntaxError(`The "${l}" subprotocol is duplicated`);e.add(l),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${r}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let i=n.slice(t,r);if(e.has(i))throw new SyntaxError(`The "${i}" subprotocol is duplicated`);return e.add(i),e}yi.exports={parse:ro}});var xi=te((Ya,ki)=>{"use strict";var io=require("events"),qt=require("http"),{Duplex:Va}=require("stream"),{createHash:no}=require("crypto"),bi=Os(),Ne=et(),oo=mi(),ao=Ts(),{GUID:lo,kWebSocket:co}=Se(),fo=/^[+/0-9A-Za-z]{22}==$/,vi=0,Si=1,Oi=2,Es=class extends io{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:ao,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=qt.createServer((s,r)=>{let i=qt.STATUS_CODES[426];r.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),r.end(i)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=ho(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(r,i,o)=>{this.handleUpgrade(r,i,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=vi}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===Oi){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(nt,this);return}if(e&&this.once("close",e),this._state!==Si)if(this._state=Si,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(nt,this):process.nextTick(nt,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{nt(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,r){t.on("error",wi);let i=e.headers["sec-websocket-key"],o=e.headers.upgrade,l=+e.headers["sec-websocket-version"];if(e.method!=="GET"){Ce(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){Ce(this,e,t,400,"Invalid Upgrade header");return}if(i===void 0||!fo.test(i)){Ce(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(l!==8&&l!==13){Ce(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){ot(t,400);return}let c=e.headers["sec-websocket-protocol"],u=new Set;if(c!==void 0)try{u=oo.parse(c)}catch{Ce(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let p=e.headers["sec-websocket-extensions"],g={};if(this.options.perMessageDeflate&&p!==void 0){let v=new Ne(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let w=bi.parse(p);w[Ne.extensionName]&&(v.accept(w[Ne.extensionName]),g[Ne.extensionName]=v)}catch{Ce(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let v={origin:e.headers[`${l===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(v,(w,A,j,F)=>{if(!w)return ot(t,A||401,j,F);this.completeUpgrade(g,i,u,e,t,s,r)});return}if(!this.options.verifyClient(v))return ot(t,401)}this.completeUpgrade(g,i,u,e,t,s,r)}completeUpgrade(e,t,s,r,i,o,l){if(!i.readable||!i.writable)return i.destroy();if(i[co])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>vi)return ot(i,503);let u=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${no("sha1").update(t+lo).digest("base64")}`],p=new this.options.WebSocket(null,void 0,this.options);if(s.size){let g=this.options.handleProtocols?this.options.handleProtocols(s,r):s.values().next().value;g&&(u.push(`Sec-WebSocket-Protocol: ${g}`),p._protocol=g)}if(e[Ne.extensionName]){let g=e[Ne.extensionName].params,v=bi.format({[Ne.extensionName]:[g]});u.push(`Sec-WebSocket-Extensions: ${v}`),p._extensions=e}this.emit("headers",u,r),i.write(u.concat(`\r
`).join(`\r
`)),i.removeListener("error",wi),p.setSocket(i,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(p),p.on("close",()=>{this.clients.delete(p),this._shouldEmitClose&&!this.clients.size&&process.nextTick(nt,this)})),l(p,r)}};ki.exports=Es;function ho(n,e){for(let t of Object.keys(e))n.on(t,e[t]);return function(){for(let s of Object.keys(e))n.removeListener(s,e[s])}}function nt(n){n._state=Oi,n.emit("close")}function wi(){this.destroy()}function ot(n,e,t,s){t=t||qt.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},n.once("finish",n.destroy),n.end(`HTTP/1.1 ${e} ${qt.STATUS_CODES[e]}\r
`+Object.keys(s).map(r=>`${r}: ${s[r]}`).join(`\r
`)+`\r
\r
`+t)}function Ce(n,e,t,s,r){if(n.listenerCount("wsClientError")){let i=new Error(r);Error.captureStackTrace(i,Ce),n.emit("wsClientError",i,t,e)}else ot(t,s,r)}});var Oo={};Zs(Oo,{AuthorizationStruct:()=>Fs,CMDService:()=>Ns,Callable:()=>_t,ChatroomStruct:()=>qs,CircularBuffer:()=>St,CoherenceMap:()=>Wt,CoherenceStruct:()=>$t,CommentStruct:()=>$s,DS:()=>re,Data:()=>Ei,DataStruct:()=>Bs,DataTablet:()=>ft,DateStruct:()=>Hs,DelayBuffer:()=>wt,DelayBufferManager:()=>We,E2EEService:()=>rs,ECGStruct:()=>Ht,EDAStruct:()=>Ds,EEGCoordinates:()=>Ti,EEGStruct:()=>ve,EMGStruct:()=>Us,EventHandler:()=>Ge,EventStruct:()=>Gs,EyeTrackerStruct:()=>Is,FNIRSStruct:()=>Jt,FrequencyBandsStruct:()=>ct,Graph:()=>_e,GraphNode:()=>W,GroupStruct:()=>zs,HRVStruct:()=>Ms,HTTPbackend:()=>os,IMUStruct:()=>Cs,InputBuffer:()=>vt,NotificationStruct:()=>Ws,PPGStruct:()=>Ls,ProfileStruct:()=>Rs,Router:()=>Xt,SSEbackend:()=>ls,ScheduleStruct:()=>Js,Service:()=>he,SessionManager:()=>Je,SessionService:()=>es,Struct:()=>K,StructBackend:()=>Ks,StructFrontend:()=>Vs,WSSbackend:()=>js,animate:()=>sr,backprop:()=>er,bindListener:()=>nr,branching:()=>rr,connectionHasId:()=>Qt,defaultCollections:()=>Gi,defaultManifest:()=>ns,defaultServiceWorker:()=>is,defaultSpecifiers:()=>Ni,eegCoordinates:()=>Ae,genTimeSpecifiers:()=>yo,genTimestampFromString:()=>pe,getAllProperties:()=>Zt,getCallbackFromString:()=>qe,getFnParamNames:()=>Ki,getFunctionHead:()=>cr,getStringId:()=>M,htmlBodyBoilerPlate:()=>Qi,instanceObject:()=>Yi,isFunction:()=>Qs,isNativeClass:()=>gt,isTypedArray:()=>dr,loaders:()=>yt,loop:()=>tr,methodstrings:()=>Xi,parseFunctionFromText:()=>mt,pseudoObjectId:()=>mo,randomId:()=>Li,reconstructObject:()=>Zi,recursivelyAssign:()=>bt,recursivelyStringifyFunctions:()=>lr,scriptBoilerPlate:()=>en,setCoordinate:()=>lt,spliceTypedArray:()=>_r,state:()=>Kt,stringifyFast:()=>ur,stringifyWithCircularRefs:()=>fr,stringifyWithFunctionsAndCircularRefs:()=>hr,structRegistry:()=>ji,substitute__operator:()=>ar,toObjectId:()=>Z,transformListenerResult:()=>or,triggerListenerOncreate:()=>ir,wrapArgs:()=>pt});module.exports=Vi(Oo);var Ge=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let s of t)this.triggerEvent(s,this.data[s]);if(this.triggers[Be]){let s=i=>{i(e)},r=this.triggers[Be].length;for(let i=r-1;i>=0;i--)s(this.triggers[Be][i].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let s=i=>{i.onchange(t)},r=this.triggers[e].length;for(let i=r-1;i>=0;i--)s(this.triggers[e][i])}};subscribeState=e=>this.subscribeEvent(Be,e);unsubscribeState=e=>this.unsubscribeEvent(Be,e);subscribeEvent=(e,t,s,r)=>{if(e){s&&r&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>s[r],set:o=>{s[r]=o},enumerable:!0,configurable:!0}),this.triggers[e]||(this.triggers[e]=[]);let i=this.ctr;return this.ctr++,this.triggers[e].push({sub:i,onchange:t}),i}else return};unsubscribeEvent=(e,t)=>{let s=this.triggers[e];if(s)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let r,i=s.find((o,l)=>{if(o.sub===t)return r=l,!0});return i&&s.splice(r,1),Object.keys(s).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(i),!0}};subscribeEventOnce=(e,t)=>{let s,r=i=>{t(i),this.unsubscribeEvent(e,s)};return s=this.subscribeEvent(e,r),s};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let s in this.triggers[e])if(this.triggers[e][s].sub===t)return this.triggers[e][s]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved},Be="*s";var Kt=new Ge,_t=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},W=class n{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:Kt};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,s){if(this.__setProperties(e,t,s),typeof e=="function"||e?.__callable){let r=new _t;r.__call=(...o)=>this.__operator(...o);let i=new Proxy(r,{get:(o,l,c)=>Reflect.has(this,l)?Reflect.get(this,l,c):Reflect.get(o,l,c),set:(o,l,c,u)=>Reflect.has(this,l)?Reflect.set(this,l,c,u):Reflect.set(o,l,c,u)});return Object.setPrototypeOf(i,this),i}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,s)=>{if((()=>{let i=e;typeof e=="function"?gt(e)?e=new e:e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&s?.get(e)&&(e=s.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=i)})(),typeof e=="object"){let i=()=>{e.__node?.state?this.__node.state=e.__node.state:s&&(e.__node.state=s.__node.state)},o=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},l=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},c=()=>{typeof e.__node=="string"?s?.get(e.__node.tag)?e=s.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),s&&(e.__node.graph=s),e instanceof _e&&(e.__node.source=e)},u=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof _e||e instanceof _e)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof _e&&e instanceof _e&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(A=>{t.set(e.__node.tag+"."+A.__node.tag,A)});let w=()=>{e.__node.nodes.forEach(A=>{t.__node.nodes.delete(e.__node.tag+"."+A.__node.tag)})};this.__addOndisconnected(w)}},p=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&s){let w=s.get(e.__operator);w&&(e.__operator=w.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},g=()=>{e.__node=Object.assign(this.__node,e.__node);let w=Object.getOwnPropertyNames(e).filter(A=>{if(!De[A])return!0});for(let A of w)A in e&&A!=="name"&&(this[A]=e[A])},v=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(w=>w.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(w=>w.bind(this))))};i(),l(),o(),c(),u(),g(),v(),p()}};__subscribe=(e,t,s,r,i,o,l)=>{let c=(p,g=(w,A)=>A||w,v=e)=>{let w;if(o){let F=pt(v,o,this.__node.graph);v=F.__callback,w=F.__args}let A=this.__node.state.subscribeEvent(p,v,this,t),j=this.__node.state.getEvent(p,A);return this.__listeners||(this.__listeners={}),this.__listeners[p]=this.__node.state.triggers[p],j&&(j.source=this.__node.tag,t&&(j.key=t),j.target=g(e,r),i&&(j.tkey=i),s&&(j.subInput=s),o&&(j.arguments=w,j.__args=o),l&&(j.__callback=l),j.node=this,j.graph=this.__node.graph),A},u=p=>{let g=this.__node.graph.get(p);if(!g&&p.includes(".")){r=p.substring(0,p.lastIndexOf("."));let v=this.__node.graph.get(p.substring(0,r));i=p.lastIndexOf(".")+1,v&&typeof v[t]=="function"&&(p=(...w)=>v[i](...w))}else g.__operator&&(p=g.__operator,i="__operator");return p};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(l=this.__node.tag+"."+e,i=e,r){if(this.__node.graph?.get(r)){let v=this.__node.graph?.get(r);if(typeof v[e]=="function"){let w=v[e];e=(...A)=>{w(...A)}}else{let w=e;e=j=>{v[w]=j}}}}else if(typeof this[e]=="function"){let v=this[e];e=(...w)=>{v(...w)}}else this.__node.graph?.get(e)&&(e=u(e));if(typeof e!="function")return}let p,g=s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?p=c(g,(v,w)=>w||v,e):e?.__node&&(p=c(g,(v,w)=>w||v.__node.unique,(...v)=>{e.__operator&&e.__operator(...v)})),p}else{if(typeof e=="string"&&(l=e,r||(r=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),i="__operator",typeof e!="object"))return;let p,g=s?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?p=c(g,(v,w)=>w||v,e):e?.__node&&(p=c(g,(v,w)=>w||v.__node.unique,(...v)=>{e.__operator&&e.__operator(...v)})),p}};__unsubscribe=(e,t,s)=>t?this.__node.state.unsubscribeEvent(s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(s?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=pt(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...s)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,s);let r=e(...s);return this.__node.state.triggers[this.__node.unique]&&(typeof r?.then=="function"?r.then(i=>{i!==void 0&&this.__node.state.setValue(this.__node.unique,i)}).catch(console.error):r!==void 0&&this.__node.state.setValue(this.__node.unique,r)),r},this.__parent instanceof n&&!this.__subscribedToParent&&this.__parent.__operator){let s=this.__parent.__subscribe(this),r=()=>{this.__parent?.__unsubscribe(s),delete this.__subscribedToParent};this.__addOndisconnected(r),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let s=this.__node.localState,r=(i,o)=>{let l=this.__node.unique+"."+o,c=`${l}input`,u,p,g,v;if(typeof i[o]=="function"&&o!=="__operator")this.__props?.[o]?g=this.__props:g=s,u=()=>g[o],p=w=>{this.__props?.[o]||(w=w.bind(this)),g[o]=(...A)=>{this.__node.state.triggers[c]&&this.__node.state.setValue(c,A);let j=w(...A);return this.__node.state.triggers[l]&&(typeof j?.then=="function"?j.then(F=>{this.__node.state.triggerEvent(l,F)}).catch(console.error):this.__node.state.triggerEvent(l,j)),j}},s[o]=i[o].bind(this),v={get:u,set:p,enumerable:!0,configurable:!0};else if(o!=="__graph"){let w,A,j;this.__props?.[o]?j=this.__props:j=s,w=()=>j[o],A=F=>{j[o]=F,this.__node.state.triggers[l]&&this.__node.state.triggerEvent(l,F)},s[o]=i[o],v={get:w,set:A,enumerable:!0,configurable:!0}}if(Object.defineProperty(i,o,v),typeof this.__node.initial=="object"){let w=Object.getOwnPropertyDescriptor(this.__node.initial,o);(w===void 0||w?.configurable)&&Object.defineProperty(this.__node.initial,o,v)}};if(t)r(e,t);else for(let i in e)r(e,i)};__proxyObject=e=>{let t=Zt(e);for(let s of t){let r={get:()=>e[s],set:i=>{e[s]=i},enumerable:!0,configurable:!0};if(Object.defineProperty(this,s,r),typeof this.__node.initial=="object"){let i=Object.getOwnPropertyDescriptor(this.__node.initial,s);(i===void 0||i?.configurable)&&Object.defineProperty(this.__node.initial,s,r)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=s=>{s(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=s=>{s(this)};this.__ondisconnected.forEach(t)}}},_e=class n{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:Kt,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,$e(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=!1)=>{function s(o,l,c=!0,u=!0){if(u){o||(o={});for(let p in l)!p.startsWith("__")&&l[p]&&typeof l[p]=="object"?(o[p]=l[p],l[p]?.__children&&s({},l[p].__children,!1,!1)):typeof l[p]=="function"&&(o[p]=l[p]);s(o,l,!0,!1)}else if(l?.__children&&!c)l.__children?.constructor.name==="Object"?o.__children?.constructor.name==="Object"?o.__children=s(o.__children,l.__children,!0,!1):o.__children=s({},l.__children,!0,!1):o.__children=l.__children;else if(c)for(let p in l)!p.startsWith("__")&&l[p]&&typeof l[p]=="object"?(o[p]=Object.assign({},l[p]),l[p]?.__children&&(o[p].__children=s({},l[p].__children,!1,!1))):typeof l[p]=="function"&&(o[p]=l[p]);return o}this.__node.roots=s(this.__node.roots?this.__node.roots:{},e);let r=Object.assign({},e);r.__node&&delete r.__node;let i=this.recursiveSet(r,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let o=new W(e,this,this);this.set(o.__node.tag,o),this.runLoaders(o,this,e,e.__node.tag),o.__listeners&&(i[o.__node.tag]=o.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(i),r};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,s,r)=>{for(let i in this.__node.loaders)typeof this.__node.loaders[i]=="object"?(this.__node.loaders[i].init&&this.__node.loaders[i](e,t,this,this.__node.roots,s,r),this.__node.loaders[i].connected&&e.__addOnconnected(this.__node.loaders[i].connect),this.__node.loaders[i].disconnected&&e.__addOndisconnected(this.__node.loaders[i].disconnect)):typeof this.__node.loaders[i]=="function"&&this.__node.loaders[i](e,t,this,this.__node.roots,s,r)};add=(e,t,s=!0)=>{let r={};typeof t=="string"&&(t=this.get(t));let i;if(typeof e=="function"?gt(e)?e.prototype instanceof W?(e=e.prototype.constructor(e,t,this),i=!0):e=new e:e={__operator:e,__callable:!0}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!i){let c=Object.getOwnPropertyNames(e),u=Object.getOwnPropertyNames(Object.getPrototypeOf(e));c.push(...u),c=c.filter(g=>!De.includes(g));let p={};for(let g of c)p[g]=e[g];e=p}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(s)this.remove(e.__node.tag,!0);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let o,l=$e({},e,2);if(i?o=e:o=new W(e,t,this),this.set(o.__node.tag,o),this.runLoaders(o,t,e,o.__node.tag),this.__node.roots[o.__node.tag]=l,o.__children&&(o.__children=Object.assign({},o.__children),this.recursiveSet(o.__children,o,r,o.__children)),o.__listeners){r[o.__node.tag]=Object.assign({},o.__listeners);for(let c in o.__listeners){let u=o.__listeners[c];o[c]&&(delete r[o.__node.tag][c],r[o.__node.tag][o.__node.tag+"."+c]=u),typeof u=="string"&&(o.__children?.[u]?r[o.__node.tag][c]=o.__node.tag+"."+u:t instanceof W&&(t.__node.tag===u||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===u)&&(r[o.__node.tag][c]=t.__node.tag))}}return this.setListeners(r),o.__callConnected(),o};recursiveSet=(e,t,s={},r,i=!1)=>{let o=Object.getOwnPropertyNames(r).filter(c=>!De.includes(c)),l=Object.getOwnPropertyNames(Object.getPrototypeOf(r)).filter(c=>!De.includes(c));o.push(...l);for(let c of o){if(c.includes("__"))continue;let u=r[c];if(Array.isArray(u))continue;let p;if(typeof u=="function"?gt(u)?(u=new u,u instanceof W&&(u=u.prototype.constructor(u,t,this),p=!0)):u={__operator:u,__callable:!0}:typeof u=="string"?this.__node.nodes.get(u)?u=this.__node.nodes.get(u):u=this.__node.roots[u]:typeof u=="boolean"&&(this.__node.nodes.get(c)?u=this.__node.nodes.get(c):u=this.__node.roots[c]),u&&typeof u=="object"){if(!p&&!(u instanceof W)){let A=Object.getOwnPropertyNames(u).filter(D=>!De.includes(D)),j=Object.getOwnPropertyNames(Object.getPrototypeOf(u)).filter(D=>!De.includes(D));j.splice(j.indexOf("constructor"),1),A.push(...j);let F={};for(let D of A)F[D]=u[D];u=F}if(u.__node||(u.__node={}),u.__node.tag||(u.__node.tag=c),u.__node.initial||(u.__node.initial=e[c]),i&&this.get(u.__node.tag))this.remove(u.__node.tag,!0);else if(this.get(u.__node.tag)&&!(!(t instanceof n)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+u.__node.tag))continue;let g,v=!1,w=$e({},u,2);if(p||u instanceof W?g=u:(g=new W(u,t,this),v=!0),!v&&u instanceof W&&!p&&t instanceof W){let A=this.subscribe(t.__node.tag,g.__node.tag),j=F=>{this.unsubscribe(t.__node.tag,A)};g.__addOndisconnected(j)}else if(g){if(this.set(g.__node.tag,g),this.runLoaders(g,t,e[c],c),e[c]=g,this.__node.roots[g.__node.tag]=w,g.__children&&(g.__children=Object.assign({},g.__children),this.recursiveSet(g.__children,g,s,g.__children)),g.__listeners){s[g.__node.tag]=Object.assign({},g.__listeners);for(let A in g.__listeners){let j=g.__listeners[A],F=A;g[A]&&(delete s[g.__node.tag][A],F=g.__node.tag+"."+A,s[g.__node.tag][F]=j),typeof j=="string"&&(g.__children?.[j]?s[g.__node.tag][F]=g.__node.tag+"."+j:t instanceof W&&(t.__node.tag===j||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===j)&&(s[g.__node.tag][F]=t.__node.tag))}}g.__callConnected()}}}return s};remove=(e,t=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof W){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let s=r=>{for(let i in r)this.unsubscribe(r[i]),this.delete(r[i].__node.tag),delete this.__node.roots[r[i].__node.tag],this.delete(i),delete this.__node.roots[i],r[i].__node.tag=r[i].__node.tag.substring(r[i].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(r[i]),r[i].__callDisconnected(),r[i].__children&&s(r[i].__children)};e.__children&&s(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let s=this.get(e);if(!s&&e.includes(".")){if(s=this.get(e.substring(0,e.lastIndexOf("."))),typeof s?.[e.substring(e.lastIndexOf(".")+1)]=="function")return s[e.substring(e.lastIndexOf(".")+1)](...t)}else if(s?.__operator)return s.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let s=this.get(t);if(typeof e[t]=="object")for(let r in e[t]){let i=this.get(r),o;if(typeof e[t][r]!="object")e[t][r]={__callback:e[t][r]};else if(!e[t][r].__callback)for(let l in e[t][r]){typeof e[t][r][l]!="object"&&(e[t][r][l]={__callback:e[t][r][l]},s.__operator&&(e[t][r][l].__callback===!0||typeof e[t][r][l].__callback>"u")&&(e[t][r][l].__callback=s.__operator));let c=this.get(l);if(c)o=this.subscribe(c,e[t][r][l].__callback,e[t][r][l].__args,void 0,e[t][r][l].subInput,t);else{let u=r.substring(0,r.lastIndexOf("."));if(c=this.get(u),c){let p=r.substring(r.lastIndexOf(".")+1);o=this.subscribe(c,e[t][r][l].__callback,e[t][r][l].__args,p,e[t][r][l].subInput,t)}}}if("__callback"in e[t][r])if(s&&((e[t][r].__callback===!0||typeof e[t][r].__callback>"u")&&(e[t][r].__callback=s.__operator),typeof e[t][r].__callback=="function"&&(e[t][r].__callback=e[t][r].__callback.bind(s))),i)o=this.subscribe(i,e[t][r].__callback,e[t][r].__args,void 0,e[t][r].subInput,t);else{let l=r.substring(0,r.lastIndexOf("."));i=this.get(l),i&&(o=this.subscribe(i,e[t][r].__callback,e[t][r].__args,r.substring(r.lastIndexOf(".")+1),e[t][r].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let s in e.__listeners){if(t&&s!==t||typeof e.__listeners[s]?.sub!="number")continue;let r=this.get(s);if(r)if(typeof!e.__listeners[s]?.__callback=="number")for(let i in e.__listeners[s])e.__listeners[s][i]?.sub&&(this.unsubscribe(r,e.__listeners[s][i].sub,void 0,e.__listeners[s][i].subInput),e.__listeners[s][i].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(r,e.__listeners[s].sub,void 0,e.__listeners[s].subInput),e.__listeners[s].sub=void 0);else if(r=this.get(s.substring(0,s.lastIndexOf("."))),r)if(typeof e.__listeners[s]=="object"&&!e.__listeners[s]?.__callback)for(let i in e.__listeners[s])typeof e.__listeners[s][i]?.sub=="number"&&(this.unsubscribe(r,e.__listeners[s][i].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s][i].subInput),e.__listeners[s][i].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(r,e.__listeners[s].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s].subInput),e.__listeners[s].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return!0});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,s)=>{let r=this.get(e);if(r){let i=r.__node.unique;return t&&(i+="."+t),this.__node.state.getEvent(i,s)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof W){let s;if(t)s=Object.assign({},this.__node.roots[e.__node.tag]);else{s=Object.assign({},e);for(let r in s)r.includes("__")&&delete s[r]}}};subscribe=(e,t,s,r,i,o,l)=>{let c=e;typeof e=="string"&&(c=this.get(e),!c&&e.includes(".")&&(c=this.get(e.substring(0,e.lastIndexOf("."))),r=e.substring(e.lastIndexOf(".")+1))),o instanceof W&&(o=o.__node.tag);let u;if(typeof t=="string"){u=t;let g=v=>{if(this.get(v)?.__operator){let w=this.get(v);o=v,v=function(...A){return w.__operator(...A)}}else if(v.includes(".")){o=v.substring(0,v.lastIndexOf("."));let w=this.get(o),A=v.substring(v.lastIndexOf(".")+1);l=A,typeof w[A]=="function"?w[A]instanceof W?v=w[A]:v=function(...j){return w[A](...j)}:v=function(j){return w[A]=j,w[A]}}return v};if(o){let v=this.get(o);typeof v?.[t]=="function"?(l=t,t=function(...w){return v[r](...w)}):v?.[r]?(l=r,v[r]instanceof W?t=v[r]:t=function(w){return v[r]=w,v[r]}):t=g(t)}else t=g(t)}let p;if(c instanceof W){let g=()=>{p=c.__subscribe(t,r,i,o,l,s,u);let v=()=>{p!==void 0&&c.__unsubscribe(p,r,i),p=void 0};c.__addOndisconnected(()=>{v(),c.__addOnconnected(()=>{p===void 0&&c.__node.graph.__node.tag===this.__node.tag&&g()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof W&&t.__addOndisconnected(()=>{v()})};g()}else if(typeof e=="string"){let g=this.get(e);if(g){if(t instanceof W&&t.__operator){let v=()=>{p=g.__subscribe(t.__operator,r,i,o,l,s,u);let w=()=>{p!==void 0&&g.__unsubscribe(p,r,i)};g.__addOndisconnected(()=>{w(),g.__addOnconnected(()=>{p===void 0&&g.__node.graph.__node.tag===this.__node.tag&&v()})}),t.__addOndisconnected(w)};v()}else if(typeof t=="function"||typeof t=="string"){let v=()=>{p=g.__subscribe(t,r,i,o,l,s,u);let w=()=>{p!==void 0&&g.__unsubscribe(p,r,i),p=void 0};g.__addOndisconnected(()=>{w(),g.__addOnconnected(()=>{p===void 0&&g.__node.graph.__node.tag===this.__node.tag&&v()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(w)};v()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(p=this.__node.state.subscribeEvent(e,t))}return p};unsubscribe=(e,t,s,r)=>e instanceof W?e.__unsubscribe(t,s,r):this.get(e)?.__unsubscribe(t,s,r);setState=e=>{this.__node.state.setState(e)}};function $e(n,e,t=1/0,s=0){for(let r in e)e[r]?.constructor.name==="Object"&&s<t?(s++,n[r]?.constructor.name==="Object"?$e(n[r],e[r],t,s):n[r]=$e({},e[r],t,s)):n[r]=e[r];return n}function Zt(n){var e=[],t=n;do{var s=Object.getOwnPropertyNames(t);let r=function(i){e.indexOf(i)===-1&&e.push(i)};s.forEach(r)}while(t=Object.getPrototypeOf(t));return e}function Yi(n){let e=Zt(n),t={};for(let s of e)t[s]=n[s];return t}function gt(n){return Qs(n)==="class"}function Qs(n){return typeof n=="function"?n.prototype?Object.getOwnPropertyDescriptor(n,"prototype")?.writable?"function":"class":n.constructor.name==="AsyncFunction"?"async":"arrow":""}var qe=(n,e)=>{if(e.get(n)?.__operator){let t=e.get(n);return(...s)=>{t.__operator(...s)}}else if(n.includes(".")){let t=n.split("."),s=t.pop(),r=t.join("."),i=e.get(r);return typeof e.get(r)?.[s]=="function"?(...o)=>i[s](...o):()=>i[s]}else if(e.get(n)){let t=e.get(n);return()=>t}else{let t=n;return()=>t}},pt=(n,e,t)=>{let s=[],r=(o,l)=>{if(o==="__output"||o==="__input"||o==="__callback")s[l]={__callback:c=>c,__args:void 0,idx:l};else if(typeof o=="string")s[l]={__callback:qe(o,t),__args:void 0,idx:l};else if(typeof o=="function"){let c=o;s[l]={__callback:(...u)=>c(...u),__args:void 0,idx:l}}else if(typeof o=="object"&&(o.__input||o.__callback)){let c=function(u){let p=u.__input?u.__input:u.__callback;if(typeof u.__input=="string"&&(p={__callback:qe(u.__input,t),__args:void 0,idx:l}),u.__args){let g=pt(p,u.__args,t);p={__callback:g.__callback,__args:g.__args,idx:l}}else p={__callback:p,__args:void 0,idx:l};if(u.__output){let g=u.__output;if(typeof u.__output=="string"?g={__callback:qe(g,t),__args:void 0,idx:l}:typeof o.__output=="object"&&(g=c(g)),typeof g?.__callback=="function"){let v=p.__callback,w=g.__callback;p={__callback:(...A)=>w(v(...A)),__args:g.__args,idx:l}}}return p};s[l]=c(o)}else{let c=o;s[l]={__callback:()=>c,__args:void 0,idx:l}}};e.forEach(r),typeof n=="string"&&(n={__callback:qe(n,t),__args:void 0});let i=typeof n=="function"?n:n.__callback;return n=function(...o){let l=u=>u.__callback(...o);return i(...s.map(l))},{__callback:n,__args:s}},De=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var er=(n,e,t)=>{n.__node.backward&&e instanceof W&&t.setListeners({[e.__node.tag]:{[n.__node.tag]:e}})},tr=(n,e,t)=>{if(n.__operator){let s=Math.random();if(n.__node.loops||(n.__node.loops={}),typeof n.__node.delay=="number"){let r=n.__operator;n.__setOperator((...i)=>new Promise((o,l)=>{n.__node.loops[s]=setTimeout(async()=>{o(await r(...i))},n.__node.delay)}))}else if(n.__node.frame===!0){let r=n.__operator;n.__setOperator((...i)=>new Promise((o,l)=>{n.__node.loops[s]=requestAnimationFrame(async()=>{o(await r(...i))})}))}if(typeof n.__node.repeat=="number"||typeof n.__node.recursive=="number"){let r=n.__operator;n.__setOperator(async(...i)=>{let o=n.__node.repeat?n.__node.repeat:n.__node.recursive,l,c=async(u,...p)=>{for(;u>0;){if(n.__node.delay||n.__node.frame){r(...p).then(async g=>{n.__node.recursive?await c(u,g):await c(u,...p)});break}else l=await r(...i);u--}};return await c(o,...i),l})}if(n.__node.loop&&typeof n.__node.loop=="number"){let r=n.__operator,i=n.__node.loop;n.__setOperator((...l)=>{if("looping"in n.__node||(n.__node.looping=!0),n.__node.looping){let c=performance.now();r(...l),n.__node.loops[s]=setTimeout(()=>{let p=performance.now()-c-n.__node.loop;p>0?i=n.__node.loop-p:i=n.__node.loop,i<=0&&(i=n.__node.loop),n.__operator(...l)},i)}}),n.__node.looping&&n.__operator();let o=l=>{l.__node.looping&&(l.__node.looping=!1),l.__node.loops[s]&&(clearTimeout(l.__node.loops[s]),cancelAnimationFrame(l.__node.loops[s]))};n.__addOndisconnected(o)}}},sr=(n,e,t)=>{if(n.__node.animate===!0||n.__animation){let s=n.__operator;n.__setOperator((...i)=>{"animating"in n.__node||(n.__node.animating=!0),n.__node.animating&&(typeof n.__animation=="function"?n.__animation(...i):s(...i),n.__node.animationFrame=requestAnimationFrame(()=>{n.__operator(...i)}))}),(n.__node.animating||(!("animating"in n.__node)||n.__node.animating)&&n.__animation)&&setTimeout(()=>{n.__node.animationFrame=requestAnimationFrame(n.__operator)},10);let r=i=>{i.__node.animating&&(i.__node.animating=!1),i.__node.animationFrame&&cancelAnimationFrame(i.__node.animationFrame)};n.__addOndisconnected(r)}},rr=(n,e,t)=>{if(typeof n.__branch=="object"&&n.__operator&&!n.__branchApplied){let s=n.__operator;n.__branchApplied=!0,n.__operator=(...r)=>{let i=s(...r);for(let o in n.__branch){let l=()=>{typeof n.__branch[o].then=="function"?n.__branch[o].then(i):n.__branch[o].then instanceof W&&n.__branch[o].then.__operator?n.__branch[o].then.__operator(i):i=n.__branch[o].then};typeof n.__branch[o].if=="function"?n.__branch[o].if(i)==!0&&l():n.__branch[o].if===i&&l()}return i}}if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&n.__listeners[s].branch&&!n.__listeners[s].branchApplied){let r=n.__listeners[s].callback;n.__listeners[s].branchApplied=!0,n.__listeners.callback=i=>{let o=()=>{typeof n.__listeners[s].branch.then=="function"?i=n.__listeners[s].branch.then(i):n.__listeners[s].branch.then instanceof W&&n.__listeners[s].branch.then.__operator?i=n.__listeners[s].branch.then.__operator(i):i=n.__listeners[s].branch.then};return typeof n.__listeners[s].branch.if=="function"?n.__listeners[s].branch.if(i)&&o():n.__listeners[s].branch.if===i&&o(),r(i)}}}},ir=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&n.__listeners[s].oncreate&&n.__listeners[s].callback(n.__listeners[s].oncreate)},nr=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].binding=="object"&&(n.__listeners.callback=n.__listeners.callback.bind(n.__listeners[s].binding))},or=(n,e,t)=>{if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].transform=="function"&&!n.__listeners[s].transformApplied){let r=n.__listeners[s].callback;n.__listeners[s].transformApplied=!0,n.__listeners.callback=i=>(i=n.__listeners[s].transform(i),r(i))}}},ar=(n,e,t)=>{n.post&&!n.__operator?n.__setOperator(n.post):!n.__operator&&typeof n.get=="function"&&n.__setOperator(n.get),!n.get&&n.__operator,n.aliases&&n.aliases.forEach(s=>{t.set(s,n);let r=i=>{t.__node.nodes.delete(s)};n.__addOndisconnected(r)}),typeof t.__node.roots?.[n.__node.tag]=="object"&&n.get&&(t.__node.roots[n.__node.tag].get=n.get)},yt={backprop:er,loop:tr,animate:sr,branching:rr,triggerListenerOncreate:ir,bindListener:nr,transformListenerResult:or,substitute__operator:ar};var lr=n=>{let e={};for(let t in n)typeof n[t]=="object"?e[t]=lr(n[t]):typeof n[t]=="function"?e[t]=n[t].toString():e[t]=n[t];return e};function Ki(n){typeof n!="string"&&(n=n.toString());let e=n.match(/\(?[^]*?\)?\s*=>/);if(e)return e[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let t=n.match(/\([^]*?\)/);return t?t[0].replace(/[()\s]/gi,"").split(","):[]}var cr=n=>{let e=n.indexOf("=>")+1;return e<=0&&(e=n.indexOf("){")),e<=0&&(e=n.indexOf(") {")),n.slice(0,n.indexOf("{",e)+1)};function mt(n=""){let e=i=>i.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=cr(n),s=e(n),r;if(t.includes("function")){let i=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));r=new Function(i,s)}else if(t.substring(0,6)===s.substring(0,6)){let i=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));r=new Function(i,s.substring(s.indexOf("{")+1,s.length-1))}else try{r=(0,eval)(n)}catch{}return r}function Zi(n="{}"){try{let e=typeof n=="string"?JSON.parse(n):n,t=s=>{for(let r in s)if(typeof s[r]=="string"){let i=mt(s[r]);typeof i=="function"&&(s[r]=i)}else typeof s[r]=="object"&&t(s[r]);return s};return t(e)}catch(e){console.error(e);return}}var fr=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function r(o,l){var c=e.length-1,u=e[c];if(typeof u=="object")if(u[o]===l||c===0)t.push(o),e.push(l.pushed);else for(;c-->=0;){if(u=e[c],typeof u=="object"&&u[o]===l){c+=2,e.length=c,t.length=c,--c,e[c]=l,t[c]=o;break}c--}}function i(o,l){if(l!=null&&typeof l=="object"){o&&r(o,l);let c=n.get(l);if(c)return"[Circular Reference]"+c;n.set(l,t.join("."))}return l}return function(l,c){try{return e.push(l),JSON.stringify(l,i,c)}finally{s()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=fr);var hr=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function r(o,l){var c=e.length-1,u=e[c];if(typeof u=="object")if(u[o]===l||c===0)t.push(o),e.push(l.pushed);else for(;c-->=0;){if(u=e[c],typeof u=="object"&&u[o]===l){c+=2,e.length=c,t.length=c,--c,e[c]=l,t[c]=o;break}c--}}function i(o,l){if(l!=null&&typeof l=="object"){o&&r(o,l);let c=n.get(l);if(c)return"[Circular Reference]"+c;n.set(typeof l=="function"?l.toString():l,t.join("."))}return typeof l=="function"?l.toString():l}return function(l,c){try{return e.push(l),JSON.stringify(l,i,c)}finally{s()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=hr);var ur=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function r(o,l){var c=e.length-1;if(e[c]){var u=e[c];if(typeof u=="object")if(u[o]===l||c===0)t.push(o),e.push(l.pushed);else for(;c-->=0;){if(u=e[c],typeof u=="object"&&u[o]===l){c+=2,e.length=c,t.length=c,--c,e[c]=l,t[c]=o;break}c++}}}function i(o,l){let c;if(l!=null)if(typeof l=="object"){let u=l.constructor.name;o&&u==="Object"&&r(o,l);let p=n.get(l);if(p)return"[Circular Reference]"+p;if(n.set(l,t.join(".")),u==="Array")l.length>20?c=l.slice(l.length-20):c=l;else if(u.includes("Set"))c=Array.from(l);else if(u!=="Object"&&u!=="Number"&&u!=="String"&&u!=="Boolean")c="instanceof_"+u;else if(u==="Object"){let g={};for(let v in l)if(l[v]==null)g[v]=l[v];else if(Array.isArray(l[v]))l[v].length>20?g[v]=l[v].slice(l[v].length-20):g[v]=l[v];else if(l[v].constructor.name==="Object"){g[v]={};for(let w in l[v])if(Array.isArray(l[v][w]))l[v][w].length>20?g[v][w]=l[v][w].slice(l[v][w].length-20):g[v][w]=l[v][w];else if(l[v][w]!=null){let A=l[v][w].constructor.name;A.includes("Set")?g[v][w]=Array.from(l[v][w]):A!=="Number"&&A!=="String"&&A!=="Boolean"?g[v][w]="instanceof_"+A:g[v][w]=l[v][w]}else g[v][w]=l[v][w]}else{let w=l[v].constructor.name;w.includes("Set")?g[v]=Array.from(l[v]):w!=="Number"&&w!=="String"&&w!=="Boolean"?g[v]="instanceof_"+w:g[v]=l[v]}c=g}else c=l}else c=l;return c}return function(l,c){e.push(l);let u=JSON.stringify(l,i,c);return s(),u}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=ur);function Xi(n){if(typeof n.__methods=="object")for(let e in n.__methods){let t=n.__methods[e],s=typeof t=="function"?t:mt(t);e==="__operator"?n.__setOperator(s):n[e]=s.bind(n)}}var he=class extends _e{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({...yt},e.loaders):{...yt}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((i,o)=>{this.get(o)?this.set(t+"."+o,i):this.set(o,i)}),this.__node.nodes.forEach((i,o)=>{e[t].__node.nodes.get(o)||e[t].__node.nodes.set(o,i)});let s=this.set;this.set=(i,o)=>(e[t].set(i,o),s(i,o));let r=this.delete;this.delete=i=>(e[t].delete(i),r(i))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,s)=>{let r=t,i=this.__node.nodes.get(e);if(i||(i=this.__node.roots[e]),i?.[r])if(typeof i[r]!="function"){if(s){Array.isArray(s)&&s.length===1?i[r]=s[0]:i[r]=s;return}return i[r]}else return Array.isArray(s)?i[r](...s):i[r](s);else return this.handleServiceMessage({route:e,args:s,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let s=t.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,s,r,i)=>{if(e instanceof W)return i?this.subscribe(e,o=>{let l=i(o);l!==void 0?this.transmit({route:t,args:l,method:r}):this.transmit({route:t,args:o,method:r},s)}):this.subscribe(e,o=>{this.transmit({route:t,args:o,method:r},s)});if(typeof e=="string")return this.subscribe(e,o=>{this.transmit({route:t,args:o,method:r},s)})};pipeOnce=(e,t,s,r,i)=>{if(e instanceof W)return i?e.__node.state.subscribeEventOnce(e.__node.unique,o=>{let l=i(o);l!==void 0?this.transmit({route:t,args:l,method:r}):this.transmit({route:t,args:o,method:r},s)}):this.__node.state.subscribeEventOnce(e.__node.unique,o=>{this.transmit({route:t,args:o,method:r},s)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,o=>{this.transmit({route:t,args:o,method:r},s)})};terminate=(...e)=>{};isTypedArray=dr;recursivelyAssign=bt;spliceTypedArray=_r;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),!0);error=(...e)=>(console.error(...e),!0)};function dr(n){return ArrayBuffer.isView(n)&&Object.prototype.toString.call(n)!=="[object DataView]"}var bt=(n,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?n[t]?.constructor.name==="Object"&&!Array.isArray(n[t])?bt(n[t],e[t]):n[t]=bt({},e[t]):n[t]=e[t];return n};function _r(n,e,t){let s=n.subarray(0,e),r;t&&(r=n.subarray(t+1));let i;return(s.length>0||r?.length>0)&&(i=new n.constructor(s.length+r.length)),i&&(s.length>0&&i.set(s),r&&r.length>0&&i.set(r,s.length)),i}(()=>{var n=class{data={};triggers={};ctr=0;constructor(f){typeof f=="object"&&(this.data=f)}setState=f=>{Object.assign(this.data,f);let a=Object.getOwnPropertyNames(f);for(let h of a)this.triggerEvent(h,this.data[h]);if(this.triggers[e]){let h=_=>{_(f)},d=this.triggers[e].length;for(let _=d-1;_>=0;_--)h(this.triggers[e][_].onchange)}return this.data};setValue=(f,a)=>{this.data[f]=a,this.triggerEvent(f,a)};triggerEvent=(f,a)=>{if(this.triggers[f]){let h=_=>{_.onchange(a)},d=this.triggers[f].length;for(let _=d-1;_>=0;_--)h(this.triggers[f][_])}};subscribeState=f=>this.subscribeEvent(e,f);unsubscribeState=f=>this.unsubscribeEvent(e,f);subscribeEvent=(f,a,h,d)=>{if(f){h&&d&&!this.triggers[f]&&Object.defineProperty(this.data,f,{get:()=>h[d],set:y=>{h[d]=y},enumerable:!0,configurable:!0}),this.triggers[f]||(this.triggers[f]=[]);let _=this.ctr;return this.ctr++,this.triggers[f].push({sub:_,onchange:a}),_}else return};unsubscribeEvent=(f,a)=>{let h=this.triggers[f];if(h)if(a===void 0)delete this.triggers[f],delete this.data[f];else{let d,_=h.find((y,m)=>{if(y.sub===a)return d=m,!0});return _&&h.splice(d,1),Object.keys(h).length===0&&(delete this.triggers[f],delete this.data[f]),this.onRemoved&&this.onRemoved(_),!0}};subscribeEventOnce=(f,a)=>{let h,d=_=>{a(_),this.unsubscribeEvent(f,h)};return h=this.subscribeEvent(f,d),h};getEvent=(f,a)=>{if(typeof a!="number")return this.triggers[f];for(let h in this.triggers[f])if(this.triggers[f][h].sub===a)return this.triggers[f][h]};getSnapshot=()=>{let f={};for(let a in this.data)f[a]=this.data[a]};onRemoved},e="*s",t=new n,s=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},r=class gr{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:t};__children;__parent;__operator;__listeners;__props;__args;constructor(a,h,d){if(this.__setProperties(a,h,d),typeof a=="function"||a?.__callable){let _=new s;_.__call=(...m)=>this.__operator(...m);let y=new Proxy(_,{get:(m,b,S)=>Reflect.has(this,b)?Reflect.get(this,b,S):Reflect.get(m,b,S),set:(m,b,S,O)=>Reflect.has(this,b)?Reflect.set(this,b,S,O):Reflect.set(m,b,S,O)});return Object.setPrototypeOf(y,this),y}}get __graph(){return this.__node?.graph}set __graph(a){this.__node.graph=a}__setProperties=(a,h,d)=>{if((()=>{let _=a;typeof a=="function"?u(a)?a=new a:a={__operator:a,__node:{forward:!0,tag:a.name}}:typeof a=="string"&&d?.get(a)&&(a=d.get(a)),"__node"in a||(a.__node={}),a.__node.initial||(a.__node.initial=_)})(),typeof a=="object"){let _=()=>{a.__node?.state?this.__node.state=a.__node.state:d&&(a.__node.state=d.__node.state)},y=()=>{a.__props&&(typeof a.__props=="function"&&(a.__props=new a.__props),typeof a.__props=="object"&&this.__proxyObject(a.__props))},m=()=>{a.__node.tag||(a.__operator?.name?a.__node.tag=a.__operator.name:a.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},b=()=>{typeof a.__node=="string"?d?.get(a.__node.tag)?a=d.get(a.__node.tag):a.__node={}:a.__node||(a.__node={}),d&&(a.__node.graph=d),a instanceof i&&(a.__node.source=a)},S=()=>{if(!a.__parent&&h&&(a.__parent=h),h?.__node&&!(h instanceof i||a instanceof i)&&(a.__node.tag=h.__node.tag+"."+a.__node.tag),h instanceof i&&a instanceof i&&(a.__node.loaders&&Object.assign(h.__node.loaders?h.__node.loaders:{},a.__node.loaders),h.__node.mapGraphs)){a.__node.nodes.forEach(E=>{h.set(a.__node.tag+"."+E.__node.tag,E)});let k=()=>{a.__node.nodes.forEach(E=>{h.__node.nodes.delete(a.__node.tag+"."+E.__node.tag)})};this.__addOndisconnected(k)}},O=()=>{if(typeof a.default=="function"&&!a.__operator&&(a.__operator=a.default),a.__operator){if(typeof a.__operator=="string"&&d){let k=d.get(a.__operator);k&&(a.__operator=k.__operator),!a.__node.tag&&a.__operator.name&&(a.__node.tag=a.__operator.name)}typeof a.__operator=="function"&&(a.__operator=this.__setOperator(a.__operator)),a.default&&(a.default=a.__operator)}},T=()=>{a.__node=Object.assign(this.__node,a.__node);let k=Object.getOwnPropertyNames(a).filter(E=>{if(!w[E])return!0});for(let E of k)E in a&&E!=="name"&&(this[E]=a[E])},x=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(k=>k.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(k=>k.bind(this))))};_(),m(),y(),b(),S(),T(),x(),O()}};__subscribe=(a,h,d,_,y,m,b)=>{let S=(T,x=(E,R)=>R||E,k=a)=>{let E;if(m){let $=v(k,m,this.__node.graph);k=$.__callback,E=$.__args}let R=this.__node.state.subscribeEvent(T,k,this,h),z=this.__node.state.getEvent(T,R);return this.__listeners||(this.__listeners={}),this.__listeners[T]=this.__node.state.triggers[T],z&&(z.source=this.__node.tag,h&&(z.key=h),z.target=x(a,_),y&&(z.tkey=y),d&&(z.subInput=d),m&&(z.arguments=E,z.__args=m),b&&(z.__callback=b),z.node=this,z.graph=this.__node.graph),R},O=T=>{let x=this.__node.graph.get(T);if(!x&&T.includes(".")){_=T.substring(0,T.lastIndexOf("."));let k=this.__node.graph.get(T.substring(0,_));y=T.lastIndexOf(".")+1,k&&typeof k[h]=="function"&&(T=(...E)=>k[y](...E))}else x.__operator&&(T=x.__operator,y="__operator");return T};if(h){if((!this.__node.localState||!this.__node.localState[h])&&this.__addLocalState(this,h),typeof a=="string"){if(b=this.__node.tag+"."+a,y=a,_){if(this.__node.graph?.get(_)){let k=this.__node.graph?.get(_);if(typeof k[a]=="function"){let E=k[a];a=(...R)=>{E(...R)}}else{let E=a;a=R=>{k[E]=R}}}}else if(typeof this[a]=="function"){let k=this[a];a=(...E)=>{k(...E)}}else this.__node.graph?.get(a)&&(a=O(a));if(typeof a!="function")return}let T,x=d?this.__node.unique+"."+h+"input":this.__node.unique+"."+h;return typeof a=="function"&&!a?.__node?T=S(x,(k,E)=>E||k,a):a?.__node&&(T=S(x,(k,E)=>E||k.__node.unique,(...k)=>{a.__operator&&a.__operator(...k)})),T}else{if(typeof a=="string"&&(b=a,_||(_=a),this.__node.graph.get(a)&&(a=this.__node.graph.get(a)),y="__operator",typeof a!="object"))return;let T,x=d?this.__node.unique+"input":this.__node.unique;return typeof a=="function"&&!a?.__node?T=S(x,(k,E)=>E||k,a):a?.__node&&(T=S(x,(k,E)=>E||k.__node.unique,(...k)=>{a.__operator&&a.__operator(...k)})),T}};__unsubscribe=(a,h,d)=>h?this.__node.state.unsubscribeEvent(d?this.__node.unique+"."+h+"input":this.__node.unique+"."+h,a):this.__node.state.unsubscribeEvent(d?this.__node.unique+"input":this.__node.unique,a);__setOperator=a=>{a=a.bind(this),this.__args&&this.__node.graph&&(a=v(a,this.__args,this.__node.graph).__callback);let h=`${this.__node.unique}input`;if(this.__operator=(...d)=>{this.__node.state.triggers[h]&&this.__node.state.setValue(h,d);let _=a(...d);return this.__node.state.triggers[this.__node.unique]&&(typeof _?.then=="function"?_.then(y=>{y!==void 0&&this.__node.state.setValue(this.__node.unique,y)}).catch(console.error):_!==void 0&&this.__node.state.setValue(this.__node.unique,_)),_},this.__parent instanceof gr&&!this.__subscribedToParent&&this.__parent.__operator){let d=this.__parent.__subscribe(this),_=()=>{this.__parent?.__unsubscribe(d),delete this.__subscribedToParent};this.__addOndisconnected(_),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(a,h)=>{if(!a)return;this.__node.localState||(this.__node.localState={});let d=this.__node.localState,_=(y,m)=>{let b=this.__node.unique+"."+m,S=`${b}input`,O,T,x,k;if(typeof y[m]=="function"&&m!=="__operator")this.__props?.[m]?x=this.__props:x=d,O=()=>x[m],T=E=>{this.__props?.[m]||(E=E.bind(this)),x[m]=(...R)=>{this.__node.state.triggers[S]&&this.__node.state.setValue(S,R);let z=E(...R);return this.__node.state.triggers[b]&&(typeof z?.then=="function"?z.then($=>{this.__node.state.triggerEvent(b,$)}).catch(console.error):this.__node.state.triggerEvent(b,z)),z}},d[m]=y[m].bind(this),k={get:O,set:T,enumerable:!0,configurable:!0};else if(m!=="__graph"){let E,R,z;this.__props?.[m]?z=this.__props:z=d,E=()=>z[m],R=$=>{z[m]=$,this.__node.state.triggers[b]&&this.__node.state.triggerEvent(b,$)},d[m]=y[m],k={get:E,set:R,enumerable:!0,configurable:!0}}if(Object.defineProperty(y,m,k),typeof this.__node.initial=="object"){let E=Object.getOwnPropertyDescriptor(this.__node.initial,m);(E===void 0||E?.configurable)&&Object.defineProperty(this.__node.initial,m,k)}};if(h)_(a,h);else for(let y in a)_(a,y)};__proxyObject=a=>{let h=l(a);for(let d of h){let _={get:()=>a[d],set:y=>{a[d]=y},enumerable:!0,configurable:!0};if(Object.defineProperty(this,d,_),typeof this.__node.initial=="object"){let y=Object.getOwnPropertyDescriptor(this.__node.initial,d);(y===void 0||y?.configurable)&&Object.defineProperty(this.__node.initial,d,_)}}};__addOnconnected(a){a=a.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(a):typeof this.__onconnected=="function"?this.__onconnected=[a,this.__onconnected]:this.__onconnected=a}__addOndisconnected(a){a=a.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(a):typeof this.__ondisconnected=="function"?this.__ondisconnected=[a,this.__ondisconnected]:this.__ondisconnected=a}__callConnected(a=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let h=d=>{d(this)};this.__onconnected.forEach(h)}}__callDisconnected(a=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let h=d=>{d(this)};this.__ondisconnected.forEach(h)}}},i=class pr{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:t,roots:{}};constructor(a){this.init(a)}init=a=>{if(a){let h=Object.assign({},a);delete h.roots,o(this.__node,h),a.roots&&this.load(a.roots)}};load=(a,h=!1)=>{function d(m,b,S=!0,O=!0){if(O){m||(m={});for(let T in b)!T.startsWith("__")&&b[T]&&typeof b[T]=="object"?(m[T]=b[T],b[T]?.__children&&d({},b[T].__children,!1,!1)):typeof b[T]=="function"&&(m[T]=b[T]);d(m,b,!0,!1)}else if(b?.__children&&!S)b.__children?.constructor.name==="Object"?m.__children?.constructor.name==="Object"?m.__children=d(m.__children,b.__children,!0,!1):m.__children=d({},b.__children,!0,!1):m.__children=b.__children;else if(S)for(let T in b)!T.startsWith("__")&&b[T]&&typeof b[T]=="object"?(m[T]=Object.assign({},b[T]),b[T]?.__children&&(m[T].__children=d({},b[T].__children,!1,!1))):typeof b[T]=="function"&&(m[T]=b[T]);return m}this.__node.roots=d(this.__node.roots?this.__node.roots:{},a);let _=Object.assign({},a);_.__node&&delete _.__node;let y=this.recursiveSet(_,this,void 0,a,h);if(a.__node){if(!a.__node.tag)a.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(a.__node.tag)){let m=new r(a,this,this);this.set(m.__node.tag,m),this.runLoaders(m,this,a,a.__node.tag),m.__listeners&&(y[m.__node.tag]=m.__listeners)}}else a.__listeners&&this.setListeners(a.__listeners);return this.setListeners(y),_};setLoaders=(a,h)=>(h?this.__node.loaders=a:Object.assign(this.__node.loaders,a),this.__node.loaders);runLoaders=(a,h,d,_)=>{for(let y in this.__node.loaders)typeof this.__node.loaders[y]=="object"?(this.__node.loaders[y].init&&this.__node.loaders[y](a,h,this,this.__node.roots,d,_),this.__node.loaders[y].connected&&a.__addOnconnected(this.__node.loaders[y].connect),this.__node.loaders[y].disconnected&&a.__addOndisconnected(this.__node.loaders[y].disconnect)):typeof this.__node.loaders[y]=="function"&&this.__node.loaders[y](a,h,this,this.__node.roots,d,_)};add=(a,h,d=!0)=>{let _={};typeof h=="string"&&(h=this.get(h));let y;if(typeof a=="function"?u(a)?a.prototype instanceof r?(a=a.prototype.constructor(a,h,this),y=!0):a=new a:a={__operator:a,__callable:!0}:typeof a=="string"&&(a=this.__node.roots[a]),!a)return;if(!y){let S=Object.getOwnPropertyNames(a),O=Object.getOwnPropertyNames(Object.getPrototypeOf(a));S.push(...O),S=S.filter(x=>!w.includes(x));let T={};for(let x of S)T[x]=a[x];a=T}if(a.__node||(a.__node={}),a.__node.initial=a,typeof a=="object"&&this.get(a.__node.tag))if(d)this.remove(a.__node.tag,!0);else return;else if(a.__node.tag&&this.get(a.__node.tag))return this.get(a.__node.tag);let m,b=o({},a,2);if(y?m=a:m=new r(a,h,this),this.set(m.__node.tag,m),this.runLoaders(m,h,a,m.__node.tag),this.__node.roots[m.__node.tag]=b,m.__children&&(m.__children=Object.assign({},m.__children),this.recursiveSet(m.__children,m,_,m.__children)),m.__listeners){_[m.__node.tag]=Object.assign({},m.__listeners);for(let S in m.__listeners){let O=m.__listeners[S];m[S]&&(delete _[m.__node.tag][S],_[m.__node.tag][m.__node.tag+"."+S]=O),typeof O=="string"&&(m.__children?.[O]?_[m.__node.tag][S]=m.__node.tag+"."+O:h instanceof r&&(h.__node.tag===O||h.__node.tag.includes(".")&&h.__node.tag.split(".").pop()===O)&&(_[m.__node.tag][S]=h.__node.tag))}}return this.setListeners(_),m.__callConnected(),m};recursiveSet=(a,h,d={},_,y=!1)=>{let m=Object.getOwnPropertyNames(_).filter(S=>!w.includes(S)),b=Object.getOwnPropertyNames(Object.getPrototypeOf(_)).filter(S=>!w.includes(S));m.push(...b);for(let S of m){if(S.includes("__"))continue;let O=_[S];if(Array.isArray(O))continue;let T;if(typeof O=="function"?u(O)?(O=new O,O instanceof r&&(O=O.prototype.constructor(O,h,this),T=!0)):O={__operator:O,__callable:!0}:typeof O=="string"?this.__node.nodes.get(O)?O=this.__node.nodes.get(O):O=this.__node.roots[O]:typeof O=="boolean"&&(this.__node.nodes.get(S)?O=this.__node.nodes.get(S):O=this.__node.roots[S]),O&&typeof O=="object"){if(!T&&!(O instanceof r)){let R=Object.getOwnPropertyNames(O).filter(oe=>!w.includes(oe)),z=Object.getOwnPropertyNames(Object.getPrototypeOf(O)).filter(oe=>!w.includes(oe));z.splice(z.indexOf("constructor"),1),R.push(...z);let $={};for(let oe of R)$[oe]=O[oe];O=$}if(O.__node||(O.__node={}),O.__node.tag||(O.__node.tag=S),O.__node.initial||(O.__node.initial=a[S]),y&&this.get(O.__node.tag))this.remove(O.__node.tag,!0);else if(this.get(O.__node.tag)&&!(!(h instanceof pr)&&h?.__node)||h?.__node&&this.get(h.__node.tag+"."+O.__node.tag))continue;let x,k=!1,E=o({},O,2);if(T||O instanceof r?x=O:(x=new r(O,h,this),k=!0),!k&&O instanceof r&&!T&&h instanceof r){let R=this.subscribe(h.__node.tag,x.__node.tag),z=$=>{this.unsubscribe(h.__node.tag,R)};x.__addOndisconnected(z)}else if(x){if(this.set(x.__node.tag,x),this.runLoaders(x,h,a[S],S),a[S]=x,this.__node.roots[x.__node.tag]=E,x.__children&&(x.__children=Object.assign({},x.__children),this.recursiveSet(x.__children,x,d,x.__children)),x.__listeners){d[x.__node.tag]=Object.assign({},x.__listeners);for(let R in x.__listeners){let z=x.__listeners[R],$=R;x[R]&&(delete d[x.__node.tag][R],$=x.__node.tag+"."+R,d[x.__node.tag][$]=z),typeof z=="string"&&(x.__children?.[z]?d[x.__node.tag][$]=x.__node.tag+"."+z:h instanceof r&&(h.__node.tag===z||h.__node.tag.includes(".")&&h.__node.tag.split(".").pop()===z)&&(d[x.__node.tag][$]=h.__node.tag))}}x.__callConnected()}}}return d};remove=(a,h=!0)=>{if(this.unsubscribe(a),typeof a=="string"&&(a=this.get(a)),a instanceof r){this.delete(a.__node.tag),delete this.__node.roots[a.__node.tag],h&&this.clearListeners(a),a.__callDisconnected();let d=_=>{for(let y in _)this.unsubscribe(_[y]),this.delete(_[y].__node.tag),delete this.__node.roots[_[y].__node.tag],this.delete(y),delete this.__node.roots[y],_[y].__node.tag=_[y].__node.tag.substring(_[y].__node.tag.lastIndexOf(".")+1),h&&this.clearListeners(_[y]),_[y].__callDisconnected(),_[y].__children&&d(_[y].__children)};a.__children&&d(a.__children)}return a?.__node.tag&&a?.__parent&&(delete a?.__parent,a.__node.tag=a.__node.tag.substring(a.__node.tag.indexOf(".")+1)),a?.__node.graph&&(a.__node.graph=void 0),a};run=(a,...h)=>{if(typeof a=="string"){let d=this.get(a);if(!d&&a.includes(".")){if(d=this.get(a.substring(0,a.lastIndexOf("."))),typeof d?.[a.substring(a.lastIndexOf(".")+1)]=="function")return d[a.substring(a.lastIndexOf(".")+1)](...h)}else if(d?.__operator)return d.__operator(...h)}if(a?.__operator)return a?.__operator(...h)};setListeners=a=>{for(let h in a){let d=this.get(h);if(typeof a[h]=="object")for(let _ in a[h]){let y=this.get(_),m;if(typeof a[h][_]!="object")a[h][_]={__callback:a[h][_]};else if(!a[h][_].__callback)for(let b in a[h][_]){typeof a[h][_][b]!="object"&&(a[h][_][b]={__callback:a[h][_][b]},d.__operator&&(a[h][_][b].__callback===!0||typeof a[h][_][b].__callback>"u")&&(a[h][_][b].__callback=d.__operator));let S=this.get(b);if(S)m=this.subscribe(S,a[h][_][b].__callback,a[h][_][b].__args,void 0,a[h][_][b].subInput,h);else{let O=_.substring(0,_.lastIndexOf("."));if(S=this.get(O),S){let T=_.substring(_.lastIndexOf(".")+1);m=this.subscribe(S,a[h][_][b].__callback,a[h][_][b].__args,T,a[h][_][b].subInput,h)}}}if("__callback"in a[h][_])if(d&&((a[h][_].__callback===!0||typeof a[h][_].__callback>"u")&&(a[h][_].__callback=d.__operator),typeof a[h][_].__callback=="function"&&(a[h][_].__callback=a[h][_].__callback.bind(d))),y)m=this.subscribe(y,a[h][_].__callback,a[h][_].__args,void 0,a[h][_].subInput,h);else{let b=_.substring(0,_.lastIndexOf("."));y=this.get(b),y&&(m=this.subscribe(y,a[h][_].__callback,a[h][_].__args,_.substring(_.lastIndexOf(".")+1),a[h][_].subInput,h))}}}};clearListeners=(a,h)=>{if(typeof a=="string"&&(a=this.get(a)),a?.__listeners)for(let d in a.__listeners){if(h&&d!==h||typeof a.__listeners[d]?.sub!="number")continue;let _=this.get(d);if(_)if(typeof!a.__listeners[d]?.__callback=="number")for(let y in a.__listeners[d])a.__listeners[d][y]?.sub&&(this.unsubscribe(_,a.__listeners[d][y].sub,void 0,a.__listeners[d][y].subInput),a.__listeners[d][y].sub=void 0);else typeof a.__listeners[d]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d].sub,void 0,a.__listeners[d].subInput),a.__listeners[d].sub=void 0);else if(_=this.get(d.substring(0,d.lastIndexOf("."))),_)if(typeof a.__listeners[d]=="object"&&!a.__listeners[d]?.__callback)for(let y in a.__listeners[d])typeof a.__listeners[d][y]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d][y].sub,d.substring(d.lastIndexOf(".")+1),a.__listeners[d][y].subInput),a.__listeners[d][y].sub=void 0);else typeof a.__listeners[d]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d].sub,d.substring(d.lastIndexOf(".")+1),a.__listeners[d].subInput),a.__listeners[d].sub=void 0)}};get=a=>this.__node.nodes.get(a);getByUnique=a=>Array.from(this.__node.nodes.values()).find(h=>{if(h.__node.unique===a)return!0});set=(a,h)=>this.__node.nodes.set(a,h);delete=a=>this.__node.nodes.delete(a);list=()=>Array.from(this.__node.nodes.keys());getListener=(a,h,d)=>{let _=this.get(a);if(_){let y=_.__node.unique;return h&&(y+="."+h),this.__node.state.getEvent(y,d)}};getProps=(a,h)=>{if(typeof a=="string"&&(a=this.get(a)),a instanceof r){let d;if(h)d=Object.assign({},this.__node.roots[a.__node.tag]);else{d=Object.assign({},a);for(let _ in d)_.includes("__")&&delete d[_]}}};subscribe=(a,h,d,_,y,m,b)=>{let S=a;typeof a=="string"&&(S=this.get(a),!S&&a.includes(".")&&(S=this.get(a.substring(0,a.lastIndexOf("."))),_=a.substring(a.lastIndexOf(".")+1))),m instanceof r&&(m=m.__node.tag);let O;if(typeof h=="string"){O=h;let x=k=>{if(this.get(k)?.__operator){let E=this.get(k);m=k,k=function(...R){return E.__operator(...R)}}else if(k.includes(".")){m=k.substring(0,k.lastIndexOf("."));let E=this.get(m),R=k.substring(k.lastIndexOf(".")+1);b=R,typeof E[R]=="function"?E[R]instanceof r?k=E[R]:k=function(...z){return E[R](...z)}:k=function(z){return E[R]=z,E[R]}}return k};if(m){let k=this.get(m);typeof k?.[h]=="function"?(b=h,h=function(...E){return k[_](...E)}):k?.[_]?(b=_,k[_]instanceof r?h=k[_]:h=function(E){return k[_]=E,k[_]}):h=x(h)}else h=x(h)}let T;if(S instanceof r){let x=()=>{T=S.__subscribe(h,_,y,m,b,d,O);let k=()=>{T!==void 0&&S.__unsubscribe(T,_,y),T=void 0};S.__addOndisconnected(()=>{k(),S.__addOnconnected(()=>{T===void 0&&S.__node.graph.__node.tag===this.__node.tag&&x()})}),typeof h=="string"&&this.get(h)&&(h=this.get(h)),h instanceof r&&h.__addOndisconnected(()=>{k()})};x()}else if(typeof a=="string"){let x=this.get(a);if(x){if(h instanceof r&&h.__operator){let k=()=>{T=x.__subscribe(h.__operator,_,y,m,b,d,O);let E=()=>{T!==void 0&&x.__unsubscribe(T,_,y)};x.__addOndisconnected(()=>{E(),x.__addOnconnected(()=>{T===void 0&&x.__node.graph.__node.tag===this.__node.tag&&k()})}),h.__addOndisconnected(E)};k()}else if(typeof h=="function"||typeof h=="string"){let k=()=>{T=x.__subscribe(h,_,y,m,b,d,O);let E=()=>{T!==void 0&&x.__unsubscribe(T,_,y),T=void 0};x.__addOndisconnected(()=>{E(),x.__addOnconnected(()=>{T===void 0&&x.__node.graph.__node.tag===this.__node.tag&&k()})}),typeof h=="string"&&this.get(h)&&this.get(h).__addOndisconnected(E)};k()}}else typeof h=="string"&&(h=this.__node.nodes.get(h).__operator),typeof h=="function"&&!h?.__node&&(T=this.__node.state.subscribeEvent(a,h))}return T};unsubscribe=(a,h,d,_)=>a instanceof r?a.__unsubscribe(h,d,_):this.get(a)?.__unsubscribe(h,d,_);setState=a=>{this.__node.state.setState(a)}};function o(f,a,h=1/0,d=0){for(let _ in a)a[_]?.constructor.name==="Object"&&d<h?(d++,f[_]?.constructor.name==="Object"?o(f[_],a[_],h,d):f[_]=o({},a[_],h,d)):f[_]=a[_];return f}function l(f){var a=[],h=f;do{var d=Object.getOwnPropertyNames(h);let _=function(y){a.indexOf(y)===-1&&a.push(y)};d.forEach(_)}while(h=Object.getPrototypeOf(h));return a}function c(f){let a=l(f),h={};for(let d of a)h[d]=f[d];return h}function u(f){return p(f)==="class"}function p(f){return typeof f=="function"?f.prototype?Object.getOwnPropertyDescriptor(f,"prototype")?.writable?"function":"class":f.constructor.name==="AsyncFunction"?"async":"arrow":""}var g=(f,a)=>{if(a.get(f)?.__operator){let h=a.get(f);return(...d)=>{h.__operator(...d)}}else if(f.includes(".")){let h=f.split("."),d=h.pop(),_=h.join("."),y=a.get(_);return typeof a.get(_)?.[d]=="function"?(...m)=>y[d](...m):()=>y[d]}else if(a.get(f)){let h=a.get(f);return()=>h}else{let h=f;return()=>h}},v=(f,a,h)=>{let d=[],_=(m,b)=>{if(m==="__output"||m==="__input"||m==="__callback")d[b]={__callback:S=>S,__args:void 0,idx:b};else if(typeof m=="string")d[b]={__callback:g(m,h),__args:void 0,idx:b};else if(typeof m=="function"){let S=m;d[b]={__callback:(...O)=>S(...O),__args:void 0,idx:b}}else if(typeof m=="object"&&(m.__input||m.__callback)){let S=function(O){let T=O.__input?O.__input:O.__callback;if(typeof O.__input=="string"&&(T={__callback:g(O.__input,h),__args:void 0,idx:b}),O.__args){let x=v(T,O.__args,h);T={__callback:x.__callback,__args:x.__args,idx:b}}else T={__callback:T,__args:void 0,idx:b};if(O.__output){let x=O.__output;if(typeof O.__output=="string"?x={__callback:g(x,h),__args:void 0,idx:b}:typeof m.__output=="object"&&(x=S(x)),typeof x?.__callback=="function"){let k=T.__callback,E=x.__callback;T={__callback:(...R)=>E(k(...R)),__args:x.__args,idx:b}}}return T};d[b]=S(m)}else{let S=m;d[b]={__callback:()=>S,__args:void 0,idx:b}}};a.forEach(_),typeof f=="string"&&(f={__callback:g(f,h),__args:void 0});let y=typeof f=="function"?f:f.__callback;return f=function(...m){let b=S=>S.__callback(...m);return y(...d.map(b))},{__callback:f,__args:d}},w=Object.getOwnPropertyNames(Object.getPrototypeOf({})),A=(f,a,h)=>{f.__node.backward&&a instanceof r&&h.setListeners({[a.__node.tag]:{[f.__node.tag]:a}})},j=(f,a,h)=>{if(f.__operator){let d=Math.random();if(f.__node.loops||(f.__node.loops={}),typeof f.__node.delay=="number"){let _=f.__operator;f.__setOperator((...y)=>new Promise((m,b)=>{f.__node.loops[d]=setTimeout(async()=>{m(await _(...y))},f.__node.delay)}))}else if(f.__node.frame===!0){let _=f.__operator;f.__setOperator((...y)=>new Promise((m,b)=>{f.__node.loops[d]=requestAnimationFrame(async()=>{m(await _(...y))})}))}if(typeof f.__node.repeat=="number"||typeof f.__node.recursive=="number"){let _=f.__operator;f.__setOperator(async(...y)=>{let m=f.__node.repeat?f.__node.repeat:f.__node.recursive,b,S=async(O,...T)=>{for(;O>0;){if(f.__node.delay||f.__node.frame){_(...T).then(async x=>{f.__node.recursive?await S(O,x):await S(O,...T)});break}else b=await _(...y);O--}};return await S(m,...y),b})}if(f.__node.loop&&typeof f.__node.loop=="number"){let _=f.__operator,y=f.__node.loop;f.__setOperator((...b)=>{if("looping"in f.__node||(f.__node.looping=!0),f.__node.looping){let S=performance.now();_(...b),f.__node.loops[d]=setTimeout(()=>{let O=performance.now()-S-f.__node.loop;O>0?y=f.__node.loop-O:y=f.__node.loop,y<=0&&(y=f.__node.loop),f.__operator(...b)},y)}}),f.__node.looping&&f.__operator();let m=b=>{b.__node.looping&&(b.__node.looping=!1),b.__node.loops[d]&&(clearTimeout(b.__node.loops[d]),cancelAnimationFrame(b.__node.loops[d]))};f.__addOndisconnected(m)}}},F=(f,a,h)=>{if(f.__node.animate===!0||f.__animation){let d=f.__operator;f.__setOperator((...y)=>{"animating"in f.__node||(f.__node.animating=!0),f.__node.animating&&(typeof f.__animation=="function"?f.__animation(...y):d(...y),f.__node.animationFrame=requestAnimationFrame(()=>{f.__operator(...y)}))}),(f.__node.animating||(!("animating"in f.__node)||f.__node.animating)&&f.__animation)&&setTimeout(()=>{f.__node.animationFrame=requestAnimationFrame(f.__operator)},10);let _=y=>{y.__node.animating&&(y.__node.animating=!1),y.__node.animationFrame&&cancelAnimationFrame(y.__node.animationFrame)};f.__addOndisconnected(_)}},D=(f,a,h)=>{if(typeof f.__branch=="object"&&f.__operator&&!f.__branchApplied){let d=f.__operator;f.__branchApplied=!0,f.__operator=(..._)=>{let y=d(..._);for(let m in f.__branch){let b=()=>{typeof f.__branch[m].then=="function"?f.__branch[m].then(y):f.__branch[m].then instanceof r&&f.__branch[m].then.__operator?f.__branch[m].then.__operator(y):y=f.__branch[m].then};typeof f.__branch[m].if=="function"?f.__branch[m].if(y)==!0&&b():f.__branch[m].if===y&&b()}return y}}if(f.__listeners){for(let d in f.__listeners)if(typeof f.__listeners[d]=="object"&&f.__listeners[d].branch&&!f.__listeners[d].branchApplied){let _=f.__listeners[d].callback;f.__listeners[d].branchApplied=!0,f.__listeners.callback=y=>{let m=()=>{typeof f.__listeners[d].branch.then=="function"?y=f.__listeners[d].branch.then(y):f.__listeners[d].branch.then instanceof r&&f.__listeners[d].branch.then.__operator?y=f.__listeners[d].branch.then.__operator(y):y=f.__listeners[d].branch.then};return typeof f.__listeners[d].branch.if=="function"?f.__listeners[d].branch.if(y)&&m():f.__listeners[d].branch.if===y&&m(),_(y)}}}},B=(f,a,h)=>{if(f.__listeners)for(let d in f.__listeners)typeof f.__listeners[d]=="object"&&f.__listeners[d].oncreate&&f.__listeners[d].callback(f.__listeners[d].oncreate)},I=(f,a,h)=>{if(f.__listeners)for(let d in f.__listeners)typeof f.__listeners[d]=="object"&&typeof f.__listeners[d].binding=="object"&&(f.__listeners.callback=f.__listeners.callback.bind(f.__listeners[d].binding))},L=(f,a,h)=>{if(f.__listeners){for(let d in f.__listeners)if(typeof f.__listeners[d]=="object"&&typeof f.__listeners[d].transform=="function"&&!f.__listeners[d].transformApplied){let _=f.__listeners[d].callback;f.__listeners[d].transformApplied=!0,f.__listeners.callback=y=>(y=f.__listeners[d].transform(y),_(y))}}},C=(f,a,h)=>{f.post&&!f.__operator?f.__setOperator(f.post):!f.__operator&&typeof f.get=="function"&&f.__setOperator(f.get),!f.get&&f.__operator,f.aliases&&f.aliases.forEach(d=>{h.set(d,f);let _=y=>{h.__node.nodes.delete(d)};f.__addOndisconnected(_)}),typeof h.__node.roots?.[f.__node.tag]=="object"&&f.get&&(h.__node.roots[f.__node.tag].get=f.get)},N={backprop:A,loop:j,animate:F,branching:D,triggerListenerOncreate:B,bindListener:I,transformListenerResult:L,substitute__operator:C},U=f=>{let a={};for(let h in f)typeof f[h]=="object"?a[h]=U(f[h]):typeof f[h]=="function"?a[h]=f[h].toString():a[h]=f[h];return a};function G(f){typeof f!="string"&&(f=f.toString());let a=f.match(/\(?[^]*?\)?\s*=>/);if(a)return a[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let h=f.match(/\([^]*?\)/);return h?h[0].replace(/[()\s]/gi,"").split(","):[]}var q=f=>{let a=f.indexOf("=>")+1;return a<=0&&(a=f.indexOf("){")),a<=0&&(a=f.indexOf(") {")),f.slice(0,f.indexOf("{",a)+1)};function V(f=""){let a=y=>y.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),h=q(f),d=a(f),_;if(h.includes("function")){let y=h.substring(h.indexOf("(")+1,h.lastIndexOf(")"));_=new Function(y,d)}else if(h.substring(0,6)===d.substring(0,6)){let y=h.substring(h.indexOf("(")+1,h.lastIndexOf(")"));_=new Function(y,d.substring(d.indexOf("{")+1,d.length-1))}else try{_=(0,eval)(f)}catch{}return _}function X(f="{}"){try{let a=typeof f=="string"?JSON.parse(f):f,h=d=>{for(let _ in d)if(typeof d[_]=="string"){let y=V(d[_]);typeof y=="function"&&(d[_]=y)}else typeof d[_]=="object"&&h(d[_]);return d};return h(a)}catch(a){console.error(a);return}}var le=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1,O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S--}}function y(m,b){if(b!=null&&typeof b=="object"){m&&_(m,b);let S=f.get(b);if(S)return"[Circular Reference]"+S;f.set(b,h.join("."))}return b}return function(m,b){try{return a.push(m),JSON.stringify(m,y,b)}finally{d()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=le);var Pe=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1,O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S--}}function y(m,b){if(b!=null&&typeof b=="object"){m&&_(m,b);let S=f.get(b);if(S)return"[Circular Reference]"+S;f.set(typeof b=="function"?b.toString():b,h.join("."))}return typeof b=="function"?b.toString():b}return function(m,b){try{return a.push(m),JSON.stringify(m,y,b)}finally{d()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=Pe);var Te=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1;if(a[S]){var O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S++}}}function y(m,b){let S;if(b!=null)if(typeof b=="object"){let O=b.constructor.name;m&&O==="Object"&&_(m,b);let T=f.get(b);if(T)return"[Circular Reference]"+T;if(f.set(b,h.join(".")),O==="Array")b.length>20?S=b.slice(b.length-20):S=b;else if(O.includes("Set"))S=Array.from(b);else if(O!=="Object"&&O!=="Number"&&O!=="String"&&O!=="Boolean")S="instanceof_"+O;else if(O==="Object"){let x={};for(let k in b)if(b[k]==null)x[k]=b[k];else if(Array.isArray(b[k]))b[k].length>20?x[k]=b[k].slice(b[k].length-20):x[k]=b[k];else if(b[k].constructor.name==="Object"){x[k]={};for(let E in b[k])if(Array.isArray(b[k][E]))b[k][E].length>20?x[k][E]=b[k][E].slice(b[k][E].length-20):x[k][E]=b[k][E];else if(b[k][E]!=null){let R=b[k][E].constructor.name;R.includes("Set")?x[k][E]=Array.from(b[k][E]):R!=="Number"&&R!=="String"&&R!=="Boolean"?x[k][E]="instanceof_"+R:x[k][E]=b[k][E]}else x[k][E]=b[k][E]}else{let E=b[k].constructor.name;E.includes("Set")?x[k]=Array.from(b[k]):E!=="Number"&&E!=="String"&&E!=="Boolean"?x[k]="instanceof_"+E:x[k]=b[k]}S=x}else S=b}else S=b;return S}return function(m,b){a.push(m);let S=JSON.stringify(m,y,b);return d(),S}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Te);function ze(f){if(typeof f.__methods=="object")for(let a in f.__methods){let h=f.__methods[a],d=typeof h=="function"?h:V(h);a==="__operator"?f.__setOperator(d):f[a]=d.bind(f)}}var ut=class extends i{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(f){super({...f,loaders:f?.loaders?Object.assign({...N},f.loaders):{...N}}),f?.services&&this.addServices(f.services),f?.restrict&&(this.restrict=f.restrict),this.load(this)}addServices=f=>{for(let a in f)if(typeof f[a]=="function"&&(f[a]=new f[a]),f[a]?.__node?.loaders&&Object.assign(this.__node.loaders,f[a].__node.loaders),f[a]?.__node?.nodes){f[a].__node.nodes.forEach((_,y)=>{this.get(y)?this.set(a+"."+y,_):this.set(y,_)}),this.__node.nodes.forEach((_,y)=>{f[a].__node.nodes.get(y)||f[a].__node.nodes.set(y,_)});let h=this.set;this.set=(_,y)=>(f[a].set(_,y),h(_,y));let d=this.delete;this.delete=_=>(f[a].delete(_),d(_))}else typeof f[a]=="object"&&this.load(f[a])};handleMethod=(f,a,h)=>{let d=a,_=this.__node.nodes.get(f);if(_||(_=this.__node.roots[f]),_?.[d])if(typeof _[d]!="function"){if(h){Array.isArray(h)&&h.length===1?_[d]=h[0]:_[d]=h;return}return _[d]}else return Array.isArray(h)?_[d](...h):_[d](h);else return this.handleServiceMessage({route:f,args:h,method:a})};handleServiceMessage(f){let a;return typeof f=="object"&&(f.route?a=f.route:f.node&&(a=f.node)),a?Array.isArray(f.args)?this.run(a,...f.args):this.run(a,f.args):f}handleGraphNodeCall(f,a){if(!f)return a;if(a?.args)this.handleServiceMessage(a);else return Array.isArray(a)?this.run(f,...a):this.run(f,a)}transmit=(...f)=>{if(typeof f[0]=="object"){let a=f[0];if(a.method)return this.handleMethod(a.route,a.method,a.args);if(a.route)return this.handleServiceMessage(a);if(a.node)return this.handleGraphNodeCall(a.node,a.args);this.__node.keepState&&(a.route&&this.setState({[a.route]:a.args}),a.node&&this.setState({[a.node]:a.args}));return}else return};receive=(...f)=>{if(f[0]){let a=f[0];if(typeof a=="string"){let h=a.substring(0,8);(h.includes("{")||h.includes("["))&&(h.includes("\\")&&(a=a.replace(/\\/g,"")),a[0]==='"'&&(a=a.substring(1,a.length-1)),a=JSON.parse(a))}if(typeof a=="object"){if(a.method)return this.restrict?.[a.route]?void 0:this.handleMethod(a.route,a.method,a.args);if(a.route)return this.restrict?.[a.route]?void 0:this.handleServiceMessage(a);if(a.node)return typeof a.node=="string"&&this.restrict?.[a.node]?void 0:this.handleGraphNodeCall(a.node,a.args);this.__node.keepState&&(a.route&&this.setState({[a.route]:a.args}),a.node&&this.setState({[a.node]:a.args}));return}}};pipe=(f,a,h,d,_)=>{if(f instanceof r)return _?this.subscribe(f,y=>{let m=_(y);m!==void 0?this.transmit({route:a,args:m,method:d}):this.transmit({route:a,args:y,method:d},h)}):this.subscribe(f,y=>{this.transmit({route:a,args:y,method:d},h)});if(typeof f=="string")return this.subscribe(f,y=>{this.transmit({route:a,args:y,method:d},h)})};pipeOnce=(f,a,h,d,_)=>{if(f instanceof r)return _?f.__node.state.subscribeEventOnce(f.__node.unique,y=>{let m=_(y);m!==void 0?this.transmit({route:a,args:m,method:d}):this.transmit({route:a,args:y,method:d},h)}):this.__node.state.subscribeEventOnce(f.__node.unique,y=>{this.transmit({route:a,args:y,method:d},h)});if(typeof f=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(f).__node.unique,y=>{this.transmit({route:a,args:y,method:d},h)})};terminate=(...f)=>{};isTypedArray=Ie;recursivelyAssign=J;spliceTypedArray=ne;ping=()=>(console.log("pinged!"),"pong");echo=(...f)=>(this.transmit(...f),f);log=(...f)=>(console.log(...f),!0);error=(...f)=>(console.error(...f),!0)};function Ie(f){return ArrayBuffer.isView(f)&&Object.prototype.toString.call(f)!=="[object DataView]"}var J=(f,a)=>{for(let h in a)a[h]?.constructor.name==="Object"&&!Array.isArray(a[h])?f[h]?.constructor.name==="Object"&&!Array.isArray(f[h])?J(f[h],a[h]):f[h]=J({},a[h]):f[h]=a[h];return f};function ne(f,a,h){let d=f.subarray(0,a),_;h&&(_=f.subarray(h+1));let y;return(d.length>0||_?.length>0)&&(y=new f.constructor(d.length+_.length)),y&&(d.length>0&&y.set(d),_&&_.length>0&&y.set(_,d.length)),y}})();var Xt=class extends(void 0){name="router";connections={};sources={};services={};serviceConnections={};users={};userTimeout=1e4;order;constructor(e){if(super(e),this.load(this),e&&(e.order&&(this.order=e.order),e.timeout&&(this.userTimeout=e.timeout),e.graph))for(let t in e.graph){let s=e.graph[t];if(typeof s=="function"&&(s=new s),s?.__node?.nodes)s.name=t,s.__node.tag=t,this.addServices({[s.name]:s}),this.routeService(s,s.connections);else if(typeof s?.service=="function"&&(s.service=new s.service),s?.service?.__node?.nodes&&(s.service.name=t,s.service.__node.tag=t,this.addServices({[s.service.name]:s.service}),this.routeService(s.service)),typeof s?.service=="object"&&(s.connections&&(Array.isArray(s.connections)?s.connections.forEach(r=>{this.addServiceConnections(s[t].service,r)}):this.addServiceConnections(s.service,s.connections)),s.config))for(let r in s.config)this.openConnection(s.service,s.config[r],s.config[r].source,s.config[r].args)}}addUser=async(e,t,s,r)=>{let i;if(e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),this.users[e._id]?i=this.users[e._id]:i=Object.assign({},e),t){for(let o in t)typeof t[o]=="object"&&(t[o].connection._id||await new Promise((l,c)=>{let u=performance.now(),p=()=>{t[o].connection._id?l(!0):performance.now()-u>this.userTimeout?(delete t[o],c(!1)):setTimeout(()=>{p()},100)};p()}).catch(l=>{console.error("Connections timed out:",l)}));for(let o in t)t[o]=this.addConnection(t[o],i._id)}if(s)for(let o in s)this.openConnection(s[o].service,s[o],i._id,s[o].args);if(!this.users[e._id]){let o=(I,...L)=>{let C=this.getConnection(i._id,"send");if(C?.send)return C.send(I,...L)},l=(I,...L)=>{let C=this.getConnections(i._id,"send");for(let N in C)if(C[N]?.send)return C[N].send(I,...L)},c=(I,L,...C)=>{let N=this.getConnection(i._id,"request");if(N?.request)return N.request(I,L,...C)},u=(I,L,...C)=>{let N=this.getConnections(i._id,"request"),U=[];for(let G in N)N[G]?.request&&U.push(N[G].request(I,L,...C));return Promise.all(U)},p=(I,L,C,...N)=>{let U=this.getConnection(i._id,"post");if(U?.post)return U.post(I,L,C,...N)},g=(I,L,C,...N)=>{let U=this.getConnections(i._id,"post");for(let G in U)U[G]?.post&&U[G].post(I,L,C,...N)},v=(I,L,C,...N)=>{let U=this.getConnection(i._id,"run");if(U?.run)return U.run(I,L,C,...N)},w=(I,L,C,...N)=>{let U=this.getConnections(i._id,"run"),G=[];for(let q in U)U[q]?.run&&G.push(U[q].run(I,L,C,...N));return Promise.all(G)},A=(I,L,...C)=>{let N=this.getConnection(i._id,"subscribe");if(N?.subscribe)return N.subscribe(I,L,...C)},j=(I,L,...C)=>{let N=this.getConnections(i._id,"subscribe"),U=[];for(let G in N)N[G]?.post&&U.push(N[G].subscribe(I,L,...C));return Promise.all(U)},F=(I,L,...C)=>{let N=this.getConnection(i._id,"unsubscribe");if(N?.unsubscribe)return N.unsubscribe(I,L,...C)},D=(I,L,...C)=>{let N=this.getConnections(i._id,"unsubscribe"),U=[];for(let G in N)N[G]?.post&&L?.[G]&&U.push(N[G].unsubscribe(I,L[G],...C));return Promise.all(U)},B=()=>this.removeUser(i);i.send=o,i.request=c,i.post=p,i.run=v,i.subscribe=A,i.unsubscribe=F,i.terminate=B,i.sendAll=l,i.requestAll=u,i.postAll=g,i.runAll=w,i.subscribeAll=j,i.unsubscribeAll=D,i.terminateAll=B,this.users[i._id]=i}if(t&&!r){let o={},l=!1;Object.keys(t).map((c,u)=>{t[c]?._id&&(o[`${u}`]=t[c]?._id,l=!0)}),l&&i.send({route:"addUser",args:[{_id:i._id},o,void 0,!0]})}return i};removeUser(e,t){return t&&this.removeConnection(e,t),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}getConnection=(e,t,s)=>{if(this.connections[e])return this.connections[e];if(this.sources[e]){if(t?.includes("All"))return this.users[e];if(s)if(t){if(this.sources[e][s]?.[t])return this.sources[e][s]}else return this.sources[e][s]?this.sources[e][s]:void 0;else if(this.order)for(let r=0;r<this.order.length;r++){let i=this.order[r];for(let o in this.sources[e])if(this.sources[e][o].service){if(typeof this.sources[e][o].service=="object"){if(this.sources[e][o].service.__node.tag===i){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name&&!this.serviceConnections[this.sources[e][o].service.name]){this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}else if(this.sources[e][o].service===i){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name){this.serviceConnections[this.sources[e][o].service.name]||this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}}else for(let r in this.sources[e]){if(this.sources[e][r].connectionType&&this.sources[e][r].service?.name&&!this.serviceConnections[this.sources[e][r].service.name]){this.removeConnection(this.sources[e][r]);continue}if(t){if(this.sources[e][r][t])return this.sources[e][r]}else return this.sources[e][r]}}else if(this.order&&!this.connections[e])for(let r=0;r<this.order.length;r++){let i=this.order[r];if(this.sources[i]?.[e]){if(this.sources[i][e].connectionType&&this.sources[i][e].service?.name&&!this.serviceConnections[this.sources[i][e].service.service.name]){this.removeConnection(this.sources[i][e].service);continue}if(t){if(this.sources[i][e][t])return this.sources[i][e]}else return this.sources[i][e]}}};getConnections=(e,t,s)=>{if(this.sources[e]){if(!s&&!t)return this.sources[e];let r={};for(let i in this.sources[e])if(typeof this.sources[e][i]=="object"){if(this.sources[e][i]._id){let o=!0;if(t&&!this.sources[e][i][t]&&(o=!1),s)for(let l in s)if(typeof this.sources[e][i][l]=="object"&&typeof s[l]=="object"){for(let c in s[l])if(s[l][c]!==this.sources[e][i][l][c]){o=!1;break}}else if(this.sources[e][i][l]!==s[l])o=!1;else{o=!1;break}o&&(r[this.sources[e][i]._id]=this.sources[e][i])}else for(let o in this.sources[e][i])if(typeof this.sources[e][i][o]=="object"){let l=!0;if(t&&!this.sources[e][i][o][t]&&(l=!1),s)for(let c in s)if(typeof this.sources[e][i][o][c]=="object"&&typeof s[c]=="object"){for(let u in s[c])if(s[c][u]!==this.sources[e][i][o][c][u]){l=!1;break}}else if(this.sources[e][i][o][c]!==s[c])l=!1;else{l=!1;break}l&&(r[this.sources[e][i][o]._id]=this.sources[e][i][o])}}return r}};runConnection=async(e,t,s,r)=>{let i;if(t.indexOf("All")>-1?i=this.users[e]:i=this.getConnection(e,t,r),i){let o=i[t](...s);return o=await o,o}};subscribeThroughConnection=(e,t,s,r,...i)=>{if(typeof t=="string"&&(t=this.getConnection(t,"run")),typeof t=="object")return new Promise((o,l)=>{t.run("routeConnections",[e,s,t._id,...i]).then(c=>{this.__node.state.subscribeEvent(s,u=>{u?.callbackId===e&&(r?typeof r=="string"?this.setState({[r]:u.args}):r(u.args):this.setState({[s]:u.args}))}),o(c)}).catch(l)})};addConnection=(e,t,s=!0)=>{let r={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let i in this.serviceConnections)for(let o in this.serviceConnections[i])if(this.serviceConnections[i][o][e]){e={connection:this.serviceConnections[i][o][e]},e.service=i,r.connectionType=i,r.connectionsKey=o;break}typeof e=="string"&&this.__node.nodes.get(e)&&(e={connection:this.__node.nodes.get(e)})}if(!(!e||typeof e=="string")){if(t&&(r.source=t),e.connection instanceof void 0){r.connection=e.connection;let i=r.connection;r.send=async o=>o.method?Array.isArray(o.args)?i[o.method]?.(...o.args):i[o.method]?.(o.args):i.__operator?Array.isArray(o.args)?i.__operator(...o.args):i.__operator(o.args):void 0,r.request=async(o,l)=>l?Array.isArray(o.args)?i[l]?.(...o.args):i[l]?.(o.args):i.__operator?Array.isArray(o.args)?i.__operator(...o.args):i.__operator(o.args):void 0,r.post=async(o,l,c)=>{if(o&&i.__node.graph.get(o)){let u=i.__node.graph.get(o);return c?Array.isArray(l)?u[c]?.(...l):u[c]?.(l):Array.isArray(l)?u.__operator(...l):u.__operator(l)}else return c?Array.isArray(l)?i[c]?.(...l):i[c]?.(l):Array.isArray(l)?i.__operator(...l):i.__operator(l)},r.run=r.post,r.subscribe=async o=>i.__subscribe(o),r.unsubscribe=async o=>i.__unsubscribe(o),r.terminate=()=>(i.__node.graph.remove(i),!0),r.onclose=e.onclose,r.onclose&&i.__addOndisconnected(o=>{r.onclose&&r.onclose(r,o)})}else if(e.connection instanceof void 0){e.connection.__node.nodes.get("open")&&(r.service=e.connection);let i=r.connection;r.send=async o=>{Array.isArray(o.args)?i.run(o.route,...o.args):i.run(o.route,o.args)},r.request=async(o,l)=>{if(o.route)return l?Array.isArray(o.args)?i.__node.nodes.get(o.route)[l]?.(...o.args):i.__node.nodes.get(o.route)[l]?.(o.args):Array.isArray(o.args)?i.run(o.route,...o.args):i.run(o.route,o.args)},r.post=async(o,l,c)=>{if(o&&i.get(o)){let u=i.get(o);return c?Array.isArray(l)?u[c]?.(...l):u[c]?.(l):Array.isArray(l)?u.run(...l):u.run(l)}},r.run=r.post,r.subscribe=async(o,l)=>i.subscribe(o,l),r.unsubscribe=async(o,l)=>i.unsubscribe(o,l),r.terminate=o=>(i.remove(o),!0)}else if(!(e._id&&this.connections[e._id])){let i=e.connection;if(typeof i=="string"){if(this.connections[i])i=this.connections[i];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let o in e.service.connections)if(e.service.connections[o][i]){i=e.service.connections[o][i],r.connectionType=o,r.connectionsKey=i;break}}}else for(let o in this.serviceConnections)for(let l in this.serviceConnections[o])if(this.serviceConnections[o][l][i]){i=this.serviceConnections[o][l][i],e.service=o,r.connectionType=o,r.connectionsKey=l;break}}if(typeof i!="object")return;if(r._id=i._id,r.connection=e.connection,r.send=i.send,r.request=i.request,r.run=i.run,r.post=i.post,r.subscribe=i.subscribe,r.unsubscribe=i.unsubscribe,r.terminate=i.terminate,r.onclose=e.onclose,r.onclose){if(!(i.onclose&&r.onclose.toString()===i.onclose.toString())){let o=i.onclose;i.onclose=(...l)=>{r.onclose&&r.onclose(r,...l),s&&r.source&&this.users[r.source]&&Object.keys(this.sources[r.source]).length===0&&this.removeUser(r.source,!1),o&&o(...l)}}}else{let o=i.onclose;i.onclose=(...l)=>{this.removeConnection(r),s&&r.source&&this.users[r.source]&&Object.keys(this.sources[r.source]).length===0&&this.removeUser(r.source,!1),o&&o(...l)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),r.service=e.service):i.graph&&(r.service=i.graph)}return!r.source&&e.source?r.source=e.source:!r.source&&e.service?r.source=typeof e.service=="object"?e.service?.name:void 0:!r.source&&(r.connection instanceof void 0||r.connection instanceof void 0)&&(r.source="local",this.order.indexOf("local")||this.order.unshift("local")),r._id||(r._id=`connection${Math.floor(Math.random()*1e15)}`),r.source&&(this.sources[r.source]||(this.sources[r.source]={}),this.sources[r.source][r._id]=r),this.connections[r._id]||(this.connections[r._id]=r),r}};removeConnection=(e,t=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){t&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let s in this.sources)if(this.sources[s][e])delete this.sources[s][e];else for(let r in this.sources[s])this.sources[s][r]?.[e]&&delete this.sources[s][e];return!0}else if(this.sources[e]){for(let s in this.sources[e])this.removeConnection(this.sources[e][s],t);return!0}}};routeService=(e,t,s,r)=>{if(this.services[e.name]=e,e.__node?.nodes&&this.__node.nodes.forEach((i,o)=>{e.__node?.nodes.get(o)?e.__node?.nodes.set(this.name+"."+o,i):e.__node?.nodes.set(o,i)}),e.users&&(e.users=this.users),t)if(typeof t=="string")this.addServiceConnections(e,t,s);else for(let i in t)this.addServiceConnections(e,i,s);r?this.order=r:(this.order||(this.order=[]),this.order.push(e.name))};addServiceConnections=(e,t,s)=>{if(typeof e=="string"&&(e=this.services[e]),t&&e[t]){let r={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][t]=e[t];for(let i in e[t])this.connections[i]||(r[i]=this.addConnection({connection:e[t][i],service:e},s),r[i].connectionType=t);return r}};openConnection=async(e,t,s,...r)=>{if(typeof e=="string"&&(e=this.services[e]),e?.__node.nodes){let i=e.run("open",t,...r);if(i instanceof Promise)return i.then(async o=>{o._id||await Qt(o,this.userTimeout),o._id&&this.addConnection({connection:o,service:e},s)});if(i&&(i._id||await Qt(i,this.userTimeout),i._id))return this.addConnection({connection:i,service:e},s)}};terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());routeConnections=(e,t,s,...r)=>{let i;if(typeof s=="string"&&(this.sources[s]&&(i=s),s=this.getConnection(s,"send")),typeof t=="string"&&(t=this.getConnection(t,"subscribe")),t?.subscribe&&s?.send)return new Promise((l,c)=>{t.subscribe(e,u=>{!this.connections[s._id]&&i&&this.sources[i]&&(i=s,Object.keys(this.sources[i]).forEach(p=>{this.sources[s][p].send&&(s=this.sources[s][p])})),this.connections[s._id]&&s.send({callbackId:e,args:u})},...r).then(u=>{l(u)})})};setUserData=(e,t)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object")return this.recursivelyAssign(e,t),!0}};function Qt(n,e=1e4){return new Promise((t,s)=>{let r=performance.now(),i=()=>{n._id?t(!0):performance.now()-r>e?s(!1):setTimeout(()=>{i()},100)};i()}).catch(t=>{console.error("Connection timed out:",t)})}var vt=class{_raw=[];constructor(e){e&&(this._raw=[...e])}get buffer(){let e=this._raw;return this._raw=[],e}set buffer(e){if(Array.isArray(e))this._raw.push(...e);else throw new Error("Input must be an array")}clear(){this._raw.length=0}push(...e){e.length>1?this._raw.push(...e):Array.isArray(e[0])?this._raw.push(...e[0]):this._raw.push(e[0])}get length(){return this._raw.length}set length(e){this._raw.length=e}},St=class{_raw;_size;onfilled;_count=0;constructor(e,t){if(e<=0)throw new Error("Size must be greater than 0");this._size=e,this._raw=new Array(e),t&&this.push(t)}get buffer(){return this._count<this._size?this._raw.slice(this._size-this._count):[...this._raw]}clear(){this._raw.length=0}set buffer(e){this.push(e)}push(...e){e.length>1?this.pushArray(e):Array.isArray(e[0])?this.pushArray(e[0]):(this._raw.length>=this._size&&this._raw.splice(0,1),this._raw.push(e[0]),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&this._count++)}pushArray(e){let t=e.length,s=this._raw.length+t;s>this._size&&this._raw.splice(0,s-this._size),this._raw.push(...e),this._raw.length===this._size&&this.onfilled?this.onfilled():this._count<this._size&&(this._count+=e.length,this._count>this._size&&(this._count=this._size))}get length(){return this._count}set length(e){if(e<0||e>this._size)throw new Error(`Length must be between 0 and ${this._size}`);this._count=e}},wt=class{_buffer={};bufferHasData;_rules;_pollInterval;_pollTimeout;onupdate;prevState;constructor(e,t){this._pollInterval=t,this.setRules(e)}setRules(e){this._rules?Object.assign(this._rules,e):this._rules=e}clearRules(e){for(let t of e)delete this._rules[t]}set buffer(e){for(let t in e){let s=this._rules[t];if(!s)continue;let r=e[t];s==="state"||s===!0?(this._buffer[t]=r,this.bufferHasData=!0):s==="inpbuf"?(this._buffer[t]||(this._buffer[t]=new vt),this._buffer[t].push(r),this.bufferHasData=!0):s?.type==="circbuf"&&(this._buffer[t]||(this._buffer[t]=new St(s.length)),this._buffer[t].push(r),this.bufferHasData=!0)}}get buffer(){let e={};for(let t in this._buffer)this._buffer[t]!==void 0&&(this._buffer[t]?._raw?(e[t]=this._buffer[t].buffer,this._buffer[t].clear()):(e[t]=this._buffer[t],delete this._buffer[t]));return this.bufferHasData=!1,e}clear(){this._buffer={},this.bufferHasData=!1}startPolling(e){e&&(this.onupdate=e),this._pollInterval&&!this._pollTimeout&&(this._pollTimeout=setInterval(()=>{if(this.bufferHasData&&this.onupdate){let t=this.buffer;this.prevState=t,this.onupdate(t),this.clear()}},this._pollInterval))}stopPolling(){this._pollTimeout&&(clearInterval(this._pollTimeout),this._pollTimeout=void 0)}},We=class{buffers={};pollInterval;pollTimeout;onupdate;prevState;constructor(e){this.pollInterval=e}createBuffer(e,t,s){if(this.buffers[e])throw new Error(`Buffer with name ${e} already exists`);let r=new wt(t,s);this.buffers[e]=r}deleteBuffer(e){delete this.buffers[e]}get(e){return this.buffers[e]}updateBuffer(e,t){if(this.buffers[e])this.buffers[e].buffer=t;else throw new Error("No buffer found of name "+e)}aggregateBuffers(){let e={};for(let t in this.buffers)if(this.buffers[t].bufferHasData){let s=this.buffers[t].buffer;e[t]=s,this.buffers[t].clear()}this.prevState=e,this.onupdate&&Object.keys(e).length>0&&this.onupdate(e)}startPolling(e){e&&(this.onupdate=e),this.pollInterval&&!this.pollTimeout&&(this.pollTimeout=setInterval(()=>{this.aggregateBuffers()},this.pollInterval))}stopPolling(){this.pollTimeout&&(clearInterval(this.pollTimeout),this.pollTimeout=void 0)}};var Je=class{sessions={};delayBufferManager;globalPollInterval=1e3;tokens={};useTokens=!1;prevState;onupdate;constructor(e,t,s){e&&(this.globalPollInterval=e),t&&(this.onupdate=t),s!==void 0&&(this.useTokens=s),this.delayBufferManager=new We(this.globalPollInterval),this.delayBufferManager.onupdate=r=>{if(this.onupdate){let i=Object.keys(r),o={};i.forEach(l=>{o[l]=this.sessions[l]}),this.prevState=r,this.onupdate(r,o)}else console.log("Buffers updated:",r)}}createSession=(e,t,s,r,i)=>{if(this.sessions[e])return new Error(`Session with ID ${e} already exists`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==i))return new Error(`Invalid token for user ${t}`);this.delayBufferManager.createBuffer(e,s);let o={password:r?.password,bannedUsers:r?.bannedUsers||{},adminUsers:r?.adminUsers||{}};o.adminUsers[t]=!0,this.sessions[e]={users:{},rules:o,db:this.delayBufferManager.get(e)},this.addUserToSession(e,t,i,r?.password)};deleteSession=(e,t,s)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);(this.checkAdmin(e,t,s)||Object.keys(r.rules.adminUsers).length===0||Object.keys(r.users).length===0)&&(this.delayBufferManager.deleteBuffer(e),delete this.sessions[e])};clearUserToken=e=>{delete this.tokens[e]};getSessionInfo=(e,t,s)=>{let r=this.sessions[e];if(!r)return new Error(`Session with ID ${e} does not exist`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);let i=this.delayBufferManager.get(e)?._rules;return{_id:e,users:Object.keys(r.users),dbrules:i}};checkAdmin(e,t,s){let r=this.sessions[e];return this.useTokens&&(!r.rules.adminUsers[t]||this.tokens[t]!==s)?(console.error(`User ${t} does not have admin privileges or invalid token`),!1):!0}updateSessions=(e,t,s,r,i,o)=>{for(let l in e)this.updateBuffer(l,e[l],t,s,r?.[l],i,o)};updateBuffer=(e,t,s,r,i,o,l)=>{let c=this.sessions[e];c&&(!this.useTokens||s&&c.users[s]&&this.tokens[s]===r||o&&this.checkAdmin(e,o,l)||c.rules.password&&c.rules.password===i)&&this.delayBufferManager.updateBuffer(e,t)};addUserToSession=(e,t,s,r,i,o,l)=>{let c=this.sessions[e];if(!c)return new Error(`Session with ID ${e} does not exist`);if(c.rules.password&&c.rules.password!==r||l&&!this.checkAdmin(e,o,l))return new Error("Password required or invalid admin token");if(c.rules.bannedUsers&&c.rules.bannedUsers[t])return new Error(`User ${t} is banned from this session`);if(this.useTokens&&(!this.tokens[t]||this.tokens[t]!==s))return new Error(`Invalid token for user ${t}`);c.users[t]=!0,i&&c.db.setRules(i)};removeUserFromSession=(e,t,s,r)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);i.users[t]&&this.checkAdmin(e,s,r)&&delete i.users[t]};setAdmin=(e,t,s,r)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,r)&&(i.rules.adminUsers[t]=!0)};removeAdmin=(e,t,s,r)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);Object.keys(i.rules.adminUsers).length>1&&this.checkAdmin(e,s,r)&&delete i.rules.adminUsers[t]};banUser=(e,t,s,r)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,t,r)&&(i.rules.bannedUsers[s]=!0,this.removeUserFromSession(e,s,t,r))};unbanUser=(e,t,s,r)=>{let i=this.sessions[e];if(!i)return new Error(`Session with ID ${e} does not exist`);this.checkAdmin(e,s,r)&&delete i.rules.bannedUsers[t]};splitUpdatesByUser=e=>{let t={};return Object.keys(e).forEach(s=>{let r=this.sessions[s];if(!r)return;let i=e[s];i&&Object.keys(r.users).forEach(o=>{t[o]||(t[o]={}),t[o][s]=i})}),t};startPolling=()=>{this.delayBufferManager.startPolling()};stopPolling=()=>{this.delayBufferManager.stopPolling()};setSessionToken=(e,t)=>{this.tokens[e]=t};generateSessionToken=e=>{let t=`${Math.floor(Math.random()*1e15)}`;return e&&(this.tokens[e]=t),t}};var es=class extends(void 0){users={};sessionManager;sessionData={};onlocalupdate;onremoteupdate;constructor(e,t,s,r,i=!1){if(super(e),r){this.users=r;for(let c in r)r[c]._id||(r[c]._id=c)}s&&(this.onlocalupdate=s),this.sessionManager=new Je(t||1e3,(c,u)=>{let p=this.sessionManager.splitUpdatesByUser(c);for(let g in p)this.onlocalupdate?this.onlocalupdate(p[g],u,this.users[g]):this.users[g]?.send&&this.users[g].send({route:"receiveSessionData",args:[p[g],g]})},i);let o={},l=Object.getOwnPropertyNames(this.sessionManager);for(let c of l)c!=="createSession"&&c!=="updateSessions"&&c!=="updateBuffer"&&c!=="setSessionToken"&&c!=="generateSessionToken"&&c!=="startPolling"&&c!=="stopPolling"&&typeof this.sessionManager[c]=="function"&&(o[c]=(...u)=>{let p=this.sessionManager[c](...u);p instanceof Error&&console.error(p)});this.load(this),this.load(o)}get prevState(){if(this.sessionManager?.prevState)return this.sessionManager.prevState}setSessionToken=(e,t,s)=>{if(this.sessionManager.setSessionToken(e,t),s&&this.users[e]?.send){let r={route:"setSessionToken",args:[e,t]};this.users[e].send(r)}else this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t};generateSessionToken=e=>{let t=this.sessionManager.generateSessionToken(e);return e&&this.users[e]&&(this.users[e]||(this.users[e]={_id:e}),this.users[e].token=t),t};messageRemoteSession=(e,t,...s)=>{this.users[e].send({route:t,args:s})};receiveSessionData=(e,t)=>{let s={};for(let r in e)this.sessionData[r]||(this.sessionData[r]={}),this.recursivelyAssign(this.sessionData[r]||{},e),s=this.sessionData[r];return this.onremoteupdate&&this.onremoteupdate(s,this.users[t]),s};createSession=(e,t,s,r,i)=>this.sessionManager.createSession(e,t,s,r,i);updateSessions=(e,t,s,r,i,o)=>this.sessionManager.updateSessions(e,t,s,r,i,o);updateBuffer=(e,t,s,r,i,o,l)=>this.sessionManager.updateBuffer(e,t,s,r,i,o,l);startPolling=()=>this.sessionManager.startPolling();stopPolling=()=>this.sessionManager.stopPolling()};var P={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(n){this.toString=function(){return"CORRUPT: "+this.message},this.message=n},invalid:function(n){this.toString=function(){return"INVALID: "+this.message},this.message=n},bug:function(n){this.toString=function(){return"BUG: "+this.message},this.message=n},notReady:function(n){this.toString=function(){return"NOT READY: "+this.message},this.message=n}}};P.cipher.aes=function(n){this.s[0][0][0]||this.O();var e,t,s,r,i=this.s[0][4],o=this.s[1];e=n.length;var l=1;if(e!==4&&e!==6&&e!==8)throw new P.exception.invalid("invalid aes key size");for(this.b=[s=n.slice(0),r=[]],n=e;n<4*e+28;n++)t=s[n-1],(n%e===0||e===8&&n%e===4)&&(t=i[t>>>24]<<24^i[t>>16&255]<<16^i[t>>8&255]<<8^i[t&255],n%e===0&&(t=t<<8^t>>>24^l<<24,l=l<<1^283*(l>>7))),s[n]=s[n-e]^t;for(e=0;n;e++,n--)t=s[e&3?n:n-4],r[e]=4>=n||4>e?t:o[0][i[t>>>24]]^o[1][i[t>>16&255]]^o[2][i[t>>8&255]]^o[3][i[t&255]]};P.cipher.aes.prototype={encrypt:function(n){return br(this,n,0)},decrypt:function(n){return br(this,n,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var n=this.s[0],e=this.s[1],t=n[4],s=e[4],r,i,o,l=[],c=[],u,p,g,v;for(r=0;256>r;r++)c[(l[r]=r<<1^283*(r>>7))^r]=r;for(i=o=0;!t[i];i^=u||1,o=c[o]||1)for(g=o^o<<1^o<<2^o<<3^o<<4,g=g>>8^g&255^99,t[i]=g,s[g]=i,p=l[r=l[u=l[i]]],v=16843009*p^65537*r^257*u^16843008*i,p=257*l[g]^16843008*g,r=0;4>r;r++)n[r][i]=p=p<<24^p>>>8,e[r][g]=v=v<<24^v>>>8;for(r=0;5>r;r++)n[r]=n[r].slice(0),e[r]=e[r].slice(0)}};function br(n,e,t){if(e.length!==4)throw new P.exception.invalid("invalid aes block size");var s=n.b[t],r=e[0]^s[0],i=e[t?3:1]^s[1],o=e[2]^s[2];e=e[t?1:3]^s[3];var l,c,u,p=s.length/4-2,g,v=4,w=[0,0,0,0];l=n.s[t],n=l[0];var A=l[1],j=l[2],F=l[3],D=l[4];for(g=0;g<p;g++)l=n[r>>>24]^A[i>>16&255]^j[o>>8&255]^F[e&255]^s[v],c=n[i>>>24]^A[o>>16&255]^j[e>>8&255]^F[r&255]^s[v+1],u=n[o>>>24]^A[e>>16&255]^j[r>>8&255]^F[i&255]^s[v+2],e=n[e>>>24]^A[r>>16&255]^j[i>>8&255]^F[o&255]^s[v+3],v+=4,r=l,i=c,o=u;for(g=0;4>g;g++)w[t?3&-g:g]=D[r>>>24]<<24^D[i>>16&255]<<16^D[o>>8&255]<<8^D[e&255]^s[v++],l=r,r=i,i=o,o=e,e=l;return w}P.bitArray={bitSlice:function(n,e,t){return n=P.bitArray.$(n.slice(e/32),32-(e&31)).slice(1),t===void 0?n:P.bitArray.clamp(n,t-e)},extract:function(n,e,t){var s=Math.floor(-e-t&31);return((e+t-1^e)&-32?n[e/32|0]<<32-s^n[e/32+1|0]>>>s:n[e/32|0]>>>s)&(1<<t)-1},concat:function(n,e){if(n.length===0||e.length===0)return n.concat(e);var t=n[n.length-1],s=P.bitArray.getPartial(t);return s===32?n.concat(e):P.bitArray.$(e,s,t|0,n.slice(0,n.length-1))},bitLength:function(n){var e=n.length;return e===0?0:32*(e-1)+P.bitArray.getPartial(n[e-1])},clamp:function(n,e){if(32*n.length<e)return n;n=n.slice(0,Math.ceil(e/32));var t=n.length;return e=e&31,0<t&&e&&(n[t-1]=P.bitArray.partial(e,n[t-1]&2147483648>>e-1,1)),n},partial:function(n,e,t){return n===32?e:(t?e|0:e<<32-n)+1099511627776*n},getPartial:function(n){return Math.round(n/1099511627776)||32},equal:function(n,e){if(P.bitArray.bitLength(n)!==P.bitArray.bitLength(e))return!1;var t=0,s;for(s=0;s<n.length;s++)t|=n[s]^e[s];return t===0},$:function(n,e,t,s){var r;for(r=0,s===void 0&&(s=[]);32<=e;e-=32)s.push(t),t=0;if(e===0)return s.concat(n);for(r=0;r<n.length;r++)s.push(t|n[r]>>>e),t=n[r]<<32-e;return r=n.length?n[n.length-1]:0,n=P.bitArray.getPartial(r),s.push(P.bitArray.partial(e+n&31,32<e+n?t:s.pop(),1)),s},i:function(n,e){return[n[0]^e[0],n[1]^e[1],n[2]^e[2],n[3]^e[3]]},byteswapM:function(n){var e,t;for(e=0;e<n.length;++e)t=n[e],n[e]=t>>>24|t>>>8&65280|(t&65280)<<8|t<<24;return n}};P.codec.utf8String={fromBits:function(n){var e="",t=P.bitArray.bitLength(n),s,r;for(s=0;s<t/8;s++)!(s&3)&&(r=n[s/4]),e+=String.fromCharCode(r>>>8>>>8>>>8),r<<=8;return decodeURIComponent(escape(e))},toBits:function(n){n=unescape(encodeURIComponent(n));var e=[],t,s=0;for(t=0;t<n.length;t++)s=s<<8|n.charCodeAt(t),(t&3)===3&&(e.push(s),s=0);return t&3&&e.push(P.bitArray.partial(8*(t&3),s)),e}};P.codec.hex={fromBits:function(n){var e="",t;for(t=0;t<n.length;t++)e+=((n[t]|0)+0xf00000000000).toString(16).substr(4);return e.substr(0,P.bitArray.bitLength(n)/4)},toBits:function(n){var e,t=[],s;for(n=n.replace(/\s|0x/g,""),s=n.length,n=n+"00000000",e=0;e<n.length;e+=8)t.push(parseInt(n.substr(e,8),16)^0);return P.bitArray.clamp(t,4*s)}};P.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(n,e,t){var s=P.codec.base32.BASE,r=P.codec.base32.REMAINING,i="",o=0,l=P.codec.base32.B,c=0,u=P.bitArray.bitLength(n);for(t&&(l=P.codec.base32.X),t=0;i.length*s<u;)i+=l.charAt((c^n[t]>>>o)>>>r),o<s?(c=n[t]<<s-o,o+=r,t++):(c<<=s,o-=s);for(;i.length&7&&!e;)i+="=";return i},toBits:function(n,e){n=n.replace(/\s|=/g,"").toUpperCase();var t=P.codec.base32.BITS,s=P.codec.base32.BASE,r=P.codec.base32.REMAINING,i=[],o,l=0,c=P.codec.base32.B,u=0,p,g="base32";for(e&&(c=P.codec.base32.X,g="base32hex"),o=0;o<n.length;o++){if(p=c.indexOf(n.charAt(o)),0>p){if(!e)try{return P.codec.base32hex.toBits(n)}catch{}throw new P.exception.invalid("this isn't "+g+"!")}l>r?(l-=r,i.push(u^p>>>l),u=p<<t-l):(l+=s,u^=p<<t-l)}return l&56&&i.push(P.bitArray.partial(l&56,u,1)),i}};P.codec.base32hex={fromBits:function(n,e){return P.codec.base32.fromBits(n,e,1)},toBits:function(n){return P.codec.base32.toBits(n,1)}};P.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(n,e,t){var s="",r=0,i=P.codec.base64.B,o=0,l=P.bitArray.bitLength(n);for(t&&(i=i.substr(0,62)+"-_"),t=0;6*s.length<l;)s+=i.charAt((o^n[t]>>>r)>>>26),6>r?(o=n[t]<<6-r,r+=26,t++):(o<<=6,r-=6);for(;s.length&3&&!e;)s+="=";return s},toBits:function(n,e){n=n.replace(/\s|=/g,"");var t=[],s,r=0,i=P.codec.base64.B,o=0,l;for(e&&(i=i.substr(0,62)+"-_"),s=0;s<n.length;s++){if(l=i.indexOf(n.charAt(s)),0>l)throw new P.exception.invalid("this isn't base64!");26<r?(r-=26,t.push(o^l>>>r),o=l<<32-r):(r+=6,o^=l<<32-r)}return r&56&&t.push(P.bitArray.partial(r&56,o,1)),t}};P.codec.base64url={fromBits:function(n){return P.codec.base64.fromBits(n,1,1)},toBits:function(n){return P.codec.base64.toBits(n,1)}};P.hash.sha256=function(n){this.b[0]||this.O(),n?(this.F=n.F.slice(0),this.A=n.A.slice(0),this.l=n.l):this.reset()};P.hash.sha256.hash=function(n){return new P.hash.sha256().update(n).finalize()};P.hash.sha256.prototype={blockSize:512,reset:function(){return this.F=this.Y.slice(0),this.A=[],this.l=0,this},update:function(n){typeof n=="string"&&(n=P.codec.utf8String.toBits(n));var e,t=this.A=P.bitArray.concat(this.A,n);if(e=this.l,n=this.l=e+P.bitArray.bitLength(n),9007199254740991<n)throw new P.exception.invalid("Cannot hash more than 2^53 - 1 bits");if(typeof Uint32Array<"u"){var s=new Uint32Array(t),r=0;for(e=512+e-(512+e&511);e<=n;e+=512)ts(this,s.subarray(16*r,16*(r+1))),r+=1;t.splice(0,16*r)}else for(e=512+e-(512+e&511);e<=n;e+=512)ts(this,t.splice(0,16));return this},finalize:function(){var n,t=this.A,e=this.F,t=P.bitArray.concat(t,[P.bitArray.partial(1,1)]);for(n=t.length+2;n&15;n++)t.push(0);for(t.push(Math.floor(this.l/4294967296)),t.push(this.l|0);t.length;)ts(this,t.splice(0,16));return this.reset(),e},Y:[],b:[],O:function(){function n(i){return 4294967296*(i-Math.floor(i))|0}for(var e=0,t=2,s,r;64>e;t++){for(r=!0,s=2;s*s<=t;s++)if(t%s===0){r=!1;break}r&&(8>e&&(this.Y[e]=n(Math.pow(t,.5))),this.b[e]=n(Math.pow(t,1/3)),e++)}}};function ts(n,e){var t,s,r,i=n.F,o=n.b,l=i[0],c=i[1],u=i[2],p=i[3],g=i[4],v=i[5],w=i[6],A=i[7];for(t=0;64>t;t++)16>t?s=e[t]:(s=e[t+1&15],r=e[t+14&15],s=e[t&15]=(s>>>7^s>>>18^s>>>3^s<<25^s<<14)+(r>>>17^r>>>19^r>>>10^r<<15^r<<13)+e[t&15]+e[t+9&15]|0),s=s+A+(g>>>6^g>>>11^g>>>25^g<<26^g<<21^g<<7)+(w^g&(v^w))+o[t],A=w,w=v,v=g,g=p+s|0,p=u,u=c,c=l,l=s+(c&u^p&(c^u))+(c>>>2^c>>>13^c>>>22^c<<30^c<<19^c<<10)|0;i[0]=i[0]+l|0,i[1]=i[1]+c|0,i[2]=i[2]+u|0,i[3]=i[3]+p|0,i[4]=i[4]+g|0,i[5]=i[5]+v|0,i[6]=i[6]+w|0,i[7]=i[7]+A|0}P.mode.ccm={name:"ccm",G:[],listenProgress:function(n){P.mode.ccm.G.push(n)},unListenProgress:function(n){n=P.mode.ccm.G.indexOf(n),-1<n&&P.mode.ccm.G.splice(n,1)},fa:function(n){var e=P.mode.ccm.G.slice(),t;for(t=0;t<e.length;t+=1)e[t](n)},encrypt:function(n,e,t,s,r){var i,o=e.slice(0),l=P.bitArray,c=l.bitLength(t)/8,u=l.bitLength(o)/8;if(r=r||64,s=s||[],7>c)throw new P.exception.invalid("ccm: iv must be at least 7 bytes");for(i=2;4>i&&u>>>8*i;i++);return i<15-c&&(i=15-c),t=l.clamp(t,8*(15-i)),e=P.mode.ccm.V(n,e,t,s,r,i),o=P.mode.ccm.C(n,o,t,e,r,i),l.concat(o.data,o.tag)},decrypt:function(n,e,t,s,r){r=r||64,s=s||[];var i=P.bitArray,o=i.bitLength(t)/8,u=i.bitLength(e),l=i.clamp(e,u-r),c=i.bitSlice(e,u-r),u=(u-r)/8;if(7>o)throw new P.exception.invalid("ccm: iv must be at least 7 bytes");for(e=2;4>e&&u>>>8*e;e++);if(e<15-o&&(e=15-o),t=i.clamp(t,8*(15-e)),l=P.mode.ccm.C(n,l,t,c,r,e),n=P.mode.ccm.V(n,l.data,t,s,r,e),!i.equal(l.tag,n))throw new P.exception.corrupt("ccm: tag doesn't match");return l.data},na:function(n,e,t,s,r,i){var o=[],l=P.bitArray,c=l.i;if(s=[l.partial(8,(e.length?64:0)|s-2<<2|i-1)],s=l.concat(s,t),s[3]|=r,s=n.encrypt(s),e.length)for(t=l.bitLength(e)/8,65279>=t?o=[l.partial(16,t)]:4294967295>=t&&(o=l.concat([l.partial(16,65534)],[t])),o=l.concat(o,e),e=0;e<o.length;e+=4)s=n.encrypt(c(s,o.slice(e,e+4).concat([0,0,0])));return s},V:function(n,e,t,s,r,i){var o=P.bitArray,l=o.i;if(r/=8,r%2||4>r||16<r)throw new P.exception.invalid("ccm: invalid tag length");if(4294967295<s.length||4294967295<e.length)throw new P.exception.bug("ccm: can't deal with 4GiB or more data");for(t=P.mode.ccm.na(n,s,t,r,o.bitLength(e)/8,i),s=0;s<e.length;s+=4)t=n.encrypt(l(t,e.slice(s,s+4).concat([0,0,0])));return o.clamp(t,8*r)},C:function(n,e,t,s,r,i){var o,l=P.bitArray;o=l.i;var c=e.length,u=l.bitLength(e),p=c/50,g=p;if(t=l.concat([l.partial(8,i-1)],t).concat([0,0,0]).slice(0,4),s=l.bitSlice(o(s,n.encrypt(t)),0,r),!c)return{tag:s,data:[]};for(o=0;o<c;o+=4)o>p&&(P.mode.ccm.fa(o/c),p+=g),t[3]++,r=n.encrypt(t),e[o]^=r[0],e[o+1]^=r[1],e[o+2]^=r[2],e[o+3]^=r[3];return{tag:s,data:l.clamp(e,u)}}};P.mode.ocb2={name:"ocb2",encrypt:function(n,e,t,s,r,i){if(P.bitArray.bitLength(t)!==128)throw new P.exception.invalid("ocb iv must be 128 bits");var o,l=P.mode.ocb2.S,c=P.bitArray,u=c.i,p=[0,0,0,0];t=l(n.encrypt(t));var g,v=[];for(s=s||[],r=r||64,o=0;o+4<e.length;o+=4)g=e.slice(o,o+4),p=u(p,g),v=v.concat(u(t,n.encrypt(u(t,g)))),t=l(t);return g=e.slice(o),e=c.bitLength(g),o=n.encrypt(u(t,[0,0,0,e])),g=c.clamp(u(g.concat([0,0,0]),o),e),p=u(p,u(g.concat([0,0,0]),o)),p=n.encrypt(u(p,u(t,l(t)))),s.length&&(p=u(p,i?s:P.mode.ocb2.pmac(n,s))),v.concat(c.concat(g,c.clamp(p,r)))},decrypt:function(n,e,t,s,r,i){if(P.bitArray.bitLength(t)!==128)throw new P.exception.invalid("ocb iv must be 128 bits");r=r||64;var o=P.mode.ocb2.S,l=P.bitArray,c=l.i,u=[0,0,0,0],p=o(n.encrypt(t)),g,v,w=P.bitArray.bitLength(e)-r,A=[];for(s=s||[],t=0;t+4<w/32;t+=4)g=c(p,n.decrypt(c(p,e.slice(t,t+4)))),u=c(u,g),A=A.concat(g),p=o(p);if(v=w-32*t,g=n.encrypt(c(p,[0,0,0,v])),g=c(g,l.clamp(e.slice(t),v).concat([0,0,0])),u=c(u,g),u=n.encrypt(c(u,c(p,o(p)))),s.length&&(u=c(u,i?s:P.mode.ocb2.pmac(n,s))),!l.equal(l.clamp(u,r),l.bitSlice(e,w)))throw new P.exception.corrupt("ocb: tag doesn't match");return A.concat(l.clamp(g,v))},pmac:function(n,e){var t,s=P.mode.ocb2.S,r=P.bitArray,i=r.i,o=[0,0,0,0],l=n.encrypt([0,0,0,0]),l=i(l,s(s(l)));for(t=0;t+4<e.length;t+=4)l=s(l),o=i(o,n.encrypt(i(l,e.slice(t,t+4))));return t=e.slice(t),128>r.bitLength(t)&&(l=i(l,s(l)),t=r.concat(t,[-2147483648,0,0,0])),o=i(o,t),n.encrypt(i(s(i(l,s(l))),o))},S:function(n){return[n[0]<<1^n[1]>>>31,n[1]<<1^n[2]>>>31,n[2]<<1^n[3]>>>31,n[3]<<1^135*(n[0]>>>31)]}};P.mode.gcm={name:"gcm",encrypt:function(n,e,t,s,r){var i=e.slice(0);return e=P.bitArray,s=s||[],n=P.mode.gcm.C(!0,n,i,s,t,r||128),e.concat(n.data,n.tag)},decrypt:function(n,e,t,s,r){var i=e.slice(0),o=P.bitArray,l=o.bitLength(i);if(r=r||128,s=s||[],r<=l?(e=o.bitSlice(i,l-r),i=o.bitSlice(i,0,l-r)):(e=i,i=[]),n=P.mode.gcm.C(!1,n,i,s,t,r),!o.equal(n.tag,e))throw new P.exception.corrupt("gcm: tag doesn't match");return n.data},ka:function(n,e){var t,s,r,i,o,l=P.bitArray.i;for(r=[0,0,0,0],i=e.slice(0),t=0;128>t;t++){for((s=(n[Math.floor(t/32)]&1<<31-t%32)!==0)&&(r=l(r,i)),o=(i[3]&1)!==0,s=3;0<s;s--)i[s]=i[s]>>>1|(i[s-1]&1)<<31;i[0]>>>=1,o&&(i[0]^=-520093696)}return r},j:function(n,e,t){var s,r=t.length;for(e=e.slice(0),s=0;s<r;s+=4)e[0]^=4294967295&t[s],e[1]^=4294967295&t[s+1],e[2]^=4294967295&t[s+2],e[3]^=4294967295&t[s+3],e=P.mode.gcm.ka(e,n);return e},C:function(n,e,t,s,r,i){var o,l,c,u,p,g,v,w,A=P.bitArray;for(g=t.length,v=A.bitLength(t),w=A.bitLength(s),l=A.bitLength(r),o=e.encrypt([0,0,0,0]),l===96?(r=r.slice(0),r=A.concat(r,[1])):(r=P.mode.gcm.j(o,[0,0,0,0],r),r=P.mode.gcm.j(o,r,[0,0,Math.floor(l/4294967296),l&4294967295])),l=P.mode.gcm.j(o,[0,0,0,0],s),p=r.slice(0),s=l.slice(0),n||(s=P.mode.gcm.j(o,l,t)),u=0;u<g;u+=4)p[3]++,c=e.encrypt(p),t[u]^=c[0],t[u+1]^=c[1],t[u+2]^=c[2],t[u+3]^=c[3];return t=A.clamp(t,v),n&&(s=P.mode.gcm.j(o,l,t)),n=[Math.floor(w/4294967296),w&4294967295,Math.floor(v/4294967296),v&4294967295],s=P.mode.gcm.j(o,s,n),c=e.encrypt(r),s[0]^=c[0],s[1]^=c[1],s[2]^=c[2],s[3]^=c[3],{tag:A.bitSlice(s,0,i),data:t}}};P.misc.hmac=function(n,e){this.W=e=e||P.hash.sha256;var t=[[],[]],s,r=e.prototype.blockSize/32;for(this.w=[new e,new e],n.length>r&&(n=e.hash(n)),s=0;s<r;s++)t[0][s]=n[s]^909522486,t[1][s]=n[s]^1549556828;this.w[0].update(t[0]),this.w[1].update(t[1]),this.R=new e(this.w[0])};P.misc.hmac.prototype.encrypt=P.misc.hmac.prototype.mac=function(n){if(this.aa)throw new P.exception.invalid("encrypt on already updated hmac called!");return this.update(n),this.digest(n)};P.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]),this.aa=!1};P.misc.hmac.prototype.update=function(n){this.aa=!0,this.R.update(n)};P.misc.hmac.prototype.digest=function(){var n=this.R.finalize(),n=new this.W(this.w[1]).update(n).finalize();return this.reset(),n};P.misc.pbkdf2=function(n,e,t,s,r){if(t=t||1e4,0>s||0>t)throw new P.exception.invalid("invalid params to pbkdf2");typeof n=="string"&&(n=P.codec.utf8String.toBits(n)),typeof e=="string"&&(e=P.codec.utf8String.toBits(e)),r=r||P.misc.hmac,n=new r(n);var i,o,l,c,u=[],p=P.bitArray;for(c=1;32*u.length<(s||1);c++){for(r=i=n.encrypt(p.concat(e,[c])),o=1;o<t;o++)for(i=n.encrypt(i),l=0;l<i.length;l++)r[l]^=i[l];u=u.concat(r)}return s&&(u=p.clamp(u,s)),u};P.prng=function(n){this.c=[new P.hash.sha256],this.m=[0],this.P=0,this.H={},this.N=0,this.U={},this.Z=this.f=this.o=this.ha=0,this.b=[0,0,0,0,0,0,0,0],this.h=[0,0,0,0],this.L=void 0,this.M=n,this.D=!1,this.K={progress:{},seeded:{}},this.u=this.ga=0,this.I=1,this.J=2,this.ca=65536,this.T=[0,48,64,96,128,192,256,384,512,768,1024],this.da=3e4,this.ba=80};P.prng.prototype={randomWords:function(n,e){var t=[],s;s=this.isReady(e);var r;if(s===this.u)throw new P.exception.notReady("generator isn't seeded");if(s&this.J){s=!(s&this.I),r=[];var i=0,o;for(this.Z=r[0]=new Date().valueOf()+this.da,o=0;16>o;o++)r.push(4294967296*Math.random()|0);for(o=0;o<this.c.length&&(r=r.concat(this.c[o].finalize()),i+=this.m[o],this.m[o]=0,s||!(this.P&1<<o));o++);for(this.P>=1<<this.c.length&&(this.c.push(new P.hash.sha256),this.m.push(0)),this.f-=i,i>this.o&&(this.o=i),this.P++,this.b=P.hash.sha256.hash(this.b.concat(r)),this.L=new P.cipher.aes(this.b),s=0;4>s&&(this.h[s]=this.h[s]+1|0,!this.h[s]);s++);}for(s=0;s<n;s+=4)(s+1)%this.ca===0&&Sr(this),r=ss(this),t.push(r[0],r[1],r[2],r[3]);return Sr(this),t.slice(0,n)},setDefaultParanoia:function(n,e){if(n===0&&e!=="Setting paranoia=0 will ruin your security; use it only for testing")throw new P.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=n},addEntropy:function(n,e,t){t=t||"user";var s,r,i=new Date().valueOf(),o=this.H[t],l=this.isReady(),c=0;switch(s=this.U[t],s===void 0&&(s=this.U[t]=this.ha++),o===void 0&&(o=this.H[t]=0),this.H[t]=(this.H[t]+1)%this.c.length,typeof n){case"number":e===void 0&&(e=1),this.c[o].update([s,this.N++,1,e,i,1,n|0]);break;case"object":if(t=Object.prototype.toString.call(n),t==="[object Uint32Array]"){for(r=[],t=0;t<n.length;t++)r.push(n[t]);n=r}else for(t!=="[object Array]"&&(c=1),t=0;t<n.length&&!c;t++)typeof n[t]!="number"&&(c=1);if(!c){if(e===void 0)for(t=e=0;t<n.length;t++)for(r=n[t];0<r;)e++,r=r>>>1;this.c[o].update([s,this.N++,2,e,i,n.length].concat(n))}break;case"string":e===void 0&&(e=n.length),this.c[o].update([s,this.N++,3,e,i,n.length]),this.c[o].update(n);break;default:c=1}if(c)throw new P.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[o]+=e,this.f+=e,l===this.u&&(this.isReady()!==this.u&&vr("seeded",Math.max(this.o,this.f)),vr("progress",this.getProgress()))},isReady:function(n){return n=this.T[n!==void 0?n:this.M],this.o&&this.o>=n?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=n?this.J|this.u:this.u},getProgress:function(n){return n=this.T[n||this.M],this.o>=n||this.f>n?1:this.f/n},startCollectors:function(){if(!this.D){if(this.a={loadTimeCollector:Ve(this,this.ma),mouseCollector:Ve(this,this.oa),keyboardCollector:Ve(this,this.la),accelerometerCollector:Ve(this,this.ea),touchCollector:Ve(this,this.qa)},window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,!1),window.addEventListener("mousemove",this.a.mouseCollector,!1),window.addEventListener("keypress",this.a.keyboardCollector,!1),window.addEventListener("devicemotion",this.a.accelerometerCollector,!1),window.addEventListener("touchmove",this.a.touchCollector,!1);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new P.exception.bug("can't attach event");this.D=!0}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,!1),window.removeEventListener("mousemove",this.a.mouseCollector,!1),window.removeEventListener("keypress",this.a.keyboardCollector,!1),window.removeEventListener("devicemotion",this.a.accelerometerCollector,!1),window.removeEventListener("touchmove",this.a.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=!1)},addEventListener:function(n,e){this.K[n][this.ga++]=e},removeEventListener:function(n,e){var t,s,r=this.K[n],i=[];for(s in r)r.hasOwnProperty(s)&&r[s]===e&&i.push(s);for(t=0;t<i.length;t++)s=i[t],delete r[s]},la:function(){He(this,1)},oa:function(n){var e,t;try{e=n.x||n.clientX||n.offsetX||0,t=n.y||n.clientY||n.offsetY||0}catch{t=e=0}e!=0&&t!=0&&this.addEntropy([e,t],2,"mouse"),He(this,0)},qa:function(n){n=n.touches[0]||n.changedTouches[0],this.addEntropy([n.pageX||n.clientX,n.pageY||n.clientY],1,"touch"),He(this,0)},ma:function(){He(this,2)},ea:function(n){if(n=n.accelerationIncludingGravity.x||n.accelerationIncludingGravity.y||n.accelerationIncludingGravity.z,window.orientation){var e=window.orientation;typeof e=="number"&&this.addEntropy(e,1,"accelerometer")}n&&this.addEntropy(n,2,"accelerometer"),He(this,0)}};function vr(n,e){var t,s=P.random.K[n],r=[];for(t in s)s.hasOwnProperty(t)&&r.push(s[t]);for(t=0;t<r.length;t++)r[t](e)}function He(n,e){typeof window<"u"&&window.performance&&typeof window.performance.now=="function"?n.addEntropy(window.performance.now(),e,"loadtime"):n.addEntropy(new Date().valueOf(),e,"loadtime")}function Sr(n){n.b=ss(n).concat(ss(n)),n.L=new P.cipher.aes(n.b)}function ss(n){for(var e=0;4>e&&(n.h[e]=n.h[e]+1|0,!n.h[e]);e++);return n.L.encrypt(n.h)}function Ve(n,e){return function(){e.apply(n,arguments)}}P.random=new P.prng(6);e:try{if(kt=typeof module<"u"&&module.exports){try{xt=require("crypto")}catch{xt=null}kt=Ot=xt}if(kt&&Ot.randomBytes)Ye=Ot.randomBytes(128),Ye=new Uint32Array(new Uint8Array(Ye).buffer),P.random.addEntropy(Ye,1024,"crypto['randomBytes']");else if(typeof window<"u"&&typeof Uint32Array<"u"){if(Ke=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(Ke);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(Ke);else break e;P.random.addEntropy(Ke,1024,"crypto['getRandomValues']")}}catch(n){typeof window<"u"&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(n))}var Ye,Ot,Ke,kt,xt;P.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(n,e,t,s){t=t||{},s=s||{};var r=P.json,i=r.g({iv:P.random.randomWords(4,0)},r.defaults),o;if(r.g(i,t),t=i.adata,typeof i.salt=="string"&&(i.salt=P.codec.base64.toBits(i.salt)),typeof i.iv=="string"&&(i.iv=P.codec.base64.toBits(i.iv)),!P.mode[i.mode]||!P.cipher[i.cipher]||typeof n=="string"&&100>=i.iter||i.ts!==64&&i.ts!==96&&i.ts!==128||i.ks!==128&&i.ks!==192&&i.ks!==256||2>i.iv.length||4<i.iv.length)throw new P.exception.invalid("json encrypt: invalid parameters");return typeof n=="string"?(o=P.misc.cachedPbkdf2(n,i),n=o.key.slice(0,i.ks/32),i.salt=o.salt):P.ecc&&n instanceof P.ecc.elGamal.publicKey&&(o=n.kem(),i.kemtag=o.tag,n=o.key.slice(0,i.ks/32)),typeof e=="string"&&(e=P.codec.utf8String.toBits(e)),typeof t=="string"&&(i.adata=t=P.codec.utf8String.toBits(t)),o=new P.cipher[i.cipher](n),r.g(s,i),s.key=n,i.ct=i.mode==="ccm"&&P.arrayBuffer&&P.arrayBuffer.ccm&&e instanceof ArrayBuffer?P.arrayBuffer.ccm.encrypt(o,e,i.iv,t,i.ts):P.mode[i.mode].encrypt(o,e,i.iv,t,i.ts),i},encrypt:function(n,e,t,s){var r=P.json,i=r.ja.apply(r,arguments);return r.encode(i)},ia:function(n,e,t,s){t=t||{},s=s||{};var r=P.json;e=r.g(r.g(r.g({},r.defaults),e),t,!0);var i,o;if(i=e.adata,typeof e.salt=="string"&&(e.salt=P.codec.base64.toBits(e.salt)),typeof e.iv=="string"&&(e.iv=P.codec.base64.toBits(e.iv)),!P.mode[e.mode]||!P.cipher[e.cipher]||typeof n=="string"&&100>=e.iter||e.ts!==64&&e.ts!==96&&e.ts!==128||e.ks!==128&&e.ks!==192&&e.ks!==256||!e.iv||2>e.iv.length||4<e.iv.length)throw new P.exception.invalid("json decrypt: invalid parameters");return typeof n=="string"?(o=P.misc.cachedPbkdf2(n,e),n=o.key.slice(0,e.ks/32),e.salt=o.salt):P.ecc&&n instanceof P.ecc.elGamal.secretKey&&(n=n.unkem(P.codec.base64.toBits(e.kemtag)).slice(0,e.ks/32)),typeof i=="string"&&(i=P.codec.utf8String.toBits(i)),o=new P.cipher[e.cipher](n),i=e.mode==="ccm"&&P.arrayBuffer&&P.arrayBuffer.ccm&&e.ct instanceof ArrayBuffer?P.arrayBuffer.ccm.decrypt(o,e.ct,e.iv,e.tag,i,e.ts):P.mode[e.mode].decrypt(o,e.ct,e.iv,i,e.ts),r.g(s,e),s.key=n,t.raw===1?i:P.codec.utf8String.fromBits(i)},decrypt:function(n,e,t,s){var r=P.json;return r.ia(n,r.decode(e),t,s)},encode:function(n){var e,t="{",s="";for(e in n)if(n.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new P.exception.invalid("json encode: invalid property name");switch(t+=s+'"'+e+'":',s=",",typeof n[e]){case"number":case"boolean":t+=n[e];break;case"string":t+='"'+escape(n[e])+'"';break;case"object":t+='"'+P.codec.base64.fromBits(n[e],0)+'"';break;default:throw new P.exception.bug("json encode: unsupported type")}}return t+"}"},decode:function(n){if(n=n.replace(/\s/g,""),!n.match(/^\{.*\}$/))throw new P.exception.invalid("json decode: this isn't json!");n=n.replace(/^\{|\}$/g,"").split(/,/);var e={},t,s;for(t=0;t<n.length;t++){if(!(s=n[t].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new P.exception.invalid("json decode: this isn't json!");s[3]!=null?e[s[2]]=parseInt(s[3],10):s[4]!=null?e[s[2]]=s[2].match(/^(ct|adata|salt|iv)$/)?P.codec.base64.toBits(s[4]):unescape(s[4]):s[5]!=null&&(e[s[2]]=s[5]==="true")}return e},g:function(n,e,t){if(n===void 0&&(n={}),e===void 0)return n;for(var s in e)if(e.hasOwnProperty(s)){if(t&&n[s]!==void 0&&n[s]!==e[s])throw new P.exception.invalid("required parameter overridden");n[s]=e[s]}return n},sa:function(n,e){var t={},s;for(s in n)n.hasOwnProperty(s)&&n[s]!==e[s]&&(t[s]=n[s]);return t},ra:function(n,e){var t={},s;for(s=0;s<e.length;s++)n[e[s]]!==void 0&&(t[e[s]]=n[e[s]]);return t}};P.encrypt=P.json.encrypt;P.decrypt=P.json.decrypt;P.misc.pa={};P.misc.cachedPbkdf2=function(n,e){var t=P.misc.pa,s;return e=e||{},s=e.iter||1e3,t=t[n]=t[n]||{},s=t[s]=t[s]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):P.random.randomWords(2,0)},t=e.salt===void 0?s.firstSalt:e.salt,s[t]=s[t]||P.misc.pbkdf2(n,t,e.iter),{key:s[t].slice(0),salt:t.slice(0)}};var se=P;var rs=class extends(void 0){name="e2ee";keys;securedKeys=!1;encryptedkeys;secret;constructor(e,t,s,r){super(e),t&&(s&&r?(this.securedKeys=!0,this.encryptedkeys=se.encrypt(r,JSON.stringify(t)).cipher,this.secret=r):Object.assign(this.keys,t)),this.load(this)}addKey=(e,t)=>{if(t||(t=`key${Math.floor(Math.random()*1e15)}`),this.securedKeys&&this.secret&&this.encryptedkeys){let s=JSON.parse(se.decrypt(this.secret,this.encryptedkeys));return s[t]={key:e,_id:t},this.encryptedkeys=se.encrypt(this.secret,s).cipher,this.encryptedkeys}else this.keys[t]={key:e,_id:t};return this.keys[t]};static generateSecret(){return se.codec.base64.fromBits(se.random.randomWords(8,10))}encrypt(e,t){return e=se.encrypt(t,e).cipher,e}decrypt(e,t){return e=se.decrypt(t,e),e}encryptRoute=(e,t)=>{typeof e=="object"&&(e=JSON.stringify(e));let s;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(se.decrypt(this.secret,this.encryptedkeys));r[t]?.key&&(e=se.encrypt(this.secret,r[t].key).cipher)}else this.keys[t]&&(s||(s=t),e=this.encrypt(e,s));return e={route:"decryptRoute",args:[e,t]},e};decryptRoute=(e,t)=>{let s=e;if(typeof e=="object"){if(t||typeof e.keyId=="string"&&(t=e.keyId),t){let r;if(this.securedKeys&&this.secret&&this.encryptedkeys){let i=JSON.parse(se.decrypt(this.secret,this.encryptedkeys));if(i[t]?.key)return s=se.decrypt(this.secret,i[t].key),s}else this.keys[t]&&(r=this.keys[t].key),r&&(s=this.decrypt(e.args,r))}}else{let r;if(this.securedKeys&&this.secret&&this.encryptedkeys){let i=JSON.parse(se.decrypt(this.secret,this.encryptedkeys));if(i[t]?.key)return s=se.decrypt(this.secret,i[t].key),s}else this.keys[t]&&(r=this.keys[t].key),r&&(s=this.decrypt(e,r))}return s};transmit=(e,t)=>(t||(t=Object.keys(this.keys)[0]),e=this.encryptRoute(e,t),this.handleServiceMessage(e));receive=(e,t)=>{if(t||(t=Object.keys(this.keys)[0]),e=this.decryptRoute(e,t),typeof e=="string"){let s=e.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(e=e.replace(/\\/g,"")),e[0]==='"'&&(e=e.substring(1,e.length-1)),e=JSON.parse(e))}if(typeof e=="object"){if(typeof e.method=="string")return this.handleMethod(e.route,e.method,e.args);if(typeof e.route=="string")return this.handleServiceMessage(e);if(typeof e.node=="string"||e.node instanceof void 0)return this.handleGraphNodeCall(e.node,e.args);this.__node.keepState&&(e.route&&this.setState({[e.route]:e.args}),e.node&&this.setState({[e.node]:e.args}))}else return e}};var Pt=fe(require("http")),Tt=fe(require("https")),ee=fe(require("fs")),ue=fe(require("path"));function Qi(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=t}):e+=n,e+="</body></html>",e}function en(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=`<script src="${t}"></script>`}):e+=`<script src="${n}"></script>`,e+="</body></html>",e}var is=function(n=4/24){return`//https://github.com/ibrahima92/pwa-with-vanilla-js

//https://github.com/ibrahima92/pwa-with-vanilla-js
let cacheName = 'pwa-assets';
const assets = [
  "/",
  "/index.html",
  "/dist/index.css", //alt default paths
  "/dist/index.js",
  '/favicon.ico'
];

let cacheExpiration = 1000 * 60 * //seconds 
  60 * //minutes
  24 * //hours
  ${n};    //days

let isValid = function (response) {
	if (!response) return false;
	var fetched = response.headers.get('sw-fetched-on');
	if (fetched && (!navigator.onLine || (parseFloat(fetched) + (cacheExpiration)) > new Date().getTime())) 
      return true;
	return false;
};

self.addEventListener("install", installEvent => {
  installEvent.waitUntil(
    caches.open(cacheName).then(cache => {
      cache.addAll(assets);
    })
  );
});

self.addEventListener("fetch", fetchEvent => { //https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/
  fetchEvent.respondWith(
    caches.match(fetchEvent.request).then(function (response) {

        // If there's a cached API and it's still valid, use it
        if (isValid(response)) {
            return response;
        }

        // Otherwise, make a fresh API call
        if(response && !assets.includes(fetchEvent.request.url)) return response;
        // Otherwise, make a fresh API call
        else return fetch(fetchEvent.request).then(function (response) {

            // Cache for offline access
            if(assets.includes(fetchEvent.request.url)){
              var copy = response.clone();
              fetchEvent.waitUntil(caches.open(cacheName).then(function (cache) {
                var headers = new Headers(copy.headers);
                headers.append('sw-fetched-on', new Date().getTime());
                return copy.blob().then(function (body) {
                  return cache.put(fetchEvent.request, new Response(body, {
                    status: copy.status ? copy.status : 200,
                    statusText: copy.statusText,
                    headers: headers
                  }));
                });
              }));
            }
            
            // Return the requested file
            return response;

        })
        // .catch(function (error) {
        // 	return caches.match(request).then(function (response) { //fallback to offline cache
        // 		return response || caches.match('/offline.json'); //todo: figure out what is supposed to go in offline.json (https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/)
        // 	});
        // });  
  }));
});

`},ns=(n="PWA")=>`{
    "short_name": "${n}",
    "name": "${n}",
    "start_url": "/",
    "display": "standalone",
    "theme_color": "#000000",
    "background_color": "#ffffff",
    "description": "${n} Test",
    "lang": "en-US",
    "permissions": [
        "storage"
    ],
    "icons":[{
        "src": "./assets/logo196.png",
        "sizes": "196x196"
    },
    {
        "src": "./assets/logo512.png",
        "sizes": "512x512"
    }]
}`;var os=class extends he{name="http";server;debug=!1;servers={};mimeTypes={".html":"text/html",".htm":"text/html",".js":"text/javascript",".css":"text/css",".json":"application/json",".txt":"text/plain",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpg",".gif":"image/gif",".svg":"image/svg+xml",".xhtml":"application/xhtml+xml",".bmp":"image/bmp",".wav":"audio/wav",".mp3":"audio/mpeg",".mp4":"video/mp4",".xml":"application/xml",".webm":"video/webm",".webp":"image/webp",".weba":"audio/webm",".woff":"font/woff",woff2:"font/woff2",".ttf":"application/font-ttf",".eot":"application/vnd.ms-fontobject",".otf":"application/font-otf",".wasm":"application/wasm",".zip":"application/zip",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".tif":"image/tiff",".sh":"application/x-sh",".csh":"application/x-csh",".rar":"application/vnd.rar",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".odt":"application/vnd.oasis.opendocument.text",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odp":"application/vnd.oasis.opendocument.presentation",".mpeg":"video/mpeg",".mjs":"text/javascript",".cjs":"text/javascript",".jsonld":"application/ld+json",".jar":"application/java-archive",".ico":"image/vnd.microsoft.icon",".gz":"application/gzip",epub:"application/epub+zip",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".csv":"text/csv",".avi":"video/x-msvideo",".aac":"audio/aac",".mpkg":"application/vnd.apple.installer+xml",".oga":"audio/ogg",".ogv":"video/ogg",ogx:"application/ogg",".php":"application/x-httpd-php",".rtf":"application/rtf",".swf":"application/x-shockwave-flash",".7z":"application/x-7z-compressed",".3gp":"video/3gpp"};constructor(e,t){super(e),this.load(this),t&&this.setupServer(t)}onStarted=(e,t,s)=>{console.log(`\u{1F431} Node server running at 
            ${e}://${t}:${s}/`)};setupServer=(e={protocol:"http",host:"localhost",port:8080,startpage:"index.html"},t,s)=>{if(e.pages){for(let r in e.pages)if(typeof e.pages[r]=="string")this.addPage(`${e.port}/${r}`,e.pages[r]);else if(typeof e.pages[r]=="object"||typeof e.pages[r]=="function"){e.pages[r].template&&(e.pages[r].get=e.pages[r].template);let i=`${e.port}/${r}`;r!=="_all"&&this.load({[i]:e.pages[r]})}}this.setupHTTPserver(e,t,s)};open=this.setupServer;setupHTTPserver=(e={host:"localhost",port:8080,startpage:"index.html",errpage:void 0},t,s=()=>{this.onStarted("http",e.host,e.port)})=>{let r=e.host?e.host:"localhost",i=e.port?e.port:8e3;if(!r||!i)return;let o=`${r}:${i}`;this.servers[o]&&this.terminate(this.servers[o]),"keepState"in e||(e.keepState=!0);let l={server:void 0,type:"httpserver",address:o,...e};t||(t=(u,p)=>{let g={args:{request:u,response:p},method:u.method,served:l},v=u.url.slice(1);if(v||(v="/"),e.debug){let w=At(new Date);console.log(w," | ","From: ",u.socket?.remoteAddress,"For: ",u.url," | ",u.method)}e.pages?tn.call(this,v,g,e.pages,u,p,e.port):g.route=v,this.receive(g)});let c;if(e.protocol==="http")c=Pt.createServer(t);else{let u;e.keypath&&e.certpath?(u={key:ee.readFileSync(e.keypath),cert:ee.readFileSync(e.certpath),passphrase:e.passphrase},c=Tt.createServer(u,t)):console.error("Error, key and/or cert .pem SSL files not provided. See OpenSSL certbot for more info on how to create free SSL certifications, or create your own self-signed one for local development.")}if(!c){console.error("Server not successfully created.");return}return l.server=c,l.terminate=()=>{this.terminate(l)},l.service=this,this.servers[o]=l,l._id=e._id?e._id:o,new Promise((u,p)=>{let g;c.on("error",v=>{l.onerror?l.onerror(v,l):console.error("Server error:",v.toString()),g||p(v)}),c.on("clientError",(v,w)=>{l.onerror?l.onerror(v,l):console.error(At(new Date)," | Server clientError:",v.toString()," | From: ",w.remoteAddress),w&&w.destroy()}),c.on("tlsClientError",(v,w)=>{l.onerror?l.onerror(v,l):console.error(At(new Date)," | Server tlsClientError: ",v.toString()," | From: ",w.remoteAddress),w&&w.destroy()}),c.on("upgrade",(v,w,A)=>{l.onupgrade&&l.onupgrade(v,w,A,l)}),c.listen(i,r,()=>{s(),l.onopen&&l.onopen(l),g=!0,u(l)})})};transmit=(e,t,s,r)=>{let i=e;if(typeof i=="object"&&!i.byteLength&&(i=JSON.stringify(i)),typeof t=="string"&&e)return this.POST(t,e);if(typeof t=="string")return this.GET(t);if(t)t.headers||(t.headers={"Content-Type":"application/json","Content-Length":i.length});else{let o=this.servers[Object.keys(this.servers)[0]];t={protocol:o.protocol,host:o.host,port:o.port,method:"POST",path:e.route,headers:{"Content-Type":"application/json","Content-Length":i.length}}}return this.request(t,i,s,r)};withResult=(e,t,s)=>{if(t&&!e.writableEnded&&!e.destroyed){let r="text/plain",i={};if(typeof t=="string"){let o=ue.extname(t);if(o&&ee.existsSync(ue.join(process.cwd(),t))){if(r=this.mimeTypes[o]||"application/octet-stream",t=ee.readFileSync(ue.join(process.cwd(),t)),r==="text/html"&&(s.served?.pages?._all||s.served?.pages?.[s.route])){let{templateString:l,headers:c}=this.injectPageCode(t.toString(),s.route,s.served);t=l,Object.assign(i,c)}}else if(typeof t=="string"&&t.includes("<")&&t.includes(">")&&t.indexOf("<")<t.indexOf(">")){if(i["Content-Type"]="text/html",s?.served?.pages?._all||s?.served?.pages?.[s.route]){let{templateString:l,headers:c}=this.injectPageCode(t,s.route,s.served);t=l,Object.assign(i,c)}e.writeHead(200,i),e.end(t,"utf-8");return}}else typeof t=="object"&&(t=JSON.stringify(t),r="application/json");i["Content-Type"]=r,e.writeHead(200,i),e.end(t,"utf-8")}else try{e.destroy()}catch{}};injectPageCode=(e,t,s)=>{s?.pages?.[t]?.inject&&(typeof s.pages[t].inject=="object"?e=this.buildPage(s.pages[t].inject,e):typeof s.pages[t].inject=="function"?e+=s.pages[t].inject():(typeof s.pages[t].inject=="string"||typeof s.pages[t].inject=="number")&&(e+=s.pages[t].inject)),s?.pages?._all?.inject&&(typeof s.pages._all.inject=="object"?e=this.buildPage(s.pages._all.inject,e):typeof s.pages._all.inject=="function"?e+=s.pages._all.inject():(typeof s.pages._all.inject=="string"||typeof s.pages._all.inject=="number")&&(e+=s.pages._all.inject));let r={};return s.pages._all?.headers&&Object.assign(r,s.pages._all.headers),s.pages[t]?.headers&&Object.assign(r,s.pages[t].headers),{templateString:e,headers:r}};receive=e=>(this.debug&&console.log(e.args.request.method,e.args.request.url),new Promise((s,r)=>{this.responsePromiseHandler(s,r,e,e.args.request,e.args.response,e.method,e.served)}).catch(s=>{console.error("Request Error:",s)}));responseOnErrorPromiseHandler=(e,t,s)=>{if(!e.writableEnded||!e.destroyed)e.statusCode=400,e.end(void 0,void 0),t(s);else{try{e.destroy()}catch{}t(s)}};getFailedPromiseHandler=(e,t,s,r,i,o)=>{if((i.writableEnded||i.destroyed)&&t(s),s=="./"||s==o?.startpage){let l="<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Brains@Play Server</h1></body></html>";if(o?.pages?._all||o?.pages?.error){let{templateString:c,headers:u}=this.injectPageCode(l,r.route,o);l=c}i.writeHead(200,{"Content-Type":"text/html"}),i.end(l,"utf-8"),e(l),o?.keepState&&this.setState({[o.address]:l});return}else this.debug&&console.log(`File ${s} does not exist on path!`);i.writeHead(500),i.end(void 0,void 0),t(s)};handleBufferedPostBodyPromiseHandler=(e,t,s,r,i)=>{if(t=Buffer.concat(t).toString(),typeof t=="string"){let p=t.substring(0,8);(p.includes("{")||p.includes("["))&&(p.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}let o,l,c;if(t?.route&&(o=t.route,l=t.method,c=t.args,o||(typeof t.route=="string"&&t.route.includes("/")&&t.route.length>1&&(t.route=t.route.split("/").pop()),o=t.route)),!o&&s?.route){let p=s.route;l=s.method,c=s.args,p||(typeof s.route=="string"&&s.route.includes("/")&&s.route.length>1&&(s.route=s.route.split("/").pop()),p=s.route)}let u=t;if(o)if(this.restrict?.[o]){try{r.destroy()}catch{}e(u)}else t.method?u=this.handleMethod(o,l,c):t.node?u=this.handleGraphNodeCall(t.node,t.args):u=this.handleServiceMessage({route:o,args:c,method:l}),u instanceof Promise?u.then(p=>{this.withResult(r,p,s),i?.keepState&&this.setState({[i.address]:u}),e(u)}):(this.withResult(r,u,s),i?.keepState&&this.setState({[i.address]:u}),e(u));else if(!r.writableEnded||!r.destroyed)r.statusCode=200,r.end(void 0,void 0),e(u);else{try{r.destroy()}catch{}e(u)}};onRequestFileReadPromiseHandler=(e,t,s,r,i,o,l,c)=>{if(e)if(e.code=="ENOENT")if(c?.errpage)ee.readFile(c.errpage,(g,v)=>{if(o.writeHead(404,{"Content-Type":"text/html"}),c.pages?._all||c.pages?.error){let{templateString:w,headers:A}=this.injectPageCode(v.toString(),l.route,c);v=w}o.end(v,"utf-8"),r(v)});else{o.writeHead(404,{"Content-Type":"text/html"});let g=`<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Error: ${e.code}</h1></body></html>`;if(c?.pages?._all||c?.pages?.[l.route]){let{templateString:v,headers:w}=this.injectPageCode(g.toString(),l.route,c);g=v}o.end(g,"utf-8"),r(e.code)}else o.writeHead(500),o.end("Something went wrong: "+e.code+` ..
`,"utf-8"),r(e.code);else{var u=String(ue.extname(i)).toLowerCase(),p=this.mimeTypes[u]||"application/octet-stream";let g={"Content-Type":p};if(p==="text/html"&&(c?.pages?._all||c?.pages?.[l.route])){let{templateString:v,headers:w}=this.injectPageCode(t.toString(),l.route,c);Object.assign(g,w),t=v}o.writeHead(200,g),o.end(t,"utf-8"),s(t)}};responsePromiseHandler=(e,t,s,r,i,o,l)=>{if(i.on("error",u=>{if(l.debug){let p=At(new Date);console.error(p,"| Response Error: ",u," From: ",r.socket?.remoteAddress," For: ",r.url," | ",r.method)}this.responseOnErrorPromiseHandler(i,t,u),r.destroy(),r.socket?.destroy()}),o==="GET"||o==="get"){var c="."+r.url;if(r.url&&this.restrict?.[r.url]&&t(r.url),c=="./"&&l?.startpage&&(c=l.startpage),c.includes("?")&&(c=c.substring(0,c.indexOf("?"))),(r.url!=="/"||l?.startpage)&&ee.existsSync(ue.join(process.cwd(),c)))i.writableEnded||i.destroyed?t(c):ee.readFile(ue.join(process.cwd(),c),(u,p)=>{this.onRequestFileReadPromiseHandler(u,p,e,t,c,i,s,l)});else if(s.route){let u;if(l){let p=`${l.port}/${s.route}`;this.__node.nodes.get(p)&&(u=p)}if(!u&&this.__node.nodes.get(s.route)&&(u=s.route),u){let p;s.method?p=this.handleMethod(u,s.method,void 0):s.node?p=this.handleGraphNodeCall(s.node,void 0):p=this.handleServiceMessage({route:u,args:void 0,method:s.method}),p instanceof Promise?p.then(g=>{l?.keepState&&this.setState({[l.address]:p}),this.withResult(i,g,s),e(p)}):p&&(l?.keepState&&this.setState({[l.address]:p}),this.withResult(i,p,s),e(p))}else s.redirect?(i.writeHead(301,{Location:s.redirect}),i.end(),e(!0)):this.getFailedPromiseHandler(e,t,c,s,i,l)}else this.getFailedPromiseHandler(e,t,c,s,i,l)}else{let u,p=!0,g;r.on("data",v=>{u||(u=[]),u.push(v),p&&(p=!1,g&&clearTimeout(g))}).on("end",()=>{this.handleBufferedPostBodyPromiseHandler(e,u,s,i,l)}),g=setTimeout(()=>{if(p){let v=new Error(`Request timed out from | ${r.socket?.remoteAddress} | For: ${r.url} | ${r.method}`);r.destroy(v),l.server.emit("clientError",v,r.socket),l.debug&&console.error(v),t(v)}},l.timeout?l.timeout:1e3)}};request=(e,t,s,r)=>{let i=Pt;e.protocol?.includes("https")&&(i=Tt),delete e.protocol;let o=i.request(e,l=>{s&&l.on("data",s),r&&l.on("end",r)});if(e.headers)for(let l in e.headers)o.setHeader(l,e.headers[l]);return t&&o.write(t),o.end(),o};POST=(e,t,s)=>{let r=e;r instanceof URL&&(r=e.toString());let i=r.startsWith("https")?"https":"http",o,l,c,u=r.split("/");return u.forEach(g=>{if(g.includes(":")){let v=g.split(":");o=v[0],l=v[1]}}),u.length>3&&(c=u.slice(3).join("/")),this.request({protocol:i,host:o,port:l,path:c,method:"POST",headers:s},t)};GET=e=>new Promise((t,s)=>{let r=Pt,i=e;e instanceof URL&&(i=e.toString()),i.includes("https")&&(r=Tt),r.get(e,o=>{let l=[];o.on("data",c=>{l.push(c)}),o.on("end",()=>{t(Buffer.concat(l))})}).on("error",o=>{s(o)})});terminate=e=>{typeof e=="string"&&(e=this.servers[e]),typeof e=="object"&&(e.server.close(),e.onclose&&e.onclose(e))};getRequestBody(e){let t=[];return new Promise((s,r)=>{e.on("data",i=>{t.push(i)}).on("end",()=>{s(Buffer.concat(t))}).on("error",i=>{let o=new Error(`Request timed out from | ${e.socket?.remoteAddress} | For: ${e.url} | ${e.method}`);e.destroy(o),r(o)})})}addPage=(e,t)=>{typeof t=="string"&&(t.includes("<html")||(t="<!DOCTYPE html><html>"+t+"</html>")),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};addHTML=(e,t)=>{typeof t=="string"&&(!t.includes("<")||!t.includes(">"))&&(t="<div>"+t+"</div>"),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};buildPage=(e,t)=>{let s="";t&&(s+=t);let r=(i,o,l)=>{if(!Array.isArray(i[o])&&typeof i[o]=="object")for(let c in i)r(i,c,l);else if(this.__node.nodes.get(o)?.get){let c=this.__node.nodes.get(o)?.get;if(typeof c=="function"&&(Array.isArray(i[o])?c=c(...i[o]):c=c(i[o])),typeof c=="string"){let u=l.lastIndexOf("<");if(u>0){let p=l.substring(u);l=l.substring(0,u)+c+p}else l+=c}}else if(this.__node.nodes.get(o)?.__operator){let c;if(this.__node.nodes.get(o)?.__operator&&(c=this.__node.nodes.get(o).__operator(i[o])),typeof c=="string"){let u=l.lastIndexOf("<");if(u>0){let p=l.substring(u);l=l.substring(0,u)+c+p}else l+=c}}else typeof this.__node.nodes.get(o)=="string"&&(l+=this.__node.nodes.get(o));return l};if(Array.isArray(e))e.forEach(i=>{s=r(e,i,s)});else if(typeof e=="object")for(let i in e)s=r(e,i,s);else typeof e=="string"?s+=e:typeof e=="function"&&(s+=e());return s};hotreload=(e="http://localhost:8080/wss",t)=>{e instanceof URL&&(e=e.toString());let s=(r,i)=>{let o=new WebSocket(r);function l(u){let p=u.includes("/")?u.split("/"):u.split("\\"),g=p[p.length-1];var v=document.getElementsByTagName("link");for(var w in v){var A=v[w];if(!u||A.href?.includes(g)){let j=A.getAttribute("href").split("?")[0],F=j+="";A.setAttribute("href",F)}}}function c(u,p,g){let v=u.includes("/")?u.split("/"):u.split("\\"),w=v[v.length-1],A=document.querySelectorAll("[src]"),j=!1;for(let F of A)if(F.src.includes(w))if(F.tagName==="SCRIPT"&&!p){window.location.reload();return}else{let D=document.createElement("object");F.insertAdjacentElement("afterend",D),F.remove();let B=F.cloneNode(!0);D.insertAdjacentElement("beforebegin",B),D.remove(),j=!0}j||window.location.reload()}o.addEventListener("message",u=>{let p=u.data;if(typeof p=="string"&&p.startsWith("{")&&(p=JSON.parse(p)),p.file){let g=p.file,v=p.reloadscripts;g.endsWith("html")||g.endsWith("xml")||g.endsWith("wasm")?window.location.reload():g.endsWith("css")?(i.endsWith("css")||(i+=".css"),l(i)):g.endsWith("js")||g.endsWith("ts")||g.endsWith("jsx")||g.endsWith("tsx")||g.endsWith("vue")?c(g,v):(l(g),c(g))}}),o.addEventListener("close",()=>{let g=Math.round(30),v=0,w=()=>{if(v++,v>g){console.error("Could not reconnect to dev server.");return}o=new WebSocket(r),o.onerror=A=>{console.error(`Hot reload port disconnected, will reload on reconnected. Attempt ${v} of ${g}`)},o.addEventListener("error",()=>{setTimeout(w,100)}),o.addEventListener("open",()=>{location.reload()})};w()})};return`
            <script>
                console.log('Hot Reload port available at ${e}');  
                (`+s.toString()+`)('${e}',${t?`'${t}'`:void 0}); 
            </script>
        `};pwa=(e="PWA",t=4/24,s="service-worker.js")=>{ee.existsSync(s)||ee.writeFileSync(ue.join(process.cwd(),s),is(t)),ee.existsSync("manifest.webmanifest")||ee.writeFileSync(ue.join(process.cwd(),"/manifest.webmanifest"),ns(e));function r(i){Array.from(document.head.querySelectorAll("link")).find(c=>{if(c.href.includes("manifest"))return!0})||document.head.insertAdjacentHTML("beforeend",'<link rel="manifest" href="./manifest.webmanifest">');let o=!!(window.location.hostname==="localhost"||window.location.hostname==="[::1]"||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function l(){navigator.serviceWorker.register(i).then(c=>{c.onupdatefound=()=>{let u=c.installing;u!=null&&(u.onstatechange=()=>{u.state==="installed"&&(navigator.serviceWorker.controller?console.log("New content is available and will be used when all tabs for this page are closed."):console.log("Content is cached for offline use."))})}}).catch(c=>{console.error("Error during service worker registration:",c)})}"serviceWorker"in navigator&&addEventListener("load",()=>{o?(fetch(i).then(c=>{let u=c.headers.get("content-type");c.status===404||u!=null&&u.indexOf("javascript")===-1?navigator.serviceWorker.ready.then(p=>{p.unregister().then(()=>{window.location.reload()})}):l()}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")}),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker.")})):l()})}return`
            <script>
                (`+r.toString()+`)('${s}'); 
            </script>
        `}};function tn(n,e,t,s,r,i){let o=t[n],l=n;if(o)e.route=n,s.url=n;else{let c="/"+n;if(o=t[c],l=c,!o&&!ue.extname(n))if(l=n.split("/")[0]+"/*",t[l])o=t[l],e.route=l,s.url=l;else{let p=c.split("/");p[p.length-1]="",l=p.join("/")+"*",t[l]&&(o=t[l],e.route=l,s.url=l)}else e.route=c,s.url=c}return typeof o=="object"&&(o.redirect&&(n=o.redirect,e.redirect=n,e.route=n),o.onrequest&&(typeof o.onrequest=="string"&&(o.onrequest=this.__node.nodes.get(o.onrequest)),typeof o.onrequest=="object"?o.onrequest.__operator&&o.onrequest.__operator(o,s,r):typeof o.onrequest=="function"&&o.onrequest(this,this.__node.nodes.get(`${i}/${l}`),s,r))),o}function At(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var jt=fe(kr()),ls=class extends he{name="sse";debug=!1;servers={};eventsources={};connections={servers:this.servers,eventsources:this.eventsources};constructor(e){super(e),this.load(this)}openSSE=e=>{let t=e.server,s=e.path;if(this.servers[s])return!1;let r=(0,jt.createChannel)(),i={type:"sse",channel:r,sessions:{},requests:{},...e};this.servers[s]=i,i._id=e._id?e._id:s;let o=(D,B,I)=>this.transmit(D,s,B,I),l=()=>this.terminate(s),c=(D,B,I,L)=>{if(!I){let C=[];for(let N in i.sessions)C.push(this.request(D,s,N,L));return C}return this.request(D,s,B,I,L)},u=(D,B,I,L,C)=>{let N={route:D,args:B};return I&&(N.method=I),this.transmit(N,s,C,L)},p=(D,B,I,L,C)=>{let N={route:D,args:B};if(!L){let U=[];for(let G in i.sessions)U.push(this.request(N,s,G,C));return U}return this.request(N,s,I,L,C)},g=(D,B,I,L,C,N,U)=>this.subscribeToSSE(D,e.url,B,I,L,C,N,U),v=(D,B,I,L)=>p("unsubscribe",[D,B],void 0,I,L);i.send=o,i.request=c,i.post=u,i.run=p,i.subscribe=g,i.unsubscribe=v,i.terminate=l,i.graph=this;let w=(D,B)=>{if(D.url?.includes(s))if(D.method==="GET")this.debug&&console.log("SSE Request",s),(0,jt.createSession)(D,B).then(I=>{r.register(I);let L=`sse${Math.floor(Math.random()*1e15)}`;i.sessions[L]=I,this.eventsources[L]={_id:L,session:I,served:i,send:(C,N)=>o(C,N,L),request:(C,N,U)=>c(C,N,L,U),post:(C,N,U,G)=>u(C,N,U,L,G),run:(C,N,U,G)=>p(C,N,U,L,G),subscribe:(C,N)=>g(C,N,void 0,L),unsubscribe:(C,N,U)=>v(C,N,L,U),terminate:()=>(delete this.eventsources[L],delete i.sessions[L],!0),onclose:(C,N,U,G,q)=>{N.onconnectionclose&&N.onconnectionclose(C,N,U,G,q)},graph:this},I.push(JSON.stringify({route:"setId",args:L})),I.on("close",()=>{let C=this.eventsources[L],N=C.onclose;delete this.eventsources[L],N&&C.onclose(I,i,L,D,B)}),i.onconnection&&i.onconnection(I,i,L,D,B)});else{let I=[];D.on("data",L=>{I.push(L)}).on("end",()=>{if(I=Buffer.concat(I).toString(),typeof I=="string"){let G=I.substring(0,8);(G.includes("{")||G.includes("["))&&(G.includes("\\")&&(I=I.replace(/\\/g,"")),I[0]==='"'&&(I=I.substring(1,I.length-1)),I=JSON.parse(I))}let L,C,N,U;if((I?.route||I?.callbackId)&&(C=I.method,N=I.args,U=I.callbackId,typeof I.route=="string"&&(I.route.includes("/")&&I.route.length>1&&(I.route=I.route.split("/").pop()),L=this.__node.roots?.[I.route])),L){let G=this.receive({route:L,args:N,method:C})}else U&&i.requests[U]&&i.requests[U](N);this.__node.keepState&&this.setState({[s]:I})})}},A=t.listeners("request");t.removeAllListeners("request");let j=(D,B)=>{A.forEach(I=>{I(D,B)})},F=(D,B)=>{D.url&&(D.url.indexOf(s)>-1?(this.servers[s]||(t.removeListener("request",F),t.addListener("request",j)),w(D,B)):j(D,B))};return t.addListener("request",F),t.addListener("close",()=>{i.onclose&&i.onclose(i)}),i};open=this.openSSE;streamIterable=(e,t,s,r="message")=>{let i=this.servers[e];if(i)if(s){if(i.sessions[s])return i.sessions[s].iterate(t,{eventName:r})}else{let o=[];for(let l in i.sessions)o.push(i.sessions[l].iterate(t));return o}};streamReadable=(e,t,s,r="message")=>{let i=this.servers[e];if(i)if(s){if(i.sessions[s])return i.sessions[s].stream(t,{eventName:r})}else{let o=[];for(let l in i.sessions)o.push(i.sessions[l].stream(t));return o}};transmit=(e,t,s,r)=>{if(!t&&(typeof e=="object"&&!e.byteLength||typeof e=="number")){if(e?.route){let i=Object.keys(this.servers);if(i.length>0){let o=this.servers[i[0]];o.channels?.includes(e.route)&&(t=o.path,s=e.route)}!t&&e.route&&this.servers[e.route]&&(t=e.route)}e=JSON.stringify(e)}if(t||(t=Object.keys(this.servers)[0]),t&&this.servers[t]){if(r){if(this.servers[t].sessions[r]?.isConnected)this.servers[t].sessions[r].push(e,s);else if(this.servers[t].sessions[r])return delete this.servers[t].sessions[r],!1}else this.servers[t].channel.broadcast(e,s);return!0}return!1};request=(e,t,s,r,i)=>new Promise((o,l)=>{let c=`${Math.random()}`,u={route:"runRequest",args:[e,t,c,r]};s&&(u.method=s);let p=this.servers[t],g=v=>{o(v)};p.requests[c]=g,p&&(r?p.sessions[r]&&p.sessions[r].push(JSON.stringify(u),i):p.channel.broadcast(JSON.stringify(u),i))});runRequest=(e,t,s,r)=>{let i=this.receive(e);if(t){let o=this.servers[t];o&&(i instanceof Promise?i.then(l=>{r?o.sessions[r]&&o.sessions[r].push(JSON.stringify({args:l,callbackId:s})):o.channel.broadcast(JSON.stringify({args:l,callbackId:s}))}):r?o.sessions[r]&&o.sessions[r].push(JSON.stringify({args:i,callbackId:s})):o.channel.broadcast(JSON.stringify({args:i,callbackId:s})))}return i};subscribeSSE=(e,t,s,r,i,o,l)=>{if(!this.restrict?.[e]&&this.servers[t])return this.subscribe(e,c=>{this.servers[t].send({args:c,callbackId:e},l,o)},s,r,i)};subscribeToSSE=(e,t,s,r,i,o,l,c)=>{if(this.servers[t])if(this.__node.state.subscribeEvent(t,u=>{u?.callbackId===e&&(s?typeof s=="string"?this.run(s,u.args):s(u.args):this.setState({[t]:u.args}))}),l){if(this.servers[t].sessions[l])return this.eventsources[l].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,r,i,o]},void 0,c)}else{let u=[];for(let p in this.servers[t].sessions)u.push(this.eventsources[p].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,r,i,o]},void 0,c));return u}};terminate=e=>(typeof e=="object"?delete this.servers[e.path]:typeof e=="string"&&(delete this.servers[e],delete this.eventsources[e]),!0)};var uo=fe(Tr(),1),_o=fe(bs(),1),go=fe(Ss(),1),Ai=fe(Ts(),1),at=fe(xi(),1);var ke=Ai.default;var js=class extends he{name="wss";debug=!1;servers={};sockets={};connections={servers:this.servers,sockets:this.sockets};constructor(e){super(e),this.load(this)}open=e=>e?.server?this.setupWSS(e):this.openWS(e);setupWSS=e=>{let t=e.port,s=e.path,r=typeof e.server=="object"?e.server:void 0,i=e.host;delete e.server,"keepState"in e||(e.keepState=!0);let o={};e.noServer?o.noServer=!0:t?t&&(o.port=t):r&&(o.server=r),e.perMessageDeflate&&(o.perMessageDeflate=e.perMessageDeflate),e.serverOptions,Object.assign(o,e.serverOptions);let l=new at.default(o),c="";if(!i&&r){let D=r.address();t||(t=D.port),c=D.address}else i&&(c=i);t&&(c+=":"+t),s&&(s.startsWith("/")||(s="/"+s),c+=s),this.servers[c]={type:"wss",wss:l,clients:{},address:c,...e},l.addListener("connection",(D,B)=>{this.debug&&console.log(`New socket connection on ${c}`);let I=`socket${Math.floor(Math.random()*1e12)}`;if(this.servers[c].clients[I]=D,D.send(JSON.stringify({route:"setId",args:I})),this.openWS({socket:D,address:I,_id:I,debug:e.debug,onclose:(L,C)=>{this.servers[c].onconnectionclosed&&this.servers[c].onconnectionclosed(L,C,D,this.servers[c],I),delete this.servers[c].clients[I]},onmessage:e.onmessage}),e.debug){let L=po(new Date);console.log(L," | ",I," | Number of live sockets: ",Object.keys(this.servers[c].clients).length)}this.servers[c].onconnection&&this.servers[c].onconnection(D,B,this.servers[c],I)}),l.on("error",D=>{this.debug&&console.log("Socket Error:",D),this.servers[c]?.onerror?this.servers[c].onerror(D,l,this.servers[c]):console.error(D)});let u=(D,B,I)=>{if(D.headers&&D.url){this.debug&&console.log("Upgrade request at: ",D.url);let L=!1;if(s&&D.url===s)L=!0;else{let C=D.headers.host.split(":")[0];t&&(C+=":"+t),C===c?L=!0:(C+=D.url.split("?")[0],C===c&&(L=!0))}L&&this.servers[c]&&this.servers[c].wss.handleUpgrade(D,B,I,C=>{this.servers[c].onupgrade&&this.servers[c].onupgrade(C,this.servers[c],D,B,I),this.servers[c].wss.emit("connection",C,D)})}};r&&r.addListener("upgrade",u),l.addListener("close",()=>{r&&r.removeListener("upgrade",u),this.servers[c]?.onclose?this.servers[c].onclose(l,this.servers[c]):console.log(`wss closed: ${c}`),delete this.servers[c]});let p=(D,B)=>{if(typeof D=="object"&&(D=JSON.stringify(D)),B)return this.sockets[B].send(D);for(let I in this.servers[c].clients)this.sockets[I].send(D)},g=(D,B,I)=>{if(I)return this.sockets[I].request(D,B);{let L=[];for(let C in this.servers[c].clients)L.push(this.sockets[C].request(D,B));return L}},v=(D,B,I,L)=>{if(L)return this.sockets[L].post(D,B,I);for(let C in this.servers[c].clients)this.sockets[C].post(D,B,I)},w=(D,B,I,L)=>{if(L)return this.sockets[L].run(D,B,I);{let C=[];for(let N in this.servers[c].clients)C.push(this.sockets[N].run(D,B,I));return C}},A=(D,B,I,L,C,N)=>{if(I)this.sockets[I].subscribe(D,B,L,C,N);else{let U=[];for(let G in this.servers[c].clients)U.push(this.sockets[G].subscribe(D,B,L,C,N));return U}},j=(D,B,I)=>{if(I)this.sockets[I].unsubscribe(D,B);else{let L=[];for(let C in this.servers[c].clients)L.push(this.sockets[C].unsubscribe(D,B));return L}},F=D=>D?this.terminate(D):this.terminate(c);return this.servers[c].send=p,this.servers[c].request=g,this.servers[c].post=v,this.servers[c].run=w,this.servers[c].subscribe=A,this.servers[c].unsubscribe=j,this.servers[c].terminate=F,this.servers[c].graph=this,this.servers[c]._id=e._id?e._id:c,this.servers[c]};openWS=e=>{if(!e.address){let g=e.protocol;g||(g="wss"),e.address=`${g}://${e.host}`,e.port&&(e.address+=":"+e.port),(!e.path||e.path?.startsWith("/"))&&(e.address+="/"),e.path&&(e.address+=e.path)}let t=e.address,s;if(e.socket?s=e.socket:s=new ke(t),"keepState"in e||(e.keepState=!0),e.onmessage)s.on("message",g=>{this.sockets[t].onmessage(g,s,this.sockets[t])});else if(e._id)s.addListener("message",g=>{ArrayBuffer.isView(g)&&(g=g.toString()),e.debug&&console.log("Message from ",e._id,": ",g),this.receive(g,s,this.sockets[t]),e.keepState&&this.setState({[t]:g})});else{let g=v=>{if(ArrayBuffer.isView(v)&&(v=v.toString()),v&&(e.debug&&console.log("Message from ",t,": ",v),typeof v=="string")){let w=v.substring(0,8);(w.includes("{")||w.includes("["))&&(w.includes("\\")&&(v=v.replace(/\\/g,"")),v[0]==='"'&&(v=v.substring(1,v.length-1)),v=JSON.parse(v),v.route==="setId"?(this.sockets[t]._id=v.args,s.removeEventListener("message",g),s.on("message",A=>{ArrayBuffer.isView(A)&&(A=A.toString()),e.debug&&console.log("Message from ",this.sockets[t]._id,": ",A),this.receive(A,s,this.sockets[t]),e.keepState&&this.setState({[t]:A})})):(this.receive(v,s,this.sockets[t]),this.setState({[t]:v})))}this.receive(v,s,this.sockets[t]),e.keepState&&this.setState({[t]:v})};s.addListener("message",g),e.onmessage=g}s.addListener("open",()=>{this.sockets[t].onopen&&this.sockets[t].onopen(s,this.sockets[t])}),s.addListener("close",(g,v)=>{let w=this.sockets[t],A=w.onclose;delete this.sockets[t],A&&A(g,v,s,w)}),s.on("error",g=>{this.sockets[t]?.onerror&&this.sockets[t].onerror(g,s,this.sockets[t])});let r=g=>this.transmit(g,s),i=(g,v,w)=>{let A={route:g,args:v};return w&&(A.method=w),this.transmit(A,s)},o=(g,v,w)=>new Promise((A,j)=>{let F=Math.random(),D={route:"runRequest",args:[{route:g,args:v},this.sockets[t]._id,F]};w&&(D.args[0].method=w);let B=I=>{let L=I.data;typeof L=="string"&&L.indexOf("{")>-1&&(L=JSON.parse(L)),typeof L=="object"&&L.callbackId===F&&(s.removeEventListener("message",B),A(L.args))};s.addEventListener("message",B),this.transmit(D,s)}),l=(g,v)=>this.request(g,s,this.sockets[t]._id,v),c=(g,v)=>this.subscribeToSocket(g,this.sockets[t]._id,v),u=(g,v)=>o("unsubscribe",[g,v]),p=()=>{this.terminate(this.sockets[t]._id)};return this.sockets[t]={type:"socket",socket:s,send:r,post:i,request:l,run:o,subscribe:c,unsubscribe:u,terminate:p,graph:this,__node:{tag:t},...e},this.sockets[t]};transmit=(e,t)=>{if((typeof e=="object"&&(e?.route||e?.node||typeof e.arrayBuffer!="function"&&typeof e.byteLength!="number"&&typeof e[0]?.byteLength!="number")||typeof e=="number")&&(e=JSON.stringify(e)),!t){let s=this.servers[Object.keys(this.servers)[0]];if(s)t=s.wss;else{let r=this.sockets[Object.keys(this.sockets)[0]];r&&(t=r.socket)}}t instanceof at.default?t.clients.forEach(s=>{s.send(e)}):t instanceof ke&&t.send(e)};closeWS=e=>{if(e){if(typeof e=="string"){for(let t in this.sockets)if(t.includes(e)){e=this.sockets[t].socket,delete this.sockets[t];break}}}else{let t=this.sockets[Object.keys(this.sockets)[0]];t&&(e=t.socket)}return e instanceof ke&&e.readyState===e.OPEN&&e.close(),!0};terminate=e=>{let t;if(e){if(typeof e=="string"){t=e;for(let s in this.servers)if(s.includes(e)||this.servers[s]._id===e){e=this.servers[s].wss;for(let r in this.servers[s].clients)this.closeWS(this.servers[s].clients[r]);delete this.servers[s];break}if(!e){for(let s in this.sockets)if(s.includes(e)||this.sockets[s]._id===e){e=this.sockets[s].socket,delete this.sockets[s];break}}}}else{let s=Object.keys(this.servers);for(let i in s)this.terminate(i);let r=Object.keys(this.sockets);for(let i in r)this.terminate(i)}return e instanceof at.default?e.close(s=>{s&&console.error(s)}):e instanceof ke&&(e.readyState===e.OPEN&&e.close(),this.get(t||e.url)&&this.remove(t||e.url)),!0};request=(e,t,s,r)=>{let i=`${Math.random()}`,o={route:"runRequest",args:[e,s,i]};return r&&(o.method=r),new Promise((l,c)=>{let u=p=>{let g=p.data;typeof g=="string"&&g.includes("callbackId")&&(g=JSON.parse(g)),typeof g=="object"&&g.callbackId===i&&(t.removeEventListener("message",u),l(g.args))};t.addEventListener("message",u),t.send(JSON.stringify(o))})};runRequest=(e,t,s)=>{let r=this.receive(e);if(t){if(typeof t=="string"){for(let i in this.servers)for(let o in this.servers[i].clients)if(o===t){t=this.servers[i].clients[o];break}if(!(t instanceof ke)){for(let i in this.sockets)if(i===t){t=this.sockets[i].socket;break}}}r instanceof Promise?r.then(i=>{r={args:i,callbackId:s},t instanceof ke&&t.send(JSON.stringify(r))}):(r={args:r,callbackId:s},t instanceof ke&&t.send(JSON.stringify(r)))}return r};subscribeSocket=(e,t,s,r,i)=>{if(!this.restrict?.[e]){if(typeof t=="string")if(this.sockets[t])t=this.sockets[t].socket;else for(let o in this.servers)this.servers[o].clients[t]&&(t=this.servers[o].clients[t]);if(typeof t=="object")return this.subscribe(e,o=>{t.readyState===t.OPEN&&(o instanceof Promise?o.then(l=>{t.send(JSON.stringify({args:l,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e})))},s,r,i)}};subscribeToSocket=(e,t,s,r,i,o)=>{if(typeof t=="string"&&this.sockets[t])return this.__node.state.subscribeEvent(t,l=>{l?.callbackId===e&&(s?typeof s=="string"?this.setState({[s]:l.args}):s(l.args):this.setState({[t]:l.args}))}),this.sockets[t].request({route:"subscribeSocket",args:[e,t,r,i,o]})}};function po(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var xe=require("child_process");var Pi=fe(require("path")),Ns=class extends he{processes;connections={processes:void 0};subprocessloader={process:(e,t,s,r,i)=>{e.command&&this.createProcess(e)}};constructor(e){super(e),this.load(this),this.connections.processes=this.processes,process?.stdin&&process.stdin.on("data",t=>{let s=t.toString();this.receive(s)})}createProcess=e=>{let t=e;if(t.command||(t.command="node"),t.args||(t.args=[Pi.default.join(process.cwd(),"node_modules","graphscript-node","services","cmd","childprocess.js")]),t.command){let s;t.options||(t.options={shell:!0,stdio:"inherit"}),t.controller=new AbortController,t.options=Object.assign({signal:t.controller.signal,env:process.env,cwd:process.cwd()},t.options),t.tag?t._id=t.tag:(t._id=`process${Math.floor(Math.random()*1e15)}`,t.tag=t._id),typeof t.command=="string"&&(t.command.includes(".js")?s=(0,xe.fork)(t.command,t.args,t.options):s=(0,xe.spawn)(t.command,t.args?t.args:[],t.options),s instanceof xe.ChildProcess&&(s.stderr&&(t.onerror?s.stderr.on("data",t.onerror):s.stderr.on("data",console.error)),s.stdout&&(t.stdout?s.stdout.on("data",t.stdout):s.stdout.on("data",r=>{let i=r.toString();this.receive(i),this.setState({[t._id]:i})})),t.onclose&&s.on("close",t.onclose),t.process=s,t.controller=new AbortController,t.send=r=>s.send(r),t.request=(r,i)=>this.request(r,t._id,i),t.post=(r,i,o)=>{let l={route:r,args:i};return o&&(l.method=o),s.send(JSON.stringify(l))},t.run=(r,i,o)=>{let l={route:r,args:i};return o&&(l.method=o),this.request(l,t._id)},t.subscribe=(r,i,o,l,c)=>this.subscribeToProcess(r,t._id,i,o,l,c),t.unsubscribe=(r,i)=>t.run("unsubscribe",[r,i]),this.processes[t._id]=t))}return t};open=this.createProcess;abort=e=>(e.controller?e.controller.abort():e.kill(),!0);send=(e,t)=>e.send(t);request=(e,t,s)=>{let r=this.processes[t].process;return new Promise((i,o)=>{let l=Math.random(),c={route:"runRequest",args:[e,l]};s&&(c.method=s);let u=p=>{let g=p.toString();if(g.includes("{")){let v=JSON.parse(g);v.callbackId===l&&(r.removeListener("data",u),i(v.args))}};r.addListener("data",u),r.send(c)})};runRequest=(e,t,s)=>{let r=this.receive(e);return typeof s=="string"&&(s=this.processes[s].process),r instanceof Promise?r.then(i=>{r={args:i,callbackId:t},s instanceof xe.ChildProcess?s.send(JSON.stringify(r)):process.stdout.write(JSON.stringify(r))}):(r={args:r,callbackId:t},s instanceof xe.ChildProcess?s.send(JSON.stringify(r)):process.stdout.write(JSON.stringify(r))),r};subscribeProcess(e,t,s,r,i){if(!this.restrict?.[e])return typeof t=="string"&&this.processes[t]&&(t=this.processes[t].process),this.subscribe(e,o=>{o instanceof Promise?o.then(l=>{t.send(JSON.stringify({args:l,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e}))},s,r,i)}subscribeToProcess(e,t,s,r,i,o){if(typeof t=="string"&&this.processes[t])return this.__node.state.subscribeEvent(t,l=>{l?.callbackId===e&&(s?typeof s=="string"?this.run(s,l.args):s(l.args):this.setState({[t]:l.args}))}),this.processes[t].request(JSON.stringify({route:"subscribeSocket",args:[e,t,r,i,o]}))}};var re={};Zs(re,{AuthorizationStruct:()=>Fs,ChatroomStruct:()=>qs,CoherenceMap:()=>Wt,CoherenceStruct:()=>$t,CommentStruct:()=>$s,Data:()=>Ei,DataStruct:()=>Bs,DateStruct:()=>Hs,ECGStruct:()=>Ht,EDAStruct:()=>Ds,EEGCoordinates:()=>Ti,EEGStruct:()=>ve,EMGStruct:()=>Us,EventStruct:()=>Gs,EyeTrackerStruct:()=>Is,FNIRSStruct:()=>Jt,FrequencyBandsStruct:()=>ct,GroupStruct:()=>zs,HRVStruct:()=>Ms,IMUStruct:()=>Cs,NotificationStruct:()=>Ws,PPGStruct:()=>Ls,ProfileStruct:()=>Rs,ScheduleStruct:()=>Js,Struct:()=>K,eegCoordinates:()=>Ae,setCoordinate:()=>lt,structRegistry:()=>ji});function K(n="struct",e={},t={_id:""},s={structType:"struct",_id:""}){function r(o=""){return`${o+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}let i={_id:r(n+"defaultId"),structType:n,ownerId:t?._id,timestamp:Date.now(),parent:{structType:s?.structType,_id:s?._id}};return i.ownerId||delete i.ownerId,i?.parent?._id||delete i.parent,Object.keys(e).length>0&&Object.assign(i,e),i}var Ae={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function lt(n,e={}){if(!Ae[n.tag]&&n.position&&(Ae[n.tag]=[n.position.x,n.position.y,n.position.z]),Ae[n.tag]){let t={channel:"",position:{x:Ae[n.tag][0],y:Ae[n.tag][1],z:Ae[n.tag][2]}};return Object.assign(e,t)}else return Object.assign(e,n)}function Ti(n=[],e=!0){let t=[];for(let s of n){let r=ve(s);t.push(r)}return e&&t.push(...Wt({channelDicts:n})),t}function ct(n=[],e={}){let t={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return n.forEach(s=>t[s]=[]),Object.assign(e,t)}function ve(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=ct(),i={tag:n,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(r)),means:JSON.parse(JSON.stringify(r)),startTime:Date.now()},o=K("eeg",i,t,s);return n&&lt(i,o),Object.assign(o,e)}function $t(n={0:ve("FP1"),1:ve("FP2")},e={},t={_id:""},s={structType:"struct",_id:""}){let r=ct(),i={tag:n[0]?.tag+"::"+n[1]?.tag,x0:n[0]?.position?.x,y0:n[0]?.position?.y,z0:n[0]?.position?.z,x1:n[1]?.position?.x,y1:n[1]?.position?.y,z1:n[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(r)),means:JSON.parse(JSON.stringify(r)),startTime:Date.now()},o=K("coherence",i,t,s);return Object.assign(o,e)}function Wt(n={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},t={_id:""},s={structType:"struct",_id:""}){for(var r=[],i=1,o=0,l=0;l<n.channelDicts.length*(n.channelDicts.length+1)/2-n.channelDicts.length;l++){if(n.taggedOnly===!1||n.taggedOnly===!0&&n.channelDicts[o].tag!==null&&n.channelDicts[o+i].tag!==null&&n.channelDicts[o].tag!=="other"&&n.channelDicts[o+i].tag!=="other"&&n.channelDicts[o].analyze===!0&&n.channelDicts[o+i].analyze===!0){var c=ve(n.channelDicts[o].tag),u=ve(n.channelDicts[o+i].tag);r.push($t({0:c,1:u},{},t,s))}i++,i+o===n.channelDicts.length&&(o++,i=1)}return r}function Jt(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},i=K("fnirs",r,t,s);return n&&lt(r,i),Object.assign(i,e)}function Cs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},i=K("imu",r,t,s);return n&&lt(r,i),Object.assign(i,e)}function Is(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},i=K("eyetracker",r,t,s);return Object.assign(i,e)}function Ht(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},i=K("ecg",r,t,s);return Object.assign(i,e)}function Ds(n="",e={},t={_id:""},s={structType:"struct",_id:""}){}function Ls(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Jt(n,t,s,e);return r.structType="ppg",r}function Ms(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=Ht(n,t,s,e);return r.structType="hrv",r}function Us(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=ve(n,t,s,e);return r.structType="emg",r}function Rs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=K("profile",{tag:n,name:"",username:"",firstName:"",lastName:"",email:"",phone:"",sex:"",birthday:"",type:"",pictureUrl:"",userRoles:{},socials:{},data:{},hidden:!1,accessToken:"",refreshToken:""},t,s);return Object.assign(i,e)}function Fs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=K("authorization",{tag:n,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:{},structs:{},excluded:{},groups:{},status:"PENDING",expires:!1,associatedAuthId:""},t,s);return Object.assign(i,e)}function zs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=K("group",{tag:n,name:"",details:"",admins:{},peers:{},clients:{},users:{}},t,s);return Object.assign(i,e)}function Ei(n,e){return{type:n,data:e,timestamp:Date.now()}}function Bs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,title:"",author:"",expires:!1,type:"",data:new Array},i=K("data",r,t,s);return Object.assign(i,e)}function Gs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,event:"",author:"",startTime:"",endTime:"",grade:void 0,value:void 0,units:void 0,location:void 0,notes:"",attachments:new Array,users:{}},i=K("event",r,t,s);return Object.assign(i,e)}function qs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:{},audioChatActive:!1,videoChatActive:!1},i=K("chatroom",r,t,s);return Object.assign(i,e)}function $s(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:{},attachments:new Array},i=K("comment",r,t,s);return Object.assign(i,e)}function Ws(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=K("notification",{tag:n,note:"",parentUserId:""},t,s);return Object.assign(i,e)}function Js(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,title:"",author:"",attachments:new Array,dates:new Array},i=K("schedule",r,t,s);return Object.assign(i,e)}function Hs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r={tag:n,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},i=K("date",r,t,s);return Object.assign(i,e)}var ji={Struct:K,EEGStruct:ve,FNIRSStruct:Jt,CoherenceStruct:$t,CoherenceMap:Wt,FrequencyBandsStruct:ct,IMUStruct:Cs,EyeTrackerStruct:Is,ECGStruct:Ht,EDAStruct:Ds,PPGStruct:Ls,HRVStruct:Ms,EMGStruct:Us,ProfileStruct:Rs,AuthorizationStruct:Fs,GroupStruct:zs,DataStruct:Bs,EventStruct:Gs,ChatroomStruct:qs,CommentStruct:$s,NotificationStruct:Ws,ScheduleStruct:Js,DateStruct:Hs};var ft=class{id;threaded;workers;DS=re;collections=new Map;data={byTime:{},notes:{},events:{},sleep:{},food:{},rx:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}};rolloverLimit=5e4;dataSorts=new Map;watches={};constructor(e={}){Object.assign(this.data,e),this.dataSorts=new Map,this.watches={},this.setSort("event",t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],t.event==="sleep"&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t)),this.setSort(["notes","note","link"],t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t)),this.id=this.randomId("dataTablet")}randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(e){let t=s=>{let r=s.structType,i=this.collections.get(r);i||(i=new Map,this.collections.set(r,i)),i.set(s._id,s),this.onCollectionSet(r,i)};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)}getLocalData(e,t){let s="",r="",i="";if(typeof t=="object"?(s=t.ownerId,r=Object.keys(t).filter(c=>c!="ownerId")[0],i=t[r]):i=t,!e&&!s&&!r&&!i)return[];let o=[];if(!e&&(s||r))return this.collections.forEach(l=>{if((r==="_id"||r==="id")&&i){let c=l.get(i);c&&o.push(c)}else l.forEach(c=>{r&&i?c[r]===i&&c.ownerId===s&&o.push(c):c.ownerId===s&&o.push(c)})}),o;{let l=this.collections.get(e);if(!l)return o;if(!r&&!s)return l.forEach(c=>{o.push(c)}),o;if((r==="_id"||r==="id")&&i)return l.get(i);l.forEach((c,u)=>{r&&i&&!s?c[r]===i&&o.push(c):s&&!r?c.ownerId===s&&o.push(c):s&&r&&i&&c.ownerId===s&&c[r]&&c[r]===i&&o.push(c)})}return o}onCollectionSet=(e,t)=>{};runSort(e,t={},s=[],r=this){let i,o=this.getSort(e);if(o)i=o(t,s,r);else return!1;return i}setSort(e,t=(s,r=[],i=this)=>{}){Array.isArray(e)?e.forEach(s=>{this.dataSorts.set(s,t)}):this.dataSorts.set(e,t)}getSort(e){return this.dataSorts.get(e)}checkWatches(e={}){for(let t in this.watches)this.watches[t].ondata(e,this.watches[t].accum,this.watches[t].ownerId)&&(this.watches[t].ontrigger(this.watches[t].accum),this.watches[t].triggered=!1)}setWatch(e,t,s=(i,o,l)=>(i.ownerId===l&&(o.data[i._id]=i),Object.keys(o.data).length>10),r=i=>{console.log(i);let o=K("alert",{alert:!0,data:i},{_id:i[Object.keys(i)[0]].ownerId});i={}}){this.watches[e]={accum:{},ownerId:t,ondata:s,ontrigger:r}}getWatch(e){return this.watches[e]}async sortStructsIntoTable(e=[]){let t=function(r,i){if(r.timestamp&&i.timestamp)return r.timestamp-i.timestamp};e.sort(t);let s=[];for(let r=0;r<e.length;r++){let i=e[r];if(!i.timestamp)continue;let o=i.timestamp;if(this.data.byTime[o]?this.data.byTime[o].push(i):this.data.byTime[o]=[i],i.structType==="data"&&i.data)i.data.forEach(async l=>{if(typeof l=="object"&&!Array.isArray(l)){let c=l.dataType;if(l.ownerId=i.ownerId,l.timestamp||(l.timestamp=o),c){let u=this.runSort(c,l,s,this);u?u.constructor?.name!=="Promise"&&(this.checkWatches(u),this.onUpdate(o,u),s.push(u)):(this.data[c]||(this.data[c]={}),l.timestamp=o,this.data[c][o]?this.data[c][o].push(l):this.data[c][o]=[l],this.data.byTime[o]?this.data.byTime[o].push(l):this.data.byTime[o]=[l],this.checkWatches(l),this.onUpdate(o,l),s.push(l))}}});else{let l=this.runSort(i.structType,i,s,this);if(l)this.checkWatches(l),this.onUpdate(o,l),s.push(l);else{let c=i.structType;this.data[c]||(this.data[c]={}),this.data[c][o]?this.data[c][o].push(i):this.data[c][o]=[i],this.checkWatches(i),this.onUpdate(o,i),s.push(i)}}}for(let r in this.data)this.data[r]=this.sortObjectByPropName(this.data[r]);this.onSorted(s)}onUpdate(e,t,s=this.data){}onSorted(e=[]){}getDataByTimestamp(e,t){let s=this.data.byTime[e];return t&&s&&(s=s.filter(r=>t?t===r.ownerId:!0)),s}getDataByTimeRange(e,t,s,r){let i={};if(s){for(let o in this.data[s]){let l=parseInt(o);l>e&&l<t&&(i[o]=[...this.data[s][o]])}s==="sleep"&&(i=this.filterSleepResults(i))}else for(let o in this.data.byTime){let l=parseInt(o);l>e&&l<t&&(i[o]=[...this.data.byTime[o]])}if(r&&i)for(let o in i){let l=[];i[o]=i[o],i[o].forEach((c,u)=>{c.ownerId!==r&&l.push(u)}),l.reverse().forEach(c=>{i[o].splice(c,1)}),i[o].length===0&&delete i[o]}return i}getDataByType(e,t,s){if(!this.data[e])return;let r={...this.data[e]};if(t&&(r=[...r[t]]),s&&r)for(let i in r){let o=[];r[i]=[...r[i]],r[i].forEach((l,c)=>{l.ownerId!==s&&o.push(c)}),o.reverse().forEach(l=>{r[i].splice(l,1)}),r[i].length===0&&delete r[i]}return e==="sleep"&&(r=this.filterSleepResults(r)),r}filterSleepResults(e={}){let t=[];for(let r in e)e[r]=[...e[r]],t.push(...e[r].filter(i=>i.structType==="event"));return t.forEach(r=>{let i;for(let o in e)e[o].forEach((l,c)=>l.structType==="fitbitsleep"&&r.startTime&&r.endTime&&Math.abs(l.startTime-r.startTime)<1e3*12*3600&&Math.abs(l.endTime-r.endTime)<1e3*12*3600&&r.endTime-r.startTime>1e3*2*3600?(i=c,!0):!1),i&&e[o].splice(i,1)}),e}sortObjectByPropName(e){return Object.keys(e).sort().reduce((s,r)=>(s[r]=e[r],s),{})}checkRollover(e,t=this.rolloverLimit){if(!e)return!1;let s=this.collections.get(e);return s?(s.forEach(r=>{for(let i in r)Array.isArray(r[i])?r[i].length>t&&(r[i].slice(r[i].length-t),i==="ffts"?r.fftCount=r[i].length:i==="times"&&(r.count=r[i].length)):typeof r[i]=="object"&&this.checkRollover(r[i])}),!0):!1}};var Ni=["now","minute","5 minutes","30 minutes","hour","6 hours","12 hours","day","3 days","week","2 weeks","month","6 months","year","5 years","decade"];function yo(n=Ni){let e=["now"];return n.forEach(t=>{t!=="now"?e.push(`last ${t}`):e.push(t)}),e}function pe(n){let e=new Date;if(n!=="now"){if(n==="last minute")e.setMinutes(e.getMinutes()-1);else if(n==="last hour")e.setHours(e.getHours()-1);else if(n==="last day")e.setDate(e.getDate()-1);else if(n==="last week")e.setDate(e.getDate()-7);else if(n==="last month")e.setMonth(e.getMonth()-1);else if(n==="last year")e.setFullYear(e.getFullYear()-1);else if(n==="last decade")e.setFullYear(e.getFullYear()-1*10);else if(n==="last century")e.setFullYear(e.getFullYear()-1*100);else if(n==="last millennium")e.setFullYear(e.getFullYear()-1*1e3);else if(n==="last microsecond")e.setMilliseconds(e.getMilliseconds()-1);else if(n==="last nanosecond")e.setMilliseconds(e.getMilliseconds()-1*.001);else if(n.startsWith("last")){let[,t,s]=n.match(/last (\d+) (\w+)/)||[];if(t&&s){let r=parseInt(t,10);s.includes("minute")?e.setMinutes(e.getMinutes()-r):s.includes("hour")?e.setHours(e.getHours()-r):s.includes("day")?e.setDate(e.getDate()-r):s.includes("week")?e.setDate(e.getDate()-r*7):s.includes("month")?e.setMonth(e.getMonth()-r):s.includes("year")?e.setFullYear(e.getFullYear()-r):s.includes("decade")?e.setFullYear(e.getFullYear()-r*10):s.includes("century")?e.setFullYear(e.getFullYear()-r*100):s.includes("millennium")?e.setFullYear(e.getFullYear()-r*1e3):s.includes("microsecond")?e.setMilliseconds(e.getMilliseconds()-r):s.includes("nanosecond")&&e.setMilliseconds(e.getMilliseconds()-r*.001)}}}return e.getTime()}(()=>{var n=class{data={};triggers={};ctr=0;constructor(f){typeof f=="object"&&(this.data=f)}setState=f=>{Object.assign(this.data,f);let a=Object.getOwnPropertyNames(f);for(let h of a)this.triggerEvent(h,this.data[h]);if(this.triggers[e]){let h=_=>{_(f)},d=this.triggers[e].length;for(let _=d-1;_>=0;_--)h(this.triggers[e][_].onchange)}return this.data};setValue=(f,a)=>{this.data[f]=a,this.triggerEvent(f,a)};triggerEvent=(f,a)=>{if(this.triggers[f]){let h=_=>{_.onchange(a)},d=this.triggers[f].length;for(let _=d-1;_>=0;_--)h(this.triggers[f][_])}};subscribeState=f=>this.subscribeEvent(e,f);unsubscribeState=f=>this.unsubscribeEvent(e,f);subscribeEvent=(f,a,h,d)=>{if(f){h&&d&&!this.triggers[f]&&Object.defineProperty(this.data,f,{get:()=>h[d],set:y=>{h[d]=y},enumerable:!0,configurable:!0}),this.triggers[f]||(this.triggers[f]=[]);let _=this.ctr;return this.ctr++,this.triggers[f].push({sub:_,onchange:a}),_}else return};unsubscribeEvent=(f,a)=>{let h=this.triggers[f];if(h)if(a===void 0)delete this.triggers[f],delete this.data[f];else{let d,_=h.find((y,m)=>{if(y.sub===a)return d=m,!0});return _&&h.splice(d,1),Object.keys(h).length===0&&(delete this.triggers[f],delete this.data[f]),this.onRemoved&&this.onRemoved(_),!0}};subscribeEventOnce=(f,a)=>{let h,d=_=>{a(_),this.unsubscribeEvent(f,h)};return h=this.subscribeEvent(f,d),h};getEvent=(f,a)=>{if(typeof a!="number")return this.triggers[f];for(let h in this.triggers[f])if(this.triggers[f][h].sub===a)return this.triggers[f][h]};getSnapshot=()=>{let f={};for(let a in this.data)f[a]=this.data[a]};onRemoved},e="*s",t=new n,s=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},r=class Ci{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:t};__children;__parent;__operator;__listeners;__props;__args;constructor(a,h,d){if(this.__setProperties(a,h,d),typeof a=="function"||a?.__callable){let _=new s;_.__call=(...m)=>this.__operator(...m);let y=new Proxy(_,{get:(m,b,S)=>Reflect.has(this,b)?Reflect.get(this,b,S):Reflect.get(m,b,S),set:(m,b,S,O)=>Reflect.has(this,b)?Reflect.set(this,b,S,O):Reflect.set(m,b,S,O)});return Object.setPrototypeOf(y,this),y}}get __graph(){return this.__node?.graph}set __graph(a){this.__node.graph=a}__setProperties=(a,h,d)=>{if((()=>{let _=a;typeof a=="function"?u(a)?a=new a:a={__operator:a,__node:{forward:!0,tag:a.name}}:typeof a=="string"&&d?.get(a)&&(a=d.get(a)),"__node"in a||(a.__node={}),a.__node.initial||(a.__node.initial=_)})(),typeof a=="object"){let _=()=>{a.__node?.state?this.__node.state=a.__node.state:d&&(a.__node.state=d.__node.state)},y=()=>{a.__props&&(typeof a.__props=="function"&&(a.__props=new a.__props),typeof a.__props=="object"&&this.__proxyObject(a.__props))},m=()=>{a.__node.tag||(a.__operator?.name?a.__node.tag=a.__operator.name:a.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},b=()=>{typeof a.__node=="string"?d?.get(a.__node.tag)?a=d.get(a.__node.tag):a.__node={}:a.__node||(a.__node={}),d&&(a.__node.graph=d),a instanceof i&&(a.__node.source=a)},S=()=>{if(!a.__parent&&h&&(a.__parent=h),h?.__node&&!(h instanceof i||a instanceof i)&&(a.__node.tag=h.__node.tag+"."+a.__node.tag),h instanceof i&&a instanceof i&&(a.__node.loaders&&Object.assign(h.__node.loaders?h.__node.loaders:{},a.__node.loaders),h.__node.mapGraphs)){a.__node.nodes.forEach(E=>{h.set(a.__node.tag+"."+E.__node.tag,E)});let k=()=>{a.__node.nodes.forEach(E=>{h.__node.nodes.delete(a.__node.tag+"."+E.__node.tag)})};this.__addOndisconnected(k)}},O=()=>{if(typeof a.default=="function"&&!a.__operator&&(a.__operator=a.default),a.__operator){if(typeof a.__operator=="string"&&d){let k=d.get(a.__operator);k&&(a.__operator=k.__operator),!a.__node.tag&&a.__operator.name&&(a.__node.tag=a.__operator.name)}typeof a.__operator=="function"&&(a.__operator=this.__setOperator(a.__operator)),a.default&&(a.default=a.__operator)}},T=()=>{a.__node=Object.assign(this.__node,a.__node);let k=Object.getOwnPropertyNames(a).filter(E=>{if(!w[E])return!0});for(let E of k)E in a&&E!=="name"&&(this[E]=a[E])},x=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(k=>k.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(k=>k.bind(this))))};_(),m(),y(),b(),S(),T(),x(),O()}};__subscribe=(a,h,d,_,y,m,b)=>{let S=(T,x=(E,R)=>R||E,k=a)=>{let E;if(m){let $=v(k,m,this.__node.graph);k=$.__callback,E=$.__args}let R=this.__node.state.subscribeEvent(T,k,this,h),z=this.__node.state.getEvent(T,R);return this.__listeners||(this.__listeners={}),this.__listeners[T]=this.__node.state.triggers[T],z&&(z.source=this.__node.tag,h&&(z.key=h),z.target=x(a,_),y&&(z.tkey=y),d&&(z.subInput=d),m&&(z.arguments=E,z.__args=m),b&&(z.__callback=b),z.node=this,z.graph=this.__node.graph),R},O=T=>{let x=this.__node.graph.get(T);if(!x&&T.includes(".")){_=T.substring(0,T.lastIndexOf("."));let k=this.__node.graph.get(T.substring(0,_));y=T.lastIndexOf(".")+1,k&&typeof k[h]=="function"&&(T=(...E)=>k[y](...E))}else x.__operator&&(T=x.__operator,y="__operator");return T};if(h){if((!this.__node.localState||!this.__node.localState[h])&&this.__addLocalState(this,h),typeof a=="string"){if(b=this.__node.tag+"."+a,y=a,_){if(this.__node.graph?.get(_)){let k=this.__node.graph?.get(_);if(typeof k[a]=="function"){let E=k[a];a=(...R)=>{E(...R)}}else{let E=a;a=R=>{k[E]=R}}}}else if(typeof this[a]=="function"){let k=this[a];a=(...E)=>{k(...E)}}else this.__node.graph?.get(a)&&(a=O(a));if(typeof a!="function")return}let T,x=d?this.__node.unique+"."+h+"input":this.__node.unique+"."+h;return typeof a=="function"&&!a?.__node?T=S(x,(k,E)=>E||k,a):a?.__node&&(T=S(x,(k,E)=>E||k.__node.unique,(...k)=>{a.__operator&&a.__operator(...k)})),T}else{if(typeof a=="string"&&(b=a,_||(_=a),this.__node.graph.get(a)&&(a=this.__node.graph.get(a)),y="__operator",typeof a!="object"))return;let T,x=d?this.__node.unique+"input":this.__node.unique;return typeof a=="function"&&!a?.__node?T=S(x,(k,E)=>E||k,a):a?.__node&&(T=S(x,(k,E)=>E||k.__node.unique,(...k)=>{a.__operator&&a.__operator(...k)})),T}};__unsubscribe=(a,h,d)=>h?this.__node.state.unsubscribeEvent(d?this.__node.unique+"."+h+"input":this.__node.unique+"."+h,a):this.__node.state.unsubscribeEvent(d?this.__node.unique+"input":this.__node.unique,a);__setOperator=a=>{a=a.bind(this),this.__args&&this.__node.graph&&(a=v(a,this.__args,this.__node.graph).__callback);let h=`${this.__node.unique}input`;if(this.__operator=(...d)=>{this.__node.state.triggers[h]&&this.__node.state.setValue(h,d);let _=a(...d);return this.__node.state.triggers[this.__node.unique]&&(typeof _?.then=="function"?_.then(y=>{y!==void 0&&this.__node.state.setValue(this.__node.unique,y)}).catch(console.error):_!==void 0&&this.__node.state.setValue(this.__node.unique,_)),_},this.__parent instanceof Ci&&!this.__subscribedToParent&&this.__parent.__operator){let d=this.__parent.__subscribe(this),_=()=>{this.__parent?.__unsubscribe(d),delete this.__subscribedToParent};this.__addOndisconnected(_),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(a,h)=>{if(!a)return;this.__node.localState||(this.__node.localState={});let d=this.__node.localState,_=(y,m)=>{let b=this.__node.unique+"."+m,S=`${b}input`,O,T,x,k;if(typeof y[m]=="function"&&m!=="__operator")this.__props?.[m]?x=this.__props:x=d,O=()=>x[m],T=E=>{this.__props?.[m]||(E=E.bind(this)),x[m]=(...R)=>{this.__node.state.triggers[S]&&this.__node.state.setValue(S,R);let z=E(...R);return this.__node.state.triggers[b]&&(typeof z?.then=="function"?z.then($=>{this.__node.state.triggerEvent(b,$)}).catch(console.error):this.__node.state.triggerEvent(b,z)),z}},d[m]=y[m].bind(this),k={get:O,set:T,enumerable:!0,configurable:!0};else if(m!=="__graph"){let E,R,z;this.__props?.[m]?z=this.__props:z=d,E=()=>z[m],R=$=>{z[m]=$,this.__node.state.triggers[b]&&this.__node.state.triggerEvent(b,$)},d[m]=y[m],k={get:E,set:R,enumerable:!0,configurable:!0}}if(Object.defineProperty(y,m,k),typeof this.__node.initial=="object"){let E=Object.getOwnPropertyDescriptor(this.__node.initial,m);(E===void 0||E?.configurable)&&Object.defineProperty(this.__node.initial,m,k)}};if(h)_(a,h);else for(let y in a)_(a,y)};__proxyObject=a=>{let h=l(a);for(let d of h){let _={get:()=>a[d],set:y=>{a[d]=y},enumerable:!0,configurable:!0};if(Object.defineProperty(this,d,_),typeof this.__node.initial=="object"){let y=Object.getOwnPropertyDescriptor(this.__node.initial,d);(y===void 0||y?.configurable)&&Object.defineProperty(this.__node.initial,d,_)}}};__addOnconnected(a){a=a.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(a):typeof this.__onconnected=="function"?this.__onconnected=[a,this.__onconnected]:this.__onconnected=a}__addOndisconnected(a){a=a.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(a):typeof this.__ondisconnected=="function"?this.__ondisconnected=[a,this.__ondisconnected]:this.__ondisconnected=a}__callConnected(a=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let h=d=>{d(this)};this.__onconnected.forEach(h)}}__callDisconnected(a=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let h=d=>{d(this)};this.__ondisconnected.forEach(h)}}},i=class Ii{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:t,roots:{}};constructor(a){this.init(a)}init=a=>{if(a){let h=Object.assign({},a);delete h.roots,o(this.__node,h),a.roots&&this.load(a.roots)}};load=(a,h=!1)=>{function d(m,b,S=!0,O=!0){if(O){m||(m={});for(let T in b)!T.startsWith("__")&&b[T]&&typeof b[T]=="object"?(m[T]=b[T],b[T]?.__children&&d({},b[T].__children,!1,!1)):typeof b[T]=="function"&&(m[T]=b[T]);d(m,b,!0,!1)}else if(b?.__children&&!S)b.__children?.constructor.name==="Object"?m.__children?.constructor.name==="Object"?m.__children=d(m.__children,b.__children,!0,!1):m.__children=d({},b.__children,!0,!1):m.__children=b.__children;else if(S)for(let T in b)!T.startsWith("__")&&b[T]&&typeof b[T]=="object"?(m[T]=Object.assign({},b[T]),b[T]?.__children&&(m[T].__children=d({},b[T].__children,!1,!1))):typeof b[T]=="function"&&(m[T]=b[T]);return m}this.__node.roots=d(this.__node.roots?this.__node.roots:{},a);let _=Object.assign({},a);_.__node&&delete _.__node;let y=this.recursiveSet(_,this,void 0,a,h);if(a.__node){if(!a.__node.tag)a.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(a.__node.tag)){let m=new r(a,this,this);this.set(m.__node.tag,m),this.runLoaders(m,this,a,a.__node.tag),m.__listeners&&(y[m.__node.tag]=m.__listeners)}}else a.__listeners&&this.setListeners(a.__listeners);return this.setListeners(y),_};setLoaders=(a,h)=>(h?this.__node.loaders=a:Object.assign(this.__node.loaders,a),this.__node.loaders);runLoaders=(a,h,d,_)=>{for(let y in this.__node.loaders)typeof this.__node.loaders[y]=="object"?(this.__node.loaders[y].init&&this.__node.loaders[y](a,h,this,this.__node.roots,d,_),this.__node.loaders[y].connected&&a.__addOnconnected(this.__node.loaders[y].connect),this.__node.loaders[y].disconnected&&a.__addOndisconnected(this.__node.loaders[y].disconnect)):typeof this.__node.loaders[y]=="function"&&this.__node.loaders[y](a,h,this,this.__node.roots,d,_)};add=(a,h,d=!0)=>{let _={};typeof h=="string"&&(h=this.get(h));let y;if(typeof a=="function"?u(a)?a.prototype instanceof r?(a=a.prototype.constructor(a,h,this),y=!0):a=new a:a={__operator:a,__callable:!0}:typeof a=="string"&&(a=this.__node.roots[a]),!a)return;if(!y){let S=Object.getOwnPropertyNames(a),O=Object.getOwnPropertyNames(Object.getPrototypeOf(a));S.push(...O),S=S.filter(x=>!w.includes(x));let T={};for(let x of S)T[x]=a[x];a=T}if(a.__node||(a.__node={}),a.__node.initial=a,typeof a=="object"&&this.get(a.__node.tag))if(d)this.remove(a.__node.tag,!0);else return;else if(a.__node.tag&&this.get(a.__node.tag))return this.get(a.__node.tag);let m,b=o({},a,2);if(y?m=a:m=new r(a,h,this),this.set(m.__node.tag,m),this.runLoaders(m,h,a,m.__node.tag),this.__node.roots[m.__node.tag]=b,m.__children&&(m.__children=Object.assign({},m.__children),this.recursiveSet(m.__children,m,_,m.__children)),m.__listeners){_[m.__node.tag]=Object.assign({},m.__listeners);for(let S in m.__listeners){let O=m.__listeners[S];m[S]&&(delete _[m.__node.tag][S],_[m.__node.tag][m.__node.tag+"."+S]=O),typeof O=="string"&&(m.__children?.[O]?_[m.__node.tag][S]=m.__node.tag+"."+O:h instanceof r&&(h.__node.tag===O||h.__node.tag.includes(".")&&h.__node.tag.split(".").pop()===O)&&(_[m.__node.tag][S]=h.__node.tag))}}return this.setListeners(_),m.__callConnected(),m};recursiveSet=(a,h,d={},_,y=!1)=>{let m=Object.getOwnPropertyNames(_).filter(S=>!w.includes(S)),b=Object.getOwnPropertyNames(Object.getPrototypeOf(_)).filter(S=>!w.includes(S));m.push(...b);for(let S of m){if(S.includes("__"))continue;let O=_[S];if(Array.isArray(O))continue;let T;if(typeof O=="function"?u(O)?(O=new O,O instanceof r&&(O=O.prototype.constructor(O,h,this),T=!0)):O={__operator:O,__callable:!0}:typeof O=="string"?this.__node.nodes.get(O)?O=this.__node.nodes.get(O):O=this.__node.roots[O]:typeof O=="boolean"&&(this.__node.nodes.get(S)?O=this.__node.nodes.get(S):O=this.__node.roots[S]),O&&typeof O=="object"){if(!T&&!(O instanceof r)){let R=Object.getOwnPropertyNames(O).filter(oe=>!w.includes(oe)),z=Object.getOwnPropertyNames(Object.getPrototypeOf(O)).filter(oe=>!w.includes(oe));z.splice(z.indexOf("constructor"),1),R.push(...z);let $={};for(let oe of R)$[oe]=O[oe];O=$}if(O.__node||(O.__node={}),O.__node.tag||(O.__node.tag=S),O.__node.initial||(O.__node.initial=a[S]),y&&this.get(O.__node.tag))this.remove(O.__node.tag,!0);else if(this.get(O.__node.tag)&&!(!(h instanceof Ii)&&h?.__node)||h?.__node&&this.get(h.__node.tag+"."+O.__node.tag))continue;let x,k=!1,E=o({},O,2);if(T||O instanceof r?x=O:(x=new r(O,h,this),k=!0),!k&&O instanceof r&&!T&&h instanceof r){let R=this.subscribe(h.__node.tag,x.__node.tag),z=$=>{this.unsubscribe(h.__node.tag,R)};x.__addOndisconnected(z)}else if(x){if(this.set(x.__node.tag,x),this.runLoaders(x,h,a[S],S),a[S]=x,this.__node.roots[x.__node.tag]=E,x.__children&&(x.__children=Object.assign({},x.__children),this.recursiveSet(x.__children,x,d,x.__children)),x.__listeners){d[x.__node.tag]=Object.assign({},x.__listeners);for(let R in x.__listeners){let z=x.__listeners[R],$=R;x[R]&&(delete d[x.__node.tag][R],$=x.__node.tag+"."+R,d[x.__node.tag][$]=z),typeof z=="string"&&(x.__children?.[z]?d[x.__node.tag][$]=x.__node.tag+"."+z:h instanceof r&&(h.__node.tag===z||h.__node.tag.includes(".")&&h.__node.tag.split(".").pop()===z)&&(d[x.__node.tag][$]=h.__node.tag))}}x.__callConnected()}}}return d};remove=(a,h=!0)=>{if(this.unsubscribe(a),typeof a=="string"&&(a=this.get(a)),a instanceof r){this.delete(a.__node.tag),delete this.__node.roots[a.__node.tag],h&&this.clearListeners(a),a.__callDisconnected();let d=_=>{for(let y in _)this.unsubscribe(_[y]),this.delete(_[y].__node.tag),delete this.__node.roots[_[y].__node.tag],this.delete(y),delete this.__node.roots[y],_[y].__node.tag=_[y].__node.tag.substring(_[y].__node.tag.lastIndexOf(".")+1),h&&this.clearListeners(_[y]),_[y].__callDisconnected(),_[y].__children&&d(_[y].__children)};a.__children&&d(a.__children)}return a?.__node.tag&&a?.__parent&&(delete a?.__parent,a.__node.tag=a.__node.tag.substring(a.__node.tag.indexOf(".")+1)),a?.__node.graph&&(a.__node.graph=void 0),a};run=(a,...h)=>{if(typeof a=="string"){let d=this.get(a);if(!d&&a.includes(".")){if(d=this.get(a.substring(0,a.lastIndexOf("."))),typeof d?.[a.substring(a.lastIndexOf(".")+1)]=="function")return d[a.substring(a.lastIndexOf(".")+1)](...h)}else if(d?.__operator)return d.__operator(...h)}if(a?.__operator)return a?.__operator(...h)};setListeners=a=>{for(let h in a){let d=this.get(h);if(typeof a[h]=="object")for(let _ in a[h]){let y=this.get(_),m;if(typeof a[h][_]!="object")a[h][_]={__callback:a[h][_]};else if(!a[h][_].__callback)for(let b in a[h][_]){typeof a[h][_][b]!="object"&&(a[h][_][b]={__callback:a[h][_][b]},d.__operator&&(a[h][_][b].__callback===!0||typeof a[h][_][b].__callback>"u")&&(a[h][_][b].__callback=d.__operator));let S=this.get(b);if(S)m=this.subscribe(S,a[h][_][b].__callback,a[h][_][b].__args,void 0,a[h][_][b].subInput,h);else{let O=_.substring(0,_.lastIndexOf("."));if(S=this.get(O),S){let T=_.substring(_.lastIndexOf(".")+1);m=this.subscribe(S,a[h][_][b].__callback,a[h][_][b].__args,T,a[h][_][b].subInput,h)}}}if("__callback"in a[h][_])if(d&&((a[h][_].__callback===!0||typeof a[h][_].__callback>"u")&&(a[h][_].__callback=d.__operator),typeof a[h][_].__callback=="function"&&(a[h][_].__callback=a[h][_].__callback.bind(d))),y)m=this.subscribe(y,a[h][_].__callback,a[h][_].__args,void 0,a[h][_].subInput,h);else{let b=_.substring(0,_.lastIndexOf("."));y=this.get(b),y&&(m=this.subscribe(y,a[h][_].__callback,a[h][_].__args,_.substring(_.lastIndexOf(".")+1),a[h][_].subInput,h))}}}};clearListeners=(a,h)=>{if(typeof a=="string"&&(a=this.get(a)),a?.__listeners)for(let d in a.__listeners){if(h&&d!==h||typeof a.__listeners[d]?.sub!="number")continue;let _=this.get(d);if(_)if(typeof!a.__listeners[d]?.__callback=="number")for(let y in a.__listeners[d])a.__listeners[d][y]?.sub&&(this.unsubscribe(_,a.__listeners[d][y].sub,void 0,a.__listeners[d][y].subInput),a.__listeners[d][y].sub=void 0);else typeof a.__listeners[d]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d].sub,void 0,a.__listeners[d].subInput),a.__listeners[d].sub=void 0);else if(_=this.get(d.substring(0,d.lastIndexOf("."))),_)if(typeof a.__listeners[d]=="object"&&!a.__listeners[d]?.__callback)for(let y in a.__listeners[d])typeof a.__listeners[d][y]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d][y].sub,d.substring(d.lastIndexOf(".")+1),a.__listeners[d][y].subInput),a.__listeners[d][y].sub=void 0);else typeof a.__listeners[d]?.sub=="number"&&(this.unsubscribe(_,a.__listeners[d].sub,d.substring(d.lastIndexOf(".")+1),a.__listeners[d].subInput),a.__listeners[d].sub=void 0)}};get=a=>this.__node.nodes.get(a);getByUnique=a=>Array.from(this.__node.nodes.values()).find(h=>{if(h.__node.unique===a)return!0});set=(a,h)=>this.__node.nodes.set(a,h);delete=a=>this.__node.nodes.delete(a);list=()=>Array.from(this.__node.nodes.keys());getListener=(a,h,d)=>{let _=this.get(a);if(_){let y=_.__node.unique;return h&&(y+="."+h),this.__node.state.getEvent(y,d)}};getProps=(a,h)=>{if(typeof a=="string"&&(a=this.get(a)),a instanceof r){let d;if(h)d=Object.assign({},this.__node.roots[a.__node.tag]);else{d=Object.assign({},a);for(let _ in d)_.includes("__")&&delete d[_]}}};subscribe=(a,h,d,_,y,m,b)=>{let S=a;typeof a=="string"&&(S=this.get(a),!S&&a.includes(".")&&(S=this.get(a.substring(0,a.lastIndexOf("."))),_=a.substring(a.lastIndexOf(".")+1))),m instanceof r&&(m=m.__node.tag);let O;if(typeof h=="string"){O=h;let x=k=>{if(this.get(k)?.__operator){let E=this.get(k);m=k,k=function(...R){return E.__operator(...R)}}else if(k.includes(".")){m=k.substring(0,k.lastIndexOf("."));let E=this.get(m),R=k.substring(k.lastIndexOf(".")+1);b=R,typeof E[R]=="function"?E[R]instanceof r?k=E[R]:k=function(...z){return E[R](...z)}:k=function(z){return E[R]=z,E[R]}}return k};if(m){let k=this.get(m);typeof k?.[h]=="function"?(b=h,h=function(...E){return k[_](...E)}):k?.[_]?(b=_,k[_]instanceof r?h=k[_]:h=function(E){return k[_]=E,k[_]}):h=x(h)}else h=x(h)}let T;if(S instanceof r){let x=()=>{T=S.__subscribe(h,_,y,m,b,d,O);let k=()=>{T!==void 0&&S.__unsubscribe(T,_,y),T=void 0};S.__addOndisconnected(()=>{k(),S.__addOnconnected(()=>{T===void 0&&S.__node.graph.__node.tag===this.__node.tag&&x()})}),typeof h=="string"&&this.get(h)&&(h=this.get(h)),h instanceof r&&h.__addOndisconnected(()=>{k()})};x()}else if(typeof a=="string"){let x=this.get(a);if(x){if(h instanceof r&&h.__operator){let k=()=>{T=x.__subscribe(h.__operator,_,y,m,b,d,O);let E=()=>{T!==void 0&&x.__unsubscribe(T,_,y)};x.__addOndisconnected(()=>{E(),x.__addOnconnected(()=>{T===void 0&&x.__node.graph.__node.tag===this.__node.tag&&k()})}),h.__addOndisconnected(E)};k()}else if(typeof h=="function"||typeof h=="string"){let k=()=>{T=x.__subscribe(h,_,y,m,b,d,O);let E=()=>{T!==void 0&&x.__unsubscribe(T,_,y),T=void 0};x.__addOndisconnected(()=>{E(),x.__addOnconnected(()=>{T===void 0&&x.__node.graph.__node.tag===this.__node.tag&&k()})}),typeof h=="string"&&this.get(h)&&this.get(h).__addOndisconnected(E)};k()}}else typeof h=="string"&&(h=this.__node.nodes.get(h).__operator),typeof h=="function"&&!h?.__node&&(T=this.__node.state.subscribeEvent(a,h))}return T};unsubscribe=(a,h,d,_)=>a instanceof r?a.__unsubscribe(h,d,_):this.get(a)?.__unsubscribe(h,d,_);setState=a=>{this.__node.state.setState(a)}};function o(f,a,h=1/0,d=0){for(let _ in a)a[_]?.constructor.name==="Object"&&d<h?(d++,f[_]?.constructor.name==="Object"?o(f[_],a[_],h,d):f[_]=o({},a[_],h,d)):f[_]=a[_];return f}function l(f){var a=[],h=f;do{var d=Object.getOwnPropertyNames(h);let _=function(y){a.indexOf(y)===-1&&a.push(y)};d.forEach(_)}while(h=Object.getPrototypeOf(h));return a}function c(f){let a=l(f),h={};for(let d of a)h[d]=f[d];return h}function u(f){return p(f)==="class"}function p(f){return typeof f=="function"?f.prototype?Object.getOwnPropertyDescriptor(f,"prototype")?.writable?"function":"class":f.constructor.name==="AsyncFunction"?"async":"arrow":""}var g=(f,a)=>{if(a.get(f)?.__operator){let h=a.get(f);return(...d)=>{h.__operator(...d)}}else if(f.includes(".")){let h=f.split("."),d=h.pop(),_=h.join("."),y=a.get(_);return typeof a.get(_)?.[d]=="function"?(...m)=>y[d](...m):()=>y[d]}else if(a.get(f)){let h=a.get(f);return()=>h}else{let h=f;return()=>h}},v=(f,a,h)=>{let d=[],_=(m,b)=>{if(m==="__output"||m==="__input"||m==="__callback")d[b]={__callback:S=>S,__args:void 0,idx:b};else if(typeof m=="string")d[b]={__callback:g(m,h),__args:void 0,idx:b};else if(typeof m=="function"){let S=m;d[b]={__callback:(...O)=>S(...O),__args:void 0,idx:b}}else if(typeof m=="object"&&(m.__input||m.__callback)){let S=function(O){let T=O.__input?O.__input:O.__callback;if(typeof O.__input=="string"&&(T={__callback:g(O.__input,h),__args:void 0,idx:b}),O.__args){let x=v(T,O.__args,h);T={__callback:x.__callback,__args:x.__args,idx:b}}else T={__callback:T,__args:void 0,idx:b};if(O.__output){let x=O.__output;if(typeof O.__output=="string"?x={__callback:g(x,h),__args:void 0,idx:b}:typeof m.__output=="object"&&(x=S(x)),typeof x?.__callback=="function"){let k=T.__callback,E=x.__callback;T={__callback:(...R)=>E(k(...R)),__args:x.__args,idx:b}}}return T};d[b]=S(m)}else{let S=m;d[b]={__callback:()=>S,__args:void 0,idx:b}}};a.forEach(_),typeof f=="string"&&(f={__callback:g(f,h),__args:void 0});let y=typeof f=="function"?f:f.__callback;return f=function(...m){let b=S=>S.__callback(...m);return y(...d.map(b))},{__callback:f,__args:d}},w=Object.getOwnPropertyNames(Object.getPrototypeOf({})),A=(f,a,h)=>{f.__node.backward&&a instanceof r&&h.setListeners({[a.__node.tag]:{[f.__node.tag]:a}})},j=(f,a,h)=>{if(f.__operator){let d=Math.random();if(f.__node.loops||(f.__node.loops={}),typeof f.__node.delay=="number"){let _=f.__operator;f.__setOperator((...y)=>new Promise((m,b)=>{f.__node.loops[d]=setTimeout(async()=>{m(await _(...y))},f.__node.delay)}))}else if(f.__node.frame===!0){let _=f.__operator;f.__setOperator((...y)=>new Promise((m,b)=>{f.__node.loops[d]=requestAnimationFrame(async()=>{m(await _(...y))})}))}if(typeof f.__node.repeat=="number"||typeof f.__node.recursive=="number"){let _=f.__operator;f.__setOperator(async(...y)=>{let m=f.__node.repeat?f.__node.repeat:f.__node.recursive,b,S=async(O,...T)=>{for(;O>0;){if(f.__node.delay||f.__node.frame){_(...T).then(async x=>{f.__node.recursive?await S(O,x):await S(O,...T)});break}else b=await _(...y);O--}};return await S(m,...y),b})}if(f.__node.loop&&typeof f.__node.loop=="number"){let _=f.__operator,y=f.__node.loop;f.__setOperator((...b)=>{if("looping"in f.__node||(f.__node.looping=!0),f.__node.looping){let S=performance.now();_(...b),f.__node.loops[d]=setTimeout(()=>{let O=performance.now()-S-f.__node.loop;O>0?y=f.__node.loop-O:y=f.__node.loop,y<=0&&(y=f.__node.loop),f.__operator(...b)},y)}}),f.__node.looping&&f.__operator();let m=b=>{b.__node.looping&&(b.__node.looping=!1),b.__node.loops[d]&&(clearTimeout(b.__node.loops[d]),cancelAnimationFrame(b.__node.loops[d]))};f.__addOndisconnected(m)}}},F=(f,a,h)=>{if(f.__node.animate===!0||f.__animation){let d=f.__operator;f.__setOperator((...y)=>{"animating"in f.__node||(f.__node.animating=!0),f.__node.animating&&(typeof f.__animation=="function"?f.__animation(...y):d(...y),f.__node.animationFrame=requestAnimationFrame(()=>{f.__operator(...y)}))}),(f.__node.animating||(!("animating"in f.__node)||f.__node.animating)&&f.__animation)&&setTimeout(()=>{f.__node.animationFrame=requestAnimationFrame(f.__operator)},10);let _=y=>{y.__node.animating&&(y.__node.animating=!1),y.__node.animationFrame&&cancelAnimationFrame(y.__node.animationFrame)};f.__addOndisconnected(_)}},D=(f,a,h)=>{if(typeof f.__branch=="object"&&f.__operator&&!f.__branchApplied){let d=f.__operator;f.__branchApplied=!0,f.__operator=(..._)=>{let y=d(..._);for(let m in f.__branch){let b=()=>{typeof f.__branch[m].then=="function"?f.__branch[m].then(y):f.__branch[m].then instanceof r&&f.__branch[m].then.__operator?f.__branch[m].then.__operator(y):y=f.__branch[m].then};typeof f.__branch[m].if=="function"?f.__branch[m].if(y)==!0&&b():f.__branch[m].if===y&&b()}return y}}if(f.__listeners){for(let d in f.__listeners)if(typeof f.__listeners[d]=="object"&&f.__listeners[d].branch&&!f.__listeners[d].branchApplied){let _=f.__listeners[d].callback;f.__listeners[d].branchApplied=!0,f.__listeners.callback=y=>{let m=()=>{typeof f.__listeners[d].branch.then=="function"?y=f.__listeners[d].branch.then(y):f.__listeners[d].branch.then instanceof r&&f.__listeners[d].branch.then.__operator?y=f.__listeners[d].branch.then.__operator(y):y=f.__listeners[d].branch.then};return typeof f.__listeners[d].branch.if=="function"?f.__listeners[d].branch.if(y)&&m():f.__listeners[d].branch.if===y&&m(),_(y)}}}},B=(f,a,h)=>{if(f.__listeners)for(let d in f.__listeners)typeof f.__listeners[d]=="object"&&f.__listeners[d].oncreate&&f.__listeners[d].callback(f.__listeners[d].oncreate)},I=(f,a,h)=>{if(f.__listeners)for(let d in f.__listeners)typeof f.__listeners[d]=="object"&&typeof f.__listeners[d].binding=="object"&&(f.__listeners.callback=f.__listeners.callback.bind(f.__listeners[d].binding))},L=(f,a,h)=>{if(f.__listeners){for(let d in f.__listeners)if(typeof f.__listeners[d]=="object"&&typeof f.__listeners[d].transform=="function"&&!f.__listeners[d].transformApplied){let _=f.__listeners[d].callback;f.__listeners[d].transformApplied=!0,f.__listeners.callback=y=>(y=f.__listeners[d].transform(y),_(y))}}},C=(f,a,h)=>{f.post&&!f.__operator?f.__setOperator(f.post):!f.__operator&&typeof f.get=="function"&&f.__setOperator(f.get),!f.get&&f.__operator,f.aliases&&f.aliases.forEach(d=>{h.set(d,f);let _=y=>{h.__node.nodes.delete(d)};f.__addOndisconnected(_)}),typeof h.__node.roots?.[f.__node.tag]=="object"&&f.get&&(h.__node.roots[f.__node.tag].get=f.get)},N={backprop:A,loop:j,animate:F,branching:D,triggerListenerOncreate:B,bindListener:I,transformListenerResult:L,substitute__operator:C},U=f=>{let a={};for(let h in f)typeof f[h]=="object"?a[h]=U(f[h]):typeof f[h]=="function"?a[h]=f[h].toString():a[h]=f[h];return a};function G(f){typeof f!="string"&&(f=f.toString());let a=f.match(/\(?[^]*?\)?\s*=>/);if(a)return a[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let h=f.match(/\([^]*?\)/);return h?h[0].replace(/[()\s]/gi,"").split(","):[]}var q=f=>{let a=f.indexOf("=>")+1;return a<=0&&(a=f.indexOf("){")),a<=0&&(a=f.indexOf(") {")),f.slice(0,f.indexOf("{",a)+1)};function V(f=""){let a=y=>y.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),h=q(f),d=a(f),_;if(h.includes("function")){let y=h.substring(h.indexOf("(")+1,h.lastIndexOf(")"));_=new Function(y,d)}else if(h.substring(0,6)===d.substring(0,6)){let y=h.substring(h.indexOf("(")+1,h.lastIndexOf(")"));_=new Function(y,d.substring(d.indexOf("{")+1,d.length-1))}else try{_=(0,eval)(f)}catch{}return _}function X(f="{}"){try{let a=typeof f=="string"?JSON.parse(f):f,h=d=>{for(let _ in d)if(typeof d[_]=="string"){let y=V(d[_]);typeof y=="function"&&(d[_]=y)}else typeof d[_]=="object"&&h(d[_]);return d};return h(a)}catch(a){console.error(a);return}}var le=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1,O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S--}}function y(m,b){if(b!=null&&typeof b=="object"){m&&_(m,b);let S=f.get(b);if(S)return"[Circular Reference]"+S;f.set(b,h.join("."))}return b}return function(m,b){try{return a.push(m),JSON.stringify(m,y,b)}finally{d()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=le);var Pe=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1,O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S--}}function y(m,b){if(b!=null&&typeof b=="object"){m&&_(m,b);let S=f.get(b);if(S)return"[Circular Reference]"+S;f.set(typeof b=="function"?b.toString():b,h.join("."))}return typeof b=="function"?b.toString():b}return function(m,b){try{return a.push(m),JSON.stringify(m,y,b)}finally{d()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=Pe);var Te=function(){let f=new Map,a=[],h=["this"];function d(){f.clear(),a.length=0,h.length=1}function _(m,b){var S=a.length-1;if(a[S]){var O=a[S];if(typeof O=="object")if(O[m]===b||S===0)h.push(m),a.push(b.pushed);else for(;S-->=0;){if(O=a[S],typeof O=="object"&&O[m]===b){S+=2,a.length=S,h.length=S,--S,a[S]=b,h[S]=m;break}S++}}}function y(m,b){let S;if(b!=null)if(typeof b=="object"){let O=b.constructor.name;m&&O==="Object"&&_(m,b);let T=f.get(b);if(T)return"[Circular Reference]"+T;if(f.set(b,h.join(".")),O==="Array")b.length>20?S=b.slice(b.length-20):S=b;else if(O.includes("Set"))S=Array.from(b);else if(O!=="Object"&&O!=="Number"&&O!=="String"&&O!=="Boolean")S="instanceof_"+O;else if(O==="Object"){let x={};for(let k in b)if(b[k]==null)x[k]=b[k];else if(Array.isArray(b[k]))b[k].length>20?x[k]=b[k].slice(b[k].length-20):x[k]=b[k];else if(b[k].constructor.name==="Object"){x[k]={};for(let E in b[k])if(Array.isArray(b[k][E]))b[k][E].length>20?x[k][E]=b[k][E].slice(b[k][E].length-20):x[k][E]=b[k][E];else if(b[k][E]!=null){let R=b[k][E].constructor.name;R.includes("Set")?x[k][E]=Array.from(b[k][E]):R!=="Number"&&R!=="String"&&R!=="Boolean"?x[k][E]="instanceof_"+R:x[k][E]=b[k][E]}else x[k][E]=b[k][E]}else{let E=b[k].constructor.name;E.includes("Set")?x[k]=Array.from(b[k]):E!=="Number"&&E!=="String"&&E!=="Boolean"?x[k]="instanceof_"+E:x[k]=b[k]}S=x}else S=b}else S=b;return S}return function(m,b){a.push(m);let S=JSON.stringify(m,y,b);return d(),S}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=Te);function ze(f){if(typeof f.__methods=="object")for(let a in f.__methods){let h=f.__methods[a],d=typeof h=="function"?h:V(h);a==="__operator"?f.__setOperator(d):f[a]=d.bind(f)}}var ut=class extends i{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(f){super({...f,loaders:f?.loaders?Object.assign({...N},f.loaders):{...N}}),f?.services&&this.addServices(f.services),f?.restrict&&(this.restrict=f.restrict),this.load(this)}addServices=f=>{for(let a in f)if(typeof f[a]=="function"&&(f[a]=new f[a]),f[a]?.__node?.loaders&&Object.assign(this.__node.loaders,f[a].__node.loaders),f[a]?.__node?.nodes){f[a].__node.nodes.forEach((_,y)=>{this.get(y)?this.set(a+"."+y,_):this.set(y,_)}),this.__node.nodes.forEach((_,y)=>{f[a].__node.nodes.get(y)||f[a].__node.nodes.set(y,_)});let h=this.set;this.set=(_,y)=>(f[a].set(_,y),h(_,y));let d=this.delete;this.delete=_=>(f[a].delete(_),d(_))}else typeof f[a]=="object"&&this.load(f[a])};handleMethod=(f,a,h)=>{let d=a,_=this.__node.nodes.get(f);if(_||(_=this.__node.roots[f]),_?.[d])if(typeof _[d]!="function"){if(h){Array.isArray(h)&&h.length===1?_[d]=h[0]:_[d]=h;return}return _[d]}else return Array.isArray(h)?_[d](...h):_[d](h);else return this.handleServiceMessage({route:f,args:h,method:a})};handleServiceMessage(f){let a;return typeof f=="object"&&(f.route?a=f.route:f.node&&(a=f.node)),a?Array.isArray(f.args)?this.run(a,...f.args):this.run(a,f.args):f}handleGraphNodeCall(f,a){if(!f)return a;if(a?.args)this.handleServiceMessage(a);else return Array.isArray(a)?this.run(f,...a):this.run(f,a)}transmit=(...f)=>{if(typeof f[0]=="object"){let a=f[0];if(a.method)return this.handleMethod(a.route,a.method,a.args);if(a.route)return this.handleServiceMessage(a);if(a.node)return this.handleGraphNodeCall(a.node,a.args);this.__node.keepState&&(a.route&&this.setState({[a.route]:a.args}),a.node&&this.setState({[a.node]:a.args}));return}else return};receive=(...f)=>{if(f[0]){let a=f[0];if(typeof a=="string"){let h=a.substring(0,8);(h.includes("{")||h.includes("["))&&(h.includes("\\")&&(a=a.replace(/\\/g,"")),a[0]==='"'&&(a=a.substring(1,a.length-1)),a=JSON.parse(a))}if(typeof a=="object"){if(a.method)return this.restrict?.[a.route]?void 0:this.handleMethod(a.route,a.method,a.args);if(a.route)return this.restrict?.[a.route]?void 0:this.handleServiceMessage(a);if(a.node)return typeof a.node=="string"&&this.restrict?.[a.node]?void 0:this.handleGraphNodeCall(a.node,a.args);this.__node.keepState&&(a.route&&this.setState({[a.route]:a.args}),a.node&&this.setState({[a.node]:a.args}));return}}};pipe=(f,a,h,d,_)=>{if(f instanceof r)return _?this.subscribe(f,y=>{let m=_(y);m!==void 0?this.transmit({route:a,args:m,method:d}):this.transmit({route:a,args:y,method:d},h)}):this.subscribe(f,y=>{this.transmit({route:a,args:y,method:d},h)});if(typeof f=="string")return this.subscribe(f,y=>{this.transmit({route:a,args:y,method:d},h)})};pipeOnce=(f,a,h,d,_)=>{if(f instanceof r)return _?f.__node.state.subscribeEventOnce(f.__node.unique,y=>{let m=_(y);m!==void 0?this.transmit({route:a,args:m,method:d}):this.transmit({route:a,args:y,method:d},h)}):this.__node.state.subscribeEventOnce(f.__node.unique,y=>{this.transmit({route:a,args:y,method:d},h)});if(typeof f=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(f).__node.unique,y=>{this.transmit({route:a,args:y,method:d},h)})};terminate=(...f)=>{};isTypedArray=Ie;recursivelyAssign=J;spliceTypedArray=ne;ping=()=>(console.log("pinged!"),"pong");echo=(...f)=>(this.transmit(...f),f);log=(...f)=>(console.log(...f),!0);error=(...f)=>(console.error(...f),!0)};function Ie(f){return ArrayBuffer.isView(f)&&Object.prototype.toString.call(f)!=="[object DataView]"}var J=(f,a)=>{for(let h in a)a[h]?.constructor.name==="Object"&&!Array.isArray(a[h])?f[h]?.constructor.name==="Object"&&!Array.isArray(f[h])?J(f[h],a[h]):f[h]=J({},a[h]):f[h]=a[h];return f};function ne(f,a,h){let d=f.subarray(0,a),_;h&&(_=f.subarray(h+1));let y;return(d.length>0||_?.length>0)&&(y=new f.constructor(d.length+_.length)),y&&(d.length>0&&y.set(d),_&&_.length>0&&y.set(_,d.length)),y}})();var Li=n=>(n?`${n}`:"")+Math.floor(1e15*Math.random()),mo=(n=Math,e=Date,t=16,s=r=>n.floor(r).toString(t))=>s(e.now()/1e3)+" ".repeat(t).replace(/./g,()=>s(n.random()*t)),Vs=class extends(void 0){name="structs";currentUser;tablet=new ft;collections=this.tablet.collections;id=Li();useAccessTokens=!1;useRefreshTokens=!1;constructor(e,t){super(e),this.load(this),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),t instanceof Object&&Object.keys(t).length>0&&this.setupUser(t)}getToken(e){if(this.useAccessTokens)return e.accessToken;if(this.useRefreshTokens)return e.refreshToken}setupUser=async(e,t=s=>{})=>{if(!e){console.error('must provide a minimum info object! e.g. {_id:"abc123"}'),t(void 0);return}let s=!1;e.id&&!e._id?e._id=e.id:e._id&&(e.id=e._id);let r=await this.getUser(e._id),i=r?.user,o,l=!1;if(!i||!i._id){o=this.userStruct(e,!1),l=!0;let c=await this.setUser(o),u=this.getLocalData(void 0,{ownerId:o._id});u?.length>0&&this.updateServerData(u),this.setAuthorizationsByGroup(o)}else{o=i;let c={_id:e._id,ownerId:e._id},u=this.userStruct(e,!1);for(let p in u)e[p]&&i[p]!==e[p]?(c[p]=e[p],i[p]=e[p]):u[p]&&!i[p]&&(c[p]=u[p],i[p]=u[p]);Object.keys(c).length>2&&await this.setUser(c),r?.authorizations&&Array.isArray(r.authorizations)&&this.setLocalData(r.authorizations),r?.groups&&Array.isArray(r.groups)&&this.setLocalData(r.groups)}if(l)this.setLocalData(o);else{let c=await this.getAllUserData(o._id,void 0,[pe("last day"),Date.now()]);if(!(!c||c.length===0)){this.setLocalData(c);let u=c.filter(w=>{if(w.structType==="notification"&&(this.getLocalData("authorization",w.parent._id)||w.parent.structType==="user"||w.parent.structType==="authorization"||!this.getLocalData(w.parent.structType,w.parent._id)))return!0}),p=c.filter(w=>{if(w.structType==="comment")return!0}),g=[];p.forEach(w=>{this.getLocalData("comment",{_id:w._id})||g.push(w._id)}),g.length>0&&this.deleteData(g),u.length>0&&(this.resolveNotifications(u,!1,void 0),s=!0);let v=c.filter(w=>{if(w.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(v)}this.setLocalData(o)}return o?(this.currentUser?Object.assign(this.currentUser,o):this.currentUser=o,t(this.currentUser),this.currentUser):(t(o),o)};baseServerCallback=async e=>{let t=e;if(typeof e=="object"&&e?.structType&&(t=[e]),Array.isArray(t)){let s=t.filter(r=>{if(r.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(s);for(let r=0;r<t.length;r++){let i=t[r];if(typeof i=="object")if((!i.structType||i.structType==="USER")&&(i.email?i.structType="user":i.structType="uncategorized"),i.structType==="user"||i.structType==="authorization"||i.structType==="group"){if(i.structType==="user")i._id=i.id;else if(i.structType==="group"&&this.currentUser){let o=!1;i.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[i.name+"_admin"]?(this.currentUser.userRoles[i.name+"_admin"]=!0,o=!0):!i.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[i.name+"_admin"]&&(delete this.currentUser.userRoles[i.name+"_admin"],o=!0),i.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[i.name+"_peer"]?(this.currentUser.userRoles[i.name+"_peer"]=!0,o=!0):!i.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[i.name+"_peer"]&&(delete this.currentUser.userRoles[i.name+"_peer"],o=!0),i.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[i.name+"_client"]?(this.currentUser.userRoles[i.name+"_client"]=!0,o=!0):!i.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[i.name+"_client"]&&(delete this.currentUser.userRoles[i.name+"_client"],o=!0),o&&await this.setUser(this.currentUser)}this.setLocalData(i)}else i.structType==="notification"?(this.getLocalData("notification",{ownerId:i.ownerId,_id:i.parent._id})?this.setLocalData(i):this.getLocalData(i.structType,{_id:i.parent._id})||this.overwriteLocalData(i),i.ownerId===this.currentUser?._id&&(i.parent.structType==="user"||i.parent.structType==="dataInstance"||i.parent.structType==="schedule"||i.parent.structType==="authorization")&&await this.resolveNotifications([i],!0),this.onNotify(i)):this.overwriteLocalData(i)}}this.onData(e)};structNotification=()=>{this.checkForNotifications()};structDeleted=e=>{this.deleteLocalData([e])};onData=e=>{};onNotify=e=>{};randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct=async(e="struct",t={},s,r,i=!0)=>{let o=re.Struct(e,t,s,r);return i&&(o=await this.updateServerData([o])[0]),o};getUser=async(e="",t,s=this.baseServerCallback)=>{if(console.log(this.currentUser),this.currentUser?.request){let r=await this.currentUser.request({route:"getUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return s(r),r}};queryUsers=async(e,t,s,r=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"queryUsers",args:[this.currentUser._id,e,t,s,void 0,this.getToken(this.currentUser)]});return r(i),i}};getUsers=async(e=[],t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"getUsersByIds",args:[this.currentUser._id,e,t]});return s(r),r}};getUsersByRole=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=await this.currentUser.request({route:"getUsersByRole",args:[this.currentUser._id,e]});return t(s),s}};getAllUserData=async(e,t=[],s,r=this.baseServerCallback)=>{if(s&&(typeof s[0]=="string"&&(s[0]=pe(s[0])),typeof s[1]=="string"&&(s[1]=pe(s[1]))),this.currentUser?.request){let i=await this.currentUser.request({route:"getAllData",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return r(i),i}};query=async(e,t={},s=!1,r=0,i=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e||!t)return;let o=await this.currentUser.request({route:"query",args:[this.currentUser._id,e,t,s,r,this.getToken(this.currentUser)]});return typeof i=="function"&&i(o),o}};getDataByTimeRange(e,t,s,r=0,i=0,o){let l={};t&&(typeof t[0]=="string"&&(t[0]=pe(t[0])),typeof t[1]=="string"&&(t[1]=pe(t[1])));let c={$gt:t[0],$lt:t[1]};return o?l[o]=c:l.timestamp=c,this.getData(e,s,l,r,i)}getData=async(e,t,s,r=0,i=0,o=this.baseServerCallback)=>{if(this.currentUser?.request){let l=await this.currentUser.request({route:"getData",args:[this.currentUser._id,e,t,s,r,i,this.getToken(this.currentUser)]});return typeof o=="function"&&o(l),l}};getDataByIds=async(e=[],t,s,r=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getDataByIds",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return typeof r=="function"&&r(i),i}};getStructParentData=async(e,t=this.baseServerCallback)=>{if(e?.parent&&this.currentUser?.request){let s=[this.currentUser._id,e.parent?.structType,"_id",e.parent?._id,this.getToken(this.currentUser)],r=(await this.currentUser.request({route:"getData",args:s}))?.[0];return typeof t=="function"&&t(r),r}};setUser=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setUser",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkUserToken=async(e,t=this.currentUser,s=this.baseServerCallback)=>{if(!e)return!1;let r=!1;for(let i in e){let o=this.userStruct();if(t[i]&&i!=="_id")if(Array.isArray(e[i])){for(let l=0;l<t[i].length;l++)if(e[i].indexOf(t[i][l])<0){t[i]=e[i],r=!0;break}if(!r){for(let l=0;l<e[i].length;l++)if(t[i].indexOf(e[i][l])<0){t[i]=e[i],r=!0;break}}}else t[i]!==e[i]&&(t[i]=e[i],r=!0);else!t[i]&&o[i]&&(t[i]=e[i],r=!0)}return r&&await this.setUser(t,s)};setData=async(e=[],t=!0,s=this.baseServerCallback)=>{if(this.currentUser?.request){let r=new Array;!Array.isArray(e)&&typeof e=="object"&&(e=[e]),e.forEach(o=>{r.push(this.stripStruct(o))});let i=await this.currentUser.request({route:"setData",args:[this.currentUser._id,r,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};updateServerData=this.setData;deleteData=async(e=[],t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=[];e.forEach(i=>{if(typeof i=="object")i?.structType&&i?._id&&(s.push({structType:i.structType,_id:i._id}),this.deleteLocalData(i));else if(typeof i=="string"){let o=this.getLocalData(void 0,{_id:i});o&&!Array.isArray(o)?s.push({structType:o.structType,_id:o._id}):s.push({_id:i})}});let r=await this.currentUser.request({route:"deleteData",args:[this.currentUser._id,s,this.getToken(this.currentUser)]});return typeof t=="function"&&t(r),r}};deleteUser=async(e=this.currentUser._id,t,s=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;let r=await this.currentUser.request({route:"deleteUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};setGroup=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setGroup",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getUserGroups=async(e=this.currentUser._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"getUserGroups",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};deleteGroup=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteGroup",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};setAuthorization=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setAuthorization",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getAuthorizations=async(e=this.currentUser?._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){if(e===void 0)return;let r=await this.currentUser.request({route:"getAuthorizations",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};deleteAuthorization=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteAuthorization",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkForNotifications=async(e=this.currentUser?._id)=>await this.getData("notification",e);resolveNotifications=async(e=[],t=!0,s=this.currentUser)=>{if(!s||e.length===0)return;let r=[],i=[],o=[],l=!1;if(e.length===0&&(e=this.getLocalData("notification",{ownerId:s._id})),e.forEach(c=>{c.parent.structType==="user"&&(l=!0),o.push(c.parent.structType),r.push(c.parent._id),i.push(c._id),this.deleteLocalData(c)}),this.deleteData(e),t){if(o.reverse().forEach((c,u)=>{c==="user"&&(this.getUser(r[u]),r.splice(r.length-u-1,1))}),r.length===1)return await this.getDataByIds(r,void 0,e[0].parent.structType);if(r.length>0)return await this.getDataByIds(r)}return!0};setAuthorizationsByGroup=async(e=this.currentUser)=>{let t=this.getLocalData("authorization",{ownerId:e._id}),s=[];if(e.userRoles&&await Promise.all(Object.keys(e.userRoles).map(async r=>{let o=r.split("_")[0],l;if(r.includes("client")?l=o+"_peer":r.includes("peer")?l=o+"_client":r.includes("admin")&&(l=o+"_owner"),l){let c=await this.getUsersByRole(l);c&&await Promise.all(c.map(async u=>{let p=u.username;p||(p=u.email),p||(p=u._id);let g=e.username;if(g||(g=e.email),g||(g=e._id),p!==g){if(r.includes("client")){if(!t.find(w=>{if(w.authorizerId===u._id&&w.authorizedId===e._id)return!0})){let w=await this.authorizeUser(re.ProfileStruct("user",e,e),u._id,p,e._id,g,{peer:!0},void 0,{group:o});s.push(w)}}else if(r.includes("peer")&&!t.find(w=>{if(w.authorizedId===u._id&&w.authorizerId===e._id)return!0})){let w=await this.authorizeUser(re.ProfileStruct("user",e,e),e._id,g,u._id,p,{peer:!0},void 0,{group:o});s.push(w)}}}))}})),s.length>0)return s};deleteRoom=async e=>{if(!e)return!1;let t=[e];return e.comments?.forEach(s=>{let r=this.getLocalData("comment",{_id:s});t.push(r)}),e?await this.deleteData(t):!1};deleteComment=async e=>{let t=[e],s=(l=e)=>{l?.replies&&l.replies.forEach(c=>{let u=this.getLocalData("comment",{_id:c});u&&(u.replies.length>0&&u.replies.forEach(p=>{s(p)}),t.push(u))})};s(e);let r=this.getLocalData(e.parent?.structType,{_id:e.parent?._id}),i=[];r&&(i=[r],t.forEach(l=>{let c=r.replies?.indexOf(l._id);c>-1&&r.replies.splice(c,1);let u=r.comments?.indexOf(l._id);u>-1&&r.comments.splice(u,1)}));let o=this.getLocalData("comment",{_id:e.replyTo});if(o?._id!==r?._id){let l=o.replies?.indexOf(r._id);l>-1&&o.replies.splice(l,1),i.push(o)}return i.length>0&&await this.updateServerData(i),await this.deleteData(t)};getUserDataByAuthorization=async(e,t,s,r=0,i=0,o=this.baseServerCallback)=>{let l=e.authorizerId;if(l)return new Promise(async c=>{this.getUser(l,!0,async u=>{let p;t?p=await this.getData(t,l,s,r,i,o):p=await this.getAllUserData(l,["notification"],void 0,o),c(p),o(p)})})};getUserDataByAuthorizationGroup=async(e="",t,s,r=0,i=0,o=this.baseServerCallback)=>{let l=this.getLocalData("authorization"),c=[];return await Promise.all(l.map(async u=>{if(u.groups?.includes(e)){let p=u.authorizerId;if(p){let g,v=await this.getUser(p,!0,o);v&&c.push(v),t?g=await this.getData(t,p,s,r,i,o):g=await this.getAllUserData(p,["notification"],void 0,o),g&&c.push(g)}return!0}})),c};overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){this.tablet.setLocalData(e)}getLocalData(e,t){return this.tablet.getLocalData(e,t)}getLocalUserPeerIds=(e=this.currentUser)=>{if(!e)return{};let t={};return this.getLocalData("authorization",e._id).forEach(r=>{r.authorizations.peer&&r.authorizerId===e._id&&(t[r.authorizedId]=!0)}),t};getLocalReplies(e){let t=[];if(e.replies){if(e.replies.reduce((s,r)=>s*(typeof r=="object"?1:0),1))return e.replies}else return t;return t=this.getLocalData("comment",{replyTo:e._id}),t}hasLocalAuthorization(e,t=this.currentUser._id){let r=this.getLocalData("authorization",{ownerId:t}).find(i=>{if(i.authorizedId===t&&i.authorizerId===e||i.authorizerId===t&&i.authorizedId===e)return!0});return r||!1}deleteLocalData(e){return Array.isArray(e)?e.forEach(t=>this.deleteStruct(t)):this.deleteStruct(e),!0}deleteStruct(e){if(typeof e=="string"&&(e=this.getLocalData(void 0,{_id:e})),!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.tablet.collections.get(e.structType).delete(e._id),!0)}stripStruct(e){let t=Object.assign({},e);for(let s in t)(t[s]===void 0||t[s]===""||t[s].constructor.name==="Map"||t[s].constructor.name==="Set"||typeof t[s]=="function"||Array.isArray(t[s])&&t[s].length===0||typeof t[s]=="object"&&Object.keys(t[s]).length===0)&&delete t[s];return t}createStruct(e,t,s=this.currentUser,r){return re.Struct(e,t,s,r)}userStruct(e={},t=!1){let s=re.ProfileStruct(void 0,e,e);if(!s.name&&s.firstName)s.name=s.firstName+" "+s.lastName;else if(s.name&&!s.firstName){let i=s.name.split(" ");s.firstName=i[0],s.lastName=i[i.length-1]}e._id?s.id=e._id:e.id?s.id=e.id:s.id="user"+Math.floor(Math.random()*1e15),s._id=s.id,s.ownerId=s.id;let r=re.ProfileStruct();for(let i in e)Object.keys(r).indexOf(i)<0&&delete s[i];return t&&(this.currentUser=s),s}authorizeUser=async(e,t="",s="",r="",i="",o={},l={},c={},u={},p=!1)=>{if(!e)return;let g=this.createStruct("authorization",void 0,e,void 0);return g.authorizedId=r,g.authorizedName=i,g.authorizerId=t,g.authorizerName=s,g.authorizations=o,g.structs=l,g.excluded=c,g.groups=u,g.expires=p,g.status="PENDING",g.associatedAuthId="",g=await this.setAuthorization(g),g};addGroup=async(e,t="",s="",r={},i={},o={},l=!0)=>{if(!e)return;let c=this.createStruct("group",void 0,e);return c.name=t,c.details=s,c.admins=r,c.peers=i,c.clients=o,c.users={},Object.assign(c.users,c.admins),Object.assign(c.users,c.peers),Object.assign(c.users,c.clients),l&&(c=await this.setGroup(c)),c};dataObject(e=void 0,t="any",s=Date.now()){return{type:t,data:e,timestamp:s}}addData=async(e,t="",s="",r="",i=[],o=!1,l=!0)=>{if(!e)return;let c=this.createStruct("dataInstance",void 0,e);return c.author=t,c.title=s,c.type=r,c.data=i,c.expires=o,l&&(c=await this.updateServerData([c])[0]),c};addEvent=async(e,t="",s="",r="",i,o,l,c,u,p,g,v,w=!0)=>{if(!e)return;v&&Object.keys(v).length===0&&(v=this.getLocalUserPeerIds(e));let A=this.createStruct("event",void 0,e);return A.author=t,A.event=s,A.notes=r,A.startTime=i,A.endTime=o,A.grade=l,A.attachments=g,A.value=c,A.units=u,A.users=v,A.location=p,w&&(A=await this.updateServerData([A])[0]),A};addChatroom=async(e,t="",s="",r,i,o=!0)=>{if(!e)return;i&&Object.keys(i).length===0&&(i=this.getLocalUserPeerIds(e));let l=this.createStruct("chatroom",void 0,e);l.message=s,l.attachments=r,l.authorId=t,l.users=i,l.replies=[],l.comments=[];let c=[l];return o&&(l=await this.updateServerData(c)[0]),l};addComment=async(e,t,s,r="",i="",o,l=!0)=>{if(!t||(s||(s=t),!e))return;let c=this.createStruct("comment",void 0,e,t);c.authorId=r,c.replyTo=s?._id,c.message=i,c.attachments=o,c.users=t?.users,c.replies=[],l||s?.replies.push(c._id),l||t?.comments.push(c._id);let u=[c,t];s?._id!==t._id&&u.push(s);let p;l&&(p=await this.updateServerData(u));let g;return typeof p=="object"&&(g=p.find(v=>{if(c.ownerId===v.ownerId&&c.timestamp===v.timestamp&&c.message===v.message)return!0})),g||p}};var Ys=Math.floor(Math.random()*16777215),Mi=H.index=parseInt(Math.random()*16777215,10),Ui=(typeof process>"u"||typeof process.pid!="number"?Math.floor(Math.random()*1e5):process.pid)%65535,Ri=(()=>{try{return _Buffer}catch{try{return Buffer}catch{return null}}})(),Vt=function(n){return!!(n!=null&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n))},zi=[];for(ie=0;ie<256;ie++)zi[ie]=(ie<=15?"0":"")+ie.toString(16);var ie,Fi=new RegExp("^[0-9a-fA-F]{24}$"),ht=[];ie=0;for(;ie<10;)ht[48+ie]=ie++;for(;ie<16;)ht[55+ie]=ht[87+ie]=ie++;function H(n){if(!(this instanceof H))return new H(n);if(n&&(n instanceof H||n._bsontype==="ObjectId"))return n;if(this._bsontype="ObjectId",n==null||typeof n=="number"){this.id=this.generate(n);return}var e=H.isValid(n);if(!e&&n!=null)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&typeof n=="string"&&n.length===24)return H.createFromHexString(n);if(n!=null&&n.length===12)this.id=n;else{if(n!=null&&typeof n.toHexString=="function")return n;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}}H.createFromTime=function(n){return n=parseInt(n,10)%4294967295,new H(vo(8,n)+"0000000000000000")};H.createFromHexString=function(n){if(typeof n>"u"||n!=null&&n.length!==24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",t=0;t<24;)e+=String.fromCharCode(ht[n.charCodeAt(t++)]<<4|ht[n.charCodeAt(t++)]);return new H(e)};H.isValid=function(n){return n==null?!1:typeof n=="number"?!0:typeof n=="string"?n.length===12||n.length===24&&Fi.test(n):n instanceof H?!0:Vt(n)?H.isValid(n.toString("hex")):typeof n.toHexString=="function"&&Ri&&(n.id instanceof Ri||typeof n.id=="string")?n.id.length===12||n.id.length===24&&Fi.test(n.id):!1};H.prototype={constructor:H,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(this.id.length===24)return this.id;if(Vt(this.id))return this.id.toString("hex");for(var n="",e=0;e<this.id.length;e++)n+=zi[this.id.charCodeAt(e)];return n},equals:function(n){return n instanceof H?this.toString()===n.toString():typeof n=="string"&&H.isValid(n)&&n.length===12&&Vt(this.id)?n===this.id.toString("binary"):typeof n=="string"&&H.isValid(n)&&n.length===24?n.toLowerCase()===this.toHexString():typeof n=="string"&&H.isValid(n)&&n.length===12?n===this.id:n!=null&&(n instanceof H||n.toHexString)?n.toHexString()===this.toHexString():!1},getTimestamp:function(){var n=new Date,e;return Vt(this.id)?e=this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:e=this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,n.setTime(Math.floor(e)*1e3),n},generate:function(n){typeof n!="number"&&(n=~~(Date.now()/1e3)),n=parseInt(n,10)%4294967295;var e=bo();return String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255,Ys>>16&255,Ys>>8&255,Ys&255,Ui>>8&255,Ui&255,e>>16&255,e>>8&255,e&255)}};function bo(){return Mi=(Mi+1)%16777215}function vo(n,e){return e=e.toString(16),e.length===n?e:"00000000".substring(e.length,n)+e}var So=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";H.prototype[So]=function(){return"ObjectId("+this+")"};H.prototype.toJSON=H.prototype.toHexString;H.prototype.toString=H.prototype.toHexString;var wo=n=>(n?`${n}_`:"")+Math.floor(1e15*Math.random()),Z=n=>typeof n=="string"&&n.length===24?new H(n):n,M=n=>typeof n=="object"?n.toString():n,Gi=["profile","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],Ks=class extends(void 0){name="structs";debug=!1;db;users={};collections={};mode="local";useAuths=!0;useAccessTokens=!1;useRefreshTokens=!1;accessTokens=new Map;refreshTokens=new Map;constructor(e,t){super(e),this.load(this),t&&this.initDB(t)}initDB=e=>{this.db=e.db,e?.users&&(this.users=e.users),e.mode&&(this.mode=e.mode),e?.collections&&(this.collections=e.collections),e.debug&&(this.debug=e.debug),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),"useAuths"in e&&(this.useAuths=e.useAuths),Gi.forEach(t=>{this.collections[t]||(this.collections[t]=this.db?{instance:this.db.collection(t)}:{},this.collections[t].reference={})})};query=async(e,t,s,r,i,o)=>{let l=this.users[e];if(!l)return!1;if(this.mode.indexOf("mongo")>-1)return await this.queryMongo(l,t,s,r,i,o);{let c=this.getLocalData(l,t);if(c&&!Array.isArray(c)){let p=!this.useAuths;if(c?.ownerId?this.useAuths&&(p=await this.checkAuthorization(l,c,"READ",o)):p=!0,p)return c}typeof i=="number"&&Array.isArray(c)&&c.length>i&&c.splice(0,i);let u=[];return c&&await Promise.all(c.map(async p=>{let g=this.getLocalData(M(p._id)),v=!this.useAuths;!g?.ownerId||g.ownerId===l._id?v=!0:this.useAuths&&(v=await this.checkAuthorization(l,g,"READ",o)),v&&u.push(g)})),u}};getUser=async(e,t,s,r)=>{let i=this.users[e];if(!i)return!1;let o;if(this.mode.indexOf("mongo")>-1)o=await this.getMongoUser(i,t,void 0,s,r);else{let l=this.getLocalData("profile",{_id:t});if(!l)o={user:void 0};else{let c=!this.useAuths;if(!l?.ownerId||l.ownerId===i._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(i,l,"READ",r)),c){let u=this.getLocalData("group",{ownerId:t}),p=this.getLocalData("authorization",{ownerId:t});o={user:l,groups:u,authorizations:p}}else o={user:{}}}}return this.debug&&console.log("getUser: user:",i,"input:",t,"output",o),o};setUser=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;if(t.accessToken)this.accessTokens.set(e,s);else if(this.useAccessTokens)return!1;if(t.refreshToken)this.refreshTokens.set(e,t.refreshToken);else if(this.useRefreshTokens)return!1;if(delete t.accessToken,delete t.refreshToken,delete r.accessToken,delete r.refreshToken,this.mode.indexOf("mongo")>-1)i=await this.setMongoUser(r,t,s);else{let o=!this.useAuths;return!t?.ownerId||t.ownerId===r._id?o=!0:this.useAuths&&(o=await this.checkAuthorization(r,t,"WRITE",s)),o&&this.setLocalData(t),!0}return this.debug&&console.log("setUser user:",r,"input:",t,"output",i),i};getUsersByIds=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;if(this.mode.includes("mongo"))i=await this.getMongoUsersByIds(r,t,s);else if(i=[],Array.isArray(t)){let o=this.getLocalData("profile",{_id:t});o&&(s?i.push({_id:o._id,username:o.username,firstName:o.firstName,lastName:o.lastName,fullName:o.fullName,pictureUrl:o.pictureUrl}):i.push(o))}return this.debug&&console.log("getUserByIds: user:",r,"input:",t,"output",i),i};getUsersByRole=async(e,t)=>{let s=this.users[e];if(!s)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoUsersByRole(s,t);else{let i=this.getLocalData("profile");r=[],i.forEach(o=>{o.userRoles[t]&&r.push(o)})}return this.debug&&console.log("getUserByRoles: user:",s,"input:",t,"output",r),r};deleteUser=async(e,t,s,r)=>{let i=this.users[e];if(!i)return!1;let o;if(this.mode.includes("mongo"))o=await this.deleteMongoUser(i,t,s,r);else{o=!1;let l=this.getLocalData(t);if(l){let c=!this.useAuths;!l?.ownerId||l.ownerId===i._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(i,l,"WRITE",r)),c&&(o=this.deleteLocalData(l))}}return this.debug&&console.log("deleteUser: user:",i,"input:",t,"output",o),o};setData=async(e,t,s,r)=>{let i=this.users[e];if(!i)return!1;let o;if(this.mode.includes("mongo"))o=await this.setMongoData(i,t,s,r);else{let l=[];return o=[],await Promise.all(t.map(async c=>{let u=this.getLocalData(c),p=!this.useAuths;!u?.ownerId||u.ownerId===i._id?p=!0:this.useAuths&&(p=await this.checkAuthorization(i,u,"WRITE",r)),p&&(this.collections[u.structType]||(this.collections[u.structType]={},this.collections[u.structType].reference={}),this.setLocalData(u),o.push(u),u.structType!=="notification"&&l.push(u))})),l.length>0&&(s===!0||typeof s>"u")&&this.checkToNotify(i,l,this.mode),this.debug&&console.log("setData:",i,t,o),!0}return this.debug&&console.log("setData: user:",i,"input:",t,s,"output",o),o};getData=async(e,t,s,r,i,o,l)=>{let c=this.users[e];if(!c)return!1;let u;if(this.mode.includes("mongo"))u=await this.getMongoData(c,t,s,r,i,o,l);else{u=[];let p;t&&(p=this.getLocalData(t)),p&&s&&(p=p.filter(g=>{if(g.ownerId===s)return!0})),p&&await Promise.all(p.map(async g=>{let v=this.getLocalData(M(g._id)),w=!this.useAuths;!v?.ownerId||v.ownerId===c._id?w=!0:this.useAuths&&(w=await this.checkAuthorization(c,v,"READ",l)),w&&u.push(v)}))}return this.debug&&console.log("getData: user:",c,"input:",t,s,r,i,o,"output",u),u};getDataByIds=async(e,t,s,r,i)=>{let o=this.users[e];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=await this.getMongoDataByIds(o,t,s,r,i);else{l=[];let c;r&&(c=this.getLocalData(r)),c&&s&&(c=c.filter(u=>{if(u.ownerId===s)return!0})),c&&await Promise.all(c.map(async u=>{let p=this.getLocalData(M(u._id)),g=!this.useAuths;!p?.ownerId||p.ownerId===o._id?g=!0:this.useAuths&&(g=await this.checkAuthorization(o,p,"READ",i)),g&&l.push(p)}))}return this.debug&&console.log("getDataByIds: user:",o,"input:",t,s,r,"output",l),l};getAllData=async(e,t,s,r,i)=>{let o=this.users[e];if(!o)return!1;let l;if(this.mode.includes("mongo"))l=await this.getAllUserMongoData(o,t,s,r,i);else{let c=this.getLocalData(void 0,{ownerId:t});l=[],await Promise.all(c.map(async u=>{if(s){if(s.indexOf(u.structType)<0){let p=!this.useAuths;!u?.ownerId||u.ownerId===o._id?p=!0:this.useAuths&&(p=await this.checkAuthorization(o,u,"READ",i)),p&&l.push(u)}}else{let p=!this.useAuths;!u?.ownerId||u.ownerId===o._id?p=!0:this.useAuths&&(p=await this.checkAuthorization(o,u,"READ",i)),p&&l.push(u)}}))}return this.debug&&console.log("getAllData: user:",o,"input:",t,s,"output",l),l};deleteData=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;return this.mode.includes("mongo")?i=await this.deleteMongoData(r,t,s):(i=!1,await Promise.all(t.map(async o=>{let l=this.getLocalData(o),c=!this.useAuths;!l?.ownerId||l.ownerId===r._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(r,l,"WRITE",s)),c&&this.deleteLocalData(l),i=!0}))),this.debug&&console.log("deleteData: user:",r,"input:",t,"output",i),i};getUserGroups=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;if(this.mode.includes("mongo"))i=await this.getMongoGroups(r,t,s);else if(typeof s=="string")i=this.getLocalData("group",{_id:s});else{i=[];let o=this.getLocalData("group");t?o.forEach(l=>{Object.keys(l.users).includes(t)&&i.push(l)}):o.forEach(l=>{Object.keys(l.users).includes(M(r._id))&&i.push(l)})}return this.debug&&console.log("getGroups: user:",r,"input:",t,s,"output",i),i};deleteGroup=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;if(this.mode.includes("mongo"))i=await this.deleteMongoGroup(r,t,s);else{let o=this.getLocalData("group",t),l=!this.useAuths;o&&(!o?.ownerId||o.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,o,"WRITE",s))),l&&(i=!0)}return this.debug&&console.log("deleteGroup: user:",r,"input:",t,"output",i),i};getAuthorizations=async(e,t,s,r)=>{let i=this.users[e];if(!i)return!1;let o;if(this.mode.includes("mongo"))o=await this.getMongoAuthorizations(i,t,s,r);else if(s){let l=this.getLocalData("authorization",{_id:s});l&&(o=[l])}else o=this.getLocalData("authorization",{ownerId:t});return this.debug&&console.log("getAuthorizations: user:",i,"input:",t,s,"output",o),o};deleteAuthorization=async(e,t,s)=>{let r=this.users[e];if(!r)return!1;let i;if(this.mode.includes("mongo"))i=await this.deleteMongoAuthorization(r,t,s);else{i=!0;let o=this.getLocalData("authorization",{_id:t});if(o){let l=!this.useAuths;!o?.ownerId||o.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,o,"WRITE",s)),l&&(i=this.deleteLocalData(o))}}return this.debug&&console.log("deleteAuthorization: user:",r,"input:",t,"output",i),i};getToken=e=>this.useAccessTokens?this.accessTokens.get(e._id):this.useRefreshTokens?this.refreshTokens.get(e._id):void 0;notificationStruct=(e={})=>{let t="notification";return{structType:t,timestamp:Date.now(),_id:wo(t),note:"",alert:!1,ownerId:"",parentUserId:"",parent:{structType:e?.structType,_id:M(e?._id)}}};checkToNotify=async(e,t=[],s=this.mode)=>{if(t.length===0)return!1;if(typeof e=="string")for(let o in this.users){let l=this.users[o];M(l._id)===e&&(e=l)}if(typeof e=="string"||e==null)return!1;let r={},i=[];if(t.forEach(async o=>{if(o?._id){if(o.ownerId&&e?._id!==o.ownerId){let l=this.notificationStruct(o);l._id="notification_"+M(o._id)+"_"+o.ownerId,l.ownerId=o.ownerId,l.note=o.structType,l.parentUserId=o.ownerId,o.alert&&(l.alert=o.alert),i.push(l),r[o.ownerId]=o.ownerId}if(o.users)Object.keys(o.users).forEach(l=>{if(l!==e._id){let c=this.notificationStruct(o);c._id="notification_"+M(o._id)+"_"+l,c.ownerId=l,c.note=o.structType,o.alert&&(c.alert=o.alert),c.parentUserId=o.ownerId,i.push(c),r[l]=l}});else{let l=[];if(s.includes("mongo")){let u=await this.collections.authorization.instance.find({$or:[{authorizedId:e._id},{authorizerId:e._id}]}).toArray();u.length>0&&u.forEach(p=>l.push(p))}else l=this.getLocalData("authorization",{authorizedId:e._id}),l.push(...this.getLocalData("authorization",{authorizerId:e._id}));l.length>0&&l.forEach(c=>{if(o.authorizerId===o.ownerId&&!r[o.authorizedId]&&c.status==="OKAY"&&c.authorizations.peer){let u=this.notificationStruct(o);u.ownerId=c.authorizedId,u._id="notification_"+M(o._id)+"_"+c.authorizedId,u.note=o.structType,u.parentUserId=o.ownerId,o.alert&&(u.alert=o.alert),i.push(u),r[u.ownerId]=u.ownerId}})}}}),i.length>0){s.includes("mongo")?await this.setMongoData(e,i,!0,this.getToken(e)):this.setLocalData(i);for(let o in r)this.users[o]?.sendAll({route:"structNotification",args:!0});return!0}else return!1};queryMongo=async(e,t,s={},r=!1,i=0,o)=>{if(!(!t&&!s))if(r){let l=await this.db.collection(t).findOne(s);if(!l)return;let c=!this.useAuths;return l?.ownerId?(M(e._id)!==l.ownerId||M(e._id)===l.ownerId&&e.userRoles?.admincontrol)&&this.useAuths&&(c=await this.checkAuthorization(e,l,"READ",o)):c=!0,c?l:void 0}else{let l=this.db.collection(t).find(s).sort({$natural:-1}).skip(i),c=[],u=await l.toArray();if(u.length>0){let p=!this.useAuths,g="";for(let v of u)v?.ownerId?(M(e._id)!==v.ownerId||M(e._id)===v.ownerId&&e.userRoles?.admincontrol)&&g!==v.ownerId&&(this.useAuths&&(p=await this.checkAuthorization(e,v,"READ",o)),g=v.ownerId):p=!0,p&&c.push(v)}return c}};setMongoData=async(e,t=[],s=!0,r)=>{let i=!1;if(t.length>0){let o=!this.useAuths,l="";if(await Promise.all(t.map(async c=>{let u={};if(Array.isArray(c)&&(u=c[1],c=c[0]),!c?.ownerId||c.ownerId===e._id?o=!0:(M(e._id)!==c.ownerId||M(e._id)===c.ownerId&&e.userRoles?.admincontrol)&&l!==c.ownerId&&(this.useAuths&&(o=await this.checkAuthorization(e,c,"WRITE",r)),l=c.ownerId),o&&c.structType){this.collections[c.structType]||(this.collections[c.structType]={},this.collections[c.structType].reference={});let p=JSON.parse(JSON.stringify(c));p._id&&delete p._id,c._id?M(c._id).includes("defaultId")?(await this.db.collection(c.structType?c.structType:"data").insertOne(p),i=!0):c.structType==="notification"?await this.db.collection(c.structType?c.structType:"data").updateOne({_id:c._id},{$set:p,...u},{upsert:!0,unique:!1}):await this.db.collection(c.structType?c.structType:"data").updateOne({_id:Z(c._id)},{$set:p,...u},{upsert:!0}):c.structType&&this.db.collection(c.structType?c.structType:"data").insertOne(p)}})),i===!0){let c=[];return await Promise.all(t.map(async(u,p)=>{let g=JSON.parse(JSON.stringify(u));if(g._id&&g.structType!=="profile"&&delete g._id,u.structType!=="comment"){let v;u.structType!=="notification"&&(v=await this.db.collection(g.structType).findOne(g)),v&&(v._id=M(v._id),c.push(v))}else if(u.structType==="comment"){let w=JSON.parse(JSON.stringify(u));w._id&&delete w._id;let A=await this.db.collection("comment").findOne(w),j=A?.replyTo,F=t.find(D=>{if(M(D._id)===j)return!0});if(F){let D=JSON.parse(JSON.stringify(F));D._id&&delete D._id;let B;if(await Promise.all(["discussion","chatroom","comment"].map(async I=>{let L=await this.db.collection(I).findOne({_id:Z(j)});L&&(B=L)})),B){let I=M(A.parent._id),L,C;I!==j?(L=t.find(U=>{if(M(U._id)===I)return!0}),L&&(delete L._id,await Promise.all(["discussion","chatroom"].map(async U=>{let G=await this.db.collection(U).findOne(L);G&&(C=G)})))):C=B;let N=[A];B&&(B.replies.indexOf(M(A._id))<0&&(B.replies.push(M(A._id)),A.replyTo=M(B._id)),N.push(B)),C&&C.comments.indexOf(A._id)<0&&(C.comments.push(M(A._id)),A.parent._id=M(C._id)),await Promise.all(N.map(async U=>{let G=JSON.parse(JSON.stringify(U));delete G._id,await this.db.collection(U.structType).updateOne({_id:Z(U._id)},{$set:G},{upsert:!1})})),[...c].reverse().forEach((U,G)=>{N.find(q=>{if(M(U._id)===M(q._id))return!0})&&c.splice(c.length-G-1,1)}),c.push(...N)}}else A&&c.push(A)}})),s&&this.checkToNotify(e,c),c}else{let c=[];return t.forEach(u=>{u.structType!=="notification"&&c.push(u)}),s&&this.checkToNotify(e,c),!0}}else return!1};setMongoUser=async(e,t,s)=>{if(t._id){let r=Z(t._id),i={_id:r};if(await this.collections.profile.instance.findOne(i)&&(M(e._id)!==t.ownerId||M(e._id)===t.ownerId&&e.userRoles?.admincontrol)){let c=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(e,t,"WRITE",s)),!c)return!1}let l=JSON.parse(JSON.stringify(t));return l._id=r,this.debug&&console.log("RETURNS PROFILE",t),await this.collections.profile.instance.updateOne(i,{$set:l},{upsert:!0}),e=await this.collections.profile.instance.findOne(i),this.checkToNotify(e,[t]),e}else return!1};setGroup=async(e,t,s=this.mode,r)=>{if(t?._id){let i=M(e._id),o;if(s.includes("mongo")?o=await this.collections.group.instance.findOne({name:t.name}):o=this.getLocalData("group",{_id:M(t._id)}),o&&(o.ownerId!==t.ownerId||t.admins.indexOf(i)<0))return!1;if(i!==t.ownerId){let A=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?A=!0:this.useAuths&&(A=await this.checkAuthorization(e,t,"WRITE",r)),!A)return!1}let l=[];Object.keys(t.users).forEach(A=>{l.push({email:A},{id:A},{username:A})});let c={},u={};if(s.includes("mongo")){let j=this.collections.profile.instance.find({$or:l}).toArray();j.length>0&&j.forEach(F=>{c[i]=F,u[i]=!0})}else l.forEach(A=>{let j=this.getLocalData("profile",A);j.length>0&&(c[M(j[0]._id)]=j[0],u[M(j[0]._id)]=!0)});t.users=u;let p={},g={},v={};Object.keys(c).forEach(A=>{let j=c[A];(t.admins[M(j._id)]||t.admins[j.email]||t.admins[j.username]||t.admins[t.ownerId])&&(p[M(j._id)]||(p[M(j._id)]=!0)),(t.peers[M(j._id)]||t.peers[j.email]||t.peers[j.username]||t.peers[t.ownerId])&&(g[M(j._id)]||(g[M(j._id)]=!0)),(t.clients[M(j._id)]||t.clients[j.email]||t.clients[j.username]||t.clients[t.ownerId])&&(v[M(j._id)]||(v[M(j._id)]=!0))}),t.admins=p,t.peers=g,t.clients=v;let w=JSON.parse(JSON.stringify(t));return w._id&&delete w._id,s.includes("mongo")?M(t._id).includes("defaultId")?(await this.db.collection(t.structType?t.structType:"data").insertOne(w),delete t._id,t=await this.db.collection(t.structType?t.structType:"data").findOne(t),t._id=M(t._id)):await this.collections.group.instance.updateOne({_id:Z(t._id)},{$set:w},{upsert:!0}):this.setLocalData(t),this.checkToNotify(e,[t],this.mode),this.debug&&console.log("setGroup: user:",e,"output",t),t}else return!1};getMongoUser=(e,t="",s=!0,r=!1,i)=>new Promise(async o=>{let l=[{email:t},{id:t},{username:t}];try{l.push({_id:Z(t)})}catch{console.log("error creating ObjectId with ",t)}let c=await this.collections.profile.instance.findOne({$or:l});if(!c||c==null)o(void 0);else if(c._id=M(c._id),c.ownerId||(c.ownerId=c._id),r)(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==i&&o(void 0),c={username:c.username,firstName:c.firstName,lastName:c.lastName,fullName:c.fullName,pictureUrl:c.pictureUrl,_id:c._id},o({user:c});else if(s){if(M(e._id)!==c._id||M(e._id)===c._id&&e.userRoles?.admincontrol){let j=!this.useAuths;this.useAuths&&(j=await this.checkAuthorization(e,c,"READ",i)),j||o(void 0)}let u=[],p=this.collections.authorization.instance.find({ownerId:c._id}),g=await p.toArray();p.toArray().length>0&&g.forEach(j=>u.push(j));let w=await this.collections.group.instance.find({users:{$all:[c._id]}}).toArray(),A=[];w.length>0&&w.forEach(j=>A.push(j)),o({user:c,authorizations:u,groups:A})}else(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==i&&o(void 0),o({user:c})});queryUsers=(e,t="",s=0,r=0,i=!1,o)=>(typeof e=="string"&&(e=this.users[e]),e?new Promise(async l=>{let c={$regex:`^${t}`,$options:"i"},u=[{email:c},{username:c},{firstName:c},{lastName:c},{name:c}],p;if(this.mode.includes("mongo")){let g=this.collections.profile.instance.find({$or:u},{projection:Yt}).skip(r);s>0&&g.limit(s),await g,p=await g.toArray(),console.log(p)}else{p=[];for(let g=0;g<u.length;g++){let v=this.getLocalData("profile",u[g]);Array.isArray(v)?v.forEach(w=>{p.push({firstName:w.firstName,lastName:w.lastName,fullName:w.fullName,username:w.username,pictureUrl:w.pictureUrl})}):v&&p.push({firstName:v.firstName,lastName:v.lastName,fullName:v.fullName,username:v.username,pictureUrl:v.pictureUrl})}}if(i){let g=[],v=M(e._id);for(let w=0;w<p.length;w++){let A=p[w];if(A._id=M(A._id),v!==A._id||v===A._id&&e.userRoles?.admincontrol){let j=!this.useAuths;this.useAuths&&(j=await this.checkAuthorization(e,A,"READ",o)),j&&g.push(A)}}p=g}else if(this.useAccessTokens||this.useRefreshTokens){let g=this.getToken(e);if(!g||g!==o){l(!1);return}}l(p)}):Promise.resolve(void 0));getMongoUsersByIds=async(e,t=[],s)=>{let r=[];t.forEach(o=>{try{r.push({_id:Z(o)})}catch{}});let i=[];if(r.length>0){let l=await this.collections.profile.instance.find({$or:r}).toArray();l.length>0&&l.forEach(c=>{s?i.push({username:c.username,firstName:c.firstName,lastName:c.lastName,fullName:c.fullName,pictureUrl:c.pictureUrl,_id:c._id}):i.push(c)})}return i};getMongoUsersByRole=async(e,t)=>{let s=this.collections.profile.instance.find({userRoles:{$all:{[t]:!0}}}),r=[],i=await s.toArray();return i.length>0&&i.forEach(o=>{r.push(o)}),r};getMongoDataByIds=async(e,t,s,r,i)=>{let o=M(e._id);if(t.length>0){let l=[];t.forEach(u=>{let p={_id:Z(u)};s&&(p.ownerId=s),l.push(p)});let c=[];if(!r)await Promise.all(Object.keys(this.collections).map(async u=>{let g=await(await this.db.collection(u).find({$or:l})).toArray();if(g.length>0){let v=!0,w="";for(let A=0;A<g.length;A++){let j=g[A];j?.ownerId?(o!==j.ownerId||o===j.ownerId&&e.userRoles?.admincontrol)&&w!==j.ownerId&&(this.useAuths&&(v=await this.checkAuthorization(e,j,"READ",i)),w=j.ownerId):v=!0,v&&c.push(j)}}}));else{let p=await(await this.db.collection(r).find({$or:l})).toArray();if(p.length>0){let g=!0,v="";p.forEach(async w=>{w?.ownerId?(o!==w.ownerId||o===w.ownerId&&e.userRoles?.admincontrol)&&v!==w.ownerId&&(this.useAuths&&(g=await this.checkAuthorization(e,w,"READ",i)),v=w.ownerId):g=!0,g&&c.push(w)})}}return c}};getMongoData=async(e,t,s,r={},i=0,o=0,l)=>{s||(s=r?.ownerId),r||(r={}),r._id&&(r._id=Z(r._id));let c=M(e._id),u=[],p=!0,g="",v;if(!t&&!s&&!r)return[];if(!t&&s&&Object.keys(r).length===0)return await this.getAllUserMongoData(e,s);if((!r||Object.keys(r).length===0)&&s&&t?v=this.db.collection(t).find({ownerId:s}).sort({$natural:-1}).skip(o):t&&Object.keys(r).length>0&&(s&&(r.ownerId=s),v=await this.db.collection(t).find(r).sort({$natural:-1}).skip(o)),v){i>0&&v.limit(i);let w=await v.toArray();if(w.length>0)for(let A=0;A<w.length;A++){let j=w[A];j?.ownerId?(c!==j.ownerId||c===j.ownerId&&e.userRoles?.admincontrol)&&g!==j.ownerId&&(this.useAuths&&(p=await this.checkAuthorization(e,j,"READ",l)),g=j.ownerId):p=!0,p===!0&&u.push(j)}}else!t&&Object.keys(r).length>0&&!s&&await Promise.all(Object.keys(this.collections).map(async w=>{if(v=await this.db.collection(w).find(r).sort({$natural:-1}).skip(o),v){i>0&&v.limit(i);let A=await v.toArray();if(A.length>0)for(let j=0;j<A.length;j++){let F=A[j];F?.ownerId?(c!==F.ownerId||c===F.ownerId&&e.userRoles?.admincontrol)&&g!==F.ownerId&&(this.useAuths&&(p=await this.checkAuthorization(e,F,"READ",l)),g=F.ownerId):p=!0,p===!0&&u.push(F)}}}));return p?u:[]};getAllUserMongoData=async(e,t,s=[],r,i)=>{let o=[],l=!0,c="";return await Promise.all(Object.keys(this.collections).map(async(u,p)=>{if(l&&s.indexOf(u)<0){let g={ownerId:t};r&&(typeof r[0]=="string"&&(r[0]=pe(r[0])),typeof r[1]=="string"&&(r[1]=pe(r[1])),g.timestamp={$gt:r[0],$lt:r[1]});let w=await this.db.collection(u).find(g).toArray(),A=w.length;for(let j=0;j<A;j++){let F=w[j];t?(M(e._id)!==t||M(e._id)===t&&e.userRoles?.admincontrol)&&c!==t&&(this.useAuths&&(l=await this.checkAuthorization(e,F,"READ",i)),c=t):l=!0,l&&o.push(F)}}})),l?o:[]};getMongoDataByRefs=async(e,t=[],s)=>{let r=[];if(r.length>0){let i="";t.forEach(async o=>{if(o.structType&&M(o._id)){let l=await this.db.collection(o.structType).findOne({_id:Z(o._id)});if(l){let c=!0;!l?.ownerId||l.ownerId===e._id?c=!0:(M(e._id)!==l.ownerId||M(e._id)===l.ownerId&&e.userRoles?.admincontrol)&&i!==l.ownerId&&(this.useAuths&&(c=await this.checkAuthorization(e,l,"READ",s)),i=l.ownerId),c===!0&&r.push(l)}}})}return r};getMongoAuthorizations=async(e,t=M(e._id),s="",r)=>{let i=[];if(s.length===0){let l=await this.collections.authorization.instance.find({ownerId:t}).toArray();l.length>0&&l.forEach(c=>{i.push(c)})}else i.push(await this.collections.authorization.instance.findOne({_id:Z(s),ownerId:t}));if(i[0]?.ownerId){if(M(e._id)!==i[0]?.ownerId){let o=!this.useAuths;if(this.useAuths&&(o=await this.checkAuthorization(e,i[0],"READ",r)),!o)return}}return i};getMongoGroups=async(e,t=M(e._id),s="")=>{let r=[];if(s.length===0){let o=await this.collections.group.instance.find({users:{$all:[t]}}).toArray();o.length>0&&o.forEach(l=>{r.push(l)})}else try{r.push(await this.collections.group.instance.findOne({_id:Z(s),users:{$all:[t]}}))}catch{}return r};deleteMongoData=async(e,t=[],s)=>{let r=[];await Promise.all(t.map(async o=>{try{let l=Z(o._id),c=await this.db.collection(o.structType).findOne({_id:l});if(c){r.push(c);let u=await this.collections.notifications.instance.find({parent:{structType:o.structType,_id:M(o._id)}}),p=u.toArray().length;for(let g=0;g<p;g++){let v=await u.next();v&&r.push(v)}}}catch{}}));let i="";return await Promise.all(r.map(async(o,l)=>{let c=!0;!o?.ownerId||o.ownerId===e._id?c=!0:(o.ownerId!==M(e._id)||M(e._id)===o.ownerId&&e.userRoles?.admincontrol)&&o.ownerId!==i&&(i=o.ownerId,this.useAuths&&(c=await this.checkAuthorization(e,o,"WRITE",s))),c&&(await this.db.collection(o.structType?o.structType:"data").deleteOne({_id:Z(o._id)}),o.users&&Object.keys(o.users).forEach(u=>{u!==M(e._id)&&u!==o.ownerId&&this.users[u]&&this.users[u]?.sendAll({route:"structDeleted",args:{_id:M(o._id),structType:o.structType}})}),o.ownerId!==e._id&&this.users[o.ownerId]&&this.users[o.ownerId]?.sendAll({route:"structDeleted",args:{_id:M(o._id),structType:o.structType}}))})),!0};deleteMongoUser=async(e,t,s,r)=>{if(M(e._id)!==t||M(e._id)===t&&e.userRoles?.admincontrol){let i=await this.collections.profile.instance.findOne({id:t}),o=!this.useAuths;if(i?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,i,"WRITE",r)):o=!0,!o)return!1}if(await this.collections.profile.instance.deleteOne({id:t}),s)for(let i in this.collections)this.collections[i].instance.deleteMany({ownerId:t}),this.collections[i].instance.updateMany({users:{[t]:!0}},{$unset:{[`users.${t}`]:""}});return M(e._id)!==t&&this.users[t]&&this.users[t]?.sendAll({route:"structDeleted",args:{_id:t,structType:"profile"}}),!0};deleteMongoGroup=async(e,t,s)=>{let r=await this.collections.group.instance.findOne({_id:Z(t)});if(r){if(r?.ownerId){if(M(e._id)!==r.ownerId||M(e._id)===r.ownerId&&e.userRoles?.admincontrol){let i=!this.useAuths;if(this.useAuths&&(i=await this.checkAuthorization(e,r,"WRITE",s)),!i)return!1}}return r.users&&Object.keys(r.users).forEach(i=>{this.users[i]?.sendAll({route:"structDeleted",args:{_id:M(r._id),structType:r.structType}})}),await this.collections.group.instance.deleteOne({_id:Z(t)}),!0}else return!1};deleteMongoAuthorization=async(e,t,s)=>{let r=await this.collections.authorization.instance.findOne({_id:Z(t)}),i=M(e._id);if(r){if(i!==r.ownerId||i===r.ownerId&&e.userRoles?.admincontrol){let o=!this.useAuths;if(r?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,r,"WRITE",s)):o=!0,!o)return!1}return r.associatedAuthId&&(this.debug&&console.log(r),await this.collections.authorization.instance.deleteOne({_id:Z(r.associatedAuthId)}),r.authorizerId!==i?this.users[r.authorizerId]?.sendAll({route:"structDeleted",args:{_id:M(r.associatedAuthId),structType:r.structType}}):r.authorizedId!==i&&this.users[r.authorizedId]?.sendAll({route:"structDeleted",args:{_id:M(r.associatedAuthId),structType:r.structType}})),await this.collections.authorization.instance.deleteOne({_id:Z(t)}),r.authorizerId===i?this.users[r.authorizerId]?.sendAll({route:"structDeleted",args:{_id:M(r._id),structType:r.structType}}):r.authorizedId===i&&this.users[r.authorizedId]?.sendAll({route:"structDeleted",args:{_id:M(r._id),structType:r.structType}}),!0}else return!1};setAuthorization=async(e,t,s)=>{let r,i,o=this.mode.includes("mongo");if(o?(r=(await this.getMongoUser(e,t.authorizedId,!1)).user,i=(await this.getMongoUser(e,t.authorizerId,!1)).user):(r=this.getLocalData("profile",{_id:t.authorizedId})?.[0],i=this.getLocalData("profile",{_id:t.authorizerId})?.[0]),!r||!i)return!1;if(t.authorizedId!==M(r._id)&&(t.authorizedId=M(r._id)),t.authorizerId!==M(i._id)&&(t.authorizerId=M(i._id)),t.authorizedName||(r.name?t.authorizedName=r.name:r.username?t.authorizedName=r.username:r.email&&(t.authorizedName=r.email)),t.authorizerName||(r.name?t.authorizedName=r.name:i.username?t.authorizerName=i.username:i.email&&(t.authorizerName=i.email)),t?.ownerId){if((M(e._id)!==t.ownerId||M(e._id)===t.ownerId&&e.userRoles?.admincontrol)&&M(e._id)!==t.authorizedId&&M(e._id)!==t.authorizerId){let p=!this.useAuths;if(this.useAuths&&(p=await this.checkAuthorization(e,t,"WRITE",s)),!p)return!1}}let l=[];if(o){let g=await(await this.collections.authorization.instance.find({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId}]})).toArray();g.length>0&&g.forEach(v=>l.push(v))}else{let p=this.getLocalData("authorization",{authorizedId:t.authorizedId});Array.isArray(p)&&p.forEach(g=>{g.authorizerId===t.authorizerId&&l.push(g)})}let c;if(Array.isArray(l))for(let p=0;p<l.length;p++){let g=l[p];if(g.ownerId!==M(e._id)){t.authorizerId===M(e._id)?(g.authorizations=t.authorizations,g.structs=t.structs,g.excluded=t.excluded,g.expires=t.expires,g.status="OKAY",t.status="OKAY"):(t.authorizations=g.authorizations,t.structs=g.structs,t.excluded=g.excluded,t.expires=g.expires,g.status="OKAY",t.status="OKAY"),t.associatedAuthId=M(g._id),g.associatedAuthId=M(t._id),c=g;let v=JSON.parse(JSON.stringify(g));o?(delete v._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:g.ownerId}]},{$set:v},{upsert:!0})):this.setLocalData(v)}}let u=JSON.parse(JSON.stringify(t));if(o?(delete u._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:t.ownerId}]},{$set:u},{upsert:!0})):this.setLocalData(u),M(t._id).includes("defaultId")&&o){let p=await this.collections.authorization.instance.findOne(u);if(p&&(t._id=M(p._id),c)){let g=await this.collections.authorization.instance.findOne({$and:[{authorizedId:c.authorizedId},{authorizerId:c.authorizerId},{ownerId:c.ownerId}]});if(g){g.associatedAuthId=M(t._id);let v=JSON.parse(JSON.stringify(g));delete v._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:g.authorizedId},{authorizerId:g.authorizerId},{ownerId:g.ownerId}]},{$set:v},{upsert:!0}),this.checkToNotify(e,[g])}}}return t};checkAuthorization=async(e,t,s="READ",r)=>{if(typeof e=="string"&&(this.users[e]?e=this.users[e]:e={_id:e}),!e||!t)return!1;if(!t.ownerId)return!0;if(typeof e=="object"&&t.ownerId===M(e._id))return e.userRoles?.admincontrol,!0;if(this.useAccessTokens){if(!this.accessTokens.get(e._id)||this.accessTokens.get(e._id)!==r)return!1}else if(this.useRefreshTokens&&(!this.refreshTokens.get(e._id)||this.refreshTokens.get(e._id)!==r))return!1;let i,o;if(this.mode.includes("mongo")){if(i=await this.collections.authorization.instance.findOne({$or:[{authorizedId:M(e._id),authorizerId:t.ownerId,ownerId:M(e._id)},{authorizedId:t.ownerId,authorizerId:M(e._id),ownerId:M(e._id)}]}),!i)return!1;o=await this.collections.authorization.instance.findOne({$or:[{authorizedId:M(e._id),authorizerId:t.ownerId,ownerId:M(t.ownerId)},{authorizedId:t.ownerId,authorizerId:M(e._id),ownerId:M(t.ownerId)}]})}else i=this.getLocalData("authorization",{ownerId:M(e._id)}).find(c=>{if(c.authorizedId===M(e._id)&&c.authorizerId===t.ownerId)return!0}),o=this.getLocalData("authorization",{ownerId:t.ownerId}).find(c=>{if(c.authorizedId===M(e._id)&&c.authorizerId===t.ownerId)return!0});if(!i||!o)return!1;let l=!1;return i.status==="OKAY"&&o.status==="OKAY"&&(t.structType==="group"?i.authorizations[t.name+"_admin"]&&o.authorizations[t.name+"_admin"]&&(l=!0):i.authorizations.peer&&o.authorizations.peer||i.authorizations.admincontrol&&o.authorizations.admincontrol||i.structIds[M(t._id)]&&o.structIds[M(t._id)]?l=!0:i.excluded[t.structType]&&t.ownerId===M(e._id)&&s==="WRITE"&&(l=!1)),l};wipeDB=async()=>(await Promise.all(Object.values(this.collections).map(e=>{try{e.instance.remove({})}catch{}})),!0);overwriteLocalData=e=>{if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:M(t._id)});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:M(e._id)});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}};setLocalData=e=>{let t=s=>{let r=s.structType,i=this.collections[r]?.reference;i||(i={},this.collections[r]||(this.collections[r]={}),this.collections[r].reference=i),i[M(s._id)]=s};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)};getLocalData=(e,t)=>{let s,r,i;if(typeof t=="object"?(s=t.ownerId,r=Object.keys(t).filter(c=>c!="ownerId")[0],i=t[r]):i=t,!e&&!s&&!r&&!i)return[];let o=[];if(!e&&(s||r))return Object.values(this.collections).forEach(l=>{if(l=l.reference,(r==="_id"||r==="id")&&i){let c=l[i];c&&o.push(c)}else Object.values(l).forEach(c=>{r&&i?c[r]===i&&c.ownerId===s&&o.push(c):c.ownerId===s&&o.push(c)})}),o;{let l=this.collections[e]?.reference;if(!l)return o;if(!r&&!s)return Object.values(l).forEach(c=>{o.push(c)}),o;if((r==="_id"||r==="id")&&i)return M(l[i]);Object.keys(l).forEach(c=>{let u=l[c];r&&i&&!s?u[r]===i&&o.push(u):s&&!r?u.ownerId===s&&o.push(u):s&&r&&i&&u.ownerId===s&&u[r]&&u[r]===i&&o.push(u)})}return o};deleteLocalData=e=>{if(!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.collections[e.structType]&&delete this.collections[e.structType].reference[e._id],!0)}},Yt=re.ProfileStruct();for(let n in Yt)n==="username"||n==="lastName"||n==="firstName"||n==="name"||n==="_id"||n==="pictureUrl"?Yt[n]=1:delete Yt[n];0&&(module.exports={AuthorizationStruct,CMDService,Callable,ChatroomStruct,CircularBuffer,CoherenceMap,CoherenceStruct,CommentStruct,DS,Data,DataStruct,DataTablet,DateStruct,DelayBuffer,DelayBufferManager,E2EEService,ECGStruct,EDAStruct,EEGCoordinates,EEGStruct,EMGStruct,EventHandler,EventStruct,EyeTrackerStruct,FNIRSStruct,FrequencyBandsStruct,Graph,GraphNode,GroupStruct,HRVStruct,HTTPbackend,IMUStruct,InputBuffer,NotificationStruct,PPGStruct,ProfileStruct,Router,SSEbackend,ScheduleStruct,Service,SessionManager,SessionService,Struct,StructBackend,StructFrontend,WSSbackend,animate,backprop,bindListener,branching,connectionHasId,defaultCollections,defaultManifest,defaultServiceWorker,defaultSpecifiers,eegCoordinates,genTimeSpecifiers,genTimestampFromString,getAllProperties,getCallbackFromString,getFnParamNames,getFunctionHead,getStringId,htmlBodyBoilerPlate,instanceObject,isFunction,isNativeClass,isTypedArray,loaders,loop,methodstrings,parseFunctionFromText,pseudoObjectId,randomId,reconstructObject,recursivelyAssign,recursivelyStringifyFunctions,scriptBoilerPlate,setCoordinate,spliceTypedArray,state,stringifyFast,stringifyWithCircularRefs,stringifyWithFunctionsAndCircularRefs,structRegistry,substitute__operator,toObjectId,transformListenerResult,triggerListenerOncreate,wrapArgs});
