var yr=Object.create;var He=Object.defineProperty;var pr=Object.getOwnPropertyDescriptor;var _r=Object.getOwnPropertyNames;var mr=Object.getPrototypeOf,br=Object.prototype.hasOwnProperty;var z=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),Ds=(n,e)=>{for(var t in e)He(n,t,{get:e[t],enumerable:!0})},Ls=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of _r(e))!br.call(n,i)&&i!==t&&He(n,i,{get:()=>e[i],enumerable:!(s=pr(e,i))||s.enumerable});return n};var V=(n,e,t)=>(t=n!=null?yr(mr(n)):{},Ls(e||!n||!n.__esModule?He(t,"default",{value:n,enumerable:!0}):t,n)),Sr=n=>Ls(He({},"__esModule",{value:!0}),n);var Qs=z((rt,zt)=>{(function(n,e){if(typeof rt=="object"&&typeof zt=="object")zt.exports=e();else if(typeof define=="function"&&define.amd)define([],e);else{var t=e();for(var s in t)(typeof rt=="object"?rt:n)[s]=t[s]}})(global,()=>(()=>{"use strict";var n={n:m=>{var _=m&&m.__esModule?()=>m.default:()=>m;return n.d(_,{a:_}),_},d:(m,_)=>{for(var k in _)n.o(_,k)&&!n.o(m,k)&&Object.defineProperty(m,k,{enumerable:!0,get:_[k]})},o:(m,_)=>Object.prototype.hasOwnProperty.call(m,_),r:m=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(m,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(m,"__esModule",{value:!0})}},e={};n.r(e),n.d(e,{Channel:()=>O,EventBuffer:()=>h,Session:()=>x,SseError:()=>p,createChannel:()=>b,createEventBuffer:()=>w,createSession:()=>v});let t=require("http"),s=m=>JSON.stringify(m),i=/(\r\n|\r|\n)/g,r=/\n+$/g,o=m=>{let _=m;return _=_.replace(i,`
`),_=_.replace(r,""),_},a=require("crypto"),l;l=a.randomUUID?()=>(0,a.randomUUID)():()=>(0,a.randomBytes)(4).toString("hex");let f=m=>async(_,k={})=>{let{eventName:A="stream"}=k;return await new Promise((P,U)=>{_.on("data",R=>{let re;re=Buffer.isBuffer(R)?R.toString():R,m(re,A)}),_.once("end",()=>P(!0)),_.once("close",()=>P(!0)),_.once("error",R=>U(R))})},c=m=>async(_,k={})=>{let{eventName:A="iteration"}=k;for await(let P of _)m(P,A)};class h{constructor(_={}){var k,A;this.buffer="",this.writeField=(P,U)=>{let R=this.sanitize(U);return this.buffer+=P+":"+R+`
`,this},this.data=P=>{let U=this.serialize(P);return this.writeField("data",U),this},this.id=(P="")=>(this.writeField("id",P),this),this.retry=P=>{let U=P.toString();return this.writeField("retry",U),this},this.comment=(P="")=>(this.writeField("",P),this),this.dispatch=()=>(this.buffer+=`
`,this),this.push=(P,U="message",R=l())=>(this.event(U).id(R).data(P).dispatch(),this),this.stream=f(this.push),this.iterate=c(this.push),this.clear=()=>(this.buffer="",this),this.read=()=>this.buffer,this.serialize=(k=_.serializer)!==null&&k!==void 0?k:s,this.sanitize=(A=_.sanitizer)!==null&&A!==void 0?A:o}event(_){return this.writeField("event",_),this}}let u=require("events");var d=n.n(u);class g extends d(){addListener(_,k){return super.addListener(_,k)}prependListener(_,k){return super.prependListener(_,k)}prependOnceListener(_,k){return super.prependOnceListener(_,k)}on(_,k){return super.on(_,k)}once(_,k){return super.once(_,k)}emit(_,...k){return super.emit(_,...k)}off(_,k){return super.off(_,k)}removeListener(_,k){return super.removeListener(_,k)}}class p extends Error{constructor(_){super(_),this.message=`better-sse: ${_}`}}class x extends g{constructor(_,k,A={}){var P,U,R,re,Ot,At,Pt;super(),this.lastId="",this.isConnected=!1,this.state={},this.initialize=()=>{var L,Q,he;let gr=`http://${this.req.headers.host}${this.req.url}`,$e=new URL(gr).searchParams;if(this.trustClientEventId){let Tt=(he=(Q=(L=this.req.headers["last-event-id"])!==null&&L!==void 0?L:$e.get("lastEventId"))!==null&&Q!==void 0?Q:$e.get("evs_last_event_id"))!==null&&he!==void 0?he:"";this.lastId=Tt}let J={};this.res instanceof t.ServerResponse?(J["Content-Type"]="text/event-stream",J["Cache-Control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",J.Connection="keep-alive",J.Pragma="no-cache",J["X-Accel-Buffering"]="no"):(J["content-type"]="text/event-stream",J["cache-control"]="private, no-cache, no-store, no-transform, must-revalidate, max-age=0",J.pragma="no-cache",J["x-accel-buffering"]="no");for(let[Tt,js]of Object.entries(this.headers))J[Tt]=js??"";this.res.writeHead(this.statusCode,J),$e.has("padding")&&this.buffer.comment(" ".repeat(2049)).dispatch(),$e.has("evs_preamble")&&this.buffer.comment(" ".repeat(2056)).dispatch(),this.initialRetry!==null&&this.buffer.retry(this.initialRetry).dispatch(),this.flush(),this.keepAliveInterval!==null&&(this.keepAliveTimer=setInterval(this.keepAlive,this.keepAliveInterval)),this.isConnected=!0,this.emit("connected")},this.onDisconnected=()=>{this.req.removeListener("close",this.onDisconnected),this.res.removeListener("close",this.onDisconnected),this.keepAliveTimer&&clearInterval(this.keepAliveTimer),this.isConnected=!1,this.emit("disconnected")},this.keepAlive=()=>{this.buffer.comment().dispatch(),this.flush()},this.data=L=>(this.buffer.data(L),this),this.id=(L="")=>(this.buffer.id(L),this.lastId=L,this),this.retry=L=>(this.buffer.retry(L),this),this.comment=L=>(this.buffer.comment(L),this),this.dispatch=()=>(this.buffer.dispatch(),this),this.flush=()=>(this.res.write(this.buffer.read()),this.buffer.clear(),this),this.push=(L,Q="message",he=l())=>{if(!this.isConnected)throw new p("Cannot push data to a non-active session.");return this.buffer.push(L,Q,he),this.flush(),this.lastId=he,this.emit("push",L,Q,he),this},this.stream=f(this.push),this.iterate=c(this.push),this.batch=async L=>{if(L instanceof h)this.res.write(L.read());else{let Q=new h({serializer:this.serialize,sanitizer:this.sanitize});await L(Q),this.res.write(Q.read())}},this.req=_,this.res=k;let Cs=(P=A.serializer)!==null&&P!==void 0?P:s,Ns=(U=A.sanitizer)!==null&&U!==void 0?U:o;this.serialize=Cs,this.sanitize=Ns,this.buffer=new h({serializer:Cs,sanitizer:Ns}),this.trustClientEventId=(R=A.trustClientEventId)===null||R===void 0||R,this.initialRetry=A.retry===null?null:(re=A.retry)!==null&&re!==void 0?re:2e3,this.keepAliveInterval=A.keepAlive===null?null:(Ot=A.keepAlive)!==null&&Ot!==void 0?Ot:1e4,this.statusCode=(At=A.statusCode)!==null&&At!==void 0?At:200,this.headers=(Pt=A.headers)!==null&&Pt!==void 0?Pt:{},this.req.once("close",this.onDisconnected),this.res.once("close",this.onDisconnected),setImmediate(this.initialize)}event(_){return this.buffer.event(_),this}}let v=(...m)=>new Promise(_=>{let k=new x(...m);k.once("connected",()=>{_(k)})});class O extends g{constructor(){super(),this.state={},this.sessions=new Set,this.broadcast=(_,k="message",A={})=>{var P;let U=(P=A.eventId)!==null&&P!==void 0?P:l(),R=A.filter?this.activeSessions.filter(A.filter):this.sessions;for(let re of R)re.push(_,k,U);return this.emit("broadcast",_,k,U),this}}get activeSessions(){return Array.from(this.sessions)}get sessionCount(){return this.sessions.size}register(_){if(this.sessions.has(_))return this;if(!_.isConnected)throw new p("Cannot register a non-active session.");return _.once("disconnected",()=>{this.emit("session-disconnected",_),this.deregister(_)}),this.sessions.add(_),this.emit("session-registered",_),this}deregister(_){return this.sessions.has(_)?(this.sessions.delete(_),this.emit("session-deregistered",_),this):this}}let b=(...m)=>new O(...m),w=(...m)=>new h(...m);return e})())});var ii=z((Xo,si)=>{"use strict";var{Duplex:Tr}=require("stream");function ei(n){n.emit("close")}function Er(){!this.destroyed&&this._writableState.finished&&this.destroy()}function ti(n){this.removeListener("error",ti),this.destroy(),this.listenerCount("error")===0&&this.emit("error",n)}function Cr(n,e){let t=!0,s=new Tr({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return n.on("message",function(r,o){let a=!o&&s._readableState.objectMode?r.toString():r;s.push(a)||n.pause()}),n.once("error",function(r){s.destroyed||(t=!1,s.destroy(r))}),n.once("close",function(){s.destroyed||s.push(null)}),s._destroy=function(i,r){if(n.readyState===n.CLOSED){r(i),process.nextTick(ei,s);return}let o=!1;n.once("error",function(l){o=!0,r(l)}),n.once("close",function(){o||r(i),process.nextTick(ei,s)}),t&&n.terminate()},s._final=function(i){if(n.readyState===n.CONNECTING){n.once("open",function(){s._final(i)});return}n._socket!==null&&(n._socket._writableState.finished?(i(),s._readableState.endEmitted&&s.destroy()):(n._socket.once("finish",function(){i()}),n.close()))},s._read=function(){n.isPaused&&n.resume()},s._write=function(i,r,o){if(n.readyState===n.CONNECTING){n.once("open",function(){s._write(i,r,o)});return}n.send(i,o)},s.on("end",Er),s.on("error",ti),s}si.exports=Cr});var ne=z((Qo,ri)=>{"use strict";ri.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}}});var Ce=z((ea,ot)=>{"use strict";var{EMPTY_BUFFER:Nr}=ne(),Gt=Buffer[Symbol.species];function jr(n,e){if(n.length===0)return Nr;if(n.length===1)return n[0];let t=Buffer.allocUnsafe(e),s=0;for(let i=0;i<n.length;i++){let r=n[i];t.set(r,s),s+=r.length}return s<e?new Gt(t.buffer,t.byteOffset,s):t}function ni(n,e,t,s,i){for(let r=0;r<i;r++)t[s+r]=n[r]^e[r&3]}function oi(n,e){for(let t=0;t<n.length;t++)n[t]^=e[t&3]}function Dr(n){return n.length===n.buffer.byteLength?n.buffer:n.buffer.slice(n.byteOffset,n.byteOffset+n.length)}function Bt(n){if(Bt.readOnly=!0,Buffer.isBuffer(n))return n;let e;return n instanceof ArrayBuffer?e=new Gt(n):ArrayBuffer.isView(n)?e=new Gt(n.buffer,n.byteOffset,n.byteLength):(e=Buffer.from(n),Bt.readOnly=!1),e}ot.exports={concat:jr,mask:ni,toArrayBuffer:Dr,toBuffer:Bt,unmask:oi};if(!process.env.WS_NO_BUFFER_UTIL)try{let n=require("bufferutil");ot.exports.mask=function(e,t,s,i,r){r<48?ni(e,t,s,i,r):n.mask(e,t,s,i,r)},ot.exports.unmask=function(e,t){e.length<32?oi(e,t):n.unmask(e,t)}}catch{}});var fi=z((ta,li)=>{"use strict";var ai=Symbol("kDone"),qt=Symbol("kRun"),$t=class{constructor(e){this[ai]=()=>{this.pending--,this[qt]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[qt]()}[qt](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[ai])}}};li.exports=$t});var De=z((sa,di)=>{"use strict";var Ne=require("zlib"),ci=Ce(),Lr=fi(),{kStatusCode:hi}=ne(),Ur=Buffer[Symbol.species],Ir=Buffer.from([0,0,255,255]),ft=Symbol("permessage-deflate"),ee=Symbol("total-length"),je=Symbol("callback"),oe=Symbol("buffers"),lt=Symbol("error"),at,Ht=class{constructor(e,t,s){if(this._maxPayload=s|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,!at){let i=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;at=new Lr(i)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[je];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let t=this._options,s=e.find(i=>!(t.serverNoContextTakeover===!1&&i.server_no_context_takeover||i.server_max_window_bits&&(t.serverMaxWindowBits===!1||typeof t.serverMaxWindowBits=="number"&&t.serverMaxWindowBits>i.server_max_window_bits)||typeof t.clientMaxWindowBits=="number"&&!i.client_max_window_bits));if(!s)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(s.server_no_context_takeover=!0),t.clientNoContextTakeover&&(s.client_no_context_takeover=!0),typeof t.serverMaxWindowBits=="number"&&(s.server_max_window_bits=t.serverMaxWindowBits),typeof t.clientMaxWindowBits=="number"?s.client_max_window_bits=t.clientMaxWindowBits:(s.client_max_window_bits===!0||t.clientMaxWindowBits===!1)&&delete s.client_max_window_bits,s}acceptAsClient(e){let t=e[0];if(this._options.clientNoContextTakeover===!1&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!t.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(t.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return t}normalizeParams(e){return e.forEach(t=>{Object.keys(t).forEach(s=>{let i=t[s];if(i.length>1)throw new Error(`Parameter "${s}" must have only a single value`);if(i=i[0],s==="client_max_window_bits"){if(i!==!0){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else if(s==="server_max_window_bits"){let r=+i;if(!Number.isInteger(r)||r<8||r>15)throw new TypeError(`Invalid value for parameter "${s}": ${i}`);i=r}else if(s==="client_no_context_takeover"||s==="server_no_context_takeover"){if(i!==!0)throw new TypeError(`Invalid value for parameter "${s}": ${i}`)}else throw new Error(`Unknown parameter "${s}"`);t[s]=i})}),e}decompress(e,t,s){at.add(i=>{this._decompress(e,t,(r,o)=>{i(),s(r,o)})})}compress(e,t,s){at.add(i=>{this._compress(e,t,(r,o)=>{i(),s(r,o)})})}_decompress(e,t,s){let i=this._isServer?"client":"server";if(!this._inflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ne.Z_DEFAULT_WINDOWBITS:this.params[r];this._inflate=Ne.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[ft]=this,this._inflate[ee]=0,this._inflate[oe]=[],this._inflate.on("error",Rr),this._inflate.on("data",ui)}this._inflate[je]=s,this._inflate.write(e),t&&this._inflate.write(Ir),this._inflate.flush(()=>{let r=this._inflate[lt];if(r){this._inflate.close(),this._inflate=null,s(r);return}let o=ci.concat(this._inflate[oe],this._inflate[ee]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[ee]=0,this._inflate[oe]=[],t&&this.params[`${i}_no_context_takeover`]&&this._inflate.reset()),s(null,o)})}_compress(e,t,s){let i=this._isServer?"server":"client";if(!this._deflate){let r=`${i}_max_window_bits`,o=typeof this.params[r]!="number"?Ne.Z_DEFAULT_WINDOWBITS:this.params[r];this._deflate=Ne.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[ee]=0,this._deflate[oe]=[],this._deflate.on("data",Mr)}this._deflate[je]=s,this._deflate.write(e),this._deflate.flush(Ne.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let r=ci.concat(this._deflate[oe],this._deflate[ee]);t&&(r=new Ur(r.buffer,r.byteOffset,r.length-4)),this._deflate[je]=null,this._deflate[ee]=0,this._deflate[oe]=[],t&&this.params[`${i}_no_context_takeover`]&&this._deflate.reset(),s(null,r)})}};di.exports=Ht;function Mr(n){this[oe].push(n),this[ee]+=n.length}function ui(n){if(this[ee]+=n.length,this[ft]._maxPayload<1||this[ee]<=this[ft]._maxPayload){this[oe].push(n);return}this[lt]=new RangeError("Max payload size exceeded"),this[lt].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[lt][hi]=1009,this.removeListener("data",ui),this.reset()}function Rr(n){this[ft]._inflate=null,n[hi]=1007,this[je](n)}});var Le=z((ia,ct)=>{"use strict";var{isUtf8:gi}=require("buffer"),Fr=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function zr(n){return n>=1e3&&n<=1014&&n!==1004&&n!==1005&&n!==1006||n>=3e3&&n<=4999}function Jt(n){let e=n.length,t=0;for(;t<e;)if(!(n[t]&128))t++;else if((n[t]&224)===192){if(t+1===e||(n[t+1]&192)!==128||(n[t]&254)===192)return!1;t+=2}else if((n[t]&240)===224){if(t+2>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||n[t]===224&&(n[t+1]&224)===128||n[t]===237&&(n[t+1]&224)===160)return!1;t+=3}else if((n[t]&248)===240){if(t+3>=e||(n[t+1]&192)!==128||(n[t+2]&192)!==128||(n[t+3]&192)!==128||n[t]===240&&(n[t+1]&240)===128||n[t]===244&&n[t+1]>143||n[t]>244)return!1;t+=4}else return!1;return!0}ct.exports={isValidStatusCode:zr,isValidUTF8:Jt,tokenChars:Fr};if(gi)ct.exports.isValidUTF8=function(n){return n.length<24?Jt(n):gi(n)};else if(!process.env.WS_NO_UTF_8_VALIDATE)try{let n=require("utf-8-validate");ct.exports.isValidUTF8=function(e){return e.length<32?Jt(e):n(e)}}catch{}});var Xt=z((ra,vi)=>{"use strict";var{Writable:Wr}=require("stream"),yi=De(),{BINARY_TYPES:Gr,EMPTY_BUFFER:pi,kStatusCode:Br,kWebSocket:qr}=ne(),{concat:Vt,toArrayBuffer:$r,unmask:Hr}=Ce(),{isValidStatusCode:Jr,isValidUTF8:_i}=Le(),ht=Buffer[Symbol.species],H=0,mi=1,bi=2,Si=3,Yt=4,Kt=5,ut=6,Zt=class extends Wr{constructor(e={}){super(),this._allowSynchronousEvents=e.allowSynchronousEvents!==void 0?e.allowSynchronousEvents:!0,this._binaryType=e.binaryType||Gr[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=e.maxPayload|0,this._skipUTF8Validation=!!e.skipUTF8Validation,this[qr]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._errored=!1,this._loop=!1,this._state=H}_write(e,t,s){if(this._opcode===8&&this._state==H)return s();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(s)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let s=this._buffers[0];return this._buffers[0]=new ht(s.buffer,s.byteOffset+e,s.length-e),new ht(s.buffer,s.byteOffset,e)}let t=Buffer.allocUnsafe(e);do{let s=this._buffers[0],i=t.length-e;e>=s.length?t.set(this._buffers.shift(),i):(t.set(new Uint8Array(s.buffer,s.byteOffset,e),i),this._buffers[0]=new ht(s.buffer,s.byteOffset+e,s.length-e)),e-=s.length}while(e>0);return t}startLoop(e){this._loop=!0;do switch(this._state){case H:this.getInfo(e);break;case mi:this.getPayloadLength16(e);break;case bi:this.getPayloadLength64(e);break;case Si:this.getMask();break;case Yt:this.getData(e);break;case Kt:case ut:this._loop=!1;return}while(this._loop);this._errored||e()}getInfo(e){if(this._bufferedBytes<2){this._loop=!1;return}let t=this.consume(2);if(t[0]&48){let i=this.createError(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");e(i);return}let s=(t[0]&64)===64;if(s&&!this._extensions[yi.extensionName]){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._fin=(t[0]&128)===128,this._opcode=t[0]&15,this._payloadLength=t[1]&127,this._opcode===0){if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(!this._fragmented){let i=this.createError(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented){let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}this._compressed=s}else if(this._opcode>7&&this._opcode<11){if(!this._fin){let i=this.createError(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");e(i);return}if(s){let i=this.createError(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");e(i);return}if(this._payloadLength>125||this._opcode===8&&this._payloadLength===1){let i=this.createError(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");e(i);return}}else{let i=this.createError(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");e(i);return}if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(t[1]&128)===128,this._isServer){if(!this._masked){let i=this.createError(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK");e(i);return}}else if(this._masked){let i=this.createError(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");e(i);return}this._payloadLength===126?this._state=mi:this._payloadLength===127?this._state=bi:this.haveLength(e)}getPayloadLength16(e){if(this._bufferedBytes<2){this._loop=!1;return}this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength(e)}getPayloadLength64(e){if(this._bufferedBytes<8){this._loop=!1;return}let t=this.consume(8),s=t.readUInt32BE(0);if(s>Math.pow(2,21)-1){let i=this.createError(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH");e(i);return}this._payloadLength=s*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength(e)}haveLength(e){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0)){let t=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");e(t);return}this._masked?this._state=Si:this._state=Yt}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=Yt}getData(e){let t=pi;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}t=this.consume(this._payloadLength),this._masked&&this._mask[0]|this._mask[1]|this._mask[2]|this._mask[3]&&Hr(t,this._mask)}if(this._opcode>7){this.controlMessage(t,e);return}if(this._compressed){this._state=Kt,this.decompress(t,e);return}t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage(e)}decompress(e,t){this._extensions[yi.extensionName].decompress(e,this._fin,(i,r)=>{if(i)return t(i);if(r.length){if(this._messageLength+=r.length,this._messageLength>this._maxPayload&&this._maxPayload>0){let o=this.createError(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");t(o);return}this._fragments.push(r)}this.dataMessage(t),this._state===H&&this.startLoop(t)})}dataMessage(e){if(!this._fin){this._state=H;return}let t=this._messageLength,s=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let i;this._binaryType==="nodebuffer"?i=Vt(s,t):this._binaryType==="arraybuffer"?i=$r(Vt(s,t)):i=s,this._allowSynchronousEvents?(this.emit("message",i,!0),this._state=H):(this._state=ut,setImmediate(()=>{this.emit("message",i,!0),this._state=H,this.startLoop(e)}))}else{let i=Vt(s,t);if(!this._skipUTF8Validation&&!_i(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");e(r);return}this._state===Kt||this._allowSynchronousEvents?(this.emit("message",i,!1),this._state=H):(this._state=ut,setImmediate(()=>{this.emit("message",i,!1),this._state=H,this.startLoop(e)}))}}controlMessage(e,t){if(this._opcode===8){if(e.length===0)this._loop=!1,this.emit("conclude",1005,pi),this.end();else{let s=e.readUInt16BE(0);if(!Jr(s)){let r=this.createError(RangeError,`invalid status code ${s}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");t(r);return}let i=new ht(e.buffer,e.byteOffset+2,e.length-2);if(!this._skipUTF8Validation&&!_i(i)){let r=this.createError(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");t(r);return}this._loop=!1,this.emit("conclude",s,i),this.end()}this._state=H;return}this._allowSynchronousEvents?(this.emit(this._opcode===9?"ping":"pong",e),this._state=H):(this._state=ut,setImmediate(()=>{this.emit(this._opcode===9?"ping":"pong",e),this._state=H,this.startLoop(t)}))}createError(e,t,s,i,r){this._loop=!1,this._errored=!0;let o=new e(s?`Invalid WebSocket frame: ${t}`:t);return Error.captureStackTrace(o,this.createError),o.code=r,o[Br]=i,o}};vi.exports=Zt});var es=z((oa,xi)=>{"use strict";var{Duplex:na}=require("stream"),{randomFillSync:Vr}=require("crypto"),wi=De(),{EMPTY_BUFFER:Yr}=ne(),{isValidStatusCode:Kr}=Le(),{mask:ki,toBuffer:me}=Ce(),K=Symbol("kByteLength"),Zr=Buffer.alloc(4),dt=8*1024,ue,be=dt,Qt=class n{constructor(e,t,s){this._extensions=t||{},s&&(this._generateMask=s,this._maskBuffer=Buffer.alloc(4)),this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){let s,i=!1,r=2,o=!1;t.mask&&(s=t.maskBuffer||Zr,t.generateMask?t.generateMask(s):(be===dt&&(ue===void 0&&(ue=Buffer.alloc(dt)),Vr(ue,0,dt),be=0),s[0]=ue[be++],s[1]=ue[be++],s[2]=ue[be++],s[3]=ue[be++]),o=(s[0]|s[1]|s[2]|s[3])===0,r=6);let a;typeof e=="string"?(!t.mask||o)&&t[K]!==void 0?a=t[K]:(e=Buffer.from(e),a=e.length):(a=e.length,i=t.mask&&t.readOnly&&!o);let l=a;a>=65536?(r+=8,l=127):a>125&&(r+=2,l=126);let f=Buffer.allocUnsafe(i?a+r:r);return f[0]=t.fin?t.opcode|128:t.opcode,t.rsv1&&(f[0]|=64),f[1]=l,l===126?f.writeUInt16BE(a,2):l===127&&(f[2]=f[3]=0,f.writeUIntBE(a,4,6)),t.mask?(f[1]|=128,f[r-4]=s[0],f[r-3]=s[1],f[r-2]=s[2],f[r-1]=s[3],o?[f,e]:i?(ki(e,s,f,r,a),[f]):(ki(e,s,e,0,a),[f,e])):[f,e]}close(e,t,s,i){let r;if(e===void 0)r=Yr;else{if(typeof e!="number"||!Kr(e))throw new TypeError("First argument must be a valid error code number");if(t===void 0||!t.length)r=Buffer.allocUnsafe(2),r.writeUInt16BE(e,0);else{let a=Buffer.byteLength(t);if(a>123)throw new RangeError("The message must not be greater than 123 bytes");r=Buffer.allocUnsafe(2+a),r.writeUInt16BE(e,0),typeof t=="string"?r.write(t,2):r.set(t,2)}}let o={[K]:r.length,fin:!0,generateMask:this._generateMask,mask:s,maskBuffer:this._maskBuffer,opcode:8,readOnly:!1,rsv1:!1};this._deflating?this.enqueue([this.dispatch,r,!1,o,i]):this.sendFrame(n.frame(r,o),i)}ping(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=me(e),i=e.length,r=me.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[K]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:9,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}pong(e,t,s){let i,r;if(typeof e=="string"?(i=Buffer.byteLength(e),r=!1):(e=me(e),i=e.length,r=me.readOnly),i>125)throw new RangeError("The data size must not be greater than 125 bytes");let o={[K]:i,fin:!0,generateMask:this._generateMask,mask:t,maskBuffer:this._maskBuffer,opcode:10,readOnly:r,rsv1:!1};this._deflating?this.enqueue([this.dispatch,e,!1,o,s]):this.sendFrame(n.frame(e,o),s)}send(e,t,s){let i=this._extensions[wi.extensionName],r=t.binary?2:1,o=t.compress,a,l;if(typeof e=="string"?(a=Buffer.byteLength(e),l=!1):(e=me(e),a=e.length,l=me.readOnly),this._firstFragment?(this._firstFragment=!1,o&&i&&i.params[i._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(o=a>=i._threshold),this._compress=o):(o=!1,r=0),t.fin&&(this._firstFragment=!0),i){let f={[K]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:o};this._deflating?this.enqueue([this.dispatch,e,this._compress,f,s]):this.dispatch(e,this._compress,f,s)}else this.sendFrame(n.frame(e,{[K]:a,fin:t.fin,generateMask:this._generateMask,mask:t.mask,maskBuffer:this._maskBuffer,opcode:r,readOnly:l,rsv1:!1}),s)}dispatch(e,t,s,i){if(!t){this.sendFrame(n.frame(e,s),i);return}let r=this._extensions[wi.extensionName];this._bufferedBytes+=s[K],this._deflating=!0,r.compress(e,s.fin,(o,a)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");typeof i=="function"&&i(l);for(let f=0;f<this._queue.length;f++){let c=this._queue[f],h=c[c.length-1];typeof h=="function"&&h(l)}return}this._bufferedBytes-=s[K],this._deflating=!1,s.readOnly=!1,this.sendFrame(n.frame(a,s),i),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[3][K],Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[3][K],this._queue.push(e)}sendFrame(e,t){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}};xi.exports=Qt});var Di=z((aa,ji)=>{"use strict";var{kForOnEventAttribute:Ue,kListener:ts}=ne(),Oi=Symbol("kCode"),Ai=Symbol("kData"),Pi=Symbol("kError"),Ti=Symbol("kMessage"),Ei=Symbol("kReason"),Se=Symbol("kTarget"),Ci=Symbol("kType"),Ni=Symbol("kWasClean"),te=class{constructor(e){this[Se]=null,this[Ci]=e}get target(){return this[Se]}get type(){return this[Ci]}};Object.defineProperty(te.prototype,"target",{enumerable:!0});Object.defineProperty(te.prototype,"type",{enumerable:!0});var de=class extends te{constructor(e,t={}){super(e),this[Oi]=t.code===void 0?0:t.code,this[Ei]=t.reason===void 0?"":t.reason,this[Ni]=t.wasClean===void 0?!1:t.wasClean}get code(){return this[Oi]}get reason(){return this[Ei]}get wasClean(){return this[Ni]}};Object.defineProperty(de.prototype,"code",{enumerable:!0});Object.defineProperty(de.prototype,"reason",{enumerable:!0});Object.defineProperty(de.prototype,"wasClean",{enumerable:!0});var ve=class extends te{constructor(e,t={}){super(e),this[Pi]=t.error===void 0?null:t.error,this[Ti]=t.message===void 0?"":t.message}get error(){return this[Pi]}get message(){return this[Ti]}};Object.defineProperty(ve.prototype,"error",{enumerable:!0});Object.defineProperty(ve.prototype,"message",{enumerable:!0});var Ie=class extends te{constructor(e,t={}){super(e),this[Ai]=t.data===void 0?null:t.data}get data(){return this[Ai]}};Object.defineProperty(Ie.prototype,"data",{enumerable:!0});var Xr={addEventListener(n,e,t={}){for(let i of this.listeners(n))if(!t[Ue]&&i[ts]===e&&!i[Ue])return;let s;if(n==="message")s=function(r,o){let a=new Ie("message",{data:o?r:r.toString()});a[Se]=this,gt(e,this,a)};else if(n==="close")s=function(r,o){let a=new de("close",{code:r,reason:o.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});a[Se]=this,gt(e,this,a)};else if(n==="error")s=function(r){let o=new ve("error",{error:r,message:r.message});o[Se]=this,gt(e,this,o)};else if(n==="open")s=function(){let r=new te("open");r[Se]=this,gt(e,this,r)};else return;s[Ue]=!!t[Ue],s[ts]=e,t.once?this.once(n,s):this.on(n,s)},removeEventListener(n,e){for(let t of this.listeners(n))if(t[ts]===e&&!t[Ue]){this.removeListener(n,t);break}}};ji.exports={CloseEvent:de,ErrorEvent:ve,Event:te,EventTarget:Xr,MessageEvent:Ie};function gt(n,e,t){typeof n=="object"&&n.handleEvent?n.handleEvent.call(n,t):n.call(e,t)}});var ss=z((la,Li)=>{"use strict";var{tokenChars:Me}=Le();function Z(n,e,t){n[e]===void 0?n[e]=[t]:n[e].push(t)}function Qr(n){let e=Object.create(null),t=Object.create(null),s=!1,i=!1,r=!1,o,a,l=-1,f=-1,c=-1,h=0;for(;h<n.length;h++)if(f=n.charCodeAt(h),o===void 0)if(c===-1&&Me[f]===1)l===-1&&(l=h);else if(h!==0&&(f===32||f===9))c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);let d=n.slice(l,c);f===44?(Z(e,d,t),t=Object.create(null)):o=d,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);else if(a===void 0)if(c===-1&&Me[f]===1)l===-1&&(l=h);else if(f===32||f===9)c===-1&&l!==-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h),Z(t,n.slice(l,c),!0),f===44&&(Z(e,o,t),t=Object.create(null),o=void 0),l=c=-1}else if(f===61&&l!==-1&&c===-1)a=n.slice(l,h),l=c=-1;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(i){if(Me[f]!==1)throw new SyntaxError(`Unexpected character at index ${h}`);l===-1?l=h:s||(s=!0),i=!1}else if(r)if(Me[f]===1)l===-1&&(l=h);else if(f===34&&l!==-1)r=!1,c=h;else if(f===92)i=!0;else throw new SyntaxError(`Unexpected character at index ${h}`);else if(f===34&&n.charCodeAt(h-1)===61)r=!0;else if(c===-1&&Me[f]===1)l===-1&&(l=h);else if(l!==-1&&(f===32||f===9))c===-1&&(c=h);else if(f===59||f===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${h}`);c===-1&&(c=h);let d=n.slice(l,c);s&&(d=d.replace(/\\/g,""),s=!1),Z(t,a,d),f===44&&(Z(e,o,t),t=Object.create(null),o=void 0),a=void 0,l=c=-1}else throw new SyntaxError(`Unexpected character at index ${h}`);if(l===-1||r||f===32||f===9)throw new SyntaxError("Unexpected end of input");c===-1&&(c=h);let u=n.slice(l,c);return o===void 0?Z(e,u,t):(a===void 0?Z(t,u,!0):s?Z(t,a,u.replace(/\\/g,"")):Z(t,a,u),Z(e,o,t)),e}function en(n){return Object.keys(n).map(e=>{let t=n[e];return Array.isArray(t)||(t=[t]),t.map(s=>[e].concat(Object.keys(s).map(i=>{let r=s[i];return Array.isArray(r)||(r=[r]),r.map(o=>o===!0?i:`${i}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}Li.exports={format:en,parse:Qr}});var as=z((ha,$i)=>{"use strict";var tn=require("events"),sn=require("https"),rn=require("http"),Mi=require("net"),nn=require("tls"),{randomBytes:on,createHash:an}=require("crypto"),{Duplex:fa,Readable:ca}=require("stream"),{URL:is}=require("url"),ae=De(),ln=Xt(),fn=es(),{BINARY_TYPES:Ui,EMPTY_BUFFER:yt,GUID:cn,kForOnEventAttribute:rs,kListener:hn,kStatusCode:un,kWebSocket:M,NOOP:Ri}=ne(),{EventTarget:{addEventListener:dn,removeEventListener:gn}}=Di(),{format:yn,parse:pn}=ss(),{toBuffer:_n}=Ce(),mn=30*1e3,Fi=Symbol("kAborted"),ns=[8,13],se=["CONNECTING","OPEN","CLOSING","CLOSED"],bn=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,N=class n extends tn{constructor(e,t,s){super(),this._binaryType=Ui[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=yt,this._closeTimer=null,this._extensions={},this._paused=!1,this._protocol="",this._readyState=n.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,t===void 0?t=[]:Array.isArray(t)||(typeof t=="object"&&t!==null?(s=t,t=[]):t=[t]),zi(this,e,t,s)):(this._autoPong=s.autoPong,this._isServer=!0)}get binaryType(){return this._binaryType}set binaryType(e){Ui.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get isPaused(){return this._paused}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,s){let i=new ln({allowSynchronousEvents:s.allowSynchronousEvents,binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:s.maxPayload,skipUTF8Validation:s.skipUTF8Validation});this._sender=new fn(e,this._extensions,s.generateMask),this._receiver=i,this._socket=e,i[M]=this,e[M]=this,i.on("conclude",wn),i.on("drain",kn),i.on("error",xn),i.on("message",On),i.on("ping",An),i.on("pong",Pn),e.setTimeout&&e.setTimeout(0),e.setNoDelay&&e.setNoDelay(),t.length>0&&e.unshift(t),e.on("close",Gi),e.on("data",_t),e.on("end",Bi),e.on("error",qi),this._readyState=n.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[ae.extensionName]&&this._extensions[ae.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=n.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){$(this,this._req,"WebSocket was closed before the connection was established");return}if(this.readyState===n.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=n.CLOSING,this._sender.close(e,t,!this._isServer,s=>{s||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),mn)}}pause(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!0,this._socket.pause())}ping(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){os(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.ping(e||yt,t,s)}pong(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(s=e,e=t=void 0):typeof t=="function"&&(s=t,t=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){os(this,e,s);return}t===void 0&&(t=!this._isServer),this._sender.pong(e||yt,t,s)}resume(){this.readyState===n.CONNECTING||this.readyState===n.CLOSED||(this._paused=!1,this._receiver._writableState.needDrain||this._socket.resume())}send(e,t,s){if(this.readyState===n.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof t=="function"&&(s=t,t={}),typeof e=="number"&&(e=e.toString()),this.readyState!==n.OPEN){os(this,e,s);return}let i={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[ae.extensionName]||(i.compress=!1),this._sender.send(e||yt,i,s)}terminate(){if(this.readyState!==n.CLOSED){if(this.readyState===n.CONNECTING){$(this,this._req,"WebSocket was closed before the connection was established");return}this._socket&&(this._readyState=n.CLOSING,this._socket.destroy())}}};Object.defineProperty(N,"CONNECTING",{enumerable:!0,value:se.indexOf("CONNECTING")});Object.defineProperty(N.prototype,"CONNECTING",{enumerable:!0,value:se.indexOf("CONNECTING")});Object.defineProperty(N,"OPEN",{enumerable:!0,value:se.indexOf("OPEN")});Object.defineProperty(N.prototype,"OPEN",{enumerable:!0,value:se.indexOf("OPEN")});Object.defineProperty(N,"CLOSING",{enumerable:!0,value:se.indexOf("CLOSING")});Object.defineProperty(N.prototype,"CLOSING",{enumerable:!0,value:se.indexOf("CLOSING")});Object.defineProperty(N,"CLOSED",{enumerable:!0,value:se.indexOf("CLOSED")});Object.defineProperty(N.prototype,"CLOSED",{enumerable:!0,value:se.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","isPaused","protocol","readyState","url"].forEach(n=>{Object.defineProperty(N.prototype,n,{enumerable:!0})});["open","error","close","message"].forEach(n=>{Object.defineProperty(N.prototype,`on${n}`,{enumerable:!0,get(){for(let e of this.listeners(n))if(e[rs])return e[hn];return null},set(e){for(let t of this.listeners(n))if(t[rs]){this.removeListener(n,t);break}typeof e=="function"&&this.addEventListener(n,e,{[rs]:!0})}})});N.prototype.addEventListener=dn;N.prototype.removeEventListener=gn;$i.exports=N;function zi(n,e,t,s){let i={allowSynchronousEvents:!0,autoPong:!0,protocolVersion:ns[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...s,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:"GET",host:void 0,path:void 0,port:void 0};if(n._autoPong=i.autoPong,!ns.includes(i.protocolVersion))throw new RangeError(`Unsupported protocol version: ${i.protocolVersion} (supported versions: ${ns.join(", ")})`);let r;if(e instanceof is)r=e;else try{r=new is(e)}catch{throw new SyntaxError(`Invalid URL: ${e}`)}r.protocol==="http:"?r.protocol="ws:":r.protocol==="https:"&&(r.protocol="wss:"),n._url=r.href;let o=r.protocol==="wss:",a=r.protocol==="ws+unix:",l;if(r.protocol!=="ws:"&&!o&&!a?l=`The URL's protocol must be one of "ws:", "wss:", "http:", "https", or "ws+unix:"`:a&&!r.pathname?l="The URL's pathname is empty":r.hash&&(l="The URL contains a fragment identifier"),l){let p=new SyntaxError(l);if(n._redirects===0)throw p;pt(n,p);return}let f=o?443:80,c=on(16).toString("base64"),h=o?sn.request:rn.request,u=new Set,d;if(i.createConnection=i.createConnection||(o?vn:Sn),i.defaultPort=i.defaultPort||f,i.port=r.port||f,i.host=r.hostname.startsWith("[")?r.hostname.slice(1,-1):r.hostname,i.headers={...i.headers,"Sec-WebSocket-Version":i.protocolVersion,"Sec-WebSocket-Key":c,Connection:"Upgrade",Upgrade:"websocket"},i.path=r.pathname+r.search,i.timeout=i.handshakeTimeout,i.perMessageDeflate&&(d=new ae(i.perMessageDeflate!==!0?i.perMessageDeflate:{},!1,i.maxPayload),i.headers["Sec-WebSocket-Extensions"]=yn({[ae.extensionName]:d.offer()})),t.length){for(let p of t){if(typeof p!="string"||!bn.test(p)||u.has(p))throw new SyntaxError("An invalid or duplicated subprotocol was specified");u.add(p)}i.headers["Sec-WebSocket-Protocol"]=t.join(",")}if(i.origin&&(i.protocolVersion<13?i.headers["Sec-WebSocket-Origin"]=i.origin:i.headers.Origin=i.origin),(r.username||r.password)&&(i.auth=`${r.username}:${r.password}`),a){let p=i.path.split(":");i.socketPath=p[0],i.path=p[1]}let g;if(i.followRedirects){if(n._redirects===0){n._originalIpc=a,n._originalSecure=o,n._originalHostOrSocketPath=a?i.socketPath:r.host;let p=s&&s.headers;if(s={...s,headers:{}},p)for(let[x,v]of Object.entries(p))s.headers[x.toLowerCase()]=v}else if(n.listenerCount("redirect")===0){let p=a?n._originalIpc?i.socketPath===n._originalHostOrSocketPath:!1:n._originalIpc?!1:r.host===n._originalHostOrSocketPath;(!p||n._originalSecure&&!o)&&(delete i.headers.authorization,delete i.headers.cookie,p||delete i.headers.host,i.auth=void 0)}i.auth&&!s.headers.authorization&&(s.headers.authorization="Basic "+Buffer.from(i.auth).toString("base64")),g=n._req=h(i),n._redirects&&n.emit("redirect",n.url,g)}else g=n._req=h(i);i.timeout&&g.on("timeout",()=>{$(n,g,"Opening handshake has timed out")}),g.on("error",p=>{g===null||g[Fi]||(g=n._req=null,pt(n,p))}),g.on("response",p=>{let x=p.headers.location,v=p.statusCode;if(x&&i.followRedirects&&v>=300&&v<400){if(++n._redirects>i.maxRedirects){$(n,g,"Maximum redirects exceeded");return}g.abort();let O;try{O=new is(x,e)}catch{let w=new SyntaxError(`Invalid URL: ${x}`);pt(n,w);return}zi(n,O,t,s)}else n.emit("unexpected-response",g,p)||$(n,g,`Unexpected server response: ${p.statusCode}`)}),g.on("upgrade",(p,x,v)=>{if(n.emit("upgrade",p),n.readyState!==N.CONNECTING)return;g=n._req=null;let O=p.headers.upgrade;if(O===void 0||O.toLowerCase()!=="websocket"){$(n,x,"Invalid Upgrade header");return}let b=an("sha1").update(c+cn).digest("base64");if(p.headers["sec-websocket-accept"]!==b){$(n,x,"Invalid Sec-WebSocket-Accept header");return}let w=p.headers["sec-websocket-protocol"],m;if(w!==void 0?u.size?u.has(w)||(m="Server sent an invalid subprotocol"):m="Server sent a subprotocol but none was requested":u.size&&(m="Server sent no subprotocol"),m){$(n,x,m);return}w&&(n._protocol=w);let _=p.headers["sec-websocket-extensions"];if(_!==void 0){if(!d){$(n,x,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let k;try{k=pn(_)}catch{$(n,x,"Invalid Sec-WebSocket-Extensions header");return}let A=Object.keys(k);if(A.length!==1||A[0]!==ae.extensionName){$(n,x,"Server indicated an extension that was not requested");return}try{d.accept(k[ae.extensionName])}catch{$(n,x,"Invalid Sec-WebSocket-Extensions header");return}n._extensions[ae.extensionName]=d}n.setSocket(x,v,{allowSynchronousEvents:i.allowSynchronousEvents,generateMask:i.generateMask,maxPayload:i.maxPayload,skipUTF8Validation:i.skipUTF8Validation})}),i.finishRequest?i.finishRequest(g,n):g.end()}function pt(n,e){n._readyState=N.CLOSING,n.emit("error",e),n.emitClose()}function Sn(n){return n.path=n.socketPath,Mi.connect(n)}function vn(n){return n.path=void 0,!n.servername&&n.servername!==""&&(n.servername=Mi.isIP(n.host)?"":n.host),nn.connect(n)}function $(n,e,t){n._readyState=N.CLOSING;let s=new Error(t);Error.captureStackTrace(s,$),e.setHeader?(e[Fi]=!0,e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),process.nextTick(pt,n,s)):(e.destroy(s),e.once("error",n.emit.bind(n,"error")),e.once("close",n.emitClose.bind(n)))}function os(n,e,t){if(e){let s=_n(e).length;n._socket?n._sender._bufferedBytes+=s:n._bufferedAmount+=s}if(t){let s=new Error(`WebSocket is not open: readyState ${n.readyState} (${se[n.readyState]})`);process.nextTick(t,s)}}function wn(n,e){let t=this[M];t._closeFrameReceived=!0,t._closeMessage=e,t._closeCode=n,t._socket[M]!==void 0&&(t._socket.removeListener("data",_t),process.nextTick(Wi,t._socket),n===1005?t.close():t.close(n,e))}function kn(){let n=this[M];n.isPaused||n._socket.resume()}function xn(n){let e=this[M];e._socket[M]!==void 0&&(e._socket.removeListener("data",_t),process.nextTick(Wi,e._socket),e.close(n[un])),e.emit("error",n)}function Ii(){this[M].emitClose()}function On(n,e){this[M].emit("message",n,e)}function An(n){let e=this[M];e._autoPong&&e.pong(n,!this._isServer,Ri),e.emit("ping",n)}function Pn(n){this[M].emit("pong",n)}function Wi(n){n.resume()}function Gi(){let n=this[M];this.removeListener("close",Gi),this.removeListener("data",_t),this.removeListener("end",Bi),n._readyState=N.CLOSING;let e;!this._readableState.endEmitted&&!n._closeFrameReceived&&!n._receiver._writableState.errorEmitted&&(e=n._socket.read())!==null&&n._receiver.write(e),n._receiver.end(),this[M]=void 0,clearTimeout(n._closeTimer),n._receiver._writableState.finished||n._receiver._writableState.errorEmitted?n.emitClose():(n._receiver.on("error",Ii),n._receiver.on("finish",Ii))}function _t(n){this[M]._receiver.write(n)||this.pause()}function Bi(){let n=this[M];n._readyState=N.CLOSING,n._receiver.end(),this.end()}function qi(){let n=this[M];this.removeListener("error",qi),this.on("error",Ri),n&&(n._readyState=N.CLOSING,this.destroy())}});var Ji=z((ua,Hi)=>{"use strict";var{tokenChars:Tn}=Le();function En(n){let e=new Set,t=-1,s=-1,i=0;for(i;i<n.length;i++){let o=n.charCodeAt(i);if(s===-1&&Tn[o]===1)t===-1&&(t=i);else if(i!==0&&(o===32||o===9))s===-1&&t!==-1&&(s=i);else if(o===44){if(t===-1)throw new SyntaxError(`Unexpected character at index ${i}`);s===-1&&(s=i);let a=n.slice(t,s);if(e.has(a))throw new SyntaxError(`The "${a}" subprotocol is duplicated`);e.add(a),t=s=-1}else throw new SyntaxError(`Unexpected character at index ${i}`)}if(t===-1||s!==-1)throw new SyntaxError("Unexpected end of input");let r=n.slice(t,i);if(e.has(r))throw new SyntaxError(`The "${r}" subprotocol is duplicated`);return e.add(r),e}Hi.exports={parse:En}});var er=z((ga,Qi)=>{"use strict";var Cn=require("events"),mt=require("http"),{Duplex:da}=require("stream"),{createHash:Nn}=require("crypto"),Vi=ss(),ge=De(),jn=Ji(),Dn=as(),{GUID:Ln,kWebSocket:Un}=ne(),In=/^[+/0-9A-Za-z]{22}==$/,Yi=0,Ki=1,Xi=2,ls=class extends Cn{constructor(e,t){if(super(),e={allowSynchronousEvents:!0,autoPong:!0,maxPayload:100*1024*1024,skipUTF8Validation:!1,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,WebSocket:Dn,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=mt.createServer((s,i)=>{let r=mt.STATUS_CODES[426];i.writeHead(426,{"Content-Length":r.length,"Content-Type":"text/plain"}),i.end(r)}),this._server.listen(e.port,e.host,e.backlog,t)):e.server&&(this._server=e.server),this._server){let s=this.emit.bind(this,"connection");this._removeListeners=Mn(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(i,r,o)=>{this.handleUpgrade(i,r,o,s)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set,this._shouldEmitClose=!1),this.options=e,this._state=Yi}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(this._state===Xi){e&&this.once("close",()=>{e(new Error("The server is not running"))}),process.nextTick(Re,this);return}if(e&&this.once("close",e),this._state!==Ki)if(this._state=Ki,this.options.noServer||this.options.server)this._server&&(this._removeListeners(),this._removeListeners=this._server=null),this.clients?this.clients.size?this._shouldEmitClose=!0:process.nextTick(Re,this):process.nextTick(Re,this);else{let t=this._server;this._removeListeners(),this._removeListeners=this._server=null,t.close(()=>{Re(this)})}}shouldHandle(e){if(this.options.path){let t=e.url.indexOf("?");if((t!==-1?e.url.slice(0,t):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,t,s,i){t.on("error",Zi);let r=e.headers["sec-websocket-key"],o=e.headers.upgrade,a=+e.headers["sec-websocket-version"];if(e.method!=="GET"){ye(this,e,t,405,"Invalid HTTP method");return}if(o===void 0||o.toLowerCase()!=="websocket"){ye(this,e,t,400,"Invalid Upgrade header");return}if(r===void 0||!In.test(r)){ye(this,e,t,400,"Missing or invalid Sec-WebSocket-Key header");return}if(a!==8&&a!==13){ye(this,e,t,400,"Missing or invalid Sec-WebSocket-Version header");return}if(!this.shouldHandle(e)){Fe(t,400);return}let l=e.headers["sec-websocket-protocol"],f=new Set;if(l!==void 0)try{f=jn.parse(l)}catch{ye(this,e,t,400,"Invalid Sec-WebSocket-Protocol header");return}let c=e.headers["sec-websocket-extensions"],h={};if(this.options.perMessageDeflate&&c!==void 0){let u=new ge(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let d=Vi.parse(c);d[ge.extensionName]&&(u.accept(d[ge.extensionName]),h[ge.extensionName]=u)}catch{ye(this,e,t,400,"Invalid or unacceptable Sec-WebSocket-Extensions header");return}}if(this.options.verifyClient){let u={origin:e.headers[`${a===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(u,(d,g,p,x)=>{if(!d)return Fe(t,g||401,p,x);this.completeUpgrade(h,r,f,e,t,s,i)});return}if(!this.options.verifyClient(u))return Fe(t,401)}this.completeUpgrade(h,r,f,e,t,s,i)}completeUpgrade(e,t,s,i,r,o,a){if(!r.readable||!r.writable)return r.destroy();if(r[Un])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>Yi)return Fe(r,503);let f=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${Nn("sha1").update(t+Ln).digest("base64")}`],c=new this.options.WebSocket(null,void 0,this.options);if(s.size){let h=this.options.handleProtocols?this.options.handleProtocols(s,i):s.values().next().value;h&&(f.push(`Sec-WebSocket-Protocol: ${h}`),c._protocol=h)}if(e[ge.extensionName]){let h=e[ge.extensionName].params,u=Vi.format({[ge.extensionName]:[h]});f.push(`Sec-WebSocket-Extensions: ${u}`),c._extensions=e}this.emit("headers",f,i),r.write(f.concat(`\r
`).join(`\r
`)),r.removeListener("error",Zi),c.setSocket(r,o,{allowSynchronousEvents:this.options.allowSynchronousEvents,maxPayload:this.options.maxPayload,skipUTF8Validation:this.options.skipUTF8Validation}),this.clients&&(this.clients.add(c),c.on("close",()=>{this.clients.delete(c),this._shouldEmitClose&&!this.clients.size&&process.nextTick(Re,this)})),a(c,i)}};Qi.exports=ls;function Mn(n,e){for(let t of Object.keys(e))n.on(t,e[t]);return function(){for(let s of Object.keys(e))n.removeListener(s,e[s])}}function Re(n){n._state=Xi,n.emit("close")}function Zi(){this.destroy()}function Fe(n,e,t,s){t=t||mt.STATUS_CODES[e],s={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(t),...s},n.once("finish",n.destroy),n.end(`HTTP/1.1 ${e} ${mt.STATUS_CODES[e]}\r
`+Object.keys(s).map(i=>`${i}: ${s[i]}`).join(`\r
`)+`\r
\r
`+t)}function ye(n,e,t,s,i){if(n.listenerCount("wsClientError")){let r=new Error(i);Error.captureStackTrace(r,ye),n.emit("wsClientError",r,t,e)}else Fe(t,s,i)}});var Vn={};Ds(Vn,{AuthorizationStruct:()=>ms,CMDService:()=>cs,Callable:()=>Je,ChatroomStruct:()=>ws,CoherenceMap:()=>St,CoherenceStruct:()=>bt,CommentStruct:()=>ks,DS:()=>G,Data:()=>rr,DataStruct:()=>Ss,DataTablet:()=>Be,DateStruct:()=>As,E2EEService:()=>Lt,ECGStruct:()=>wt,EDAStruct:()=>ds,EEGCoordinates:()=>ir,EEGStruct:()=>ie,EMGStruct:()=>ps,EventHandler:()=>ke,EventStruct:()=>vs,EyeTrackerStruct:()=>us,FNIRSStruct:()=>vt,FrequencyBandsStruct:()=>Ge,Graph:()=>q,GraphNode:()=>T,GroupStruct:()=>bs,HRVStruct:()=>ys,HTTPbackend:()=>Ft,IMUStruct:()=>hs,NotificationStruct:()=>xs,PPGStruct:()=>gs,ProfileStruct:()=>_s,Router:()=>Ut,SSEbackend:()=>Wt,ScheduleStruct:()=>Os,Service:()=>C,SessionsService:()=>Nt,Struct:()=>j,StructBackend:()=>Es,StructFrontend:()=>Ps,WSSbackend:()=>fs,animate:()=>Rs,backprop:()=>Is,bindListener:()=>Ws,branching:()=>Fs,connectionHasId:()=>It,defaultCollections:()=>dr,defaultManifest:()=>Rt,defaultServiceWorker:()=>Mt,defaultSpecifiers:()=>or,eegCoordinates:()=>ce,genTimeSpecifiers:()=>Gn,genTimestampFromString:()=>X,getAllProperties:()=>Ct,getCallbackFromString:()=>xe,getFnParamNames:()=>wr,getFunctionHead:()=>$s,getStringId:()=>S,htmlBodyBoilerPlate:()=>Or,instanceObject:()=>vr,isFunction:()=>Us,isNativeClass:()=>Ve,isTypedArray:()=>Vs,loaders:()=>_e,loop:()=>Ms,methodstrings:()=>xr,parseFunctionFromText:()=>Ke,pseudoObjectId:()=>Bn,randomId:()=>ar,reconstructObject:()=>kr,recursivelyAssign:()=>Ze,recursivelyStringifyFunctions:()=>qs,scriptBoilerPlate:()=>Ar,setCoordinate:()=>We,spliceTypedArray:()=>Ys,state:()=>Et,stringifyFast:()=>I,stringifyWithCircularRefs:()=>Hs,stringifyWithFunctionsAndCircularRefs:()=>Js,structRegistry:()=>nr,substitute__operator:()=>Bs,toObjectId:()=>D,transformListenerResult:()=>Gs,triggerListenerOncreate:()=>zs,wrapArgs:()=>Ye});module.exports=Sr(Vn);var ke=class{data={};triggers={};ctr=0;constructor(e){typeof e=="object"&&(this.data=e)}setState=e=>{Object.assign(this.data,e);let t=Object.getOwnPropertyNames(e);for(let s of t)this.triggerEvent(s,this.data[s]);if(this.triggers[we]){let s=r=>{r(e)},i=this.triggers[we].length;for(let r=i-1;r>=0;r--)s(this.triggers[we][r].onchange)}return this.data};setValue=(e,t)=>{this.data[e]=t,this.triggerEvent(e,t)};triggerEvent=(e,t)=>{if(this.triggers[e]){let s=r=>{r.onchange(t)},i=this.triggers[e].length;for(let r=i-1;r>=0;r--)s(this.triggers[e][r])}};subscribeState=e=>this.subscribeEvent(we,e);unsubscribeState=e=>this.unsubscribeEvent(we,e);subscribeEvent=(e,t,s,i)=>{if(e){s&&i&&!this.triggers[e]&&Object.defineProperty(this.data,e,{get:()=>s[i],set:o=>{s[i]=o},enumerable:!0,configurable:!0}),this.triggers[e]||(this.triggers[e]=[]);let r=this.ctr;return this.ctr++,this.triggers[e].push({sub:r,onchange:t}),r}else return};unsubscribeEvent=(e,t)=>{let s=this.triggers[e];if(s)if(t===void 0)delete this.triggers[e],delete this.data[e];else{let i,r=s.find((o,a)=>{if(o.sub===t)return i=a,!0});return r&&s.splice(i,1),Object.keys(s).length===0&&(delete this.triggers[e],delete this.data[e]),this.onRemoved&&this.onRemoved(r),!0}};subscribeEventOnce=(e,t)=>{let s,i=r=>{t(r),this.unsubscribeEvent(e,s)};return s=this.subscribeEvent(e,i),s};getEvent=(e,t)=>{if(typeof t!="number")return this.triggers[e];for(let s in this.triggers[e])if(this.triggers[e][s].sub===t)return this.triggers[e][s]};getSnapshot=()=>{let e={};for(let t in this.data)e[t]=this.data[t]};onRemoved},we="*s";var Et=new ke,Je=class extends Function{__bound;__call;constructor(){return super("return this.__bound.__call.apply(this.__bound, arguments)"),this.__bound=this.bind(this),this.__bound}},T=class n{__node={tag:`node${Math.floor(Math.random()*1e15)}`,unique:`${Math.floor(Math.random()*1e15)}`,state:Et};__children;__parent;__operator;__listeners;__props;__args;constructor(e,t,s){if(this.__setProperties(e,t,s),typeof e=="function"||e?.__callable){let i=new Je;i.__call=(...o)=>this.__operator(...o);let r=new Proxy(i,{get:(o,a,l)=>Reflect.has(this,a)?Reflect.get(this,a,l):Reflect.get(o,a,l),set:(o,a,l,f)=>Reflect.has(this,a)?Reflect.set(this,a,l,f):Reflect.set(o,a,l,f)});return Object.setPrototypeOf(r,this),r}}get __graph(){return this.__node?.graph}set __graph(e){this.__node.graph=e}__setProperties=(e,t,s)=>{if((()=>{let r=e;typeof e=="function"?Ve(e)?e=new e:e={__operator:e,__node:{forward:!0,tag:e.name}}:typeof e=="string"&&s?.get(e)&&(e=s.get(e)),"__node"in e||(e.__node={}),e.__node.initial||(e.__node.initial=r)})(),typeof e=="object"){let r=()=>{e.__node?.state?this.__node.state=e.__node.state:s&&(e.__node.state=s.__node.state)},o=()=>{e.__props&&(typeof e.__props=="function"&&(e.__props=new e.__props),typeof e.__props=="object"&&this.__proxyObject(e.__props))},a=()=>{e.__node.tag||(e.__operator?.name?e.__node.tag=e.__operator.name:e.__node.tag=`node${Math.floor(Math.random()*1e15)}`)},l=()=>{typeof e.__node=="string"?s?.get(e.__node.tag)?e=s.get(e.__node.tag):e.__node={}:e.__node||(e.__node={}),s&&(e.__node.graph=s),e instanceof q&&(e.__node.source=e)},f=()=>{if(!e.__parent&&t&&(e.__parent=t),t?.__node&&!(t instanceof q||e instanceof q)&&(e.__node.tag=t.__node.tag+"."+e.__node.tag),t instanceof q&&e instanceof q&&(e.__node.loaders&&Object.assign(t.__node.loaders?t.__node.loaders:{},e.__node.loaders),t.__node.mapGraphs)){e.__node.nodes.forEach(g=>{t.set(e.__node.tag+"."+g.__node.tag,g)});let d=()=>{e.__node.nodes.forEach(g=>{t.__node.nodes.delete(e.__node.tag+"."+g.__node.tag)})};this.__addOndisconnected(d)}},c=()=>{if(typeof e.default=="function"&&!e.__operator&&(e.__operator=e.default),e.__operator){if(typeof e.__operator=="string"&&s){let d=s.get(e.__operator);d&&(e.__operator=d.__operator),!e.__node.tag&&e.__operator.name&&(e.__node.tag=e.__operator.name)}typeof e.__operator=="function"&&(e.__operator=this.__setOperator(e.__operator)),e.default&&(e.default=e.__operator)}},h=()=>{e.__node=Object.assign(this.__node,e.__node);let d=Object.getOwnPropertyNames(e).filter(g=>{if(!pe[g])return!0});for(let g of d)g in e&&g!=="name"&&(this[g]=e[g])},u=()=>{this.__onconnected&&(typeof this.__onconnected=="function"?this.__onconnected=this.__onconnected.bind(this):Array.isArray(this.__onconnected)&&(this.__onconnected=this.__onconnected.map(d=>d.bind(this))),typeof this.__ondisconnected=="function"?this.__ondisconnected=this.__ondisconnected.bind(this):Array.isArray(this.__ondisconnected)&&(this.__ondisconnected=this.__ondisconnected.map(d=>d.bind(this))))};r(),a(),o(),l(),f(),h(),u(),c()}};__subscribe=(e,t,s,i,r,o,a)=>{let l=(c,h=(d,g)=>g||d,u=e)=>{let d;if(o){let x=Ye(u,o,this.__node.graph);u=x.__callback,d=x.__args}let g=this.__node.state.subscribeEvent(c,u,this,t),p=this.__node.state.getEvent(c,g);return this.__listeners||(this.__listeners={}),this.__listeners[c]=this.__node.state.triggers[c],p&&(p.source=this.__node.tag,t&&(p.key=t),p.target=h(e,i),r&&(p.tkey=r),s&&(p.subInput=s),o&&(p.arguments=d,p.__args=o),a&&(p.__callback=a),p.node=this,p.graph=this.__node.graph),g},f=c=>{let h=this.__node.graph.get(c);if(!h&&c.includes(".")){i=c.substring(0,c.lastIndexOf("."));let u=this.__node.graph.get(c.substring(0,i));r=c.lastIndexOf(".")+1,u&&typeof u[t]=="function"&&(c=(...d)=>u[r](...d))}else h.__operator&&(c=h.__operator,r="__operator");return c};if(t){if((!this.__node.localState||!this.__node.localState[t])&&this.__addLocalState(this,t),typeof e=="string"){if(a=this.__node.tag+"."+e,r=e,i){if(this.__node.graph?.get(i)){let u=this.__node.graph?.get(i);if(typeof u[e]=="function"){let d=u[e];e=(...g)=>{d(...g)}}else{let d=e;e=p=>{u[d]=p}}}}else if(typeof this[e]=="function"){let u=this[e];e=(...d)=>{u(...d)}}else this.__node.graph?.get(e)&&(e=f(e));if(typeof e!="function")return}let c,h=s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t;return typeof e=="function"&&!e?.__node?c=l(h,(u,d)=>d||u,e):e?.__node&&(c=l(h,(u,d)=>d||u.__node.unique,(...u)=>{e.__operator&&e.__operator(...u)})),c}else{if(typeof e=="string"&&(a=e,i||(i=e),this.__node.graph.get(e)&&(e=this.__node.graph.get(e)),r="__operator",typeof e!="object"))return;let c,h=s?this.__node.unique+"input":this.__node.unique;return typeof e=="function"&&!e?.__node?c=l(h,(u,d)=>d||u,e):e?.__node&&(c=l(h,(u,d)=>d||u.__node.unique,(...u)=>{e.__operator&&e.__operator(...u)})),c}};__unsubscribe=(e,t,s)=>t?this.__node.state.unsubscribeEvent(s?this.__node.unique+"."+t+"input":this.__node.unique+"."+t,e):this.__node.state.unsubscribeEvent(s?this.__node.unique+"input":this.__node.unique,e);__setOperator=e=>{e=e.bind(this),this.__args&&this.__node.graph&&(e=Ye(e,this.__args,this.__node.graph).__callback);let t=`${this.__node.unique}input`;if(this.__operator=(...s)=>{this.__node.state.triggers[t]&&this.__node.state.setValue(t,s);let i=e(...s);return this.__node.state.triggers[this.__node.unique]&&(typeof i?.then=="function"?i.then(r=>{r!==void 0&&this.__node.state.setValue(this.__node.unique,r)}).catch(console.error):i!==void 0&&this.__node.state.setValue(this.__node.unique,i)),i},this.__parent instanceof n&&!this.__subscribedToParent&&this.__parent.__operator){let s=this.__parent.__subscribe(this),i=()=>{this.__parent?.__unsubscribe(s),delete this.__subscribedToParent};this.__addOndisconnected(i),this.__subscribedToParent=!0}return this.__operator};__addLocalState=(e,t)=>{if(!e)return;this.__node.localState||(this.__node.localState={});let s=this.__node.localState,i=(r,o)=>{let a=this.__node.unique+"."+o,l=`${a}input`,f,c,h,u;if(typeof r[o]=="function"&&o!=="__operator")this.__props?.[o]?h=this.__props:h=s,f=()=>h[o],c=d=>{this.__props?.[o]||(d=d.bind(this)),h[o]=(...g)=>{this.__node.state.triggers[l]&&this.__node.state.setValue(l,g);let p=d(...g);return this.__node.state.triggers[a]&&(typeof p?.then=="function"?p.then(x=>{this.__node.state.triggerEvent(a,x)}).catch(console.error):this.__node.state.triggerEvent(a,p)),p}},s[o]=r[o].bind(this),u={get:f,set:c,enumerable:!0,configurable:!0};else if(o!=="__graph"){let d,g,p;this.__props?.[o]?p=this.__props:p=s,d=()=>p[o],g=x=>{p[o]=x,this.__node.state.triggers[a]&&this.__node.state.triggerEvent(a,x)},s[o]=r[o],u={get:d,set:g,enumerable:!0,configurable:!0}}if(Object.defineProperty(r,o,u),typeof this.__node.initial=="object"){let d=Object.getOwnPropertyDescriptor(this.__node.initial,o);(d===void 0||d?.configurable)&&Object.defineProperty(this.__node.initial,o,u)}};if(t)i(e,t);else for(let r in e)i(e,r)};__proxyObject=e=>{let t=Ct(e);for(let s of t){let i={get:()=>e[s],set:r=>{e[s]=r},enumerable:!0,configurable:!0};if(Object.defineProperty(this,s,i),typeof this.__node.initial=="object"){let r=Object.getOwnPropertyDescriptor(this.__node.initial,s);(r===void 0||r?.configurable)&&Object.defineProperty(this.__node.initial,s,i)}}};__addOnconnected(e){e=e.bind(this),Array.isArray(this.__onconnected)?this.__onconnected.push(e):typeof this.__onconnected=="function"?this.__onconnected=[e,this.__onconnected]:this.__onconnected=e}__addOndisconnected(e){e=e.bind(this),Array.isArray(this.__ondisconnected)?this.__ondisconnected.push(e):typeof this.__ondisconnected=="function"?this.__ondisconnected=[e,this.__ondisconnected]:this.__ondisconnected=e}__callConnected(e=this){if(typeof this.__onconnected=="function")this.__onconnected(this);else if(Array.isArray(this.__onconnected)){let t=s=>{s(this)};this.__onconnected.forEach(t)}}__callDisconnected(e=this){if(typeof this.__ondisconnected=="function")this.__ondisconnected(this);else if(Array.isArray(this.__ondisconnected)){let t=s=>{s(this)};this.__ondisconnected.forEach(t)}}},q=class n{__node={tag:`graph${Math.floor(Math.random()*1e15)}`,unique:`${Math.random()}`,nodes:new Map,state:Et,roots:{}};constructor(e){this.init(e)}init=e=>{if(e){let t=Object.assign({},e);delete t.roots,Oe(this.__node,t),e.roots&&this.load(e.roots)}};load=(e,t=!1)=>{function s(o,a,l=!0,f=!0){if(f){o||(o={});for(let c in a)!c.startsWith("__")&&a[c]&&typeof a[c]=="object"?(o[c]=a[c],a[c]?.__children&&s({},a[c].__children,!1,!1)):typeof a[c]=="function"&&(o[c]=a[c]);s(o,a,!0,!1)}else if(a?.__children&&!l)a.__children?.constructor.name==="Object"?o.__children?.constructor.name==="Object"?o.__children=s(o.__children,a.__children,!0,!1):o.__children=s({},a.__children,!0,!1):o.__children=a.__children;else if(l)for(let c in a)!c.startsWith("__")&&a[c]&&typeof a[c]=="object"?(o[c]=Object.assign({},a[c]),a[c]?.__children&&(o[c].__children=s({},a[c].__children,!1,!1))):typeof a[c]=="function"&&(o[c]=a[c]);return o}this.__node.roots=s(this.__node.roots?this.__node.roots:{},e);let i=Object.assign({},e);i.__node&&delete i.__node;let r=this.recursiveSet(i,this,void 0,e,t);if(e.__node){if(!e.__node.tag)e.__node._tag=`roots${Math.floor(Math.random()*1e15)}`;else if(!this.get(e.__node.tag)){let o=new T(e,this,this);this.set(o.__node.tag,o),this.runLoaders(o,this,e,e.__node.tag),o.__listeners&&(r[o.__node.tag]=o.__listeners)}}else e.__listeners&&this.setListeners(e.__listeners);return this.setListeners(r),i};setLoaders=(e,t)=>(t?this.__node.loaders=e:Object.assign(this.__node.loaders,e),this.__node.loaders);runLoaders=(e,t,s,i)=>{for(let r in this.__node.loaders)typeof this.__node.loaders[r]=="object"?(this.__node.loaders[r].init&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i),this.__node.loaders[r].connected&&e.__addOnconnected(this.__node.loaders[r].connect),this.__node.loaders[r].disconnected&&e.__addOndisconnected(this.__node.loaders[r].disconnect)):typeof this.__node.loaders[r]=="function"&&this.__node.loaders[r](e,t,this,this.__node.roots,s,i)};add=(e,t,s=!0)=>{let i={};typeof t=="string"&&(t=this.get(t));let r;if(typeof e=="function"?Ve(e)?e.prototype instanceof T?(e=e.prototype.constructor(e,t,this),r=!0):e=new e:e={__operator:e,__callable:!0}:typeof e=="string"&&(e=this.__node.roots[e]),!e)return;if(!r){let l=Object.getOwnPropertyNames(e),f=Object.getOwnPropertyNames(Object.getPrototypeOf(e));l.push(...f),l=l.filter(h=>!pe.includes(h));let c={};for(let h of l)c[h]=e[h];e=c}if(e.__node||(e.__node={}),e.__node.initial=e,typeof e=="object"&&this.get(e.__node.tag))if(s)this.remove(e.__node.tag,!0);else return;else if(e.__node.tag&&this.get(e.__node.tag))return this.get(e.__node.tag);let o,a=Oe({},e,2);if(r?o=e:o=new T(e,t,this),this.set(o.__node.tag,o),this.runLoaders(o,t,e,o.__node.tag),this.__node.roots[o.__node.tag]=a,o.__children&&(o.__children=Object.assign({},o.__children),this.recursiveSet(o.__children,o,i,o.__children)),o.__listeners){i[o.__node.tag]=Object.assign({},o.__listeners);for(let l in o.__listeners){let f=o.__listeners[l];o[l]&&(delete i[o.__node.tag][l],i[o.__node.tag][o.__node.tag+"."+l]=f),typeof f=="string"&&(o.__children?.[f]?i[o.__node.tag][l]=o.__node.tag+"."+f:t instanceof T&&(t.__node.tag===f||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===f)&&(i[o.__node.tag][l]=t.__node.tag))}}return this.setListeners(i),o.__callConnected(),o};recursiveSet=(e,t,s={},i,r=!1)=>{let o=Object.getOwnPropertyNames(i).filter(l=>!pe.includes(l)),a=Object.getOwnPropertyNames(Object.getPrototypeOf(i)).filter(l=>!pe.includes(l));o.push(...a);for(let l of o){if(l.includes("__"))continue;let f=i[l];if(Array.isArray(f))continue;let c;if(typeof f=="function"?Ve(f)?(f=new f,f instanceof T&&(f=f.prototype.constructor(f,t,this),c=!0)):f={__operator:f,__callable:!0}:typeof f=="string"?this.__node.nodes.get(f)?f=this.__node.nodes.get(f):f=this.__node.roots[f]:typeof f=="boolean"&&(this.__node.nodes.get(l)?f=this.__node.nodes.get(l):f=this.__node.roots[l]),f&&typeof f=="object"){if(!c&&!(f instanceof T)){let g=Object.getOwnPropertyNames(f).filter(v=>!pe.includes(v)),p=Object.getOwnPropertyNames(Object.getPrototypeOf(f)).filter(v=>!pe.includes(v));p.splice(p.indexOf("constructor"),1),g.push(...p);let x={};for(let v of g)x[v]=f[v];f=x}if(f.__node||(f.__node={}),f.__node.tag||(f.__node.tag=l),f.__node.initial||(f.__node.initial=e[l]),r&&this.get(f.__node.tag))this.remove(f.__node.tag,!0);else if(this.get(f.__node.tag)&&!(!(t instanceof n)&&t?.__node)||t?.__node&&this.get(t.__node.tag+"."+f.__node.tag))continue;let h,u=!1,d=Oe({},f,2);if(c||f instanceof T?h=f:(h=new T(f,t,this),u=!0),!u&&f instanceof T&&!c&&t instanceof T){let g=this.subscribe(t.__node.tag,h.__node.tag),p=x=>{this.unsubscribe(t.__node.tag,g)};h.__addOndisconnected(p)}else if(h){if(this.set(h.__node.tag,h),this.runLoaders(h,t,e[l],l),e[l]=h,this.__node.roots[h.__node.tag]=d,h.__children&&(h.__children=Object.assign({},h.__children),this.recursiveSet(h.__children,h,s,h.__children)),h.__listeners){s[h.__node.tag]=Object.assign({},h.__listeners);for(let g in h.__listeners){let p=h.__listeners[g],x=g;h[g]&&(delete s[h.__node.tag][g],x=h.__node.tag+"."+g,s[h.__node.tag][x]=p),typeof p=="string"&&(h.__children?.[p]?s[h.__node.tag][x]=h.__node.tag+"."+p:t instanceof T&&(t.__node.tag===p||t.__node.tag.includes(".")&&t.__node.tag.split(".").pop()===p)&&(s[h.__node.tag][x]=t.__node.tag))}}h.__callConnected()}}}return s};remove=(e,t=!0)=>{if(this.unsubscribe(e),typeof e=="string"&&(e=this.get(e)),e instanceof T){this.delete(e.__node.tag),delete this.__node.roots[e.__node.tag],t&&this.clearListeners(e),e.__callDisconnected();let s=i=>{for(let r in i)this.unsubscribe(i[r]),this.delete(i[r].__node.tag),delete this.__node.roots[i[r].__node.tag],this.delete(r),delete this.__node.roots[r],i[r].__node.tag=i[r].__node.tag.substring(i[r].__node.tag.lastIndexOf(".")+1),t&&this.clearListeners(i[r]),i[r].__callDisconnected(),i[r].__children&&s(i[r].__children)};e.__children&&s(e.__children)}return e?.__node.tag&&e?.__parent&&(delete e?.__parent,e.__node.tag=e.__node.tag.substring(e.__node.tag.indexOf(".")+1)),e?.__node.graph&&(e.__node.graph=void 0),e};run=(e,...t)=>{if(typeof e=="string"){let s=this.get(e);if(!s&&e.includes(".")){if(s=this.get(e.substring(0,e.lastIndexOf("."))),typeof s?.[e.substring(e.lastIndexOf(".")+1)]=="function")return s[e.substring(e.lastIndexOf(".")+1)](...t)}else if(s?.__operator)return s.__operator(...t)}if(e?.__operator)return e?.__operator(...t)};setListeners=e=>{for(let t in e){let s=this.get(t);if(typeof e[t]=="object")for(let i in e[t]){let r=this.get(i),o;if(typeof e[t][i]!="object")e[t][i]={__callback:e[t][i]};else if(!e[t][i].__callback)for(let a in e[t][i]){typeof e[t][i][a]!="object"&&(e[t][i][a]={__callback:e[t][i][a]},s.__operator&&(e[t][i][a].__callback===!0||typeof e[t][i][a].__callback>"u")&&(e[t][i][a].__callback=s.__operator));let l=this.get(a);if(l)o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,void 0,e[t][i][a].subInput,t);else{let f=i.substring(0,i.lastIndexOf("."));if(l=this.get(f),l){let c=i.substring(i.lastIndexOf(".")+1);o=this.subscribe(l,e[t][i][a].__callback,e[t][i][a].__args,c,e[t][i][a].subInput,t)}}}if("__callback"in e[t][i])if(s&&((e[t][i].__callback===!0||typeof e[t][i].__callback>"u")&&(e[t][i].__callback=s.__operator),typeof e[t][i].__callback=="function"&&(e[t][i].__callback=e[t][i].__callback.bind(s))),r)o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,void 0,e[t][i].subInput,t);else{let a=i.substring(0,i.lastIndexOf("."));r=this.get(a),r&&(o=this.subscribe(r,e[t][i].__callback,e[t][i].__args,i.substring(i.lastIndexOf(".")+1),e[t][i].subInput,t))}}}};clearListeners=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e?.__listeners)for(let s in e.__listeners){if(t&&s!==t||typeof e.__listeners[s]?.sub!="number")continue;let i=this.get(s);if(i)if(typeof!e.__listeners[s]?.__callback=="number")for(let r in e.__listeners[s])e.__listeners[s][r]?.sub&&(this.unsubscribe(i,e.__listeners[s][r].sub,void 0,e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,void 0,e.__listeners[s].subInput),e.__listeners[s].sub=void 0);else if(i=this.get(s.substring(0,s.lastIndexOf("."))),i)if(typeof e.__listeners[s]=="object"&&!e.__listeners[s]?.__callback)for(let r in e.__listeners[s])typeof e.__listeners[s][r]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s][r].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s][r].subInput),e.__listeners[s][r].sub=void 0);else typeof e.__listeners[s]?.sub=="number"&&(this.unsubscribe(i,e.__listeners[s].sub,s.substring(s.lastIndexOf(".")+1),e.__listeners[s].subInput),e.__listeners[s].sub=void 0)}};get=e=>this.__node.nodes.get(e);getByUnique=e=>Array.from(this.__node.nodes.values()).find(t=>{if(t.__node.unique===e)return!0});set=(e,t)=>this.__node.nodes.set(e,t);delete=e=>this.__node.nodes.delete(e);list=()=>Array.from(this.__node.nodes.keys());getListener=(e,t,s)=>{let i=this.get(e);if(i){let r=i.__node.unique;return t&&(r+="."+t),this.__node.state.getEvent(r,s)}};getProps=(e,t)=>{if(typeof e=="string"&&(e=this.get(e)),e instanceof T){let s;if(t)s=Object.assign({},this.__node.roots[e.__node.tag]);else{s=Object.assign({},e);for(let i in s)i.includes("__")&&delete s[i]}}};subscribe=(e,t,s,i,r,o,a)=>{let l=e;typeof e=="string"&&(l=this.get(e),!l&&e.includes(".")&&(l=this.get(e.substring(0,e.lastIndexOf("."))),i=e.substring(e.lastIndexOf(".")+1))),o instanceof T&&(o=o.__node.tag);let f;if(typeof t=="string"){f=t;let h=u=>{if(this.get(u)?.__operator){let d=this.get(u);o=u,u=function(...g){return d.__operator(...g)}}else if(u.includes(".")){o=u.substring(0,u.lastIndexOf("."));let d=this.get(o),g=u.substring(u.lastIndexOf(".")+1);a=g,typeof d[g]=="function"?d[g]instanceof T?u=d[g]:u=function(...p){return d[g](...p)}:u=function(p){return d[g]=p,d[g]}}return u};if(o){let u=this.get(o);typeof u?.[t]=="function"?(a=t,t=function(...d){return u[i](...d)}):u?.[i]?(a=i,u[i]instanceof T?t=u[i]:t=function(d){return u[i]=d,u[i]}):t=h(t)}else t=h(t)}let c;if(l instanceof T){let h=()=>{c=l.__subscribe(t,i,r,o,a,s,f);let u=()=>{c!==void 0&&l.__unsubscribe(c,i,r),c=void 0};l.__addOndisconnected(()=>{u(),l.__addOnconnected(()=>{c===void 0&&l.__node.graph.__node.tag===this.__node.tag&&h()})}),typeof t=="string"&&this.get(t)&&(t=this.get(t)),t instanceof T&&t.__addOndisconnected(()=>{u()})};h()}else if(typeof e=="string"){let h=this.get(e);if(h){if(t instanceof T&&t.__operator){let u=()=>{c=h.__subscribe(t.__operator,i,r,o,a,s,f);let d=()=>{c!==void 0&&h.__unsubscribe(c,i,r)};h.__addOndisconnected(()=>{d(),h.__addOnconnected(()=>{c===void 0&&h.__node.graph.__node.tag===this.__node.tag&&u()})}),t.__addOndisconnected(d)};u()}else if(typeof t=="function"||typeof t=="string"){let u=()=>{c=h.__subscribe(t,i,r,o,a,s,f);let d=()=>{c!==void 0&&h.__unsubscribe(c,i,r),c=void 0};h.__addOndisconnected(()=>{d(),h.__addOnconnected(()=>{c===void 0&&h.__node.graph.__node.tag===this.__node.tag&&u()})}),typeof t=="string"&&this.get(t)&&this.get(t).__addOndisconnected(d)};u()}}else typeof t=="string"&&(t=this.__node.nodes.get(t).__operator),typeof t=="function"&&!t?.__node&&(c=this.__node.state.subscribeEvent(e,t))}return c};unsubscribe=(e,t,s,i)=>e instanceof T?e.__unsubscribe(t,s,i):this.get(e)?.__unsubscribe(t,s,i);setState=e=>{this.__node.state.setState(e)}};function Oe(n,e,t=1/0,s=0){for(let i in e)e[i]?.constructor.name==="Object"&&s<t?(s++,n[i]?.constructor.name==="Object"?Oe(n[i],e[i],t,s):n[i]=Oe({},e[i],t,s)):n[i]=e[i];return n}function Ct(n){var e=[],t=n;do{var s=Object.getOwnPropertyNames(t);let i=function(r){e.indexOf(r)===-1&&e.push(r)};s.forEach(i)}while(t=Object.getPrototypeOf(t));return e}function vr(n){let e=Ct(n),t={};for(let s of e)t[s]=n[s];return t}function Ve(n){return Us(n)==="class"}function Us(n){return typeof n=="function"?n.prototype?Object.getOwnPropertyDescriptor(n,"prototype")?.writable?"function":"class":n.constructor.name==="AsyncFunction"?"async":"arrow":""}var xe=(n,e)=>{if(e.get(n)?.__operator){let t=e.get(n);return(...s)=>{t.__operator(...s)}}else if(n.includes(".")){let t=n.split("."),s=t.pop(),i=t.join("."),r=e.get(i);return typeof e.get(i)?.[s]=="function"?(...o)=>r[s](...o):()=>r[s]}else if(e.get(n)){let t=e.get(n);return()=>t}else{let t=n;return()=>t}},Ye=(n,e,t)=>{let s=[],i=(o,a)=>{if(o==="__output"||o==="__input"||o==="__callback")s[a]={__callback:l=>l,__args:void 0,idx:a};else if(typeof o=="string")s[a]={__callback:xe(o,t),__args:void 0,idx:a};else if(typeof o=="function"){let l=o;s[a]={__callback:(...f)=>l(...f),__args:void 0,idx:a}}else if(typeof o=="object"&&(o.__input||o.__callback)){let l=function(f){let c=f.__input?f.__input:f.__callback;if(typeof f.__input=="string"&&(c={__callback:xe(f.__input,t),__args:void 0,idx:a}),f.__args){let h=Ye(c,f.__args,t);c={__callback:h.__callback,__args:h.__args,idx:a}}else c={__callback:c,__args:void 0,idx:a};if(f.__output){let h=f.__output;if(typeof f.__output=="string"?h={__callback:xe(h,t),__args:void 0,idx:a}:typeof o.__output=="object"&&(h=l(h)),typeof h?.__callback=="function"){let u=c.__callback,d=h.__callback;c={__callback:(...g)=>d(u(...g)),__args:h.__args,idx:a}}}return c};s[a]=l(o)}else{let l=o;s[a]={__callback:()=>l,__args:void 0,idx:a}}};e.forEach(i),typeof n=="string"&&(n={__callback:xe(n,t),__args:void 0});let r=typeof n=="function"?n:n.__callback;return n=function(...o){let a=f=>f.__callback(...o);return r(...s.map(a))},{__callback:n,__args:s}},pe=Object.getOwnPropertyNames(Object.getPrototypeOf({}));var Is=(n,e,t)=>{n.__node.backward&&e instanceof T&&t.setListeners({[e.__node.tag]:{[n.__node.tag]:e}})},Ms=(n,e,t)=>{if(n.__operator){let s=Math.random();if(n.__node.loops||(n.__node.loops={}),typeof n.__node.delay=="number"){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=setTimeout(async()=>{o(await i(...r))},n.__node.delay)}))}else if(n.__node.frame===!0){let i=n.__operator;n.__setOperator((...r)=>new Promise((o,a)=>{n.__node.loops[s]=requestAnimationFrame(async()=>{o(await i(...r))})}))}if(typeof n.__node.repeat=="number"||typeof n.__node.recursive=="number"){let i=n.__operator;n.__setOperator(async(...r)=>{let o=n.__node.repeat?n.__node.repeat:n.__node.recursive,a,l=async(f,...c)=>{for(;f>0;){if(n.__node.delay||n.__node.frame){i(...c).then(async h=>{n.__node.recursive?await l(f,h):await l(f,...c)});break}else a=await i(...r);f--}};return await l(o,...r),a})}if(n.__node.loop&&typeof n.__node.loop=="number"){let i=n.__operator,r=n.__node.loop;n.__setOperator((...a)=>{if("looping"in n.__node||(n.__node.looping=!0),n.__node.looping){let l=performance.now();i(...a),n.__node.loops[s]=setTimeout(()=>{let c=performance.now()-l-n.__node.loop;c>0?r=n.__node.loop-c:r=n.__node.loop,r<=0&&(r=n.__node.loop),n.__operator(...a)},r)}}),n.__node.looping&&n.__operator();let o=a=>{a.__node.looping&&(a.__node.looping=!1),a.__node.loops[s]&&(clearTimeout(a.__node.loops[s]),cancelAnimationFrame(a.__node.loops[s]))};n.__addOndisconnected(o)}}},Rs=(n,e,t)=>{if(n.__node.animate===!0||n.__animation){let s=n.__operator;n.__setOperator((...r)=>{"animating"in n.__node||(n.__node.animating=!0),n.__node.animating&&(typeof n.__animation=="function"?n.__animation(...r):s(...r),n.__node.animationFrame=requestAnimationFrame(()=>{n.__operator(...r)}))}),(n.__node.animating||(!("animating"in n.__node)||n.__node.animating)&&n.__animation)&&setTimeout(()=>{n.__node.animationFrame=requestAnimationFrame(n.__operator)},10);let i=r=>{r.__node.animating&&(r.__node.animating=!1),r.__node.animationFrame&&cancelAnimationFrame(r.__node.animationFrame)};n.__addOndisconnected(i)}},Fs=(n,e,t)=>{if(typeof n.__branch=="object"&&n.__operator&&!n.__branchApplied){let s=n.__operator;n.__branchApplied=!0,n.__operator=(...i)=>{let r=s(...i);for(let o in n.__branch){let a=()=>{typeof n.__branch[o].then=="function"?n.__branch[o].then(r):n.__branch[o].then instanceof T&&n.__branch[o].then.__operator?n.__branch[o].then.__operator(r):r=n.__branch[o].then};typeof n.__branch[o].if=="function"?n.__branch[o].if(r)==!0&&a():n.__branch[o].if===r&&a()}return r}}if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&n.__listeners[s].branch&&!n.__listeners[s].branchApplied){let i=n.__listeners[s].callback;n.__listeners[s].branchApplied=!0,n.__listeners.callback=r=>{let o=()=>{typeof n.__listeners[s].branch.then=="function"?r=n.__listeners[s].branch.then(r):n.__listeners[s].branch.then instanceof T&&n.__listeners[s].branch.then.__operator?r=n.__listeners[s].branch.then.__operator(r):r=n.__listeners[s].branch.then};return typeof n.__listeners[s].branch.if=="function"?n.__listeners[s].branch.if(r)&&o():n.__listeners[s].branch.if===r&&o(),i(r)}}}},zs=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&n.__listeners[s].oncreate&&n.__listeners[s].callback(n.__listeners[s].oncreate)},Ws=(n,e,t)=>{if(n.__listeners)for(let s in n.__listeners)typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].binding=="object"&&(n.__listeners.callback=n.__listeners.callback.bind(n.__listeners[s].binding))},Gs=(n,e,t)=>{if(n.__listeners){for(let s in n.__listeners)if(typeof n.__listeners[s]=="object"&&typeof n.__listeners[s].transform=="function"&&!n.__listeners[s].transformApplied){let i=n.__listeners[s].callback;n.__listeners[s].transformApplied=!0,n.__listeners.callback=r=>(r=n.__listeners[s].transform(r),i(r))}}},Bs=(n,e,t)=>{n.post&&!n.__operator?n.__setOperator(n.post):!n.__operator&&typeof n.get=="function"&&n.__setOperator(n.get),!n.get&&n.__operator,n.aliases&&n.aliases.forEach(s=>{t.set(s,n);let i=r=>{t.__node.nodes.delete(s)};n.__addOndisconnected(i)}),typeof t.__node.roots?.[n.__node.tag]=="object"&&n.get&&(t.__node.roots[n.__node.tag].get=n.get)},_e={backprop:Is,loop:Ms,animate:Rs,branching:Fs,triggerListenerOncreate:zs,bindListener:Ws,transformListenerResult:Gs,substitute__operator:Bs};var qs=n=>{let e={};for(let t in n)typeof n[t]=="object"?e[t]=qs(n[t]):typeof n[t]=="function"?e[t]=n[t].toString():e[t]=n[t];return e};function wr(n){typeof n!="string"&&(n=n.toString());let e=n.match(/\(?[^]*?\)?\s*=>/);if(e)return e[0].replace(/[()\s]/gi,"").replace("=>","").split(",");let t=n.match(/\([^]*?\)/);return t?t[0].replace(/[()\s]/gi,"").split(","):[]}var $s=n=>{let e=n.indexOf("=>")+1;return e<=0&&(e=n.indexOf("){")),e<=0&&(e=n.indexOf(") {")),n.slice(0,n.indexOf("{",e)+1)};function Ke(n=""){let e=r=>r.replace(/^\W*(function[^{]+\{([\s\S]*)\}|[^=]+=>[^{]*\{([\s\S]*)\}|[^=]+=>(.+))/i,"$2$3$4"),t=$s(n),s=e(n),i;if(t.includes("function")){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s)}else if(t.substring(0,6)===s.substring(0,6)){let r=t.substring(t.indexOf("(")+1,t.lastIndexOf(")"));i=new Function(r,s.substring(s.indexOf("{")+1,s.length-1))}else try{i=(0,eval)(n)}catch{}return i}function kr(n="{}"){try{let e=typeof n=="string"?JSON.parse(n):n,t=s=>{for(let i in s)if(typeof s[i]=="string"){let r=Ke(s[i]);typeof r=="function"&&(s[i]=r)}else typeof s[i]=="object"&&t(s[i]);return s};return t(e)}catch(e){console.error(e);return}}var Hs=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(a,t.join("."))}return a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithCircularRefs===void 0&&(JSON.stringifyWithCircularRefs=Hs);var Js=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1,f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l--}}function r(o,a){if(a!=null&&typeof a=="object"){o&&i(o,a);let l=n.get(a);if(l)return"[Circular Reference]"+l;n.set(typeof a=="function"?a.toString():a,t.join("."))}return typeof a=="function"?a.toString():a}return function(a,l){try{return e.push(a),JSON.stringify(a,r,l)}finally{s()}}}();JSON.stringifyWithFunctionsAndCircularRefs===void 0&&(JSON.stringifyWithFunctionsAndCircularRefs=Js);var I=function(){let n=new Map,e=[],t=["this"];function s(){n.clear(),e.length=0,t.length=1}function i(o,a){var l=e.length-1;if(e[l]){var f=e[l];if(typeof f=="object")if(f[o]===a||l===0)t.push(o),e.push(a.pushed);else for(;l-->=0;){if(f=e[l],typeof f=="object"&&f[o]===a){l+=2,e.length=l,t.length=l,--l,e[l]=a,t[l]=o;break}l++}}}function r(o,a){let l;if(a!=null)if(typeof a=="object"){let f=a.constructor.name;o&&f==="Object"&&i(o,a);let c=n.get(a);if(c)return"[Circular Reference]"+c;if(n.set(a,t.join(".")),f==="Array")a.length>20?l=a.slice(a.length-20):l=a;else if(f.includes("Set"))l=Array.from(a);else if(f!=="Object"&&f!=="Number"&&f!=="String"&&f!=="Boolean")l="instanceof_"+f;else if(f==="Object"){let h={};for(let u in a)if(a[u]==null)h[u]=a[u];else if(Array.isArray(a[u]))a[u].length>20?h[u]=a[u].slice(a[u].length-20):h[u]=a[u];else if(a[u].constructor.name==="Object"){h[u]={};for(let d in a[u])if(Array.isArray(a[u][d]))a[u][d].length>20?h[u][d]=a[u][d].slice(a[u][d].length-20):h[u][d]=a[u][d];else if(a[u][d]!=null){let g=a[u][d].constructor.name;g.includes("Set")?h[u][d]=Array.from(a[u][d]):g!=="Number"&&g!=="String"&&g!=="Boolean"?h[u][d]="instanceof_"+g:h[u][d]=a[u][d]}else h[u][d]=a[u][d]}else{let d=a[u].constructor.name;d.includes("Set")?h[u]=Array.from(a[u]):d!=="Number"&&d!=="String"&&d!=="Boolean"?h[u]="instanceof_"+d:h[u]=a[u]}l=h}else l=a}else l=a;return l}return function(a,l){e.push(a);let f=JSON.stringify(a,r,l);return s(),f}}();JSON.stringifyFast===void 0&&(JSON.stringifyFast=I);function xr(n){if(typeof n.__methods=="object")for(let e in n.__methods){let t=n.__methods[e],s=typeof t=="function"?t:Ke(t);e==="__operator"?n.__setOperator(s):n[e]=s.bind(n)}}var C=class extends q{name=`service${Math.floor(Math.random()*1e15)}`;restrict;constructor(e){super({...e,loaders:e?.loaders?Object.assign({..._e},e.loaders):{..._e}}),e?.services&&this.addServices(e.services),e?.restrict&&(this.restrict=e.restrict),this.load(this)}addServices=e=>{for(let t in e)if(typeof e[t]=="function"&&(e[t]=new e[t]),e[t]?.__node?.loaders&&Object.assign(this.__node.loaders,e[t].__node.loaders),e[t]?.__node?.nodes){e[t].__node.nodes.forEach((r,o)=>{this.get(o)?this.set(t+"."+o,r):this.set(o,r)}),this.__node.nodes.forEach((r,o)=>{e[t].__node.nodes.get(o)||e[t].__node.nodes.set(o,r)});let s=this.set;this.set=(r,o)=>(e[t].set(r,o),s(r,o));let i=this.delete;this.delete=r=>(e[t].delete(r),i(r))}else typeof e[t]=="object"&&this.load(e[t])};handleMethod=(e,t,s)=>{let i=t.toLowerCase(),r=this.__node.nodes.get(e);if(r||(r=this.__node.roots[e]),r?.[i])if(typeof r[i]!="function"){if(s){Array.isArray(s)&&s.length===1?r[i]=s[0]:r[i]=s;return}return r[i]}else return Array.isArray(s)?r[i](...s):r[i](s);else return this.handleServiceMessage({route:e,args:s,method:t})};handleServiceMessage(e){let t;return typeof e=="object"&&(e.route?t=e.route:e.node&&(t=e.node)),t?Array.isArray(e.args)?this.run(t,...e.args):this.run(t,e.args):e}handleGraphNodeCall(e,t){if(!e)return t;if(t?.args)this.handleServiceMessage(t);else return Array.isArray(t)?this.run(e,...t):this.run(e,t)}transmit=(...e)=>{if(typeof e[0]=="object"){let t=e[0];if(t.method)return this.handleMethod(t.route,t.method,t.args);if(t.route)return this.handleServiceMessage(t);if(t.node)return this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}else return};receive=(...e)=>{if(e[0]){let t=e[0];if(typeof t=="string"){let s=t.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}if(typeof t=="object"){if(t.method)return this.restrict?.[t.route]?void 0:this.handleMethod(t.route,t.method,t.args);if(t.route)return this.restrict?.[t.route]?void 0:this.handleServiceMessage(t);if(t.node)return typeof t.node=="string"&&this.restrict?.[t.node]?void 0:this.handleGraphNodeCall(t.node,t.args);this.__node.keepState&&(t.route&&this.setState({[t.route]:t.args}),t.node&&this.setState({[t.node]:t.args}));return}}};pipe=(e,t,s,i,r)=>{if(e instanceof T)return r?this.subscribe(e,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.subscribe(e,o=>{this.transmit({route:t,args:o,method:i},s)})};pipeOnce=(e,t,s,i,r)=>{if(e instanceof T)return r?e.__node.state.subscribeEventOnce(e.__node.unique,o=>{let a=r(o);a!==void 0?this.transmit({route:t,args:a,method:i}):this.transmit({route:t,args:o,method:i},s)}):this.__node.state.subscribeEventOnce(e.__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)});if(typeof e=="string")return this.__node.state.subscribeEventOnce(this.__node.nodes.get(e).__node.unique,o=>{this.transmit({route:t,args:o,method:i},s)})};terminate=(...e)=>{};isTypedArray=Vs;recursivelyAssign=Ze;spliceTypedArray=Ys;ping=()=>(console.log("pinged!"),"pong");echo=(...e)=>(this.transmit(...e),e);log=(...e)=>(console.log(...e),!0);error=(...e)=>(console.error(...e),!0)};function Vs(n){return ArrayBuffer.isView(n)&&Object.prototype.toString.call(n)!=="[object DataView]"}var Ze=(n,e)=>{for(let t in e)e[t]?.constructor.name==="Object"&&!Array.isArray(e[t])?n[t]?.constructor.name==="Object"&&!Array.isArray(n[t])?Ze(n[t],e[t]):n[t]=Ze({},e[t]):n[t]=e[t];return n};function Ys(n,e,t){let s=n.subarray(0,e),i;t&&(i=n.subarray(t+1));let r;return(s.length>0||i?.length>0)&&(r=new n.constructor(s.length+i.length)),r&&(s.length>0&&r.set(s),i&&i.length>0&&r.set(i,s.length)),r}var Nt=class extends C{name="sessions";users={};sessions={oneWay:{},shared:{}};invites={};constructor(e,t){super(e),this.setLoaders(_e),this.load(this),t&&(this.users=t)}getSessionInfo=(e,t)=>{if(e)if(this.sessions.oneWay[e]){let s=this.sessions.oneWay[e];if(s.settings&&(s.settings.source===t||s.settings.listener===t||s.settings.ownerId===t||s.settings.admins?.[t]||s.settings.moderators?.[t])){let i={...s.settings};return delete i.password,{oneWay:{[e]:i}}}}else if(this.sessions.shared[e]){let s={...this.sessions.shared[e]?.settings};return delete s.password,{shared:{[e]:s}}}else{let s={};for(let i in this.sessions.shared)this.sessions.shared[i].settings?.name===e&&(s[i]={...this.sessions.shared[i]?.settings},delete s[i].password);if(Object.keys(s).length>0)return s}else return this.sessions.shared};openOneWaySession=(e={},t,s)=>{if(e._id||(e._id=`oneWay${Math.floor(Math.random()*1e15)}`,this.sessions.oneWay[e._id]&&(delete e._id,this.openOneWaySession(e,t))),e._id&&t&&this.users[t]){if(t&&(e.settings||(e.settings={listener:t,source:t,propnames:{latency:!0},admins:{[t]:!0},ownerId:t}),e.settings.listener||(e.settings.listener=s||t),e.settings.source||(e.settings.source=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e),e.data||(e.data={}),e.onopen&&e.onopen(e),this.sessions.oneWay[e._id])return this.updateSession(e,t);e.settings?.listener&&e.settings.source&&(this.sessions.oneWay[e._id]=e)}return e};openSharedSession=(e,t)=>{if(!e._id&&(e._id=`shared${Math.floor(Math.random()*1e15)}`,this.sessions.shared[e._id]))return delete e._id,this.openSharedSession(e,t);if(e._id&&t&&this.users[t]){if(typeof t=="string"?(e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{[t]:!0},admins:{[t]:!0},ownerId:t}),e.settings.users||(e.settings.users={[t]:!0}),e.settings.admins||(e.settings.admins={[t]:!0}),e.settings.ownerId||(e.settings.ownerId=t),this.users[t].sessions||(this.users[t].sessions={}),this.users[t].sessions[e._id]=e):e.settings||(e.settings={name:"shared",propnames:{latency:!0},users:{}}),e.data||(e.data={oneWay:{},shared:{}}),e.settings.name||(e.name=e.id),e.onopen&&e.onopen(e),this.sessions.shared[e._id])return this.updateSession(e,t);this.sessions.shared[e._id]=e}return e};open=(e,t)=>{e.listener?this.openOneWaySession(e,t):this.openSharedSession(e,t)};updateSession=(e,t)=>{let s;if(e._id)if(s=this.sessions.oneWay[e._id],s||(s=this.sessions.shared[e._id]),s&&t){if(s.settings&&(s?.settings.source===t||s.settings.admins?.[t]||s.settings.moderators?.[t]||s.settings.ownerId===t))return this.recursivelyAssign(s,e)}else return e.settings?.source?this.openOneWaySession(e,t):this.openSharedSession(e,t);return!1};joinSession=(e,t,s,i=!0)=>{if(!t&&!this.users[t])return!1;this.users[t].sessions||(this.users[t].sessions={});let r=this.sessions.shared[e];return r||(r=this.sessions.oneWay[e]),r?.settings?r.settings?.banned&&r.settings.banned[t]||r.settings?.password&&(!s?.settings?.password||s.settings.password!==r.settings.password)||r.settings.maxUsers&&Object.keys(r.settings.users)>r.setting.maxUsers?!1:(r.settings.users[t]=!0,r.settings.newUser=!0,this.users[t].sessions[e]=r,s?this.updateSession(s,t):(i&&this.users[t]?.send&&this.users[t].send({route:"joinSession",args:[e,t,r]}),r)):s?.source||s?.listener?(r=this.openOneWaySession(s,t),i&&this.users[t]?.send&&this.users[t].send({route:"joinSession",args:[e,t,r]}),r):s?(r=this.openSharedSession(s,t),i&&this.users[t]?.send&&this.users[t].send({route:"joinSession",args:[e,t,r]}),r):!1};inviteToSession=(e,t,s,i=!0)=>{i&&this.users[t]?.send?this.users[t]?.send({route:"receiveSessionInvite",args:[e,t,s]}):this.receiveSessionInvite(e,t,s)};receiveSessionInvite=(e,t,s)=>{this.invites[t]||(this.invites[t]={});let i=typeof e=="string"?e:e._id;return this.invites[t][i]={session:e,endpoint:s},i};acceptInvite=(e,t,s=!0)=>{let i=typeof e=="string"?e:e._id,r=this.invites[t]?.[i],o;return r&&(e=r.session,o=r.endpoint,delete this.invites[t]?.[i]),new Promise((a,l)=>{if(i||a(!1),s&&o&&this.users[o]?.send){let f,c=setTimeout(()=>{f||(this.unsubscribe("joinSession",h),l(new Error("Session join timed out")))},1e4),h=this.subscribe("joinSession",u=>{typeof u=="object"&&u?._id===i&&u.setting?.users?.includes(t)&&(this.unsubscribe("joinSession",h),f=!0,c&&clearTimeout(c),a(u))});this.users[o]?.send({route:"joinSession",args:[i,t,void 0,!0]})}else a(this.joinSession(i,t,typeof e=="object"?e:void 0))})};rejectInvite=(e,t,s=!0)=>{let i=typeof e=="string"?e:e._id;if(this.invites[t]?.[i]){let r=this.invites[t][i].endpoint;return delete this.invites[t][i],s&&r&&this.users[r]?.send&&this.users[r].send({route:"rejectInvite",args:[i,t]}),!0}};leaveSession=(e,t,s=!0,i=!0)=>{let r;return typeof e=="string"?(r=e,e=this.sessions.oneWay[r],e||(e=this.sessions.shared[r])):r=e._id,e?(this.sessions.oneWay[r]?(t===e.settings.source||t===e.settings.listener||e.settings.admins?.[t]||e.settings.moderators?.[t])&&(delete this.sessions.oneWay[r],delete this.users[t]?.sessions[r],delete this.users[t]?.sessionSubs?.[r],s&&(e.settings.admins?.[t]&&delete(this.sessions.shared[r].settings?.admins)[t],e.settings.moderators?.[t]&&delete(this.sessions.shared[r].settings?.moderators)[t]),i&&this.users[t]?.send?this.users[t].send({route:"unsubscribeFromSession",args:[e._id,t,s]}):this.unsubsribeFromSession(e,t,s)):this.sessions.shared[r]&&(delete this.sessions.shared.settings.users[t],delete this.users[t]?.sessions[r],delete this.users[t]?.sessionSubs?.[r],s&&(e.settings.admins?.[t]&&delete(this.sessions.shared[r].settings?.admins)[t],e.settings.moderators?.[t]&&delete(this.sessions.shared[r].settings?.moderators)[t],e.data.shared[t]&&delete this.sessions.shared[r].data?.shared[t],e.settings.host===t&&(this.swapHost(e,void 0,!0),delete e.data.shared[t])),i&&this.users[t]?.send?this.users[t].send({route:"unsubscribeFromSession",args:[e._id,t,s]}):this.unsubsribeFromSession(e,t,s)),!0):!1};deleteSession=(e,t,s=!0)=>{if(typeof e=="string"){let i=e;e=this.sessions.oneWay[i],e||(e=this.sessions.shared[i])}if(e&&(e.source===t||e.listener===t||e.admins?.[t]||e.ownerId===t)){for(let i in e.settings.users)if(this.users[i]?.sessions&&delete this.users[i].sessions[e._id],this.users[i]?.sessionSubs&&delete this.users[i].sessionSubs[e._id],s)if(e.users)for(let r in e.users)this.users[r]?.send&&this.users[r].send({route:"unsubscribeFromSession",args:[e._id,r]});else e.listener?this.users[e.listener]?.send&&this.users[e.listener].send({route:"unsubscribeFromSession",args:[e._id,e.listener]}):this.users[t]?.send&&this.users[t].send({route:"unsubscribeFromSession",args:[e._id,t]});else this.unsubsribeFromSession(e,i);this.sessions.oneWay[e._id]?delete this.sessions.oneWay[e._id]:this.sessions.shared[e._id]&&delete this.sessions.oneWay[e._id],e.onclose&&e.onclose(e)}return!0};getFirstMatch(e,t){for(let s in e)if(s in t)return s;return!1}swapHost=(e,t,s=!0,i=!0)=>{if(typeof e=="string"&&(this.sessions.oneWay[e]?e=this.sessions.oneWay[e]:this.sessions.shared[e]&&(e=this.sessions.shared[e])),typeof e=="object"&&e.settings){let r=e.settings.host;if(delete e.settings.host,t&&e.settings.users[t]&&(e.settings.host=t),e.settings.ownerId&&!e.settings.host&&e.settings.users[e.settings.ownerId]&&(e.settings.host=e.settings.ownerId),e.settings.admins&&!e.settings.host){let o=this.getFirstMatch(e.settings.users,e.settings.admins);o&&(e.settings.host=o)}if(e.settings.moderators&&!e.settings.host){let o=this.getFirstMatch(e.settings.users,e.settings.moderators);o&&(e.settings.host=o)}return e.settings.host||(e.settings.host=Object.keys(e.settings.users)[0]),s&&r&&e.settings.inheritHostData!==!1&&e.data?.shared[r]&&e.data?.shared[r]&&(e.data.shared[e.settings.host]=Object.assign(e.data.shared[e.settings.host]?e.data.shared[e.settings.host]:{},e.data.shared[r])),!0}return!1};subscribeToSession=(e,t,s,i,r)=>{if(typeof e=="string"){let a=this.sessions.oneWay[e];if(a||(a=this.sessions.shared[e]),!a)return;e=a}let o=this.users[t];if(o){if(o.sessionSubs||(o.sessionSubs={}),o.sessionSubs[e._id]||(o.sessionSubs[e._id]={}),s&&(o.sessionSubs[e._id].onmessage=s),i&&(this.sessionSubs[t][e._id].onopen=i),r&&(o.sessionSubs[e._id].onclose=r),typeof i=="function"){let a=this.subscribe("joinSession",l=>{l._id===e._id&&this.sessionSubs[t][e._id].onopen(e,o),this.unsubscribe("joinSession",a)});o.sessionSubs[e._id].onopenSub=a}return e}};unsubsribeFromSession=(e,t,s=!0)=>{if(typeof e=="string"){let r=this.sessions.oneWay[e];if(r||(r=this.sessions.shared[e]),!r)return;e=r}let i=(r,o)=>{let a=this.users[r];a&&(a.sessionSubs?.[o._id]&&a.sessionSubs[o._id].onopenSub&&this.unsubscribe("joinSession",a.sessionSubs[o._id].onopenSub),a.sessionSubs[o._id].onclose&&a.sessionSubs[o._id].onclose(o,a),delete a.sessionSubs[o._id])};if(t)i(t,e);else for(let r in this.users)i(r,e);s&&(this.sessions.oneWay[e._id]?delete this.sessions.oneWay[e._id]:this.sessions.shared[e._id]&&delete this.sessions.shared[e._id])};sessionUpdateCheck=(e,t=!0)=>{let s={oneWay:{},shared:{}};for(let i in this.sessions.oneWay){let r=this.sessions.oneWay[i],o={_id:r._id,settings:{listener:r.listener,source:r.source},data:{}};if(!this.users[r.source]){delete this.sessions.oneWay[i];continue}if(r.settings&&r.data)for(let a in r.settings.propnames)a in this.users[r.source]?this.sessions.oneWay[i].data?typeof r.data[a]=="object"?this.users[r.source][a]&&(I(r.data[a])!==I(this.users[r.source][a])||!(a in r.data))&&(o.data[a]=this.users[r.source][a]):a in this.users[r.source]&&(r.data[a]!==this.users[r.source][a]||!(a in r.data))&&(o.data[a]=this.users[r.source][a]):o.data[a]=this.users[r.source][a]:this.sessions.oneWay[i]?.data&&a in this.sessions.oneWay[i]?.data&&delete this.sessions.oneWay[i].data[a];Object.keys(o.data).length>0&&(this.recursivelyAssign(this.sessions.oneWay[i].data,o.data),s.oneWay[r._id]=o,e&&e(r,o),r.settings.onhasupdate&&r.onhasupdate(r,o))}for(let i in this.sessions.shared){let r=this.sessions.shared[i],o={_id:r._id,settings:{name:r.name},data:{}};if(r.settings?.host){let a={},l={};for(let f in r.settings.users){if(this.users[f])r.settings.newUser&&(o.settings.users=r.settings.users,o.settings.host=r.settings.host,r.settings.newUser=!1);else{delete r.settings.users[f],r.settings.host===f&&this.swapHost(r,void 0,!0),r.data?.shared[f]&&delete r.data.shared[f],r.data?.oneWay?.[f]&&delete r.data.shared[f],o.settings.users=r.settings.users,o.settings.host=r.settings.host;continue}if(f!==r.settings.host){a[f]={};for(let c in r.settings.propnames)c in this.users[f]?r.data?.oneWay&&!(f in r.data.oneWay)?typeof this.users[f][c]=="object"?a[f][c]=this.recursivelyAssign({},this.users[f][c]):a[f][c]=this.users[f][c]:typeof a[f][c]=="object"&&r.data?c in this.users[f][c]&&(I(r.data?.shared[f][c])!==I(this.users[f][c])||!(c in r.data))&&(a[f][c]=this.users[f][c]):this.users[f][c]&&r.data?.oneWay?.[c]!==this.users[f][c]&&(a[f][c]=this.users[f][c]):r.data?.oneWay?.[f]&&c in r.data?.oneWay?.[f]&&delete r.data.oneWay[f][c];Object.keys(a[f]).length===0&&delete a[f]}else{l[f]={};for(let c in r.settings.hostprops)c in this.users[f]?r.data&&!(f in r.data.shared)?typeof this.users[f][c]=="object"?l[f][c]=this.recursivelyAssign({},this.users[f][c]):l[f][c]=this.users[f][c]:typeof l[f][c]=="object"&&r.data?(I(r.data?.shared[f][c])!==I(this.users[f][c])||!(c in r.data.shared[f]))&&(l[f][c]=this.users[f][c]):r.data?.shared[f][c]!==this.users[f][c]&&(l[f][c]=this.users[f][c]):r.data?.shared[f]&&c in r.data?.shared[f]&&delete r.data.shared[f][c]}}Object.keys(a).length>0&&(o.data.oneWay=a),Object.keys(l).length>0&&(o.data.shared=l)}else{let a={};if(r.settings?.users){for(let l in r.settings.users){if(!this.users[l]){delete r.settings.users[l],r.settings.host===l&&this.swapHost(r,void 0,!0),r.data?.shared[l]&&delete r.data.shared[l],r.data?.oneWay?.[l]&&delete r.data.shared[l],o.settings.users=r.settings.users,o.settings.host=r.settings.host;continue}a[l]={};for(let f in r.settings.propnames)f in this.users[l]?r.data&&!(l in r.data.shared)?typeof this.users[l][f]=="object"?a[l][f]=this.recursivelyAssign({},this.users[l][f]):a[l][f]=this.users[l][f]:typeof r.data?.shared[l]?.[f]=="object"?(I(r.data.shared[l][f])!==I(this.users[l][f])||!(f in r.data.shared[l]))&&(a[l][f]=this.users[l][f]):r.data?.shared[l]?.[f]!==this.users[l][f]&&(a[l][f]=this.users[l][f]):r.data?.shared[l]&&f in r.data?.shared[l]&&delete r.data.shared[l][f];Object.keys(a[l]).length===0&&delete a[l]}Object.keys(a).length>0&&(o.data.shared=a)}}(o.data.shared||o.data.oneWay)&&(s.shared[r._id]=o,o.data.shared&&Object.assign(this.sessions.shared[i].data?.shared,o.data.shared),o.data.oneWay&&Object.assign(this.sessions.shared[i].data?.oneWay,o.data.oneWay),e&&e(r,o),r.settings.onhasupdate&&r.settings.onhasupdate(r,o))}if(Object.keys(s.oneWay).length===0&&delete s.oneWay,Object.keys(s.shared).length===0&&delete s.shared,Object.keys(s).length!==0)return t&&this.transmitSessionUpdates(s),s};transmitSessionUpdates=e=>{let t={};if(e.oneWay)for(let i in e.oneWay){let r=this.sessions.oneWay[i];if(r?.settings){let o=r.settings.listener;t[o]||(t[o]={}),t[o].oneWay[i]=e.oneWay[i]}}if(e.shared)for(let i in e.shared){let r=this.sessions.shared[i];if(r?.settings)for(let o in r.settings.users)t[o]||(t[o]={}),t[o].shared[i]=e.shared[i]}let s={route:"receiveSessionUpdates",args:null};for(let i in t)s.args=[i,t[i]],this.users[i]?.send&&this.users[i].send(JSON.stringify(s)),this.setState({[i]:Object.create(s)});return t};receiveSessionUpdates=(e,t)=>{if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object"){let s=this.users[e];if(s&&(s.sessions||(s.sessions={oneWay:{},shared:{}}),s.sessionSubs||(s.sessionSubs={})),t.oneWay)for(let i in t.oneWay)this.recursivelyAssign(this.sessions.oneWay[i].data,t.oneWay[i].data),this.sessions.oneWay[i]?.settings.onmessage&&this.sessions.oneWay[i].settings.onmessage(this.sessions.oneWay[i],t.oneWay[i]),s?.sessionSubs[s._id]?.[i]?.onmessage&&s.sessionSubs[s._id][i].onmessage(s.sessions[i],t,s);if(t.shared)for(let i in t.shared)t.shared[i].settings.users&&(this.sessions.shared[i].settings.users=t.shared[i].settings.users),t.shared[i].settings.host&&(this.sessions.shared[i].settings.host=t.shared[i].settings.host),t.shared[i].data.oneWay&&this.recursivelyAssign(this.sessions.shared[i].data.oneWay,t.shared[i].data.oneWay),t.shared[i].data.shared&&this.recursivelyAssign(this.sessions.shared[i].data.shared,t.shared[i].data.shared),this.sessions.shared[i]?.settings.onmessage&&this.sessions.shared[i].settings.onmessage(this.sessions.shared[i],t.shared[i]),s?.sessionSubs[s._id]?.[i]?.onmessage&&s.sessionSubs[s._id][i].onmessage(s.sessions[i],t,s);return s}};getUpdatedUserData=e=>{let t={};for(let s in e.sessions){let i=e.sessions[s];if((i.settings.users[e._id]||i.settings.source===e._id)&&!i.settings.spectators?.[e._id])if(i.settings.host===e._id)for(let r in i.settings.hostprops)!t[r]&&r in e&&(i.data.shared?.[e._id]&&r in i.data.shared?.[e._id]?typeof e[r]=="object"?I(i.data.shared[e._id][r])!==I(e[r])&&(t[r]=e[r]):i.data.shared[e._id][r]!==e[r]&&(t[r]=e[r]):t[r]=e[r]);else for(let r in i.settings.propnames)!t[r]&&e[r]!==void 0&&(i.settings.source?typeof e[r]=="object"&&r in i.data?I(i.data[r])!==I(e[r])&&(t[r]=e[r]):i.data[r]!==e[r]&&(t[r]=e[r]):i.data.shared?.[e._id]&&r in i.data.shared?.[e._id]?typeof e[r]=="object"?I(i.data.shared[e._id][r])!==I(e[r])&&(t[r]=e[r]):i.data.shared[e._id][r]!==e[r]&&(t[r]=e[r]):t[r]=e[r])}return t};userUpdateCheck=(e,t)=>{if(e.sessions){let s=this.getUpdatedUserData(e);if(Object.keys(s).length>0){let i={route:"setUserProps",args:[e._id,s]};return e.send&&e.send(i),this.setState({[e._id]:i}),t&&t(e,s),s}}};setUserProps=(e,t)=>e&&typeof e=="string"&&(e=this.users[e],!e)?!1:(t&&typeof t=="string"&&(t=JSON.parse(t)),this.recursivelyAssign(e,t),!0);userUpdateLoop={__operator:this.userUpdateCheck,__node:{loop:10}};sessionLoop={__operator:this.sessionUpdateCheck,__node:{loop:10}};STREAMLATEST=0;STREAMALLLATEST=1;streamSettings={};streamFunctions={allLatestValues:(e,t)=>{let s;if(Array.isArray(e))e.length!==t.lastRead&&(s=e.slice(t.lastRead),t.lastRead=e.length);else if(typeof e=="object"){s={};for(let i in e)Array.isArray(e[i])?(typeof t=="number"?t={[i]:{lastRead:void 0}}:t[i]||(t[i]={lastRead:void 0}),e[i].length!==t[i].lastRead&&(s[i]=e[i].slice(t[i].lastRead),t[i].lastRead=e[i].length)):(typeof t=="number"?t={[i]:{lastRead:void 0}}:t[i]||(t[i]={lastRead:void 0}),t[i].lastRead!==e[i]&&(s[i]=e[i],t[i].lastRead=e[i]));Object.keys(s).length===0&&(s=void 0)}else t.lastRead!==e&&(s=e,t.lastRead=e);return s},latestValue:(e,t)=>{let s;if(Array.isArray(e))e.length!==t.lastRead&&(s=e[e.length-1],t.lastRead=e.length);else if(typeof e=="object"){s={};for(let i in e)Array.isArray(e[i])?(typeof t=="number"?t={[i]:{lastRead:void 0}}:t[i]||(t[i]={lastRead:void 0}),e[i].length!==t[i].lastRead&&(s[i]=e[i][e[i].length-1],t[i].lastRead=e[i].length)):(typeof t=="number"?t={[i]:{lastRead:void 0}}:t[i]||(t[i]={lastRead:void 0}),t[i].lastRead!==e[i]&&(s[i]=e[i],t[i].lastRead=e[i]))}else t.lastRead!==e&&(s=e,t.lastRead=e);return s}};setStreamFunc=(e,t,s=this.streamFunctions.allLatestValues)=>(this.streamSettings[e].settings[t]||(this.streamSettings[e].settings[t]={lastRead:0}),s===this.STREAMLATEST?this.streamSettings[e].settings[t].callback=this.streamFunctions.latestValue:s===this.STREAMALLLATEST?this.streamSettings[e].settings[t].callback=this.streamFunctions.allLatestValues:typeof s=="string"?this.streamSettings[e].settings[t].callback=this.streamFunctions[s]:typeof s=="function"&&(this.streamSettings[e].settings[t].callback=s),this.streamSettings[e].settings[t].callback||(this.streamSettings[e].settings[t].callback=this.streamFunctions.allLatestValues),!0);addStreamFunc=(e,t=s=>{})=>{this.streamFunctions[e]=t};setStream=(e={},t={},s=`stream${Math.floor(Math.random()*1e10)}`,i,r)=>{if(t.keys){if(t.keys.length===0){let o=Object.keys(e);o.length>0&&(t.keys=Array.from(o))}}else t.keys=Array.from(Object.keys(e));return this.streamSettings[s]={object:e,settings:t,onupdate:i,onclose:r},this.subscribe(s,o=>{this.streamSettings[s].onupdate&&this.streamSettings[s].onupdate(o,this.streamSettings[s])}),t.keys.forEach(o=>{t[o]?.callback?this.setStreamFunc(s,o,t[o].callback):this.setStreamFunc(s,o,t.callback)}),this.streamSettings[s]};removeStream=(e,t)=>{if(e&&this.streamSettings[e]&&!t)this.streamSettings[e].onclose&&this.streamSettings[e].onclose(this.streamSettings[e]),this.unsubscribe(e),delete this.streamSettings[e];else if(t&&this.streamSettings[e]?.settings?.keys){let s=this.streamSettings[e].settings.keys.indexOf(t);return s>-1&&this.streamSettings[e].settings.keys.splice(s,1),this.streamSettings[e].settings[t]&&delete this.streamSettings[e].settings[t],!0}return!1};updateStreamData=(e,t={})=>this.streamSettings[e]?(Object.assign(this.streamSettings[e].object,t),this.streamSettings[e].object):!1;getStreamUpdate=e=>{if(!this.streamSettings[e])return;let t={};return this.streamSettings[e].settings.keys.forEach(s=>{if(this.streamSettings[e].settings[s]){let i=this.streamSettings[e].settings[s].callback(this.streamSettings[e].object[s],this.streamSettings[e].settings[s]);i!==void 0&&(t[s]=i)}}),this.setState({[e]:t}),t};getAllStreamUpdates=()=>{let e={};for(let t in this.streamSettings){let s=this.getStreamUpdate(t);Object.assign(e,s)}return e};streamLoop={__operator:this.getAllStreamUpdates,__node:{loop:10}}};var y={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(n){this.toString=function(){return"CORRUPT: "+this.message},this.message=n},invalid:function(n){this.toString=function(){return"INVALID: "+this.message},this.message=n},bug:function(n){this.toString=function(){return"BUG: "+this.message},this.message=n},notReady:function(n){this.toString=function(){return"NOT READY: "+this.message},this.message=n}}};y.cipher.aes=function(n){this.s[0][0][0]||this.O();var e,t,s,i,r=this.s[0][4],o=this.s[1];e=n.length;var a=1;if(e!==4&&e!==6&&e!==8)throw new y.exception.invalid("invalid aes key size");for(this.b=[s=n.slice(0),i=[]],n=e;n<4*e+28;n++)t=s[n-1],(n%e===0||e===8&&n%e===4)&&(t=r[t>>>24]<<24^r[t>>16&255]<<16^r[t>>8&255]<<8^r[t&255],n%e===0&&(t=t<<8^t>>>24^a<<24,a=a<<1^283*(a>>7))),s[n]=s[n-e]^t;for(e=0;n;e++,n--)t=s[e&3?n:n-4],i[e]=4>=n||4>e?t:o[0][r[t>>>24]]^o[1][r[t>>16&255]]^o[2][r[t>>8&255]]^o[3][r[t&255]]};y.cipher.aes.prototype={encrypt:function(n){return Ks(this,n,0)},decrypt:function(n){return Ks(this,n,1)},s:[[[],[],[],[],[]],[[],[],[],[],[]]],O:function(){var n=this.s[0],e=this.s[1],t=n[4],s=e[4],i,r,o,a=[],l=[],f,c,h,u;for(i=0;256>i;i++)l[(a[i]=i<<1^283*(i>>7))^i]=i;for(r=o=0;!t[r];r^=f||1,o=l[o]||1)for(h=o^o<<1^o<<2^o<<3^o<<4,h=h>>8^h&255^99,t[r]=h,s[h]=r,c=a[i=a[f=a[r]]],u=16843009*c^65537*i^257*f^16843008*r,c=257*a[h]^16843008*h,i=0;4>i;i++)n[i][r]=c=c<<24^c>>>8,e[i][h]=u=u<<24^u>>>8;for(i=0;5>i;i++)n[i]=n[i].slice(0),e[i]=e[i].slice(0)}};function Ks(n,e,t){if(e.length!==4)throw new y.exception.invalid("invalid aes block size");var s=n.b[t],i=e[0]^s[0],r=e[t?3:1]^s[1],o=e[2]^s[2];e=e[t?1:3]^s[3];var a,l,f,c=s.length/4-2,h,u=4,d=[0,0,0,0];a=n.s[t],n=a[0];var g=a[1],p=a[2],x=a[3],v=a[4];for(h=0;h<c;h++)a=n[i>>>24]^g[r>>16&255]^p[o>>8&255]^x[e&255]^s[u],l=n[r>>>24]^g[o>>16&255]^p[e>>8&255]^x[i&255]^s[u+1],f=n[o>>>24]^g[e>>16&255]^p[i>>8&255]^x[r&255]^s[u+2],e=n[e>>>24]^g[i>>16&255]^p[r>>8&255]^x[o&255]^s[u+3],u+=4,i=a,r=l,o=f;for(h=0;4>h;h++)d[t?3&-h:h]=v[i>>>24]<<24^v[r>>16&255]<<16^v[o>>8&255]<<8^v[e&255]^s[u++],a=i,i=r,r=o,o=e,e=a;return d}y.bitArray={bitSlice:function(n,e,t){return n=y.bitArray.$(n.slice(e/32),32-(e&31)).slice(1),t===void 0?n:y.bitArray.clamp(n,t-e)},extract:function(n,e,t){var s=Math.floor(-e-t&31);return((e+t-1^e)&-32?n[e/32|0]<<32-s^n[e/32+1|0]>>>s:n[e/32|0]>>>s)&(1<<t)-1},concat:function(n,e){if(n.length===0||e.length===0)return n.concat(e);var t=n[n.length-1],s=y.bitArray.getPartial(t);return s===32?n.concat(e):y.bitArray.$(e,s,t|0,n.slice(0,n.length-1))},bitLength:function(n){var e=n.length;return e===0?0:32*(e-1)+y.bitArray.getPartial(n[e-1])},clamp:function(n,e){if(32*n.length<e)return n;n=n.slice(0,Math.ceil(e/32));var t=n.length;return e=e&31,0<t&&e&&(n[t-1]=y.bitArray.partial(e,n[t-1]&2147483648>>e-1,1)),n},partial:function(n,e,t){return n===32?e:(t?e|0:e<<32-n)+1099511627776*n},getPartial:function(n){return Math.round(n/1099511627776)||32},equal:function(n,e){if(y.bitArray.bitLength(n)!==y.bitArray.bitLength(e))return!1;var t=0,s;for(s=0;s<n.length;s++)t|=n[s]^e[s];return t===0},$:function(n,e,t,s){var i;for(i=0,s===void 0&&(s=[]);32<=e;e-=32)s.push(t),t=0;if(e===0)return s.concat(n);for(i=0;i<n.length;i++)s.push(t|n[i]>>>e),t=n[i]<<32-e;return i=n.length?n[n.length-1]:0,n=y.bitArray.getPartial(i),s.push(y.bitArray.partial(e+n&31,32<e+n?t:s.pop(),1)),s},i:function(n,e){return[n[0]^e[0],n[1]^e[1],n[2]^e[2],n[3]^e[3]]},byteswapM:function(n){var e,t;for(e=0;e<n.length;++e)t=n[e],n[e]=t>>>24|t>>>8&65280|(t&65280)<<8|t<<24;return n}};y.codec.utf8String={fromBits:function(n){var e="",t=y.bitArray.bitLength(n),s,i;for(s=0;s<t/8;s++)!(s&3)&&(i=n[s/4]),e+=String.fromCharCode(i>>>8>>>8>>>8),i<<=8;return decodeURIComponent(escape(e))},toBits:function(n){n=unescape(encodeURIComponent(n));var e=[],t,s=0;for(t=0;t<n.length;t++)s=s<<8|n.charCodeAt(t),(t&3)===3&&(e.push(s),s=0);return t&3&&e.push(y.bitArray.partial(8*(t&3),s)),e}};y.codec.hex={fromBits:function(n){var e="",t;for(t=0;t<n.length;t++)e+=((n[t]|0)+0xf00000000000).toString(16).substr(4);return e.substr(0,y.bitArray.bitLength(n)/4)},toBits:function(n){var e,t=[],s;for(n=n.replace(/\s|0x/g,""),s=n.length,n=n+"00000000",e=0;e<n.length;e+=8)t.push(parseInt(n.substr(e,8),16)^0);return y.bitArray.clamp(t,4*s)}};y.codec.base32={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",X:"0123456789ABCDEFGHIJKLMNOPQRSTUV",BITS:32,BASE:5,REMAINING:27,fromBits:function(n,e,t){var s=y.codec.base32.BASE,i=y.codec.base32.REMAINING,r="",o=0,a=y.codec.base32.B,l=0,f=y.bitArray.bitLength(n);for(t&&(a=y.codec.base32.X),t=0;r.length*s<f;)r+=a.charAt((l^n[t]>>>o)>>>i),o<s?(l=n[t]<<s-o,o+=i,t++):(l<<=s,o-=s);for(;r.length&7&&!e;)r+="=";return r},toBits:function(n,e){n=n.replace(/\s|=/g,"").toUpperCase();var t=y.codec.base32.BITS,s=y.codec.base32.BASE,i=y.codec.base32.REMAINING,r=[],o,a=0,l=y.codec.base32.B,f=0,c,h="base32";for(e&&(l=y.codec.base32.X,h="base32hex"),o=0;o<n.length;o++){if(c=l.indexOf(n.charAt(o)),0>c){if(!e)try{return y.codec.base32hex.toBits(n)}catch{}throw new y.exception.invalid("this isn't "+h+"!")}a>i?(a-=i,r.push(f^c>>>a),f=c<<t-a):(a+=s,f^=c<<t-a)}return a&56&&r.push(y.bitArray.partial(a&56,f,1)),r}};y.codec.base32hex={fromBits:function(n,e){return y.codec.base32.fromBits(n,e,1)},toBits:function(n){return y.codec.base32.toBits(n,1)}};y.codec.base64={B:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(n,e,t){var s="",i=0,r=y.codec.base64.B,o=0,a=y.bitArray.bitLength(n);for(t&&(r=r.substr(0,62)+"-_"),t=0;6*s.length<a;)s+=r.charAt((o^n[t]>>>i)>>>26),6>i?(o=n[t]<<6-i,i+=26,t++):(o<<=6,i-=6);for(;s.length&3&&!e;)s+="=";return s},toBits:function(n,e){n=n.replace(/\s|=/g,"");var t=[],s,i=0,r=y.codec.base64.B,o=0,a;for(e&&(r=r.substr(0,62)+"-_"),s=0;s<n.length;s++){if(a=r.indexOf(n.charAt(s)),0>a)throw new y.exception.invalid("this isn't base64!");26<i?(i-=26,t.push(o^a>>>i),o=a<<32-i):(i+=6,o^=a<<32-i)}return i&56&&t.push(y.bitArray.partial(i&56,o,1)),t}};y.codec.base64url={fromBits:function(n){return y.codec.base64.fromBits(n,1,1)},toBits:function(n){return y.codec.base64.toBits(n,1)}};y.hash.sha256=function(n){this.b[0]||this.O(),n?(this.F=n.F.slice(0),this.A=n.A.slice(0),this.l=n.l):this.reset()};y.hash.sha256.hash=function(n){return new y.hash.sha256().update(n).finalize()};y.hash.sha256.prototype={blockSize:512,reset:function(){return this.F=this.Y.slice(0),this.A=[],this.l=0,this},update:function(n){typeof n=="string"&&(n=y.codec.utf8String.toBits(n));var e,t=this.A=y.bitArray.concat(this.A,n);if(e=this.l,n=this.l=e+y.bitArray.bitLength(n),9007199254740991<n)throw new y.exception.invalid("Cannot hash more than 2^53 - 1 bits");if(typeof Uint32Array<"u"){var s=new Uint32Array(t),i=0;for(e=512+e-(512+e&511);e<=n;e+=512)jt(this,s.subarray(16*i,16*(i+1))),i+=1;t.splice(0,16*i)}else for(e=512+e-(512+e&511);e<=n;e+=512)jt(this,t.splice(0,16));return this},finalize:function(){var n,t=this.A,e=this.F,t=y.bitArray.concat(t,[y.bitArray.partial(1,1)]);for(n=t.length+2;n&15;n++)t.push(0);for(t.push(Math.floor(this.l/4294967296)),t.push(this.l|0);t.length;)jt(this,t.splice(0,16));return this.reset(),e},Y:[],b:[],O:function(){function n(r){return 4294967296*(r-Math.floor(r))|0}for(var e=0,t=2,s,i;64>e;t++){for(i=!0,s=2;s*s<=t;s++)if(t%s===0){i=!1;break}i&&(8>e&&(this.Y[e]=n(Math.pow(t,.5))),this.b[e]=n(Math.pow(t,1/3)),e++)}}};function jt(n,e){var t,s,i,r=n.F,o=n.b,a=r[0],l=r[1],f=r[2],c=r[3],h=r[4],u=r[5],d=r[6],g=r[7];for(t=0;64>t;t++)16>t?s=e[t]:(s=e[t+1&15],i=e[t+14&15],s=e[t&15]=(s>>>7^s>>>18^s>>>3^s<<25^s<<14)+(i>>>17^i>>>19^i>>>10^i<<15^i<<13)+e[t&15]+e[t+9&15]|0),s=s+g+(h>>>6^h>>>11^h>>>25^h<<26^h<<21^h<<7)+(d^h&(u^d))+o[t],g=d,d=u,u=h,h=c+s|0,c=f,f=l,l=a,a=s+(l&f^c&(l^f))+(l>>>2^l>>>13^l>>>22^l<<30^l<<19^l<<10)|0;r[0]=r[0]+a|0,r[1]=r[1]+l|0,r[2]=r[2]+f|0,r[3]=r[3]+c|0,r[4]=r[4]+h|0,r[5]=r[5]+u|0,r[6]=r[6]+d|0,r[7]=r[7]+g|0}y.mode.ccm={name:"ccm",G:[],listenProgress:function(n){y.mode.ccm.G.push(n)},unListenProgress:function(n){n=y.mode.ccm.G.indexOf(n),-1<n&&y.mode.ccm.G.splice(n,1)},fa:function(n){var e=y.mode.ccm.G.slice(),t;for(t=0;t<e.length;t+=1)e[t](n)},encrypt:function(n,e,t,s,i){var r,o=e.slice(0),a=y.bitArray,l=a.bitLength(t)/8,f=a.bitLength(o)/8;if(i=i||64,s=s||[],7>l)throw new y.exception.invalid("ccm: iv must be at least 7 bytes");for(r=2;4>r&&f>>>8*r;r++);return r<15-l&&(r=15-l),t=a.clamp(t,8*(15-r)),e=y.mode.ccm.V(n,e,t,s,i,r),o=y.mode.ccm.C(n,o,t,e,i,r),a.concat(o.data,o.tag)},decrypt:function(n,e,t,s,i){i=i||64,s=s||[];var r=y.bitArray,o=r.bitLength(t)/8,f=r.bitLength(e),a=r.clamp(e,f-i),l=r.bitSlice(e,f-i),f=(f-i)/8;if(7>o)throw new y.exception.invalid("ccm: iv must be at least 7 bytes");for(e=2;4>e&&f>>>8*e;e++);if(e<15-o&&(e=15-o),t=r.clamp(t,8*(15-e)),a=y.mode.ccm.C(n,a,t,l,i,e),n=y.mode.ccm.V(n,a.data,t,s,i,e),!r.equal(a.tag,n))throw new y.exception.corrupt("ccm: tag doesn't match");return a.data},na:function(n,e,t,s,i,r){var o=[],a=y.bitArray,l=a.i;if(s=[a.partial(8,(e.length?64:0)|s-2<<2|r-1)],s=a.concat(s,t),s[3]|=i,s=n.encrypt(s),e.length)for(t=a.bitLength(e)/8,65279>=t?o=[a.partial(16,t)]:4294967295>=t&&(o=a.concat([a.partial(16,65534)],[t])),o=a.concat(o,e),e=0;e<o.length;e+=4)s=n.encrypt(l(s,o.slice(e,e+4).concat([0,0,0])));return s},V:function(n,e,t,s,i,r){var o=y.bitArray,a=o.i;if(i/=8,i%2||4>i||16<i)throw new y.exception.invalid("ccm: invalid tag length");if(4294967295<s.length||4294967295<e.length)throw new y.exception.bug("ccm: can't deal with 4GiB or more data");for(t=y.mode.ccm.na(n,s,t,i,o.bitLength(e)/8,r),s=0;s<e.length;s+=4)t=n.encrypt(a(t,e.slice(s,s+4).concat([0,0,0])));return o.clamp(t,8*i)},C:function(n,e,t,s,i,r){var o,a=y.bitArray;o=a.i;var l=e.length,f=a.bitLength(e),c=l/50,h=c;if(t=a.concat([a.partial(8,r-1)],t).concat([0,0,0]).slice(0,4),s=a.bitSlice(o(s,n.encrypt(t)),0,i),!l)return{tag:s,data:[]};for(o=0;o<l;o+=4)o>c&&(y.mode.ccm.fa(o/l),c+=h),t[3]++,i=n.encrypt(t),e[o]^=i[0],e[o+1]^=i[1],e[o+2]^=i[2],e[o+3]^=i[3];return{tag:s,data:a.clamp(e,f)}}};y.mode.ocb2={name:"ocb2",encrypt:function(n,e,t,s,i,r){if(y.bitArray.bitLength(t)!==128)throw new y.exception.invalid("ocb iv must be 128 bits");var o,a=y.mode.ocb2.S,l=y.bitArray,f=l.i,c=[0,0,0,0];t=a(n.encrypt(t));var h,u=[];for(s=s||[],i=i||64,o=0;o+4<e.length;o+=4)h=e.slice(o,o+4),c=f(c,h),u=u.concat(f(t,n.encrypt(f(t,h)))),t=a(t);return h=e.slice(o),e=l.bitLength(h),o=n.encrypt(f(t,[0,0,0,e])),h=l.clamp(f(h.concat([0,0,0]),o),e),c=f(c,f(h.concat([0,0,0]),o)),c=n.encrypt(f(c,f(t,a(t)))),s.length&&(c=f(c,r?s:y.mode.ocb2.pmac(n,s))),u.concat(l.concat(h,l.clamp(c,i)))},decrypt:function(n,e,t,s,i,r){if(y.bitArray.bitLength(t)!==128)throw new y.exception.invalid("ocb iv must be 128 bits");i=i||64;var o=y.mode.ocb2.S,a=y.bitArray,l=a.i,f=[0,0,0,0],c=o(n.encrypt(t)),h,u,d=y.bitArray.bitLength(e)-i,g=[];for(s=s||[],t=0;t+4<d/32;t+=4)h=l(c,n.decrypt(l(c,e.slice(t,t+4)))),f=l(f,h),g=g.concat(h),c=o(c);if(u=d-32*t,h=n.encrypt(l(c,[0,0,0,u])),h=l(h,a.clamp(e.slice(t),u).concat([0,0,0])),f=l(f,h),f=n.encrypt(l(f,l(c,o(c)))),s.length&&(f=l(f,r?s:y.mode.ocb2.pmac(n,s))),!a.equal(a.clamp(f,i),a.bitSlice(e,d)))throw new y.exception.corrupt("ocb: tag doesn't match");return g.concat(a.clamp(h,u))},pmac:function(n,e){var t,s=y.mode.ocb2.S,i=y.bitArray,r=i.i,o=[0,0,0,0],a=n.encrypt([0,0,0,0]),a=r(a,s(s(a)));for(t=0;t+4<e.length;t+=4)a=s(a),o=r(o,n.encrypt(r(a,e.slice(t,t+4))));return t=e.slice(t),128>i.bitLength(t)&&(a=r(a,s(a)),t=i.concat(t,[-2147483648,0,0,0])),o=r(o,t),n.encrypt(r(s(r(a,s(a))),o))},S:function(n){return[n[0]<<1^n[1]>>>31,n[1]<<1^n[2]>>>31,n[2]<<1^n[3]>>>31,n[3]<<1^135*(n[0]>>>31)]}};y.mode.gcm={name:"gcm",encrypt:function(n,e,t,s,i){var r=e.slice(0);return e=y.bitArray,s=s||[],n=y.mode.gcm.C(!0,n,r,s,t,i||128),e.concat(n.data,n.tag)},decrypt:function(n,e,t,s,i){var r=e.slice(0),o=y.bitArray,a=o.bitLength(r);if(i=i||128,s=s||[],i<=a?(e=o.bitSlice(r,a-i),r=o.bitSlice(r,0,a-i)):(e=r,r=[]),n=y.mode.gcm.C(!1,n,r,s,t,i),!o.equal(n.tag,e))throw new y.exception.corrupt("gcm: tag doesn't match");return n.data},ka:function(n,e){var t,s,i,r,o,a=y.bitArray.i;for(i=[0,0,0,0],r=e.slice(0),t=0;128>t;t++){for((s=(n[Math.floor(t/32)]&1<<31-t%32)!==0)&&(i=a(i,r)),o=(r[3]&1)!==0,s=3;0<s;s--)r[s]=r[s]>>>1|(r[s-1]&1)<<31;r[0]>>>=1,o&&(r[0]^=-520093696)}return i},j:function(n,e,t){var s,i=t.length;for(e=e.slice(0),s=0;s<i;s+=4)e[0]^=4294967295&t[s],e[1]^=4294967295&t[s+1],e[2]^=4294967295&t[s+2],e[3]^=4294967295&t[s+3],e=y.mode.gcm.ka(e,n);return e},C:function(n,e,t,s,i,r){var o,a,l,f,c,h,u,d,g=y.bitArray;for(h=t.length,u=g.bitLength(t),d=g.bitLength(s),a=g.bitLength(i),o=e.encrypt([0,0,0,0]),a===96?(i=i.slice(0),i=g.concat(i,[1])):(i=y.mode.gcm.j(o,[0,0,0,0],i),i=y.mode.gcm.j(o,i,[0,0,Math.floor(a/4294967296),a&4294967295])),a=y.mode.gcm.j(o,[0,0,0,0],s),c=i.slice(0),s=a.slice(0),n||(s=y.mode.gcm.j(o,a,t)),f=0;f<h;f+=4)c[3]++,l=e.encrypt(c),t[f]^=l[0],t[f+1]^=l[1],t[f+2]^=l[2],t[f+3]^=l[3];return t=g.clamp(t,u),n&&(s=y.mode.gcm.j(o,a,t)),n=[Math.floor(d/4294967296),d&4294967295,Math.floor(u/4294967296),u&4294967295],s=y.mode.gcm.j(o,s,n),l=e.encrypt(i),s[0]^=l[0],s[1]^=l[1],s[2]^=l[2],s[3]^=l[3],{tag:g.bitSlice(s,0,r),data:t}}};y.misc.hmac=function(n,e){this.W=e=e||y.hash.sha256;var t=[[],[]],s,i=e.prototype.blockSize/32;for(this.w=[new e,new e],n.length>i&&(n=e.hash(n)),s=0;s<i;s++)t[0][s]=n[s]^909522486,t[1][s]=n[s]^1549556828;this.w[0].update(t[0]),this.w[1].update(t[1]),this.R=new e(this.w[0])};y.misc.hmac.prototype.encrypt=y.misc.hmac.prototype.mac=function(n){if(this.aa)throw new y.exception.invalid("encrypt on already updated hmac called!");return this.update(n),this.digest(n)};y.misc.hmac.prototype.reset=function(){this.R=new this.W(this.w[0]),this.aa=!1};y.misc.hmac.prototype.update=function(n){this.aa=!0,this.R.update(n)};y.misc.hmac.prototype.digest=function(){var n=this.R.finalize(),n=new this.W(this.w[1]).update(n).finalize();return this.reset(),n};y.misc.pbkdf2=function(n,e,t,s,i){if(t=t||1e4,0>s||0>t)throw new y.exception.invalid("invalid params to pbkdf2");typeof n=="string"&&(n=y.codec.utf8String.toBits(n)),typeof e=="string"&&(e=y.codec.utf8String.toBits(e)),i=i||y.misc.hmac,n=new i(n);var r,o,a,l,f=[],c=y.bitArray;for(l=1;32*f.length<(s||1);l++){for(i=r=n.encrypt(c.concat(e,[l])),o=1;o<t;o++)for(r=n.encrypt(r),a=0;a<r.length;a++)i[a]^=r[a];f=f.concat(i)}return s&&(f=c.clamp(f,s)),f};y.prng=function(n){this.c=[new y.hash.sha256],this.m=[0],this.P=0,this.H={},this.N=0,this.U={},this.Z=this.f=this.o=this.ha=0,this.b=[0,0,0,0,0,0,0,0],this.h=[0,0,0,0],this.L=void 0,this.M=n,this.D=!1,this.K={progress:{},seeded:{}},this.u=this.ga=0,this.I=1,this.J=2,this.ca=65536,this.T=[0,48,64,96,128,192,256,384,512,768,1024],this.da=3e4,this.ba=80};y.prng.prototype={randomWords:function(n,e){var t=[],s;s=this.isReady(e);var i;if(s===this.u)throw new y.exception.notReady("generator isn't seeded");if(s&this.J){s=!(s&this.I),i=[];var r=0,o;for(this.Z=i[0]=new Date().valueOf()+this.da,o=0;16>o;o++)i.push(4294967296*Math.random()|0);for(o=0;o<this.c.length&&(i=i.concat(this.c[o].finalize()),r+=this.m[o],this.m[o]=0,s||!(this.P&1<<o));o++);for(this.P>=1<<this.c.length&&(this.c.push(new y.hash.sha256),this.m.push(0)),this.f-=r,r>this.o&&(this.o=r),this.P++,this.b=y.hash.sha256.hash(this.b.concat(i)),this.L=new y.cipher.aes(this.b),s=0;4>s&&(this.h[s]=this.h[s]+1|0,!this.h[s]);s++);}for(s=0;s<n;s+=4)(s+1)%this.ca===0&&Xs(this),i=Dt(this),t.push(i[0],i[1],i[2],i[3]);return Xs(this),t.slice(0,n)},setDefaultParanoia:function(n,e){if(n===0&&e!=="Setting paranoia=0 will ruin your security; use it only for testing")throw new y.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this.M=n},addEntropy:function(n,e,t){t=t||"user";var s,i,r=new Date().valueOf(),o=this.H[t],a=this.isReady(),l=0;switch(s=this.U[t],s===void 0&&(s=this.U[t]=this.ha++),o===void 0&&(o=this.H[t]=0),this.H[t]=(this.H[t]+1)%this.c.length,typeof n){case"number":e===void 0&&(e=1),this.c[o].update([s,this.N++,1,e,r,1,n|0]);break;case"object":if(t=Object.prototype.toString.call(n),t==="[object Uint32Array]"){for(i=[],t=0;t<n.length;t++)i.push(n[t]);n=i}else for(t!=="[object Array]"&&(l=1),t=0;t<n.length&&!l;t++)typeof n[t]!="number"&&(l=1);if(!l){if(e===void 0)for(t=e=0;t<n.length;t++)for(i=n[t];0<i;)e++,i=i>>>1;this.c[o].update([s,this.N++,2,e,r,n.length].concat(n))}break;case"string":e===void 0&&(e=n.length),this.c[o].update([s,this.N++,3,e,r,n.length]),this.c[o].update(n);break;default:l=1}if(l)throw new y.exception.bug("random: addEntropy only supports number, array of numbers or string");this.m[o]+=e,this.f+=e,a===this.u&&(this.isReady()!==this.u&&Zs("seeded",Math.max(this.o,this.f)),Zs("progress",this.getProgress()))},isReady:function(n){return n=this.T[n!==void 0?n:this.M],this.o&&this.o>=n?this.m[0]>this.ba&&new Date().valueOf()>this.Z?this.J|this.I:this.I:this.f>=n?this.J|this.u:this.u},getProgress:function(n){return n=this.T[n||this.M],this.o>=n||this.f>n?1:this.f/n},startCollectors:function(){if(!this.D){if(this.a={loadTimeCollector:Pe(this,this.ma),mouseCollector:Pe(this,this.oa),keyboardCollector:Pe(this,this.la),accelerometerCollector:Pe(this,this.ea),touchCollector:Pe(this,this.qa)},window.addEventListener)window.addEventListener("load",this.a.loadTimeCollector,!1),window.addEventListener("mousemove",this.a.mouseCollector,!1),window.addEventListener("keypress",this.a.keyboardCollector,!1),window.addEventListener("devicemotion",this.a.accelerometerCollector,!1),window.addEventListener("touchmove",this.a.touchCollector,!1);else if(document.attachEvent)document.attachEvent("onload",this.a.loadTimeCollector),document.attachEvent("onmousemove",this.a.mouseCollector),document.attachEvent("keypress",this.a.keyboardCollector);else throw new y.exception.bug("can't attach event");this.D=!0}},stopCollectors:function(){this.D&&(window.removeEventListener?(window.removeEventListener("load",this.a.loadTimeCollector,!1),window.removeEventListener("mousemove",this.a.mouseCollector,!1),window.removeEventListener("keypress",this.a.keyboardCollector,!1),window.removeEventListener("devicemotion",this.a.accelerometerCollector,!1),window.removeEventListener("touchmove",this.a.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this.a.loadTimeCollector),document.detachEvent("onmousemove",this.a.mouseCollector),document.detachEvent("keypress",this.a.keyboardCollector)),this.D=!1)},addEventListener:function(n,e){this.K[n][this.ga++]=e},removeEventListener:function(n,e){var t,s,i=this.K[n],r=[];for(s in i)i.hasOwnProperty(s)&&i[s]===e&&r.push(s);for(t=0;t<r.length;t++)s=r[t],delete i[s]},la:function(){Ae(this,1)},oa:function(n){var e,t;try{e=n.x||n.clientX||n.offsetX||0,t=n.y||n.clientY||n.offsetY||0}catch{t=e=0}e!=0&&t!=0&&this.addEntropy([e,t],2,"mouse"),Ae(this,0)},qa:function(n){n=n.touches[0]||n.changedTouches[0],this.addEntropy([n.pageX||n.clientX,n.pageY||n.clientY],1,"touch"),Ae(this,0)},ma:function(){Ae(this,2)},ea:function(n){if(n=n.accelerationIncludingGravity.x||n.accelerationIncludingGravity.y||n.accelerationIncludingGravity.z,window.orientation){var e=window.orientation;typeof e=="number"&&this.addEntropy(e,1,"accelerometer")}n&&this.addEntropy(n,2,"accelerometer"),Ae(this,0)}};function Zs(n,e){var t,s=y.random.K[n],i=[];for(t in s)s.hasOwnProperty(t)&&i.push(s[t]);for(t=0;t<i.length;t++)i[t](e)}function Ae(n,e){typeof window<"u"&&window.performance&&typeof window.performance.now=="function"?n.addEntropy(window.performance.now(),e,"loadtime"):n.addEntropy(new Date().valueOf(),e,"loadtime")}function Xs(n){n.b=Dt(n).concat(Dt(n)),n.L=new y.cipher.aes(n.b)}function Dt(n){for(var e=0;4>e&&(n.h[e]=n.h[e]+1|0,!n.h[e]);e++);return n.L.encrypt(n.h)}function Pe(n,e){return function(){e.apply(n,arguments)}}y.random=new y.prng(6);e:try{if(Qe=typeof module<"u"&&module.exports){try{et=require("crypto")}catch{et=null}Qe=Xe=et}if(Qe&&Xe.randomBytes)Te=Xe.randomBytes(128),Te=new Uint32Array(new Uint8Array(Te).buffer),y.random.addEntropy(Te,1024,"crypto['randomBytes']");else if(typeof window<"u"&&typeof Uint32Array<"u"){if(Ee=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(Ee);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(Ee);else break e;y.random.addEntropy(Ee,1024,"crypto['getRandomValues']")}}catch(n){typeof window<"u"&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(n))}var Te,Xe,Ee,Qe,et;y.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},ja:function(n,e,t,s){t=t||{},s=s||{};var i=y.json,r=i.g({iv:y.random.randomWords(4,0)},i.defaults),o;if(i.g(r,t),t=r.adata,typeof r.salt=="string"&&(r.salt=y.codec.base64.toBits(r.salt)),typeof r.iv=="string"&&(r.iv=y.codec.base64.toBits(r.iv)),!y.mode[r.mode]||!y.cipher[r.cipher]||typeof n=="string"&&100>=r.iter||r.ts!==64&&r.ts!==96&&r.ts!==128||r.ks!==128&&r.ks!==192&&r.ks!==256||2>r.iv.length||4<r.iv.length)throw new y.exception.invalid("json encrypt: invalid parameters");return typeof n=="string"?(o=y.misc.cachedPbkdf2(n,r),n=o.key.slice(0,r.ks/32),r.salt=o.salt):y.ecc&&n instanceof y.ecc.elGamal.publicKey&&(o=n.kem(),r.kemtag=o.tag,n=o.key.slice(0,r.ks/32)),typeof e=="string"&&(e=y.codec.utf8String.toBits(e)),typeof t=="string"&&(r.adata=t=y.codec.utf8String.toBits(t)),o=new y.cipher[r.cipher](n),i.g(s,r),s.key=n,r.ct=r.mode==="ccm"&&y.arrayBuffer&&y.arrayBuffer.ccm&&e instanceof ArrayBuffer?y.arrayBuffer.ccm.encrypt(o,e,r.iv,t,r.ts):y.mode[r.mode].encrypt(o,e,r.iv,t,r.ts),r},encrypt:function(n,e,t,s){var i=y.json,r=i.ja.apply(i,arguments);return i.encode(r)},ia:function(n,e,t,s){t=t||{},s=s||{};var i=y.json;e=i.g(i.g(i.g({},i.defaults),e),t,!0);var r,o;if(r=e.adata,typeof e.salt=="string"&&(e.salt=y.codec.base64.toBits(e.salt)),typeof e.iv=="string"&&(e.iv=y.codec.base64.toBits(e.iv)),!y.mode[e.mode]||!y.cipher[e.cipher]||typeof n=="string"&&100>=e.iter||e.ts!==64&&e.ts!==96&&e.ts!==128||e.ks!==128&&e.ks!==192&&e.ks!==256||!e.iv||2>e.iv.length||4<e.iv.length)throw new y.exception.invalid("json decrypt: invalid parameters");return typeof n=="string"?(o=y.misc.cachedPbkdf2(n,e),n=o.key.slice(0,e.ks/32),e.salt=o.salt):y.ecc&&n instanceof y.ecc.elGamal.secretKey&&(n=n.unkem(y.codec.base64.toBits(e.kemtag)).slice(0,e.ks/32)),typeof r=="string"&&(r=y.codec.utf8String.toBits(r)),o=new y.cipher[e.cipher](n),r=e.mode==="ccm"&&y.arrayBuffer&&y.arrayBuffer.ccm&&e.ct instanceof ArrayBuffer?y.arrayBuffer.ccm.decrypt(o,e.ct,e.iv,e.tag,r,e.ts):y.mode[e.mode].decrypt(o,e.ct,e.iv,r,e.ts),i.g(s,e),s.key=n,t.raw===1?r:y.codec.utf8String.fromBits(r)},decrypt:function(n,e,t,s){var i=y.json;return i.ia(n,i.decode(e),t,s)},encode:function(n){var e,t="{",s="";for(e in n)if(n.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new y.exception.invalid("json encode: invalid property name");switch(t+=s+'"'+e+'":',s=",",typeof n[e]){case"number":case"boolean":t+=n[e];break;case"string":t+='"'+escape(n[e])+'"';break;case"object":t+='"'+y.codec.base64.fromBits(n[e],0)+'"';break;default:throw new y.exception.bug("json encode: unsupported type")}}return t+"}"},decode:function(n){if(n=n.replace(/\s/g,""),!n.match(/^\{.*\}$/))throw new y.exception.invalid("json decode: this isn't json!");n=n.replace(/^\{|\}$/g,"").split(/,/);var e={},t,s;for(t=0;t<n.length;t++){if(!(s=n[t].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new y.exception.invalid("json decode: this isn't json!");s[3]!=null?e[s[2]]=parseInt(s[3],10):s[4]!=null?e[s[2]]=s[2].match(/^(ct|adata|salt|iv)$/)?y.codec.base64.toBits(s[4]):unescape(s[4]):s[5]!=null&&(e[s[2]]=s[5]==="true")}return e},g:function(n,e,t){if(n===void 0&&(n={}),e===void 0)return n;for(var s in e)if(e.hasOwnProperty(s)){if(t&&n[s]!==void 0&&n[s]!==e[s])throw new y.exception.invalid("required parameter overridden");n[s]=e[s]}return n},sa:function(n,e){var t={},s;for(s in n)n.hasOwnProperty(s)&&n[s]!==e[s]&&(t[s]=n[s]);return t},ra:function(n,e){var t={},s;for(s=0;s<e.length;s++)n[e[s]]!==void 0&&(t[e[s]]=n[e[s]]);return t}};y.encrypt=y.json.encrypt;y.decrypt=y.json.decrypt;y.misc.pa={};y.misc.cachedPbkdf2=function(n,e){var t=y.misc.pa,s;return e=e||{},s=e.iter||1e3,t=t[n]=t[n]||{},s=t[s]=t[s]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):y.random.randomWords(2,0)},t=e.salt===void 0?s.firstSalt:e.salt,s[t]=s[t]||y.misc.pbkdf2(n,t,e.iter),{key:s[t].slice(0),salt:t.slice(0)}};var W=y;var Lt=class extends C{name="e2ee";keys;securedKeys=!1;encryptedkeys;secret;constructor(e,t,s,i){super(e),t&&(s&&i?(this.securedKeys=!0,this.encryptedkeys=W.encrypt(i,JSON.stringify(t)).cipher,this.secret=i):Object.assign(this.keys,t)),this.load(this)}addKey=(e,t)=>{if(t||(t=`key${Math.floor(Math.random()*1e15)}`),this.securedKeys&&this.secret&&this.encryptedkeys){let s=JSON.parse(W.decrypt(this.secret,this.encryptedkeys));return s[t]={key:e,_id:t},this.encryptedkeys=W.encrypt(this.secret,s).cipher,this.encryptedkeys}else this.keys[t]={key:e,_id:t};return this.keys[t]};static generateSecret(){return W.codec.base64.fromBits(W.random.randomWords(8,10))}encrypt(e,t){return e=W.encrypt(t,e).cipher,e}decrypt(e,t){return e=W.decrypt(t,e),e}encryptRoute=(e,t)=>{typeof e=="object"&&(e=JSON.stringify(e));let s;if(this.securedKeys&&this.secret&&this.encryptedkeys){let i=JSON.parse(W.decrypt(this.secret,this.encryptedkeys));i[t]?.key&&(e=W.encrypt(this.secret,i[t].key).cipher)}else this.keys[t]&&(s||(s=t),e=this.encrypt(e,s));return e={route:"decryptRoute",args:[e,t]},e};decryptRoute=(e,t)=>{let s=e;if(typeof e=="object"){if(t||typeof e.keyId=="string"&&(t=e.keyId),t){let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(W.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=W.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e.args,i))}}else{let i;if(this.securedKeys&&this.secret&&this.encryptedkeys){let r=JSON.parse(W.decrypt(this.secret,this.encryptedkeys));if(r[t]?.key)return s=W.decrypt(this.secret,r[t].key),s}else this.keys[t]&&(i=this.keys[t].key),i&&(s=this.decrypt(e,i))}return s};transmit=(e,t)=>(t||(t=Object.keys(this.keys)[0]),e=this.encryptRoute(e,t),this.handleServiceMessage(e));receive=(e,t)=>{if(t||(t=Object.keys(this.keys)[0]),e=this.decryptRoute(e,t),typeof e=="string"){let s=e.substring(0,8);(s.includes("{")||s.includes("["))&&(s.includes("\\")&&(e=e.replace(/\\/g,"")),e[0]==='"'&&(e=e.substring(1,e.length-1)),e=JSON.parse(e))}if(typeof e=="object"){if(typeof e.method=="string")return this.handleMethod(e.route,e.method,e.args);if(typeof e.route=="string")return this.handleServiceMessage(e);if(typeof e.node=="string"||e.node instanceof T)return this.handleGraphNodeCall(e.node,e.args);this.__node.keepState&&(e.route&&this.setState({[e.route]:e.args}),e.node&&this.setState({[e.node]:e.args}))}else return e}};var Ut=class extends C{name="router";connections={};sources={};services={};serviceConnections={};users={};userTimeout=1e4;order;constructor(e){if(super(e),this.load(this),e&&(e.order&&(this.order=e.order),e.timeout&&(this.userTimeout=e.timeout),e.graph))for(let t in e.graph){let s=e.graph[t];if(typeof s=="function"&&(s=new s),s?.__node?.nodes)s.name=t,s.__node.tag=t,this.addServices({[s.name]:s}),this.routeService(s,s.connections);else if(typeof s?.service=="function"&&(s.service=new s.service),s?.service?.__node?.nodes&&(s.service.name=t,s.service.__node.tag=t,this.addServices({[s.service.name]:s.service}),this.routeService(s.service)),typeof s?.service=="object"&&(s.connections&&(Array.isArray(s.connections)?s.connections.forEach(i=>{this.addServiceConnections(s[t].service,i)}):this.addServiceConnections(s.service,s.connections)),s.config))for(let i in s.config)this.openConnection(s.service,s.config[i],s.config[i].source,s.config[i].args)}}addUser=async(e,t,s,i)=>{let r;if(e._id||(e._id=`user${Math.floor(Math.random()*1e15)}`),this.users[e._id]?r=this.users[e._id]:r=Object.assign({},e),t){for(let o in t)typeof t[o]=="object"&&(t[o].connection._id||await new Promise((a,l)=>{let f=performance.now(),c=()=>{t[o].connection._id?a(!0):performance.now()-f>this.userTimeout?(delete t[o],l(!1)):setTimeout(()=>{c()},100)};c()}).catch(a=>{console.error("Connections timed out:",a)}));for(let o in t)t[o]=this.addConnection(t[o],r._id)}if(s)for(let o in s)this.openConnection(s[o].service,s[o],r._id,s[o].args);if(!this.users[e._id]){let o=(b,...w)=>{let m=this.getConnection(r._id,"send");if(m?.send)return m.send(b,...w)},a=(b,...w)=>{let m=this.getConnections(r._id,"send");for(let _ in m)if(m[_]?.send)return m[_].send(b,...w)},l=(b,w,...m)=>{let _=this.getConnection(r._id,"request");if(_?.request)return _.request(b,w,...m)},f=(b,w,...m)=>{let _=this.getConnections(r._id,"request"),k=[];for(let A in _)_[A]?.request&&k.push(_[A].request(b,w,...m));return Promise.all(k)},c=(b,w,m,..._)=>{let k=this.getConnection(r._id,"post");if(k?.post)return k.post(b,w,m,..._)},h=(b,w,m,..._)=>{let k=this.getConnections(r._id,"post");for(let A in k)k[A]?.post&&k[A].post(b,w,m,..._)},u=(b,w,m,..._)=>{let k=this.getConnection(r._id,"run");if(k?.run)return k.run(b,w,m,..._)},d=(b,w,m,..._)=>{let k=this.getConnections(r._id,"run"),A=[];for(let P in k)k[P]?.run&&A.push(k[P].run(b,w,m,..._));return Promise.all(A)},g=(b,w,...m)=>{let _=this.getConnection(r._id,"subscribe");if(_?.subscribe)return _.subscribe(b,w,...m)},p=(b,w,...m)=>{let _=this.getConnections(r._id,"subscribe"),k=[];for(let A in _)_[A]?.post&&k.push(_[A].subscribe(b,w,...m));return Promise.all(k)},x=(b,w,...m)=>{let _=this.getConnection(r._id,"unsubscribe");if(_?.unsubscribe)return _.unsubscribe(b,w,...m)},v=(b,w,...m)=>{let _=this.getConnections(r._id,"unsubscribe"),k=[];for(let A in _)_[A]?.post&&w?.[A]&&k.push(_[A].unsubscribe(b,w[A],...m));return Promise.all(k)},O=()=>this.removeUser(r);r.send=o,r.request=l,r.post=c,r.run=u,r.subscribe=g,r.unsubscribe=x,r.terminate=O,r.sendAll=a,r.requestAll=f,r.postAll=h,r.runAll=d,r.subscribeAll=p,r.unsubscribeAll=v,r.terminateAll=O,this.users[r._id]=r}if(t&&!i){let o={},a=!1;Object.keys(t).map((l,f)=>{t[l]?._id&&(o[`${f}`]=t[l]?._id,a=!0)}),a&&r.send({route:"addUser",args:[{_id:r._id},o,void 0,!0]})}return r};removeUser(e,t){return t&&this.removeConnection(e,t),typeof e=="string"&&(e=this.users[e]),typeof e=="object"&&e._id&&(delete this.users[e._id],e.onclose&&e.onclose(e)),!0}getConnection=(e,t,s)=>{if(this.connections[e])return this.connections[e];if(this.sources[e]){if(t?.includes("All"))return this.users[e];if(s)if(t){if(this.sources[e][s]?.[t])return this.sources[e][s]}else return this.sources[e][s]?this.sources[e][s]:void 0;else if(this.order)for(let i=0;i<this.order.length;i++){let r=this.order[i];for(let o in this.sources[e])if(this.sources[e][o].service){if(typeof this.sources[e][o].service=="object"){if(this.sources[e][o].service.__node.tag===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name&&!this.serviceConnections[this.sources[e][o].service.name]){this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}else if(this.sources[e][o].service===r){if(this.sources[e][o].connectionType&&this.sources[e][o].service?.name){this.serviceConnections[this.sources[e][o].service.name]||this.removeConnection(this.sources[e][o]);continue}if(t){if(this.sources[e][o][t])return this.sources[e][o]}else return this.sources[e][o]}}}else for(let i in this.sources[e]){if(this.sources[e][i].connectionType&&this.sources[e][i].service?.name&&!this.serviceConnections[this.sources[e][i].service.name]){this.removeConnection(this.sources[e][i]);continue}if(t){if(this.sources[e][i][t])return this.sources[e][i]}else return this.sources[e][i]}}else if(this.order&&!this.connections[e])for(let i=0;i<this.order.length;i++){let r=this.order[i];if(this.sources[r]?.[e]){if(this.sources[r][e].connectionType&&this.sources[r][e].service?.name&&!this.serviceConnections[this.sources[r][e].service.service.name]){this.removeConnection(this.sources[r][e].service);continue}if(t){if(this.sources[r][e][t])return this.sources[r][e]}else return this.sources[r][e]}}};getConnections=(e,t,s)=>{if(this.sources[e]){if(!s&&!t)return this.sources[e];let i={};for(let r in this.sources[e])if(typeof this.sources[e][r]=="object"){if(this.sources[e][r]._id){let o=!0;if(t&&!this.sources[e][r][t]&&(o=!1),s)for(let a in s)if(typeof this.sources[e][r][a]=="object"&&typeof s[a]=="object"){for(let l in s[a])if(s[a][l]!==this.sources[e][r][a][l]){o=!1;break}}else if(this.sources[e][r][a]!==s[a])o=!1;else{o=!1;break}o&&(i[this.sources[e][r]._id]=this.sources[e][r])}else for(let o in this.sources[e][r])if(typeof this.sources[e][r][o]=="object"){let a=!0;if(t&&!this.sources[e][r][o][t]&&(a=!1),s)for(let l in s)if(typeof this.sources[e][r][o][l]=="object"&&typeof s[l]=="object"){for(let f in s[l])if(s[l][f]!==this.sources[e][r][o][l][f]){a=!1;break}}else if(this.sources[e][r][o][l]!==s[l])a=!1;else{a=!1;break}a&&(i[this.sources[e][r][o]._id]=this.sources[e][r][o])}}return i}};runConnection=async(e,t,s,i)=>{let r;if(t.indexOf("All")>-1?r=this.users[e]:r=this.getConnection(e,t,i),r){let o=r[t](...s);return o=await o,o}};subscribeThroughConnection=(e,t,s,i,...r)=>{if(typeof t=="string"&&(t=this.getConnection(t,"run")),typeof t=="object")return new Promise((o,a)=>{t.run("routeConnections",[e,s,t._id,...r]).then(l=>{this.__node.state.subscribeEvent(s,f=>{f?.callbackId===e&&(i?typeof i=="string"?this.setState({[i]:f.args}):i(f.args):this.setState({[s]:f.args}))}),o(l)}).catch(a)})};addConnection=(e,t,s=!0)=>{let i={};if(typeof e=="string"){if(this.connections[e])e=this.connections[e];else for(let r in this.serviceConnections)for(let o in this.serviceConnections[r])if(this.serviceConnections[r][o][e]){e={connection:this.serviceConnections[r][o][e]},e.service=r,i.connectionType=r,i.connectionsKey=o;break}typeof e=="string"&&this.__node.nodes.get(e)&&(e={connection:this.__node.nodes.get(e)})}if(!(!e||typeof e=="string")){if(t&&(i.source=t),e.connection instanceof T){i.connection=e.connection;let r=i.connection;i.send=async o=>o.method?Array.isArray(o.args)?r[o.method]?.(...o.args):r[o.method]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.request=async(o,a)=>a?Array.isArray(o.args)?r[a]?.(...o.args):r[a]?.(o.args):r.__operator?Array.isArray(o.args)?r.__operator(...o.args):r.__operator(o.args):void 0,i.post=async(o,a,l)=>{if(o&&r.__node.graph.get(o)){let f=r.__node.graph.get(o);return l?Array.isArray(a)?f[l]?.(...a):f[l]?.(a):Array.isArray(a)?f.__operator(...a):f.__operator(a)}else return l?Array.isArray(a)?r[l]?.(...a):r[l]?.(a):Array.isArray(a)?r.__operator(...a):r.__operator(a)},i.run=i.post,i.subscribe=async o=>r.__subscribe(o),i.unsubscribe=async o=>r.__unsubscribe(o),i.terminate=()=>(r.__node.graph.remove(r),!0),i.onclose=e.onclose,i.onclose&&r.__addOndisconnected(o=>{i.onclose&&i.onclose(i,o)})}else if(e.connection instanceof q){e.connection.__node.nodes.get("open")&&(i.service=e.connection);let r=i.connection;i.send=async o=>{Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.request=async(o,a)=>{if(o.route)return a?Array.isArray(o.args)?r.__node.nodes.get(o.route)[a]?.(...o.args):r.__node.nodes.get(o.route)[a]?.(o.args):Array.isArray(o.args)?r.run(o.route,...o.args):r.run(o.route,o.args)},i.post=async(o,a,l)=>{if(o&&r.get(o)){let f=r.get(o);return l?Array.isArray(a)?f[l]?.(...a):f[l]?.(a):Array.isArray(a)?f.run(...a):f.run(a)}},i.run=i.post,i.subscribe=async(o,a)=>r.subscribe(o,a),i.unsubscribe=async(o,a)=>r.unsubscribe(o,a),i.terminate=o=>(r.remove(o),!0)}else if(!(e._id&&this.connections[e._id])){let r=e.connection;if(typeof r=="string"){if(this.connections[r])r=this.connections[r];else if(e.service){if(typeof e.service=="string"&&(e.service=this.services[e.service]),typeof e.service=="object"&&e.service.connections){for(let o in e.service.connections)if(e.service.connections[o][r]){r=e.service.connections[o][r],i.connectionType=o,i.connectionsKey=r;break}}}else for(let o in this.serviceConnections)for(let a in this.serviceConnections[o])if(this.serviceConnections[o][a][r]){r=this.serviceConnections[o][a][r],e.service=o,i.connectionType=o,i.connectionsKey=a;break}}if(typeof r!="object")return;if(i._id=r._id,i.connection=e.connection,i.send=r.send,i.request=r.request,i.run=r.run,i.post=r.post,i.subscribe=r.subscribe,i.unsubscribe=r.unsubscribe,i.terminate=r.terminate,i.onclose=e.onclose,i.onclose){if(!(r.onclose&&i.onclose.toString()===r.onclose.toString())){let o=r.onclose;r.onclose=(...a)=>{i.onclose&&i.onclose(i,...a),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}}else{let o=r.onclose;r.onclose=(...a)=>{this.removeConnection(i),s&&i.source&&this.users[i.source]&&Object.keys(this.sources[i.source]).length===0&&this.removeUser(i.source,!1),o&&o(...a)}}e.service?(typeof e.service=="string"&&(e.service=this.services[e.service]),i.service=e.service):r.graph&&(i.service=r.graph)}return!i.source&&e.source?i.source=e.source:!i.source&&e.service?i.source=typeof e.service=="object"?e.service?.name:void 0:!i.source&&(i.connection instanceof T||i.connection instanceof q)&&(i.source="local",this.order.indexOf("local")||this.order.unshift("local")),i._id||(i._id=`connection${Math.floor(Math.random()*1e15)}`),i.source&&(this.sources[i.source]||(this.sources[i.source]={}),this.sources[i.source][i._id]=i),this.connections[i._id]||(this.connections[i._id]=i),i}};removeConnection=(e,t=!1)=>{if(typeof e=="object"&&e._id&&(e=e._id),typeof e=="string"){if(this.connections[e]){t&&this.connections[e]&&this.connections[e].terminate(),delete this.connections[e];for(let s in this.sources)if(this.sources[s][e])delete this.sources[s][e];else for(let i in this.sources[s])this.sources[s][i]?.[e]&&delete this.sources[s][e];return!0}else if(this.sources[e]){for(let s in this.sources[e])this.removeConnection(this.sources[e][s],t);return!0}}};routeService=(e,t,s,i)=>{if(this.services[e.name]=e,e.__node?.nodes&&this.__node.nodes.forEach((r,o)=>{e.__node?.nodes.get(o)?e.__node?.nodes.set(this.name+"."+o,r):e.__node?.nodes.set(o,r)}),e.users&&(e.users=this.users),t)if(typeof t=="string")this.addServiceConnections(e,t,s);else for(let r in t)this.addServiceConnections(e,r,s);i?this.order=i:(this.order||(this.order=[]),this.order.push(e.name))};addServiceConnections=(e,t,s)=>{if(typeof e=="string"&&(e=this.services[e]),t&&e[t]){let i={};this.serviceConnections[e.name]||(this.serviceConnections[e.name]={}),this.serviceConnections[e.name][t]=e[t];for(let r in e[t])this.connections[r]||(i[r]=this.addConnection({connection:e[t][r],service:e},s),i[r].connectionType=t);return i}};openConnection=async(e,t,s,...i)=>{if(typeof e=="string"&&(e=this.services[e]),e?.__node.nodes){let r=e.run("open",t,...i);if(r instanceof Promise)return r.then(async o=>{o._id||await It(o,this.userTimeout),o._id&&this.addConnection({connection:o,service:e},s)});if(r&&(r._id||await It(r,this.userTimeout),r._id))return this.addConnection({connection:r,service:e},s)}};terminate=e=>(typeof e=="string"&&(e=this.connections[e]),e.terminate());routeConnections=(e,t,s,...i)=>{let r;if(typeof s=="string"&&(this.sources[s]&&(r=s),s=this.getConnection(s,"send")),typeof t=="string"&&(t=this.getConnection(t,"subscribe")),t?.subscribe&&s?.send)return new Promise((a,l)=>{t.subscribe(e,f=>{!this.connections[s._id]&&r&&this.sources[r]&&(r=s,Object.keys(this.sources[r]).forEach(c=>{this.sources[s][c].send&&(s=this.sources[s][c])})),this.connections[s._id]&&s.send({callbackId:e,args:f})},...i).then(f=>{a(f)})})};setUserData=(e,t)=>{if(e&&typeof e=="string"&&(e=this.users[e],!e))return!1;if(t&&typeof t=="string"&&(t=JSON.parse(t)),typeof t=="object")return this.recursivelyAssign(e,t),!0}};function It(n,e=1e4){return new Promise((t,s)=>{let i=performance.now(),r=()=>{n._id?t(!0):performance.now()-i>e?s(!1):setTimeout(()=>{r()},100)};r()}).catch(t=>{console.error("Connection timed out:",t)})}var st=V(require("http")),it=V(require("https")),F=V(require("fs")),Y=V(require("path"));function Or(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=t}):e+=n,e+="</body></html>",e}function Ar(n){let e="<!DOCTYPE html><html><head><body>";return Array.isArray(n)?n.forEach(t=>{e+=`<script src="${t}"></script>`}):e+=`<script src="${n}"></script>`,e+="</body></html>",e}var Mt=function(n=4/24){return`//https://github.com/ibrahima92/pwa-with-vanilla-js

//https://github.com/ibrahima92/pwa-with-vanilla-js
let cacheName = 'pwa-assets';
const assets = [
  "/",
  "/index.html",
  "/dist/index.css", //alt default paths
  "/dist/index.js",
  '/favicon.ico'
];

let cacheExpiration = 1000 * 60 * //seconds 
  60 * //minutes
  24 * //hours
  ${n};    //days

let isValid = function (response) {
	if (!response) return false;
	var fetched = response.headers.get('sw-fetched-on');
	if (fetched && (!navigator.onLine || (parseFloat(fetched) + (cacheExpiration)) > new Date().getTime())) 
      return true;
	return false;
};

self.addEventListener("install", installEvent => {
  installEvent.waitUntil(
    caches.open(cacheName).then(cache => {
      cache.addAll(assets);
    })
  );
});

self.addEventListener("fetch", fetchEvent => { //https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/
  fetchEvent.respondWith(
    caches.match(fetchEvent.request).then(function (response) {

        // If there's a cached API and it's still valid, use it
        if (isValid(response)) {
            return response;
        }

        // Otherwise, make a fresh API call
        if(response && !assets.includes(fetchEvent.request.url)) return response;
        // Otherwise, make a fresh API call
        else return fetch(fetchEvent.request).then(function (response) {

            // Cache for offline access
            if(assets.includes(fetchEvent.request.url)){
              var copy = response.clone();
              fetchEvent.waitUntil(caches.open(cacheName).then(function (cache) {
                var headers = new Headers(copy.headers);
                headers.append('sw-fetched-on', new Date().getTime());
                return copy.blob().then(function (body) {
                  return cache.put(fetchEvent.request, new Response(body, {
                    status: copy.status ? copy.status : 200,
                    statusText: copy.statusText,
                    headers: headers
                  }));
                });
              }));
            }
            
            // Return the requested file
            return response;

        })
        // .catch(function (error) {
        // 	return caches.match(request).then(function (response) { //fallback to offline cache
        // 		return response || caches.match('/offline.json'); //todo: figure out what is supposed to go in offline.json (https://gomakethings.com/how-to-set-an-expiration-date-for-items-in-a-service-worker-cache/)
        // 	});
        // });  
  }));
});

`},Rt=(n="PWA")=>`{
    "short_name": "${n}",
    "name": "${n}",
    "start_url": "/",
    "display": "standalone",
    "theme_color": "#000000",
    "background_color": "#ffffff",
    "description": "${n} Test",
    "lang": "en-US",
    "permissions": [
        "storage"
    ],
    "icons":[{
        "src": "./assets/logo196.png",
        "sizes": "196x196"
    },
    {
        "src": "./assets/logo512.png",
        "sizes": "512x512"
    }]
}`;var Ft=class extends C{name="http";server;debug=!1;servers={};mimeTypes={".html":"text/html",".htm":"text/html",".js":"text/javascript",".css":"text/css",".json":"application/json",".txt":"text/plain",".png":"image/png",".jpg":"image/jpg",".jpeg":"image/jpg",".gif":"image/gif",".svg":"image/svg+xml",".xhtml":"application/xhtml+xml",".bmp":"image/bmp",".wav":"audio/wav",".mp3":"audio/mpeg",".mp4":"video/mp4",".xml":"application/xml",".webm":"video/webm",".webp":"image/webp",".weba":"audio/webm",".woff":"font/woff",woff2:"font/woff2",".ttf":"application/font-ttf",".eot":"application/vnd.ms-fontobject",".otf":"application/font-otf",".wasm":"application/wasm",".zip":"application/zip",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".tif":"image/tiff",".sh":"application/x-sh",".csh":"application/x-csh",".rar":"application/vnd.rar",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".odt":"application/vnd.oasis.opendocument.text",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odp":"application/vnd.oasis.opendocument.presentation",".mpeg":"video/mpeg",".mjs":"text/javascript",".cjs":"text/javascript",".jsonld":"application/ld+json",".jar":"application/java-archive",".ico":"image/vnd.microsoft.icon",".gz":"application/gzip",epub:"application/epub+zip",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".csv":"text/csv",".avi":"video/x-msvideo",".aac":"audio/aac",".mpkg":"application/vnd.apple.installer+xml",".oga":"audio/ogg",".ogv":"video/ogg",ogx:"application/ogg",".php":"application/x-httpd-php",".rtf":"application/rtf",".swf":"application/x-shockwave-flash",".7z":"application/x-7z-compressed",".3gp":"video/3gpp"};constructor(e,t){super(e),this.load(this),t&&this.setupServer(t)}onStarted=(e,t,s)=>{console.log(`\u{1F431} Node server running at 
            ${e}://${t}:${s}/`)};setupServer=(e={protocol:"http",host:"localhost",port:8080,startpage:"index.html"},t,s)=>{if(e.pages){for(let i in e.pages)if(typeof e.pages[i]=="string")this.addPage(`${e.port}/${i}`,e.pages[i]);else if(typeof e.pages[i]=="object"||typeof e.pages[i]=="function"){e.pages[i].template&&(e.pages[i].get=e.pages[i].template);let r=`${e.port}/${i}`;i!=="_all"&&this.load({[r]:e.pages[i]})}}this.setupHTTPserver(e,t,s)};open=this.setupServer;setupHTTPserver=(e={host:"localhost",port:8080,startpage:"index.html",errpage:void 0},t,s=()=>{this.onStarted("http",e.host,e.port)})=>{let i=e.host?e.host:"localhost",r=e.port?e.port:8e3;if(!i||!r)return;let o=`${i}:${r}`;this.servers[o]&&this.terminate(this.servers[o]),"keepState"in e||(e.keepState=!0);let a={server:void 0,type:"httpserver",address:o,...e};t||(t=(f,c)=>{let h={args:{request:f,response:c},method:f.method,served:a},u=f.url.slice(1);if(u||(u="/"),e.debug){let d=tt(new Date);console.log(d," | ","From: ",f.socket?.remoteAddress,"For: ",f.url," | ",f.method)}e.pages?Pr.call(this,u,h,e.pages,f,c,e.port):h.route=u,this.receive(h)});let l;if(e.protocol==="http")l=st.createServer(t);else{let f;e.keypath&&e.certpath?(f={key:F.readFileSync(e.keypath),cert:F.readFileSync(e.certpath),passphrase:e.passphrase},l=it.createServer(f,t)):console.error("Error, key and/or cert .pem SSL files not provided. See OpenSSL certbot for more info on how to create free SSL certifications, or create your own self-signed one for local development.")}if(!l){console.error("Server not successfully created.");return}return a.server=l,a.terminate=()=>{this.terminate(a)},a.service=this,this.servers[o]=a,a._id=e._id?e._id:o,new Promise((f,c)=>{let h;l.on("error",u=>{a.onerror?a.onerror(u,a):console.error("Server error:",u.toString()),h||c(u)}),l.on("clientError",(u,d)=>{a.onerror?a.onerror(u,a):console.error(tt(new Date)," | Server clientError:",u.toString()," | From: ",d.remoteAddress),d&&d.destroy()}),l.on("tlsClientError",(u,d)=>{a.onerror?a.onerror(u,a):console.error(tt(new Date)," | Server tlsClientError: ",u.toString()," | From: ",d.remoteAddress),d&&d.destroy()}),l.on("upgrade",(u,d,g)=>{a.onupgrade&&a.onupgrade(u,d,g,a)}),l.listen(r,i,()=>{s(),a.onopen&&a.onopen(a),h=!0,f(a)})})};transmit=(e,t,s,i)=>{let r=e;if(typeof r=="object"&&!r.byteLength&&(r=JSON.stringify(r)),typeof t=="string"&&e)return this.POST(t,e);if(typeof t=="string")return this.GET(t);if(t)t.headers||(t.headers={"Content-Type":"application/json","Content-Length":r.length});else{let o=this.servers[Object.keys(this.servers)[0]];t={protocol:o.protocol,host:o.host,port:o.port,method:"POST",path:e.route,headers:{"Content-Type":"application/json","Content-Length":r.length}}}return this.request(t,r,s,i)};withResult=(e,t,s)=>{if(t&&!e.writableEnded&&!e.destroyed){let i="text/plain",r={};if(typeof t=="string"){let o=Y.extname(t);if(o&&F.existsSync(Y.join(process.cwd(),t))){if(i=this.mimeTypes[o]||"application/octet-stream",t=F.readFileSync(Y.join(process.cwd(),t)),i==="text/html"&&(s.served?.pages?._all||s.served?.pages?.[s.route])){let{templateString:a,headers:l}=this.injectPageCode(t.toString(),s.route,s.served);t=a,Object.assign(r,l)}}else if(typeof t=="string"&&t.includes("<")&&t.includes(">")&&t.indexOf("<")<t.indexOf(">")){if(r["Content-Type"]="text/html",s?.served?.pages?._all||s?.served?.pages?.[s.route]){let{templateString:a,headers:l}=this.injectPageCode(t,s.route,s.served);t=a,Object.assign(r,l)}e.writeHead(200,r),e.end(t,"utf-8");return}}else typeof t=="object"&&(t=JSON.stringify(t),i="application/json");r["Content-Type"]=i,e.writeHead(200,r),e.end(t,"utf-8")}else try{e.destroy()}catch{}};injectPageCode=(e,t,s)=>{s?.pages?.[t]?.inject&&(typeof s.pages[t].inject=="object"?e=this.buildPage(s.pages[t].inject,e):typeof s.pages[t].inject=="function"?e+=s.pages[t].inject():(typeof s.pages[t].inject=="string"||typeof s.pages[t].inject=="number")&&(e+=s.pages[t].inject)),s?.pages?._all?.inject&&(typeof s.pages._all.inject=="object"?e=this.buildPage(s.pages._all.inject,e):typeof s.pages._all.inject=="function"?e+=s.pages._all.inject():(typeof s.pages._all.inject=="string"||typeof s.pages._all.inject=="number")&&(e+=s.pages._all.inject));let i={};return s.pages._all?.headers&&Object.assign(i,s.pages._all.headers),s.pages[t]?.headers&&Object.assign(i,s.pages[t].headers),{templateString:e,headers:i}};receive=e=>(this.debug&&console.log(e.args.request.method,e.args.request.url),new Promise((s,i)=>{this.responsePromiseHandler(s,i,e,e.args.request,e.args.response,e.method,e.served)}).catch(s=>{console.error("Request Error:",s)}));responseOnErrorPromiseHandler=(e,t,s)=>{if(!e.writableEnded||!e.destroyed)e.statusCode=400,e.end(void 0,void 0),t(s);else{try{e.destroy()}catch{}t(s)}};getFailedPromiseHandler=(e,t,s,i,r,o)=>{if((r.writableEnded||r.destroyed)&&t(s),s=="./"||s==o?.startpage){let a="<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Brains@Play Server</h1></body></html>";if(o?.pages?._all||o?.pages?.error){let{templateString:l,headers:f}=this.injectPageCode(a,i.route,o);a=l}r.writeHead(200,{"Content-Type":"text/html"}),r.end(a,"utf-8"),e(a),o?.keepState&&this.setState({[o.address]:a});return}else this.debug&&console.log(`File ${s} does not exist on path!`);r.writeHead(500),r.end(void 0,void 0),t(s)};handleBufferedPostBodyPromiseHandler=(e,t,s,i,r)=>{if(t=Buffer.concat(t).toString(),typeof t=="string"){let c=t.substring(0,8);(c.includes("{")||c.includes("["))&&(c.includes("\\")&&(t=t.replace(/\\/g,"")),t[0]==='"'&&(t=t.substring(1,t.length-1)),t=JSON.parse(t))}let o,a,l;if(t?.route&&(o=t.route,a=t.method,l=t.args,o||(typeof t.route=="string"&&t.route.includes("/")&&t.route.length>1&&(t.route=t.route.split("/").pop()),o=t.route)),!o&&s?.route){let c=s.route;a=s.method,l=s.args,c||(typeof s.route=="string"&&s.route.includes("/")&&s.route.length>1&&(s.route=s.route.split("/").pop()),c=s.route)}let f=t;if(o)if(this.restrict?.[o]){try{i.destroy()}catch{}e(f)}else t.method?f=this.handleMethod(o,a,l):t.node?f=this.handleGraphNodeCall(t.node,t.args):f=this.handleServiceMessage({route:o,args:l,method:a}),f instanceof Promise?f.then(c=>{this.withResult(i,c,s),r?.keepState&&this.setState({[r.address]:f}),e(f)}):(this.withResult(i,f,s),r?.keepState&&this.setState({[r.address]:f}),e(f));else if(!i.writableEnded||!i.destroyed)i.statusCode=200,i.end(void 0,void 0),e(f);else{try{i.destroy()}catch{}e(f)}};onRequestFileReadPromiseHandler=(e,t,s,i,r,o,a,l)=>{if(e)if(e.code=="ENOENT")if(l?.errpage)F.readFile(l.errpage,(h,u)=>{if(o.writeHead(404,{"Content-Type":"text/html"}),l.pages?._all||l.pages?.error){let{templateString:d,headers:g}=this.injectPageCode(u.toString(),a.route,l);u=d}o.end(u,"utf-8"),i(u)});else{o.writeHead(404,{"Content-Type":"text/html"});let h=`<!DOCTYPE html><html><head></head><body style='background-color:#101010 color:white;'><h1>Error: ${e.code}</h1></body></html>`;if(l?.pages?._all||l?.pages?.[a.route]){let{templateString:u,headers:d}=this.injectPageCode(h.toString(),a.route,l);h=u}o.end(h,"utf-8"),i(e.code)}else o.writeHead(500),o.end("Something went wrong: "+e.code+` ..
`,"utf-8"),i(e.code);else{var f=String(Y.extname(r)).toLowerCase(),c=this.mimeTypes[f]||"application/octet-stream";let h={"Content-Type":c};if(c==="text/html"&&(l?.pages?._all||l?.pages?.[a.route])){let{templateString:u,headers:d}=this.injectPageCode(t.toString(),a.route,l);Object.assign(h,d),t=u}o.writeHead(200,h),o.end(t,"utf-8"),s(t)}};responsePromiseHandler=(e,t,s,i,r,o,a)=>{if(r.on("error",f=>{if(a.debug){let c=tt(new Date);console.error(c,"| Response Error: ",f," From: ",i.socket?.remoteAddress," For: ",i.url," | ",i.method)}this.responseOnErrorPromiseHandler(r,t,f),i.destroy(),i.socket?.destroy()}),o==="GET"||o==="get"){var l="."+i.url;if(i.url&&this.restrict?.[i.url]&&t(i.url),l=="./"&&a?.startpage&&(l=a.startpage),l.includes("?")&&(l=l.substring(0,l.indexOf("?"))),(i.url!=="/"||a?.startpage)&&F.existsSync(Y.join(process.cwd(),l)))r.writableEnded||r.destroyed?t(l):F.readFile(Y.join(process.cwd(),l),(f,c)=>{this.onRequestFileReadPromiseHandler(f,c,e,t,l,r,s,a)});else if(s.route){let f;if(a){let c=`${a.port}/${s.route}`;this.__node.nodes.get(c)&&(f=c)}if(!f&&this.__node.nodes.get(s.route)&&(f=s.route),f){let c;s.method?c=this.handleMethod(f,s.method,void 0):s.node?c=this.handleGraphNodeCall(s.node,void 0):c=this.handleServiceMessage({route:f,args:void 0,method:s.method}),c instanceof Promise?c.then(h=>{a?.keepState&&this.setState({[a.address]:c}),this.withResult(r,h,s),e(c)}):c&&(a?.keepState&&this.setState({[a.address]:c}),this.withResult(r,c,s),e(c))}else s.redirect?(r.writeHead(301,{Location:s.redirect}),r.end(),e(!0)):this.getFailedPromiseHandler(e,t,l,s,r,a)}else this.getFailedPromiseHandler(e,t,l,s,r,a)}else{let f,c=!0,h;i.on("data",u=>{f||(f=[]),f.push(u),c&&(c=!1,h&&clearTimeout(h))}).on("end",()=>{this.handleBufferedPostBodyPromiseHandler(e,f,s,r,a)}),h=setTimeout(()=>{if(c){let u=new Error(`Request timed out from | ${i.socket?.remoteAddress} | For: ${i.url} | ${i.method}`);i.destroy(u),a.server.emit("clientError",u,i.socket),a.debug&&console.error(u),t(u)}},a.timeout?a.timeout:1e3)}};request=(e,t,s,i)=>{let r=st;e.protocol?.includes("https")&&(r=it),delete e.protocol;let o=r.request(e,a=>{s&&a.on("data",s),i&&a.on("end",i)});if(e.headers)for(let a in e.headers)o.setHeader(a,e.headers[a]);return t&&o.write(t),o.end(),o};POST=(e,t,s)=>{let i=e;i instanceof URL&&(i=e.toString());let r=i.startsWith("https")?"https":"http",o,a,l,f=i.split("/");return f.forEach(h=>{if(h.includes(":")){let u=h.split(":");o=u[0],a=u[1]}}),f.length>3&&(l=f.slice(3).join("/")),this.request({protocol:r,host:o,port:a,path:l,method:"POST",headers:s},t)};GET=e=>new Promise((t,s)=>{let i=st,r=e;e instanceof URL&&(r=e.toString()),r.includes("https")&&(i=it),i.get(e,o=>{let a=[];o.on("data",l=>{a.push(l)}),o.on("end",()=>{t(Buffer.concat(a))})}).on("error",o=>{s(o)})});terminate=e=>{typeof e=="string"&&(e=this.servers[e]),typeof e=="object"&&(e.server.close(),e.onclose&&e.onclose(e))};getRequestBody(e){let t=[];return new Promise((s,i)=>{e.on("data",r=>{t.push(r)}).on("end",()=>{s(Buffer.concat(t))}).on("error",r=>{let o=new Error(`Request timed out from | ${e.socket?.remoteAddress} | For: ${e.url} | ${e.method}`);e.destroy(o),i(o)})})}addPage=(e,t)=>{typeof t=="string"&&(t.includes("<html")||(t="<!DOCTYPE html><html>"+t+"</html>")),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};addHTML=(e,t)=>{typeof t=="string"&&(!t.includes("<")||!t.includes(">"))&&(t="<div>"+t+"</div>"),typeof this.__node.roots?.[e]=="object"?(this.__node.roots[e].get=t,this.__node.nodes.get(e).get=t):this.load({[e]:{get:t}})};buildPage=(e,t)=>{let s="";t&&(s+=t);let i=(r,o,a)=>{if(!Array.isArray(r[o])&&typeof r[o]=="object")for(let l in r)i(r,l,a);else if(this.__node.nodes.get(o)?.get){let l=this.__node.nodes.get(o)?.get;if(typeof l=="function"&&(Array.isArray(r[o])?l=l(...r[o]):l=l(r[o])),typeof l=="string"){let f=a.lastIndexOf("<");if(f>0){let c=a.substring(f);a=a.substring(0,f)+l+c}else a+=l}}else if(this.__node.nodes.get(o)?.__operator){let l;if(this.__node.nodes.get(o)?.__operator&&(l=this.__node.nodes.get(o).__operator(r[o])),typeof l=="string"){let f=a.lastIndexOf("<");if(f>0){let c=a.substring(f);a=a.substring(0,f)+l+c}else a+=l}}else typeof this.__node.nodes.get(o)=="string"&&(a+=this.__node.nodes.get(o));return a};if(Array.isArray(e))e.forEach(r=>{s=i(e,r,s)});else if(typeof e=="object")for(let r in e)s=i(e,r,s);else typeof e=="string"?s+=e:typeof e=="function"&&(s+=e());return s};hotreload=(e="http://localhost:8080/wss",t)=>{e instanceof URL&&(e=e.toString());let s=(i,r)=>{let o=new WebSocket(i);function a(f){let c=f.includes("/")?f.split("/"):f.split("\\"),h=c[c.length-1];var u=document.getElementsByTagName("link");for(var d in u){var g=u[d];if(!f||g.href?.includes(h)){let p=g.getAttribute("href").split("?")[0],x=p+="";g.setAttribute("href",x)}}}function l(f,c,h){let u=f.includes("/")?f.split("/"):f.split("\\"),d=u[u.length-1],g=document.querySelectorAll("[src]"),p=!1;for(let x of g)if(x.src.includes(d))if(x.tagName==="SCRIPT"&&!c){window.location.reload();return}else{let v=document.createElement("object");x.insertAdjacentElement("afterend",v),x.remove();let O=x.cloneNode(!0);v.insertAdjacentElement("beforebegin",O),v.remove(),p=!0}p||window.location.reload()}o.addEventListener("message",f=>{let c=f.data;if(typeof c=="string"&&c.startsWith("{")&&(c=JSON.parse(c)),c.file){let h=c.file,u=c.reloadscripts;h.endsWith("html")||h.endsWith("xml")||h.endsWith("wasm")?window.location.reload():h.endsWith("css")?(r.endsWith("css")||(r+=".css"),a(r)):h.endsWith("js")||h.endsWith("ts")||h.endsWith("jsx")||h.endsWith("tsx")||h.endsWith("vue")?l(h,u):(a(h),l(h))}}),o.addEventListener("close",()=>{let h=Math.round(30),u=0,d=()=>{if(u++,u>h){console.error("Could not reconnect to dev server.");return}o=new WebSocket(i),o.onerror=g=>{console.error(`Hot reload port disconnected, will reload on reconnected. Attempt ${u} of ${h}`)},o.addEventListener("error",()=>{setTimeout(d,100)}),o.addEventListener("open",()=>{location.reload()})};d()})};return`
            <script>
                console.log('Hot Reload port available at ${e}');  
                (`+s.toString()+`)('${e}',${t?`'${t}'`:void 0}); 
            </script>
        `};pwa=(e="PWA",t=4/24,s="service-worker.js")=>{F.existsSync(s)||F.writeFileSync(Y.join(process.cwd(),s),Mt(t)),F.existsSync("manifest.webmanifest")||F.writeFileSync(Y.join(process.cwd(),"/manifest.webmanifest"),Rt(e));function i(r){Array.from(document.head.querySelectorAll("link")).find(l=>{if(l.href.includes("manifest"))return!0})||document.head.insertAdjacentHTML("beforeend",'<link rel="manifest" href="./manifest.webmanifest">');let o=!!(window.location.hostname==="localhost"||window.location.hostname==="[::1]"||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function a(){navigator.serviceWorker.register(r).then(l=>{l.onupdatefound=()=>{let f=l.installing;f!=null&&(f.onstatechange=()=>{f.state==="installed"&&(navigator.serviceWorker.controller?console.log("New content is available and will be used when all tabs for this page are closed."):console.log("Content is cached for offline use."))})}}).catch(l=>{console.error("Error during service worker registration:",l)})}"serviceWorker"in navigator&&addEventListener("load",()=>{o?(fetch(r).then(l=>{let f=l.headers.get("content-type");l.status===404||f!=null&&f.indexOf("javascript")===-1?navigator.serviceWorker.ready.then(c=>{c.unregister().then(()=>{window.location.reload()})}):a()}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")}),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker.")})):a()})}return`
            <script>
                (`+i.toString()+`)('${s}'); 
            </script>
        `}};function Pr(n,e,t,s,i,r){let o=t[n],a=n;if(o)e.route=n,s.url=n;else{let l="/"+n;if(o=t[l],a=l,!o&&!Y.extname(n))if(a=n.split("/")[0]+"/*",t[a])o=t[a],e.route=a,s.url=a;else{let c=l.split("/");c[c.length-1]="",a=c.join("/")+"*",t[a]&&(o=t[a],e.route=a,s.url=a)}else e.route=l,s.url=l}return typeof o=="object"&&(o.redirect&&(n=o.redirect,e.redirect=n,e.route=n),o.onrequest&&(typeof o.onrequest=="string"&&(o.onrequest=this.__node.nodes.get(o.onrequest)),typeof o.onrequest=="object"?o.onrequest.__operator&&o.onrequest.__operator(o,s,i):typeof o.onrequest=="function"&&o.onrequest(this,this.__node.nodes.get(`${r}/${a}`),s,i))),o}function tt(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var nt=V(Qs()),Wt=class extends C{name="sse";debug=!1;servers={};eventsources={};connections={servers:this.servers,eventsources:this.eventsources};constructor(e){super(e),this.load(this)}openSSE=e=>{let t=e.server,s=e.path;if(this.servers[s])return!1;let i=(0,nt.createChannel)(),r={type:"sse",channel:i,sessions:{},requests:{},...e};this.servers[s]=r,r._id=e._id?e._id:s;let o=(v,O,b)=>this.transmit(v,s,O,b),a=()=>this.terminate(s),l=(v,O,b,w)=>{if(!b){let m=[];for(let _ in r.sessions)m.push(this.request(v,s,_,w));return m}return this.request(v,s,O,b,w)},f=(v,O,b,w,m)=>{let _={route:v,args:O};return b&&(_.method=b),this.transmit(_,s,m,w)},c=(v,O,b,w,m)=>{let _={route:v,args:O};if(!w){let k=[];for(let A in r.sessions)k.push(this.request(_,s,A,m));return k}return this.request(_,s,b,w,m)},h=(v,O,b,w,m,_,k)=>this.subscribeToSSE(v,e.url,O,b,w,m,_,k),u=(v,O,b,w)=>c("unsubscribe",[v,O],void 0,b,w);r.send=o,r.request=l,r.post=f,r.run=c,r.subscribe=h,r.unsubscribe=u,r.terminate=a,r.graph=this;let d=(v,O)=>{if(v.url?.includes(s))if(v.method==="GET")this.debug&&console.log("SSE Request",s),(0,nt.createSession)(v,O).then(b=>{i.register(b);let w=`sse${Math.floor(Math.random()*1e15)}`;r.sessions[w]=b,this.eventsources[w]={_id:w,session:b,served:r,send:(m,_)=>o(m,_,w),request:(m,_,k)=>l(m,_,w,k),post:(m,_,k,A)=>f(m,_,k,w,A),run:(m,_,k,A)=>c(m,_,k,w,A),subscribe:(m,_)=>h(m,_,void 0,w),unsubscribe:(m,_,k)=>u(m,_,w,k),terminate:()=>(delete this.eventsources[w],delete r.sessions[w],!0),onclose:(m,_,k,A,P)=>{_.onconnectionclose&&_.onconnectionclose(m,_,k,A,P)},graph:this},b.push(JSON.stringify({route:"setId",args:w})),b.on("close",()=>{let m=this.eventsources[w],_=m.onclose;delete this.eventsources[w],_&&m.onclose(b,r,w,v,O)}),r.onconnection&&r.onconnection(b,r,w,v,O)});else{let b=[];v.on("data",w=>{b.push(w)}).on("end",()=>{if(b=Buffer.concat(b).toString(),typeof b=="string"){let A=b.substring(0,8);(A.includes("{")||A.includes("["))&&(A.includes("\\")&&(b=b.replace(/\\/g,"")),b[0]==='"'&&(b=b.substring(1,b.length-1)),b=JSON.parse(b))}let w,m,_,k;if((b?.route||b?.callbackId)&&(m=b.method,_=b.args,k=b.callbackId,typeof b.route=="string"&&(b.route.includes("/")&&b.route.length>1&&(b.route=b.route.split("/").pop()),w=this.__node.roots?.[b.route])),w){let A=this.receive({route:w,args:_,method:m})}else k&&r.requests[k]&&r.requests[k](_);this.__node.keepState&&this.setState({[s]:b})})}},g=t.listeners("request");t.removeAllListeners("request");let p=(v,O)=>{g.forEach(b=>{b(v,O)})},x=(v,O)=>{v.url&&(v.url.indexOf(s)>-1?(this.servers[s]||(t.removeListener("request",x),t.addListener("request",p)),d(v,O)):p(v,O))};return t.addListener("request",x),t.addListener("close",()=>{r.onclose&&r.onclose(r)}),r};open=this.openSSE;streamIterable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].iterate(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].iterate(t));return o}};streamReadable=(e,t,s,i="message")=>{let r=this.servers[e];if(r)if(s){if(r.sessions[s])return r.sessions[s].stream(t,{eventName:i})}else{let o=[];for(let a in r.sessions)o.push(r.sessions[a].stream(t));return o}};transmit=(e,t,s,i)=>{if(!t&&(typeof e=="object"&&!e.byteLength||typeof e=="number")){if(e?.route){let r=Object.keys(this.servers);if(r.length>0){let o=this.servers[r[0]];o.channels?.includes(e.route)&&(t=o.path,s=e.route)}!t&&e.route&&this.servers[e.route]&&(t=e.route)}e=JSON.stringify(e)}if(t||(t=Object.keys(this.servers)[0]),t&&this.servers[t]){if(i){if(this.servers[t].sessions[i]?.isConnected)this.servers[t].sessions[i].push(e,s);else if(this.servers[t].sessions[i])return delete this.servers[t].sessions[i],!1}else this.servers[t].channel.broadcast(e,s);return!0}return!1};request=(e,t,s,i,r)=>new Promise((o,a)=>{let l=`${Math.random()}`,f={route:"runRequest",args:[e,t,l,i]};s&&(f.method=s);let c=this.servers[t],h=u=>{o(u)};c.requests[l]=h,c&&(i?c.sessions[i]&&c.sessions[i].push(JSON.stringify(f),r):c.channel.broadcast(JSON.stringify(f),r))});runRequest=(e,t,s,i)=>{let r=this.receive(e);if(t){let o=this.servers[t];o&&(r instanceof Promise?r.then(a=>{i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:a,callbackId:s})):o.channel.broadcast(JSON.stringify({args:a,callbackId:s}))}):i?o.sessions[i]&&o.sessions[i].push(JSON.stringify({args:r,callbackId:s})):o.channel.broadcast(JSON.stringify({args:r,callbackId:s})))}return r};subscribeSSE=(e,t,s,i,r,o,a)=>{if(!this.restrict?.[e]&&this.servers[t])return this.subscribe(e,l=>{this.servers[t].send({args:l,callbackId:e},a,o)},s,i,r)};subscribeToSSE=(e,t,s,i,r,o,a,l)=>{if(this.servers[t])if(this.__node.state.subscribeEvent(t,f=>{f?.callbackId===e&&(s?typeof s=="string"?this.run(s,f.args):s(f.args):this.setState({[t]:f.args}))}),a){if(this.servers[t].sessions[a])return this.eventsources[a].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l)}else{let f=[];for(let c in this.servers[t].sessions)f.push(this.eventsources[c].run("subscribeSSE",{route:"subscribeSSE",args:[e,t,i,r,o]},void 0,l));return f}};terminate=e=>(typeof e=="object"?delete this.servers[e.path]:typeof e=="string"&&(delete this.servers[e],delete this.eventsources[e]),!0)};var Rn=V(ii(),1),Fn=V(Xt(),1),zn=V(es(),1),tr=V(as(),1),ze=V(er(),1);var le=tr.default;var fs=class extends C{name="wss";debug=!1;servers={};sockets={};connections={servers:this.servers,sockets:this.sockets};constructor(e){super(e),this.load(this)}open=e=>e?.server?this.setupWSS(e):this.openWS(e);setupWSS=e=>{let t=e.port,s=e.path,i=typeof e.server=="object"?e.server:void 0,r=e.host;delete e.server,"keepState"in e||(e.keepState=!0);let o={};e.noServer?o.noServer=!0:t?t&&(o.port=t):i&&(o.server=i),e.perMessageDeflate&&(o.perMessageDeflate=e.perMessageDeflate),e.serverOptions,Object.assign(o,e.serverOptions);let a=new ze.default(o),l="";if(!r&&i){let v=i.address();t||(t=v.port),l=v.address}else r&&(l=r);t&&(l+=":"+t),s&&(s.startsWith("/")||(s="/"+s),l+=s),this.servers[l]={type:"wss",wss:a,clients:{},address:l,...e},a.addListener("connection",(v,O)=>{this.debug&&console.log(`New socket connection on ${l}`);let b=`socket${Math.floor(Math.random()*1e12)}`;if(this.servers[l].clients[b]=v,v.send(JSON.stringify({route:"setId",args:b})),this.openWS({socket:v,address:b,_id:b,debug:e.debug,onclose:(w,m)=>{this.servers[l].onconnectionclosed&&this.servers[l].onconnectionclosed(w,m,v,this.servers[l],b),delete this.servers[l].clients[b]},onmessage:e.onmessage}),e.debug){let w=Wn(new Date);console.log(w," | ",b," | Number of live sockets: ",Object.keys(this.servers[l].clients).length)}this.servers[l].onconnection&&this.servers[l].onconnection(v,O,this.servers[l],b)}),a.on("error",v=>{this.debug&&console.log("Socket Error:",v),this.servers[l]?.onerror?this.servers[l].onerror(v,a,this.servers[l]):console.error(v)});let f=(v,O,b)=>{if(v.headers&&v.url){this.debug&&console.log("Upgrade request at: ",v.url);let w=!1;if(s&&v.url===s)w=!0;else{let m=v.headers.host.split(":")[0];t&&(m+=":"+t),m===l?w=!0:(m+=v.url.split("?")[0],m===l&&(w=!0))}w&&this.servers[l]&&this.servers[l].wss.handleUpgrade(v,O,b,m=>{this.servers[l].onupgrade&&this.servers[l].onupgrade(m,this.servers[l],v,O,b),this.servers[l].wss.emit("connection",m,v)})}};i&&i.addListener("upgrade",f),a.addListener("close",()=>{i&&i.removeListener("upgrade",f),this.servers[l]?.onclose?this.servers[l].onclose(a,this.servers[l]):console.log(`wss closed: ${l}`),delete this.servers[l]});let c=(v,O)=>{if(typeof v=="object"&&(v=JSON.stringify(v)),O)return this.sockets[O].send(v);for(let b in this.servers[l].clients)this.sockets[b].send(v)},h=(v,O,b)=>{if(b)return this.sockets[b].request(v,O);{let w=[];for(let m in this.servers[l].clients)w.push(this.sockets[m].request(v,O));return w}},u=(v,O,b,w)=>{if(w)return this.sockets[w].post(v,O,b);for(let m in this.servers[l].clients)this.sockets[m].post(v,O,b)},d=(v,O,b,w)=>{if(w)return this.sockets[w].run(v,O,b);{let m=[];for(let _ in this.servers[l].clients)m.push(this.sockets[_].run(v,O,b));return m}},g=(v,O,b,w,m,_)=>{if(b)this.sockets[b].subscribe(v,O,w,m,_);else{let k=[];for(let A in this.servers[l].clients)k.push(this.sockets[A].subscribe(v,O,w,m,_));return k}},p=(v,O,b)=>{if(b)this.sockets[b].unsubscribe(v,O);else{let w=[];for(let m in this.servers[l].clients)w.push(this.sockets[m].unsubscribe(v,O));return w}},x=v=>v?this.terminate(v):this.terminate(l);return this.servers[l].send=c,this.servers[l].request=h,this.servers[l].post=u,this.servers[l].run=d,this.servers[l].subscribe=g,this.servers[l].unsubscribe=p,this.servers[l].terminate=x,this.servers[l].graph=this,this.servers[l]._id=e._id?e._id:l,this.servers[l]};openWS=e=>{if(!e.address){let h=e.protocol;h||(h="wss"),e.address=`${h}://${e.host}`,e.port&&(e.address+=":"+e.port),(!e.path||e.path?.startsWith("/"))&&(e.address+="/"),e.path&&(e.address+=e.path)}let t=e.address,s;if(e.socket?s=e.socket:s=new le(t),"keepState"in e||(e.keepState=!0),e.onmessage)s.on("message",h=>{this.sockets[t].onmessage(h,s,this.sockets[t])});else if(e._id)s.addListener("message",h=>{ArrayBuffer.isView(h)&&(h=h.toString()),e.debug&&console.log("Message from ",e._id,": ",h),this.receive(h,s,this.sockets[t]),e.keepState&&this.setState({[t]:h})});else{let h=u=>{if(ArrayBuffer.isView(u)&&(u=u.toString()),u&&(e.debug&&console.log("Message from ",t,": ",u),typeof u=="string")){let d=u.substring(0,8);(d.includes("{")||d.includes("["))&&(d.includes("\\")&&(u=u.replace(/\\/g,"")),u[0]==='"'&&(u=u.substring(1,u.length-1)),u=JSON.parse(u),u.route==="setId"?(this.sockets[t]._id=u.args,s.removeEventListener("message",h),s.on("message",g=>{ArrayBuffer.isView(g)&&(g=g.toString()),e.debug&&console.log("Message from ",this.sockets[t]._id,": ",g),this.receive(g,s,this.sockets[t]),e.keepState&&this.setState({[t]:g})})):(this.receive(u,s,this.sockets[t]),this.setState({[t]:u})))}this.receive(u,s,this.sockets[t]),e.keepState&&this.setState({[t]:u})};s.addListener("message",h),e.onmessage=h}s.addListener("open",()=>{this.sockets[t].onopen&&this.sockets[t].onopen(s,this.sockets[t])}),s.addListener("close",(h,u)=>{let d=this.sockets[t],g=d.onclose;delete this.sockets[t],g&&g(h,u,s,d)}),s.on("error",h=>{this.sockets[t]?.onerror&&this.sockets[t].onerror(h,s,this.sockets[t])});let i=h=>this.transmit(h,s),r=(h,u,d)=>{let g={route:h,args:u};return d&&(g.method=d),this.transmit(g,s)},o=(h,u,d)=>new Promise((g,p)=>{let x=Math.random(),v={route:"runRequest",args:[{route:h,args:u},this.sockets[t]._id,x]};d&&(v.args[0].method=d);let O=b=>{let w=b.data;typeof w=="string"&&w.indexOf("{")>-1&&(w=JSON.parse(w)),typeof w=="object"&&w.callbackId===x&&(s.removeEventListener("message",O),g(w.args))};s.addEventListener("message",O),this.transmit(v,s)}),a=(h,u)=>this.request(h,s,this.sockets[t]._id,u),l=(h,u)=>this.subscribeToSocket(h,this.sockets[t]._id,u),f=(h,u)=>o("unsubscribe",[h,u]),c=()=>{this.terminate(this.sockets[t]._id)};return this.sockets[t]={type:"socket",socket:s,send:i,post:r,request:a,run:o,subscribe:l,unsubscribe:f,terminate:c,graph:this,__node:{tag:t},...e},this.sockets[t]};transmit=(e,t)=>{if((typeof e=="object"&&(e?.route||e?.node||typeof e.arrayBuffer!="function"&&typeof e.byteLength!="number"&&typeof e[0]?.byteLength!="number")||typeof e=="number")&&(e=JSON.stringify(e)),!t){let s=this.servers[Object.keys(this.servers)[0]];if(s)t=s.wss;else{let i=this.sockets[Object.keys(this.sockets)[0]];i&&(t=i.socket)}}t instanceof ze.default?t.clients.forEach(s=>{s.send(e)}):t instanceof le&&t.send(e)};closeWS=e=>{if(e){if(typeof e=="string"){for(let t in this.sockets)if(t.includes(e)){e=this.sockets[t].socket,delete this.sockets[t];break}}}else{let t=this.sockets[Object.keys(this.sockets)[0]];t&&(e=t.socket)}return e instanceof le&&e.readyState===e.OPEN&&e.close(),!0};terminate=e=>{let t;if(e){if(typeof e=="string"){t=e;for(let s in this.servers)if(s.includes(e)||this.servers[s]._id===e){e=this.servers[s].wss;for(let i in this.servers[s].clients)this.closeWS(this.servers[s].clients[i]);delete this.servers[s];break}if(!e){for(let s in this.sockets)if(s.includes(e)||this.sockets[s]._id===e){e=this.sockets[s].socket,delete this.sockets[s];break}}}}else{let s=Object.keys(this.servers);for(let r in s)this.terminate(r);let i=Object.keys(this.sockets);for(let r in i)this.terminate(r)}return e instanceof ze.default?e.close(s=>{s&&console.error(s)}):e instanceof le&&(e.readyState===e.OPEN&&e.close(),this.get(t||e.url)&&this.remove(t||e.url)),!0};request=(e,t,s,i)=>{let r=`${Math.random()}`,o={route:"runRequest",args:[e,s,r]};return i&&(o.method=i),new Promise((a,l)=>{let f=c=>{let h=c.data;typeof h=="string"&&h.includes("callbackId")&&(h=JSON.parse(h)),typeof h=="object"&&h.callbackId===r&&(t.removeEventListener("message",f),a(h.args))};t.addEventListener("message",f),t.send(JSON.stringify(o))})};runRequest=(e,t,s)=>{let i=this.receive(e);if(t){if(typeof t=="string"){for(let r in this.servers)for(let o in this.servers[r].clients)if(o===t){t=this.servers[r].clients[o];break}if(!(t instanceof le)){for(let r in this.sockets)if(r===t){t=this.sockets[r].socket;break}}}i instanceof Promise?i.then(r=>{i={args:r,callbackId:s},t instanceof le&&t.send(JSON.stringify(i))}):(i={args:i,callbackId:s},t instanceof le&&t.send(JSON.stringify(i)))}return i};subscribeSocket=(e,t,s,i,r)=>{if(!this.restrict?.[e]){if(typeof t=="string")if(this.sockets[t])t=this.sockets[t].socket;else for(let o in this.servers)this.servers[o].clients[t]&&(t=this.servers[o].clients[t]);if(typeof t=="object")return this.subscribe(e,o=>{t.readyState===t.OPEN&&(o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e})))},s,i,r)}};subscribeToSocket=(e,t,s,i,r,o)=>{if(typeof t=="string"&&this.sockets[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.setState({[s]:a.args}):s(a.args):this.setState({[t]:a.args}))}),this.sockets[t].request({route:"subscribeSocket",args:[e,t,i,r,o]})}};function Wn(n){let e=n.getHours(),t=n.getMinutes();return e=e<10?"0"+e:e,t=t<10?"0"+t:t,`${e}:${t}`}var fe=require("child_process");var sr=V(require("path")),cs=class extends C{processes;connections={processes:void 0};subprocessloader={process:(e,t,s,i,r)=>{e.command&&this.createProcess(e)}};constructor(e){super(e),this.load(this),this.connections.processes=this.processes,process?.stdin&&process.stdin.on("data",t=>{let s=t.toString();this.receive(s)})}createProcess=e=>{let t=e;if(t.command||(t.command="node"),t.args||(t.args=[sr.default.join(process.cwd(),"node_modules","graphscript-node","services","cmd","childprocess.js")]),t.command){let s;t.options||(t.options={shell:!0,stdio:"inherit"}),t.controller=new AbortController,t.options=Object.assign({signal:t.controller.signal,env:process.env,cwd:process.cwd()},t.options),t.tag?t._id=t.tag:(t._id=`process${Math.floor(Math.random()*1e15)}`,t.tag=t._id),typeof t.command=="string"&&(t.command.includes(".js")?s=(0,fe.fork)(t.command,t.args,t.options):s=(0,fe.spawn)(t.command,t.args?t.args:[],t.options),s instanceof fe.ChildProcess&&(s.stderr&&(t.onerror?s.stderr.on("data",t.onerror):s.stderr.on("data",console.error)),s.stdout&&(t.stdout?s.stdout.on("data",t.stdout):s.stdout.on("data",i=>{let r=i.toString();this.receive(r),this.setState({[t._id]:r})})),t.onclose&&s.on("close",t.onclose),t.process=s,t.controller=new AbortController,t.send=i=>s.send(i),t.request=(i,r)=>this.request(i,t._id,r),t.post=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),s.send(JSON.stringify(a))},t.run=(i,r,o)=>{let a={route:i,args:r};return o&&(a.method=o),this.request(a,t._id)},t.subscribe=(i,r,o,a,l)=>this.subscribeToProcess(i,t._id,r,o,a,l),t.unsubscribe=(i,r)=>t.run("unsubscribe",[i,r]),this.processes[t._id]=t))}return t};open=this.createProcess;abort=e=>(e.controller?e.controller.abort():e.kill(),!0);send=(e,t)=>e.send(t);request=(e,t,s)=>{let i=this.processes[t].process;return new Promise((r,o)=>{let a=Math.random(),l={route:"runRequest",args:[e,a]};s&&(l.method=s);let f=c=>{let h=c.toString();if(h.includes("{")){let u=JSON.parse(h);u.callbackId===a&&(i.removeListener("data",f),r(u.args))}};i.addListener("data",f),i.send(l)})};runRequest=(e,t,s)=>{let i=this.receive(e);return typeof s=="string"&&(s=this.processes[s].process),i instanceof Promise?i.then(r=>{i={args:r,callbackId:t},s instanceof fe.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))}):(i={args:i,callbackId:t},s instanceof fe.ChildProcess?s.send(JSON.stringify(i)):process.stdout.write(JSON.stringify(i))),i};subscribeProcess(e,t,s,i,r){if(!this.restrict?.[e])return typeof t=="string"&&this.processes[t]&&(t=this.processes[t].process),this.subscribe(e,o=>{o instanceof Promise?o.then(a=>{t.send(JSON.stringify({args:a,callbackId:e}))}):t.send(JSON.stringify({args:o,callbackId:e}))},s,i,r)}subscribeToProcess(e,t,s,i,r,o){if(typeof t=="string"&&this.processes[t])return this.__node.state.subscribeEvent(t,a=>{a?.callbackId===e&&(s?typeof s=="string"?this.run(s,a.args):s(a.args):this.setState({[t]:a.args}))}),this.processes[t].request(JSON.stringify({route:"subscribeSocket",args:[e,t,i,r,o]}))}};var G={};Ds(G,{AuthorizationStruct:()=>ms,ChatroomStruct:()=>ws,CoherenceMap:()=>St,CoherenceStruct:()=>bt,CommentStruct:()=>ks,Data:()=>rr,DataStruct:()=>Ss,DateStruct:()=>As,ECGStruct:()=>wt,EDAStruct:()=>ds,EEGCoordinates:()=>ir,EEGStruct:()=>ie,EMGStruct:()=>ps,EventStruct:()=>vs,EyeTrackerStruct:()=>us,FNIRSStruct:()=>vt,FrequencyBandsStruct:()=>Ge,GroupStruct:()=>bs,HRVStruct:()=>ys,IMUStruct:()=>hs,NotificationStruct:()=>xs,PPGStruct:()=>gs,ProfileStruct:()=>_s,ScheduleStruct:()=>Os,Struct:()=>j,eegCoordinates:()=>ce,setCoordinate:()=>We,structRegistry:()=>nr});function j(n="struct",e={},t={_id:""},s={structType:"struct",_id:""}){function i(o=""){return`${o+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}let r={_id:i(n+"defaultId"),structType:n,ownerId:t?._id,timestamp:Date.now(),parent:{structType:s?.structType,_id:s?._id}};return r.ownerId||delete r.ownerId,r?.parent?._id||delete r.parent,Object.keys(e).length>0&&Object.assign(r,e),r}var ce={FP1:[-21.2,66.9,12.1],FPZ:[1.4,65.1,11.3],FP2:[24.3,66.3,12.5],AF7:[-41.7,52.8,11.3],AF3:[-32.7,48.4,32.8],AFZ:[1.8,54.8,37.9],AF4:[35.1,50.1,31.1],AF8:[43.9,52.7,9.3],F5:[-51.4,26.7,24.7],F3:[-39.7,25.3,44.7],F1:[-22.1,26.8,54.9],FZ:[0,26.8,60.6],F2:[23.6,28.2,55.6],F4:[41.9,27.5,43.9],F6:[52.9,28.7,25.2],F7:[-52.1,28.6,3.8],F8:[53.2,28.4,3.1],FC5:[-59.1,3,26.1],FC3:[-45.5,2.4,51.3],FC1:[-24.7,.3,66.4],FCZ:[1,1,72.8],FC2:[26.1,3.2,66],FC4:[47.5,4.6,49.7],FC6:[60.5,4.9,25.5],FT9:[-53.8,-2.1,-29.1],FT7:[-59.2,3.4,-2.1],FT8:[60.2,4.7,-2.8],FT10:[55,-3.6,-31],T7:[-65.8,-17.8,-2.9],T5:[-61.5,-65.3,1.1],T3:[-70.2,-21.3,-10.7],T4:[71.9,-25.2,-8.2],T6:[59.3,-67.6,3.8],T8:[67.4,-18.5,-3.4],C5:[-63.6,-18.9,25.8],C3:[-49.1,-20.7,53.2],C1:[-25.1,-22.5,70.1],CZ:[.8,-21.9,77.4],C2:[26.7,-20.9,69.5],C4:[50.3,-18.8,53],C6:[65.2,-18,26.4],CP5:[-61.8,-46.2,22.5],CP3:[-46.9,-47.7,49.7],CP1:[-24,-49.1,66.1],CPZ:[.7,-47.9,72.6],CP2:[25.8,-47.1,66],CP4:[49.5,-45.5,50.7],CP6:[62.9,-44.6,24.4],TP9:[-73.6,-46.7,-4],TP7:[-63.6,-44.7,-4],TP8:[64.6,-45.4,-3.7],TP10:[74.6,-47.4,-3.7],P9:[-50.8,-51.3,-37.7],P7:[-55.9,-64.8,0],P5:[-52.7,-67.1,19.9],P3:[-41.4,-67.8,42.4],P1:[-21.6,-71.3,52.6],PZ:[.7,-69.3,56.9],P2:[24.4,-69.9,53.5],P4:[44.2,-65.8,42.7],P6:[54.4,-65.3,20.2],P8:[56.4,-64.4,.1],P10:[51,-53.9,-36.5],PO7:[-44,-81.7,1.6],PO3:[-33.3,-84.3,26.5],POZ:[0,-87.9,33.5],PO4:[35.2,-82.6,26.1],PO8:[43.3,-82,.7],O1:[-25.8,-93.3,7.7],OZ:[.3,-97.1,8.7],O2:[25,-95.2,6.2]};function We(n,e={}){if(!ce[n.tag]&&n.position&&(ce[n.tag]=[n.position.x,n.position.y,n.position.z]),ce[n.tag]){let t={channel:"",position:{x:ce[n.tag][0],y:ce[n.tag][1],z:ce[n.tag][2]}};return Object.assign(e,t)}else return Object.assign(e,n)}function ir(n=[],e=!0){let t=[];for(let s of n){let i=ie(s);t.push(i)}return e&&t.push(...St({channelDicts:n})),t}function Ge(n=[],e={}){let t={scp:[],delta:[],theta:[],alpha1:[],alpha2:[],beta:[],lowgamma:[],highgamma:[]};return n.forEach(s=>t[s]=[]),Object.assign(e,t)}function ie(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=Ge(),r={tag:n,position:{x:0,y:0,z:0},count:0,times:[],raw:[],filtered:[],fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=j("eeg",r,t,s);return n&&We(r,o),Object.assign(o,e)}function bt(n={0:ie("FP1"),1:ie("FP2")},e={},t={_id:""},s={structType:"struct",_id:""}){let i=Ge(),r={tag:n[0]?.tag+"::"+n[1]?.tag,x0:n[0]?.position?.x,y0:n[0]?.position?.y,z0:n[0]?.position?.z,x1:n[1]?.position?.x,y1:n[1]?.position?.y,z1:n[1]?.position?.z,fftCount:0,fftTimes:[],ffts:[],slices:JSON.parse(JSON.stringify(i)),means:JSON.parse(JSON.stringify(i)),startTime:Date.now()},o=j("coherence",r,t,s);return Object.assign(o,e)}function St(n={channelDicts:[{ch:0,tag:"FP1",analyze:!1},{ch:1,tag:"FP2",analyze:!1}],taggedOnly:!0},e={},t={_id:""},s={structType:"struct",_id:""}){for(var i=[],r=1,o=0,a=0;a<n.channelDicts.length*(n.channelDicts.length+1)/2-n.channelDicts.length;a++){if(n.taggedOnly===!1||n.taggedOnly===!0&&n.channelDicts[o].tag!==null&&n.channelDicts[o+r].tag!==null&&n.channelDicts[o].tag!=="other"&&n.channelDicts[o+r].tag!=="other"&&n.channelDicts[o].analyze===!0&&n.channelDicts[o+r].analyze===!0){var l=ie(n.channelDicts[o].tag),f=ie(n.channelDicts[o+r].tag);i.push(bt({0:l,1:f},{},t,s))}r++,r+o===n.channelDicts.length&&(o++,r=1)}return i}function vt(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,position:{x:0,y:0,z:0},count:0,times:[],red:[],ir:[],ir2:[],ambient:[],ratio:[],temp:[],beat_detect:{beats:[],breaths:[],rir:[],rir2:[],drir_dt:[],localmins:[],localmaxs:[],val_dists:[],peak_dists:[],localmins2:[],localmaxs2:[],val_dists2:[],peak_dists2:[]},startTime:Date.now()},r=j("fnirs",i,t,s);return n&&We(i,r),Object.assign(r,e)}function hs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,Ax:[],Ay:[],Az:[],Gx:[],Gy:[],Gz:[],startTime:Date.now()},r=j("imu",i,t,s);return n&&We(i,r),Object.assign(r,e)}function us(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],x:[],y:[],smax:[],smay:[],startTime:Date.now()},r=j("eyetracker",i,t,s);return Object.assign(r,e)}function wt(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,count:0,times:[],raw:[],filtered:[],bpm:[],hrv:[],startTime:Date.now()},r=j("ecg",i,t,s);return Object.assign(r,e)}function ds(n="",e={},t={_id:""},s={structType:"struct",_id:""}){}function gs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=vt(n,t,s,e);return i.structType="ppg",i}function ys(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=wt(n,t,s,e);return i.structType="hrv",i}function ps(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i=ie(n,t,s,e);return i.structType="emg",i}function _s(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=j("profile",{tag:n,name:"",username:"",firstName:"",lastName:"",email:"",phone:"",sex:"",birthday:"",type:"",pictureUrl:"",userRoles:{},socials:{},data:{},hidden:!1,accessToken:"",refreshToken:""},t,s);return Object.assign(r,e)}function ms(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=j("authorization",{tag:n,authorizedId:"",authorizedName:"",authorizerId:"",authorizerName:"",authorizations:{},structs:{},excluded:{},groups:{},status:"PENDING",expires:!1,associatedAuthId:""},t,s);return Object.assign(r,e)}function bs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=j("group",{tag:n,name:"",details:"",admins:{},peers:{},clients:{},users:{}},t,s);return Object.assign(r,e)}function rr(n,e){return{type:n,data:e,timestamp:Date.now()}}function Ss(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",expires:!1,type:"",data:new Array},r=j("data",i,t,s);return Object.assign(r,e)}function vs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,event:"",author:"",startTime:"",endTime:"",grade:void 0,value:void 0,units:void 0,location:void 0,notes:"",attachments:new Array,users:{}},r=j("event",i,t,s);return Object.assign(r,e)}function ws(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,message:"",topic:"",author:"",attachments:new Array,comments:new Array,replies:new Array,users:{},audioChatActive:!1,videoChatActive:!1},r=j("chatroom",i,t,s);return Object.assign(r,e)}function ks(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,author:"",replyTo:"",message:"",rating:0,replies:new Array,users:{},attachments:new Array},r=j("comment",i,t,s);return Object.assign(r,e)}function xs(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let r=j("notification",{tag:n,note:"",parentUserId:""},t,s);return Object.assign(r,e)}function Os(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,title:"",author:"",attachments:new Array,dates:new Array},r=j("schedule",i,t,s);return Object.assign(r,e)}function As(n="",e={},t={_id:""},s={structType:"struct",_id:""}){let i={tag:n,timeSet:"",notes:"",recurs:"NEVER",attachments:new Array},r=j("date",i,t,s);return Object.assign(r,e)}var nr={Struct:j,EEGStruct:ie,FNIRSStruct:vt,CoherenceStruct:bt,CoherenceMap:St,FrequencyBandsStruct:Ge,IMUStruct:hs,EyeTrackerStruct:us,ECGStruct:wt,EDAStruct:ds,PPGStruct:gs,HRVStruct:ys,EMGStruct:ps,ProfileStruct:_s,AuthorizationStruct:ms,GroupStruct:bs,DataStruct:Ss,EventStruct:vs,ChatroomStruct:ws,CommentStruct:ks,NotificationStruct:xs,ScheduleStruct:Os,DateStruct:As};var Be=class{id;threaded;workers;DS=G;collections=new Map;data={byTime:{},notes:{},events:{},sleep:{},food:{},rx:{},hr:{},ppg:{},hrv:{},ecg:{},emg:{},eeg:{},fnirs:{}};rolloverLimit=5e4;dataSorts=new Map;watches={};constructor(e={}){Object.assign(this.data,e),this.dataSorts=new Map,this.watches={},this.setSort("event",t=>(this.data.events[t.timestamp]?this.data.events[t.timestamp].push(t):this.data.events[t.timestamp]=[t],t.event==="sleep"&&(this.data.sleep[t.timestamp]?this.data.sleep[t.timestamp].push(t):this.data.sleep[t.timestamp]=[t]),t)),this.setSort(["notes","note","link"],t=>(this.data.notes[t.timestamp]?this.data.notes[t.timestamp].push(t):this.data.notes[t.timestamp]=[t],this.data.byTime[t.timestamp]?this.data.byTime[t.timestamp].push(t):this.data.byTime[t.timestamp]=[t],t)),this.id=this.randomId("dataTablet")}randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}setLocalData(e){let t=s=>{let i=s.structType,r=this.collections.get(i);r||(r=new Map,this.collections.set(i,r)),r.set(s._id,s),this.onCollectionSet(i,r)};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)}getLocalData(e,t){let s="",i="",r="";if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return this.collections.forEach(a=>{if((i==="_id"||i==="id")&&r){let l=a.get(r);l&&o.push(l)}else a.forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections.get(e);if(!a)return o;if(!i&&!s)return a.forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return a.get(r);a.forEach((l,f)=>{i&&r&&!s?l[i]===r&&o.push(l):s&&!i?l.ownerId===s&&o.push(l):s&&i&&r&&l.ownerId===s&&l[i]&&l[i]===r&&o.push(l)})}return o}onCollectionSet=(e,t)=>{};runSort(e,t={},s=[],i=this){let r,o=this.getSort(e);if(o)r=o(t,s,i);else return!1;return r}setSort(e,t=(s,i=[],r=this)=>{}){Array.isArray(e)?e.forEach(s=>{this.dataSorts.set(s,t)}):this.dataSorts.set(e,t)}getSort(e){return this.dataSorts.get(e)}checkWatches(e={}){for(let t in this.watches)this.watches[t].ondata(e,this.watches[t].accum,this.watches[t].ownerId)&&(this.watches[t].ontrigger(this.watches[t].accum),this.watches[t].triggered=!1)}setWatch(e,t,s=(r,o,a)=>(r.ownerId===a&&(o.data[r._id]=r),Object.keys(o.data).length>10),i=r=>{console.log(r);let o=j("alert",{alert:!0,data:r},{_id:r[Object.keys(r)[0]].ownerId});r={}}){this.watches[e]={accum:{},ownerId:t,ondata:s,ontrigger:i}}getWatch(e){return this.watches[e]}async sortStructsIntoTable(e=[]){let t=function(i,r){if(i.timestamp&&r.timestamp)return i.timestamp-r.timestamp};e.sort(t);let s=[];for(let i=0;i<e.length;i++){let r=e[i];if(!r.timestamp)continue;let o=r.timestamp;if(this.data.byTime[o]?this.data.byTime[o].push(r):this.data.byTime[o]=[r],r.structType==="data"&&r.data)r.data.forEach(async a=>{if(typeof a=="object"&&!Array.isArray(a)){let l=a.dataType;if(a.ownerId=r.ownerId,a.timestamp||(a.timestamp=o),l){let f=this.runSort(l,a,s,this);f?f.constructor?.name!=="Promise"&&(this.checkWatches(f),this.onUpdate(o,f),s.push(f)):(this.data[l]||(this.data[l]={}),a.timestamp=o,this.data[l][o]?this.data[l][o].push(a):this.data[l][o]=[a],this.data.byTime[o]?this.data.byTime[o].push(a):this.data.byTime[o]=[a],this.checkWatches(a),this.onUpdate(o,a),s.push(a))}}});else{let a=this.runSort(r.structType,r,s,this);if(a)this.checkWatches(a),this.onUpdate(o,a),s.push(a);else{let l=r.structType;this.data[l]||(this.data[l]={}),this.data[l][o]?this.data[l][o].push(r):this.data[l][o]=[r],this.checkWatches(r),this.onUpdate(o,r),s.push(r)}}}for(let i in this.data)this.data[i]=this.sortObjectByPropName(this.data[i]);this.onSorted(s)}onUpdate(e,t,s=this.data){}onSorted(e=[]){}getDataByTimestamp(e,t){let s=this.data.byTime[e];return t&&s&&(s=s.filter(i=>t?t===i.ownerId:!0)),s}getDataByTimeRange(e,t,s,i){let r={};if(s){for(let o in this.data[s]){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data[s][o]])}s==="sleep"&&(r=this.filterSleepResults(r))}else for(let o in this.data.byTime){let a=parseInt(o);a>e&&a<t&&(r[o]=[...this.data.byTime[o]])}if(i&&r)for(let o in r){let a=[];r[o]=r[o],r[o].forEach((l,f)=>{l.ownerId!==i&&a.push(f)}),a.reverse().forEach(l=>{r[o].splice(l,1)}),r[o].length===0&&delete r[o]}return r}getDataByType(e,t,s){if(!this.data[e])return;let i={...this.data[e]};if(t&&(i=[...i[t]]),s&&i)for(let r in i){let o=[];i[r]=[...i[r]],i[r].forEach((a,l)=>{a.ownerId!==s&&o.push(l)}),o.reverse().forEach(a=>{i[r].splice(a,1)}),i[r].length===0&&delete i[r]}return e==="sleep"&&(i=this.filterSleepResults(i)),i}filterSleepResults(e={}){let t=[];for(let i in e)e[i]=[...e[i]],t.push(...e[i].filter(r=>r.structType==="event"));return t.forEach(i=>{let r;for(let o in e)e[o].forEach((a,l)=>a.structType==="fitbitsleep"&&i.startTime&&i.endTime&&Math.abs(a.startTime-i.startTime)<1e3*12*3600&&Math.abs(a.endTime-i.endTime)<1e3*12*3600&&i.endTime-i.startTime>1e3*2*3600?(r=l,!0):!1),r&&e[o].splice(r,1)}),e}sortObjectByPropName(e){return Object.keys(e).sort().reduce((s,i)=>(s[i]=e[i],s),{})}checkRollover(e,t=this.rolloverLimit){if(!e)return!1;let s=this.collections.get(e);return s?(s.forEach(i=>{for(let r in i)Array.isArray(i[r])?i[r].length>t&&(i[r].slice(i[r].length-t),r==="ffts"?i.fftCount=i[r].length:r==="times"&&(i.count=i[r].length)):typeof i[r]=="object"&&this.checkRollover(i[r])}),!0):!1}};var or=["now","minute","5 minutes","30 minutes","hour","6 hours","12 hours","day","3 days","week","2 weeks","month","6 months","year","5 years","decade"];function Gn(n=or){let e=["now"];return n.forEach(t=>{t!=="now"?e.push(`last ${t}`):e.push(t)}),e}function X(n){let e=new Date;if(n!=="now"){if(n==="last minute")e.setMinutes(e.getMinutes()-1);else if(n==="last hour")e.setHours(e.getHours()-1);else if(n==="last day")e.setDate(e.getDate()-1);else if(n==="last week")e.setDate(e.getDate()-7);else if(n==="last month")e.setMonth(e.getMonth()-1);else if(n==="last year")e.setFullYear(e.getFullYear()-1);else if(n==="last decade")e.setFullYear(e.getFullYear()-1*10);else if(n==="last century")e.setFullYear(e.getFullYear()-1*100);else if(n==="last millennium")e.setFullYear(e.getFullYear()-1*1e3);else if(n==="last microsecond")e.setMilliseconds(e.getMilliseconds()-1);else if(n==="last nanosecond")e.setMilliseconds(e.getMilliseconds()-1*.001);else if(n.startsWith("last")){let[,t,s]=n.match(/last (\d+) (\w+)/)||[];if(t&&s){let i=parseInt(t,10);s.includes("minute")?e.setMinutes(e.getMinutes()-i):s.includes("hour")?e.setHours(e.getHours()-i):s.includes("day")?e.setDate(e.getDate()-i):s.includes("week")?e.setDate(e.getDate()-i*7):s.includes("month")?e.setMonth(e.getMonth()-i):s.includes("year")?e.setFullYear(e.getFullYear()-i):s.includes("decade")?e.setFullYear(e.getFullYear()-i*10):s.includes("century")?e.setFullYear(e.getFullYear()-i*100):s.includes("millennium")?e.setFullYear(e.getFullYear()-i*1e3):s.includes("microsecond")?e.setMilliseconds(e.getMilliseconds()-i):s.includes("nanosecond")&&e.setMilliseconds(e.getMilliseconds()-i*.001)}}}return e.getTime()}var ar=n=>(n?`${n}`:"")+Math.floor(1e15*Math.random()),Bn=(n=Math,e=Date,t=16,s=i=>n.floor(i).toString(t))=>s(e.now()/1e3)+" ".repeat(t).replace(/./g,()=>s(n.random()*t)),Ps=class extends C{name="structs";currentUser;tablet=new Be;collections=this.tablet.collections;id=ar();useAccessTokens=!1;useRefreshTokens=!1;constructor(e,t){super(e),this.load(this),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),t instanceof Object&&Object.keys(t).length>0&&this.setupUser(t)}getToken(e){return this.useRefreshTokens?e.refreshToken:e.accessToken}setupUser=async(e,t=s=>{})=>{if(!e){console.error('must provide a minimum info object! e.g. {_id:"abc123"}'),t(void 0);return}let s=!1;e.id&&!e._id?e._id=e.id:e._id&&(e.id=e._id);let i=await this.getUser(e._id),r=i?.user,o,a=!1;if(!r||!r._id){o=this.userStruct(e,!1),a=!0;let l=await this.setUser(o),f=this.getLocalData(void 0,{ownerId:o._id});f?.length>0&&this.updateServerData(f),this.setAuthorizationsByGroup(o)}else{o=r;let l={_id:e._id,ownerId:e._id},f=this.userStruct(e,!1);for(let c in f)e[c]&&r[c]!==e[c]?(l[c]=e[c],r[c]=e[c]):f[c]&&!r[c]&&(l[c]=f[c],r[c]=f[c]);Object.keys(l).length>2&&await this.setUser(l),i?.authorizations&&Array.isArray(i.authorizations)&&this.setLocalData(i.authorizations),i?.groups&&Array.isArray(i.groups)&&this.setLocalData(i.groups)}if(a)this.setLocalData(o);else{let l=await this.getAllUserData(o._id,void 0,[X("last day"),Date.now()]);if(!(!l||l.length===0)){this.setLocalData(l);let f=l.filter(d=>{if(d.structType==="notification"&&(this.getLocalData("authorization",d.parent._id)||d.parent.structType==="user"||d.parent.structType==="authorization"||!this.getLocalData(d.parent.structType,d.parent._id)))return!0}),c=l.filter(d=>{if(d.structType==="comment")return!0}),h=[];c.forEach(d=>{this.getLocalData("comment",{_id:d._id})||h.push(d._id)}),h.length>0&&this.deleteData(h),f.length>0&&(this.resolveNotifications(f,!1,void 0),s=!0);let u=l.filter(d=>{if(d.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(u)}this.setLocalData(o)}return o?(this.currentUser?Object.assign(this.currentUser,o):this.currentUser=o,t(this.currentUser),this.currentUser):(t(o),o)};baseServerCallback=async e=>{let t=e;if(typeof e=="object"&&e?.structType&&(t=[e]),Array.isArray(t)){let s=t.filter(i=>{if(i.structType!=="notification")return!0});this.tablet&&this.tablet.sortStructsIntoTable(s);for(let i=0;i<t.length;i++){let r=t[i];if(typeof r=="object")if((!r.structType||r.structType==="USER")&&(r.email?r.structType="user":r.structType="uncategorized"),r.structType==="user"||r.structType==="authorization"||r.structType==="group"){if(r.structType==="user")r._id=r.id;else if(r.structType==="group"&&this.currentUser){let o=!1;r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_admin"]?(this.currentUser.userRoles[r.name+"_admin"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_admin"]&&(delete this.currentUser.userRoles[r.name+"_admin"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_peer"]?(this.currentUser.userRoles[r.name+"_peer"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_peer"]&&(delete this.currentUser.userRoles[r.name+"_peer"],o=!0),r.admins[this.currentUser?._id]&&!this.currentUser.userRoles?.[r.name+"_client"]?(this.currentUser.userRoles[r.name+"_client"]=!0,o=!0):!r.admins[this.currentUser?._id]&&this.currentUser.userRoles?.[r.name+"_client"]&&(delete this.currentUser.userRoles[r.name+"_client"],o=!0),o&&await this.setUser(this.currentUser)}this.setLocalData(r)}else r.structType==="notification"?(this.getLocalData("notification",{ownerId:r.ownerId,_id:r.parent._id})?this.setLocalData(r):this.getLocalData(r.structType,{_id:r.parent._id})||this.overwriteLocalData(r),r.ownerId===this.currentUser?._id&&(r.parent.structType==="user"||r.parent.structType==="dataInstance"||r.parent.structType==="schedule"||r.parent.structType==="authorization")&&await this.resolveNotifications([r],!0),this.onNotify(r)):this.overwriteLocalData(r)}}this.onData(e)};structNotification=()=>{this.checkForNotifications()};structDeleted=e=>{this.deleteLocalData([e])};onData=e=>{};onNotify=e=>{};randomId(e=""){return`${e+Math.floor(Math.random()+Math.random()*Math.random()*1e16)}`}addStruct=async(e="struct",t={},s,i,r=!0)=>{let o=G.Struct(e,t,s,i);return r&&(o=await this.updateServerData([o])[0]),o};getUser=async(e="",t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return s(i),i}};queryUsers=async(e,t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"queryUsers",args:[this.currentUser._id,e,t,s,void 0,this.getToken(this.currentUser)]});return i(r),r}};getUsers=async(e=[],t,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUsersByIds",args:[this.currentUser._id,e,t]});return s(i),i}};getUsersByRole=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=await this.currentUser.request({route:"getUsersByRole",args:[this.currentUser._id,e]});return t(s),s}};getAllUserData=async(e,t=[],s,i=this.baseServerCallback)=>{if(s&&(typeof s[0]=="string"&&(s[0]=X(s[0])),typeof s[1]=="string"&&(s[1]=X(s[1]))),this.currentUser?.request){let r=await this.currentUser.request({route:"getAllData",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return i(r),r}};query=async(e,t={},s=!1,i=0,r=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e||!t)return;let o=await this.currentUser.request({route:"query",args:[this.currentUser._id,e,t,s,i,this.getToken(this.currentUser)]});return typeof r=="function"&&r(o),o}};getDataByTimeRange(e,t,s,i=0,r=0,o){let a={};t&&(typeof t[0]=="string"&&(t[0]=X(t[0])),typeof t[1]=="string"&&(t[1]=X(t[1])));let l={$gt:t[0],$lt:t[1]};return o?a[o]=l:a.timestamp=l,this.getData(e,s,a,i,r)}getData=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{if(this.currentUser?.request){let a=await this.currentUser.request({route:"getData",args:[this.currentUser._id,e,t,s,i,r,this.getToken(this.currentUser)]});return typeof o=="function"&&o(a),a}};getDataByIds=async(e=[],t,s,i=this.baseServerCallback)=>{if(this.currentUser?.request){let r=await this.currentUser.request({route:"getDataByIds",args:[this.currentUser._id,e,t,s,this.getToken(this.currentUser)]});return typeof i=="function"&&i(r),r}};getStructParentData=async(e,t=this.baseServerCallback)=>{if(e?.parent&&this.currentUser?.request){let s=[this.currentUser._id,e.parent?.structType,"_id",e.parent?._id,this.getToken(this.currentUser)],i=(await this.currentUser.request({route:"getData",args:s}))?.[0];return typeof t=="function"&&t(i),i}};setUser=async(e,t=this.baseServerCallback)=>{if(console.log(this.currentUser),e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setUser",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkUserToken=async(e,t=this.currentUser,s=this.baseServerCallback)=>{if(!e)return!1;let i=!1;for(let r in e){let o=this.userStruct();if(t[r]&&r!=="_id")if(Array.isArray(e[r])){for(let a=0;a<t[r].length;a++)if(e[r].indexOf(t[r][a])<0){t[r]=e[r],i=!0;break}if(!i){for(let a=0;a<e[r].length;a++)if(t[r].indexOf(e[r][a])<0){t[r]=e[r],i=!0;break}}}else t[r]!==e[r]&&(t[r]=e[r],i=!0);else!t[r]&&o[r]&&(t[r]=e[r],i=!0)}return i&&await this.setUser(t,s)};setData=async(e=[],t=!0,s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=new Array;!Array.isArray(e)&&typeof e=="object"&&(e=[e]),e.forEach(o=>{i.push(this.stripStruct(o))});let r=await this.currentUser.request({route:"setData",args:[this.currentUser._id,i,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(r),r}};updateServerData=this.setData;deleteData=async(e=[],t=this.baseServerCallback)=>{if(this.currentUser?.request){let s=[];e.forEach(r=>{if(typeof r=="object")r?.structType&&r?._id&&(s.push({structType:r.structType,_id:r._id}),this.deleteLocalData(r));else if(typeof r=="string"){let o=this.getLocalData(void 0,{_id:r});o&&!Array.isArray(o)?s.push({structType:o.structType,_id:o._id}):s.push({_id:r})}});let i=await this.currentUser.request({route:"deleteData",args:[this.currentUser._id,s,this.getToken(this.currentUser)]});return typeof t=="function"&&t(i),i}};deleteUser=async(e=this.currentUser._id,t,s=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;let i=await this.currentUser.request({route:"deleteUser",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};setGroup=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setGroup",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getUserGroups=async(e=this.currentUser._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){let i=await this.currentUser.request({route:"getUserGroups",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteGroup=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteGroup",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};setAuthorization=async(e,t=this.baseServerCallback)=>{if(e&&this.currentUser?.request){let s=await this.currentUser.request({route:"setAuthorization",args:[this.currentUser._id,this.stripStruct(e),this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};getAuthorizations=async(e=this.currentUser?._id,t="",s=this.baseServerCallback)=>{if(this.currentUser?.request){if(e===void 0)return;let i=await this.currentUser.request({route:"getAuthorizations",args:[this.currentUser._id,e,t,this.getToken(this.currentUser)]});return typeof s=="function"&&s(i),i}};deleteAuthorization=async(e,t=this.baseServerCallback)=>{if(this.currentUser?.request){if(!e)return;this.deleteLocalData(e);let s=await this.currentUser.request({route:"deleteAuthorization",args:[this.currentUser._id,e,this.getToken(this.currentUser)]});return typeof t=="function"&&t(s),s}};checkForNotifications=async(e=this.currentUser?._id)=>await this.getData("notification",e);resolveNotifications=async(e=[],t=!0,s=this.currentUser)=>{if(!s||e.length===0)return;let i=[],r=[],o=[],a=!1;if(e.length===0&&(e=this.getLocalData("notification",{ownerId:s._id})),e.forEach(l=>{l.parent.structType==="user"&&(a=!0),o.push(l.parent.structType),i.push(l.parent._id),r.push(l._id),this.deleteLocalData(l)}),this.deleteData(e),t){if(o.reverse().forEach((l,f)=>{l==="user"&&(this.getUser(i[f]),i.splice(i.length-f-1,1))}),i.length===1)return await this.getDataByIds(i,void 0,e[0].parent.structType);if(i.length>0)return await this.getDataByIds(i)}return!0};setAuthorizationsByGroup=async(e=this.currentUser)=>{let t=this.getLocalData("authorization",{ownerId:e._id}),s=[];if(e.userRoles&&await Promise.all(Object.keys(e.userRoles).map(async i=>{let o=i.split("_")[0],a;if(i.includes("client")?a=o+"_peer":i.includes("peer")?a=o+"_client":i.includes("admin")&&(a=o+"_owner"),a){let l=await this.getUsersByRole(a);l&&await Promise.all(l.map(async f=>{let c=f.username;c||(c=f.email),c||(c=f._id);let h=e.username;if(h||(h=e.email),h||(h=e._id),c!==h){if(i.includes("client")){if(!t.find(d=>{if(d.authorizerId===f._id&&d.authorizedId===e._id)return!0})){let d=await this.authorizeUser(G.ProfileStruct("user",e,e),f._id,c,e._id,h,{peer:!0},void 0,{group:o});s.push(d)}}else if(i.includes("peer")&&!t.find(d=>{if(d.authorizedId===f._id&&d.authorizerId===e._id)return!0})){let d=await this.authorizeUser(G.ProfileStruct("user",e,e),e._id,h,f._id,c,{peer:!0},void 0,{group:o});s.push(d)}}}))}})),s.length>0)return s};deleteRoom=async e=>{if(!e)return!1;let t=[e];return e.comments?.forEach(s=>{let i=this.getLocalData("comment",{_id:s});t.push(i)}),e?await this.deleteData(t):!1};deleteComment=async e=>{let t=[e],s=(a=e)=>{a?.replies&&a.replies.forEach(l=>{let f=this.getLocalData("comment",{_id:l});f&&(f.replies.length>0&&f.replies.forEach(c=>{s(c)}),t.push(f))})};s(e);let i=this.getLocalData(e.parent?.structType,{_id:e.parent?._id}),r=[];i&&(r=[i],t.forEach(a=>{let l=i.replies?.indexOf(a._id);l>-1&&i.replies.splice(l,1);let f=i.comments?.indexOf(a._id);f>-1&&i.comments.splice(f,1)}));let o=this.getLocalData("comment",{_id:e.replyTo});if(o?._id!==i?._id){let a=o.replies?.indexOf(i._id);a>-1&&o.replies.splice(a,1),r.push(o)}return r.length>0&&await this.updateServerData(r),await this.deleteData(t)};getUserDataByAuthorization=async(e,t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=e.authorizerId;if(a)return new Promise(async l=>{this.getUser(a,!0,async f=>{let c;t?c=await this.getData(t,a,s,i,r,o):c=await this.getAllUserData(a,["notification"],void 0,o),l(c),o(c)})})};getUserDataByAuthorizationGroup=async(e="",t,s,i=0,r=0,o=this.baseServerCallback)=>{let a=this.getLocalData("authorization"),l=[];return await Promise.all(a.map(async f=>{if(f.groups?.includes(e)){let c=f.authorizerId;if(c){let h,u=await this.getUser(c,!0,o);u&&l.push(u),t?h=await this.getData(t,c,s,i,r,o):h=await this.getAllUserData(c,["notification"],void 0,o),h&&l.push(h)}return!0}})),l};overwriteLocalData(e){if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:t._id});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:e._id});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}}setLocalData(e){this.tablet.setLocalData(e)}getLocalData(e,t){return this.tablet.getLocalData(e,t)}getLocalUserPeerIds=(e=this.currentUser)=>{if(!e)return{};let t={};return this.getLocalData("authorization",e._id).forEach(i=>{i.authorizations.peer&&i.authorizerId===e._id&&(t[i.authorizedId]=!0)}),t};getLocalReplies(e){let t=[];if(e.replies){if(e.replies.reduce((s,i)=>s*(typeof i=="object"?1:0),1))return e.replies}else return t;return t=this.getLocalData("comment",{replyTo:e._id}),t}hasLocalAuthorization(e,t=this.currentUser._id){let i=this.getLocalData("authorization",{ownerId:t}).find(r=>{if(r.authorizedId===t&&r.authorizerId===e||r.authorizerId===t&&r.authorizedId===e)return!0});return i||!1}deleteLocalData(e){return Array.isArray(e)?e.forEach(t=>this.deleteStruct(t)):this.deleteStruct(e),!0}deleteStruct(e){if(typeof e=="string"&&(e=this.getLocalData(void 0,{_id:e})),!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.tablet.collections.get(e.structType).delete(e._id),!0)}stripStruct(e){let t=Object.assign({},e);for(let s in t)(t[s]===void 0||t[s]===""||t[s].constructor.name==="Map"||t[s].constructor.name==="Set"||typeof t[s]=="function"||Array.isArray(t[s])&&t[s].length===0||typeof t[s]=="object"&&Object.keys(t[s]).length===0)&&delete t[s];return t}createStruct(e,t,s=this.currentUser,i){return G.Struct(e,t,s,i)}userStruct(e={},t=!1){let s=G.ProfileStruct(void 0,e,e);if(!s.name&&s.firstName)s.name=s.firstName+" "+s.lastName;else if(s.name&&!s.firstName){let r=s.name.split(" ");s.firstName=r[0],s.lastName=r[r.length-1]}e._id?s.id=e._id:e.id?s.id=e.id:s.id="user"+Math.floor(Math.random()*1e15),s._id=s.id,s.ownerId=s.id;let i=G.ProfileStruct();for(let r in e)Object.keys(i).indexOf(r)<0&&delete s[r];return t&&(this.currentUser=s),s}authorizeUser=async(e,t="",s="",i="",r="",o={},a={},l={},f={},c=!1)=>{if(!e)return;let h=this.createStruct("authorization",void 0,e,void 0);return h.authorizedId=i,h.authorizedName=r,h.authorizerId=t,h.authorizerName=s,h.authorizations=o,h.structs=a,h.excluded=l,h.groups=f,h.expires=c,h.status="PENDING",h.associatedAuthId="",h=await this.setAuthorization(h),h};addGroup=async(e,t="",s="",i={},r={},o={},a=!0)=>{if(!e)return;let l=this.createStruct("group",void 0,e);return l.name=t,l.details=s,l.admins=i,l.peers=r,l.clients=o,l.users={},Object.assign(l.users,l.admins),Object.assign(l.users,l.peers),Object.assign(l.users,l.clients),a&&(l=await this.setGroup(l)),l};dataObject(e=void 0,t="any",s=Date.now()){return{type:t,data:e,timestamp:s}}addData=async(e,t="",s="",i="",r=[],o=!1,a=!0)=>{if(!e)return;let l=this.createStruct("dataInstance",void 0,e);return l.author=t,l.title=s,l.type=i,l.data=r,l.expires=o,a&&(l=await this.updateServerData([l])[0]),l};addEvent=async(e,t="",s="",i="",r,o,a,l,f,c,h,u,d=!0)=>{if(!e)return;u&&Object.keys(u).length===0&&(u=this.getLocalUserPeerIds(e));let g=this.createStruct("event",void 0,e);return g.author=t,g.event=s,g.notes=i,g.startTime=r,g.endTime=o,g.grade=a,g.attachments=h,g.value=l,g.units=f,g.users=u,g.location=c,d&&(g=await this.updateServerData([g])[0]),g};addChatroom=async(e,t="",s="",i,r,o=!0)=>{if(!e)return;r&&Object.keys(r).length===0&&(r=this.getLocalUserPeerIds(e));let a=this.createStruct("chatroom",void 0,e);a.message=s,a.attachments=i,a.authorId=t,a.users=r,a.replies=[],a.comments=[];let l=[a];return o&&(a=await this.updateServerData(l)[0]),a};addComment=async(e,t,s,i="",r="",o,a=!0)=>{if(!t||(s||(s=t),!e))return;let l=this.createStruct("comment",void 0,e,t);l.authorId=i,l.replyTo=s?._id,l.message=r,l.attachments=o,l.users=t?.users,l.replies=[],a||s?.replies.push(l._id),a||t?.comments.push(l._id);let f=[l,t];s?._id!==t._id&&f.push(s);let c;a&&(c=await this.updateServerData(f));let h;return typeof c=="object"&&(h=c.find(u=>{if(l.ownerId===u.ownerId&&l.timestamp===u.timestamp&&l.message===u.message)return!0})),h||c}};var Ts=Math.floor(Math.random()*16777215),lr=E.index=parseInt(Math.random()*16777215,10),fr=(typeof process>"u"||typeof process.pid!="number"?Math.floor(Math.random()*1e5):process.pid)%65535,cr=(()=>{try{return _Buffer}catch{try{return Buffer}catch{return null}}})(),kt=function(n){return!!(n!=null&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n))},ur=[];for(B=0;B<256;B++)ur[B]=(B<=15?"0":"")+B.toString(16);var B,hr=new RegExp("^[0-9a-fA-F]{24}$"),qe=[];B=0;for(;B<10;)qe[48+B]=B++;for(;B<16;)qe[55+B]=qe[87+B]=B++;function E(n){if(!(this instanceof E))return new E(n);if(n&&(n instanceof E||n._bsontype==="ObjectId"))return n;if(this._bsontype="ObjectId",n==null||typeof n=="number"){this.id=this.generate(n);return}var e=E.isValid(n);if(!e&&n!=null)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(e&&typeof n=="string"&&n.length===24)return E.createFromHexString(n);if(n!=null&&n.length===12)this.id=n;else{if(n!=null&&typeof n.toHexString=="function")return n;throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters")}}module.exports=E;E.default=E;E.createFromTime=function(n){return n=parseInt(n,10)%4294967295,new E($n(8,n)+"0000000000000000")};E.createFromHexString=function(n){if(typeof n>"u"||n!=null&&n.length!==24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");for(var e="",t=0;t<24;)e+=String.fromCharCode(qe[n.charCodeAt(t++)]<<4|qe[n.charCodeAt(t++)]);return new E(e)};E.isValid=function(n){return n==null?!1:typeof n=="number"?!0:typeof n=="string"?n.length===12||n.length===24&&hr.test(n):n instanceof E?!0:kt(n)?E.isValid(n.toString("hex")):typeof n.toHexString=="function"&&cr&&(n.id instanceof cr||typeof n.id=="string")?n.id.length===12||n.id.length===24&&hr.test(n.id):!1};E.prototype={constructor:E,toHexString:function(){if(!this.id||!this.id.length)throw new Error("invalid ObjectId, ObjectId.id must be either a string or a Buffer, but is ["+JSON.stringify(this.id)+"]");if(this.id.length===24)return this.id;if(kt(this.id))return this.id.toString("hex");for(var n="",e=0;e<this.id.length;e++)n+=ur[this.id.charCodeAt(e)];return n},equals:function(n){return n instanceof E?this.toString()===n.toString():typeof n=="string"&&E.isValid(n)&&n.length===12&&kt(this.id)?n===this.id.toString("binary"):typeof n=="string"&&E.isValid(n)&&n.length===24?n.toLowerCase()===this.toHexString():typeof n=="string"&&E.isValid(n)&&n.length===12?n===this.id:n!=null&&(n instanceof E||n.toHexString)?n.toHexString()===this.toHexString():!1},getTimestamp:function(){var n=new Date,e;return kt(this.id)?e=this.id[3]|this.id[2]<<8|this.id[1]<<16|this.id[0]<<24:e=this.id.charCodeAt(3)|this.id.charCodeAt(2)<<8|this.id.charCodeAt(1)<<16|this.id.charCodeAt(0)<<24,n.setTime(Math.floor(e)*1e3),n},generate:function(n){typeof n!="number"&&(n=~~(Date.now()/1e3)),n=parseInt(n,10)%4294967295;var e=qn();return String.fromCharCode(n>>24&255,n>>16&255,n>>8&255,n&255,Ts>>16&255,Ts>>8&255,Ts&255,fr>>8&255,fr&255,e>>16&255,e>>8&255,e&255)}};function qn(){return lr=(lr+1)%16777215}function $n(n,e){return e=e.toString(16),e.length===n?e:"00000000".substring(e.length,n)+e}var Hn=Symbol&&Symbol.for&&Symbol.for("nodejs.util.inspect.custom")||"inspect";E.prototype[Hn]=function(){return"ObjectId("+this+")"};E.prototype.toJSON=E.prototype.toHexString;E.prototype.toString=E.prototype.toHexString;var Jn=n=>(n?`${n}_`:"")+Math.floor(1e15*Math.random()),D=n=>typeof n=="string"&&n.length===24?new E(n):n,S=n=>typeof n=="object"?n.toString():n,dr=["profile","group","authorization","discussion","chatroom","comment","dataInstance","event","notification","schedule","date"],Es=class extends C{name="structs";debug=!1;db;users={};collections={};mode="local";useAuths=!0;useAccessTokens=!1;useRefreshTokens=!1;accessTokens=new Map;refreshTokens=new Map;constructor(e,t){super(e),this.load(this),t&&this.initDB(t)}initDB=e=>{this.db=e.db,e?.users&&(this.users=e.users),e.mode&&(this.mode=e.mode),e?.collections&&(this.collections=e.collections),e.debug&&(this.debug=e.debug),e.useAccessTokens&&(this.useAccessTokens=e.useAccessTokens),e.useRefreshTokens&&(this.useRefreshTokens=e.useRefreshTokens),"useAuths"in e&&(this.useAuths=e.useAuths),dr.forEach(t=>{this.collections[t]||(this.collections[t]=this.db?{instance:this.db.collection(t)}:{},this.collections[t].reference={})})};query=async(e,t,s,i,r,o)=>{let a=this.users[e];if(!a)return!1;if(this.mode.indexOf("mongo")>-1)return await this.queryMongo(a,t,s,i,r,o);{let l=this.getLocalData(a,t);if(l&&!Array.isArray(l)){let c=!this.useAuths;if(l?.ownerId?this.useAuths&&(c=await this.checkAuthorization(a,l,"READ",o)):c=!0,c)return l}typeof r=="number"&&Array.isArray(l)&&l.length>r&&l.splice(0,r);let f=[];return l&&await Promise.all(l.map(async c=>{let h=this.getLocalData(S(c._id)),u=!this.useAuths;!h?.ownerId||h.ownerId===a._id?u=!0:this.useAuths&&(u=await this.checkAuthorization(a,h,"READ",o)),u&&f.push(h)})),f}};getUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.indexOf("mongo")>-1)o=await this.getMongoUser(r,t,void 0,s,i);else{let a=this.getLocalData("profile",{_id:t});if(!a)o={user:void 0};else{let l=!this.useAuths;if(!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"READ",i)),l){let f=this.getLocalData("group",{ownerId:t}),c=this.getLocalData("authorization",{ownerId:t});o={user:a,groups:f,authorizations:c}}else o={user:{}}}}return this.debug&&console.log("getUser: user:",r,"input:",t,"output",o),o};setUser=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(t.accessToken)this.accessTokens.set(e,s);else if(this.useAccessTokens)return!1;if(t.refreshToken)this.refreshTokens.set(e,t.refreshToken);else if(this.useRefreshTokens)return!1;if(delete t.accessToken,delete t.refreshToken,delete i.accessToken,delete i.refreshToken,this.mode.indexOf("mongo")>-1)r=await this.setMongoUser(i,t,s);else{let o=!this.useAuths;return!t?.ownerId||t.ownerId===i._id?o=!0:this.useAuths&&(o=await this.checkAuthorization(i,t,"WRITE",s)),o&&this.setLocalData(t),!0}return this.debug&&console.log("setUser user:",i,"input:",t,"output",r),r};getUsersByIds=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoUsersByIds(i,t,s);else if(r=[],Array.isArray(t)){let o=this.getLocalData("profile",{_id:t});o&&(s?r.push({_id:o._id,username:o.username,firstName:o.firstName,lastName:o.lastName,fullName:o.fullName,pictureUrl:o.pictureUrl}):r.push(o))}return this.debug&&console.log("getUserByIds: user:",i,"input:",t,"output",r),r};getUsersByRole=async(e,t)=>{let s=this.users[e];if(!s)return!1;let i;if(this.mode.includes("mongo"))i=await this.getMongoUsersByRole(s,t);else{let r=this.getLocalData("profile");i=[],r.forEach(o=>{o.userRoles[t]&&i.push(o)})}return this.debug&&console.log("getUserByRoles: user:",s,"input:",t,"output",i),i};deleteUser=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.deleteMongoUser(r,t,s,i);else{o=!1;let a=this.getLocalData(t);if(a){let l=!this.useAuths;!a?.ownerId||a.ownerId===r._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(r,a,"WRITE",i)),l&&(o=this.deleteLocalData(a))}}return this.debug&&console.log("deleteUser: user:",r,"input:",t,"output",o),o};setData=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.setMongoData(r,t,s,i);else{let a=[];return o=[],await Promise.all(t.map(async l=>{let f=this.getLocalData(l),c=!this.useAuths;!f?.ownerId||f.ownerId===r._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(r,f,"WRITE",i)),c&&(this.collections[f.structType]||(this.collections[f.structType]={},this.collections[f.structType].reference={}),this.setLocalData(f),o.push(f),f.structType!=="notification"&&a.push(f))})),a.length>0&&(s===!0||typeof s>"u")&&this.checkToNotify(r,a,this.mode),this.debug&&console.log("setData:",r,t,o),!0}return this.debug&&console.log("setData: user:",r,"input:",t,s,"output",o),o};getData=async(e,t,s,i,r,o,a)=>{let l=this.users[e];if(!l)return!1;let f;if(this.mode.includes("mongo"))f=await this.getMongoData(l,t,s,i,r,o,a);else{f=[];let c;t&&(c=this.getLocalData(t)),c&&s&&(c=c.filter(h=>{if(h.ownerId===s)return!0})),c&&await Promise.all(c.map(async h=>{let u=this.getLocalData(S(h._id)),d=!this.useAuths;!u?.ownerId||u.ownerId===l._id?d=!0:this.useAuths&&(d=await this.checkAuthorization(l,u,"READ",a)),d&&f.push(u)}))}return this.debug&&console.log("getData: user:",l,"input:",t,s,i,r,o,"output",f),f};getDataByIds=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getMongoDataByIds(o,t,s,i,r);else{a=[];let l;i&&(l=this.getLocalData(i)),l&&s&&(l=l.filter(f=>{if(f.ownerId===s)return!0})),l&&await Promise.all(l.map(async f=>{let c=this.getLocalData(S(f._id)),h=!this.useAuths;!c?.ownerId||c.ownerId===o._id?h=!0:this.useAuths&&(h=await this.checkAuthorization(o,c,"READ",r)),h&&a.push(c)}))}return this.debug&&console.log("getDataByIds: user:",o,"input:",t,s,i,"output",a),a};getAllData=async(e,t,s,i,r)=>{let o=this.users[e];if(!o)return!1;let a;if(this.mode.includes("mongo"))a=await this.getAllUserMongoData(o,t,s,i,r);else{let l=this.getLocalData(void 0,{ownerId:t});a=[],await Promise.all(l.map(async f=>{if(s){if(s.indexOf(f.structType)<0){let c=!this.useAuths;!f?.ownerId||f.ownerId===o._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(o,f,"READ",r)),c&&a.push(f)}}else{let c=!this.useAuths;!f?.ownerId||f.ownerId===o._id?c=!0:this.useAuths&&(c=await this.checkAuthorization(o,f,"READ",r)),c&&a.push(f)}}))}return this.debug&&console.log("getAllData: user:",o,"input:",t,s,"output",a),a};deleteData=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;return this.mode.includes("mongo")?r=await this.deleteMongoData(i,t,s):(r=!1,await Promise.all(t.map(async o=>{let a=this.getLocalData(o),l=!this.useAuths;!a?.ownerId||a.ownerId===i._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(i,a,"WRITE",s)),l&&this.deleteLocalData(a),r=!0}))),this.debug&&console.log("deleteData: user:",i,"input:",t,"output",r),r};getUserGroups=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.getMongoGroups(i,t,s);else if(typeof s=="string")r=this.getLocalData("group",{_id:s});else{r=[];let o=this.getLocalData("group");t?o.forEach(a=>{Object.keys(a.users).includes(t)&&r.push(a)}):o.forEach(a=>{Object.keys(a.users).includes(S(i._id))&&r.push(a)})}return this.debug&&console.log("getGroups: user:",i,"input:",t,s,"output",r),r};deleteGroup=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoGroup(i,t,s);else{let o=this.getLocalData("group",t),a=!this.useAuths;o&&(!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s))),a&&(r=!0)}return this.debug&&console.log("deleteGroup: user:",i,"input:",t,"output",r),r};getAuthorizations=async(e,t,s,i)=>{let r=this.users[e];if(!r)return!1;let o;if(this.mode.includes("mongo"))o=await this.getMongoAuthorizations(r,t,s,i);else if(s){let a=this.getLocalData("authorization",{_id:s});a&&(o=[a])}else o=this.getLocalData("authorization",{ownerId:t});return this.debug&&console.log("getAuthorizations: user:",r,"input:",t,s,"output",o),o};deleteAuthorization=async(e,t,s)=>{let i=this.users[e];if(!i)return!1;let r;if(this.mode.includes("mongo"))r=await this.deleteMongoAuthorization(i,t,s);else{r=!0;let o=this.getLocalData("authorization",{_id:t});if(o){let a=!this.useAuths;!o?.ownerId||o.ownerId===i._id?a=!0:this.useAuths&&(a=await this.checkAuthorization(i,o,"WRITE",s)),a&&(r=this.deleteLocalData(o))}}return this.debug&&console.log("deleteAuthorization: user:",i,"input:",t,"output",r),r};getToken=e=>this.useAccessTokens?this.accessTokens.get(e._id):this.useRefreshTokens?this.refreshTokens.get(e._id):void 0;notificationStruct=(e={})=>{let t="notification";return{structType:t,timestamp:Date.now(),_id:Jn(t),note:"",alert:!1,ownerId:"",parentUserId:"",parent:{structType:e?.structType,_id:S(e?._id)}}};checkToNotify=async(e,t=[],s=this.mode)=>{if(t.length===0)return!1;if(typeof e=="string")for(let o in this.users){let a=this.users[o];S(a._id)===e&&(e=a)}if(typeof e=="string"||e==null)return!1;let i={},r=[];if(t.forEach(async o=>{if(o?._id){if(o.ownerId&&e?._id!==o.ownerId){let a=this.notificationStruct(o);a._id="notification_"+S(o._id)+"_"+o.ownerId,a.ownerId=o.ownerId,a.note=o.structType,a.parentUserId=o.ownerId,o.alert&&(a.alert=o.alert),r.push(a),i[o.ownerId]=o.ownerId}if(o.users)Object.keys(o.users).forEach(a=>{if(a!==e._id){let l=this.notificationStruct(o);l._id="notification_"+S(o._id)+"_"+a,l.ownerId=a,l.note=o.structType,o.alert&&(l.alert=o.alert),l.parentUserId=o.ownerId,r.push(l),i[a]=a}});else{let a=[];if(s.includes("mongo")){let f=await this.collections.authorization.instance.find({$or:[{authorizedId:e._id},{authorizerId:e._id}]}).toArray();f.length>0&&f.forEach(c=>a.push(c))}else a=this.getLocalData("authorization",{authorizedId:e._id}),a.push(...this.getLocalData("authorization",{authorizerId:e._id}));a.length>0&&a.forEach(l=>{if(o.authorizerId===o.ownerId&&!i[o.authorizedId]&&l.status==="OKAY"&&l.authorizations.peer){let f=this.notificationStruct(o);f.ownerId=l.authorizedId,f._id="notification_"+S(o._id)+"_"+l.authorizedId,f.note=o.structType,f.parentUserId=o.ownerId,o.alert&&(f.alert=o.alert),r.push(f),i[f.ownerId]=f.ownerId}})}}}),r.length>0){s.includes("mongo")?await this.setMongoData(e,r,!0,this.getToken(e)):this.setLocalData(r);for(let o in i)this.users[o]?.sendAll({route:"structNotification",args:!0});return!0}else return!1};queryMongo=async(e,t,s={},i=!1,r=0,o)=>{if(!(!t&&!s))if(i){let a=await this.db.collection(t).findOne(s);if(!a)return;let l=!this.useAuths;return a?.ownerId?(S(e._id)!==a.ownerId||S(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",o)):l=!0,l?a:void 0}else{let a=this.db.collection(t).find(s).sort({$natural:-1}).skip(r),l=[],f=await a.toArray();if(f.length>0){let c=!this.useAuths,h="";for(let u of f)u?.ownerId?(S(e._id)!==u.ownerId||S(e._id)===u.ownerId&&e.userRoles?.admincontrol)&&h!==u.ownerId&&(this.useAuths&&(c=await this.checkAuthorization(e,u,"READ",o)),h=u.ownerId):c=!0,c&&l.push(u)}return l}};setMongoData=async(e,t=[],s=!0,i)=>{let r=!1;if(t.length>0){let o=!this.useAuths,a="";if(await Promise.all(t.map(async l=>{let f={};if(Array.isArray(l)&&(f=l[1],l=l[0]),!l?.ownerId||l.ownerId===e._id?o=!0:(S(e._id)!==l.ownerId||S(e._id)===l.ownerId&&e.userRoles?.admincontrol)&&a!==l.ownerId&&(this.useAuths&&(o=await this.checkAuthorization(e,l,"WRITE",i)),a=l.ownerId),o&&l.structType){this.collections[l.structType]||(this.collections[l.structType]={},this.collections[l.structType].reference={});let c=JSON.parse(JSON.stringify(l));c._id&&delete c._id,l._id?S(l._id).includes("defaultId")?(await this.db.collection(l.structType?l.structType:"data").insertOne(c),r=!0):l.structType==="notification"?await this.db.collection(l.structType?l.structType:"data").updateOne({_id:l._id},{$set:c,...f},{upsert:!0,unique:!1}):await this.db.collection(l.structType?l.structType:"data").updateOne({_id:D(l._id)},{$set:c,...f},{upsert:!0}):l.structType&&this.db.collection(l.structType?l.structType:"data").insertOne(c)}})),r===!0){let l=[];return await Promise.all(t.map(async(f,c)=>{let h=JSON.parse(JSON.stringify(f));if(h._id&&h.structType!=="profile"&&delete h._id,f.structType!=="comment"){let u;f.structType!=="notification"&&(u=await this.db.collection(h.structType).findOne(h)),u&&(u._id=S(u._id),l.push(u))}else if(f.structType==="comment"){let d=JSON.parse(JSON.stringify(f));d._id&&delete d._id;let g=await this.db.collection("comment").findOne(d),p=g?.replyTo,x=t.find(v=>{if(S(v._id)===p)return!0});if(x){let v=JSON.parse(JSON.stringify(x));v._id&&delete v._id;let O;if(await Promise.all(["discussion","chatroom","comment"].map(async b=>{let w=await this.db.collection(b).findOne({_id:D(p)});w&&(O=w)})),O){let b=S(g.parent._id),w,m;b!==p?(w=t.find(k=>{if(S(k._id)===b)return!0}),w&&(delete w._id,await Promise.all(["discussion","chatroom"].map(async k=>{let A=await this.db.collection(k).findOne(w);A&&(m=A)})))):m=O;let _=[g];O&&(O.replies.indexOf(S(g._id))<0&&(O.replies.push(S(g._id)),g.replyTo=S(O._id)),_.push(O)),m&&m.comments.indexOf(g._id)<0&&(m.comments.push(S(g._id)),g.parent._id=S(m._id)),await Promise.all(_.map(async k=>{let A=JSON.parse(JSON.stringify(k));delete A._id,await this.db.collection(k.structType).updateOne({_id:D(k._id)},{$set:A},{upsert:!1})})),[...l].reverse().forEach((k,A)=>{_.find(P=>{if(S(k._id)===S(P._id))return!0})&&l.splice(l.length-A-1,1)}),l.push(..._)}}else g&&l.push(g)}})),s&&this.checkToNotify(e,l),l}else{let l=[];return t.forEach(f=>{f.structType!=="notification"&&l.push(f)}),s&&this.checkToNotify(e,l),!0}}else return!1};setMongoUser=async(e,t,s)=>{if(t._id){let i=D(t._id),r={_id:i};if(await this.collections.profile.instance.findOne(r)&&(S(e._id)!==t.ownerId||S(e._id)===t.ownerId&&e.userRoles?.admincontrol)){let l=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?l=!0:this.useAuths&&(l=await this.checkAuthorization(e,t,"WRITE",s)),!l)return!1}let a=JSON.parse(JSON.stringify(t));return a._id=i,this.debug&&console.log("RETURNS PROFILE",t),await this.collections.profile.instance.updateOne(r,{$set:a},{upsert:!0}),e=await this.collections.profile.instance.findOne(r),this.checkToNotify(e,[t]),e}else return!1};setGroup=async(e,t,s=this.mode,i)=>{if(t?._id){let r=S(e._id),o;if(s.includes("mongo")?o=await this.collections.group.instance.findOne({name:t.name}):o=this.getLocalData("group",{_id:S(t._id)}),o&&(o.ownerId!==t.ownerId||t.admins.indexOf(r)<0))return!1;if(r!==t.ownerId){let g=!this.useAuths;if(!t?.ownerId||t.ownerId===e._id?g=!0:this.useAuths&&(g=await this.checkAuthorization(e,t,"WRITE",i)),!g)return!1}let a=[];Object.keys(t.users).forEach(g=>{a.push({email:g},{id:g},{username:g})});let l={},f={};if(s.includes("mongo")){let p=this.collections.profile.instance.find({$or:a}).toArray();p.length>0&&p.forEach(x=>{l[r]=x,f[r]=!0})}else a.forEach(g=>{let p=this.getLocalData("profile",g);p.length>0&&(l[S(p[0]._id)]=p[0],f[S(p[0]._id)]=!0)});t.users=f;let c={},h={},u={};Object.keys(l).forEach(g=>{let p=l[g];(t.admins[S(p._id)]||t.admins[p.email]||t.admins[p.username]||t.admins[t.ownerId])&&(c[S(p._id)]||(c[S(p._id)]=!0)),(t.peers[S(p._id)]||t.peers[p.email]||t.peers[p.username]||t.peers[t.ownerId])&&(h[S(p._id)]||(h[S(p._id)]=!0)),(t.clients[S(p._id)]||t.clients[p.email]||t.clients[p.username]||t.clients[t.ownerId])&&(u[S(p._id)]||(u[S(p._id)]=!0))}),t.admins=c,t.peers=h,t.clients=u;let d=JSON.parse(JSON.stringify(t));return d._id&&delete d._id,s.includes("mongo")?S(t._id).includes("defaultId")?(await this.db.collection(t.structType?t.structType:"data").insertOne(d),delete t._id,t=await this.db.collection(t.structType?t.structType:"data").findOne(t),t._id=S(t._id)):await this.collections.group.instance.updateOne({_id:D(t._id)},{$set:d},{upsert:!0}):this.setLocalData(t),this.checkToNotify(e,[t],this.mode),this.debug&&console.log("setGroup: user:",e,"output",t),t}else return!1};getMongoUser=(e,t="",s=!0,i=!1,r)=>new Promise(async o=>{let a=[{email:t},{id:t},{username:t}];try{a.push({_id:D(t)})}catch{console.log("error creating ObjectId with ",t)}let l=await this.collections.profile.instance.findOne({$or:a});if(!l||l==null)o(void 0);else if(l._id=S(l._id),l.ownerId||(l.ownerId=l._id),i)(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),l={username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id},o({user:l});else if(s){if(S(e._id)!==l._id||S(e._id)===l._id&&e.userRoles?.admincontrol){let p=!this.useAuths;this.useAuths&&(p=await this.checkAuthorization(e,l,"READ",r)),p||o(void 0)}let f=[],c=this.collections.authorization.instance.find({ownerId:l._id}),h=await c.toArray();c.toArray().length>0&&h.forEach(p=>f.push(p));let d=await this.collections.group.instance.find({users:{$all:[l._id]}}).toArray(),g=[];d.length>0&&d.forEach(p=>g.push(p)),o({user:l,authorizations:f,groups:g})}else(this.useAccessTokens||this.useRefreshTokens)&&this.getToken(e)!==r&&o(void 0),o({user:l})});queryUsers=(e,t="",s=0,i=0,r=!1,o)=>(typeof e=="string"&&(e=this.users[e]),e?new Promise(async a=>{let l={$regex:`^${t}`,$options:"i"},f=[{email:l},{username:l},{firstName:l},{lastName:l},{name:l}],c;if(this.mode.includes("mongo")){let h=this.collections.profile.instance.find({$or:f},{projection:xt}).skip(i);s>0&&h.limit(s),await h,c=await h.toArray(),console.log(c)}else{c=[];for(let h=0;h<f.length;h++){let u=this.getLocalData("profile",f[h]);Array.isArray(u)?u.forEach(d=>{c.push({firstName:d.firstName,lastName:d.lastName,fullName:d.fullName,username:d.username,pictureUrl:d.pictureUrl})}):u&&c.push({firstName:u.firstName,lastName:u.lastName,fullName:u.fullName,username:u.username,pictureUrl:u.pictureUrl})}}if(r){let h=[],u=S(e._id);for(let d=0;d<c.length;d++){let g=c[d];if(g._id=S(g._id),u!==g._id||u===g._id&&e.userRoles?.admincontrol){let p=!this.useAuths;this.useAuths&&(p=await this.checkAuthorization(e,g,"READ",o)),p&&h.push(g)}}c=h}else if(this.useAccessTokens||this.useRefreshTokens){let h=this.getToken(e);if(!h||h!==o){a(!1);return}}a(c)}):Promise.resolve(void 0));getMongoUsersByIds=async(e,t=[],s)=>{let i=[];t.forEach(o=>{try{i.push({_id:D(o)})}catch{}});let r=[];if(i.length>0){let a=await this.collections.profile.instance.find({$or:i}).toArray();a.length>0&&a.forEach(l=>{s?r.push({username:l.username,firstName:l.firstName,lastName:l.lastName,fullName:l.fullName,pictureUrl:l.pictureUrl,_id:l._id}):r.push(l)})}return r};getMongoUsersByRole=async(e,t)=>{let s=this.collections.profile.instance.find({userRoles:{$all:{[t]:!0}}}),i=[],r=await s.toArray();return r.length>0&&r.forEach(o=>{i.push(o)}),i};getMongoDataByIds=async(e,t,s,i,r)=>{let o=S(e._id);if(t.length>0){let a=[];t.forEach(f=>{let c={_id:D(f)};s&&(c.ownerId=s),a.push(c)});let l=[];if(!i)await Promise.all(Object.keys(this.collections).map(async f=>{let h=await(await this.db.collection(f).find({$or:a})).toArray();if(h.length>0){let u=!0,d="";for(let g=0;g<h.length;g++){let p=h[g];p?.ownerId?(o!==p.ownerId||o===p.ownerId&&e.userRoles?.admincontrol)&&d!==p.ownerId&&(this.useAuths&&(u=await this.checkAuthorization(e,p,"READ",r)),d=p.ownerId):u=!0,u&&l.push(p)}}}));else{let c=await(await this.db.collection(i).find({$or:a})).toArray();if(c.length>0){let h=!0,u="";c.forEach(async d=>{d?.ownerId?(o!==d.ownerId||o===d.ownerId&&e.userRoles?.admincontrol)&&u!==d.ownerId&&(this.useAuths&&(h=await this.checkAuthorization(e,d,"READ",r)),u=d.ownerId):h=!0,h&&l.push(d)})}}return l}};getMongoData=async(e,t,s,i={},r=0,o=0,a)=>{s||(s=i?.ownerId),i||(i={}),i._id&&(i._id=D(i._id));let l=S(e._id),f=[],c=!0,h="",u;if(!t&&!s&&!i)return[];if(!t&&s&&Object.keys(i).length===0)return await this.getAllUserMongoData(e,s);if((!i||Object.keys(i).length===0)&&s&&t?u=this.db.collection(t).find({ownerId:s}).sort({$natural:-1}).skip(o):t&&Object.keys(i).length>0&&(s&&(i.ownerId=s),u=await this.db.collection(t).find(i).sort({$natural:-1}).skip(o)),u){r>0&&u.limit(r);let d=await u.toArray();if(d.length>0)for(let g=0;g<d.length;g++){let p=d[g];p?.ownerId?(l!==p.ownerId||l===p.ownerId&&e.userRoles?.admincontrol)&&h!==p.ownerId&&(this.useAuths&&(c=await this.checkAuthorization(e,p,"READ",a)),h=p.ownerId):c=!0,c===!0&&f.push(p)}}else!t&&Object.keys(i).length>0&&!s&&await Promise.all(Object.keys(this.collections).map(async d=>{if(u=await this.db.collection(d).find(i).sort({$natural:-1}).skip(o),u){r>0&&u.limit(r);let g=await u.toArray();if(g.length>0)for(let p=0;p<g.length;p++){let x=g[p];x?.ownerId?(l!==x.ownerId||l===x.ownerId&&e.userRoles?.admincontrol)&&h!==x.ownerId&&(this.useAuths&&(c=await this.checkAuthorization(e,x,"READ",a)),h=x.ownerId):c=!0,c===!0&&f.push(x)}}}));return c?f:[]};getAllUserMongoData=async(e,t,s=[],i,r)=>{let o=[],a=!0,l="";return await Promise.all(Object.keys(this.collections).map(async(f,c)=>{if(a&&s.indexOf(f)<0){let h={ownerId:t};i&&(typeof i[0]=="string"&&(i[0]=X(i[0])),typeof i[1]=="string"&&(i[1]=X(i[1])),h.timestamp={$gt:i[0],$lt:i[1]});let d=await this.db.collection(f).find(h).toArray(),g=d.length;for(let p=0;p<g;p++){let x=d[p];t?(S(e._id)!==t||S(e._id)===t&&e.userRoles?.admincontrol)&&l!==t&&(this.useAuths&&(a=await this.checkAuthorization(e,x,"READ",r)),l=t):a=!0,a&&o.push(x)}}})),a?o:[]};getMongoDataByRefs=async(e,t=[],s)=>{let i=[];if(i.length>0){let r="";t.forEach(async o=>{if(o.structType&&S(o._id)){let a=await this.db.collection(o.structType).findOne({_id:D(o._id)});if(a){let l=!0;!a?.ownerId||a.ownerId===e._id?l=!0:(S(e._id)!==a.ownerId||S(e._id)===a.ownerId&&e.userRoles?.admincontrol)&&r!==a.ownerId&&(this.useAuths&&(l=await this.checkAuthorization(e,a,"READ",s)),r=a.ownerId),l===!0&&i.push(a)}}})}return i};getMongoAuthorizations=async(e,t=S(e._id),s="",i)=>{let r=[];if(s.length===0){let a=await this.collections.authorization.instance.find({ownerId:t}).toArray();a.length>0&&a.forEach(l=>{r.push(l)})}else r.push(await this.collections.authorization.instance.findOne({_id:D(s),ownerId:t}));if(r[0]?.ownerId){if(S(e._id)!==r[0]?.ownerId){let o=!this.useAuths;if(this.useAuths&&(o=await this.checkAuthorization(e,r[0],"READ",i)),!o)return}}return r};getMongoGroups=async(e,t=S(e._id),s="")=>{let i=[];if(s.length===0){let o=await this.collections.group.instance.find({users:{$all:[t]}}).toArray();o.length>0&&o.forEach(a=>{i.push(a)})}else try{i.push(await this.collections.group.instance.findOne({_id:D(s),users:{$all:[t]}}))}catch{}return i};deleteMongoData=async(e,t=[],s)=>{let i=[];await Promise.all(t.map(async o=>{try{let a=D(o._id),l=await this.db.collection(o.structType).findOne({_id:a});if(l){i.push(l);let f=await this.collections.notifications.instance.find({parent:{structType:o.structType,_id:S(o._id)}}),c=f.toArray().length;for(let h=0;h<c;h++){let u=await f.next();u&&i.push(u)}}}catch{}}));let r="";return await Promise.all(i.map(async(o,a)=>{let l=!0;!o?.ownerId||o.ownerId===e._id?l=!0:(o.ownerId!==S(e._id)||S(e._id)===o.ownerId&&e.userRoles?.admincontrol)&&o.ownerId!==r&&(r=o.ownerId,this.useAuths&&(l=await this.checkAuthorization(e,o,"WRITE",s))),l&&(await this.db.collection(o.structType?o.structType:"data").deleteOne({_id:D(o._id)}),o.users&&Object.keys(o.users).forEach(f=>{f!==S(e._id)&&f!==o.ownerId&&this.users[f]&&this.users[f]?.sendAll({route:"structDeleted",args:{_id:S(o._id),structType:o.structType}})}),o.ownerId!==e._id&&this.users[o.ownerId]&&this.users[o.ownerId]?.sendAll({route:"structDeleted",args:{_id:S(o._id),structType:o.structType}}))})),!0};deleteMongoUser=async(e,t,s,i)=>{if(S(e._id)!==t||S(e._id)===t&&e.userRoles?.admincontrol){let r=await this.collections.profile.instance.findOne({id:t}),o=!this.useAuths;if(r?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,r,"WRITE",i)):o=!0,!o)return!1}if(await this.collections.profile.instance.deleteOne({id:t}),s)for(let r in this.collections)this.collections[r].instance.deleteMany({ownerId:t}),this.collections[r].instance.updateMany({users:{[t]:!0}},{$unset:{[`users.${t}`]:""}});return S(e._id)!==t&&this.users[t]&&this.users[t]?.sendAll({route:"structDeleted",args:{_id:t,structType:"profile"}}),!0};deleteMongoGroup=async(e,t,s)=>{let i=await this.collections.group.instance.findOne({_id:D(t)});if(i){if(i?.ownerId){if(S(e._id)!==i.ownerId||S(e._id)===i.ownerId&&e.userRoles?.admincontrol){let r=!this.useAuths;if(this.useAuths&&(r=await this.checkAuthorization(e,i,"WRITE",s)),!r)return!1}}return i.users&&Object.keys(i.users).forEach(r=>{this.users[r]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}})}),await this.collections.group.instance.deleteOne({_id:D(t)}),!0}else return!1};deleteMongoAuthorization=async(e,t,s)=>{let i=await this.collections.authorization.instance.findOne({_id:D(t)}),r=S(e._id);if(i){if(r!==i.ownerId||r===i.ownerId&&e.userRoles?.admincontrol){let o=!this.useAuths;if(i?.ownerId?this.useAuths&&(o=await this.checkAuthorization(e,i,"WRITE",s)):o=!0,!o)return!1}return i.associatedAuthId&&(this.debug&&console.log(i),await this.collections.authorization.instance.deleteOne({_id:D(i.associatedAuthId)}),i.authorizerId!==r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:S(i.associatedAuthId),structType:i.structType}}):i.authorizedId!==r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:S(i.associatedAuthId),structType:i.structType}})),await this.collections.authorization.instance.deleteOne({_id:D(t)}),i.authorizerId===r?this.users[i.authorizerId]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}}):i.authorizedId===r&&this.users[i.authorizedId]?.sendAll({route:"structDeleted",args:{_id:S(i._id),structType:i.structType}}),!0}else return!1};setAuthorization=async(e,t,s)=>{let i,r,o=this.mode.includes("mongo");if(o?(i=(await this.getMongoUser(e,t.authorizedId,!1)).user,r=(await this.getMongoUser(e,t.authorizerId,!1)).user):(i=this.getLocalData("profile",{_id:t.authorizedId})?.[0],r=this.getLocalData("profile",{_id:t.authorizerId})?.[0]),!i||!r)return!1;if(t.authorizedId!==S(i._id)&&(t.authorizedId=S(i._id)),t.authorizerId!==S(r._id)&&(t.authorizerId=S(r._id)),t.authorizedName||(i.name?t.authorizedName=i.name:i.username?t.authorizedName=i.username:i.email&&(t.authorizedName=i.email)),t.authorizerName||(i.name?t.authorizedName=i.name:r.username?t.authorizerName=r.username:r.email&&(t.authorizerName=r.email)),t?.ownerId){if((S(e._id)!==t.ownerId||S(e._id)===t.ownerId&&e.userRoles?.admincontrol)&&S(e._id)!==t.authorizedId&&S(e._id)!==t.authorizerId){let c=!this.useAuths;if(this.useAuths&&(c=await this.checkAuthorization(e,t,"WRITE",s)),!c)return!1}}let a=[];if(o){let h=await(await this.collections.authorization.instance.find({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId}]})).toArray();h.length>0&&h.forEach(u=>a.push(u))}else{let c=this.getLocalData("authorization",{authorizedId:t.authorizedId});Array.isArray(c)&&c.forEach(h=>{h.authorizerId===t.authorizerId&&a.push(h)})}let l;if(Array.isArray(a))for(let c=0;c<a.length;c++){let h=a[c];if(h.ownerId!==S(e._id)){t.authorizerId===S(e._id)?(h.authorizations=t.authorizations,h.structs=t.structs,h.excluded=t.excluded,h.expires=t.expires,h.status="OKAY",t.status="OKAY"):(t.authorizations=h.authorizations,t.structs=h.structs,t.excluded=h.excluded,t.expires=h.expires,h.status="OKAY",t.status="OKAY"),t.associatedAuthId=S(h._id),h.associatedAuthId=S(t._id),l=h;let u=JSON.parse(JSON.stringify(h));o?(delete u._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:h.ownerId}]},{$set:u},{upsert:!0})):this.setLocalData(u)}}let f=JSON.parse(JSON.stringify(t));if(o?(delete f._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:t.authorizedId},{authorizerId:t.authorizerId},{ownerId:t.ownerId}]},{$set:f},{upsert:!0})):this.setLocalData(f),S(t._id).includes("defaultId")&&o){let c=await this.collections.authorization.instance.findOne(f);if(c&&(t._id=S(c._id),l)){let h=await this.collections.authorization.instance.findOne({$and:[{authorizedId:l.authorizedId},{authorizerId:l.authorizerId},{ownerId:l.ownerId}]});if(h){h.associatedAuthId=S(t._id);let u=JSON.parse(JSON.stringify(h));delete u._id,await this.collections.authorization.instance.updateOne({$and:[{authorizedId:h.authorizedId},{authorizerId:h.authorizerId},{ownerId:h.ownerId}]},{$set:u},{upsert:!0}),this.checkToNotify(e,[h])}}}return t};checkAuthorization=async(e,t,s="READ",i)=>{if(typeof e=="string"&&(this.users[e]?e=this.users[e]:e={_id:e}),!e||!t)return!1;if(!t.ownerId)return!0;if(typeof e=="object"&&t.ownerId===S(e._id))return e.userRoles?.admincontrol,!0;if(this.useAccessTokens){if(!this.accessTokens.get(e._id)||this.accessTokens.get(e._id)!==i)return!1}else if(this.useRefreshTokens&&(!this.refreshTokens.get(e._id)||this.refreshTokens.get(e._id)!==i))return!1;let r,o;if(this.mode.includes("mongo")){if(r=await this.collections.authorization.instance.findOne({$or:[{authorizedId:S(e._id),authorizerId:t.ownerId,ownerId:S(e._id)},{authorizedId:t.ownerId,authorizerId:S(e._id),ownerId:S(e._id)}]}),!r)return!1;o=await this.collections.authorization.instance.findOne({$or:[{authorizedId:S(e._id),authorizerId:t.ownerId,ownerId:S(t.ownerId)},{authorizedId:t.ownerId,authorizerId:S(e._id),ownerId:S(t.ownerId)}]})}else r=this.getLocalData("authorization",{ownerId:S(e._id)}).find(l=>{if(l.authorizedId===S(e._id)&&l.authorizerId===t.ownerId)return!0}),o=this.getLocalData("authorization",{ownerId:t.ownerId}).find(l=>{if(l.authorizedId===S(e._id)&&l.authorizerId===t.ownerId)return!0});if(!r||!o)return!1;let a=!1;return r.status==="OKAY"&&o.status==="OKAY"&&(t.structType==="group"?r.authorizations[t.name+"_admin"]&&o.authorizations[t.name+"_admin"]&&(a=!0):r.authorizations.peer&&o.authorizations.peer||r.authorizations.admincontrol&&o.authorizations.admincontrol||r.structIds[S(t._id)]&&o.structIds[S(t._id)]?a=!0:r.excluded[t.structType]&&t.ownerId===S(e._id)&&s==="WRITE"&&(a=!1)),a};wipeDB=async()=>(await Promise.all(Object.values(this.collections).map(e=>{try{e.instance.remove({})}catch{}})),!0);overwriteLocalData=e=>{if(Array.isArray(e))e.forEach(t=>{let s=this.getLocalData(t.structType,{ownerId:t.ownerId,_id:S(t._id)});!s||s?.length===0?this.setLocalData(t):Object.assign(s,t)});else{let t=this.getLocalData(e.structType,{ownerId:e.ownerId,_id:S(e._id)});!t||t?.length===0?this.setLocalData(e):Object.assign(t,e)}};setLocalData=e=>{let t=s=>{let i=s.structType,r=this.collections[i]?.reference;r||(r={},this.collections[i]||(this.collections[i]={}),this.collections[i].reference=r),r[S(s._id)]=s};Array.isArray(e)?e.forEach(s=>{t(s)}):t(e)};getLocalData=(e,t)=>{let s,i,r;if(typeof t=="object"?(s=t.ownerId,i=Object.keys(t).filter(l=>l!="ownerId")[0],r=t[i]):r=t,!e&&!s&&!i&&!r)return[];let o=[];if(!e&&(s||i))return Object.values(this.collections).forEach(a=>{if(a=a.reference,(i==="_id"||i==="id")&&r){let l=a[r];l&&o.push(l)}else Object.values(a).forEach(l=>{i&&r?l[i]===r&&l.ownerId===s&&o.push(l):l.ownerId===s&&o.push(l)})}),o;{let a=this.collections[e]?.reference;if(!a)return o;if(!i&&!s)return Object.values(a).forEach(l=>{o.push(l)}),o;if((i==="_id"||i==="id")&&r)return S(a[r]);Object.keys(a).forEach(l=>{let f=a[l];i&&r&&!s?f[i]===r&&o.push(f):s&&!i?f.ownerId===s&&o.push(f):s&&i&&r&&f.ownerId===s&&f[i]&&f[i]===r&&o.push(f)})}return o};deleteLocalData=e=>{if(!e)throw new Error("Struct not supplied");return!e.structType||!e._id?!1:(this.collections[e.structType]&&delete this.collections[e.structType].reference[e._id],!0)}},xt=G.ProfileStruct();for(let n in xt)n==="username"||n==="lastName"||n==="firstName"||n==="name"||n==="_id"||n==="pictureUrl"?xt[n]=1:delete xt[n];0&&(module.exports={AuthorizationStruct,CMDService,Callable,ChatroomStruct,CoherenceMap,CoherenceStruct,CommentStruct,DS,Data,DataStruct,DataTablet,DateStruct,E2EEService,ECGStruct,EDAStruct,EEGCoordinates,EEGStruct,EMGStruct,EventHandler,EventStruct,EyeTrackerStruct,FNIRSStruct,FrequencyBandsStruct,Graph,GraphNode,GroupStruct,HRVStruct,HTTPbackend,IMUStruct,NotificationStruct,PPGStruct,ProfileStruct,Router,SSEbackend,ScheduleStruct,Service,SessionsService,Struct,StructBackend,StructFrontend,WSSbackend,animate,backprop,bindListener,branching,connectionHasId,defaultCollections,defaultManifest,defaultServiceWorker,defaultSpecifiers,eegCoordinates,genTimeSpecifiers,genTimestampFromString,getAllProperties,getCallbackFromString,getFnParamNames,getFunctionHead,getStringId,htmlBodyBoilerPlate,instanceObject,isFunction,isNativeClass,isTypedArray,loaders,loop,methodstrings,parseFunctionFromText,pseudoObjectId,randomId,reconstructObject,recursivelyAssign,recursivelyStringifyFunctions,scriptBoilerPlate,setCoordinate,spliceTypedArray,state,stringifyFast,stringifyWithCircularRefs,stringifyWithFunctionsAndCircularRefs,structRegistry,substitute__operator,toObjectId,transformListenerResult,triggerListenerOncreate,wrapArgs});
